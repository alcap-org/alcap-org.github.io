<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ: midas/src/mana.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>midas/src/mana.cpp</h1><a href="mana_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Name:         mana.c</span>
<a name="l00004"></a>00004 <span class="comment">  Created by:   Stefan Ritt</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Contents:     The system part of the MIDAS analyzer. Has to be</span>
<a name="l00007"></a>00007 <span class="comment">                linked with analyze.c to form a complete analyzer</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">  $Log: mana.cpp,v $</span>
<a name="l00010"></a>00010 <span class="comment">  Revision 1.3  2011-06-04 04:33:01  mhmurray</span>
<a name="l00011"></a>00011 <span class="comment">  MM: resolved an ambiguity in calls to TTree::Branch() that is not resolved by recent versions of gcc. I used static_cast&lt;&gt; to enforce proper typing</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment">  Revision 1.2  2011-03-26 09:09:32  mhmurray</span>
<a name="l00014"></a>00014 <span class="comment">  MM: Added support for a directory structure in the mu histogram output file. This required adding the function WriteObjectList which recurses on directories that it finds while writing all objects to file. See the function CloseRootOutputFile for the implementation.</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">  Also added a &quot;return NULL&quot; to root_server_loop, which should return a (void*). PPreviously, this function returned nothing explicitly, and the NCSA compiler doesn&apos;t want to fill in the blanks and just return NULL.</span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment">  Revision 1.1.1.1  2009-01-14 21:21:41  winter</span>
<a name="l00019"></a>00019 <span class="comment">  DAQ software</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">  Revision 1.2  2008/11/24 09:09:38  l_data</span>
<a name="l00022"></a>00022 <span class="comment">  (Peter Winter) No module name output</span>
<a name="l00023"></a>00023 <span class="comment"></span>
<a name="l00024"></a>00024 <span class="comment">  Revision 1.1.1.1  2008/11/14 14:22:16  l_data</span>
<a name="l00025"></a>00025 <span class="comment">  (Peter Winter) Starting version of midas for MuSun</span>
<a name="l00026"></a>00026 <span class="comment"></span>
<a name="l00027"></a>00027 <span class="comment">  Revision 1.2  2006/01/26 20:27:17  fegray</span>
<a name="l00028"></a>00028 <span class="comment">  (Fred)</span>
<a name="l00029"></a>00029 <span class="comment">  - Add Steve&apos;s gMiasTreeOutputFileName option.</span>
<a name="l00030"></a>00030 <span class="comment">  - Expand size of memory used for event buffer.</span>
<a name="l00031"></a>00031 <span class="comment"></span>
<a name="l00032"></a>00032 <span class="comment">  Revision 1.1  2006/01/25 01:34:46  mucap</span>
<a name="l00033"></a>00033 <span class="comment">  (Fred)</span>
<a name="l00034"></a>00034 <span class="comment">  Online analyzer framework used during run 9.  It is basically the run 8</span>
<a name="l00035"></a>00035 <span class="comment">  analyzer updated so that it compiles with the new version of MIDAS.</span>
<a name="l00036"></a>00036 <span class="comment">  (The analyzer that comes with the new version is broken in quite a few ways.)</span>
<a name="l00037"></a>00037 <span class="comment"></span>
<a name="l00038"></a>00038 <span class="comment">  Revision 1.3  2005/06/16 23:15:08  fegray</span>
<a name="l00039"></a>00039 <span class="comment">  (Fred)</span>
<a name="l00040"></a>00040 <span class="comment">  Adjust calculation of data_size slightly so that mdump doesn&apos;t complain of</span>
<a name="l00041"></a>00041 <span class="comment">  &quot;FIXED format with Midas Header&quot; on skimmed files.</span>
<a name="l00042"></a>00042 <span class="comment"></span>
<a name="l00043"></a>00043 <span class="comment">  Revision 1.2  2005/06/15 20:00:33  fegray</span>
<a name="l00044"></a>00044 <span class="comment">  (Fred)</span>
<a name="l00045"></a>00045 <span class="comment">  Modified mana.c to add a &quot;-O &lt;filename&gt;&quot; command line option (capital O)</span>
<a name="l00046"></a>00046 <span class="comment">  to specify a secondary ROOT output file.  This makes it possible to</span>
<a name="l00047"></a>00047 <span class="comment">  write skimmed data to a MIDAS file (with the usual &quot;-o&quot; option) and</span>
<a name="l00048"></a>00048 <span class="comment">  the associated histograms to a ROOT file.</span>
<a name="l00049"></a>00049 <span class="comment"></span>
<a name="l00050"></a>00050 <span class="comment">  Revision 1.1  2005/06/14 19:24:01  fegray</span>
<a name="l00051"></a>00051 <span class="comment">  (Slightly) customized version of the MIDAS analyzer framework that is</span>
<a name="l00052"></a>00052 <span class="comment">  needed for mu.</span>
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a>00054 <span class="comment">  Revision 1.118  2004/05/07 19:40:11  midas</span>
<a name="l00055"></a>00055 <span class="comment">  Replaced min/max by MIN/MAX macros</span>
<a name="l00056"></a>00056 <span class="comment"></span>
<a name="l00057"></a>00057 <span class="comment">  Revision 1.117  2004/02/12 08:21:22  midas</span>
<a name="l00058"></a>00058 <span class="comment">  Print ROOT server port on startup</span>
<a name="l00059"></a>00059 <span class="comment"></span>
<a name="l00060"></a>00060 <span class="comment">  Revision 1.116  2004/02/12 08:06:35  midas</span>
<a name="l00061"></a>00061 <span class="comment">  Added -s parameter for ROOT server</span>
<a name="l00062"></a>00062 <span class="comment"></span>
<a name="l00063"></a>00063 <span class="comment">  Revision 1.115  2004/01/18 08:25:10  olchansk</span>
<a name="l00064"></a>00064 <span class="comment">  replace PVM with HAVE_PVM to dodge namespace pollution on macosx</span>
<a name="l00065"></a>00065 <span class="comment"></span>
<a name="l00066"></a>00066 <span class="comment">  Revision 1.114  2004/01/17 05:35:53  olchansk</span>
<a name="l00067"></a>00067 <span class="comment">  replace #define ALIGN() with ALIGN8() to dodge namespace pollution under macosx</span>
<a name="l00068"></a>00068 <span class="comment">  hide strlcpy() &amp; co #ifdef HAVE_STRLCPY (macosx already has strlcpy())</span>
<a name="l00069"></a>00069 <span class="comment">  correct inconsistent prototype of dbg_malloc() and dbg_calloc()</span>
<a name="l00070"></a>00070 <span class="comment"></span>
<a name="l00071"></a>00071 <span class="comment">  Revision 1.113  2004/01/08 08:40:10  midas</span>
<a name="l00072"></a>00072 <span class="comment">  Implemented standard indentation</span>
<a name="l00073"></a>00073 <span class="comment"></span>
<a name="l00074"></a>00074 <span class="comment">  Revision 1.112  2003/12/18 17:42:12  midas</span>
<a name="l00075"></a>00075 <span class="comment">  Added &apos;P&apos; to HROPEN to work with uppercase directories in offline mode</span>
<a name="l00076"></a>00076 <span class="comment"></span>
<a name="l00077"></a>00077 <span class="comment">  Revision 1.111  2003/12/17 07:59:50  midas</span>
<a name="l00078"></a>00078 <span class="comment">  Improved previous error display</span>
<a name="l00079"></a>00079 <span class="comment"></span>
<a name="l00080"></a>00080 <span class="comment">  Revision 1.110  2003/12/17 07:52:32  midas</span>
<a name="l00081"></a>00081 <span class="comment">  Added error display if experiment not defined</span>
<a name="l00082"></a>00082 <span class="comment"></span>
<a name="l00083"></a>00083 <span class="comment">  Revision 1.109  2003/12/12 12:54:35  midas</span>
<a name="l00084"></a>00084 <span class="comment">  Warn about uppercase characters in HBOOK directory names</span>
<a name="l00085"></a>00085 <span class="comment"></span>
<a name="l00086"></a>00086 <span class="comment">  Revision 1.108  2003/12/12 12:52:24  midas</span>
<a name="l00087"></a>00087 <span class="comment">  Warn about uppercase characters in HBOOK directory names</span>
<a name="l00088"></a>00088 <span class="comment"></span>
<a name="l00089"></a>00089 <span class="comment">  Revision 1.107  2003/12/12 12:32:09  midas</span>
<a name="l00090"></a>00090 <span class="comment">  Fixed HBOOK compiler warnings</span>
<a name="l00091"></a>00091 <span class="comment"></span>
<a name="l00092"></a>00092 <span class="comment">  Revision 1.106  2003/12/04 12:51:18  midas</span>
<a name="l00093"></a>00093 <span class="comment">  Fixed problem when output file does not contain a &apos;.&apos;</span>
<a name="l00094"></a>00094 <span class="comment"></span>
<a name="l00095"></a>00095 <span class="comment">  Revision 1.105  2003/11/24 08:22:45  midas</span>
<a name="l00096"></a>00096 <span class="comment">  Changed timeouts from INT to DWORD, added ignore_timeout to cm_cleanup, adde &apos;-f&apos; flag to ODBEdit &apos;cleanup&apos;</span>
<a name="l00097"></a>00097 <span class="comment"></span>
<a name="l00098"></a>00098 <span class="comment">  Revision 1.104  2003/11/20 11:29:44  midas</span>
<a name="l00099"></a>00099 <span class="comment">  Implemented db_check_record and use it in most places instead of db_create_record</span>
<a name="l00100"></a>00100 <span class="comment"></span>
<a name="l00101"></a>00101 <span class="comment">  Revision 1.103  2003/11/01 23:21:30  olchansk</span>
<a name="l00102"></a>00102 <span class="comment">  per Stephan Ritt&apos;s request, remove #error Please defeine either -DHAVE_HBOOK or -DHAVE_ROOT</span>
<a name="l00103"></a>00103 <span class="comment"></span>
<a name="l00104"></a>00104 <span class="comment">  Revision 1.102  2003/11/01 01:25:11  olchansk</span>
<a name="l00105"></a>00105 <span class="comment">  abort if cannto read /runinfo/run number</span>
<a name="l00106"></a>00106 <span class="comment">  abort on invalid run numbers</span>
<a name="l00107"></a>00107 <span class="comment">  abort if cannot write /runinfo/run number</span>
<a name="l00108"></a>00108 <span class="comment"></span>
<a name="l00109"></a>00109 <span class="comment">  Revision 1.101  2003/10/29 14:37:14  midas</span>
<a name="l00110"></a>00110 <span class="comment">  Don&apos;t book NTUPLES for unknown events</span>
<a name="l00111"></a>00111 <span class="comment"></span>
<a name="l00112"></a>00112 <span class="comment">  Revision 1.100  2003/10/29 14:33:46  midas</span>
<a name="l00113"></a>00113 <span class="comment">  Test for either HAVE_HBOOK or HAVE_ROOT</span>
<a name="l00114"></a>00114 <span class="comment"></span>
<a name="l00115"></a>00115 <span class="comment">  Revision 1.99  2003/10/03 18:57:40  pierre</span>
<a name="l00116"></a>00116 <span class="comment">  fix error msg</span>
<a name="l00117"></a>00117 <span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">  Revision 1.98  2003/05/09 07:40:04  midas</span>
<a name="l00119"></a>00119 <span class="comment">  Added extra parameter to cm_get_environment</span>
<a name="l00120"></a>00120 <span class="comment"></span>
<a name="l00121"></a>00121 <span class="comment">  Revision 1.97  2003/05/02 09:03:01  midas</span>
<a name="l00122"></a>00122 <span class="comment">  Fixed buffer overflows by strlcpy()</span>
<a name="l00123"></a>00123 <span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment">  Revision 1.96  2003/04/30 12:58:50  midas</span>
<a name="l00125"></a>00125 <span class="comment">  Load HBOOK histos after booking</span>
<a name="l00126"></a>00126 <span class="comment"></span>
<a name="l00127"></a>00127 <span class="comment">  Revision 1.95  2003/04/28 11:13:18  midas</span>
<a name="l00128"></a>00128 <span class="comment">  Moved ss_force_single_thread() befor cm_connect_experiment</span>
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="comment">  Revision 1.94  2003/04/25 14:04:26  midas</span>
<a name="l00131"></a>00131 <span class="comment">  Fixed wrong #ifdef HAVE_ROOT</span>
<a name="l00132"></a>00132 <span class="comment"></span>
<a name="l00133"></a>00133 <span class="comment">  Revision 1.93  2003/04/25 13:29:23  midas</span>
<a name="l00134"></a>00134 <span class="comment">  Added ss_force_single_thread()</span>
<a name="l00135"></a>00135 <span class="comment"></span>
<a name="l00136"></a>00136 <span class="comment">  Revision 1.92  2003/04/25 11:53:22  midas</span>
<a name="l00137"></a>00137 <span class="comment">  Added ROOT histo server</span>
<a name="l00138"></a>00138 <span class="comment"></span>
<a name="l00139"></a>00139 <span class="comment">  Revision 1.91  2003/04/23 15:30:17  midas</span>
<a name="l00140"></a>00140 <span class="comment">  Fixed compiler warnings under g++</span>
<a name="l00141"></a>00141 <span class="comment"></span>
<a name="l00142"></a>00142 <span class="comment">  Revision 1.90  2003/04/23 15:08:02  midas</span>
<a name="l00143"></a>00143 <span class="comment">  Added TTree output</span>
<a name="l00144"></a>00144 <span class="comment"></span>
<a name="l00145"></a>00145 <span class="comment">  Revision 1.89  2003/04/22 14:58:17  midas</span>
<a name="l00146"></a>00146 <span class="comment">  Made histogram loading from last.root work</span>
<a name="l00147"></a>00147 <span class="comment"></span>
<a name="l00148"></a>00148 <span class="comment">  Revision 1.88  2003/04/22 12:07:22  midas</span>
<a name="l00149"></a>00149 <span class="comment">  Made mana.c compile under Visual C++, added TApplication to make select() work</span>
<a name="l00150"></a>00150 <span class="comment"></span>
<a name="l00151"></a>00151 <span class="comment">  Revision 1.87  2003/04/21 03:22:59  olchansk</span>
<a name="l00152"></a>00152 <span class="comment">  remove \t</span>
<a name="l00153"></a>00153 <span class="comment">  fix missing calls to CloseRootOutputFile()</span>
<a name="l00154"></a>00154 <span class="comment">  fix call to gManaOutputTree-&gt;Fill();</span>
<a name="l00155"></a>00155 <span class="comment"></span>
<a name="l00156"></a>00156 <span class="comment">  Revision 1.86  2003/04/20 03:07:12  olchansk</span>
<a name="l00157"></a>00157 <span class="comment">  fix botched #ifdef HAVE_HBOOK around ana_callback()</span>
<a name="l00158"></a>00158 <span class="comment"></span>
<a name="l00159"></a>00159 <span class="comment">  Revision 1.85  2003/04/20 02:59:13  olchansk</span>
<a name="l00160"></a>00160 <span class="comment">  merge ROOT code into mana.c</span>
<a name="l00161"></a>00161 <span class="comment">  remove MANA_LITE, replaced with HAVE_HBOOK, HAVE_ROOT</span>
<a name="l00162"></a>00162 <span class="comment">  ROOT histogramming support almost complete,</span>
<a name="l00163"></a>00163 <span class="comment">  ROOT TTree filling is missing</span>
<a name="l00164"></a>00164 <span class="comment">  all ROOT code is untested, but compiles with RH-8.0, GCC-3.2, ROOT v3.05.03</span>
<a name="l00165"></a>00165 <span class="comment"></span>
<a name="l00166"></a>00166 <span class="comment">  Revision 1.84  2003/04/07 23:59:41  olchansk</span>
<a name="l00167"></a>00167 <span class="comment">  make mana.c compilable with g++ 3.2</span>
<a name="l00168"></a>00168 <span class="comment">  replace all &apos;\t&apos; with spaces</span>
<a name="l00169"></a>00169 <span class="comment"></span>
<a name="l00170"></a>00170 <span class="comment">  Revision 1.83  2003/03/31 08:27:34  midas</span>
<a name="l00171"></a>00171 <span class="comment">  Fixed alignment bug for strings</span>
<a name="l00172"></a>00172 <span class="comment"></span>
<a name="l00173"></a>00173 <span class="comment">  Revision 1.82  2002/11/28 09:43:46  midas</span>
<a name="l00174"></a>00174 <span class="comment">  Added &apos;-o OFLN&apos; option to produce PAW shared memory in offline mode</span>
<a name="l00175"></a>00175 <span class="comment"></span>
<a name="l00176"></a>00176 <span class="comment">  Revision 1.81  2002/09/17 22:12:10  pierre</span>
<a name="l00177"></a>00177 <span class="comment">  add arg to cm_cleanup</span>
<a name="l00178"></a>00178 <span class="comment"></span>
<a name="l00179"></a>00179 <span class="comment">  Revision 1.80  2002/08/13 14:34:18  midas</span>
<a name="l00180"></a>00180 <span class="comment">  Added event header byte swapping for offline analysis on RS6000 system</span>
<a name="l00181"></a>00181 <span class="comment"></span>
<a name="l00182"></a>00182 <span class="comment">  Revision 1.79  2002/06/03 06:07:15  midas</span>
<a name="l00183"></a>00183 <span class="comment">  Added extra parameter to ss_daemon_init to keep stdout</span>
<a name="l00184"></a>00184 <span class="comment"></span>
<a name="l00185"></a>00185 <span class="comment">  Revision 1.78  2002/05/10 05:21:50  pierre</span>
<a name="l00186"></a>00186 <span class="comment">  add MANA_LITE #ifdef</span>
<a name="l00187"></a>00187 <span class="comment"></span>
<a name="l00188"></a>00188 <span class="comment">  Revision 1.77  2002/05/09 01:57:37  midas</span>
<a name="l00189"></a>00189 <span class="comment">  Set &apos;events to ODB&apos; TRUE by default</span>
<a name="l00190"></a>00190 <span class="comment"></span>
<a name="l00191"></a>00191 <span class="comment">  Revision 1.76  2002/05/08 22:15:03  pierre</span>
<a name="l00192"></a>00192 <span class="comment">  add db_get_value arg</span>
<a name="l00193"></a>00193 <span class="comment"></span>
<a name="l00194"></a>00194 <span class="comment">  Revision 1.75  2002/05/08 19:54:40  midas</span>
<a name="l00195"></a>00195 <span class="comment">  Added extra parameter to function db_get_value()</span>
<a name="l00196"></a>00196 <span class="comment"></span>
<a name="l00197"></a>00197 <span class="comment">  Revision 1.74  2001/11/09 20:27:53  pierre</span>
<a name="l00198"></a>00198 <span class="comment">  Fix replay for YBOS format</span>
<a name="l00199"></a>00199 <span class="comment"></span>
<a name="l00200"></a>00200 <span class="comment">  Revision 1.73  2001/01/30 09:13:04  midas</span>
<a name="l00201"></a>00201 <span class="comment">  Correct for increased event size</span>
<a name="l00202"></a>00202 <span class="comment"></span>
<a name="l00203"></a>00203 <span class="comment">  Revision 1.72  2001/01/29 15:27:43  midas</span>
<a name="l00204"></a>00204 <span class="comment">  Added some \n for parallel version</span>
<a name="l00205"></a>00205 <span class="comment"></span>
<a name="l00206"></a>00206 <span class="comment">  Revision 1.71  2000/11/20 12:18:58  midas</span>
<a name="l00207"></a>00207 <span class="comment">  Merge more than 10 RZ files</span>
<a name="l00208"></a>00208 <span class="comment"></span>
<a name="l00209"></a>00209 <span class="comment">  Revision 1.70  2000/11/20 11:26:53  midas</span>
<a name="l00210"></a>00210 <span class="comment">  Added &quot;use tests&quot; in analyzer request</span>
<a name="l00211"></a>00211 <span class="comment"></span>
<a name="l00212"></a>00212 <span class="comment">  Revision 1.69  2000/11/17 08:25:45  midas</span>
<a name="l00213"></a>00213 <span class="comment">  Added disable_shm_write flag for Linux cluster applications</span>
<a name="l00214"></a>00214 <span class="comment"></span>
<a name="l00215"></a>00215 <span class="comment">  Revision 1.68  2000/11/15 14:02:08  midas</span>
<a name="l00216"></a>00216 <span class="comment">  Some more work on PVM, but not yet finished</span>
<a name="l00217"></a>00217 <span class="comment"></span>
<a name="l00218"></a>00218 <span class="comment">  Revision 1.67  2000/11/08 15:03:00  midas</span>
<a name="l00219"></a>00219 <span class="comment">  Fixed bug that elapsed time was zero after EOR event</span>
<a name="l00220"></a>00220 <span class="comment"></span>
<a name="l00221"></a>00221 <span class="comment">  Revision 1.66  2000/11/08 14:47:40  midas</span>
<a name="l00222"></a>00222 <span class="comment">  Analyzer now stops with &apos;!&apos; also in -r (multi run) mode</span>
<a name="l00223"></a>00223 <span class="comment"></span>
<a name="l00224"></a>00224 <span class="comment">  Revision 1.65  2000/10/30 10:07:24  midas</span>
<a name="l00225"></a>00225 <span class="comment">  Fixed bug that &quot;always true&quot; test was cleared at the BOR</span>
<a name="l00226"></a>00226 <span class="comment"></span>
<a name="l00227"></a>00227 <span class="comment">  Revision 1.64  2000/09/18 09:22:23  midas</span>
<a name="l00228"></a>00228 <span class="comment">  Fixed bug which limited output event size to 64k</span>
<a name="l00229"></a>00229 <span class="comment"></span>
<a name="l00230"></a>00230 <span class="comment">  Revision 1.63  2000/08/10 07:44:50  midas</span>
<a name="l00231"></a>00231 <span class="comment">  Made PAW global memory name variable under /analyzer/output/global memeory name</span>
<a name="l00232"></a>00232 <span class="comment">  to run more than one online analyzer instance on one machine</span>
<a name="l00233"></a>00233 <span class="comment"></span>
<a name="l00234"></a>00234 <span class="comment">  Revision 1.62  2000/06/06 13:41:09  midas</span>
<a name="l00235"></a>00235 <span class="comment">  Added lock_histo to prevent histos from being cleared</span>
<a name="l00236"></a>00236 <span class="comment"></span>
<a name="l00237"></a>00237 <span class="comment">  Revision 1.61  2000/06/06 11:22:02  midas</span>
<a name="l00238"></a>00238 <span class="comment">  Added EXT_EVENT_SIZE, partially implemented PVM stuff</span>
<a name="l00239"></a>00239 <span class="comment"></span>
<a name="l00240"></a>00240 <span class="comment">  Revision 1.60  2000/05/09 08:42:58  midas</span>
<a name="l00241"></a>00241 <span class="comment">  Call analyzer_init after ODB load to correct record structures</span>
<a name="l00242"></a>00242 <span class="comment"></span>
<a name="l00243"></a>00243 <span class="comment">  Revision 1.59  2000/05/09 08:00:58  midas</span>
<a name="l00244"></a>00244 <span class="comment">  Fixed bug with file not found in ma_open</span>
<a name="l00245"></a>00245 <span class="comment"></span>
<a name="l00246"></a>00246 <span class="comment">  Revision 1.58  2000/05/05 08:44:09  midas</span>
<a name="l00247"></a>00247 <span class="comment">  Added ybos_get_tid_size</span>
<a name="l00248"></a>00248 <span class="comment"></span>
<a name="l00249"></a>00249 <span class="comment">  Revision 1.57  2000/03/23 08:50:37  midas</span>
<a name="l00250"></a>00250 <span class="comment">  Changed comments</span>
<a name="l00251"></a>00251 <span class="comment"></span>
<a name="l00252"></a>00252 <span class="comment">  Revision 1.56  2000/03/13 16:37:10  midas</span>
<a name="l00253"></a>00253 <span class="comment">  Add data directory to last.rz if no directory present already in ODB key</span>
<a name="l00254"></a>00254 <span class="comment"></span>
<a name="l00255"></a>00255 <span class="comment">  Revision 1.55  2000/03/08 17:39:35  midas</span>
<a name="l00256"></a>00256 <span class="comment">  Added &quot;/analyzer/output/events to odb&quot; flag</span>
<a name="l00257"></a>00257 <span class="comment"></span>
<a name="l00258"></a>00258 <span class="comment">  Revision 1.54  2000/03/06 22:39:06  midas</span>
<a name="l00259"></a>00259 <span class="comment">  Moved last.rz to /analyzer/output so that it can be changed, including a path</span>
<a name="l00260"></a>00260 <span class="comment"></span>
<a name="l00261"></a>00261 <span class="comment">  Revision 1.53  2000/03/01 23:04:18  midas</span>
<a name="l00262"></a>00262 <span class="comment">  Added correct_num_events</span>
<a name="l00263"></a>00263 <span class="comment"></span>
<a name="l00264"></a>00264 <span class="comment">  Revision 1.52  2000/02/15 11:07:50  midas</span>
<a name="l00265"></a>00265 <span class="comment">  Changed GET_xxx to bit flags</span>
<a name="l00266"></a>00266 <span class="comment"></span>
<a name="l00267"></a>00267 <span class="comment">  Revision 1.51  2000/02/09 09:32:00  midas</span>
<a name="l00268"></a>00268 <span class="comment">  Speed up analyzer start</span>
<a name="l00269"></a>00269 <span class="comment"></span>
<a name="l00270"></a>00270 <span class="comment">  Revision 1.50  2000/02/01 08:26:09  midas</span>
<a name="l00271"></a>00271 <span class="comment">  Added -P (protect) flag</span>
<a name="l00272"></a>00272 <span class="comment"></span>
<a name="l00273"></a>00273 <span class="comment">  Revision 1.49  2000/01/21 08:38:47  midas</span>
<a name="l00274"></a>00274 <span class="comment">  Added event size check for analyzer event extension</span>
<a name="l00275"></a>00275 <span class="comment"></span>
<a name="l00276"></a>00276 <span class="comment">  Revision 1.48  2000/01/20 12:04:31  midas</span>
<a name="l00277"></a>00277 <span class="comment">  Fixed bug when opening offline files</span>
<a name="l00278"></a>00278 <span class="comment"></span>
<a name="l00279"></a>00279 <span class="comment">  Revision 1.47  1999/12/21 09:40:27  midas</span>
<a name="l00280"></a>00280 <span class="comment">  Ajdusted spaces</span>
<a name="l00281"></a>00281 <span class="comment"></span>
<a name="l00282"></a>00282 <span class="comment">  Revision 1.46  1999/12/20 22:12:15  pierre</span>
<a name="l00283"></a>00283 <span class="comment">  - moved yb_tid_size[] in ybos.c, declared extern</span>
<a name="l00284"></a>00284 <span class="comment"></span>
<a name="l00285"></a>00285 <span class="comment">  Revision 1.45  1999/12/17 00:10:47  pierre</span>
<a name="l00286"></a>00286 <span class="comment">  - Add YBOS support.</span>
<a name="l00287"></a>00287 <span class="comment"></span>
<a name="l00288"></a>00288 <span class="comment">  Revision 1.44  1999/11/29 14:04:31  midas</span>
<a name="l00289"></a>00289 <span class="comment">  Fixed bug that with RWNT all events were filled, even if buffer size = 0</span>
<a name="l00290"></a>00290 <span class="comment"></span>
<a name="l00291"></a>00291 <span class="comment">  Revision 1.43  1999/11/29 11:27:23  midas</span>
<a name="l00292"></a>00292 <span class="comment">  Made HBOOK record size LREC changable via command line parameter -L</span>
<a name="l00293"></a>00293 <span class="comment"></span>
<a name="l00294"></a>00294 <span class="comment">  Revision 1.42  1999/11/29 09:14:45  midas</span>
<a name="l00295"></a>00295 <span class="comment">  Do a automatic cleanup if running offline</span>
<a name="l00296"></a>00296 <span class="comment"></span>
<a name="l00297"></a>00297 <span class="comment">  Revision 1.41  1999/11/26 12:04:49  midas</span>
<a name="l00298"></a>00298 <span class="comment">  Added additional error message when creating module parameters in ODB</span>
<a name="l00299"></a>00299 <span class="comment"></span>
<a name="l00300"></a>00300 <span class="comment">  Revision 1.40  1999/11/23 15:49:41  midas</span>
<a name="l00301"></a>00301 <span class="comment">  Allocate local event buffers according to MAX_EVENT_SIZE</span>
<a name="l00302"></a>00302 <span class="comment"></span>
<a name="l00303"></a>00303 <span class="comment">  Revision 1.39  1999/10/18 14:41:51  midas</span>
<a name="l00304"></a>00304 <span class="comment">  Use /programs/&lt;name&gt;/Watchdog timeout in all programs as timeout value. The</span>
<a name="l00305"></a>00305 <span class="comment">  default value can be submitted by calling cm_connect_experiment1(..., timeout)</span>
<a name="l00306"></a>00306 <span class="comment"></span>
<a name="l00307"></a>00307 <span class="comment">  Revision 1.38  1999/10/11 14:59:24  midas</span>
<a name="l00308"></a>00308 <span class="comment">  Moved the daemonizing before the cm_connect_experiment</span>
<a name="l00309"></a>00309 <span class="comment"></span>
<a name="l00310"></a>00310 <span class="comment">  Revision 1.37  1999/10/11 14:45:01  midas</span>
<a name="l00311"></a>00311 <span class="comment">  Added note about becoming a daemon</span>
<a name="l00312"></a>00312 <span class="comment"></span>
<a name="l00313"></a>00313 <span class="comment">  Revision 1.36  1999/10/11 14:40:04  midas</span>
<a name="l00314"></a>00314 <span class="comment">  Added -D flag (become daemon)</span>
<a name="l00315"></a>00315 <span class="comment"></span>
<a name="l00316"></a>00316 <span class="comment">  Revision 1.35  1999/10/08 13:17:11  midas</span>
<a name="l00317"></a>00317 <span class="comment">  Fixed wrongly booked N-tuple #100000 when loading from last.rz</span>
<a name="l00318"></a>00318 <span class="comment"></span>
<a name="l00319"></a>00319 <span class="comment">  Revision 1.34  1999/10/06 10:42:40  midas</span>
<a name="l00320"></a>00320 <span class="comment">  Added -l flag not to load histos from last.rz</span>
<a name="l00321"></a>00321 <span class="comment"></span>
<a name="l00322"></a>00322 <span class="comment">  Revision 1.33  1999/09/23 12:45:48  midas</span>
<a name="l00323"></a>00323 <span class="comment">  Added 32 bit banks</span>
<a name="l00324"></a>00324 <span class="comment"></span>
<a name="l00325"></a>00325 <span class="comment">  Revision 1.32  1999/08/20 14:26:24  midas</span>
<a name="l00326"></a>00326 <span class="comment">  Do last.rz existence checking before loading</span>
<a name="l00327"></a>00327 <span class="comment"></span>
<a name="l00328"></a>00328 <span class="comment">  Revision 1.31  1999/08/20 13:31:18  midas</span>
<a name="l00329"></a>00329 <span class="comment">  Analyzer saves and reloads online histos</span>
<a name="l00330"></a>00330 <span class="comment"></span>
<a name="l00331"></a>00331 <span class="comment">  Revision 1.30  1999/08/16 08:28:42  midas</span>
<a name="l00332"></a>00332 <span class="comment">  Fixed bug with wrong run number extraction from tape1/run123456.mid</span>
<a name="l00333"></a>00333 <span class="comment"></span>
<a name="l00334"></a>00334 <span class="comment">  Revision 1.29  1999/08/13 13:49:14  midas</span>
<a name="l00335"></a>00335 <span class="comment">  Extract current_run_number from BOR event</span>
<a name="l00336"></a>00336 <span class="comment"></span>
<a name="l00337"></a>00337 <span class="comment">  Revision 1.28  1999/08/12 14:39:10  midas</span>
<a name="l00338"></a>00338 <span class="comment">  Fixed bug where from serveral input files specified via &quot;-i xxx.mid yyy.mid&quot;</span>
<a name="l00339"></a>00339 <span class="comment">  only the last one was contained in the output file.</span>
<a name="l00340"></a>00340 <span class="comment"></span>
<a name="l00341"></a>00341 <span class="comment">  Revision 1.27  1999/08/12 14:09:31  midas</span>
<a name="l00342"></a>00342 <span class="comment">  Changed -f flag from filter ID to &quot;copy original event if analyer accepts it&quot;</span>
<a name="l00343"></a>00343 <span class="comment"></span>
<a name="l00344"></a>00344 <span class="comment">  Revision 1.26  1999/07/22 07:04:56  midas</span>
<a name="l00345"></a>00345 <span class="comment">  Only dump histos in online mode</span>
<a name="l00346"></a>00346 <span class="comment"></span>
<a name="l00347"></a>00347 <span class="comment">  Revision 1.25  1999/07/21 09:22:01  midas</span>
<a name="l00348"></a>00348 <span class="comment">  Added Ctrl-C handler to cm_connect_experiment and cm_yield</span>
<a name="l00349"></a>00349 <span class="comment"></span>
<a name="l00350"></a>00350 <span class="comment">  Revision 1.24  1999/07/15 07:35:25  midas</span>
<a name="l00351"></a>00351 <span class="comment">  Added Ctrl-C handling</span>
<a name="l00352"></a>00352 <span class="comment"></span>
<a name="l00353"></a>00353 <span class="comment">  Revision 1.23  1999/07/15 06:51:17  midas</span>
<a name="l00354"></a>00354 <span class="comment">  Don&apos;t call ss_getchar in &quot;quiet&quot; mode not to block tty</span>
<a name="l00355"></a>00355 <span class="comment"></span>
<a name="l00356"></a>00356 <span class="comment">  Revision 1.22  1999/07/13 08:16:45  midas</span>
<a name="l00357"></a>00357 <span class="comment">  -q flag makes now analyzer really quiet (not to block the terminal in BG)</span>
<a name="l00358"></a>00358 <span class="comment"></span>
<a name="l00359"></a>00359 <span class="comment">  Revision 1.21  1999/07/12 11:22:51  midas</span>
<a name="l00360"></a>00360 <span class="comment">  Added tests</span>
<a name="l00361"></a>00361 <span class="comment"></span>
<a name="l00362"></a>00362 <span class="comment">  Revision 1.20  1999/07/02 13:40:53  midas</span>
<a name="l00363"></a>00363 <span class="comment">  Write periodic and slow events always to ODB, not only every second</span>
<a name="l00364"></a>00364 <span class="comment"></span>
<a name="l00365"></a>00365 <span class="comment">  Revision 1.19  1999/07/02 13:27:26  midas</span>
<a name="l00366"></a>00366 <span class="comment">  Removed *par from write_event_odb (for external use)</span>
<a name="l00367"></a>00367 <span class="comment"></span>
<a name="l00368"></a>00368 <span class="comment">  Revision 1.18  1999/06/24 11:59:17  midas</span>
<a name="l00369"></a>00369 <span class="comment">  Fixed filling of N-tuples if RWNT_SIZE equals zero</span>
<a name="l00370"></a>00370 <span class="comment"></span>
<a name="l00371"></a>00371 <span class="comment">  Revision 1.17  1999/06/23 09:37:26  midas</span>
<a name="l00372"></a>00372 <span class="comment">  Print time for offline analysis</span>
<a name="l00373"></a>00373 <span class="comment"></span>
<a name="l00374"></a>00374 <span class="comment">  Revision 1.16  1999/05/20 07:37:22  midas</span>
<a name="l00375"></a>00375 <span class="comment">  Fixed bug with ss_getchar() when running online</span>
<a name="l00376"></a>00376 <span class="comment"></span>
<a name="l00377"></a>00377 <span class="comment">  Revision 1.15  1999/04/22 07:53:37  midas</span>
<a name="l00378"></a>00378 <span class="comment">  Added event size in -verbose output</span>
<a name="l00379"></a>00379 <span class="comment"></span>
<a name="l00380"></a>00380 <span class="comment">  Revision 1.14  1999/03/02 10:00:37  midas</span>
<a name="l00381"></a>00381 <span class="comment">  Used ANA_SKIP/CONTINUE for skipping events</span>
<a name="l00382"></a>00382 <span class="comment"></span>
<a name="l00383"></a>00383 <span class="comment">  Revision 1.13  1999/02/22 11:55:20  midas</span>
<a name="l00384"></a>00384 <span class="comment">  Fixed bug with rebooking of N-tuples</span>
<a name="l00385"></a>00385 <span class="comment"></span>
<a name="l00386"></a>00386 <span class="comment">  Revision 1.12  1999/02/03 16:36:50  midas</span>
<a name="l00387"></a>00387 <span class="comment">  Added -f flag to filter events</span>
<a name="l00388"></a>00388 <span class="comment"></span>
<a name="l00389"></a>00389 <span class="comment">  Revision 1.11  1999/02/01 15:47:47  midas</span>
<a name="l00390"></a>00390 <span class="comment">  - removed ASCII read function (only historical for pibeta)</span>
<a name="l00391"></a>00391 <span class="comment">  - analyze_file puts current offline run number into ODB</span>
<a name="l00392"></a>00392 <span class="comment"></span>
<a name="l00393"></a>00393 <span class="comment">  Revision 1.10  1999/01/15 12:50:04  midas</span>
<a name="l00394"></a>00394 <span class="comment">  - Set /Analyzer/Bank switches/... to FALSE by default to avoid N-tuple</span>
<a name="l00395"></a>00395 <span class="comment">    overflow when an analyzer is started the first time</span>
<a name="l00396"></a>00396 <span class="comment">  - Assume MIDAS data format on /dev/... input</span>
<a name="l00397"></a>00397 <span class="comment"></span>
<a name="l00398"></a>00398 <span class="comment">  Revision 1.9  1999/01/08 15:00:53  midas</span>
<a name="l00399"></a>00399 <span class="comment">  Analyzer does not stop if a file in a range of files is missing</span>
<a name="l00400"></a>00400 <span class="comment"></span>
<a name="l00401"></a>00401 <span class="comment">  Revision 1.8  1998/12/16 11:07:41  midas</span>
<a name="l00402"></a>00402 <span class="comment">  - verbose output (via -v flag) for N-Tuple booking</span>
<a name="l00403"></a>00403 <span class="comment">  - error message if histo dump is on when running online</span>
<a name="l00404"></a>00404 <span class="comment"></span>
<a name="l00405"></a>00405 <span class="comment">  Revision 1.7  1998/12/10 12:50:47  midas</span>
<a name="l00406"></a>00406 <span class="comment">  Program abort with &quot;!&quot; now works without a return under UNIX</span>
<a name="l00407"></a>00407 <span class="comment"></span>
<a name="l00408"></a>00408 <span class="comment">  Revision 1.6  1998/12/10 05:28:18  midas</span>
<a name="l00409"></a>00409 <span class="comment">  Removed convert-only flag, added -v (verbose) flag</span>
<a name="l00410"></a>00410 <span class="comment"></span>
<a name="l00411"></a>00411 <span class="comment">  Revision 1.5  1998/10/29 14:37:58  midas</span>
<a name="l00412"></a>00412 <span class="comment">  Fixed problem with &apos;!&apos; for stopping analyzer</span>
<a name="l00413"></a>00413 <span class="comment"></span>
<a name="l00414"></a>00414 <span class="comment">  Revision 1.4  1998/10/22 07:11:15  midas</span>
<a name="l00415"></a>00415 <span class="comment">  *** empty log message ***</span>
<a name="l00416"></a>00416 <span class="comment"></span>
<a name="l00417"></a>00417 <span class="comment">  Revision 1.3  1998/10/19 16:40:44  midas</span>
<a name="l00418"></a>00418 <span class="comment">  ASCII output of multi-module LRS1877 now possible</span>
<a name="l00419"></a>00419 <span class="comment"></span>
<a name="l00420"></a>00420 <span class="comment">  Revision 1.2  1998/10/12 12:19:01  midas</span>
<a name="l00421"></a>00421 <span class="comment">  Added Log tag in header</span>
<a name="l00422"></a>00422 <span class="comment"></span>
<a name="l00423"></a>00423 <span class="comment"></span>
<a name="l00424"></a>00424 <span class="comment">\********************************************************************/</span>
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00427"></a>00427 <span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<a name="l00428"></a>00428 <span class="preprocessor">#include &quot;<a class="code" href="msystem_8h.html">msystem.h</a>&quot;</span>
<a name="l00429"></a>00429 <span class="preprocessor">#include &quot;<a class="code" href="hardware_8h.html">hardware.h</a>&quot;</span>
<a name="l00430"></a>00430 <span class="preprocessor">#include &quot;<a class="code" href="zlib_8h.html">zlib.h</a>&quot;</span>
<a name="l00431"></a>00431 <span class="preprocessor">#include &quot;<a class="code" href="ybos_8h.html">ybos.h</a>&quot;</span>
<a name="l00432"></a>00432 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00435"></a>00435 
<a name="l00436"></a>00436 <span class="comment">/* cernlib includes */</span>
<a name="l00437"></a>00437 <span class="preprocessor">#ifdef OS_WINNT</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span><span class="preprocessor">#define VISUAL_CPLUSPLUS</span>
<a name="l00439"></a>00439 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00440"></a>00440 <span class="preprocessor"></span>
<a name="l00441"></a>00441 <span class="preprocessor">#ifdef OS_LINUX</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span><span class="preprocessor">#define f2cFortran</span>
<a name="l00443"></a>00443 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00444"></a>00444 <span class="preprocessor"></span>
<a name="l00445"></a>00445 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span>
<a name="l00447"></a>00447 <span class="preprocessor">#include &lt;<a class="code" href="cfortran_8h.html">cfortran.h</a>&gt;</span>
<a name="l00448"></a>00448 <span class="preprocessor">#include &lt;<a class="code" href="hbook_8h.html">hbook.h</a>&gt;</span>
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="comment">/* missing in hbook.h */</span>
<a name="l00451"></a>00451 <span class="preprocessor">#ifndef HFNOV</span>
<a name="l00452"></a>00452 <span class="preprocessor"></span><span class="preprocessor">#define HFNOV(A1,A2)  CCALLSFSUB2(HFNOV,hfnov,INT,FLOATV,A1,A2)</span>
<a name="l00453"></a>00453 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00454"></a>00454 <span class="preprocessor"></span>
<a name="l00455"></a>00455 <span class="preprocessor">#ifndef HMERGE</span>
<a name="l00456"></a>00456 <span class="preprocessor"></span><span class="preprocessor">#define HMERGE(A1,A2,A3)  CCALLSFSUB3(HMERGE,hmerge,INT,STRINGV,STRING,A1,A2,A3)</span>
<a name="l00457"></a>00457 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00458"></a>00458 <span class="preprocessor"></span>
<a name="l00459"></a>00459 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l00464"></a>00464 <span class="preprocessor"></span>
<a name="l00465"></a>00465 <span class="preprocessor">#undef abs</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span>
<a name="l00467"></a>00467 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00468"></a>00468 <span class="preprocessor">#include &lt;TApplication.h&gt;</span>
<a name="l00469"></a>00469 <span class="preprocessor">#include &lt;TKey.h&gt;</span>
<a name="l00470"></a>00470 <span class="preprocessor">#include &lt;TROOT.h&gt;</span>
<a name="l00471"></a>00471 <span class="preprocessor">#include &lt;TH1.h&gt;</span>
<a name="l00472"></a>00472 <span class="preprocessor">#include &lt;TFile.h&gt;</span>
<a name="l00473"></a>00473 <span class="preprocessor">#include &lt;TTree.h&gt;</span>
<a name="l00474"></a>00474 <span class="preprocessor">#include &lt;TLeaf.h&gt;</span>
<a name="l00475"></a>00475 <span class="preprocessor">#include &lt;TSocket.h&gt;</span>
<a name="l00476"></a>00476 <span class="preprocessor">#include &lt;TServerSocket.h&gt;</span>
<a name="l00477"></a>00477 <span class="preprocessor">#include &lt;TMessage.h&gt;</span>
<a name="l00478"></a>00478 <span class="preprocessor">#include &lt;TObjString.h&gt;</span>
<a name="l00479"></a>00479 <span class="preprocessor">#include &lt;TSystem.h&gt;</span>
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 <span class="preprocessor">#ifdef OS_LINUX</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span><span class="preprocessor">#include &lt;TThread.h&gt;</span>
<a name="l00483"></a>00483 <span class="preprocessor">#endif</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>
<a name="l00485"></a>00485 <span class="comment">/* Our own ROOT global objects */</span>
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 TApplication *<a class="code" href="MDQ__Amplitude_8cpp.html#afd64558b184072361ea06d2b253ae428">manaApp</a>;
<a name="l00488"></a>00488 TDirectory *<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a> = NULL;       <span class="comment">// Container for all histograms</span>
<a name="l00489"></a>00489 TFile *<a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a> = NULL;  <span class="comment">// MIDAS output file</span>
<a name="l00490"></a>00490 <span class="keywordtype">char</span> *<a class="code" href="MTreeOutput_8cpp.html#a1eb4ae60b0d63b452d2b8c0341985730">gMiasTreeOutputFileName</a> = NULL;  <span class="comment">// MIAS ROOT Tree output file</span>
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 <span class="comment">/* MIDAS output tree structure holing one tree per event type */</span>
<a name="l00493"></a>00493 
<a name="l00494"></a>00494 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00495"></a>00495    <span class="keywordtype">int</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l00496"></a>00496    TTree *tree;
<a name="l00497"></a>00497    <span class="keywordtype">int</span> n_branch;
<a name="l00498"></a>00498    <span class="keywordtype">char</span> *branch_name;
<a name="l00499"></a>00499    <span class="keywordtype">int</span> *branch_filled;
<a name="l00500"></a>00500    <span class="keywordtype">int</span> *branch_len;
<a name="l00501"></a>00501    TBranch **<a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>;
<a name="l00502"></a>00502 } EVENT_TREE;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00505"></a>00505    TFile *f;
<a name="l00506"></a>00506    <span class="keywordtype">int</span> n_tree;
<a name="l00507"></a>00507    EVENT_TREE *event_tree;
<a name="l00508"></a>00508 } TREE_STRUCT;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510 TREE_STRUCT tree_struct;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l00513"></a>00513 
<a name="l00514"></a>00514 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 <span class="comment">/* PVM include */</span>
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span>
<a name="l00520"></a>00520 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> pvm_start_time = 0;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 <span class="keyword">extern</span> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="group__msfunctionc.html#ga92e8e4e8fae25311b5816a776399a0c1">disable_shm_write</a>;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 <span class="keywordtype">void</span> pvm_debug(<span class="keywordtype">char</span> *<a class="code" href="webpaw_8c.html#a6113855b8e5965f1e91ee407b4026ab7">format</a>, ...)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526    va_list argptr;
<a name="l00527"></a>00527    <span class="keywordtype">char</span> msg[256], <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l00528"></a>00528 
<a name="l00529"></a>00529    <span class="keywordflow">if</span> (pvm_start_time == 0)
<a name="l00530"></a>00530       pvm_start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    va_start(argptr, format);
<a name="l00533"></a>00533    vsprintf(msg, (<span class="keywordtype">char</span> *) format, argptr);
<a name="l00534"></a>00534    va_end(argptr);
<a name="l00535"></a>00535    sprintf(str, <span class="stringliteral">&quot;%1.3lf:  %s&quot;</span>, (<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - pvm_start_time) / 1000.0, msg);
<a name="l00536"></a>00536    puts(str);
<a name="l00537"></a>00537 <span class="preprocessor">#ifdef OS_LINUX</span>
<a name="l00538"></a>00538 <span class="preprocessor"></span>   {
<a name="l00539"></a>00539       <span class="keywordtype">char</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>[256];
<a name="l00540"></a>00540 
<a name="l00541"></a>00541       sprintf(cmd, <span class="stringliteral">&quot;echo &gt; /dev/console \&quot;%s\&quot;&quot;</span>, str);
<a name="l00542"></a>00542       system(cmd);
<a name="l00543"></a>00543    }
<a name="l00544"></a>00544 <span class="preprocessor">#endif</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span>}
<a name="l00546"></a>00546 
<a name="l00547"></a>00547 <span class="preprocessor">#undef STRICT</span>
<a name="l00548"></a>00548 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="pvm3_8h.html">pvm3.h</a>&gt;</span>
<a name="l00549"></a>00549 <span class="preprocessor">#endif</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span>
<a name="l00551"></a>00551 <span class="comment">/*----- PVM TAGS and data ------------------------------------------*/</span>
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 <span class="comment">/* buffer size must be larger than largest event (ODB dump!) */</span>
<a name="l00554"></a><a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">00554</a> <span class="preprocessor">#define PVM_BUFFER_SIZE (1024*1024)</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span>
<a name="l00556"></a>00556 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span><span class="preprocessor">#define TAG_DATA  1</span>
<a name="l00558"></a>00558 <span class="preprocessor"></span><span class="preprocessor">#define TAG_BOR   2</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span><span class="preprocessor">#define TAG_EOR   3</span>
<a name="l00560"></a>00560 <span class="preprocessor"></span><span class="preprocessor">#define TAG_EXIT  4</span>
<a name="l00561"></a>00561 <span class="preprocessor"></span><span class="preprocessor">#define TAG_INIT  5</span>
<a name="l00562"></a>00562 <span class="preprocessor"></span>
<a name="l00563"></a>00563 <span class="keywordtype">int</span> pvm_n_task;
<a name="l00564"></a>00564 <span class="keywordtype">int</span> pvm_myparent;
<a name="l00565"></a>00565 <span class="keywordtype">int</span> pvm_client_index;
<a name="l00566"></a>00566 
<a name="l00567"></a>00567 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00568"></a>00568    <span class="keywordtype">int</span> tid;
<a name="l00569"></a>00569    <span class="keywordtype">char</span> host[80];
<a name="l00570"></a>00570    <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>;
<a name="l00571"></a>00571    <span class="keywordtype">int</span> wp;
<a name="l00572"></a>00572    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> n_events;
<a name="l00573"></a>00573    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>;
<a name="l00574"></a>00574    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> eor_sent;
<a name="l00575"></a>00575 } PVM_CLIENT;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 PVM_CLIENT *pvmc;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 <span class="keywordtype">int</span> pvm_eor(<span class="keywordtype">int</span>);
<a name="l00580"></a>00580 <span class="keywordtype">int</span> pvm_merge(<span class="keywordtype">void</span>);
<a name="l00581"></a>00581 <span class="keywordtype">void</span> pvm_debug(<span class="keywordtype">char</span> *format, ...);
<a name="l00582"></a>00582 <span class="keywordtype">int</span> pvm_distribute(<a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> * par, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent);
<a name="l00583"></a>00583 
<a name="l00584"></a>00584 <span class="comment">//#define PVM_DEBUG pvm_debug</span>
<a name="l00585"></a>00585 <span class="preprocessor">#define PVM_DEBUG</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span>
<a name="l00587"></a>00587 <span class="preprocessor">#endif                          </span><span class="comment">/* PVM */</span>
<a name="l00588"></a>00588 
<a name="l00589"></a><a class="code" href="mana_8cpp.html#af945b9fcaabbb88495c742e84a4d3d39">00589</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#aa4ff6bc44b442b662f294b78a74d22ce">pvm_master</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="mana_8cpp.html#af945b9fcaabbb88495c742e84a4d3d39">pvm_slave</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00590"></a>00590 
<a name="l00591"></a><a class="code" href="mana_8cpp.html#a7fce5fc9af5702ff4cbc3f25bde32347">00591</a> <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a7fce5fc9af5702ff4cbc3f25bde32347">bstr</a> = <span class="stringliteral">&quot; &quot;</span>;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 <span class="comment">/* items defined in analyzer.c */</span>
<a name="l00596"></a>00596 <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>;
<a name="l00597"></a>00597 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a8fd380b49c2d273b54ec6a6fb077d760">analyzer_loop_period</a>;
<a name="l00598"></a>00598 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#afeea792d4dbe0001bd025397e494ab5b">analyzer_init</a>(<span class="keywordtype">void</span>);
<a name="l00599"></a>00599 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a7738840c25fb678186362479850b4df6">analyzer_exit</a>(<span class="keywordtype">void</span>);
<a name="l00600"></a>00600 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a7173b35a859f0740c437df5f68ccf80b">analyzer_loop</a>(<span class="keywordtype">void</span>);
<a name="l00601"></a>00601 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a22c6bd312e4f7ffd79162e64835cfd42">ana_begin_of_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00602"></a>00602 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a8e03cbe2637bd6f4488a659c9f23d29e">ana_end_of_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00603"></a>00603 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a86f2bc78d542107ce023a1d54f79b13e">ana_pause_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00604"></a>00604 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a35f57e1efbd308b1ca049035dcdc13f6">ana_resume_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00605"></a>00605 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a7503268889a084b74a968787ffc025b7">odb_size</a>;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 <span class="comment">/*---- globals -----------------------------------------------------*/</span>
<a name="l00608"></a>00608 
<a name="l00609"></a>00609 <span class="comment">/* ODB handle */</span>
<a name="l00610"></a><a class="code" href="mana_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">00610</a> <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612 <span class="comment">/* run number */</span>
<a name="l00613"></a><a class="code" href="mana_8cpp.html#a115cf2b067a8ad1c02c6b700dcb19775">00613</a> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mana_8cpp.html#a115cf2b067a8ad1c02c6b700dcb19775">current_run_number</a>;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 <span class="comment">/* analyze_request defined in analyze.c or anasys.c */</span>
<a name="l00616"></a>00616 <span class="keyword">extern</span> <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> <a class="code" href="analyzer_8cpp.html#ab1be3d7f64edcbf386bfd220bc7bda9b">analyze_request</a>[];
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="comment">/* N-tupel booking and filling flag */</span>
<a name="l00619"></a><a class="code" href="mana_8cpp.html#acad1970d3f9313bf7782eb6ae587c9a7">00619</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#acad1970d3f9313bf7782eb6ae587c9a7">ntuple_flag</a>;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 <span class="comment">/* list of locked histos (won&apos;t get cleared) */</span>
<a name="l00622"></a><a class="code" href="mana_8cpp.html#a32357ef75116a47e988625b8d78ecfc5">00622</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a32357ef75116a47e988625b8d78ecfc5">lock_list</a>[10000];
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="comment">/* flag to indicate whether the queue is being cleared after a stop request */</span>
<a name="l00625"></a><a class="code" href="mana_8cpp.html#addcec48ded248cb150b9ded486f01da8">00625</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#addcec48ded248cb150b9ded486f01da8">now_stopping</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 <span class="preprocessor">#ifdef extname</span>
<a name="l00628"></a>00628 <span class="preprocessor"></span><span class="keywordtype">int</span> quest_[100];
<a name="l00629"></a>00629 <span class="preprocessor">#else</span>
<a name="l00630"></a>00630 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="fal_8c.html#a54e2499cfb7a66c138ef6c0e1b4714f4">QUEST</a>[100];
<a name="l00631"></a>00631 <span class="preprocessor">#endif</span>
<a name="l00632"></a>00632 <span class="preprocessor"></span>
<a name="l00633"></a>00633 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a145953d65e4f33a2308075f26c13bfbe">pawc_size</a>;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635 <span class="comment">/* default HBOOK record size */</span>
<a name="l00636"></a><a class="code" href="mana_8cpp.html#a4f4d653810d83035206144299458b3d0">00636</a> <span class="preprocessor">#define HBOOK_LREC 8190</span>
<a name="l00637"></a>00637 <span class="preprocessor"></span>
<a name="l00638"></a>00638 <span class="comment">/* maximum extended event size */</span>
<a name="l00639"></a>00639 <span class="preprocessor">#ifndef EXT_EVENT_SIZE</span>
<a name="l00640"></a><a class="code" href="mana_8cpp.html#a2cfad5b8da98c11be16500fc15dba5aa">00640</a> <span class="preprocessor"></span><span class="preprocessor">#define EXT_EVENT_SIZE (5*(MAX_EVENT_SIZE+sizeof(EVENT_HEADER)))</span>
<a name="l00641"></a>00641 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00642"></a>00642 <span class="preprocessor"></span>
<a name="l00643"></a>00643 <span class="comment">/* command line parameters */</span>
<a name="l00644"></a>00644 <span class="keyword">struct </span>{
<a name="l00645"></a><a class="code" href="mana_8cpp.html#a7fd54785c88eccf892c6aa8d5f6e78d0">00645</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a7fd54785c88eccf892c6aa8d5f6e78d0">online</a>;
<a name="l00646"></a><a class="code" href="mana_8cpp.html#af65cc3664520b7cd0817adc7106f9624">00646</a>    <span class="keywordtype">char</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[<a class="code" href="group__midasincludecode.html#ga2010c9ed4ef21c3171de778157b9c494">HOST_NAME_LENGTH</a>];
<a name="l00647"></a><a class="code" href="mana_8cpp.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">00647</a>    <span class="keywordtype">char</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>];
<a name="l00648"></a><a class="code" href="mana_8cpp.html#a96deaa7886d0996592e850e04aea1795">00648</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a96deaa7886d0996592e850e04aea1795">input_file_name</a>[10][256];
<a name="l00649"></a><a class="code" href="mana_8cpp.html#a1be2956569ea7201e80da80d2517ae0f">00649</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a1be2956569ea7201e80da80d2517ae0f">output_file_name</a>[256];
<a name="l00650"></a><a class="code" href="mana_8cpp.html#a24b25d290fef8bf6c0b21bfbbb4fefdd">00650</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a24b25d290fef8bf6c0b21bfbbb4fefdd">secondary_output_file_name</a>[256];
<a name="l00651"></a><a class="code" href="mana_8cpp.html#a6eaf70ed949e0b77f861573ffb313975">00651</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a6eaf70ed949e0b77f861573ffb313975">mias_tree_output_file_name</a>[256];
<a name="l00652"></a><a class="code" href="mana_8cpp.html#a172a606e5fbb7290c1e2a89d0f2d39d0">00652</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>[2];
<a name="l00653"></a><a class="code" href="mana_8cpp.html#a228a29e4d9ddfb6bc4994455a321bdc4">00653</a>    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>[4];
<a name="l00654"></a><a class="code" href="mana_8cpp.html#acd79c70e7b9dbde81f9a618bed1245e5">00654</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#acd79c70e7b9dbde81f9a618bed1245e5">filter</a>;
<a name="l00655"></a><a class="code" href="mana_8cpp.html#a4c4543fab10c0a1dc56223711d62f023">00655</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#a4c4543fab10c0a1dc56223711d62f023">graphics</a>;
<a name="l00656"></a><a class="code" href="mana_8cpp.html#a09aab23bbdc57f08685183469f2c34f6">00656</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a09aab23bbdc57f08685183469f2c34f6">config_file_name</a>[10][256];
<a name="l00657"></a><a class="code" href="mana_8cpp.html#a6dadda9a6f1103026d1d128fe203aa9a">00657</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a6dadda9a6f1103026d1d128fe203aa9a">param</a>[10][256];
<a name="l00658"></a><a class="code" href="mana_8cpp.html#a7016f372863223b54ca53ae070701a94">00658</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a7016f372863223b54ca53ae070701a94">protect</a>[10][256];
<a name="l00659"></a><a class="code" href="mana_8cpp.html#ae9487d607449dedf95bca2636c33b5d3">00659</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#ae9487d607449dedf95bca2636c33b5d3">rwnt</a>;
<a name="l00660"></a><a class="code" href="mana_8cpp.html#a57f54b03009e95624f04afab052e6f2e">00660</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a57f54b03009e95624f04afab052e6f2e">lrec</a>;
<a name="l00661"></a><a class="code" href="mana_8cpp.html#a81f0a890e023743f1b88d0cb7d4f74db">00661</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a>;
<a name="l00662"></a><a class="code" href="mana_8cpp.html#ad023bbf13e60f8caee82c26f70e0f0a5">00662</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="overall_8cpp.html#a0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>;
<a name="l00663"></a><a class="code" href="mana_8cpp.html#a34e0e7602d9696c3f499540a59d06a36">00663</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#a34e0e7602d9696c3f499540a59d06a36">quiet</a>;
<a name="l00664"></a><a class="code" href="mana_8cpp.html#afb9f83013556b16cc1f547e955188356">00664</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#afb9f83013556b16cc1f547e955188356">no_load</a>;
<a name="l00665"></a><a class="code" href="mana_8cpp.html#a96203468e98720f55cbede5bb1f8cffe">00665</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#a96203468e98720f55cbede5bb1f8cffe">daemon</a>;
<a name="l00666"></a><a class="code" href="mana_8cpp.html#abd4c58430e4e44ed3162b1beae228971">00666</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#abd4c58430e4e44ed3162b1beae228971">n_task</a>;
<a name="l00667"></a><a class="code" href="mana_8cpp.html#a9c6222f0920e2024e2371df707389e55">00667</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a9c6222f0920e2024e2371df707389e55">pvm_buf_size</a>;
<a name="l00668"></a><a class="code" href="mana_8cpp.html#a92facc49fbf15b92029c0c7dac1a8d35">00668</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a92facc49fbf15b92029c0c7dac1a8d35">root_port</a>;
<a name="l00669"></a>00669 } <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="keyword">struct </span>{
<a name="l00672"></a><a class="code" href="mana_8cpp.html#a01d765415b8b865701ba44d771870744">00672</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a01d765415b8b865701ba44d771870744">flag_char</a>;
<a name="l00673"></a><a class="code" href="mana_8cpp.html#abf0f2b4c0e71c91c7405885282eb2c04">00673</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#abf0f2b4c0e71c91c7405885282eb2c04">description</a>[1000];
<a name="l00674"></a><a class="code" href="mana_8cpp.html#a735984d41155bc1032e09bece8f8d66d">00674</a>    <span class="keywordtype">void</span> *<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>;
<a name="l00675"></a><a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">00675</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>;
<a name="l00676"></a>00676    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>;
<a name="l00677"></a><a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">00677</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>;
<a name="l00678"></a>00678 } <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[] = {
<a name="l00679"></a>00679 
<a name="l00680"></a>00680    {
<a name="l00681"></a>00681    <span class="charliteral">&apos;c&apos;</span>, <span class="stringliteral">&quot;&lt;filename1&gt;   Configuration file name(s). May contain a &apos;%05d&apos; to be\n\</span>
<a name="l00682"></a>00682 <span class="stringliteral">     &lt;filename2&gt;   replaced by the run number. Up to ten files can be\n\</span>
<a name="l00683"></a>00683 <span class="stringliteral">         ...       specified in one \&quot;-c\&quot; statement&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.config_file_name, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, 10}, {
<a name="l00684"></a>00684    <span class="charliteral">&apos;d&apos;</span>, <span class="stringliteral">&quot;              Debug flag when started the analyzer fron a debugger.\n\</span>
<a name="l00685"></a>00685 <span class="stringliteral">                   Prevents the system to kill the analyzer when the\n\</span>
<a name="l00686"></a>00686 <span class="stringliteral">                   debugger stops at a breakpoint&quot;</span>, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.debug, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, 0}, {
<a name="l00687"></a>00687    <span class="charliteral">&apos;D&apos;</span>, <span class="stringliteral">&quot;              Start analyzer as a daemon in the background (UNIX only).&quot;</span>,
<a name="l00688"></a>00688           &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.daemon, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, 0}, {
<a name="l00689"></a>00689    <span class="charliteral">&apos;e&apos;</span>, <span class="stringliteral">&quot;&lt;experiment&gt;  MIDAS experiment to connect to&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.exp_name, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, 1}, {
<a name="l00690"></a>00690    <span class="charliteral">&apos;f&apos;</span>, <span class="stringliteral">&quot;              Filter mode. Write original events to output file\n\</span>
<a name="l00691"></a>00691 <span class="stringliteral">                   only if analyzer accepts them (doesn&apos;t return ANA_SKIP).\n&quot;</span>, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.filter, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, 0}, {
<a name="l00692"></a>00692    <span class="charliteral">&apos;g&apos;</span>, <span class="stringliteral">&quot;              Graphics mode. Runs ROOT in non-batch mode.\n&quot;</span>, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.graphics, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, 0}, {
<a name="l00693"></a>00693    <span class="charliteral">&apos;h&apos;</span>, <span class="stringliteral">&quot;&lt;hostname&gt;    MIDAS host to connect to when running the analyzer online&quot;</span>,
<a name="l00694"></a>00694           <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.host_name, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, 1}, {
<a name="l00695"></a>00695    <span class="charliteral">&apos;i&apos;</span>, <span class="stringliteral">&quot;&lt;filename1&gt;   Input file name. May contain a &apos;%05d&apos; to be replaced by\n\</span>
<a name="l00696"></a>00696 <span class="stringliteral">     &lt;filename2&gt;   the run number. Up to ten input files can be specified\n\</span>
<a name="l00697"></a>00697 <span class="stringliteral">         ...       in one \&quot;-i\&quot; statement&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.input_file_name, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, 10}, {
<a name="l00698"></a>00698    <span class="charliteral">&apos;l&apos;</span>, <span class="stringliteral">&quot;              If set, don&apos;t load histos from last histo file when\n\</span>
<a name="l00699"></a>00699 <span class="stringliteral">                   running online.&quot;</span>, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.no_load, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, 0}, {
<a name="l00700"></a>00700    <span class="charliteral">&apos;L&apos;</span>, <span class="stringliteral">&quot;              HBOOK LREC size. Default is 8190.&quot;</span>, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.lrec, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, 0}, {
<a name="l00701"></a>00701    <span class="charliteral">&apos;n&apos;</span>, <span class="stringliteral">&quot;&lt;count&gt;       Analyze only \&quot;count\&quot; events.\n\</span>
<a name="l00702"></a>00702 <span class="stringliteral">     &lt;first&gt; &lt;last&gt;\n\</span>
<a name="l00703"></a>00703 <span class="stringliteral">                   Analyze only events from \&quot;first\&quot; to \&quot;last\&quot;.\n\</span>
<a name="l00704"></a>00704 <span class="stringliteral">     &lt;first&gt; &lt;last&gt; &lt;n&gt;\n\</span>
<a name="l00705"></a>00705 <span class="stringliteral">                   Analyze every n-th event from \&quot;first\&quot; to \&quot;last\&quot;.&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, 4}, {
<a name="l00706"></a>00706    <span class="charliteral">&apos;o&apos;</span>, <span class="stringliteral">&quot;&lt;filename&gt;    Output file name. Extension may be .mid (MIDAS binary),\n\</span>
<a name="l00707"></a>00707 <span class="stringliteral">                   .asc (ASCII) or .rz (HBOOK). If the name contains a &apos;%05d&apos;,\n\</span>
<a name="l00708"></a>00708 <span class="stringliteral">                   one output file is generated for each run. Use \&quot;OFLN\&quot; as\n\</span>
<a name="l00709"></a>00709 <span class="stringliteral">                   output file name to creaate a HBOOK shared memory instead\n\</span>
<a name="l00710"></a>00710 <span class="stringliteral">                   of a file.&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, 1}, 
<a name="l00711"></a>00711 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l00712"></a>00712 <span class="preprocessor"></span>  {<span class="charliteral">&apos;O&apos;</span>, <span class="stringliteral">&quot;&lt;filename&gt;    Secondary output file name, which can be used to generate\n\</span>
<a name="l00713"></a>00713 <span class="stringliteral">                   a .root histogram file in addition to the main output file.&quot;</span>,
<a name="l00714"></a>00714                    <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.secondary_output_file_name, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, 1}, 
<a name="l00715"></a>00715   {<span class="charliteral">&apos;T&apos;</span>, <span class="stringliteral">&quot;&lt;filename&gt;    MIAS Tree output file name, which can be used to generate\n\</span>
<a name="l00716"></a>00716 <span class="stringliteral">                   a .root Tree file in addition to the main output file.&quot;</span>,
<a name="l00717"></a>00717                    <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.mias_tree_output_file_name, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, 1}, 
<a name="l00718"></a>00718 <span class="preprocessor">#endif</span>
<a name="l00719"></a>00719 <span class="preprocessor"></span>  {<span class="charliteral">&apos;p&apos;</span>, <span class="stringliteral">&quot;&lt;param=value&gt; Set individual parameters to a specific value.\n\</span>
<a name="l00720"></a>00720 <span class="stringliteral">                   Overrides any setting in configuration files&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.param, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, 10}, {
<a name="l00721"></a>00721    <span class="charliteral">&apos;P&apos;</span>, <span class="stringliteral">&quot;&lt;ODB tree&gt;    Protect an ODB subtree from being overwritten\n\</span>
<a name="l00722"></a>00722 <span class="stringliteral">                   with the online data when ODB gets loaded from .mid file&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.protect, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, 10}, {
<a name="l00723"></a>00723    <span class="charliteral">&apos;q&apos;</span>, <span class="stringliteral">&quot;              Quiet flag. If set, don&apos;t display run progress in\n\</span>
<a name="l00724"></a>00724 <span class="stringliteral">                   offline mode.&quot;</span>, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, 0}, {
<a name="l00725"></a>00725    <span class="charliteral">&apos;r&apos;</span>, <span class="stringliteral">&quot;&lt;range&gt;       Range of run numbers to analyzer like \&quot;-r 120 125\&quot;\n\</span>
<a name="l00726"></a>00726 <span class="stringliteral">                   to analyze runs 120 to 125 (inclusive). The \&quot;-r\&quot;\n\</span>
<a name="l00727"></a>00727 <span class="stringliteral">                   flag must be used with a &apos;%05d&apos; in the input file name.&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.run_number, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, 2},
<a name="l00728"></a>00728 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l00729"></a>00729 <span class="preprocessor"></span>   {
<a name="l00730"></a>00730    <span class="charliteral">&apos;t&apos;</span>, <span class="stringliteral">&quot;&lt;n&gt;           Parallelize analyzer using &lt;n&gt; tasks with PVM.&quot;</span>,
<a name="l00731"></a>00731           &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n_task, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, 1}, {
<a name="l00732"></a>00732    <span class="charliteral">&apos;b&apos;</span>, <span class="stringliteral">&quot;&lt;n&gt;           Buffer size for parallelization in kB.&quot;</span>,
<a name="l00733"></a>00733           &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.pvm_buf_size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, 1},
<a name="l00734"></a>00734 <span class="preprocessor">#endif</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span>
<a name="l00736"></a>00736 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l00737"></a>00737 <span class="preprocessor"></span>   {
<a name="l00738"></a>00738    <span class="charliteral">&apos;s&apos;</span>, <span class="stringliteral">&quot;&lt;port&gt;        Start ROOT histo server under &lt;port&gt;. If port==0, don&apos;t start server.&quot;</span>,
<a name="l00739"></a>00739           &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.root_port, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, 1},
<a name="l00740"></a>00740 <span class="preprocessor">#endif</span>
<a name="l00741"></a>00741 <span class="preprocessor"></span>   
<a name="l00742"></a>00742    {
<a name="l00743"></a>00743    <span class="charliteral">&apos;v&apos;</span>, <span class="stringliteral">&quot;              Verbose output.&quot;</span>, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.verbose, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, 0}, {
<a name="l00744"></a>00744    <span class="charliteral">&apos;w&apos;</span>, <span class="stringliteral">&quot;              Produce row-wise N-tuples in outpur .rz file. By\n\</span>
<a name="l00745"></a>00745 <span class="stringliteral">                   default, column-wise N-tuples are used.&quot;</span>, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, 0}, {
<a name="l00746"></a>00746    0}
<a name="l00747"></a>00747 };
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 <span class="comment">/* output file information, maps to /&lt;analyzer&gt;/Output */</span>
<a name="l00750"></a>00750 <span class="keyword">struct </span>{
<a name="l00751"></a><a class="code" href="mana_8cpp.html#a258adbf16b88a7db88c7d8bce9708c50">00751</a>    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>[256];
<a name="l00752"></a>00752    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#ae9487d607449dedf95bca2636c33b5d3">rwnt</a>;
<a name="l00753"></a><a class="code" href="mana_8cpp.html#a6cddf80902f55138cf944ed06cbcbd61">00753</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#a6cddf80902f55138cf944ed06cbcbd61">histo_dump</a>;
<a name="l00754"></a><a class="code" href="mana_8cpp.html#a81e1be5cc336f24597a82cfa087c1ac3">00754</a>    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a81e1be5cc336f24597a82cfa087c1ac3">histo_dump_filename</a>[256];
<a name="l00755"></a><a class="code" href="mana_8cpp.html#a4439d57afe08d556f78e4b0ba490c79a">00755</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#a4439d57afe08d556f78e4b0ba490c79a">clear_histos</a>;
<a name="l00756"></a><a class="code" href="mana_8cpp.html#aa43b224cec5b9bf4a8feb7fd364b9a7f">00756</a>    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#aa43b224cec5b9bf4a8feb7fd364b9a7f">last_histo_filename</a>[256];
<a name="l00757"></a><a class="code" href="mana_8cpp.html#af68e872de565f722d84950f339b26cb9">00757</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#af68e872de565f722d84950f339b26cb9">events_to_odb</a>;
<a name="l00758"></a><a class="code" href="mana_8cpp.html#a52bbe25f799ffa103a99650e3abd4e5e">00758</a>    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a52bbe25f799ffa103a99650e3abd4e5e">global_memory_name</a>[8];
<a name="l00759"></a>00759 } <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>;
<a name="l00760"></a>00760 
<a name="l00761"></a><a class="code" href="mana_8cpp.html#ab297e8b6af734888d3dc2cfe335a9d44">00761</a> FILE *<a class="code" href="mana_8cpp.html#ab297e8b6af734888d3dc2cfe335a9d44">out_file</a>;
<a name="l00762"></a><a class="code" href="mana_8cpp.html#ae6891eb430d9160a128f56a01e10f4dc">00762</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#ae6891eb430d9160a128f56a01e10f4dc">out_gzip</a>;
<a name="l00763"></a><a class="code" href="mana_8cpp.html#a57462a01b2494cba89ae18620110c130">00763</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a57462a01b2494cba89ae18620110c130">out_format</a>;
<a name="l00764"></a><a class="code" href="mana_8cpp.html#abbc229a696029d540d0e1261e0fd6880">00764</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mana_8cpp.html#abbc229a696029d540d0e1261e0fd6880">out_append</a>;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l00767"></a>00767 <span class="keywordtype">void</span> <a class="code" href="mana_8cpp.html#abe1e94ccaf2f7b108ef3291550a119c6">odb_load</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent);
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="comment">/*---- ODB records -------------------------------------------------*/</span>
<a name="l00770"></a>00770 
<a name="l00771"></a><a class="code" href="mana_8cpp.html#a9b830b651a8c873d619d16eb495097af">00771</a> <span class="preprocessor">#define ANALYZER_REQUEST_STR &quot;\</span>
<a name="l00772"></a>00772 <span class="preprocessor">Event ID = INT : 0\n\</span>
<a name="l00773"></a>00773 <span class="preprocessor">Trigger mask = INT : -1\n\</span>
<a name="l00774"></a>00774 <span class="preprocessor">Sampling type = INT : 1\n\</span>
<a name="l00775"></a>00775 <span class="preprocessor">Buffer = STRING : [32] SYSTEM\n\</span>
<a name="l00776"></a>00776 <span class="preprocessor">Enabled = BOOL : 1\n\</span>
<a name="l00777"></a>00777 <span class="preprocessor">Client name = STRING : [32] \n\</span>
<a name="l00778"></a>00778 <span class="preprocessor">Host = STRING : [32] \n\</span>
<a name="l00779"></a>00779 <span class="preprocessor">&quot;</span>
<a name="l00780"></a>00780 <span class="preprocessor"></span>
<a name="l00781"></a><a class="code" href="mana_8cpp.html#a407acb59ee878974632978f7682e8d23">00781</a> <span class="preprocessor">#define ANALYZER_STATS_STR &quot;\</span>
<a name="l00782"></a>00782 <span class="preprocessor">Events received = DOUBLE : 0\n\</span>
<a name="l00783"></a>00783 <span class="preprocessor">Events per sec. = DOUBLE : 0\n\</span>
<a name="l00784"></a>00784 <span class="preprocessor">Events written = DOUBLE : 0\n\</span>
<a name="l00785"></a>00785 <span class="preprocessor">&quot;</span>
<a name="l00786"></a>00786 <span class="preprocessor"></span>
<a name="l00787"></a><a class="code" href="mana_8cpp.html#a7c5689a91d273a5acdde5b6d6fd2a0b0">00787</a> <span class="preprocessor">#define OUT_INFO_STR &quot;\</span>
<a name="l00788"></a>00788 <span class="preprocessor">Filename = STRING : [256] run%05d.asc\n\</span>
<a name="l00789"></a>00789 <span class="preprocessor">RWNT = BOOL : 0\n\</span>
<a name="l00790"></a>00790 <span class="preprocessor">Histo Dump = BOOL : 0\n\</span>
<a name="l00791"></a>00791 <span class="preprocessor">Histo Dump Filename = STRING : [256] his%05d.rz\n\</span>
<a name="l00792"></a>00792 <span class="preprocessor">Clear histos = BOOL : 1\n\</span>
<a name="l00793"></a>00793 <span class="preprocessor">Last Histo Filename = STRING : [256] last.rz\n\</span>
<a name="l00794"></a>00794 <span class="preprocessor">Events to ODB = BOOL : 1\n\</span>
<a name="l00795"></a>00795 <span class="preprocessor">Global Memory Name = STRING : [8] ONLN\n\</span>
<a name="l00796"></a>00796 <span class="preprocessor">&quot;</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span>
<a name="l00798"></a>00798 <span class="comment">/*-- interprete command line parameters ----------------------------*/</span>
<a name="l00799"></a>00799 
<a name="l00800"></a><a class="code" href="mana_8cpp.html#ac965acb06ece6889fd3b68d82ca916c5">00800</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#ac965acb06ece6889fd3b68d82ca916c5">getparam</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l00801"></a>00801 {
<a name="l00802"></a>00802    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804    <span class="comment">/* parse command line parameters */</span>
<a name="l00805"></a>00805    <span class="keywordflow">for</span> (index = 1; index &lt; argc;) {
<a name="l00806"></a>00806       <span class="comment">/* search flag in parameter description */</span>
<a name="l00807"></a>00807       <span class="keywordflow">if</span> (argv[index][0] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l00808"></a>00808          <span class="keywordflow">for</span> (j = 0; <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].flag_char; j++)
<a name="l00809"></a>00809             <span class="keywordflow">if</span> (argv[index][1] == <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="mana_8cpp.html#a01d765415b8b865701ba44d771870744">flag_char</a>)
<a name="l00810"></a>00810                <span class="keywordflow">break</span>;
<a name="l00811"></a>00811 
<a name="l00812"></a>00812          <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].flag_char)
<a name="l00813"></a>00813             <span class="keywordflow">goto</span> <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815          <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> &gt; 0 &amp;&amp; index &gt;= argc - 1)
<a name="l00816"></a>00816             <span class="keywordflow">goto</span> <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>;
<a name="l00817"></a>00817          index++;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819          <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a> == <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>) {
<a name="l00820"></a>00820             *((<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> *) <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>) = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00821"></a>00821             <span class="keywordflow">continue</span>;
<a name="l00822"></a>00822          }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824          <span class="keywordflow">do</span> {
<a name="l00825"></a>00825             <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a> == <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>)
<a name="l00826"></a>00826                strcpy((<span class="keywordtype">char</span> *) <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a> + <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].index * 256,
<a name="l00827"></a>00827                       argv[index]);
<a name="l00828"></a>00828             <span class="keywordflow">else</span>
<a name="l00829"></a>00829                <a class="code" href="group__msectionh.html#ga7b3d26e7b258c093ad999bf1286bb871">db_sscanf</a>(argv[index], <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>,
<a name="l00830"></a>00830                          &amp;size, <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].index, <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>);
<a name="l00831"></a>00831 
<a name="l00832"></a>00832             <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> &gt; 1)
<a name="l00833"></a>00833                <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].index++;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835             <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].index &gt; <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].<a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>) {
<a name="l00836"></a>00836                printf(<span class="stringliteral">&quot;Note more than %d options possible for flag -%c\n&quot;</span>,
<a name="l00837"></a>00837                       <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].n, <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[j].flag_char);
<a name="l00838"></a>00838                <span class="keywordflow">return</span> 0;
<a name="l00839"></a>00839             }
<a name="l00840"></a>00840 
<a name="l00841"></a>00841             index++;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843          } <span class="keywordflow">while</span> (index &lt; argc &amp;&amp; argv[index][0] != <span class="charliteral">&apos;-&apos;</span>);
<a name="l00844"></a>00844 
<a name="l00845"></a>00845       } <span class="keywordflow">else</span>
<a name="l00846"></a>00846          <span class="keywordflow">goto</span> <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>;
<a name="l00847"></a>00847    }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851  <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>:
<a name="l00852"></a>00852 
<a name="l00853"></a>00853    printf(<span class="stringliteral">&quot;usage: analyzer [options]\n\n&quot;</span>);
<a name="l00854"></a>00854    printf(<span class="stringliteral">&quot;valid options are:\n&quot;</span>);
<a name="l00855"></a>00855    <span class="keywordflow">for</span> (i = 0; <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[i].flag_char; i++)
<a name="l00856"></a>00856       printf(<span class="stringliteral">&quot;  -%c %s\n&quot;</span>, <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[i].<a class="code" href="mana_8cpp.html#a01d765415b8b865701ba44d771870744">flag_char</a>, <a class="code" href="mana_8cpp.html#ab39aaaee5cd095effe8aca0c1c4e4245">clp_descrip</a>[i].<a class="code" href="mana_8cpp.html#abf0f2b4c0e71c91c7405885282eb2c04">description</a>);
<a name="l00857"></a>00857 
<a name="l00858"></a>00858    <span class="keywordflow">return</span> 0;
<a name="l00859"></a>00859 }
<a name="l00860"></a>00860 
<a name="l00861"></a>00861 <span class="comment">/*-- add &lt;/logger/data dir&gt; before filename ------------------------*/</span>
<a name="l00862"></a>00862 
<a name="l00863"></a><a class="code" href="group__msectionh.html#ga42926f9062f24eb432ffb6414cde67e8">00863</a> <span class="keywordtype">void</span> <a class="code" href="group__msectionh.html#ga42926f9062f24eb432ffb6414cde67e8">add_data_dir</a>(<span class="keywordtype">char</span> *result, <span class="keywordtype">char</span> *file)
<a name="l00864"></a>00864 {
<a name="l00865"></a>00865    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hDB, hkey;
<a name="l00866"></a>00866    <span class="keywordtype">char</span> str[256];
<a name="l00867"></a>00867    <span class="keywordtype">int</span> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869    <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;hDB, NULL);
<a name="l00870"></a>00870    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Data dir&quot;</span>, &amp;hkey);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872    <span class="keywordflow">if</span> (hkey) {
<a name="l00873"></a>00873       size = <span class="keyword">sizeof</span>(str);
<a name="l00874"></a>00874       <a class="code" href="group__msectionh.html#gad6e53374f24813cdba8713781683c556">db_get_data</a>(hDB, hkey, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>);
<a name="l00875"></a>00875       <span class="keywordflow">if</span> (str[strlen(str) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l00876"></a>00876          strcat(str, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l00877"></a>00877       strcat(str, file);
<a name="l00878"></a>00878       strcpy(result, str);
<a name="l00879"></a>00879    } <span class="keywordflow">else</span>
<a name="l00880"></a>00880       strcpy(result, file);
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 <span class="comment">/*-- db_get_event_definition ---------------------------------------*/</span>
<a name="l00884"></a>00884 
<a name="l00885"></a>00885 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00886"></a>00886    <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l00887"></a><a class="code" href="structEVENT__DEF.html#a1f9fe59026081d85b2ee6ad8645e060b">00887</a>    <span class="keywordtype">int</span> <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>;
<a name="l00888"></a>00888    <a class="code" href="unionWORD.html">WORD</a> format;
<a name="l00889"></a>00889    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hDefKey;
<a name="l00890"></a><a class="code" href="structEVENT__DEF.html#a66d1640adf533d3d29e015244e0c4fd2">00890</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> disabled;
<a name="l00891"></a>00891 } <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a>;
<a name="l00892"></a>00892 
<a name="l00893"></a><a class="code" href="mana_8cpp.html#ad5d6f1e4c99351c9278d6189b7e87b08">00893</a> <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *<a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>)
<a name="l00894"></a>00894 {
<a name="l00895"></a>00895    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>;
<a name="l00896"></a>00896    <span class="keywordtype">char</span> str[80];
<a name="l00897"></a>00897    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, hKeyRoot;
<a name="l00898"></a>00898    <a class="code" href="unionWORD.html">WORD</a> id;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900 <span class="preprocessor">#define EVENT_DEF_CACHE_SIZE 30</span>
<a name="l00901"></a>00901 <span class="preprocessor"></span>   <span class="keyword">static</span> <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def = NULL;
<a name="l00902"></a>00902 
<a name="l00903"></a>00903    <span class="comment">/* allocate memory for cache */</span>
<a name="l00904"></a>00904    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l00905"></a>00905       event_def = (<a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *) calloc(<a class="code" href="fal_8c.html#a696fa60df0f6ed300eb2f4d17ea46054">EVENT_DEF_CACHE_SIZE</a>, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__DEF.html">EVENT_DEF</a>));
<a name="l00906"></a>00906 
<a name="l00907"></a>00907    <span class="comment">/* lookup if event definition in cache */</span>
<a name="l00908"></a>00908    <span class="keywordflow">for</span> (i = 0; event_def[i].<a class="code" href="structEVENT__DEF.html#a450b12516bc22bbd288f8172099ef85f">event_id</a>; i++)
<a name="l00909"></a>00909       <span class="keywordflow">if</span> (event_def[i].event_id == event_id)
<a name="l00910"></a>00910          <span class="keywordflow">return</span> &amp;event_def[i];
<a name="l00911"></a>00911 
<a name="l00912"></a>00912    <span class="comment">/* search free cache entry */</span>
<a name="l00913"></a>00913    <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="fal_8c.html#a696fa60df0f6ed300eb2f4d17ea46054">EVENT_DEF_CACHE_SIZE</a>; index++)
<a name="l00914"></a>00914       <span class="keywordflow">if</span> (event_def[index].event_id == 0)
<a name="l00915"></a>00915          <span class="keywordflow">break</span>;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917    <span class="keywordflow">if</span> (index == EVENT_DEF_CACHE_SIZE) {
<a name="l00918"></a>00918       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;db_get_event_definition&quot;</span>, <span class="stringliteral">&quot;too many event definitions&quot;</span>);
<a name="l00919"></a>00919       <span class="keywordflow">return</span> NULL;
<a name="l00920"></a>00920    }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922    <span class="comment">/* check for system events */</span>
<a name="l00923"></a>00923    <span class="keywordflow">if</span> (event_id &lt; 0) {
<a name="l00924"></a>00924       event_def[index].<a class="code" href="structEVENT__DEF.html#a450b12516bc22bbd288f8172099ef85f">event_id</a> = event_id;
<a name="l00925"></a>00925       event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>;
<a name="l00926"></a>00926       event_def[index].<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a> = 0;
<a name="l00927"></a>00927       event_def[index].<a class="code" href="structEVENT__DEF.html#a66d1640adf533d3d29e015244e0c4fd2">disabled</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00928"></a>00928       <span class="keywordflow">return</span> &amp;event_def[index];
<a name="l00929"></a>00929    }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931    status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, <span class="stringliteral">&quot;/equipment&quot;</span>, &amp;hKeyRoot);
<a name="l00932"></a>00932    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00933"></a>00933       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;db_get_event_definition&quot;</span>, <span class="stringliteral">&quot;cannot find /equipment entry in ODB&quot;</span>);
<a name="l00934"></a>00934       <span class="keywordflow">return</span> NULL;
<a name="l00935"></a>00935    }
<a name="l00936"></a>00936 
<a name="l00937"></a>00937    <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l00938"></a>00938       <span class="comment">/* search for equipment with specific name */</span>
<a name="l00939"></a>00939       status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, hKeyRoot, i, &amp;hKey);
<a name="l00940"></a>00940       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>) {
<a name="l00941"></a>00941          sprintf(str, <span class="stringliteral">&quot;Cannot find event id %d under /equipment&quot;</span>, event_id);
<a name="l00942"></a>00942          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;db_get_event_definition&quot;</span>, str);
<a name="l00943"></a>00943          <span class="keywordflow">return</span> NULL;
<a name="l00944"></a>00944       }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946       size = <span class="keyword">sizeof</span>(id);
<a name="l00947"></a>00947       status = <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, hKey, <span class="stringliteral">&quot;Common/Event ID&quot;</span>, &amp;<span class="keywordtype">id</span>, &amp;size, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00948"></a>00948       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00949"></a>00949          <span class="keywordflow">continue</span>;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951       size = <span class="keyword">sizeof</span>(type);
<a name="l00952"></a>00952       status = <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, hKey, <span class="stringliteral">&quot;Common/Type&quot;</span>, &amp;type, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00953"></a>00953       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00954"></a>00954          <span class="keywordflow">continue</span>;
<a name="l00955"></a>00955 
<a name="l00956"></a>00956       <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == event_id) {
<a name="l00957"></a>00957          <span class="comment">/* set cache entry */</span>
<a name="l00958"></a>00958          event_def[index].<a class="code" href="structEVENT__DEF.html#a450b12516bc22bbd288f8172099ef85f">event_id</a> = id;
<a name="l00959"></a>00959          event_def[index].<a class="code" href="structEVENT__DEF.html#a1f9fe59026081d85b2ee6ad8645e060b">type</a> = type;
<a name="l00960"></a>00960 
<a name="l00961"></a>00961          size = <span class="keyword">sizeof</span>(str);
<a name="l00962"></a>00962          str[0] = 0;
<a name="l00963"></a>00963          <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, hKey, <span class="stringliteral">&quot;Common/Format&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00964"></a>00964 
<a name="l00965"></a>00965          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;Fixed&quot;</span>))
<a name="l00966"></a>00966             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>;
<a name="l00967"></a>00967          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;ASCII&quot;</span>))
<a name="l00968"></a>00968             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>;
<a name="l00969"></a>00969          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;MIDAS&quot;</span>))
<a name="l00970"></a>00970             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>;
<a name="l00971"></a>00971          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;YBOS&quot;</span>))
<a name="l00972"></a>00972             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>;
<a name="l00973"></a>00973          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;DUMP&quot;</span>))
<a name="l00974"></a>00974             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gaffaf04a985dfa6ff43ab39a8c6e3f0a7">FORMAT_DUMP</a>;
<a name="l00975"></a>00975          <span class="keywordflow">else</span> {
<a name="l00976"></a>00976             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;db_get_event_definition&quot;</span>, <span class="stringliteral">&quot;unknown data format&quot;</span>);
<a name="l00977"></a>00977             event_def[index].<a class="code" href="structEVENT__DEF.html#a450b12516bc22bbd288f8172099ef85f">event_id</a> = 0;
<a name="l00978"></a>00978             <span class="keywordflow">return</span> NULL;
<a name="l00979"></a>00979          }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981          <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, hKey, <span class="stringliteral">&quot;Variables&quot;</span>, &amp;event_def[index].hDefKey);
<a name="l00982"></a>00982          <span class="keywordflow">return</span> &amp;event_def[index];
<a name="l00983"></a>00983       }
<a name="l00984"></a>00984    }
<a name="l00985"></a>00985 }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987 <span class="comment">/*-- functions for internal tests ----------------------------------*/</span>
<a name="l00988"></a>00988 
<a name="l00989"></a><a class="code" href="mana_8cpp.html#a8d48fae6c3a349ad62641f44252fb21e">00989</a> <a class="code" href="structANA__TEST.html">ANA_TEST</a> **<a class="code" href="fal_8c.html#a8d48fae6c3a349ad62641f44252fb21e">tl</a>;
<a name="l00990"></a><a class="code" href="mana_8cpp.html#afc7da5af4f263536aae9ad609dea1a26">00990</a> <span class="keywordtype">int</span> <a class="code" href="fal_8c.html#afc7da5af4f263536aae9ad609dea1a26">n_test</a> = 0;
<a name="l00991"></a>00991 
<a name="l00992"></a><a class="code" href="group__msectionh.html#gafe14ae429e3bc130043ebe683c41943e">00992</a> <span class="keywordtype">void</span> <a class="code" href="group__msectionh.html#gafe14ae429e3bc130043ebe683c41943e">test_register</a>(<a class="code" href="structANA__TEST.html">ANA_TEST</a> * t)
<a name="l00993"></a>00993 {
<a name="l00994"></a>00994    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996    <span class="comment">/* check if test already registered */</span>
<a name="l00997"></a>00997    <span class="keywordflow">for</span> (i = 0; i &lt; n_test; i++)
<a name="l00998"></a>00998       <span class="keywordflow">if</span> (tl[i] == t)
<a name="l00999"></a>00999          <span class="keywordflow">break</span>;
<a name="l01000"></a>01000    <span class="keywordflow">if</span> (i &lt; n_test) {
<a name="l01001"></a>01001       t-&gt;<a class="code" href="group__midasincludecode.html#ga7b6db64e56a7eca12d6efb6cb64748fa">registered</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01002"></a>01002       <span class="keywordflow">return</span>;
<a name="l01003"></a>01003    }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005    <span class="comment">/* allocate space for pointer to test */</span>
<a name="l01006"></a>01006    <span class="keywordflow">if</span> (n_test == 0) {
<a name="l01007"></a>01007       tl = (<a class="code" href="structANA__TEST.html">ANA_TEST</a> **) malloc(2 * <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *));
<a name="l01008"></a>01008 
<a name="l01009"></a>01009       <span class="comment">/* define &quot;always true&quot; test */</span>
<a name="l01010"></a>01010       tl[0] = (<a class="code" href="structANA__TEST.html">ANA_TEST</a> *) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structANA__TEST.html">ANA_TEST</a>));
<a name="l01011"></a>01011       strcpy(tl[0]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, <span class="stringliteral">&quot;Always true&quot;</span>);
<a name="l01012"></a>01012       tl[0]-&gt;<a class="code" href="group__midasincludecode.html#ga76f53e0e2afd1fcfc50195a05d715227">count</a> = 0;
<a name="l01013"></a>01013       tl[0]-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01014"></a>01014       tl[0]-&gt;<a class="code" href="group__midasincludecode.html#ga7b6db64e56a7eca12d6efb6cb64748fa">registered</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01015"></a>01015       n_test++;
<a name="l01016"></a>01016    } <span class="keywordflow">else</span>
<a name="l01017"></a>01017       tl = (<a class="code" href="structANA__TEST.html">ANA_TEST</a> **) realloc(tl, (n_test + 1) * <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *));
<a name="l01018"></a>01018 
<a name="l01019"></a>01019    tl[n_test] = t;
<a name="l01020"></a>01020    t-&gt;<a class="code" href="group__midasincludecode.html#ga76f53e0e2afd1fcfc50195a05d715227">count</a> = 0;
<a name="l01021"></a>01021    t-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01022"></a>01022    t-&gt;<a class="code" href="group__midasincludecode.html#ga7b6db64e56a7eca12d6efb6cb64748fa">registered</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01023"></a>01023 
<a name="l01024"></a>01024    n_test++;
<a name="l01025"></a>01025 }
<a name="l01026"></a>01026 
<a name="l01027"></a><a class="code" href="mana_8cpp.html#a443aaa38b1796a39d965acb610d31cc8">01027</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a443aaa38b1796a39d965acb610d31cc8">test_clear</a>()
<a name="l01028"></a>01028 {
<a name="l01029"></a>01029    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l01030"></a>01030 
<a name="l01031"></a>01031    <span class="comment">/* clear all tests in interal list */</span>
<a name="l01032"></a>01032    <span class="keywordflow">for</span> (i = 0; i &lt; n_test; i++) {
<a name="l01033"></a>01033       tl[i]-&gt;<a class="code" href="group__midasincludecode.html#ga76f53e0e2afd1fcfc50195a05d715227">count</a> = 0;
<a name="l01034"></a>01034       tl[i]-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01035"></a>01035    }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037    <span class="comment">/* set &quot;always true&quot; test */</span>
<a name="l01038"></a>01038    <span class="keywordflow">if</span> (n_test &gt; 0)
<a name="l01039"></a>01039       tl[0]-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01040"></a>01040 }
<a name="l01041"></a>01041 
<a name="l01042"></a><a class="code" href="mana_8cpp.html#a5d0c60b46806a49cf44b5db6053b1e0f">01042</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a5d0c60b46806a49cf44b5db6053b1e0f">test_increment</a>()
<a name="l01043"></a>01043 {
<a name="l01044"></a>01044    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046    <span class="comment">/* increment test counters based on their value and reset them */</span>
<a name="l01047"></a>01047    <span class="keywordflow">for</span> (i = 0; i &lt; n_test; i++) {
<a name="l01048"></a>01048       <span class="keywordflow">if</span> (tl[i]-&gt;<a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>)
<a name="l01049"></a>01049          tl[i]-&gt;<a class="code" href="group__midasincludecode.html#ga76f53e0e2afd1fcfc50195a05d715227">count</a>++;
<a name="l01050"></a>01050       <span class="keywordflow">if</span> (i &gt; 0)
<a name="l01051"></a>01051          tl[i]-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01052"></a>01052    }
<a name="l01053"></a>01053 }
<a name="l01054"></a>01054 
<a name="l01055"></a><a class="code" href="mana_8cpp.html#a29da9175b91a9b8fbadf2499e84c11e3">01055</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a29da9175b91a9b8fbadf2499e84c11e3">test_write</a>()
<a name="l01056"></a>01056 {
<a name="l01057"></a>01057    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l01058"></a>01058    <span class="keywordtype">char</span> str[256];
<a name="l01059"></a>01059 
<a name="l01060"></a>01060    <span class="comment">/* write all test counts to /analyzer/tests/&lt;name&gt; */</span>
<a name="l01061"></a>01061    <span class="keywordflow">for</span> (i = 0; i &lt; n_test; i++) {
<a name="l01062"></a>01062       sprintf(str, <span class="stringliteral">&quot;/%s/Tests/%s&quot;</span>, analyzer_name, tl[i]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l01063"></a>01063       <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(hDB, 0, str, &amp;tl[i]-&gt;<a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>, <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>), 1, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>);
<a name="l01064"></a>01064    }
<a name="l01065"></a>01065 }
<a name="l01066"></a>01066 
<a name="l01067"></a>01067 <span class="comment">/*-- load parameters specified on command line ---------------------*/</span>
<a name="l01068"></a>01068 
<a name="l01069"></a><a class="code" href="mana_8cpp.html#ae20b777778d5dcd241cf1dfb0dd2230f">01069</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#ae20b777778d5dcd241cf1dfb0dd2230f">load_parameters</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l01070"></a>01070 {
<a name="l01071"></a>01071    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01072"></a>01072    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l01073"></a>01073    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256], str[80], value_string[80], param_string[80];
<a name="l01074"></a>01074    <span class="keywordtype">char</span> <a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>[32];
<a name="l01075"></a>01075    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l01076"></a>01076 
<a name="l01077"></a>01077    <span class="comment">/* loop over configutation file names */</span>
<a name="l01078"></a>01078    <span class="keywordflow">for</span> (i = 0; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.config_file_name[i][0] &amp;&amp; i &lt; 10; i++) {
<a name="l01079"></a>01079       <span class="keywordflow">if</span> (strchr(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.config_file_name[i], <span class="charliteral">&apos;%&apos;</span>) != NULL)
<a name="l01080"></a>01080          sprintf(file_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.config_file_name[i], run_number);
<a name="l01081"></a>01081       <span class="keywordflow">else</span>
<a name="l01082"></a>01082          strcpy(file_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.config_file_name[i]);
<a name="l01083"></a>01083 
<a name="l01084"></a>01084       <span class="comment">/* load file under &quot;/&quot; */</span>
<a name="l01085"></a>01085       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaf1812a69d21a199cc1bbb110620051b8">db_load</a>(hDB, 0, file_name, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01086"></a>01086          printf(<span class="stringliteral">&quot;Configuration file \&quot;%s\&quot; loaded\n&quot;</span>, file_name);
<a name="l01087"></a>01087    }
<a name="l01088"></a>01088 
<a name="l01089"></a>01089    <span class="comment">/* loop over parameters */</span>
<a name="l01090"></a>01090    <span class="keywordflow">for</span> (i = 0; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.param[i][0] &amp;&amp; i &lt; 10; i++) {
<a name="l01091"></a>01091       <span class="keywordflow">if</span> (strchr(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.param[i], <span class="charliteral">&apos;=&apos;</span>) == NULL) {
<a name="l01092"></a>01092          printf(<span class="stringliteral">&quot;Error: parameter %s contains no value\n&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.param[i]);
<a name="l01093"></a>01093       } <span class="keywordflow">else</span> {
<a name="l01094"></a>01094          strcpy(value_string, strchr(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.param[i], <span class="charliteral">&apos;=&apos;</span>) + 1);
<a name="l01095"></a>01095          strcpy(param_string, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.param[i]);
<a name="l01096"></a>01096          *strchr(param_string, <span class="charliteral">&apos;=&apos;</span>) = 0;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098          index = 0;
<a name="l01099"></a>01099          <span class="keywordflow">if</span> (strchr(param_string, <span class="charliteral">&apos;[&apos;</span>) != NULL) {
<a name="l01100"></a>01100             index = atoi(strchr(param_string, <span class="charliteral">&apos;[&apos;</span>) + 1);
<a name="l01101"></a>01101             *strchr(param_string, <span class="charliteral">&apos;[&apos;</span>) = 0;
<a name="l01102"></a>01102          }
<a name="l01103"></a>01103 
<a name="l01104"></a>01104          <span class="keywordflow">if</span> (param_string[0] == <span class="charliteral">&apos;/&apos;</span>)
<a name="l01105"></a>01105             strcpy(str, param_string);
<a name="l01106"></a>01106          <span class="keywordflow">else</span>
<a name="l01107"></a>01107             sprintf(str, <span class="stringliteral">&quot;/%s/Parameters/%s&quot;</span>, analyzer_name, param_string);
<a name="l01108"></a>01108          <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l01109"></a>01109          <span class="keywordflow">if</span> (hkey == 0) {
<a name="l01110"></a>01110             printf(<span class="stringliteral">&quot;Error: cannot find parameter %s in ODB\n&quot;</span>, str);
<a name="l01111"></a>01111          } <span class="keywordflow">else</span> {
<a name="l01112"></a>01112             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hkey, &amp;key);
<a name="l01113"></a>01113             <a class="code" href="group__msectionh.html#ga7b3d26e7b258c093ad999bf1286bb871">db_sscanf</a>(value_string, data, &amp;size, 0, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l01114"></a>01114 
<a name="l01115"></a>01115             status = <a class="code" href="group__msectionh.html#ga18f5e7743545b06fca4f3d5ce9889034">db_set_data_index</a>(hDB, hkey, data, size, index, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l01116"></a>01116             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01117"></a>01117                printf(<span class="stringliteral">&quot;Parameter %s changed to %s\n&quot;</span>, str, value_string);
<a name="l01118"></a>01118             <span class="keywordflow">else</span>
<a name="l01119"></a>01119                printf(<span class="stringliteral">&quot;Cannot change parameter %s\n&quot;</span>, str);
<a name="l01120"></a>01120          }
<a name="l01121"></a>01121       }
<a name="l01122"></a>01122    }
<a name="l01123"></a>01123 
<a name="l01124"></a>01124    <span class="comment">/* let parameter changes propagate to modules */</span>
<a name="l01125"></a>01125    <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(0);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01128"></a>01128 }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130 <span class="comment">/*-- book N-tuples from ODB bank structures ------------------------*/</span>
<a name="l01131"></a>01131 
<a name="l01132"></a><a class="code" href="mana_8cpp.html#a224d67b5dbc75c0db41de55f1869544f">01132</a> <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a224d67b5dbc75c0db41de55f1869544f">hbook_types</a>[][8] = {
<a name="l01133"></a>01133    <span class="stringliteral">&quot;&quot;</span>,
<a name="l01134"></a>01134    <span class="stringliteral">&quot;:U:8&quot;</span>,                      <span class="comment">/* TID_BYTE      */</span>
<a name="l01135"></a>01135    <span class="stringliteral">&quot;:I:8&quot;</span>,                      <span class="comment">/* TID_SBYTE     */</span>
<a name="l01136"></a>01136    <span class="stringliteral">&quot;:I:8&quot;</span>,                      <span class="comment">/* TID_CHAR      */</span>
<a name="l01137"></a>01137    <span class="stringliteral">&quot;:U:16&quot;</span>,                     <span class="comment">/* TID_WORD      */</span>
<a name="l01138"></a>01138    <span class="stringliteral">&quot;:I:16&quot;</span>,                     <span class="comment">/* TID_SHORT     */</span>
<a name="l01139"></a>01139    <span class="stringliteral">&quot;:U*4&quot;</span>,                      <span class="comment">/* TID_DWORD     */</span>
<a name="l01140"></a>01140    <span class="stringliteral">&quot;:I*4&quot;</span>,                      <span class="comment">/* TID_INT       */</span>
<a name="l01141"></a>01141    <span class="stringliteral">&quot;:I*4&quot;</span>,                      <span class="comment">/* TID_BOOL      */</span>
<a name="l01142"></a>01142    <span class="stringliteral">&quot;:R*4&quot;</span>,                      <span class="comment">/* TID_FLOAT     */</span>
<a name="l01143"></a>01143    <span class="stringliteral">&quot;:R*8&quot;</span>,                      <span class="comment">/* TID_DOUBLE    */</span>
<a name="l01144"></a>01144    <span class="stringliteral">&quot;:U:8&quot;</span>,                      <span class="comment">/* TID_BITFIELD  */</span>
<a name="l01145"></a>01145    <span class="stringliteral">&quot;:C:32&quot;</span>,                     <span class="comment">/* TID_STRING    */</span>
<a name="l01146"></a>01146    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_ARRAY     */</span>
<a name="l01147"></a>01147    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_STRUCT    */</span>
<a name="l01148"></a>01148    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_KEY       */</span>
<a name="l01149"></a>01149    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_LINK      */</span>
<a name="l01150"></a>01150    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_LAST      */</span>
<a name="l01151"></a>01151 
<a name="l01152"></a>01152 };
<a name="l01153"></a>01153 
<a name="l01154"></a>01154 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>(<span class="keywordtype">void</span>);
<a name="l01155"></a>01155 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a1231b896720547aa0748ecfaa9e68d05">book_ttree</a>(<span class="keywordtype">void</span>);
<a name="l01156"></a>01156 
<a name="l01157"></a><a class="code" href="mana_8cpp.html#aa2ad5915dcb13ea292c9b31f1cf492a9">01157</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#aa2ad5915dcb13ea292c9b31f1cf492a9">banks_changed</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> hDB, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="keywordtype">void</span> *info)
<a name="l01158"></a>01158 {
<a name="l01159"></a>01159    <span class="keywordtype">char</span> str[80];
<a name="l01160"></a>01160    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162    <span class="comment">/* close previously opened hot link */</span>
<a name="l01163"></a>01163    sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches&quot;</span>, analyzer_name);
<a name="l01164"></a>01164    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l01165"></a>01165    <a class="code" href="group__msectionh.html#gae60eb33ad37ee9a9ce1cbc872db2fb19">db_close_record</a>(hDB, hkey);
<a name="l01166"></a>01166 
<a name="l01167"></a>01167 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l01168"></a>01168 <span class="preprocessor"></span>   <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>();
<a name="l01169"></a>01169    printf(<span class="stringliteral">&quot;N-tuples rebooked\n&quot;</span>);
<a name="l01170"></a>01170 <span class="preprocessor">#endif</span>
<a name="l01171"></a>01171 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l01172"></a>01172 <span class="preprocessor"></span>   <a class="code" href="mana_8cpp.html#a1231b896720547aa0748ecfaa9e68d05">book_ttree</a>();
<a name="l01173"></a>01173    printf(<span class="stringliteral">&quot;ROOT TTree rebooked\n&quot;</span>);
<a name="l01174"></a>01174 <span class="preprocessor">#endif</span>
<a name="l01175"></a>01175 <span class="preprocessor"></span>}
<a name="l01176"></a>01176 
<a name="l01177"></a>01177 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l01178"></a>01178 <span class="preprocessor"></span><a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>(<span class="keywordtype">void</span>)
<a name="l01179"></a>01179 {
<a name="l01180"></a>01180    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, n_tag, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, id;
<a name="l01181"></a>01181    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l01182"></a>01182    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l01183"></a>01183    <span class="keywordtype">char</span> ch_tags[2000];
<a name="l01184"></a>01184    <span class="keywordtype">char</span> rw_tag[512][8];
<a name="l01185"></a>01185    <span class="keywordtype">char</span> str[80], str2[80], key_name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>], block_name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>];
<a name="l01186"></a>01186    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l01187"></a>01187    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l01188"></a>01188 
<a name="l01189"></a>01189    <span class="comment">/* check global N-tuple flag */</span>
<a name="l01190"></a>01190    ntuple_flag = 1;
<a name="l01191"></a>01191    size = <span class="keyword">sizeof</span>(ntuple_flag);
<a name="l01192"></a>01192    sprintf(str, <span class="stringliteral">&quot;/%s/Book N-tuples&quot;</span>, analyzer_name);
<a name="l01193"></a>01193    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, str, &amp;ntuple_flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    <span class="keywordflow">if</span> (!ntuple_flag)
<a name="l01196"></a>01196       <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198    <span class="comment">/* copy output flag from ODB to bank_list */</span>
<a name="l01199"></a>01199    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l01200"></a>01200       bank_list = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l01201"></a>01201 
<a name="l01202"></a>01202       <span class="keywordflow">if</span> (bank_list != NULL)
<a name="l01203"></a>01203          <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l01204"></a>01204             sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches/%s&quot;</span>, analyzer_name, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l01205"></a>01205             bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01206"></a>01206             size = <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>);
<a name="l01207"></a>01207             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, str, &amp;bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a>, &amp;size, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01208"></a>01208          }
<a name="l01209"></a>01209    }
<a name="l01210"></a>01210 
<a name="l01211"></a>01211    <span class="comment">/* hot link bank switches to N-tuple re-booking */</span>
<a name="l01212"></a>01212    sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches&quot;</span>, analyzer_name);
<a name="l01213"></a>01213    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l01214"></a>01214    <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(hDB, hkey, NULL, 0, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="fal_8c.html#aa2ad5915dcb13ea292c9b31f1cf492a9">banks_changed</a>, NULL);
<a name="l01215"></a>01215 
<a name="l01216"></a>01216    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt) {
<a name="l01217"></a>01217       <span class="comment">/* book CW N-tuples */</span>
<a name="l01218"></a>01218 
<a name="l01219"></a>01219       <span class="comment">/* go through all analyzer requests (events) */</span>
<a name="l01220"></a>01220       <span class="keywordflow">for</span> (index = 0; analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; index++) {
<a name="l01221"></a>01221          <span class="comment">/* book N-tuple with evend ID */</span>
<a name="l01222"></a>01222          <a class="code" href="hbook_8h.html#a470e9177386f678890bb5816dcd1eebc">HBNT</a>(analyze_request[index].ar_info.event_id, analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>,
<a name="l01223"></a>01223               bstr);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225          <span class="comment">/* book run number/event number/time */</span>
<a name="l01226"></a>01226          strcpy(str, <span class="stringliteral">&quot;Number&quot;</span>);
<a name="l01227"></a>01227          strcpy(str2, <span class="stringliteral">&quot;Run:U*4,Number:U*4,Time:U*4&quot;</span>);
<a name="l01228"></a>01228          <a class="code" href="hbook_8h.html#aa3ccf6a8c1ca48617fa02e0e9dd5776e">HBNAME</a>(analyze_request[index].ar_info.event_id, str,
<a name="l01229"></a>01229                 (<span class="keywordtype">int</span> *) &amp;analyze_request[index].<a class="code" href="group__midasincludecode.html#ga7cac02c3834cd0d1574db723568348a6">number</a>, str2);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231          bank_list = analyze_request[index].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l01232"></a>01232          <span class="keywordflow">if</span> (bank_list == NULL) {
<a name="l01233"></a>01233             <span class="comment">/* book fixed event */</span>
<a name="l01234"></a>01234             event_def =
<a name="l01235"></a>01235                 <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>((<span class="keywordtype">short</span> <span class="keywordtype">int</span>) analyze_request[index].ar_info.
<a name="l01236"></a>01236                                         <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>);
<a name="l01237"></a>01237             <span class="keywordflow">if</span> (event_def == NULL) {
<a name="l01238"></a>01238                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>, <span class="stringliteral">&quot;Cannot find definition of event %s in ODB&quot;</span>,
<a name="l01239"></a>01239                       analyze_request[index].event_name);
<a name="l01240"></a>01240                <span class="keywordflow">return</span> 0;
<a name="l01241"></a>01241             }
<a name="l01242"></a>01242 
<a name="l01243"></a>01243             ch_tags[0] = 0;
<a name="l01244"></a>01244             <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01245"></a>01245                status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, i, &amp;hkey);
<a name="l01246"></a>01246                <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01247"></a>01247                   <span class="keywordflow">break</span>;
<a name="l01248"></a>01248 
<a name="l01249"></a>01249                <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hkey, &amp;key);
<a name="l01250"></a>01250 
<a name="l01251"></a>01251                <span class="comment">/* convert blanks etc to &apos;_&apos; */</span>
<a name="l01252"></a>01252                strcpy(str, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01253"></a>01253                <span class="keywordflow">for</span> (j = 0; str[j]; j++) {
<a name="l01254"></a>01254                   <span class="keywordflow">if</span> (!(str[j] &gt;= <span class="charliteral">&apos;a&apos;</span> &amp;&amp; str[j] &lt;= <span class="charliteral">&apos;z&apos;</span>) &amp;&amp;
<a name="l01255"></a>01255                       !(str[j] &gt;= <span class="charliteral">&apos;A&apos;</span> &amp;&amp; str[j] &lt;= <span class="charliteral">&apos;Z&apos;</span>) &amp;&amp;
<a name="l01256"></a>01256                       !(str[j] &gt;= <span class="charliteral">&apos;0&apos;</span> &amp;&amp; str[j] &lt;= <span class="charliteral">&apos;9&apos;</span>))
<a name="l01257"></a>01257                      str[j] = <span class="charliteral">&apos;_&apos;</span>;
<a name="l01258"></a>01258                }
<a name="l01259"></a>01259                strcat(ch_tags, str);
<a name="l01260"></a>01260                str[0] = 0;
<a name="l01261"></a>01261 
<a name="l01262"></a>01262                <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> &gt; 1)
<a name="l01263"></a>01263                   sprintf(str, <span class="stringliteral">&quot;(%d)&quot;</span>, key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>);
<a name="l01264"></a>01264 
<a name="l01265"></a>01265                <span class="keywordflow">if</span> (hbook_types[key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>] != NULL)
<a name="l01266"></a>01266                   strcat(str, hbook_types[key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>]);
<a name="l01267"></a>01267                <span class="keywordflow">else</span> {
<a name="l01268"></a>01268                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01269"></a>01269                          <span class="stringliteral">&quot;Key %s in event %s is of type %s with no HBOOK correspondence&quot;</span>,
<a name="l01270"></a>01270                          key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>, analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>,
<a name="l01271"></a>01271                          <a class="code" href="group__msectionh.html#ga94fb45fa1cdd442e964ebe32c7668976">rpc_tid_name</a>(key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>));
<a name="l01272"></a>01272                   <span class="keywordflow">return</span> 0;
<a name="l01273"></a>01273                }
<a name="l01274"></a>01274                strcat(ch_tags, str);
<a name="l01275"></a>01275                strcat(ch_tags, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l01276"></a>01276             }
<a name="l01277"></a>01277 
<a name="l01278"></a>01278             ch_tags[strlen(ch_tags) - 1] = 0;
<a name="l01279"></a>01279             <a class="code" href="group__msectionh.html#ga1880903c0ebb0d58809f48f6b2d59704">db_get_record_size</a>(hDB, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, 0, &amp;size);
<a name="l01280"></a>01280             analyze_request[index].<a class="code" href="group__midasincludecode.html#ga9a0765582d554039a03d79a119c60558">addr</a> = calloc(1, size);
<a name="l01281"></a>01281 
<a name="l01282"></a>01282             strcpy(block_name, analyze_request[index].event_name);
<a name="l01283"></a>01283             block_name[8] = 0;
<a name="l01284"></a>01284 
<a name="l01285"></a>01285             <a class="code" href="hbook_8h.html#aa3ccf6a8c1ca48617fa02e0e9dd5776e">HBNAME</a>(analyze_request[index].ar_info.event_id, block_name,
<a name="l01286"></a>01286                    analyze_request[index].<a class="code" href="group__midasincludecode.html#ga9a0765582d554039a03d79a119c60558">addr</a>, ch_tags);
<a name="l01287"></a>01287          } <span class="keywordflow">else</span> {
<a name="l01288"></a>01288             <span class="comment">/* go thorough all banks in bank_list */</span>
<a name="l01289"></a>01289             <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l01290"></a>01290                <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0)
<a name="l01291"></a>01291                   <span class="keywordflow">continue</span>;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293                <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a> != <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l01294"></a>01294                   sprintf(str, <span class="stringliteral">&quot;N%s[0,%ld]&quot;</span>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>);
<a name="l01295"></a>01295                   <a class="code" href="hbook_8h.html#aa3ccf6a8c1ca48617fa02e0e9dd5776e">HBNAME</a>(analyze_request[index].ar_info.event_id,
<a name="l01296"></a>01296                          bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) &amp; bank_list-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a>, str);
<a name="l01297"></a>01297 
<a name="l01298"></a>01298                   sprintf(str, <span class="stringliteral">&quot;%s(N%s)&quot;</span>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l01299"></a>01299 
<a name="l01300"></a>01300                   <span class="comment">/* define variable length array */</span>
<a name="l01301"></a>01301                   <span class="keywordflow">if</span> (hbook_types[bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>] != NULL)
<a name="l01302"></a>01302                      strcat(str, hbook_types[bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>]);
<a name="l01303"></a>01303                   <span class="keywordflow">else</span> {
<a name="l01304"></a>01304                      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01305"></a>01305                             <span class="stringliteral">&quot;Bank %s is of type %s with no HBOOK correspondence&quot;</span>,
<a name="l01306"></a>01306                             bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, <a class="code" href="group__msectionh.html#ga94fb45fa1cdd442e964ebe32c7668976">rpc_tid_name</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>));
<a name="l01307"></a>01307                      <span class="keywordflow">return</span> 0;
<a name="l01308"></a>01308                   }
<a name="l01309"></a>01309 
<a name="l01310"></a>01310                   <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>) == 0) {
<a name="l01311"></a>01311                      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01312"></a>01312                             <span class="stringliteral">&quot;Bank %s is of type with unknown size&quot;</span>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l01313"></a>01313                      <span class="keywordflow">return</span> 0;
<a name="l01314"></a>01314                   }
<a name="l01315"></a>01315 
<a name="l01316"></a>01316                   bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a> =
<a name="l01317"></a>01317                       calloc(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>, <a class="code" href="Mql_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(4, <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>)));
<a name="l01318"></a>01318 
<a name="l01319"></a>01319                   <a class="code" href="hbook_8h.html#aa3ccf6a8c1ca48617fa02e0e9dd5776e">HBNAME</a>(analyze_request[index].ar_info.event_id,
<a name="l01320"></a>01320                          bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>, str);
<a name="l01321"></a>01321                } <span class="keywordflow">else</span> {
<a name="l01322"></a>01322                   <span class="comment">/* define structured bank */</span>
<a name="l01323"></a>01323                   ch_tags[0] = 0;
<a name="l01324"></a>01324                   <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01325"></a>01325                      status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a>, i, &amp;hkey);
<a name="l01326"></a>01326                      <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01327"></a>01327                         <span class="keywordflow">break</span>;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329                      <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hkey, &amp;key);
<a name="l01330"></a>01330 
<a name="l01331"></a>01331                      <span class="comment">/* convert blanks etc to &apos;_&apos; */</span>
<a name="l01332"></a>01332                      strcpy(str, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01333"></a>01333                      <span class="keywordflow">for</span> (j = 0; str[j]; j++) {
<a name="l01334"></a>01334                         <span class="keywordflow">if</span> (!(str[j] &gt;= <span class="charliteral">&apos;a&apos;</span> &amp;&amp; str[j] &lt;= <span class="charliteral">&apos;z&apos;</span>) &amp;&amp;
<a name="l01335"></a>01335                             !(str[j] &gt;= <span class="charliteral">&apos;A&apos;</span> &amp;&amp; str[j] &lt;= <span class="charliteral">&apos;Z&apos;</span>) &amp;&amp;
<a name="l01336"></a>01336                             !(str[j] &gt;= <span class="charliteral">&apos;0&apos;</span> &amp;&amp; str[j] &lt;= <span class="charliteral">&apos;9&apos;</span>))
<a name="l01337"></a>01337                            str[j] = <span class="charliteral">&apos;_&apos;</span>;
<a name="l01338"></a>01338                      }
<a name="l01339"></a>01339                      strcat(ch_tags, str);
<a name="l01340"></a>01340                      str[0] = 0;
<a name="l01341"></a>01341 
<a name="l01342"></a>01342                      <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> &gt; 1)
<a name="l01343"></a>01343                         sprintf(str, <span class="stringliteral">&quot;(%d)&quot;</span>, key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>);
<a name="l01344"></a>01344 
<a name="l01345"></a>01345                      <span class="keywordflow">if</span> (hbook_types[key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>] != NULL)
<a name="l01346"></a>01346                         strcat(str, hbook_types[key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>]);
<a name="l01347"></a>01347                      <span class="keywordflow">else</span> {
<a name="l01348"></a>01348                         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01349"></a>01349                                <span class="stringliteral">&quot;Key %s in bank %s is of type %s with no HBOOK correspondence&quot;</span>,
<a name="l01350"></a>01350                                key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, <a class="code" href="group__msectionh.html#ga94fb45fa1cdd442e964ebe32c7668976">rpc_tid_name</a>(key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>));
<a name="l01351"></a>01351                         <span class="keywordflow">return</span> 0;
<a name="l01352"></a>01352                      }
<a name="l01353"></a>01353                      strcat(ch_tags, str);
<a name="l01354"></a>01354                      strcat(ch_tags, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l01355"></a>01355                   }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357                   ch_tags[strlen(ch_tags) - 1] = 0;
<a name="l01358"></a>01358                   bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a> = calloc(1, bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>);
<a name="l01359"></a>01359 
<a name="l01360"></a>01360                   <a class="code" href="hbook_8h.html#aa3ccf6a8c1ca48617fa02e0e9dd5776e">HBNAME</a>(analyze_request[index].ar_info.event_id,
<a name="l01361"></a>01361                          bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>, ch_tags);
<a name="l01362"></a>01362                }
<a name="l01363"></a>01363             }
<a name="l01364"></a>01364          }
<a name="l01365"></a>01365 
<a name="l01366"></a>01366          <span class="comment">/* HPRNT(analyze_request[index].ar_info.event_id); */</span>
<a name="l01367"></a>01367       }
<a name="l01368"></a>01368    } <span class="keywordflow">else</span> {
<a name="l01369"></a>01369       <span class="comment">/* book RW N-tuples */</span>
<a name="l01370"></a>01370 
<a name="l01371"></a>01371       <span class="comment">/* go through all analyzer requests (events) */</span>
<a name="l01372"></a>01372       <span class="keywordflow">for</span> (index = 0; analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; index++) {
<a name="l01373"></a>01373          <span class="comment">/* get pointer to event definition */</span>
<a name="l01374"></a>01374          event_def =
<a name="l01375"></a>01375              <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>((<span class="keywordtype">short</span> <span class="keywordtype">int</span>) analyze_request[index].ar_info.event_id);
<a name="l01376"></a>01376 
<a name="l01377"></a>01377          <span class="comment">/* skip if not found */</span>
<a name="l01378"></a>01378          <span class="keywordflow">if</span> (!event_def)
<a name="l01379"></a>01379             <span class="keywordflow">continue</span>;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381          <span class="comment">/* don&apos;t book NT if not requested */</span>
<a name="l01382"></a>01382          <span class="keywordflow">if</span> (analyze_request[index].rwnt_buffer_size == 0) {
<a name="l01383"></a>01383             event_def-&gt;<a class="code" href="structEVENT__DEF.html#a66d1640adf533d3d29e015244e0c4fd2">disabled</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01384"></a>01384             <span class="keywordflow">continue</span>;
<a name="l01385"></a>01385          }
<a name="l01386"></a>01386 
<a name="l01387"></a>01387          n_tag = 0;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389          strcpy(rw_tag[n_tag++], <span class="stringliteral">&quot;Run&quot;</span>);
<a name="l01390"></a>01390          strcpy(rw_tag[n_tag++], <span class="stringliteral">&quot;Number&quot;</span>);
<a name="l01391"></a>01391          strcpy(rw_tag[n_tag++], <span class="stringliteral">&quot;Time&quot;</span>);
<a name="l01392"></a>01392 
<a name="l01393"></a>01393          <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.verbose) {
<a name="l01394"></a>01394             printf(<span class="stringliteral">&quot;NT #%d-1: Run\n&quot;</span>, analyze_request[index].ar_info.event_id);
<a name="l01395"></a>01395             printf(<span class="stringliteral">&quot;NT #%d-2: Number\n&quot;</span>, analyze_request[index].ar_info.event_id);
<a name="l01396"></a>01396             printf(<span class="stringliteral">&quot;NT #%d-3: Time\n&quot;</span>, analyze_request[index].ar_info.event_id);
<a name="l01397"></a>01397          }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399          bank_list = analyze_request[index].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l01400"></a>01400          <span class="keywordflow">if</span> (bank_list == NULL) {
<a name="l01401"></a>01401             <span class="comment">/* book fixed event */</span>
<a name="l01402"></a>01402 
<a name="l01403"></a>01403             <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01404"></a>01404                status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, i, &amp;hkey);
<a name="l01405"></a>01405                <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01406"></a>01406                   <span class="keywordflow">break</span>;
<a name="l01407"></a>01407 
<a name="l01408"></a>01408                <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hkey, &amp;key);
<a name="l01409"></a>01409 
<a name="l01410"></a>01410                <span class="comment">/* convert blanks etc to &apos;_&apos; */</span>
<a name="l01411"></a>01411                strcpy(key_name, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01412"></a>01412                <span class="keywordflow">for</span> (j = 0; key_name[j]; j++) {
<a name="l01413"></a>01413                   <span class="keywordflow">if</span> (!(key_name[j] &gt;= <span class="charliteral">&apos;a&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;z&apos;</span>) &amp;&amp;
<a name="l01414"></a>01414                       !(key_name[j] &gt;= <span class="charliteral">&apos;A&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;Z&apos;</span>) &amp;&amp;
<a name="l01415"></a>01415                       !(key_name[j] &gt;= <span class="charliteral">&apos;0&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;9&apos;</span>))
<a name="l01416"></a>01416                      key_name[j] = <span class="charliteral">&apos;_&apos;</span>;
<a name="l01417"></a>01417                }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419                <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> &gt; 1)
<a name="l01420"></a>01420                   <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l01421"></a>01421                      sprintf(str, <span class="stringliteral">&quot;%s%d&quot;</span>, key_name, j);
<a name="l01422"></a>01422                      strncpy(rw_tag[n_tag++], str, 8);
<a name="l01423"></a>01423 
<a name="l01424"></a>01424                      <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.verbose)
<a name="l01425"></a>01425                         printf(<span class="stringliteral">&quot;NT #%d-%d: %s\n&quot;</span>, analyze_request[index].ar_info.event_id,
<a name="l01426"></a>01426                                n_tag + 1, str);
<a name="l01427"></a>01427 
<a name="l01428"></a>01428                      <span class="keywordflow">if</span> (n_tag &gt;= 512) {
<a name="l01429"></a>01429                         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01430"></a>01430                                <span class="stringliteral">&quot;Too much tags for RW N-tupeles (512 maximum)&quot;</span>);
<a name="l01431"></a>01431                         <span class="keywordflow">return</span> 0;
<a name="l01432"></a>01432                      }
<a name="l01433"></a>01433                } <span class="keywordflow">else</span> {
<a name="l01434"></a>01434                   strncpy(rw_tag[n_tag++], key_name, 8);
<a name="l01435"></a>01435 
<a name="l01436"></a>01436                   <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.verbose)
<a name="l01437"></a>01437                      printf(<span class="stringliteral">&quot;NT #%d-%d: %s\n&quot;</span>, analyze_request[index].ar_info.event_id,
<a name="l01438"></a>01438                             n_tag, key_name);
<a name="l01439"></a>01439                }
<a name="l01440"></a>01440 
<a name="l01441"></a>01441                <span class="keywordflow">if</span> (n_tag &gt;= 512) {
<a name="l01442"></a>01442                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01443"></a>01443                          <span class="stringliteral">&quot;Too much tags for RW N-tupeles (512 maximum)&quot;</span>);
<a name="l01444"></a>01444                   <span class="keywordflow">return</span> 0;
<a name="l01445"></a>01445                }
<a name="l01446"></a>01446             }
<a name="l01447"></a>01447          } <span class="keywordflow">else</span> {
<a name="l01448"></a>01448             <span class="comment">/* go through all banks in bank_list */</span>
<a name="l01449"></a>01449             <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l01450"></a>01450                <span class="comment">/* remember tag offset in n_data variable */</span>
<a name="l01451"></a>01451                bank_list-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> = n_tag;
<a name="l01452"></a>01452 
<a name="l01453"></a>01453                <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0)
<a name="l01454"></a>01454                   <span class="keywordflow">continue</span>;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456                <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a> != <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l01457"></a>01457                   <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>; i++) {
<a name="l01458"></a>01458                      sprintf(str, <span class="stringliteral">&quot;%s%d&quot;</span>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, i);
<a name="l01459"></a>01459                      strncpy(rw_tag[n_tag++], str, 8);
<a name="l01460"></a>01460 
<a name="l01461"></a>01461                      <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.verbose)
<a name="l01462"></a>01462                         printf(<span class="stringliteral">&quot;NT #%d-%d: %s\n&quot;</span>, analyze_request[index].ar_info.event_id,
<a name="l01463"></a>01463                                n_tag, str);
<a name="l01464"></a>01464                      <span class="keywordflow">if</span> (n_tag &gt;= 512) {
<a name="l01465"></a>01465                         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01466"></a>01466                                <span class="stringliteral">&quot;Too much tags for RW N-tupeles (512 maximum)&quot;</span>);
<a name="l01467"></a>01467                         <span class="keywordflow">return</span> 0;
<a name="l01468"></a>01468                      }
<a name="l01469"></a>01469                   }
<a name="l01470"></a>01470                } <span class="keywordflow">else</span> {
<a name="l01471"></a>01471                   <span class="comment">/* define structured bank */</span>
<a name="l01472"></a>01472                   <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01473"></a>01473                      status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a>, i, &amp;hkey);
<a name="l01474"></a>01474                      <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01475"></a>01475                         <span class="keywordflow">break</span>;
<a name="l01476"></a>01476 
<a name="l01477"></a>01477                      <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hkey, &amp;key);
<a name="l01478"></a>01478 
<a name="l01479"></a>01479                      <span class="comment">/* convert blanks etc to &apos;_&apos; */</span>
<a name="l01480"></a>01480                      strcpy(key_name, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01481"></a>01481                      <span class="keywordflow">for</span> (j = 0; key_name[j]; j++) {
<a name="l01482"></a>01482                         <span class="keywordflow">if</span> (!(key_name[j] &gt;= <span class="charliteral">&apos;a&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;z&apos;</span>) &amp;&amp;
<a name="l01483"></a>01483                             !(key_name[j] &gt;= <span class="charliteral">&apos;A&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;Z&apos;</span>) &amp;&amp;
<a name="l01484"></a>01484                             !(key_name[j] &gt;= <span class="charliteral">&apos;0&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;9&apos;</span>))
<a name="l01485"></a>01485                            key_name[j] = <span class="charliteral">&apos;_&apos;</span>;
<a name="l01486"></a>01486                      }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488                      <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> &gt; 1)
<a name="l01489"></a>01489                         <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l01490"></a>01490                            sprintf(str, <span class="stringliteral">&quot;%s%d&quot;</span>, key_name, j);
<a name="l01491"></a>01491                            strncpy(rw_tag[n_tag++], str, 8);
<a name="l01492"></a>01492 
<a name="l01493"></a>01493                            <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.verbose)
<a name="l01494"></a>01494                               printf(<span class="stringliteral">&quot;NT #%d-%d: %s\n&quot;</span>,
<a name="l01495"></a>01495                                      analyze_request[index].ar_info.event_id, n_tag, str);
<a name="l01496"></a>01496 
<a name="l01497"></a>01497                            <span class="keywordflow">if</span> (n_tag &gt;= 512) {
<a name="l01498"></a>01498                               <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01499"></a>01499                                      <span class="stringliteral">&quot;Too much tags for RW N-tupeles (512 maximum)&quot;</span>);
<a name="l01500"></a>01500                               <span class="keywordflow">return</span> 0;
<a name="l01501"></a>01501                            }
<a name="l01502"></a>01502                      } <span class="keywordflow">else</span> {
<a name="l01503"></a>01503                         strncpy(rw_tag[n_tag++], key_name, 8);
<a name="l01504"></a>01504                         <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.verbose)
<a name="l01505"></a>01505                            printf(<span class="stringliteral">&quot;NT #%d-%d: %s\n&quot;</span>,
<a name="l01506"></a>01506                                   analyze_request[index].ar_info.event_id, n_tag,
<a name="l01507"></a>01507                                   key_name);
<a name="l01508"></a>01508                      }
<a name="l01509"></a>01509 
<a name="l01510"></a>01510                      <span class="keywordflow">if</span> (n_tag &gt;= 512) {
<a name="l01511"></a>01511                         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01512"></a>01512                                <span class="stringliteral">&quot;Too much tags for RW N-tupeles (512 maximum)&quot;</span>);
<a name="l01513"></a>01513                         <span class="keywordflow">return</span> 0;
<a name="l01514"></a>01514                      }
<a name="l01515"></a>01515                   }
<a name="l01516"></a>01516                }
<a name="l01517"></a>01517             }
<a name="l01518"></a>01518          }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520          <span class="comment">/* book N-tuple with evend ID */</span>
<a name="l01521"></a>01521          strcpy(block_name, analyze_request[index].event_name);
<a name="l01522"></a>01522          block_name[8] = 0;
<a name="l01523"></a>01523 
<a name="l01524"></a>01524          <span class="keywordtype">id</span> = analyze_request[index].<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="structAR__INFO.html#acb0cf26c5067b0c8eb7a895b70e42f11">event_id</a>;
<a name="l01525"></a>01525          <span class="keywordflow">if</span> (<a class="code" href="hbook_8h.html#a3efc0c35b6588eb50787985bb6440719">HEXIST</a>(<span class="keywordtype">id</span>))
<a name="l01526"></a>01526             <a class="code" href="hbook_8h.html#a3d7fcc23e32f4f11cb69aa1f97073ac0">HDELET</a>(<span class="keywordtype">id</span>);
<a name="l01527"></a>01527 
<a name="l01528"></a>01528          <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online || <a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <span class="stringliteral">&quot;OFLN&quot;</span>))
<a name="l01529"></a>01529             <a class="code" href="hbook_8h.html#afa68d551e34550d853d9a019dfcad8a0">HBOOKN</a>(<span class="keywordtype">id</span>, block_name, n_tag, bstr,
<a name="l01530"></a>01530                    n_tag * analyze_request[index].rwnt_buffer_size, rw_tag);
<a name="l01531"></a>01531          <span class="keywordflow">else</span> {
<a name="l01532"></a>01532             strcpy(str, <span class="stringliteral">&quot;//OFFLINE&quot;</span>);
<a name="l01533"></a>01533             <a class="code" href="hbook_8h.html#afa68d551e34550d853d9a019dfcad8a0">HBOOKN</a>(<span class="keywordtype">id</span>, block_name, n_tag, str, 5120, rw_tag);
<a name="l01534"></a>01534          }
<a name="l01535"></a>01535 
<a name="l01536"></a>01536          <span class="keywordflow">if</span> (!<a class="code" href="hbook_8h.html#a3efc0c35b6588eb50787985bb6440719">HEXIST</a>(<span class="keywordtype">id</span>)) {
<a name="l01537"></a>01537             printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01538"></a>01538             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l01539"></a>01539                    <span class="stringliteral">&quot;Cannot book N-tuple #%d. Increase PAWC size via the -s flag or switch off banks&quot;</span>,
<a name="l01540"></a>01540                    <span class="keywordtype">id</span>);
<a name="l01541"></a>01541          }
<a name="l01542"></a>01542       }
<a name="l01543"></a>01543    }
<a name="l01544"></a>01544 
<a name="l01545"></a>01545    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01546"></a>01546 }
<a name="l01547"></a>01547 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l01548"></a>01548 
<a name="l01549"></a>01549 <span class="comment">/*-- book TTree from ODB bank structures ---------------------------*/</span>
<a name="l01550"></a>01550 
<a name="l01551"></a>01551 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l01552"></a>01552 <span class="preprocessor"></span>
<a name="l01553"></a>01553 <span class="keywordtype">char</span> ttree_types[][8] = {
<a name="l01554"></a>01554    <span class="stringliteral">&quot;&quot;</span>,
<a name="l01555"></a>01555    <span class="stringliteral">&quot;b&quot;</span>,                         <span class="comment">/* TID_BYTE      */</span>
<a name="l01556"></a>01556    <span class="stringliteral">&quot;B&quot;</span>,                         <span class="comment">/* TID_SBYTE     */</span>
<a name="l01557"></a>01557    <span class="stringliteral">&quot;b&quot;</span>,                         <span class="comment">/* TID_CHAR      */</span>
<a name="l01558"></a>01558    <span class="stringliteral">&quot;s&quot;</span>,                         <span class="comment">/* TID_WORD      */</span>
<a name="l01559"></a>01559    <span class="stringliteral">&quot;S&quot;</span>,                         <span class="comment">/* TID_SHORT     */</span>
<a name="l01560"></a>01560    <span class="stringliteral">&quot;i&quot;</span>,                         <span class="comment">/* TID_DWORD     */</span>
<a name="l01561"></a>01561    <span class="stringliteral">&quot;I&quot;</span>,                         <span class="comment">/* TID_INT       */</span>
<a name="l01562"></a>01562    <span class="stringliteral">&quot;I&quot;</span>,                         <span class="comment">/* TID_BOOL      */</span>
<a name="l01563"></a>01563    <span class="stringliteral">&quot;F&quot;</span>,                         <span class="comment">/* TID_FLOAT     */</span>
<a name="l01564"></a>01564    <span class="stringliteral">&quot;D&quot;</span>,                         <span class="comment">/* TID_DOUBLE    */</span>
<a name="l01565"></a>01565    <span class="stringliteral">&quot;b&quot;</span>,                         <span class="comment">/* TID_BITFIELD  */</span>
<a name="l01566"></a>01566    <span class="stringliteral">&quot;C&quot;</span>,                         <span class="comment">/* TID_STRING    */</span>
<a name="l01567"></a>01567    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_ARRAY     */</span>
<a name="l01568"></a>01568    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_STRUCT    */</span>
<a name="l01569"></a>01569    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_KEY       */</span>
<a name="l01570"></a>01570    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_LINK      */</span>
<a name="l01571"></a>01571    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_LAST      */</span>
<a name="l01572"></a>01572 
<a name="l01573"></a>01573 };
<a name="l01574"></a>01574 
<a name="l01575"></a>01575 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a1231b896720547aa0748ecfaa9e68d05">book_ttree</a>()
<a name="l01576"></a>01576 {
<a name="l01577"></a>01577    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> index, i, status, size;
<a name="l01578"></a>01578    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l01579"></a>01579    <a class="code" href="structKEY.html">KEY</a> key;
<a name="l01580"></a>01580    <span class="keywordtype">char</span> leaf_tags[2000];
<a name="l01581"></a>01581    <span class="keywordtype">char</span> str[80];
<a name="l01582"></a>01582    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l01583"></a>01583    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l01584"></a>01584    EVENT_TREE *et;
<a name="l01585"></a>01585 
<a name="l01586"></a>01586    <span class="comment">/* check global N-tuple flag */</span>
<a name="l01587"></a>01587    ntuple_flag = 1;
<a name="l01588"></a>01588    size = <span class="keyword">sizeof</span>(ntuple_flag);
<a name="l01589"></a>01589    sprintf(str, <span class="stringliteral">&quot;/%s/Book TTree&quot;</span>, analyzer_name);
<a name="l01590"></a>01590    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, str, &amp;ntuple_flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01591"></a>01591 
<a name="l01592"></a>01592    <span class="keywordflow">if</span> (!ntuple_flag)
<a name="l01593"></a>01593       <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01594"></a>01594 
<a name="l01595"></a>01595    <span class="comment">/* copy output flag from ODB to bank_list */</span>
<a name="l01596"></a>01596    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l01597"></a>01597       bank_list = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l01598"></a>01598 
<a name="l01599"></a>01599       <span class="keywordflow">if</span> (bank_list != NULL)
<a name="l01600"></a>01600          <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l01601"></a>01601             sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches/%s&quot;</span>, analyzer_name, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l01602"></a>01602             bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01603"></a>01603             size = <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>);
<a name="l01604"></a>01604             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, str, &amp;bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a>, &amp;size, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01605"></a>01605          }
<a name="l01606"></a>01606    }
<a name="l01607"></a>01607 
<a name="l01608"></a>01608    <span class="comment">/* hot link bank switches to N-tuple re-booking */</span>
<a name="l01609"></a>01609    sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches&quot;</span>, analyzer_name);
<a name="l01610"></a>01610    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l01611"></a>01611    <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(hDB, hkey, NULL, 0, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="fal_8c.html#aa2ad5915dcb13ea292c9b31f1cf492a9">banks_changed</a>, NULL);
<a name="l01612"></a>01612 
<a name="l01613"></a>01613    <span class="comment">/* go through all analyzer requests (events) */</span>
<a name="l01614"></a>01614    <span class="keywordflow">for</span> (index = 0; analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; index++) {
<a name="l01615"></a>01615       <span class="comment">/* create tree */</span>
<a name="l01616"></a>01616       tree_struct.n_tree++;
<a name="l01617"></a>01617       <span class="keywordflow">if</span> (tree_struct.n_tree == 1)
<a name="l01618"></a>01618          tree_struct.event_tree = (EVENT_TREE *) malloc(<span class="keyword">sizeof</span>(EVENT_TREE));
<a name="l01619"></a>01619       <span class="keywordflow">else</span>
<a name="l01620"></a>01620          tree_struct.event_tree =
<a name="l01621"></a>01621              (EVENT_TREE *) realloc(tree_struct.event_tree,
<a name="l01622"></a>01622                                     <span class="keyword">sizeof</span>(EVENT_TREE) * tree_struct.n_tree);
<a name="l01623"></a>01623 
<a name="l01624"></a>01624       et = tree_struct.event_tree + (tree_struct.n_tree - 1);
<a name="l01625"></a>01625 
<a name="l01626"></a>01626       et-&gt;event_id = analyze_request[index].<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="structAR__INFO.html#acb0cf26c5067b0c8eb7a895b70e42f11">event_id</a>;
<a name="l01627"></a>01627       et-&gt;n_branch = 0;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629       <span class="comment">/* create tree */</span>
<a name="l01630"></a>01630       sprintf(str, <span class="stringliteral">&quot;Event \&quot;%s\&quot;, ID %d&quot;</span>, analyze_request[index].event_name,
<a name="l01631"></a>01631               et-&gt;event_id);
<a name="l01632"></a>01632       et-&gt;tree = <span class="keyword">new</span> TTree(analyze_request[index].event_name, str);
<a name="l01633"></a>01633 
<a name="l01634"></a>01634       <span class="comment">/* book run number/event number/time */</span>
<a name="l01635"></a>01635       et-&gt;branch = (TBranch **) malloc(<span class="keyword">sizeof</span>(TBranch *));
<a name="l01636"></a>01636       et-&gt;branch_name = (<span class="keywordtype">char</span> *) malloc(<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l01637"></a>01637       et-&gt;branch_filled = (<span class="keywordtype">int</span> *) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l01638"></a>01638       et-&gt;branch_len = (<span class="keywordtype">int</span> *) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l01639"></a>01639 
<a name="l01640"></a>01640       et-&gt;branch[et-&gt;n_branch] =
<a name="l01641"></a>01641           et-&gt;tree-&gt;Branch(<span class="stringliteral">&quot;Number&quot;</span>, &amp;analyze_request[index].number,
<a name="l01642"></a>01642                            <span class="stringliteral">&quot;Run/I:Number/I:Time/i&quot;</span>);
<a name="l01643"></a>01643       strcpy(et-&gt;branch_name, <span class="stringliteral">&quot;Number&quot;</span>);
<a name="l01644"></a>01644       et-&gt;n_branch++;
<a name="l01645"></a>01645 
<a name="l01646"></a>01646       bank_list = analyze_request[index].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l01647"></a>01647       <span class="keywordflow">if</span> (bank_list == NULL) {
<a name="l01648"></a>01648          <span class="comment">/* book fixed event */</span>
<a name="l01649"></a>01649          event_def =
<a name="l01650"></a>01650              <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>((<span class="keywordtype">short</span> <span class="keywordtype">int</span>) analyze_request[index].ar_info.event_id);
<a name="l01651"></a>01651          <span class="keywordflow">if</span> (event_def == NULL) {
<a name="l01652"></a>01652             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ttree&quot;</span>, <span class="stringliteral">&quot;Cannot find definition of event %s in ODB&quot;</span>,
<a name="l01653"></a>01653                    analyze_request[index].event_name);
<a name="l01654"></a>01654             <span class="keywordflow">return</span> 0;
<a name="l01655"></a>01655          }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657          leaf_tags[0] = 0;
<a name="l01658"></a>01658          <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01659"></a>01659             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, i, &amp;hkey);
<a name="l01660"></a>01660             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01661"></a>01661                <span class="keywordflow">break</span>;
<a name="l01662"></a>01662 
<a name="l01663"></a>01663             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hkey, &amp;key);
<a name="l01664"></a>01664 
<a name="l01665"></a>01665             strcat(leaf_tags, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01666"></a>01666 
<a name="l01667"></a>01667             <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> &gt; 1)
<a name="l01668"></a>01668                sprintf(leaf_tags + strlen(leaf_tags), <span class="stringliteral">&quot;[%d]&quot;</span>, key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>);
<a name="l01669"></a>01669 
<a name="l01670"></a>01670             strcat(leaf_tags, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l01671"></a>01671 
<a name="l01672"></a>01672             <span class="keywordflow">if</span> (ttree_types[key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>] != NULL)
<a name="l01673"></a>01673                strcat(leaf_tags, ttree_types[key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>]);
<a name="l01674"></a>01674             <span class="keywordflow">else</span> {
<a name="l01675"></a>01675                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ttree&quot;</span>,
<a name="l01676"></a>01676                       <span class="stringliteral">&quot;Key %s in event %s is of type %s with no TTREE correspondence&quot;</span>,
<a name="l01677"></a>01677                       key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>, analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>,
<a name="l01678"></a>01678                       <a class="code" href="group__msectionh.html#ga94fb45fa1cdd442e964ebe32c7668976">rpc_tid_name</a>(key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>));
<a name="l01679"></a>01679                <span class="keywordflow">return</span> 0;
<a name="l01680"></a>01680             }
<a name="l01681"></a>01681             strcat(leaf_tags, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l01682"></a>01682          }
<a name="l01683"></a>01683 
<a name="l01684"></a>01684          leaf_tags[strlen(leaf_tags) - 1] = 0;  <span class="comment">/* delete last &apos;:&apos; */</span>
<a name="l01685"></a>01685 
<a name="l01686"></a>01686          et-&gt;branch =
<a name="l01687"></a>01687              (TBranch **) realloc(et-&gt;branch, <span class="keyword">sizeof</span>(TBranch *) * (et-&gt;n_branch + 1));
<a name="l01688"></a>01688          et-&gt;branch_name =
<a name="l01689"></a>01689              (<span class="keywordtype">char</span> *) realloc(et-&gt;branch_name, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a> * (et-&gt;n_branch + 1));
<a name="l01690"></a>01690          et-&gt;branch_filled =
<a name="l01691"></a>01691              (<span class="keywordtype">int</span> *) realloc(et-&gt;branch_filled, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (et-&gt;n_branch + 1));
<a name="l01692"></a>01692          et-&gt;branch_len =
<a name="l01693"></a>01693              (<span class="keywordtype">int</span> *) realloc(et-&gt;branch_len, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (et-&gt;n_branch + 1));
<a name="l01694"></a>01694 
<a name="l01695"></a>01695          et-&gt;branch[et-&gt;n_branch] =
<a name="l01696"></a>01696              et-&gt;tree-&gt;Branch(
<a name="l01697"></a>01697                 static_cast&lt;const char*&gt;(analyze_request[index].event_name), 0, 
<a name="l01698"></a>01698                 static_cast&lt;const char*&gt;(leaf_tags));
<a name="l01699"></a>01699          strcpy(&amp;et-&gt;branch_name[et-&gt;n_branch * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>],
<a name="l01700"></a>01700                 analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>);
<a name="l01701"></a>01701          et-&gt;n_branch++;
<a name="l01702"></a>01702       } <span class="keywordflow">else</span> {
<a name="l01703"></a>01703          <span class="comment">/* go thorough all banks in bank_list */</span>
<a name="l01704"></a>01704          <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l01705"></a>01705             <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0)
<a name="l01706"></a>01706                <span class="keywordflow">continue</span>;
<a name="l01707"></a>01707 
<a name="l01708"></a>01708             <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a> != <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l01709"></a>01709                sprintf(leaf_tags, <span class="stringliteral">&quot;n%s/I:%s[n%s]/&quot;</span>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>,
<a name="l01710"></a>01710                        bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l01711"></a>01711 
<a name="l01712"></a>01712                <span class="comment">/* define variable length array */</span>
<a name="l01713"></a>01713                <span class="keywordflow">if</span> (ttree_types[bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>] != NULL)
<a name="l01714"></a>01714                   strcat(leaf_tags, ttree_types[bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>]);
<a name="l01715"></a>01715                <span class="keywordflow">else</span> {
<a name="l01716"></a>01716                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ttree&quot;</span>,
<a name="l01717"></a>01717                          <span class="stringliteral">&quot;Bank %s is of type %s with no TTREE correspondence&quot;</span>,
<a name="l01718"></a>01718                          bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, <a class="code" href="group__msectionh.html#ga94fb45fa1cdd442e964ebe32c7668976">rpc_tid_name</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>));
<a name="l01719"></a>01719                   <span class="keywordflow">return</span> 0;
<a name="l01720"></a>01720                }
<a name="l01721"></a>01721 
<a name="l01722"></a>01722                <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>) == 0) {
<a name="l01723"></a>01723                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ttree&quot;</span>, <span class="stringliteral">&quot;Bank %s is of type with unknown size&quot;</span>,
<a name="l01724"></a>01724                          bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l01725"></a>01725                   <span class="keywordflow">return</span> 0;
<a name="l01726"></a>01726                }
<a name="l01727"></a>01727 
<a name="l01728"></a>01728                et-&gt;branch =
<a name="l01729"></a>01729                    (TBranch **) realloc(et-&gt;branch,
<a name="l01730"></a>01730                                         <span class="keyword">sizeof</span>(TBranch *) * (et-&gt;n_branch + 1));
<a name="l01731"></a>01731                et-&gt;branch_name =
<a name="l01732"></a>01732                    (<span class="keywordtype">char</span> *) realloc(et-&gt;branch_name, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a> * (et-&gt;n_branch + 1));
<a name="l01733"></a>01733                et-&gt;branch_filled =
<a name="l01734"></a>01734                    (<span class="keywordtype">int</span> *) realloc(et-&gt;branch_filled, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (et-&gt;n_branch + 1));
<a name="l01735"></a>01735                et-&gt;branch_len =
<a name="l01736"></a>01736                    (<span class="keywordtype">int</span> *) realloc(et-&gt;branch_len, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (et-&gt;n_branch + 1));
<a name="l01737"></a>01737 
<a name="l01738"></a>01738                et-&gt;branch[et-&gt;n_branch] =
<a name="l01739"></a>01739                    et-&gt;tree-&gt;Branch(static_cast&lt;const char*&gt;(bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>), 
<a name="l01740"></a>01740                                     0, static_cast&lt;const char*&gt;(leaf_tags));
<a name="l01741"></a>01741                strcpy(&amp;et-&gt;branch_name[et-&gt;n_branch * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>], bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l01742"></a>01742                et-&gt;n_branch++;
<a name="l01743"></a>01743             } <span class="keywordflow">else</span> {
<a name="l01744"></a>01744                <span class="comment">/* define structured bank */</span>
<a name="l01745"></a>01745                leaf_tags[0] = 0;
<a name="l01746"></a>01746                <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01747"></a>01747                   status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a>, i, &amp;hkey);
<a name="l01748"></a>01748                   <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01749"></a>01749                      <span class="keywordflow">break</span>;
<a name="l01750"></a>01750 
<a name="l01751"></a>01751                   <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hkey, &amp;key);
<a name="l01752"></a>01752 
<a name="l01753"></a>01753                   strcat(leaf_tags, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01754"></a>01754 
<a name="l01755"></a>01755                   <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> &gt; 1)
<a name="l01756"></a>01756                      sprintf(leaf_tags + strlen(leaf_tags), <span class="stringliteral">&quot;[%d]&quot;</span>, key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>);
<a name="l01757"></a>01757 
<a name="l01758"></a>01758                   strcat(leaf_tags, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l01759"></a>01759 
<a name="l01760"></a>01760                   <span class="keywordflow">if</span> (ttree_types[key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>] != NULL)
<a name="l01761"></a>01761                      strcat(leaf_tags, ttree_types[key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>]);
<a name="l01762"></a>01762                   <span class="keywordflow">else</span> {
<a name="l01763"></a>01763                      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ttree&quot;</span>,
<a name="l01764"></a>01764                             <span class="stringliteral">&quot;Key %s in bank %s is of type %s with no HBOOK correspondence&quot;</span>,
<a name="l01765"></a>01765                             key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, <a class="code" href="group__msectionh.html#ga94fb45fa1cdd442e964ebe32c7668976">rpc_tid_name</a>(key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>));
<a name="l01766"></a>01766                      <span class="keywordflow">return</span> 0;
<a name="l01767"></a>01767                   }
<a name="l01768"></a>01768                   strcat(leaf_tags, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l01769"></a>01769                }
<a name="l01770"></a>01770 
<a name="l01771"></a>01771                leaf_tags[strlen(leaf_tags) - 1] = 0;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773                et-&gt;branch =
<a name="l01774"></a>01774                    (TBranch **) realloc(et-&gt;branch,
<a name="l01775"></a>01775                                         <span class="keyword">sizeof</span>(TBranch *) * (et-&gt;n_branch + 1));
<a name="l01776"></a>01776                et-&gt;branch_name =
<a name="l01777"></a>01777                    (<span class="keywordtype">char</span> *) realloc(et-&gt;branch_name, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a> * (et-&gt;n_branch + 1));
<a name="l01778"></a>01778                et-&gt;branch_filled =
<a name="l01779"></a>01779                    (<span class="keywordtype">int</span> *) realloc(et-&gt;branch_filled, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (et-&gt;n_branch + 1));
<a name="l01780"></a>01780                et-&gt;branch_len =
<a name="l01781"></a>01781                    (<span class="keywordtype">int</span> *) realloc(et-&gt;branch_len, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (et-&gt;n_branch + 1));
<a name="l01782"></a>01782 
<a name="l01783"></a>01783                et-&gt;branch[et-&gt;n_branch] =
<a name="l01784"></a>01784                    et-&gt;tree-&gt;Branch(static_cast&lt;const char*&gt;(bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>), 
<a name="l01785"></a>01785                    0, static_cast&lt;const char*&gt;(leaf_tags));
<a name="l01786"></a>01786                strcpy(&amp;et-&gt;branch_name[et-&gt;n_branch * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>], bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l01787"></a>01787                et-&gt;n_branch++;
<a name="l01788"></a>01788             }
<a name="l01789"></a>01789          }
<a name="l01790"></a>01790       }
<a name="l01791"></a>01791    }
<a name="l01792"></a>01792 
<a name="l01793"></a>01793    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01794"></a>01794 }
<a name="l01795"></a>01795 
<a name="l01796"></a>01796 <span class="comment">/*-- root histogram routines ---------------------------------------*/</span>
<a name="l01797"></a>01797 
<a name="l01798"></a>01798 <span class="comment">// Save all objects from given directory into given file</span>
<a name="l01799"></a>01799 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> SaveRootHistograms(TDirectory * dir, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>)
<a name="l01800"></a>01800 {
<a name="l01801"></a>01801    TDirectory *savedir = gDirectory;
<a name="l01802"></a>01802    TFile *outf = <span class="keyword">new</span> TFile(filename, <span class="stringliteral">&quot;RECREATE&quot;</span>, <span class="stringliteral">&quot;Midas Analyzer Histograms&quot;</span>);
<a name="l01803"></a>01803    <span class="keywordflow">if</span> (outf == 0) {
<a name="l01804"></a>01804       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;SaveRootHistograms&quot;</span>, <span class="stringliteral">&quot;Cannot create output file %s&quot;</span>, filename);
<a name="l01805"></a>01805       <span class="keywordflow">return</span> 0;
<a name="l01806"></a>01806    }
<a name="l01807"></a>01807 
<a name="l01808"></a>01808    outf-&gt;cd();
<a name="l01809"></a>01809    TIter next(dir-&gt;GetList());
<a name="l01810"></a>01810    <span class="keywordflow">while</span> (TObject * obj = next())
<a name="l01811"></a>01811       obj-&gt;Write();
<a name="l01812"></a>01812 
<a name="l01813"></a>01813    outf-&gt;Close();
<a name="l01814"></a>01814    <span class="keyword">delete</span> outf;
<a name="l01815"></a>01815    <span class="comment">// restore current directory</span>
<a name="l01816"></a>01816    savedir-&gt;cd();
<a name="l01817"></a>01817    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01818"></a>01818 }
<a name="l01819"></a>01819 
<a name="l01820"></a>01820 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01821"></a>01821 
<a name="l01822"></a>01822 <span class="comment">// Load all objects from given file into given directory</span>
<a name="l01823"></a>01823 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> LoadRootHistograms(TDirectory * dir, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
<a name="l01824"></a>01824 {
<a name="l01825"></a>01825    TDirectory *savedir = gDirectory;
<a name="l01826"></a>01826    dir-&gt;cd();
<a name="l01827"></a>01827    TFile *inf = <span class="keyword">new</span> TFile(filename, <span class="stringliteral">&quot;READ&quot;</span>);
<a name="l01828"></a>01828    <span class="keywordflow">if</span> (inf == NULL)
<a name="l01829"></a>01829       printf(<span class="stringliteral">&quot;Error: File \&quot;%s\&quot; not found&quot;</span>, filename);
<a name="l01830"></a>01830    <span class="keywordflow">else</span> {
<a name="l01831"></a>01831       TIter next(inf-&gt;GetListOfKeys());
<a name="l01832"></a>01832 
<a name="l01833"></a>01833       <span class="keywordflow">while</span> (TObject * obj = next()) {
<a name="l01834"></a>01834          <span class="comment">//if (obj-&gt;InheritsFrom(&quot;TH1&quot;)) // does not work???</span>
<a name="l01835"></a>01835          {
<a name="l01836"></a>01836             dir-&gt;cd();
<a name="l01837"></a>01837             inf-&gt;Get(obj-&gt;GetName())-&gt;Clone();
<a name="l01838"></a>01838             savedir-&gt;cd();
<a name="l01839"></a>01839          }
<a name="l01840"></a>01840       }
<a name="l01841"></a>01841       inf-&gt;Close();
<a name="l01842"></a>01842       <span class="keyword">delete</span> inf;
<a name="l01843"></a>01843    }
<a name="l01844"></a>01844    <span class="comment">// restore current directory</span>
<a name="l01845"></a>01845    savedir-&gt;cd();
<a name="l01846"></a>01846    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01847"></a>01847 }
<a name="l01848"></a>01848 
<a name="l01849"></a>01849 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01850"></a>01850 
<a name="l01851"></a>01851 <span class="comment">// Clear all TH1 objects in the given directory</span>
<a name="l01852"></a>01852 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> ClearRootHistograms(TDirectory * dir)
<a name="l01853"></a>01853 {
<a name="l01854"></a>01854    TIter next(dir-&gt;GetList());
<a name="l01855"></a>01855    <span class="keywordflow">while</span> (TObject * obj = next())
<a name="l01856"></a>01856       <span class="keywordflow">if</span> (obj-&gt;InheritsFrom(<span class="stringliteral">&quot;TH1&quot;</span>))
<a name="l01857"></a>01857          ((<a class="code" href="c8051F000_8h.html#a4ae730549ffdf484b18e051fcddbe8ff">TH1</a> *) obj)-&gt;Reset();
<a name="l01858"></a>01858    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01859"></a>01859 }
<a name="l01860"></a>01860 
<a name="l01861"></a>01861 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01862"></a>01862 
<a name="l01863"></a>01863 
<a name="l01864"></a>01864 <span class="comment">// Added by Michael M 26 Mar 2011 to support a directory structure</span>
<a name="l01865"></a>01865 <span class="comment">// for ROOT histograms at mu level.</span>
<a name="l01866"></a>01866 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> WriteObjectList(TList* <a class="code" href="namespacemodules.html#a12afb64f27b8a4e356d665de83e78ad3">list</a>)
<a name="l01867"></a>01867 {
<a name="l01868"></a>01868   TIter next(list);
<a name="l01869"></a>01869   <span class="keywordflow">while</span> (TObject* obj = next()) {
<a name="l01870"></a>01870     <span class="comment">// if obj is a directory, recurse.</span>
<a name="l01871"></a>01871     <span class="keywordflow">if</span>( obj-&gt;InheritsFrom( TDirectory::Class() ) ) {
<a name="l01872"></a>01872       TDirectory* currentdir = gDirectory; <span class="comment">// save to switch back</span>
<a name="l01873"></a>01873       TDirectory* newdir = gDirectory-&gt;mkdir(((TDirectory*)obj)-&gt;GetName(),
<a name="l01874"></a>01874                                              ((TDirectory*)obj)-&gt;GetName());
<a name="l01875"></a>01875       newdir-&gt;cd();
<a name="l01876"></a>01876       WriteObjectList( ((TDirectory*)obj)-&gt;GetList() );
<a name="l01877"></a>01877       <span class="comment">//switch back to this directory, and continue writing objects</span>
<a name="l01878"></a>01878       currentdir-&gt;cd();
<a name="l01879"></a>01879       <span class="keywordflow">continue</span>; <span class="comment">// TDirectory::Write() does nothing.</span>
<a name="l01880"></a>01880     }
<a name="l01881"></a>01881     obj-&gt;Write();
<a name="l01882"></a>01882   }
<a name="l01883"></a>01883   <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01884"></a>01884 }
<a name="l01885"></a>01885 
<a name="l01886"></a>01886 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01887"></a>01887 
<a name="l01888"></a>01888 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> CloseRootOutputFile()
<a name="l01889"></a>01889 {
<a name="l01890"></a>01890    <span class="keywordtype">int</span> i;
<a name="l01891"></a>01891 
<a name="l01892"></a>01892    <span class="comment">// ensure that we do have an open file</span>
<a name="l01893"></a>01893    assert(gManaOutputFile != NULL);
<a name="l01894"></a>01894 
<a name="l01895"></a>01895    <span class="comment">// save the histograms</span>
<a name="l01896"></a>01896    <a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a>-&gt;cd();
<a name="l01897"></a>01897    <span class="comment">/* </span>
<a name="l01898"></a>01898 <span class="comment">   TIter next(gManaHistsDir-&gt;GetList());</span>
<a name="l01899"></a>01899 <span class="comment">   while (TObject * obj = next())</span>
<a name="l01900"></a>01900 <span class="comment">      obj-&gt;Write();</span>
<a name="l01901"></a>01901 <span class="comment">   */</span> <span class="comment">// MM: replaced with WriteObjectList() for directories, below.</span>
<a name="l01902"></a>01902   
<a name="l01903"></a>01903    WriteObjectList(<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a>-&gt;GetList());
<a name="l01904"></a>01904 
<a name="l01905"></a>01905    <span class="comment">// close the output file</span>
<a name="l01906"></a>01906    <a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a>-&gt;Write();
<a name="l01907"></a>01907    <a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a>-&gt;Close();
<a name="l01908"></a>01908    <span class="keyword">delete</span> <a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a>;
<a name="l01909"></a>01909    <a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a> = NULL;
<a name="l01910"></a>01910 
<a name="l01911"></a>01911    <span class="comment">// delete the output trees</span>
<a name="l01912"></a>01912    <span class="keywordflow">for</span> (i = 0; i &lt; tree_struct.n_tree; i++)
<a name="l01913"></a>01913       <span class="keywordflow">if</span> (tree_struct.event_tree[i].branch) {
<a name="l01914"></a>01914          free(tree_struct.event_tree[i].branch);
<a name="l01915"></a>01915          free(tree_struct.event_tree[i].branch_name);
<a name="l01916"></a>01916          free(tree_struct.event_tree[i].branch_filled);
<a name="l01917"></a>01917          free(tree_struct.event_tree[i].branch_len);
<a name="l01918"></a>01918          tree_struct.event_tree[i].branch = NULL;
<a name="l01919"></a>01919       }
<a name="l01920"></a>01920 
<a name="l01921"></a>01921    <span class="comment">/* delete event tree */</span>
<a name="l01922"></a>01922    free(tree_struct.event_tree);
<a name="l01923"></a>01923    tree_struct.event_tree = NULL;
<a name="l01924"></a>01924 
<a name="l01925"></a>01925    <span class="comment">// go to ROOT root directory</span>
<a name="l01926"></a>01926    <a class="code" href="odb__check_8cc.html#aa3e77a8c365861e656f07ad0fb999f49">gROOT</a>-&gt;cd();
<a name="l01927"></a>01927 
<a name="l01928"></a>01928    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l01929"></a>01929 }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l01932"></a>01932 
<a name="l01933"></a>01933 <span class="comment">/*-- analyzer init routine -----------------------------------------*/</span>
<a name="l01934"></a>01934 
<a name="l01935"></a><a class="code" href="mana_8cpp.html#a12f9d4b93e18856d7ea847512163fc3b">01935</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a12f9d4b93e18856d7ea847512163fc3b">mana_init</a>()
<a name="l01936"></a>01936 {
<a name="l01937"></a>01937    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l01938"></a>01938    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, j, status, size;
<a name="l01939"></a>01939    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l01940"></a>01940    <span class="keywordtype">char</span> str[256], block_name[32];
<a name="l01941"></a>01941    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l01942"></a>01942    <span class="keywordtype">double</span> dummy;
<a name="l01943"></a>01943 
<a name="l01944"></a>01944    sprintf(str, <span class="stringliteral">&quot;/%s/Output&quot;</span>, analyzer_name);
<a name="l01945"></a>01945    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l01946"></a>01946 
<a name="l01947"></a>01947    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online) {
<a name="l01948"></a>01948       status =
<a name="l01949"></a>01949           <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(hDB, hkey, &amp;<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>, <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL);
<a name="l01950"></a>01950       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01951"></a>01951          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bor&quot;</span>, <span class="stringliteral">&quot;Cannot read output info record&quot;</span>);
<a name="l01952"></a>01952          <span class="keywordflow">return</span> 0;
<a name="l01953"></a>01953       }
<a name="l01954"></a>01954    }
<a name="l01955"></a>01955 
<a name="l01956"></a>01956 <span class="preprocessor">#if HAVE_ROOT</span>
<a name="l01957"></a>01957 <span class="preprocessor"></span>   <span class="comment">/* MIAS Tree output file opened in src/uiuc/EventTree/TEventTreeAnalysis.cpp. */</span>
<a name="l01958"></a>01958    <a class="code" href="MTreeOutput_8cpp.html#a1eb4ae60b0d63b452d2b8c0341985730">gMiasTreeOutputFileName</a> = <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.mias_tree_output_file_name;
<a name="l01959"></a>01959    <span class="keywordflow">if</span>(<a class="code" href="MTreeOutput_8cpp.html#a1eb4ae60b0d63b452d2b8c0341985730">gMiasTreeOutputFileName</a>) {
<a name="l01960"></a>01960      printf(<span class="stringliteral">&quot;gMiasTreeOutputFileName = %s\n&quot;</span>, <a class="code" href="MTreeOutput_8cpp.html#a1eb4ae60b0d63b452d2b8c0341985730">gMiasTreeOutputFileName</a>);
<a name="l01961"></a>01961    } <span class="keywordflow">else</span> {
<a name="l01962"></a>01962      printf(<span class="stringliteral">&quot;gMiasTreeOutputFileName == NULL\n&quot;</span>);
<a name="l01963"></a>01963    }
<a name="l01964"></a>01964 <span class="preprocessor">#endif</span>
<a name="l01965"></a>01965 <span class="preprocessor"></span>
<a name="l01966"></a>01966    <span class="comment">/* create ODB structures for banks */</span>
<a name="l01967"></a>01967    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l01968"></a>01968       bank_list = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l01969"></a>01969 
<a name="l01970"></a>01970       <span class="keywordflow">if</span> (bank_list == NULL)
<a name="l01971"></a>01971          <span class="keywordflow">continue</span>;
<a name="l01972"></a>01972 
<a name="l01973"></a>01973       <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l01974"></a>01974          strncpy(block_name, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, 4);
<a name="l01975"></a>01975          block_name[4] = 0;
<a name="l01976"></a>01976 
<a name="l01977"></a>01977          <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a> == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l01978"></a>01978             sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, analyze_request[i].event_name,
<a name="l01979"></a>01979                     block_name);
<a name="l01980"></a>01980             <a class="code" href="group__msectionh.html#gaba7341fc6e27b70739734a50b489ef4f">db_check_record</a>(hDB, 0, str, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga7ebd92f00cb428fcbb555f3ad30b86c8">init_str</a>), <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01981"></a>01981             <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l01982"></a>01982             bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a> = hkey;
<a name="l01983"></a>01983          } <span class="keywordflow">else</span> {
<a name="l01984"></a>01984             sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, analyze_request[i].event_name,
<a name="l01985"></a>01985                     block_name);
<a name="l01986"></a>01986             dummy = 0;
<a name="l01987"></a>01987             <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(hDB, 0, str, &amp;dummy, <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>), 1,
<a name="l01988"></a>01988                          bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>);
<a name="l01989"></a>01989             <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l01990"></a>01990             bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a> = hkey;
<a name="l01991"></a>01991          }
<a name="l01992"></a>01992       }
<a name="l01993"></a>01993    }
<a name="l01994"></a>01994 
<a name="l01995"></a>01995    <span class="comment">/* create ODB structures for fixed events */</span>
<a name="l01996"></a>01996    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l01997"></a>01997       <span class="keywordflow">if</span> (analyze_request[i].init_string) {
<a name="l01998"></a>01998          sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables&quot;</span>, analyze_request[i].event_name);
<a name="l01999"></a>01999          <a class="code" href="group__msectionh.html#gaba7341fc6e27b70739734a50b489ef4f">db_check_record</a>(hDB, 0, str, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(analyze_request[i].init_string), <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02000"></a>02000       }
<a name="l02001"></a>02001    }
<a name="l02002"></a>02002 
<a name="l02003"></a>02003    <span class="comment">/* delete tests in ODB */</span>
<a name="l02004"></a>02004    sprintf(str, <span class="stringliteral">&quot;/%s/Tests&quot;</span>, analyzer_name);
<a name="l02005"></a>02005    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l02006"></a>02006    <span class="keywordflow">if</span> (hkey)
<a name="l02007"></a>02007       <a class="code" href="group__msectionh.html#ga91277a012e0bfddbc32885da450409e0">db_delete_key</a>(hDB, hkey, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l02008"></a>02008 
<a name="l02009"></a>02009 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l02010"></a>02010 <span class="preprocessor"></span>   <span class="comment">/* create global memory */</span>
<a name="l02011"></a>02011    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online) {
<a name="l02012"></a>02012       <span class="comment">/* book online N-tuples only once when online */</span>
<a name="l02013"></a>02013       status = <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>();
<a name="l02014"></a>02014       <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02015"></a>02015          <span class="keywordflow">return</span> status;
<a name="l02016"></a>02016    } <span class="keywordflow">else</span> {
<a name="l02017"></a>02017       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <span class="stringliteral">&quot;OFLN&quot;</span>)) {
<a name="l02018"></a>02018          <span class="comment">/* book online N-tuples only once when online */</span>
<a name="l02019"></a>02019          status = <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>();
<a name="l02020"></a>02020          <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02021"></a>02021             <span class="keywordflow">return</span> status;
<a name="l02022"></a>02022       }
<a name="l02023"></a>02023    }
<a name="l02024"></a>02024 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l02025"></a>02025 
<a name="l02026"></a>02026 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l02027"></a>02027 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online) {
<a name="l02028"></a>02028       <span class="comment">/* book online N-tuples only once when online */</span>
<a name="l02029"></a>02029       status = <a class="code" href="mana_8cpp.html#a1231b896720547aa0748ecfaa9e68d05">book_ttree</a>();
<a name="l02030"></a>02030       <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02031"></a>02031          <span class="keywordflow">return</span> status;
<a name="l02032"></a>02032    }
<a name="l02033"></a>02033 <span class="preprocessor">#endif</span>
<a name="l02034"></a>02034 <span class="preprocessor"></span>
<a name="l02035"></a>02035    <span class="comment">/* call main analyzer init routine */</span>
<a name="l02036"></a>02036    status = <a class="code" href="analyzer_8cpp.html#afeea792d4dbe0001bd025397e494ab5b">analyzer_init</a>();
<a name="l02037"></a>02037    <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02038"></a>02038       <span class="keywordflow">return</span> status;
<a name="l02039"></a>02039 
<a name="l02040"></a>02040    <span class="comment">/* initialize modules */</span>
<a name="l02041"></a>02041    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02042"></a>02042       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l02043"></a>02043       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++) {
<a name="l02044"></a>02044          <span class="comment">/* copy module enabled flag to ana_module */</span>
<a name="l02045"></a>02045          sprintf(str, <span class="stringliteral">&quot;/%s/Module switches/%s&quot;</span>, analyzer_name, module[j]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l02046"></a>02046          module[j]-&gt;<a class="code" href="group__midasincludecode.html#ga0d86abcfd4f421658176e51c24f7eb29">enabled</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02047"></a>02047          size = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l02048"></a>02048          <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, str, &amp;module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02049"></a>02049 
<a name="l02050"></a>02050          <span class="keywordflow">if</span> (module[j]-&gt;init != NULL &amp;&amp; module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>)
<a name="l02051"></a>02051             module[j]-&gt;<a class="code" href="group__midasincludecode.html#ga8ae1120805260da00f37f34ed6d519c5">init</a>();
<a name="l02052"></a>02052       }
<a name="l02053"></a>02053    }
<a name="l02054"></a>02054 
<a name="l02055"></a>02055    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l02056"></a>02056 }
<a name="l02057"></a>02057 
<a name="l02058"></a>02058 <span class="comment">/*-- exit routine --------------------------------------------------*/</span>
<a name="l02059"></a>02059 
<a name="l02060"></a><a class="code" href="mana_8cpp.html#a11a24986d9abfd2f14209cf7c8893f52">02060</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a11a24986d9abfd2f14209cf7c8893f52">mana_exit</a>()
<a name="l02061"></a>02061 {
<a name="l02062"></a>02062    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l02063"></a>02063    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, j;
<a name="l02064"></a>02064 
<a name="l02065"></a>02065    <span class="comment">/* call exit routines from modules */</span>
<a name="l02066"></a>02066    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02067"></a>02067       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l02068"></a>02068       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++)
<a name="l02069"></a>02069          <span class="keywordflow">if</span> (module[j]-&gt;exit != NULL &amp;&amp; module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>)
<a name="l02070"></a>02070             module[j]-&gt;<a class="code" href="group__midasincludecode.html#gaf3b4cc4d6a12a8eadeea80d82866b780">exit</a>();
<a name="l02071"></a>02071    }
<a name="l02072"></a>02072 
<a name="l02073"></a>02073    <span class="comment">/* call main analyzer exit routine */</span>
<a name="l02074"></a>02074    <span class="keywordflow">return</span> <a class="code" href="analyzer_8cpp.html#a7738840c25fb678186362479850b4df6">analyzer_exit</a>();
<a name="l02075"></a>02075 }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077 <span class="comment">/*-- BOR routine ---------------------------------------------------*/</span>
<a name="l02078"></a>02078 
<a name="l02079"></a><a class="code" href="mana_8cpp.html#aad9e8ec0221ce200e2bd2fd32f77833b">02079</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#aad9e8ec0221ce200e2bd2fd32f77833b">bor</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error)
<a name="l02080"></a>02080 {
<a name="l02081"></a>02081    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l02082"></a>02082    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, j, size;
<a name="l02083"></a>02083    <span class="keywordtype">char</span> str[256], <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256], *ext_str;
<a name="l02084"></a>02084    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l02085"></a>02085 
<a name="l02086"></a>02086    <span class="comment">/* load parameters */</span>
<a name="l02087"></a>02087    <a class="code" href="mana_8cpp.html#ae20b777778d5dcd241cf1dfb0dd2230f">load_parameters</a>(run_number);
<a name="l02088"></a>02088 
<a name="l02089"></a>02089    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02090"></a>02090       <span class="comment">/* copy output flag from ODB to bank_list */</span>
<a name="l02091"></a>02091       bank_list = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l02092"></a>02092 
<a name="l02093"></a>02093       <span class="keywordflow">if</span> (bank_list != NULL)
<a name="l02094"></a>02094          <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l02095"></a>02095             sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches/%s&quot;</span>, analyzer_name, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l02096"></a>02096             bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02097"></a>02097             size = <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>);
<a name="l02098"></a>02098             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, str, &amp;bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a>, &amp;size, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02099"></a>02099          }
<a name="l02100"></a>02100 
<a name="l02101"></a>02101       <span class="comment">/* copy module enabled flag to ana_module */</span>
<a name="l02102"></a>02102       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l02103"></a>02103       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++) {
<a name="l02104"></a>02104          sprintf(str, <span class="stringliteral">&quot;/%s/Module switches/%s&quot;</span>, analyzer_name, module[j]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l02105"></a>02105          module[j]-&gt;<a class="code" href="group__midasincludecode.html#ga0d86abcfd4f421658176e51c24f7eb29">enabled</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02106"></a>02106          size = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l02107"></a>02107          <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, str, &amp;module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02108"></a>02108       }
<a name="l02109"></a>02109    }
<a name="l02110"></a>02110 
<a name="l02111"></a>02111    <span class="comment">/* clear histos, N-tuples and tests */</span>
<a name="l02112"></a>02112    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online &amp;&amp; <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.clear_histos) {
<a name="l02113"></a>02113 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l02114"></a>02114 <span class="preprocessor"></span>      <span class="keywordtype">int</span> hid[10000];
<a name="l02115"></a>02115       <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>;
<a name="l02116"></a>02116 
<a name="l02117"></a>02117       <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++)
<a name="l02118"></a>02118          <span class="keywordflow">if</span> (analyze_request[i].bank_list != NULL)
<a name="l02119"></a>02119             <span class="keywordflow">if</span> (<a class="code" href="hbook_8h.html#a3efc0c35b6588eb50787985bb6440719">HEXIST</a>(analyze_request[i].ar_info.event_id))
<a name="l02120"></a>02120                <a class="code" href="hbook_8h.html#aabf9d6f4996c66f08569c299f1f48f8c">HRESET</a>(analyze_request[i].ar_info.event_id, bstr);
<a name="l02121"></a>02121 
<a name="l02122"></a>02122       <span class="comment">/* get list of all histos */</span>
<a name="l02123"></a>02123       <a class="code" href="hbook_8h.html#a9adb23be1d3ce4990eecbe93dc2c1d40">HIDALL</a>(hid, n);
<a name="l02124"></a>02124       <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l02125"></a>02125          <span class="keywordflow">for</span> (j = 0; j &lt; 10000; j++)
<a name="l02126"></a>02126             <span class="keywordflow">if</span> (lock_list[j] == 0 || lock_list[j] == hid[i])
<a name="l02127"></a>02127                <span class="keywordflow">break</span>;
<a name="l02128"></a>02128 
<a name="l02129"></a>02129          <span class="comment">/* clear histo if not locked */</span>
<a name="l02130"></a>02130          <span class="keywordflow">if</span> (lock_list[j] != hid[i])
<a name="l02131"></a>02131             <a class="code" href="hbook_8h.html#aabf9d6f4996c66f08569c299f1f48f8c">HRESET</a>(hid[i], bstr);
<a name="l02132"></a>02132       }
<a name="l02133"></a>02133 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l02134"></a>02134 
<a name="l02135"></a>02135 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l02136"></a>02136 <span class="preprocessor"></span>      <span class="comment">/* clear histos */</span>
<a name="l02137"></a>02137       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online &amp;&amp; <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.clear_histos)
<a name="l02138"></a>02138          ClearRootHistograms(<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a>);
<a name="l02139"></a>02139 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l02140"></a>02140 
<a name="l02141"></a>02141       <span class="comment">/* clear tests */</span>
<a name="l02142"></a>02142       <a class="code" href="fal_8c.html#a443aaa38b1796a39d965acb610d31cc8">test_clear</a>();
<a name="l02143"></a>02143    }
<a name="l02144"></a>02144 
<a name="l02145"></a>02145    <span class="comment">/* open output file if not already open (append mode) and in offline mode */</span>
<a name="l02146"></a>02146    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online &amp;&amp; out_file == NULL &amp;&amp; !pvm_master
<a name="l02147"></a>02147        &amp;&amp; !<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <span class="stringliteral">&quot;OFLN&quot;</span>)) {
<a name="l02148"></a>02148       <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename[0]) {
<a name="l02149"></a>02149          strcpy(str, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename);
<a name="l02150"></a>02150          <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>) != NULL)
<a name="l02151"></a>02151             sprintf(file_name, str, run_number);
<a name="l02152"></a>02152          <span class="keywordflow">else</span>
<a name="l02153"></a>02153             strcpy(file_name, str);
<a name="l02154"></a>02154 
<a name="l02155"></a>02155          <span class="comment">/* check output file extension */</span>
<a name="l02156"></a>02156          out_gzip = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02157"></a>02157          <span class="keywordflow">if</span> (strchr(file_name, <span class="charliteral">&apos;.&apos;</span>)) {
<a name="l02158"></a>02158             ext_str = file_name + strlen(file_name) - 1;
<a name="l02159"></a>02159             <span class="keywordflow">while</span> (*ext_str != <span class="charliteral">&apos;.&apos;</span>)
<a name="l02160"></a>02160                ext_str--;
<a name="l02161"></a>02161 
<a name="l02162"></a>02162             <span class="keywordflow">if</span> (strncmp(ext_str, <span class="stringliteral">&quot;.gz&quot;</span>, 3) == 0) {
<a name="l02163"></a>02163                out_gzip = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02164"></a>02164                ext_str--;
<a name="l02165"></a>02165                <span class="keywordflow">while</span> (*ext_str != <span class="charliteral">&apos;.&apos;</span> &amp;&amp; ext_str &gt; file_name)
<a name="l02166"></a>02166                   ext_str--;
<a name="l02167"></a>02167             }
<a name="l02168"></a>02168 
<a name="l02169"></a>02169             <span class="keywordflow">if</span> (strncmp(ext_str, <span class="stringliteral">&quot;.asc&quot;</span>, 4) == 0)
<a name="l02170"></a>02170                out_format = <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>;
<a name="l02171"></a>02171             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(ext_str, <span class="stringliteral">&quot;.mid&quot;</span>, 4) == 0)
<a name="l02172"></a>02172                out_format = <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>;
<a name="l02173"></a>02173             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(ext_str, <span class="stringliteral">&quot;.rz&quot;</span>, 3) == 0)
<a name="l02174"></a>02174                out_format = <a class="code" href="group__mdefineh.html#gac3a857e4820ecdaa22f9a66a560dccad">FORMAT_HBOOK</a>;
<a name="l02175"></a>02175             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(ext_str, <span class="stringliteral">&quot;.root&quot;</span>, 5) == 0)
<a name="l02176"></a>02176                out_format = <a class="code" href="group__mdefineh.html#ga9663ae12f7cbf4295b3804ebd335e408">FORMAT_ROOT</a>;
<a name="l02177"></a>02177             <span class="keywordflow">else</span> {
<a name="l02178"></a>02178                strcpy(error,
<a name="l02179"></a>02179                       <span class="stringliteral">&quot;Unknown output data format. Please use file extension .asc, .mid, .rz or .root.\n&quot;</span>);
<a name="l02180"></a>02180                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bor&quot;</span>, error);
<a name="l02181"></a>02181                <span class="keywordflow">return</span> 0;
<a name="l02182"></a>02182             }
<a name="l02183"></a>02183          } <span class="keywordflow">else</span>
<a name="l02184"></a>02184             out_format = <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>;
<a name="l02185"></a>02185 
<a name="l02186"></a>02186 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l02187"></a>02187 <span class="preprocessor"></span>         <span class="comment">/* use node name as filename if PVM slave */</span>
<a name="l02188"></a>02188          <span class="keywordflow">if</span> (pvm_slave) {
<a name="l02189"></a>02189             <span class="comment">/* extract extension */</span>
<a name="l02190"></a>02190             <span class="keywordflow">if</span> (strchr(file_name, <span class="charliteral">&apos;.&apos;</span>)) {
<a name="l02191"></a>02191                strcpy(str, strchr(file_name, <span class="charliteral">&apos;.&apos;</span>) + 1);
<a name="l02192"></a>02192                sprintf(file_name, <span class="stringliteral">&quot;n%d&quot;</span>, pvm_client_index);
<a name="l02193"></a>02193                strcat(file_name, <span class="stringliteral">&quot;.&quot;</span>);
<a name="l02194"></a>02194                strcat(file_name, str);
<a name="l02195"></a>02195             } <span class="keywordflow">else</span> {
<a name="l02196"></a>02196                sprintf(file_name, <span class="stringliteral">&quot;n%d&quot;</span>, pvm_client_index);
<a name="l02197"></a>02197             }
<a name="l02198"></a>02198 
<a name="l02199"></a>02199             PVM_DEBUG(<span class="stringliteral">&quot;BOR: file_name = %s&quot;</span>, file_name);
<a name="l02200"></a>02200          }
<a name="l02201"></a>02201 <span class="preprocessor">#endif</span>
<a name="l02202"></a>02202 <span class="preprocessor"></span>
<a name="l02203"></a>02203          <span class="comment">/* open output file */</span>
<a name="l02204"></a>02204          <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#gac3a857e4820ecdaa22f9a66a560dccad">FORMAT_HBOOK</a>) {
<a name="l02205"></a>02205 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l02206"></a>02206 <span class="preprocessor"></span>            <span class="keywordtype">int</span> status, <a class="code" href="mana_8cpp.html#a57f54b03009e95624f04afab052e6f2e">lrec</a>;
<a name="l02207"></a>02207             <span class="keywordtype">char</span> str2[80];
<a name="l02208"></a>02208 
<a name="l02209"></a>02209             lrec = <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.lrec;
<a name="l02210"></a>02210 <span class="preprocessor">#ifdef extname</span>
<a name="l02211"></a>02211 <span class="preprocessor"></span>            quest_[9] = 65000;
<a name="l02212"></a>02212 <span class="preprocessor">#else</span>
<a name="l02213"></a>02213 <span class="preprocessor"></span>            QUEST[9] = 65000;
<a name="l02214"></a>02214 <span class="preprocessor">#endif</span>
<a name="l02215"></a>02215 <span class="preprocessor"></span>
<a name="l02216"></a>02216             strcpy(str, <span class="stringliteral">&quot;BSIZE&quot;</span>);
<a name="l02217"></a>02217             <a class="code" href="hbook_8h.html#ac48bfb20cfbfc47ea35b184e6d7ca4bb">HBSET</a>(str, <a class="code" href="mana_8cpp.html#a4f4d653810d83035206144299458b3d0">HBOOK_LREC</a>, status);
<a name="l02218"></a>02218             strcpy(str, <span class="stringliteral">&quot;OFFLINE&quot;</span>);
<a name="l02219"></a>02219             strcpy(str2, <span class="stringliteral">&quot;NQP&quot;</span>);
<a name="l02220"></a>02220             <a class="code" href="hbook_8h.html#a8090e517e3eaf8ef982f3fdb986b7faa">HROPEN</a>(1, str, file_name, str2, lrec, status);
<a name="l02221"></a>02221             <span class="keywordflow">if</span> (status != 0) {
<a name="l02222"></a>02222                sprintf(error, <span class="stringliteral">&quot;Cannot open output file %s&quot;</span>, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename);
<a name="l02223"></a>02223                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bor&quot;</span>, error);
<a name="l02224"></a>02224                out_file = NULL;
<a name="l02225"></a>02225                <span class="keywordflow">return</span> 0;
<a name="l02226"></a>02226             } <span class="keywordflow">else</span>
<a name="l02227"></a>02227                out_file = (FILE *) 1;
<a name="l02228"></a>02228 <span class="preprocessor">#else</span>
<a name="l02229"></a>02229 <span class="preprocessor"></span>            <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bor&quot;</span>, <span class="stringliteral">&quot;HBOOK support is not compiled in&quot;</span>);
<a name="l02230"></a>02230 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l02231"></a>02231          }
<a name="l02232"></a>02232 
<a name="l02233"></a>02233          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#ga9663ae12f7cbf4295b3804ebd335e408">FORMAT_ROOT</a>) {
<a name="l02234"></a>02234 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l02235"></a>02235 <span class="preprocessor"></span>            <span class="comment">// ensure the output file is closed</span>
<a name="l02236"></a>02236             assert(<a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a> == NULL);
<a name="l02237"></a>02237 
<a name="l02238"></a>02238             <a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a> =
<a name="l02239"></a>02239                 <span class="keyword">new</span> TFile(file_name, <span class="stringliteral">&quot;RECREATE&quot;</span>, <span class="stringliteral">&quot;Midas Analyzer output file&quot;</span>);
<a name="l02240"></a>02240             <span class="keywordflow">if</span> (<a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a> == NULL) {
<a name="l02241"></a>02241                sprintf(error, <span class="stringliteral">&quot;Cannot open output file %s&quot;</span>, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename);
<a name="l02242"></a>02242                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bor&quot;</span>, error);
<a name="l02243"></a>02243                out_file = NULL;
<a name="l02244"></a>02244                <span class="keywordflow">return</span> 0;
<a name="l02245"></a>02245             }
<a name="l02246"></a>02246             <span class="comment">// make all ROOT objects created by user module bor() functions</span>
<a name="l02247"></a>02247             <span class="comment">// go into the output file</span>
<a name="l02248"></a>02248             <a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a>-&gt;cd();
<a name="l02249"></a>02249 
<a name="l02250"></a>02250             out_file = (FILE *) 1;
<a name="l02251"></a>02251 <span class="preprocessor">#else</span>
<a name="l02252"></a>02252 <span class="preprocessor"></span>            <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bor&quot;</span>, <span class="stringliteral">&quot;ROOT support is not compiled in&quot;</span>);
<a name="l02253"></a>02253 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l02254"></a>02254          }
<a name="l02255"></a>02255 
<a name="l02256"></a>02256          <span class="keywordflow">else</span> {
<a name="l02257"></a>02257             <span class="keywordflow">if</span> (out_gzip)
<a name="l02258"></a>02258                out_file = (FILE *) gzopen(file_name, <span class="stringliteral">&quot;wb&quot;</span>);
<a name="l02259"></a>02259             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>)
<a name="l02260"></a>02260                out_file = fopen(file_name, <span class="stringliteral">&quot;wt&quot;</span>);
<a name="l02261"></a>02261             <span class="keywordflow">else</span>
<a name="l02262"></a>02262                out_file = fopen(file_name, <span class="stringliteral">&quot;wb&quot;</span>);
<a name="l02263"></a>02263             <span class="keywordflow">if</span> (out_file == NULL) {
<a name="l02264"></a>02264                sprintf(error, <span class="stringliteral">&quot;Cannot open output file %s&quot;</span>, file_name);
<a name="l02265"></a>02265                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bor&quot;</span>, error);
<a name="l02266"></a>02266                <span class="keywordflow">return</span> 0;
<a name="l02267"></a>02267             }
<a name="l02268"></a>02268          }
<a name="l02269"></a>02269       } <span class="keywordflow">else</span>
<a name="l02270"></a>02270          out_file = NULL;
<a name="l02271"></a>02271 
<a name="l02272"></a>02272 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l02273"></a>02273 <span class="preprocessor"></span>      <span class="comment">/* book N-tuples */</span>
<a name="l02274"></a>02274       <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#gac3a857e4820ecdaa22f9a66a560dccad">FORMAT_HBOOK</a>) {
<a name="l02275"></a>02275          <span class="keywordtype">int</span> status = <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>();
<a name="l02276"></a>02276          <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02277"></a>02277             <span class="keywordflow">return</span> status;
<a name="l02278"></a>02278       }
<a name="l02279"></a>02279 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l02280"></a>02280 
<a name="l02281"></a>02281 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l02282"></a>02282 <span class="preprocessor"></span>      <span class="comment">/* book ROOT TTree */</span>
<a name="l02283"></a>02283       <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#ga9663ae12f7cbf4295b3804ebd335e408">FORMAT_ROOT</a>) {
<a name="l02284"></a>02284          <span class="keywordtype">int</span> status = <a class="code" href="mana_8cpp.html#a1231b896720547aa0748ecfaa9e68d05">book_ttree</a>();
<a name="l02285"></a>02285          <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02286"></a>02286             <span class="keywordflow">return</span> status;
<a name="l02287"></a>02287       }
<a name="l02288"></a>02288 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l02289"></a>02289 
<a name="l02290"></a>02290    }
<a name="l02291"></a>02291 
<a name="l02292"></a>02292 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l02293"></a>02293 <span class="preprocessor"></span>   <span class="comment">/* open secondary output file if applicable. */</span>
<a name="l02294"></a>02294    <span class="keywordflow">if</span> (out_format != <a class="code" href="group__mdefineh.html#ga9663ae12f7cbf4295b3804ebd335e408">FORMAT_ROOT</a> &amp;&amp; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.secondary_output_file_name[0] != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l02295"></a>02295     <span class="comment">// ensure the output file is closed</span>
<a name="l02296"></a>02296     assert(<a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a> == NULL);
<a name="l02297"></a>02297 
<a name="l02298"></a>02298     <a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a> =
<a name="l02299"></a>02299         <span class="keyword">new</span> TFile(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.secondary_output_file_name, <span class="stringliteral">&quot;RECREATE&quot;</span>, 
<a name="l02300"></a>02300                         <span class="stringliteral">&quot;Midas Analyzer output file&quot;</span>);
<a name="l02301"></a>02301     <span class="keywordflow">if</span> (<a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a> == NULL) {
<a name="l02302"></a>02302        sprintf(error, <span class="stringliteral">&quot;Cannot open secondary output file %s&quot;</span>, 
<a name="l02303"></a>02303                        <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.secondary_output_file_name);
<a name="l02304"></a>02304        <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bor&quot;</span>, error);
<a name="l02305"></a>02305        <span class="keywordflow">return</span> 0;
<a name="l02306"></a>02306     }
<a name="l02307"></a>02307     <span class="comment">// make all ROOT objects created by user module bor() functions</span>
<a name="l02308"></a>02308     <span class="comment">// go into the output file</span>
<a name="l02309"></a>02309     <a class="code" href="MDQ__Amplitude_8cpp.html#ad8864ed116c986a346b9899eced11cb1">gManaOutputFile</a>-&gt;cd();
<a name="l02310"></a>02310    }
<a name="l02311"></a>02311 
<a name="l02312"></a>02312 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l02313"></a>02313 
<a name="l02314"></a>02314    <span class="comment">/* if (out_file == NULL) */</span>
<a name="l02315"></a>02315    <span class="comment">/* save run number */</span>
<a name="l02316"></a>02316    current_run_number = run_number;
<a name="l02317"></a>02317 
<a name="l02318"></a>02318    <span class="comment">/* call bor for modules */</span>
<a name="l02319"></a>02319    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02320"></a>02320       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l02321"></a>02321       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++)
<a name="l02322"></a>02322          <span class="keywordflow">if</span> (module[j]-&gt;<a class="code" href="mana_8cpp.html#aad9e8ec0221ce200e2bd2fd32f77833b">bor</a> != NULL &amp;&amp; module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>)
<a name="l02323"></a>02323             module[j]-&gt;<a class="code" href="group__midasincludecode.html#ga288a69852e0bcf07f90f4f344c42801b">bor</a>(run_number);
<a name="l02324"></a>02324    }
<a name="l02325"></a>02325 
<a name="l02326"></a>02326    <span class="comment">/* call main analyzer BOR routine */</span>
<a name="l02327"></a>02327    <span class="keywordflow">return</span> <a class="code" href="analyzer_8cpp.html#a22c6bd312e4f7ffd79162e64835cfd42">ana_begin_of_run</a>(run_number, error);
<a name="l02328"></a>02328 }
<a name="l02329"></a>02329 
<a name="l02330"></a>02330 <span class="comment">/*-- EOR routine ---------------------------------------------------*/</span>
<a name="l02331"></a>02331 
<a name="l02332"></a><a class="code" href="mana_8cpp.html#accdfb5cb6649097a857202444fbc3aa6">02332</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#accdfb5cb6649097a857202444fbc3aa6">eor</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error)
<a name="l02333"></a>02333 {
<a name="l02334"></a>02334    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l02335"></a>02335    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l02336"></a>02336    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, j, status;
<a name="l02337"></a>02337    <span class="keywordtype">char</span> str[256], <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256];
<a name="l02338"></a>02338 
<a name="l02339"></a>02339    <span class="comment">/* call EOR routines modules */</span>
<a name="l02340"></a>02340    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02341"></a>02341       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l02342"></a>02342       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++)
<a name="l02343"></a>02343          <span class="keywordflow">if</span> (module[j]-&gt;<a class="code" href="mana_8cpp.html#accdfb5cb6649097a857202444fbc3aa6">eor</a> != NULL &amp;&amp; module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>)
<a name="l02344"></a>02344             module[j]-&gt;<a class="code" href="group__midasincludecode.html#gab6b3f976d916f185922ed4ccfe6453c6">eor</a>(run_number);
<a name="l02345"></a>02345    }
<a name="l02346"></a>02346 
<a name="l02347"></a>02347    <span class="comment">/* call main analyzer BOR routine */</span>
<a name="l02348"></a>02348    status = <a class="code" href="analyzer_8cpp.html#a8e03cbe2637bd6f4488a659c9f23d29e">ana_end_of_run</a>(run_number, error);
<a name="l02349"></a>02349 
<a name="l02350"></a>02350    <span class="comment">/* save histos if requested */</span>
<a name="l02351"></a>02351    <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.histo_dump &amp;&amp; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online) {
<a name="l02352"></a>02352       strcpy(str, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.histo_dump_filename);
<a name="l02353"></a>02353       <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>) != NULL)
<a name="l02354"></a>02354          sprintf(file_name, str, run_number);
<a name="l02355"></a>02355       <span class="keywordflow">else</span>
<a name="l02356"></a>02356          strcpy(file_name, str);
<a name="l02357"></a>02357 
<a name="l02358"></a>02358       <a class="code" href="group__msectionh.html#ga42926f9062f24eb432ffb6414cde67e8">add_data_dir</a>(str, file_name);
<a name="l02359"></a>02359 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l02360"></a>02360 <span class="preprocessor"></span>      <span class="keywordflow">for</span> (i = 0; i &lt; (int) strlen(str); i++)
<a name="l02361"></a>02361          <span class="keywordflow">if</span> (isupper(str[i]))
<a name="l02362"></a>02362             <span class="keywordflow">break</span>;
<a name="l02363"></a>02363 
<a name="l02364"></a>02364       <span class="keywordflow">if</span> (i &lt; (<span class="keywordtype">int</span>) strlen(str)) {
<a name="l02365"></a>02365          printf
<a name="l02366"></a>02366              (<span class="stringliteral">&quot;Error: Due to a limitation in HBOOK, directoy names may not contain uppercase\n&quot;</span>);
<a name="l02367"></a>02367          printf(<span class="stringliteral">&quot;       characters. Histogram saving to %s will not work.\n&quot;</span>, str);
<a name="l02368"></a>02368       } <span class="keywordflow">else</span> {
<a name="l02369"></a>02369          <span class="keywordtype">char</span> str2[256];
<a name="l02370"></a>02370          strcpy(str2, <span class="stringliteral">&quot;NT&quot;</span>);
<a name="l02371"></a>02371          <a class="code" href="hbook_8h.html#afebb35542c02eb885020475cb221afaf">HRPUT</a>(0, str, str2);
<a name="l02372"></a>02372       }
<a name="l02373"></a>02373 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l02374"></a>02374 
<a name="l02375"></a>02375 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l02376"></a>02376 <span class="preprocessor"></span>      SaveRootHistograms(<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a>, str);
<a name="l02377"></a>02377 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l02378"></a>02378    }
<a name="l02379"></a>02379 
<a name="l02380"></a>02380    <span class="comment">/* close output file */</span>
<a name="l02381"></a>02381    <span class="keywordflow">if</span> (out_file &amp;&amp; !out_append) {
<a name="l02382"></a>02382       <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#gac3a857e4820ecdaa22f9a66a560dccad">FORMAT_HBOOK</a>) {
<a name="l02383"></a>02383 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l02384"></a>02384 <span class="preprocessor"></span>         <a class="code" href="hbook_8h.html#aa909f5e02f93a1b3fadcf02ecfb1c460">HROUT</a>(0, i, bstr);
<a name="l02385"></a>02385          strcpy(str, <span class="stringliteral">&quot;OFFLINE&quot;</span>);
<a name="l02386"></a>02386          <a class="code" href="hbook_8h.html#ab87aad0525ef5d5966116b420c2bc24e">HREND</a>(str);
<a name="l02387"></a>02387 <span class="preprocessor">#else</span>
<a name="l02388"></a>02388 <span class="preprocessor"></span>         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;eor&quot;</span>, <span class="stringliteral">&quot;HBOOK support is not compiled in&quot;</span>);
<a name="l02389"></a>02389 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l02390"></a>02390       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#ga9663ae12f7cbf4295b3804ebd335e408">FORMAT_ROOT</a>) {
<a name="l02391"></a>02391 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l02392"></a>02392 <span class="preprocessor"></span>         CloseRootOutputFile();
<a name="l02393"></a>02393 <span class="preprocessor">#else</span>
<a name="l02394"></a>02394 <span class="preprocessor"></span>         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;eor&quot;</span>, <span class="stringliteral">&quot;ROOT support is not compiled in&quot;</span>);
<a name="l02395"></a>02395 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l02396"></a>02396       } <span class="keywordflow">else</span> {
<a name="l02397"></a>02397          <span class="keywordflow">if</span> (out_gzip)
<a name="l02398"></a>02398             gzclose(out_file);
<a name="l02399"></a>02399          <span class="keywordflow">else</span>
<a name="l02400"></a>02400             fclose(out_file);
<a name="l02401"></a>02401       }
<a name="l02402"></a>02402 
<a name="l02403"></a>02403       out_file = NULL;
<a name="l02404"></a>02404 
<a name="l02405"></a>02405       <span class="comment">/* free CWNT buffer */</span>
<a name="l02406"></a>02406       <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02407"></a>02407          bank_list = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l02408"></a>02408 
<a name="l02409"></a>02409          <span class="keywordflow">if</span> (bank_list == NULL) {
<a name="l02410"></a>02410             <span class="keywordflow">if</span> (analyze_request[i].<a class="code" href="lrs1821_8c.html#a83a7514b5202f841d4b7a22b2eaece9c">addr</a>) {
<a name="l02411"></a>02411                free(analyze_request[i].addr);
<a name="l02412"></a>02412                analyze_request[i].<a class="code" href="group__midasincludecode.html#ga9a0765582d554039a03d79a119c60558">addr</a> = NULL;
<a name="l02413"></a>02413             }
<a name="l02414"></a>02414          } <span class="keywordflow">else</span> {
<a name="l02415"></a>02415             <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++)
<a name="l02416"></a>02416                <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>) {
<a name="l02417"></a>02417                   free(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>);
<a name="l02418"></a>02418                   bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a> = NULL;
<a name="l02419"></a>02419                }
<a name="l02420"></a>02420          }
<a name="l02421"></a>02421       }
<a name="l02422"></a>02422    }
<a name="l02423"></a>02423 
<a name="l02424"></a>02424 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l02425"></a>02425 <span class="preprocessor"></span>   <span class="comment">/* close secondary output file */</span>
<a name="l02426"></a>02426    <span class="keywordflow">if</span>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.secondary_output_file_name[0] != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l02427"></a>02427      CloseRootOutputFile();
<a name="l02428"></a>02428    }
<a name="l02429"></a>02429 <span class="preprocessor">#endif</span>
<a name="l02430"></a>02430 <span class="preprocessor"></span>
<a name="l02431"></a>02431    <span class="keywordflow">return</span> status;
<a name="l02432"></a>02432 }
<a name="l02433"></a>02433 
<a name="l02434"></a>02434 <span class="comment">/*-- transition callbacks ------------------------------------------*/</span>
<a name="l02435"></a>02435 
<a name="l02436"></a>02436 <span class="comment">/*-- start ---------------------------------------------------------*/</span>
<a name="l02437"></a>02437 
<a name="l02438"></a><a class="code" href="mana_8cpp.html#add7f1295fb688b84e58b96a50eae8df6">02438</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a6e149fe266abfc4575be750a5ae1d3b0">tr_prestart</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l02439"></a>02439 {
<a name="l02440"></a>02440    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status, i;
<a name="l02441"></a>02441 
<a name="l02442"></a>02442    now_stopping = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02443"></a>02443 
<a name="l02444"></a>02444    <span class="comment">/* reset counters */</span>
<a name="l02445"></a>02445    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02446"></a>02446       analyze_request[i].<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>.<a class="code" href="structAR__STATS.html#ae75a481fd926f515b17a3e2b63ee283a">events_received</a> = 0;
<a name="l02447"></a>02447       analyze_request[i].<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>.<a class="code" href="group__midasincludecode.html#ga3695a89775259f076f838bf46af2e00f">events_per_sec</a> = 0;
<a name="l02448"></a>02448       analyze_request[i].<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>.<a class="code" href="group__midasincludecode.html#ga142015e81c965f9e9fba58f5a6322525">events_written</a> = 0;
<a name="l02449"></a>02449       analyze_request[i].<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a> = 0;
<a name="l02450"></a>02450       analyze_request[i].<a class="code" href="group__midasincludecode.html#gaeaa47cc2392bfdc8a1ee1a459082c876">events_written</a> = 0;
<a name="l02451"></a>02451    }
<a name="l02452"></a>02452 
<a name="l02453"></a>02453    status = <a class="code" href="mana_8cpp.html#aad9e8ec0221ce200e2bd2fd32f77833b">bor</a>(rn, error);
<a name="l02454"></a>02454    <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02455"></a>02455       <span class="keywordflow">return</span> status;
<a name="l02456"></a>02456 
<a name="l02457"></a>02457    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l02458"></a>02458 }
<a name="l02459"></a>02459 
<a name="l02460"></a>02460 <span class="comment">/*-- stop ----------------------------------------------------------*/</span>
<a name="l02461"></a>02461 
<a name="l02462"></a><a class="code" href="mana_8cpp.html#a5c030a1926f2439e78b7bd0d00221937">02462</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a29971c513f4451dd5c79373edd928ca0">tr_stop</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l02463"></a>02463 {
<a name="l02464"></a>02464    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, status, n_bytes;
<a name="l02465"></a>02465 
<a name="l02466"></a>02466    <span class="comment">/* wait until all events in buffers are analyzed */</span>
<a name="l02467"></a>02467 
<a name="l02468"></a>02468   now_stopping = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02469"></a>02469 
<a name="l02470"></a>02470   printf(<span class="stringliteral">&quot;*** Received stop request ***\n&quot;</span>);
<a name="l02471"></a>02471 
<a name="l02472"></a>02472    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l02473"></a>02473       <span class="keywordflow">while</span> (<a class="code" href="group__msectionh.html#ga545449f5acb6b13f78b1194cb92b3d63">bm_poll_event</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>));
<a name="l02474"></a>02474    <span class="keywordflow">else</span>
<a name="l02475"></a>02475       <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02476"></a>02476          <span class="keywordflow">do</span> {
<a name="l02477"></a>02477             <a class="code" href="group__msectionh.html#ga16a2c902dc41dd323e6552c940b37af9">bm_get_buffer_level</a>(analyze_request[i].buffer_handle, &amp;n_bytes);
<a name="l02478"></a>02478             <span class="keywordflow">if</span> (n_bytes &gt; 0)
<a name="l02479"></a>02479                <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(100);
<a name="l02480"></a>02480          } <span class="keywordflow">while</span> (n_bytes &gt; 0);
<a name="l02481"></a>02481       }
<a name="l02482"></a>02482 
<a name="l02483"></a>02483    <span class="comment">/* update statistics */</span>
<a name="l02484"></a>02484    <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l02485"></a>02485 
<a name="l02486"></a>02486    status = <a class="code" href="mana_8cpp.html#accdfb5cb6649097a857202444fbc3aa6">eor</a>(rn, error);
<a name="l02487"></a>02487    <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02488"></a>02488       <span class="keywordflow">return</span> status;
<a name="l02489"></a>02489 
<a name="l02490"></a>02490    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l02491"></a>02491 }
<a name="l02492"></a>02492 
<a name="l02493"></a>02493 <span class="comment">/*-- pause ---------------------------------------------------------*/</span>
<a name="l02494"></a>02494 
<a name="l02495"></a><a class="code" href="mana_8cpp.html#a7b3b6a2f570d0b31b1ad13c34536db5a">02495</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate9_2mfe__mucap_8c.html#a7b3b6a2f570d0b31b1ad13c34536db5a">tr_pause</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l02496"></a>02496 {
<a name="l02497"></a>02497    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status;
<a name="l02498"></a>02498 
<a name="l02499"></a>02499    status = <a class="code" href="analyzer_8cpp.html#a86f2bc78d542107ce023a1d54f79b13e">ana_pause_run</a>(rn, error);
<a name="l02500"></a>02500    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02501"></a>02501       <span class="keywordflow">return</span> status;
<a name="l02502"></a>02502 
<a name="l02503"></a>02503    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l02504"></a>02504 }
<a name="l02505"></a>02505 
<a name="l02506"></a>02506 <span class="comment">/*-- resume --------------------------------------------------------*/</span>
<a name="l02507"></a>02507 
<a name="l02508"></a><a class="code" href="mana_8cpp.html#ac69f1c3106f3389ed0dde43e7b86e54d">02508</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">tr_resume</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l02509"></a>02509 {
<a name="l02510"></a>02510    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status;
<a name="l02511"></a>02511 
<a name="l02512"></a>02512    status = <a class="code" href="analyzer_8cpp.html#a35f57e1efbd308b1ca049035dcdc13f6">ana_resume_run</a>(rn, error);
<a name="l02513"></a>02513    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02514"></a>02514       <span class="keywordflow">return</span> status;
<a name="l02515"></a>02515 
<a name="l02516"></a>02516    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l02517"></a>02517 }
<a name="l02518"></a>02518 
<a name="l02519"></a>02519 <span class="comment">/*---- ASCII output ------------------------------------------------*/</span>
<a name="l02520"></a>02520 
<a name="l02521"></a><a class="code" href="mana_8cpp.html#af3dac432eb411d20fb144182a22c1f4e">02521</a> <span class="preprocessor">#define STR_INC(p,base) { p+=strlen(p); \</span>
<a name="l02522"></a>02522 <span class="preprocessor">                          if (p &gt; base+sizeof(base)) \</span>
<a name="l02523"></a>02523 <span class="preprocessor">                            cm_msg(MERROR, &quot;STR_INC&quot;, &quot;ASCII buffer too small&quot;); }</span>
<a name="l02524"></a>02524 <span class="preprocessor"></span>
<a name="l02525"></a>02525 
<a name="l02526"></a><a class="code" href="mana_8cpp.html#a548ba840d1c3a1f2a18009e48513f245">02526</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a548ba840d1c3a1f2a18009e48513f245">write_event_ascii</a>(FILE * file, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> * par)
<a name="l02527"></a>02527 {
<a name="l02528"></a>02528    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status, size, i, j, <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>;
<a name="l02529"></a>02529    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> exclude;
<a name="l02530"></a>02530    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l02531"></a>02531    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *pbl;
<a name="l02532"></a>02532    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l02533"></a>02533    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l02534"></a>02534    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l02535"></a>02535    <span class="keywordtype">void</span> *pdata;
<a name="l02536"></a>02536    <span class="keywordtype">char</span> *pbuf, <a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>[5], <a class="code" href="msgdump_8c.html#ae8c4f86d88b7b85ae0f2bd5ceecfe425">type_name</a>[10];
<a name="l02537"></a>02537    <a class="code" href="structLRS1882__DATA.html">LRS1882_DATA</a> *lrs1882;
<a name="l02538"></a>02538    <a class="code" href="structLRS1877__DATA.html">LRS1877_DATA</a> *lrs1877;
<a name="l02539"></a>02539    <a class="code" href="structLRS1877__HEADER.html">LRS1877_HEADER</a> *lrs1877_header;
<a name="l02540"></a>02540    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l02541"></a>02541    <a class="code" href="structKEY.html">KEY</a> key;
<a name="l02542"></a>02542    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>[100000];
<a name="l02543"></a>02543    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bkname;
<a name="l02544"></a>02544    <a class="code" href="unionWORD.html">WORD</a> bktype;
<a name="l02545"></a>02545 
<a name="l02546"></a>02546    event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l02547"></a>02547    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l02548"></a>02548       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l02549"></a>02549 
<a name="l02550"></a>02550    <span class="comment">/* write event header */</span>
<a name="l02551"></a>02551    pbuf = buffer;
<a name="l02552"></a>02552    name[4] = 0;
<a name="l02553"></a>02553 
<a name="l02554"></a>02554    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> == <a class="code" href="group__mbufferh.html#gaea58a47233f988dd2f9a0320d99734dc">EVENTID_BOR</a>)
<a name="l02555"></a>02555       sprintf(pbuf, <span class="stringliteral">&quot;%%ID BOR NR %d\n&quot;</span>, (<span class="keywordtype">int</span>) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
<a name="l02556"></a>02556    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> == <a class="code" href="group__mbufferh.html#ga8f46d90b4c90a2387685d422625c654f">EVENTID_EOR</a>)
<a name="l02557"></a>02557       sprintf(pbuf, <span class="stringliteral">&quot;%%ID EOR NR %d\n&quot;</span>, (<span class="keywordtype">int</span>) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
<a name="l02558"></a>02558    <span class="keywordflow">else</span>
<a name="l02559"></a>02559       sprintf(pbuf, <span class="stringliteral">&quot;%%ID %d TR %d NR %d\n&quot;</span>, pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>,
<a name="l02560"></a>02560               (<span class="keywordtype">int</span>) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
<a name="l02561"></a>02561    <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l02562"></a>02562 
<a name="l02563"></a>02563   <span class="comment">/*---- MIDAS format ----------------------------------------------*/</span>
<a name="l02564"></a>02564    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l02565"></a>02565       pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l02566"></a>02566       pbk = NULL;
<a name="l02567"></a>02567       pbk32 = NULL;
<a name="l02568"></a>02568       <span class="keywordflow">do</span> {
<a name="l02569"></a>02569          <span class="comment">/* scan all banks */</span>
<a name="l02570"></a>02570          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh)) {
<a name="l02571"></a>02571             size = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l02572"></a>02572             <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l02573"></a>02573                <span class="keywordflow">break</span>;
<a name="l02574"></a>02574             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l02575"></a>02575             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l02576"></a>02576          } <span class="keywordflow">else</span> {
<a name="l02577"></a>02577             size = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l02578"></a>02578             <span class="keywordflow">if</span> (pbk == NULL)
<a name="l02579"></a>02579                <span class="keywordflow">break</span>;
<a name="l02580"></a>02580             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l02581"></a>02581             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l02582"></a>02582          }
<a name="l02583"></a>02583 
<a name="l02584"></a>02584          <span class="comment">/* look if bank is in exclude list */</span>
<a name="l02585"></a>02585          exclude = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02586"></a>02586          pbl = NULL;
<a name="l02587"></a>02587          <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a> != NULL)
<a name="l02588"></a>02588             <span class="keywordflow">for</span> (i = 0; par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; i++)
<a name="l02589"></a>02589                <span class="keywordflow">if</span> (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>) == bkname) {
<a name="l02590"></a>02590                   pbl = &amp;par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i];
<a name="l02591"></a>02591                   exclude = (pbl-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0);
<a name="l02592"></a>02592                   <span class="keywordflow">break</span>;
<a name="l02593"></a>02593                }
<a name="l02594"></a>02594 
<a name="l02595"></a>02595          <span class="keywordflow">if</span> (!exclude) {
<a name="l02596"></a>02596             <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF))
<a name="l02597"></a>02597                size /= <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF);
<a name="l02598"></a>02598 
<a name="l02599"></a>02599             lrs1882 = (<a class="code" href="structLRS1882__DATA.html">LRS1882_DATA</a> *) pdata;
<a name="l02600"></a>02600             lrs1877 = (<a class="code" href="structLRS1877__DATA.html">LRS1877_DATA</a> *) pdata;
<a name="l02601"></a>02601 
<a name="l02602"></a>02602             <span class="comment">/* write bank header */</span>
<a name="l02603"></a>02603             *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) name) = bkname;
<a name="l02604"></a>02604 
<a name="l02605"></a>02605             <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == 0)
<a name="l02606"></a>02606                strcpy(type_name, <a class="code" href="group__msectionh.html#ga94fb45fa1cdd442e964ebe32c7668976">rpc_tid_name</a>(bktype &amp; 0xFF));
<a name="l02607"></a>02607             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ae970f1c88e76ada2bcb23a140e27e37c">TID_LRS1882</a>)
<a name="l02608"></a>02608                strcpy(type_name, <span class="stringliteral">&quot;LRS1882&quot;</span>);
<a name="l02609"></a>02609             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ab4bb71b415e8b5ba35490697817c0415">TID_LRS1877</a>)
<a name="l02610"></a>02610                strcpy(type_name, <span class="stringliteral">&quot;LRS1877&quot;</span>);
<a name="l02611"></a>02611             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#a9446e243f13a3078e1237e48543021fd">TID_PCOS3</a>)
<a name="l02612"></a>02612                strcpy(type_name, <span class="stringliteral">&quot;PCOS3&quot;</span>);
<a name="l02613"></a>02613             <span class="keywordflow">else</span>
<a name="l02614"></a>02614                strcpy(type_name, <span class="stringliteral">&quot;unknown&quot;</span>);
<a name="l02615"></a>02615 
<a name="l02616"></a>02616             sprintf(pbuf, <span class="stringliteral">&quot;BK %s TP %s SZ %d\n&quot;</span>, name, type_name, size);
<a name="l02617"></a>02617             <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l02618"></a>02618 
<a name="l02619"></a>02619             <span class="keywordflow">if</span> (bktype == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l02620"></a>02620                <span class="keywordflow">if</span> (pbl == NULL)
<a name="l02621"></a>02621                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_ascii&quot;</span>, <span class="stringliteral">&quot;received unknown bank %s&quot;</span>, name);
<a name="l02622"></a>02622                <span class="keywordflow">else</span>
<a name="l02623"></a>02623                   <span class="comment">/* write structured bank */</span>
<a name="l02624"></a>02624                   <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l02625"></a>02625                      status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, pbl-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a>, i, &amp;hKey);
<a name="l02626"></a>02626                      <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l02627"></a>02627                         <span class="keywordflow">break</span>;
<a name="l02628"></a>02628 
<a name="l02629"></a>02629                      <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hKey, &amp;key);
<a name="l02630"></a>02630                      sprintf(pbuf, <span class="stringliteral">&quot;%s:\n&quot;</span>, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l02631"></a>02631                      <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l02632"></a>02632 
<a name="l02633"></a>02633                      <span class="comment">/* adjust for alignment */</span>
<a name="l02634"></a>02634                      pdata =
<a name="l02635"></a>02635                          (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata,
<a name="l02636"></a>02636                                          <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l02637"></a>02637 
<a name="l02638"></a>02638                      <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l02639"></a>02639                         <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pbuf, pdata, key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>, j, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l02640"></a>02640                         strcat(pbuf, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02641"></a>02641                         <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l02642"></a>02642                      }
<a name="l02643"></a>02643 
<a name="l02644"></a>02644                      <span class="comment">/* shift data pointer to next item */</span>
<a name="l02645"></a>02645                      pdata = (<span class="keywordtype">char</span> *) pdata + key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l02646"></a>02646                   }
<a name="l02647"></a>02647             } <span class="keywordflow">else</span> {
<a name="l02648"></a>02648                <span class="comment">/* write variable length bank  */</span>
<a name="l02649"></a>02649                <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ab4bb71b415e8b5ba35490697817c0415">TID_LRS1877</a>) {
<a name="l02650"></a>02650                   <span class="keywordflow">for</span> (i = 0; i &lt; size;) {
<a name="l02651"></a>02651                      lrs1877_header = (<a class="code" href="structLRS1877__HEADER.html">LRS1877_HEADER</a> *) &amp; lrs1877[i];
<a name="l02652"></a>02652 
<a name="l02653"></a>02653                      <span class="comment">/* print header */</span>
<a name="l02654"></a>02654                      sprintf(pbuf, <span class="stringliteral">&quot;GA %d BF %d CN %d&quot;</span>,
<a name="l02655"></a>02655                              lrs1877_header-&gt;<a class="code" href="structLRS1877__HEADER.html#a5c3514b7bef026ab66f56dd7f165a175">geo_addr</a>, lrs1877_header-&gt;<a class="code" href="structLRS1877__HEADER.html#ad874ba2882df823d261c24579bc589ed">buffer</a>,
<a name="l02656"></a>02656                              lrs1877_header-&gt;<a class="code" href="structLRS1877__HEADER.html#a8aa9a9acc7efc7ed688d99758c5af954">count</a>);
<a name="l02657"></a>02657                      strcat(pbuf, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02658"></a>02658                      <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l02659"></a>02659 
<a name="l02660"></a>02660                      count = lrs1877_header-&gt;<a class="code" href="structLRS1877__HEADER.html#a8aa9a9acc7efc7ed688d99758c5af954">count</a>;
<a name="l02661"></a>02661                      <span class="keywordflow">if</span> (count == 0)
<a name="l02662"></a>02662                         <span class="keywordflow">break</span>;
<a name="l02663"></a>02663                      <span class="keywordflow">for</span> (j = 1; j &lt; count; j++) {
<a name="l02664"></a>02664                         <span class="comment">/* print data */</span>
<a name="l02665"></a>02665                         sprintf(pbuf, <span class="stringliteral">&quot;GA %d CH %02d ED %d DA %1.1lf&quot;</span>,
<a name="l02666"></a>02666                                 lrs1877[i].geo_addr, lrs1877[i + j].<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>,
<a name="l02667"></a>02667                                 lrs1877[i + j].edge, lrs1877[i + j].<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a> * 0.5);
<a name="l02668"></a>02668                         strcat(pbuf, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02669"></a>02669                         <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l02670"></a>02670                      }
<a name="l02671"></a>02671 
<a name="l02672"></a>02672                      i += count;
<a name="l02673"></a>02673                   }
<a name="l02674"></a>02674                } <span class="keywordflow">else</span>
<a name="l02675"></a>02675                   <span class="keywordflow">for</span> (i = 0; i &lt; size; i++) {
<a name="l02676"></a>02676                      <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == 0)
<a name="l02677"></a>02677                         <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pbuf, pdata, size, i, bktype &amp; 0xFF);
<a name="l02678"></a>02678 
<a name="l02679"></a>02679                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ae970f1c88e76ada2bcb23a140e27e37c">TID_LRS1882</a>)
<a name="l02680"></a>02680                         sprintf(pbuf, <span class="stringliteral">&quot;GA %d CH %02d DA %d&quot;</span>,
<a name="l02681"></a>02681                                 lrs1882[i].geo_addr, lrs1882[i].<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>, lrs1882[i].<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>);
<a name="l02682"></a>02682 
<a name="l02683"></a>02683                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#a9446e243f13a3078e1237e48543021fd">TID_PCOS3</a>)
<a name="l02684"></a>02684                         sprintf(pbuf, <span class="stringliteral">&quot;TBD&quot;</span>);
<a name="l02685"></a>02685                      <span class="keywordflow">else</span>
<a name="l02686"></a>02686                         <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pbuf, pdata, size, i, bktype &amp; 0xFF);
<a name="l02687"></a>02687 
<a name="l02688"></a>02688                      strcat(pbuf, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02689"></a>02689                      <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l02690"></a>02690                   }
<a name="l02691"></a>02691             }
<a name="l02692"></a>02692          }
<a name="l02693"></a>02693 
<a name="l02694"></a>02694       } <span class="keywordflow">while</span> (1);
<a name="l02695"></a>02695    }
<a name="l02696"></a>02696 
<a name="l02697"></a>02697   <span class="comment">/*---- FIXED format ----------------------------------------------*/</span>
<a name="l02698"></a>02698    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
<a name="l02699"></a>02699       <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a> == 0)
<a name="l02700"></a>02700          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_ascii&quot;</span>, <span class="stringliteral">&quot;cannot find event definition&quot;</span>);
<a name="l02701"></a>02701       <span class="keywordflow">else</span> {
<a name="l02702"></a>02702          pdata = (<span class="keywordtype">char</span> *) (pevent + 1);
<a name="l02703"></a>02703          <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l02704"></a>02704             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, i, &amp;hKey);
<a name="l02705"></a>02705             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l02706"></a>02706                <span class="keywordflow">break</span>;
<a name="l02707"></a>02707 
<a name="l02708"></a>02708             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hKey, &amp;key);
<a name="l02709"></a>02709             sprintf(pbuf, <span class="stringliteral">&quot;%s\n&quot;</span>, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l02710"></a>02710             <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l02711"></a>02711 
<a name="l02712"></a>02712             <span class="comment">/* adjust for alignment */</span>
<a name="l02713"></a>02713             pdata = (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l02714"></a>02714 
<a name="l02715"></a>02715             <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l02716"></a>02716                <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pbuf, pdata, key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>, j, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l02717"></a>02717                strcat(pbuf, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02718"></a>02718                <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l02719"></a>02719             }
<a name="l02720"></a>02720 
<a name="l02721"></a>02721             <span class="comment">/* shift data pointer to next item */</span>
<a name="l02722"></a>02722             pdata = (<span class="keywordtype">char</span> *) pdata + key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l02723"></a>02723          }
<a name="l02724"></a>02724       }
<a name="l02725"></a>02725    }
<a name="l02726"></a>02726 
<a name="l02727"></a>02727    <span class="comment">/* insert empty line after each event */</span>
<a name="l02728"></a>02728    strcat(pbuf, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02729"></a>02729    size = strlen(buffer);
<a name="l02730"></a>02730 
<a name="l02731"></a>02731    <span class="comment">/* write record to device */</span>
<a name="l02732"></a>02732    <span class="keywordflow">if</span> (out_gzip)
<a name="l02733"></a>02733       status = gzwrite(file, buffer, size) == size ? <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l02734"></a>02734    <span class="keywordflow">else</span>
<a name="l02735"></a>02735       status =
<a name="l02736"></a>02736           fwrite(buffer, 1, size, file) == (size_t) size ? <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l02737"></a>02737 
<a name="l02738"></a>02738    <span class="keywordflow">return</span> status;
<a name="l02739"></a>02739 }
<a name="l02740"></a>02740 
<a name="l02741"></a>02741 <span class="comment">/*---- MIDAS output ------------------------------------------------*/</span>
<a name="l02742"></a>02742 
<a name="l02743"></a><a class="code" href="mana_8cpp.html#a75ddaf388f46748e2585fa04d22278f2">02743</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a75ddaf388f46748e2585fa04d22278f2">write_event_midas</a>(FILE * file, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> * par)
<a name="l02744"></a>02744 {
<a name="l02745"></a>02745    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status, size = 0, i;
<a name="l02746"></a>02746    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> exclude;
<a name="l02747"></a>02747    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l02748"></a>02748    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *pbl;
<a name="l02749"></a>02749    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l02750"></a>02750    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l02751"></a>02751    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l02752"></a>02752    <span class="keywordtype">char</span> *pdata, *pdata_copy;
<a name="l02753"></a>02753    <span class="keywordtype">char</span> *pbuf;
<a name="l02754"></a>02754    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent_copy;
<a name="l02755"></a>02755    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bkname, bksize;
<a name="l02756"></a>02756    <a class="code" href="unionWORD.html">WORD</a> bktype;
<a name="l02757"></a>02757    <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> = NULL;
<a name="l02758"></a>02758 
<a name="l02759"></a>02759    <span class="keywordflow">if</span> (buffer == NULL)
<a name="l02760"></a>02760       buffer = (<span class="keywordtype">char</span> *) malloc(<a class="code" href="mana_8cpp.html#a2cfad5b8da98c11be16500fc15dba5aa">EXT_EVENT_SIZE</a>);
<a name="l02761"></a>02761 
<a name="l02762"></a>02762    pevent_copy = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>((<a class="code" href="group__midasincludecode.html#ga790216a8e71233fed28657b16a052e36">PTYPE</a>) buffer);
<a name="l02763"></a>02763 
<a name="l02764"></a>02764    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.filter) {
<a name="l02765"></a>02765       <span class="comment">/* use original event */</span>
<a name="l02766"></a>02766       size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l02767"></a>02767       memcpy(pevent_copy, pevent, size);
<a name="l02768"></a>02768    } <span class="keywordflow">else</span> {
<a name="l02769"></a>02769       <span class="comment">/* copy only banks which are turned on via /analyzer/bank switches */</span>
<a name="l02770"></a>02770 
<a name="l02771"></a>02771     <span class="comment">/*---- MIDAS format ----------------------------------------------*/</span>
<a name="l02772"></a>02772 
<a name="l02773"></a>02773       event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l02774"></a>02774       <span class="keywordflow">if</span> (event_def == NULL)
<a name="l02775"></a>02775          <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l02776"></a>02776 
<a name="l02777"></a>02777       <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l02778"></a>02778          <span class="comment">/* copy event header */</span>
<a name="l02779"></a>02779          pbuf = (<span class="keywordtype">char</span> *) pevent_copy;
<a name="l02780"></a>02780          memcpy(pbuf, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l02781"></a>02781          pbuf += <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l02782"></a>02782 
<a name="l02783"></a>02783          pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l02784"></a>02784 
<a name="l02785"></a>02785          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh))
<a name="l02786"></a>02786             <a class="code" href="group__msectionh.html#ga54b6fd483a10f6b7f134e5203e53a406">bk_init32</a>(pbuf);
<a name="l02787"></a>02787          <span class="keywordflow">else</span>
<a name="l02788"></a>02788             <a class="code" href="group__msectionh.html#ga6a2d6aced3ec658234d4c6ab0ba043fb">bk_init</a>(pbuf);
<a name="l02789"></a>02789 
<a name="l02790"></a>02790          pbk = NULL;
<a name="l02791"></a>02791          pbk32 = NULL;
<a name="l02792"></a>02792          pdata_copy = pbuf;
<a name="l02793"></a>02793          <span class="keywordflow">do</span> {
<a name="l02794"></a>02794             <span class="comment">/* scan all banks */</span>
<a name="l02795"></a>02795             <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh)) {
<a name="l02796"></a>02796                size = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l02797"></a>02797                <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l02798"></a>02798                   <span class="keywordflow">break</span>;
<a name="l02799"></a>02799                bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l02800"></a>02800                bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l02801"></a>02801                bksize = pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga211ae680238a01caef15677d73d2ee9f">data_size</a>;
<a name="l02802"></a>02802             } <span class="keywordflow">else</span> {
<a name="l02803"></a>02803                size = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l02804"></a>02804                <span class="keywordflow">if</span> (pbk == NULL)
<a name="l02805"></a>02805                   <span class="keywordflow">break</span>;
<a name="l02806"></a>02806                bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l02807"></a>02807                bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l02808"></a>02808                bksize = pbk-&gt;<a class="code" href="group__midasincludecode.html#ga95afeb25db8deb1ea4cffd6ba50a6dcf">data_size</a>;
<a name="l02809"></a>02809             }
<a name="l02810"></a>02810 
<a name="l02811"></a>02811             <span class="comment">/* look if bank is in exclude list */</span>
<a name="l02812"></a>02812             exclude = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02813"></a>02813             pbl = NULL;
<a name="l02814"></a>02814             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a> != NULL)
<a name="l02815"></a>02815                <span class="keywordflow">for</span> (i = 0; par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; i++)
<a name="l02816"></a>02816                   <span class="keywordflow">if</span> (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>) == bkname) {
<a name="l02817"></a>02817                      pbl = &amp;par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i];
<a name="l02818"></a>02818                      exclude = (pbl-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0);
<a name="l02819"></a>02819                      <span class="keywordflow">break</span>;
<a name="l02820"></a>02820                   }
<a name="l02821"></a>02821 
<a name="l02822"></a>02822             <span class="keywordflow">if</span> (!exclude) {
<a name="l02823"></a>02823                <span class="comment">/* copy bank */</span>
<a name="l02824"></a>02824                <a class="code" href="group__msectionh.html#ga5d60ec9f544f56ab8170380ebe195584">bk_create</a>(pbuf, (<span class="keywordtype">char</span> *) (&amp;bkname), bktype, &amp;pdata_copy);
<a name="l02825"></a>02825                memcpy(pdata_copy, pdata, bksize);
<a name="l02826"></a>02826                pdata_copy += bksize;
<a name="l02827"></a>02827                <a class="code" href="group__msectionh.html#gab0314f08910a3950815d265d090656b7">bk_close</a>(pbuf, pdata_copy);
<a name="l02828"></a>02828             }
<a name="l02829"></a>02829 
<a name="l02830"></a>02830          } <span class="keywordflow">while</span> (1);
<a name="l02831"></a>02831 
<a name="l02832"></a>02832          <span class="comment">/* set event size in header */</span>
<a name="l02833"></a>02833          size = <a class="code" href="group__msectionh.html#ga825db64c9ef9b4656698c890fca37c05">bk_size</a>(pbuf);
<a name="l02834"></a>02834          pevent_copy-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = size;
<a name="l02835"></a>02835          size += <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l02836"></a>02836       }
<a name="l02837"></a>02837 
<a name="l02838"></a>02838     <span class="comment">/*---- FIXED format ----------------------------------------------*/</span>
<a name="l02839"></a>02839       <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
<a name="l02840"></a>02840          size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l02841"></a>02841          memcpy(pevent_copy, pevent, size);
<a name="l02842"></a>02842       }
<a name="l02843"></a>02843 
<a name="l02844"></a>02844       <span class="keywordflow">if</span> (pevent_copy-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> == 0)
<a name="l02845"></a>02845          <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l02846"></a>02846    }
<a name="l02847"></a>02847 
<a name="l02848"></a>02848    <span class="comment">/* write record to device */</span>
<a name="l02849"></a>02849    <span class="keywordflow">if</span> (out_gzip)
<a name="l02850"></a>02850       status = gzwrite(file, pevent_copy, size) == size ? <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l02851"></a>02851    <span class="keywordflow">else</span>
<a name="l02852"></a>02852       status =
<a name="l02853"></a>02853           fwrite(pevent_copy, 1, size, file) == (size_t) size ? <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l02854"></a>02854 
<a name="l02855"></a>02855    <span class="keywordflow">return</span> status;
<a name="l02856"></a>02856 }
<a name="l02857"></a>02857 
<a name="l02858"></a>02858 <span class="comment">/*---- HBOOK output ------------------------------------------------*/</span>
<a name="l02859"></a>02859 
<a name="l02860"></a>02860 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l02861"></a>02861 <span class="preprocessor"></span>
<a name="l02862"></a>02862 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a2ba1d8e79f061e622f62471ae9bc7063">write_event_hbook</a>(FILE * file, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> * par)
<a name="l02863"></a>02863 {
<a name="l02864"></a>02864    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, j, <a class="code" href="odbhist_8c.html#a43fa990200c3ddd47c35f151bd4d66bf">k</a>, <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, size, item_size, status;
<a name="l02865"></a>02865    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l02866"></a>02866    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l02867"></a>02867    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *pbl;
<a name="l02868"></a>02868    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l02869"></a>02869    <span class="keywordtype">void</span> *pdata;
<a name="l02870"></a>02870    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> exclude, exclude_all;
<a name="l02871"></a>02871    <span class="keywordtype">char</span> block_name[5], str[80];
<a name="l02872"></a>02872    <span class="keywordtype">float</span> <a class="code" href="fal_8c.html#ae9487d607449dedf95bca2636c33b5d3">rwnt</a>[512];
<a name="l02873"></a>02873    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l02874"></a>02874    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l02875"></a>02875    <a class="code" href="structKEY.html">KEY</a> key;
<a name="l02876"></a>02876    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bkname;
<a name="l02877"></a>02877    <a class="code" href="unionWORD.html">WORD</a> bktype;
<a name="l02878"></a>02878 
<a name="l02879"></a>02879    <span class="comment">/* return if N-tuples are disabled */</span>
<a name="l02880"></a>02880    <span class="keywordflow">if</span> (!ntuple_flag)
<a name="l02881"></a>02881       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l02882"></a>02882 
<a name="l02883"></a>02883    event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l02884"></a>02884    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l02885"></a>02885       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l02886"></a>02886 
<a name="l02887"></a>02887    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a66d1640adf533d3d29e015244e0c4fd2">disabled</a>)
<a name="l02888"></a>02888       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l02889"></a>02889 
<a name="l02890"></a>02890    <span class="comment">/* fill number info */</span>
<a name="l02891"></a>02891    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt) {
<a name="l02892"></a>02892       memset(rwnt, 0, <span class="keyword">sizeof</span>(rwnt));
<a name="l02893"></a>02893       rwnt[0] = (float) current_run_number;
<a name="l02894"></a>02894       rwnt[1] = (float) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>;
<a name="l02895"></a>02895       rwnt[2] = (<span class="keywordtype">float</span>) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>;
<a name="l02896"></a>02896    } <span class="keywordflow">else</span> {
<a name="l02897"></a>02897       par-&gt;<a class="code" href="group__midasincludecode.html#ga7cac02c3834cd0d1574db723568348a6">number</a>.<a class="code" href="structANALYZE__REQUEST.html#a8ab25f33bbb1a45800975dd5d87b0caf">run</a> = current_run_number;
<a name="l02898"></a>02898       par-&gt;<a class="code" href="group__midasincludecode.html#ga7cac02c3834cd0d1574db723568348a6">number</a>.<a class="code" href="group__midasincludecode.html#ga8eb5dfa05ce631ead9382cdafc82c8df">serial</a> = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>;
<a name="l02899"></a>02899       par-&gt;<a class="code" href="group__midasincludecode.html#ga7cac02c3834cd0d1574db723568348a6">number</a>.<a class="code" href="group__midasincludecode.html#ga66d92551c9b1ce76463d4d5da7facafb">time</a> = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>;
<a name="l02900"></a>02900    }
<a name="l02901"></a>02901 
<a name="l02902"></a>02902   <span class="comment">/*---- MIDAS format ----------------------------------------------*/</span>
<a name="l02903"></a>02903 
<a name="l02904"></a>02904    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l02905"></a>02905       <span class="comment">/* first fill number block */</span>
<a name="l02906"></a>02906       strcpy(str, <span class="stringliteral">&quot;Number&quot;</span>);
<a name="l02907"></a>02907       <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt)
<a name="l02908"></a>02908          <a class="code" href="hbook_8h.html#a73abd4724ed2f01879bed8a3e7e5f726">HFNTB</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, str);
<a name="l02909"></a>02909 
<a name="l02910"></a>02910       pbk = NULL;
<a name="l02911"></a>02911       pbk32 = NULL;
<a name="l02912"></a>02912       exclude_all = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02913"></a>02913       <span class="keywordflow">do</span> {
<a name="l02914"></a>02914          pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l02915"></a>02915          <span class="comment">/* scan all banks */</span>
<a name="l02916"></a>02916          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh)) {
<a name="l02917"></a>02917             size = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l02918"></a>02918             <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l02919"></a>02919                <span class="keywordflow">break</span>;
<a name="l02920"></a>02920             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l02921"></a>02921             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l02922"></a>02922          } <span class="keywordflow">else</span> {
<a name="l02923"></a>02923             size = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l02924"></a>02924             <span class="keywordflow">if</span> (pbk == NULL)
<a name="l02925"></a>02925                <span class="keywordflow">break</span>;
<a name="l02926"></a>02926             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l02927"></a>02927             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l02928"></a>02928          }
<a name="l02929"></a>02929 
<a name="l02930"></a>02930          <span class="comment">/* look if bank is in exclude list */</span>
<a name="l02931"></a>02931          *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) block_name) = bkname;
<a name="l02932"></a>02932          block_name[4] = 0;
<a name="l02933"></a>02933 
<a name="l02934"></a>02934          exclude = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02935"></a>02935          pbl = NULL;
<a name="l02936"></a>02936          <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a> != NULL) {
<a name="l02937"></a>02937             <span class="keywordflow">for</span> (i = 0; par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; i++)
<a name="l02938"></a>02938                <span class="keywordflow">if</span> (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>) == bkname) {
<a name="l02939"></a>02939                   pbl = &amp;par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i];
<a name="l02940"></a>02940                   exclude = (pbl-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0);
<a name="l02941"></a>02941                   <span class="keywordflow">break</span>;
<a name="l02942"></a>02942                }
<a name="l02943"></a>02943             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0] == 0)
<a name="l02944"></a>02944                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>, <span class="stringliteral">&quot;Received unknown bank %s&quot;</span>,
<a name="l02945"></a>02945                       block_name);
<a name="l02946"></a>02946          }
<a name="l02947"></a>02947 
<a name="l02948"></a>02948          <span class="comment">/* fill CW N-tuple */</span>
<a name="l02949"></a>02949          <span class="keywordflow">if</span> (!exclude &amp;&amp; pbl != NULL &amp;&amp; !<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt) {
<a name="l02950"></a>02950             <span class="comment">/* set array size in bank list */</span>
<a name="l02951"></a>02951             <span class="keywordflow">if</span> ((bktype &amp; 0xFF) != <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l02952"></a>02952                item_size = <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF);
<a name="l02953"></a>02953                <span class="keywordflow">if</span> (item_size == 0) {
<a name="l02954"></a>02954                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>,
<a name="l02955"></a>02955                          <span class="stringliteral">&quot;Received bank %s with unknown item size&quot;</span>, block_name);
<a name="l02956"></a>02956                   <span class="keywordflow">continue</span>;
<a name="l02957"></a>02957                }
<a name="l02958"></a>02958 
<a name="l02959"></a>02959                pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> = size / item_size;
<a name="l02960"></a>02960 
<a name="l02961"></a>02961                <span class="comment">/* check bank size */</span>
<a name="l02962"></a>02962                <span class="keywordflow">if</span> (pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> &gt; pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>) {
<a name="l02963"></a>02963                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>,
<a name="l02964"></a>02964                          <span class="stringliteral">&quot;Bank %s has more (%d) entries than maximum value (%d)&quot;</span>,
<a name="l02965"></a>02965                          block_name, pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a>, pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>);
<a name="l02966"></a>02966                   <span class="keywordflow">continue</span>;
<a name="l02967"></a>02967                }
<a name="l02968"></a>02968 
<a name="l02969"></a>02969                <span class="comment">/* copy bank to buffer in bank list, DWORD aligned */</span>
<a name="l02970"></a>02970                <span class="keywordflow">if</span> (item_size &gt;= 4) {
<a name="l02971"></a>02971                   size = <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a> * item_size, size);
<a name="l02972"></a>02972                   memcpy(pbl-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>, pdata, size);
<a name="l02973"></a>02973                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (item_size == 2)
<a name="l02974"></a>02974                   <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a>; i++)
<a name="l02975"></a>02975                      *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a> + i) = (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) * ((<a class="code" href="unionWORD.html">WORD</a> *) pdata + i);
<a name="l02976"></a>02976                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (item_size == 1)
<a name="l02977"></a>02977                   <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a>; i++)
<a name="l02978"></a>02978                      *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a> + i) = (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) * ((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) pdata + i);
<a name="l02979"></a>02979             } <span class="keywordflow">else</span> {
<a name="l02980"></a>02980                <span class="comment">/* hope that structure members are aligned as HBOOK thinks ... */</span>
<a name="l02981"></a>02981                memcpy(pbl-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>, pdata, size);
<a name="l02982"></a>02982             }
<a name="l02983"></a>02983 
<a name="l02984"></a>02984             <span class="comment">/* fill N-tuple */</span>
<a name="l02985"></a>02985             <a class="code" href="hbook_8h.html#a73abd4724ed2f01879bed8a3e7e5f726">HFNTB</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, block_name);
<a name="l02986"></a>02986          }
<a name="l02987"></a>02987 
<a name="l02988"></a>02988          <span class="comment">/* fill RW N-tuple */</span>
<a name="l02989"></a>02989          <span class="keywordflow">if</span> (!exclude &amp;&amp; pbl != NULL &amp;&amp; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt) {
<a name="l02990"></a>02990             exclude_all = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02991"></a>02991 
<a name="l02992"></a>02992             item_size = <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF);
<a name="l02993"></a>02993             <span class="comment">/* set array size in bank list */</span>
<a name="l02994"></a>02994             <span class="keywordflow">if</span> ((bktype &amp; 0xFF) != <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l02995"></a>02995                n = size / item_size;
<a name="l02996"></a>02996 
<a name="l02997"></a>02997                <span class="comment">/* check bank size */</span>
<a name="l02998"></a>02998                <span class="keywordflow">if</span> (n &gt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>) {
<a name="l02999"></a>02999                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>,
<a name="l03000"></a>03000                          <span class="stringliteral">&quot;Bank %s has more (%d) entries than maximum value (%d)&quot;</span>,
<a name="l03001"></a>03001                          block_name, n, pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>);
<a name="l03002"></a>03002                   <span class="keywordflow">continue</span>;
<a name="l03003"></a>03003                }
<a name="l03004"></a>03004 
<a name="l03005"></a>03005                <span class="comment">/* convert bank to float values */</span>
<a name="l03006"></a>03006                <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l03007"></a>03007                   <span class="keywordflow">switch</span> (bktype &amp; 0xFF) {
<a name="l03008"></a>03008                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga7499d3aa0ca98d255f5147494ab4f572">TID_BYTE</a>:
<a name="l03009"></a>03009                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) pdata + i));
<a name="l03010"></a>03010                      <span class="keywordflow">break</span>;
<a name="l03011"></a>03011                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>:
<a name="l03012"></a>03012                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<a class="code" href="unionWORD.html">WORD</a> *) pdata + i));
<a name="l03013"></a>03013                      <span class="keywordflow">break</span>;
<a name="l03014"></a>03014                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>:
<a name="l03015"></a>03015                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pdata + i));
<a name="l03016"></a>03016                      <span class="keywordflow">break</span>;
<a name="l03017"></a>03017                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gae932ec1b283f6c4b9c30a6d489beea7f">TID_FLOAT</a>:
<a name="l03018"></a>03018                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<span class="keywordtype">float</span> *) pdata + i));
<a name="l03019"></a>03019                      <span class="keywordflow">break</span>;
<a name="l03020"></a>03020                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>:
<a name="l03021"></a>03021                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<span class="keywordtype">double</span> *) pdata + i));
<a name="l03022"></a>03022                      <span class="keywordflow">break</span>;
<a name="l03023"></a>03023                   }
<a name="l03024"></a>03024                }
<a name="l03025"></a>03025 
<a name="l03026"></a>03026                <span class="comment">/* zero padding */</span>
<a name="l03027"></a>03027                <span class="keywordflow">for</span> (; i &lt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>; i++)
<a name="l03028"></a>03028                   rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = 0.f;
<a name="l03029"></a>03029             } <span class="keywordflow">else</span> {
<a name="l03030"></a>03030                <span class="comment">/* fill N-tuple from structured bank */</span>
<a name="l03031"></a>03031                k = pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a>;
<a name="l03032"></a>03032 
<a name="l03033"></a>03033                <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l03034"></a>03034                   status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, pbl-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a>, i, &amp;hkey);
<a name="l03035"></a>03035                   <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l03036"></a>03036                      <span class="keywordflow">break</span>;
<a name="l03037"></a>03037 
<a name="l03038"></a>03038                   <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hkey, &amp;key);
<a name="l03039"></a>03039 
<a name="l03040"></a>03040                   <span class="comment">/* align data pointer */</span>
<a name="l03041"></a>03041                   pdata =
<a name="l03042"></a>03042                       (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l03043"></a>03043 
<a name="l03044"></a>03044                   <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l03045"></a>03045                      <span class="keywordflow">switch</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> &amp; 0xFF) {
<a name="l03046"></a>03046                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga7499d3aa0ca98d255f5147494ab4f572">TID_BYTE</a>:
<a name="l03047"></a>03047                         rwnt[k++] = (float) (*((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) pdata + j));
<a name="l03048"></a>03048                         <span class="keywordflow">break</span>;
<a name="l03049"></a>03049                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>:
<a name="l03050"></a>03050                         rwnt[k++] = (float) (*((<a class="code" href="unionWORD.html">WORD</a> *) pdata + j));
<a name="l03051"></a>03051                         <span class="keywordflow">break</span>;
<a name="l03052"></a>03052                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga4281dafac4285eae3e3c9be0a1d93c5a">TID_SHORT</a>:
<a name="l03053"></a>03053                         rwnt[k++] = (float) (*((<span class="keywordtype">short</span> <span class="keywordtype">int</span> *) pdata + j));
<a name="l03054"></a>03054                         <span class="keywordflow">break</span>;
<a name="l03055"></a>03055                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>:
<a name="l03056"></a>03056                         rwnt[k++] = (float) (*((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) pdata + j));
<a name="l03057"></a>03057                         <span class="keywordflow">break</span>;
<a name="l03058"></a>03058                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>:
<a name="l03059"></a>03059                         rwnt[k++] = (float) (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pdata + j));
<a name="l03060"></a>03060                         <span class="keywordflow">break</span>;
<a name="l03061"></a>03061                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>:
<a name="l03062"></a>03062                         rwnt[k++] = (float) (*((<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> *) pdata + j));
<a name="l03063"></a>03063                         <span class="keywordflow">break</span>;
<a name="l03064"></a>03064                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gae932ec1b283f6c4b9c30a6d489beea7f">TID_FLOAT</a>:
<a name="l03065"></a>03065                         rwnt[k++] = (float) (*((<span class="keywordtype">float</span> *) pdata + j));
<a name="l03066"></a>03066                         <span class="keywordflow">break</span>;
<a name="l03067"></a>03067                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>:
<a name="l03068"></a>03068                         rwnt[k++] = (float) (*((<span class="keywordtype">double</span> *) pdata + j));
<a name="l03069"></a>03069                         <span class="keywordflow">break</span>;
<a name="l03070"></a>03070                      }
<a name="l03071"></a>03071                   }
<a name="l03072"></a>03072 
<a name="l03073"></a>03073                   <span class="comment">/* shift data pointer to next item */</span>
<a name="l03074"></a>03074                   (<span class="keywordtype">char</span> *) pdata += key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l03075"></a>03075                }
<a name="l03076"></a>03076             }
<a name="l03077"></a>03077          }
<a name="l03078"></a>03078 
<a name="l03079"></a>03079       } <span class="keywordflow">while</span> (<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03080"></a>03080 
<a name="l03081"></a>03081       <span class="comment">/* fill RW N-tuple */</span>
<a name="l03082"></a>03082       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt &amp;&amp; file != NULL &amp;&amp; !exclude_all)
<a name="l03083"></a>03083          <a class="code" href="hbook_8h.html#a1343e9a00908e216e2fea192c3c162c8">HFN</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, rwnt);
<a name="l03084"></a>03084 
<a name="l03085"></a>03085       <span class="comment">/* fill shared memory */</span>
<a name="l03086"></a>03086       <span class="keywordflow">if</span> (file == NULL)
<a name="l03087"></a>03087          <a class="code" href="fal_8c.html#a9284066018f8d23f887b0f407b9a1442">HFNOV</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, rwnt);
<a name="l03088"></a>03088 
<a name="l03089"></a>03089    }
<a name="l03090"></a>03090 
<a name="l03091"></a>03091 
<a name="l03092"></a>03092    <span class="comment">/* if (event_def-&gt;format == FORMAT_MIDAS) */</span>
<a name="l03093"></a>03093  <span class="comment">/*---- YBOS format ----------------------------------------------*/</span>
<a name="l03094"></a>03094    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>) {
<a name="l03095"></a>03095       <a class="code" href="structYBOS__BANK__HEADER.html">YBOS_BANK_HEADER</a> *pybk;
<a name="l03096"></a>03096 
<a name="l03097"></a>03097       <span class="comment">/* first fill number block */</span>
<a name="l03098"></a>03098       strcpy(str, <span class="stringliteral">&quot;Number&quot;</span>);
<a name="l03099"></a>03099       <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt)
<a name="l03100"></a>03100          <a class="code" href="hbook_8h.html#a73abd4724ed2f01879bed8a3e7e5f726">HFNTB</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, str);
<a name="l03101"></a>03101 
<a name="l03102"></a>03102       pbk = NULL;
<a name="l03103"></a>03103       exclude_all = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03104"></a>03104       <span class="keywordflow">do</span> {
<a name="l03105"></a>03105          <span class="comment">/* scan all banks */</span>
<a name="l03106"></a>03106          size = <a class="code" href="group__ybosincludecode.html#ga1460247a5eeb130851ec244920996d07">ybk_iterate</a>((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) (pevent + 1), &amp;pybk, &amp;pdata);
<a name="l03107"></a>03107          <span class="keywordflow">if</span> (pybk == NULL)
<a name="l03108"></a>03108             <span class="keywordflow">break</span>;
<a name="l03109"></a>03109 
<a name="l03110"></a>03110          <span class="comment">/* in bytes */</span>
<a name="l03111"></a>03111          size &lt;&lt;= 2;
<a name="l03112"></a>03112 
<a name="l03113"></a>03113          <span class="comment">/* look if bank is in exclude list */</span>
<a name="l03114"></a>03114          *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) block_name) = pybk-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#a48b75f0b13d19047668335154985c01d">name</a>;
<a name="l03115"></a>03115          block_name[4] = 0;
<a name="l03116"></a>03116 
<a name="l03117"></a>03117          exclude = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03118"></a>03118          pbl = NULL;
<a name="l03119"></a>03119          <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a> != NULL) {
<a name="l03120"></a>03120             <span class="keywordflow">for</span> (i = 0; par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; i++)
<a name="l03121"></a>03121                <span class="keywordflow">if</span> (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>) == pybk-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#a48b75f0b13d19047668335154985c01d">name</a>) {
<a name="l03122"></a>03122                   pbl = &amp;par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i];
<a name="l03123"></a>03123                   exclude = (pbl-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0);
<a name="l03124"></a>03124                   <span class="keywordflow">break</span>;
<a name="l03125"></a>03125                }
<a name="l03126"></a>03126             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0] == 0)
<a name="l03127"></a>03127                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>, <span class="stringliteral">&quot;Received unknown bank %s&quot;</span>,
<a name="l03128"></a>03128                       block_name);
<a name="l03129"></a>03129          }
<a name="l03130"></a>03130 
<a name="l03131"></a>03131          <span class="comment">/* fill CW N-tuple */</span>
<a name="l03132"></a>03132          <span class="keywordflow">if</span> (!exclude &amp;&amp; pbl != NULL &amp;&amp; !<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt) {
<a name="l03133"></a>03133             <span class="comment">/* set array size in bank list */</span>
<a name="l03134"></a>03134             <span class="keywordflow">if</span> ((pybk-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> &amp; 0xFF) &lt; <a class="code" href="group__ybosdefineh.html#gac0c471f6b5b30dcb4d014445b9ff4a3d">MAX_BKTYPE</a>) {
<a name="l03135"></a>03135                item_size = <a class="code" href="group__ybosincludecode.html#ga369f3e070e2ebe42fdf13a60242b6593">ybos_get_tid_size</a>(pybk-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> &amp; 0xFF);
<a name="l03136"></a>03136                <span class="keywordflow">if</span> (item_size == 0) {
<a name="l03137"></a>03137                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>,
<a name="l03138"></a>03138                          <span class="stringliteral">&quot;Received bank %s with unknown item size&quot;</span>, block_name);
<a name="l03139"></a>03139                   <span class="keywordflow">continue</span>;
<a name="l03140"></a>03140                }
<a name="l03141"></a>03141 
<a name="l03142"></a>03142                pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> = size / item_size;
<a name="l03143"></a>03143 
<a name="l03144"></a>03144                <span class="comment">/* check bank size */</span>
<a name="l03145"></a>03145                <span class="keywordflow">if</span> (pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> &gt; pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>) {
<a name="l03146"></a>03146                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>,
<a name="l03147"></a>03147                          <span class="stringliteral">&quot;Bank %s has more (%d) entries than maximum value (%d)&quot;</span>,
<a name="l03148"></a>03148                          block_name, pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a>, pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>);
<a name="l03149"></a>03149                   <span class="keywordflow">continue</span>;
<a name="l03150"></a>03150                }
<a name="l03151"></a>03151 
<a name="l03152"></a>03152                <span class="comment">/* copy bank to buffer in bank list, DWORD aligned */</span>
<a name="l03153"></a>03153                <span class="keywordflow">if</span> (item_size &gt;= 4) {
<a name="l03154"></a>03154                   size = <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a> * item_size, size);
<a name="l03155"></a>03155                   memcpy(pbl-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>, pdata, size);
<a name="l03156"></a>03156                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (item_size == 2)
<a name="l03157"></a>03157                   <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a>; i++)
<a name="l03158"></a>03158                      *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a> + i) = (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) * ((<a class="code" href="unionWORD.html">WORD</a> *) pdata + i);
<a name="l03159"></a>03159                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (item_size == 1)
<a name="l03160"></a>03160                   <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a>; i++)
<a name="l03161"></a>03161                      *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a> + i) = (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) * ((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) pdata + i);
<a name="l03162"></a>03162             } <span class="keywordflow">else</span> {
<a name="l03163"></a>03163                <span class="comment">/* hope that structure members are aligned as HBOOK thinks ... */</span>
<a name="l03164"></a>03164                memcpy(pbl-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>, pdata, size);
<a name="l03165"></a>03165             }
<a name="l03166"></a>03166 
<a name="l03167"></a>03167             <span class="comment">/* fill N-tuple */</span>
<a name="l03168"></a>03168             <a class="code" href="hbook_8h.html#a73abd4724ed2f01879bed8a3e7e5f726">HFNTB</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, block_name);
<a name="l03169"></a>03169          }
<a name="l03170"></a>03170 
<a name="l03171"></a>03171          <span class="comment">/* fill RW N-tuple */</span>
<a name="l03172"></a>03172          <span class="keywordflow">if</span> (!exclude &amp;&amp; pbl != NULL &amp;&amp; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt) {
<a name="l03173"></a>03173             exclude_all = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03174"></a>03174 
<a name="l03175"></a>03175             item_size = <a class="code" href="group__ybosincludecode.html#ga369f3e070e2ebe42fdf13a60242b6593">ybos_get_tid_size</a>(pybk-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> &amp; 0xFF);
<a name="l03176"></a>03176             <span class="comment">/* set array size in bank list */</span>
<a name="l03177"></a>03177             <span class="keywordflow">if</span> ((pybk-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> &amp; 0xFF) &lt; <a class="code" href="group__ybosdefineh.html#gac0c471f6b5b30dcb4d014445b9ff4a3d">MAX_BKTYPE</a>) {
<a name="l03178"></a>03178                n = size / item_size;
<a name="l03179"></a>03179 
<a name="l03180"></a>03180                <span class="comment">/* check bank size */</span>
<a name="l03181"></a>03181                <span class="keywordflow">if</span> (n &gt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>) {
<a name="l03182"></a>03182                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>,
<a name="l03183"></a>03183                          <span class="stringliteral">&quot;Bank %s has more (%d) entries than maximum value (%d)&quot;</span>,
<a name="l03184"></a>03184                          block_name, n, pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>);
<a name="l03185"></a>03185                   <span class="keywordflow">continue</span>;
<a name="l03186"></a>03186                }
<a name="l03187"></a>03187 
<a name="l03188"></a>03188                <span class="comment">/* convert bank to float values */</span>
<a name="l03189"></a>03189                <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l03190"></a>03190                   <span class="keywordflow">switch</span> (pybk-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> &amp; 0xFF) {
<a name="l03191"></a>03191                   <span class="keywordflow">case</span> <a class="code" href="group__ybosdefineh.html#ga37b2a5de4003dff9ef6837b6f99a0a69">I1_BKTYPE</a>:
<a name="l03192"></a>03192                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) pdata + i));
<a name="l03193"></a>03193                      <span class="keywordflow">break</span>;
<a name="l03194"></a>03194                   <span class="keywordflow">case</span> <a class="code" href="group__ybosdefineh.html#ga4b6b5459b4c74b76ee12197538fe6d1d">I2_BKTYPE</a>:
<a name="l03195"></a>03195                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<a class="code" href="unionWORD.html">WORD</a> *) pdata + i));
<a name="l03196"></a>03196                      <span class="keywordflow">break</span>;
<a name="l03197"></a>03197                   <span class="keywordflow">case</span> <a class="code" href="group__ybosdefineh.html#gac78b656213d4a1fb1fd9bf9bd8c46f09">I4_BKTYPE</a>:
<a name="l03198"></a>03198                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pdata + i));
<a name="l03199"></a>03199                      <span class="keywordflow">break</span>;
<a name="l03200"></a>03200                   <span class="keywordflow">case</span> <a class="code" href="group__ybosdefineh.html#ga07c32fd205319ee4bd3b6adde65058d6">F4_BKTYPE</a>:
<a name="l03201"></a>03201                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<span class="keywordtype">float</span> *) pdata + i));
<a name="l03202"></a>03202                      <span class="keywordflow">break</span>;
<a name="l03203"></a>03203                   <span class="keywordflow">case</span> <a class="code" href="group__ybosdefineh.html#gaba3ee4247e6ef5302ba5a83079a338e0">D8_BKTYPE</a>:
<a name="l03204"></a>03204                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<span class="keywordtype">double</span> *) pdata + i));
<a name="l03205"></a>03205                      <span class="keywordflow">break</span>;
<a name="l03206"></a>03206                   }
<a name="l03207"></a>03207                }
<a name="l03208"></a>03208 
<a name="l03209"></a>03209                <span class="comment">/* zero padding */</span>
<a name="l03210"></a>03210                <span class="keywordflow">for</span> (; i &lt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>; i++)
<a name="l03211"></a>03211                   rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = 0.f;
<a name="l03212"></a>03212             } <span class="keywordflow">else</span> {
<a name="l03213"></a>03213                printf(<span class="stringliteral">&quot;YBOS is not supporting STRUCTURE banks \n&quot;</span>);
<a name="l03214"></a>03214             }
<a name="l03215"></a>03215          }
<a name="l03216"></a>03216 
<a name="l03217"></a>03217       } <span class="keywordflow">while</span> (<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03218"></a>03218 
<a name="l03219"></a>03219       <span class="comment">/* fill RW N-tuple */</span>
<a name="l03220"></a>03220       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt &amp;&amp; file != NULL &amp;&amp; !exclude_all)
<a name="l03221"></a>03221          <a class="code" href="hbook_8h.html#a1343e9a00908e216e2fea192c3c162c8">HFN</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, rwnt);
<a name="l03222"></a>03222 
<a name="l03223"></a>03223       <span class="comment">/* fill shared memory */</span>
<a name="l03224"></a>03224       <span class="keywordflow">if</span> (file == NULL)
<a name="l03225"></a>03225          <a class="code" href="fal_8c.html#a9284066018f8d23f887b0f407b9a1442">HFNOV</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, rwnt);
<a name="l03226"></a>03226 
<a name="l03227"></a>03227    }
<a name="l03228"></a>03228 
<a name="l03229"></a>03229 
<a name="l03230"></a>03230    <span class="comment">/* if (event_def-&gt;format == FORMAT_YBOS) */</span>
<a name="l03231"></a>03231  <span class="comment">/*---- FIXED format ----------------------------------------------*/</span>
<a name="l03232"></a>03232    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
<a name="l03233"></a>03233       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt) {
<a name="l03234"></a>03234          <span class="comment">/* fill N-tuple from structured bank */</span>
<a name="l03235"></a>03235          pdata = pevent + 1;
<a name="l03236"></a>03236          k = 3;                 <span class="comment">/* index 0..2 for run/serial/time */</span>
<a name="l03237"></a>03237 
<a name="l03238"></a>03238          <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l03239"></a>03239             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, i, &amp;hkey);
<a name="l03240"></a>03240             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l03241"></a>03241                <span class="keywordflow">break</span>;
<a name="l03242"></a>03242 
<a name="l03243"></a>03243             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hkey, &amp;key);
<a name="l03244"></a>03244 
<a name="l03245"></a>03245             <span class="comment">/* align data pointer */</span>
<a name="l03246"></a>03246             pdata = (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l03247"></a>03247 
<a name="l03248"></a>03248             <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l03249"></a>03249                <span class="keywordflow">switch</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> &amp; 0xFF) {
<a name="l03250"></a>03250                <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga7499d3aa0ca98d255f5147494ab4f572">TID_BYTE</a>:
<a name="l03251"></a>03251                   rwnt[k++] = (float) (*((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) pdata + j));
<a name="l03252"></a>03252                   <span class="keywordflow">break</span>;
<a name="l03253"></a>03253                <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>:
<a name="l03254"></a>03254                   rwnt[k++] = (float) (*((<a class="code" href="unionWORD.html">WORD</a> *) pdata + j));
<a name="l03255"></a>03255                   <span class="keywordflow">break</span>;
<a name="l03256"></a>03256                <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga4281dafac4285eae3e3c9be0a1d93c5a">TID_SHORT</a>:
<a name="l03257"></a>03257                   rwnt[k++] = (float) (*((<span class="keywordtype">short</span> <span class="keywordtype">int</span> *) pdata + j));
<a name="l03258"></a>03258                   <span class="keywordflow">break</span>;
<a name="l03259"></a>03259                <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>:
<a name="l03260"></a>03260                   rwnt[k++] = (float) (*((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) pdata + j));
<a name="l03261"></a>03261                   <span class="keywordflow">break</span>;
<a name="l03262"></a>03262                <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>:
<a name="l03263"></a>03263                   rwnt[k++] = (float) (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pdata + j));
<a name="l03264"></a>03264                   <span class="keywordflow">break</span>;
<a name="l03265"></a>03265                <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>:
<a name="l03266"></a>03266                   rwnt[k++] = (float) (*((<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> *) pdata + j));
<a name="l03267"></a>03267                   <span class="keywordflow">break</span>;
<a name="l03268"></a>03268                <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gae932ec1b283f6c4b9c30a6d489beea7f">TID_FLOAT</a>:
<a name="l03269"></a>03269                   rwnt[k++] = (float) (*((<span class="keywordtype">float</span> *) pdata + j));
<a name="l03270"></a>03270                   <span class="keywordflow">break</span>;
<a name="l03271"></a>03271                <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>:
<a name="l03272"></a>03272                   rwnt[k++] = (float) (*((<span class="keywordtype">double</span> *) pdata + j));
<a name="l03273"></a>03273                   <span class="keywordflow">break</span>;
<a name="l03274"></a>03274                }
<a name="l03275"></a>03275             }
<a name="l03276"></a>03276 
<a name="l03277"></a>03277             <span class="comment">/* shift data pointer to next item */</span>
<a name="l03278"></a>03278             (<span class="keywordtype">char</span> *) pdata += key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l03279"></a>03279          }
<a name="l03280"></a>03280 
<a name="l03281"></a>03281          <span class="comment">/* fill RW N-tuple */</span>
<a name="l03282"></a>03282          <span class="keywordflow">if</span> (file != NULL)
<a name="l03283"></a>03283             <a class="code" href="hbook_8h.html#a1343e9a00908e216e2fea192c3c162c8">HFN</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, rwnt);
<a name="l03284"></a>03284 
<a name="l03285"></a>03285          <span class="comment">/* fill shared memory */</span>
<a name="l03286"></a>03286          <span class="keywordflow">if</span> (file == NULL)
<a name="l03287"></a>03287             <a class="code" href="fal_8c.html#a9284066018f8d23f887b0f407b9a1442">HFNOV</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, rwnt);
<a name="l03288"></a>03288       } <span class="keywordflow">else</span> {
<a name="l03289"></a>03289          memcpy(par-&gt;<a class="code" href="group__midasincludecode.html#ga9a0765582d554039a03d79a119c60558">addr</a>, pevent + 1, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l03290"></a>03290 
<a name="l03291"></a>03291          <span class="comment">/* fill N-tuple */</span>
<a name="l03292"></a>03292          <a class="code" href="hbook_8h.html#a06fd59698517753dcd96879e922c6eb4">HFNT</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l03293"></a>03293       }
<a name="l03294"></a>03294 
<a name="l03295"></a>03295    }
<a name="l03296"></a>03296 
<a name="l03297"></a>03297    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03298"></a>03298 }
<a name="l03299"></a>03299 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l03300"></a>03300 
<a name="l03301"></a>03301 <span class="comment">/*---- ROOT output -------------------------------------------------*/</span>
<a name="l03302"></a>03302 
<a name="l03303"></a>03303 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l03304"></a>03304 <span class="preprocessor"></span>
<a name="l03305"></a>03305 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> write_event_ttree(FILE * file, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> * par)
<a name="l03306"></a>03306 {
<a name="l03307"></a>03307    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, bklen;
<a name="l03308"></a>03308    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l03309"></a>03309    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l03310"></a>03310    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *pbl;
<a name="l03311"></a>03311    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l03312"></a>03312    <span class="keywordtype">void</span> *pdata;
<a name="l03313"></a>03313    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> exclude, exclude_all;
<a name="l03314"></a>03314    <span class="keywordtype">char</span> <a class="code" href="mdump_8c.html#a29615e4ecb94c1a935bc21365ea50f61">bank_name</a>[5];
<a name="l03315"></a>03315    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l03316"></a>03316    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bkname;
<a name="l03317"></a>03317    <a class="code" href="unionWORD.html">WORD</a> bktype;
<a name="l03318"></a>03318    EVENT_TREE *et;
<a name="l03319"></a>03319    TBranch *<a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>;
<a name="l03320"></a>03320 
<a name="l03321"></a>03321    <span class="comment">/* return if N-tuples are disabled */</span>
<a name="l03322"></a>03322    <span class="keywordflow">if</span> (!ntuple_flag)
<a name="l03323"></a>03323       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l03324"></a>03324 
<a name="l03325"></a>03325    event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l03326"></a>03326    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l03327"></a>03327       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l03328"></a>03328 
<a name="l03329"></a>03329    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a66d1640adf533d3d29e015244e0c4fd2">disabled</a>)
<a name="l03330"></a>03330       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l03331"></a>03331 
<a name="l03332"></a>03332    <span class="comment">/* fill number info */</span>
<a name="l03333"></a>03333    par-&gt;<a class="code" href="group__midasincludecode.html#ga7cac02c3834cd0d1574db723568348a6">number</a>.<a class="code" href="structANALYZE__REQUEST.html#a8ab25f33bbb1a45800975dd5d87b0caf">run</a> = current_run_number;
<a name="l03334"></a>03334    par-&gt;<a class="code" href="group__midasincludecode.html#ga7cac02c3834cd0d1574db723568348a6">number</a>.<a class="code" href="group__midasincludecode.html#ga8eb5dfa05ce631ead9382cdafc82c8df">serial</a> = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>;
<a name="l03335"></a>03335    par-&gt;<a class="code" href="group__midasincludecode.html#ga7cac02c3834cd0d1574db723568348a6">number</a>.<a class="code" href="group__midasincludecode.html#ga66d92551c9b1ce76463d4d5da7facafb">time</a> = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>;
<a name="l03336"></a>03336 
<a name="l03337"></a>03337   <span class="comment">/*---- MIDAS format ----------------------------------------------*/</span>
<a name="l03338"></a>03338 
<a name="l03339"></a>03339    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l03340"></a>03340       <span class="comment">/* find event in tree structure */</span>
<a name="l03341"></a>03341       <span class="keywordflow">for</span> (i = 0; i &lt; tree_struct.n_tree; i++)
<a name="l03342"></a>03342          <span class="keywordflow">if</span> (tree_struct.event_tree[i].event_id == pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>)
<a name="l03343"></a>03343             <span class="keywordflow">break</span>;
<a name="l03344"></a>03344 
<a name="l03345"></a>03345       <span class="keywordflow">if</span> (i == tree_struct.n_tree) {
<a name="l03346"></a>03346          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_ttree&quot;</span>, <span class="stringliteral">&quot;Event #%d not booked by book_ttree()&quot;</span>,
<a name="l03347"></a>03347                 pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l03348"></a>03348          <span class="keywordflow">return</span> <a class="code" href="group__err24.html#gaa473d6d45ff06e93dcab855be5170ab1">SS_INVALID_FORMAT</a>;
<a name="l03349"></a>03349       }
<a name="l03350"></a>03350 
<a name="l03351"></a>03351       et = tree_struct.event_tree + i;
<a name="l03352"></a>03352 
<a name="l03353"></a>03353       <span class="comment">/* first mark all banks non-filled */</span>
<a name="l03354"></a>03354       <span class="keywordflow">for</span> (i = 0; i &lt; et-&gt;n_branch; i++)
<a name="l03355"></a>03355          et-&gt;branch_filled[i] = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03356"></a>03356 
<a name="l03357"></a>03357       <span class="comment">/* first fill number block */</span>
<a name="l03358"></a>03358       et-&gt;branch_filled[0] = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03359"></a>03359 
<a name="l03360"></a>03360       pbk = NULL;
<a name="l03361"></a>03361       pbk32 = NULL;
<a name="l03362"></a>03362       exclude_all = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03363"></a>03363       <span class="keywordflow">do</span> {
<a name="l03364"></a>03364          pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l03365"></a>03365          <span class="comment">/* scan all banks */</span>
<a name="l03366"></a>03366          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh)) {
<a name="l03367"></a>03367             bklen = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l03368"></a>03368             <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l03369"></a>03369                <span class="keywordflow">break</span>;
<a name="l03370"></a>03370             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l03371"></a>03371             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l03372"></a>03372          } <span class="keywordflow">else</span> {
<a name="l03373"></a>03373             bklen = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l03374"></a>03374             <span class="keywordflow">if</span> (pbk == NULL)
<a name="l03375"></a>03375                <span class="keywordflow">break</span>;
<a name="l03376"></a>03376             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l03377"></a>03377             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l03378"></a>03378          }
<a name="l03379"></a>03379 
<a name="l03380"></a>03380          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF))
<a name="l03381"></a>03381             bklen /= <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF);
<a name="l03382"></a>03382 
<a name="l03383"></a>03383          <span class="comment">/* look if bank is in exclude list */</span>
<a name="l03384"></a>03384          *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) bank_name) = bkname;
<a name="l03385"></a>03385          bank_name[4] = 0;
<a name="l03386"></a>03386 
<a name="l03387"></a>03387          exclude = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03388"></a>03388          pbl = NULL;
<a name="l03389"></a>03389          <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a> != NULL) {
<a name="l03390"></a>03390             <span class="keywordflow">for</span> (i = 0; par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; i++)
<a name="l03391"></a>03391                <span class="keywordflow">if</span> (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>) == bkname) {
<a name="l03392"></a>03392                   pbl = &amp;par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i];
<a name="l03393"></a>03393                   exclude = (pbl-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0);
<a name="l03394"></a>03394                   <span class="keywordflow">break</span>;
<a name="l03395"></a>03395                }
<a name="l03396"></a>03396             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0] == 0) {
<a name="l03397"></a>03397                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_ttree&quot;</span>, <span class="stringliteral">&quot;Received unknown bank %s&quot;</span>, bank_name);
<a name="l03398"></a>03398                <span class="keywordflow">continue</span>;
<a name="l03399"></a>03399             }
<a name="l03400"></a>03400          }
<a name="l03401"></a>03401 
<a name="l03402"></a>03402          <span class="comment">/* fill leaf */</span>
<a name="l03403"></a>03403          <span class="keywordflow">if</span> (!exclude &amp;&amp; pbl != NULL) {
<a name="l03404"></a>03404             <span class="keywordflow">for</span> (i = 0; i &lt; et-&gt;n_branch; i++)
<a name="l03405"></a>03405                <span class="keywordflow">if</span> (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) (&amp;et-&gt;branch_name[i * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>])) == bkname)
<a name="l03406"></a>03406                   <span class="keywordflow">break</span>;
<a name="l03407"></a>03407 
<a name="l03408"></a>03408             <span class="keywordflow">if</span> (i == et-&gt;n_branch) {
<a name="l03409"></a>03409                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_ttree&quot;</span>, <span class="stringliteral">&quot;Received unknown bank %s&quot;</span>, bank_name);
<a name="l03410"></a>03410                <span class="keywordflow">continue</span>;
<a name="l03411"></a>03411             }
<a name="l03412"></a>03412 
<a name="l03413"></a>03413             exclude_all = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03414"></a>03414             branch = et-&gt;branch[i];
<a name="l03415"></a>03415             et-&gt;branch_filled[i] = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03416"></a>03416             et-&gt;branch_len[i] = bklen;
<a name="l03417"></a>03417 
<a name="l03418"></a>03418             <span class="comment">/* structured bank */</span>
<a name="l03419"></a>03419             <span class="keywordflow">if</span> ((bktype &amp; 0xFF) != <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l03420"></a>03420                TIter next(branch-&gt;GetListOfLeaves());
<a name="l03421"></a>03421                TLeaf *leaf = (TLeaf *) next();
<a name="l03422"></a>03422 
<a name="l03423"></a>03423                <span class="comment">/* varibale length array */</span>
<a name="l03424"></a>03424                leaf-&gt;SetAddress(&amp;et-&gt;branch_len[i]);
<a name="l03425"></a>03425 
<a name="l03426"></a>03426                leaf = (TLeaf *) next();
<a name="l03427"></a>03427                leaf-&gt;SetAddress(pdata);
<a name="l03428"></a>03428             } <span class="keywordflow">else</span> {
<a name="l03429"></a>03429                <span class="comment">/* hope that structure members are aligned as TTREE thinks ... */</span>
<a name="l03430"></a>03430                branch-&gt;SetAddress(pdata);
<a name="l03431"></a>03431             }
<a name="l03432"></a>03432          }
<a name="l03433"></a>03433 
<a name="l03434"></a>03434       } <span class="keywordflow">while</span> (<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03435"></a>03435 
<a name="l03436"></a>03436       <span class="comment">/* check if all branches have been filled */</span>
<a name="l03437"></a>03437       <span class="keywordflow">for</span> (i = 0; i &lt; et-&gt;n_branch; i++)
<a name="l03438"></a>03438          <span class="keywordflow">if</span> (!et-&gt;branch_filled[i])
<a name="l03439"></a>03439             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;root_write&quot;</span>,
<a name="l03440"></a>03440                    <span class="stringliteral">&quot;Bank %s booked but not received, tree cannot be filled&quot;</span>,
<a name="l03441"></a>03441                    et-&gt;branch_name + (i * NAME_LENGTH));
<a name="l03442"></a>03442 
<a name="l03443"></a>03443       <span class="comment">/* fill tree */</span>
<a name="l03444"></a>03444       <span class="keywordflow">if</span> (file != NULL &amp;&amp; !exclude_all)
<a name="l03445"></a>03445          et-&gt;tree-&gt;Fill();
<a name="l03446"></a>03446 
<a name="l03447"></a>03447 
<a name="l03448"></a>03448    }
<a name="l03449"></a>03449 
<a name="l03450"></a>03450 
<a name="l03451"></a>03451 
<a name="l03452"></a>03452    <span class="comment">/* if (event_def-&gt;format == FORMAT_MIDAS) */</span>
<a name="l03453"></a>03453  <span class="comment">/*---- FIXED format ----------------------------------------------*/</span>
<a name="l03454"></a>03454    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
<a name="l03455"></a>03455       <span class="comment">/* find event in tree structure */</span>
<a name="l03456"></a>03456       <span class="keywordflow">for</span> (i = 0; i &lt; tree_struct.n_tree; i++)
<a name="l03457"></a>03457          <span class="keywordflow">if</span> (tree_struct.event_tree[i].event_id == pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>)
<a name="l03458"></a>03458             <span class="keywordflow">break</span>;
<a name="l03459"></a>03459 
<a name="l03460"></a>03460       <span class="keywordflow">if</span> (i == tree_struct.n_tree) {
<a name="l03461"></a>03461          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_ttree&quot;</span>, <span class="stringliteral">&quot;Event #%d not booked by book_ttree()&quot;</span>,
<a name="l03462"></a>03462                 pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l03463"></a>03463          <span class="keywordflow">return</span> <a class="code" href="group__err24.html#gaa473d6d45ff06e93dcab855be5170ab1">SS_INVALID_FORMAT</a>;
<a name="l03464"></a>03464       }
<a name="l03465"></a>03465 
<a name="l03466"></a>03466       et = tree_struct.event_tree + i;
<a name="l03467"></a>03467 
<a name="l03468"></a>03468       et-&gt;tree-&gt;GetBranch(et-&gt;branch_name)-&gt;SetAddress(pevent + 1);
<a name="l03469"></a>03469       et-&gt;tree-&gt;Fill();
<a name="l03470"></a>03470    }
<a name="l03471"></a>03471 
<a name="l03472"></a>03472    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03473"></a>03473 }
<a name="l03474"></a>03474 
<a name="l03475"></a>03475 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l03476"></a>03476 
<a name="l03477"></a>03477 <span class="comment">/*---- ODB output --------------------------------------------------*/</span>
<a name="l03478"></a>03478 
<a name="l03479"></a><a class="code" href="mana_8cpp.html#a0b211773db8022bff4c277dc8bd8e90f">03479</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#ab55e3bbd032e2ede908194386fdd0dc3">write_event_odb</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent)
<a name="l03480"></a>03480 {
<a name="l03481"></a>03481    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status, size, n_data, i;
<a name="l03482"></a>03482    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l03483"></a>03483    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l03484"></a>03484    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l03485"></a>03485    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l03486"></a>03486    <span class="keywordtype">void</span> *pdata;
<a name="l03487"></a>03487    <span class="keywordtype">char</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>[5];
<a name="l03488"></a>03488    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hKeyRoot, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l03489"></a>03489    <a class="code" href="structKEY.html">KEY</a> key;
<a name="l03490"></a>03490    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bkname;
<a name="l03491"></a>03491    <a class="code" href="unionWORD.html">WORD</a> bktype;
<a name="l03492"></a>03492 
<a name="l03493"></a>03493    event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l03494"></a>03494    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l03495"></a>03495       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l03496"></a>03496 
<a name="l03497"></a>03497   <span class="comment">/*---- MIDAS format ----------------------------------------------*/</span>
<a name="l03498"></a>03498    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l03499"></a>03499       pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l03500"></a>03500       pbk = NULL;
<a name="l03501"></a>03501       pbk32 = NULL;
<a name="l03502"></a>03502       <span class="keywordflow">do</span> {
<a name="l03503"></a>03503          <span class="comment">/* scan all banks */</span>
<a name="l03504"></a>03504          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh)) {
<a name="l03505"></a>03505             size = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l03506"></a>03506             <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l03507"></a>03507                <span class="keywordflow">break</span>;
<a name="l03508"></a>03508             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l03509"></a>03509             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l03510"></a>03510          } <span class="keywordflow">else</span> {
<a name="l03511"></a>03511             size = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l03512"></a>03512             <span class="keywordflow">if</span> (pbk == NULL)
<a name="l03513"></a>03513                <span class="keywordflow">break</span>;
<a name="l03514"></a>03514             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l03515"></a>03515             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l03516"></a>03516          }
<a name="l03517"></a>03517 
<a name="l03518"></a>03518          n_data = size;
<a name="l03519"></a>03519          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF))
<a name="l03520"></a>03520             n_data /= <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF);
<a name="l03521"></a>03521 
<a name="l03522"></a>03522          <span class="comment">/* get bank key */</span>
<a name="l03523"></a>03523          *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) name) = bkname;
<a name="l03524"></a>03524          name[4] = 0;
<a name="l03525"></a>03525 
<a name="l03526"></a>03526          status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, name, &amp;hKeyRoot);
<a name="l03527"></a>03527          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03528"></a>03528             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_odb&quot;</span>, <span class="stringliteral">&quot;received unknown bank %s&quot;</span>, name);
<a name="l03529"></a>03529             <span class="keywordflow">continue</span>;
<a name="l03530"></a>03530          }
<a name="l03531"></a>03531 
<a name="l03532"></a>03532          <span class="keywordflow">if</span> (bktype == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l03533"></a>03533             <span class="comment">/* write structured bank */</span>
<a name="l03534"></a>03534             <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l03535"></a>03535                status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, hKeyRoot, i, &amp;hKey);
<a name="l03536"></a>03536                <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l03537"></a>03537                   <span class="keywordflow">break</span>;
<a name="l03538"></a>03538 
<a name="l03539"></a>03539                <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hKey, &amp;key);
<a name="l03540"></a>03540 
<a name="l03541"></a>03541                <span class="comment">/* adjust for alignment */</span>
<a name="l03542"></a>03542                <span class="keywordflow">if</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> != <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a> &amp;&amp; key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> != <a class="code" href="group__mdefineh.html#gaa63f41f547c7f46f828aaf35073807ea">TID_LINK</a>)
<a name="l03543"></a>03543                   pdata =
<a name="l03544"></a>03544                       (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l03545"></a>03545 
<a name="l03546"></a>03546                status = <a class="code" href="group__msectionh.html#ga6b98aa5ac9036c49023c0cc9353922d4">db_set_data</a>(hDB, hKey, pdata, key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>,
<a name="l03547"></a>03547                                     key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l03548"></a>03548                <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03549"></a>03549                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_odb&quot;</span>, <span class="stringliteral">&quot;cannot write %s to ODB&quot;</span>, name);
<a name="l03550"></a>03550                   <span class="keywordflow">continue</span>;
<a name="l03551"></a>03551                }
<a name="l03552"></a>03552 
<a name="l03553"></a>03553                <span class="comment">/* shift data pointer to next item */</span>
<a name="l03554"></a>03554                pdata = (<span class="keywordtype">char</span> *) pdata + key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l03555"></a>03555             }
<a name="l03556"></a>03556          } <span class="keywordflow">else</span> {
<a name="l03557"></a>03557             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hKeyRoot, &amp;key);
<a name="l03558"></a>03558 
<a name="l03559"></a>03559             <span class="comment">/* write variable length bank  */</span>
<a name="l03560"></a>03560             <span class="keywordflow">if</span> (n_data &gt; 0) {
<a name="l03561"></a>03561                status = <a class="code" href="group__msectionh.html#ga6b98aa5ac9036c49023c0cc9353922d4">db_set_data</a>(hDB, hKeyRoot, pdata, size, n_data, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l03562"></a>03562                <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03563"></a>03563                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_odb&quot;</span>, <span class="stringliteral">&quot;cannot write %s to ODB&quot;</span>, name);
<a name="l03564"></a>03564                   <span class="keywordflow">continue</span>;
<a name="l03565"></a>03565                }
<a name="l03566"></a>03566             }
<a name="l03567"></a>03567          }
<a name="l03568"></a>03568       } <span class="keywordflow">while</span> (1);
<a name="l03569"></a>03569    }
<a name="l03570"></a>03570 
<a name="l03571"></a>03571   <span class="comment">/*---- FIXED format ----------------------------------------------*/</span>
<a name="l03572"></a>03572    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a> &amp;&amp; !<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online) {
<a name="l03573"></a>03573       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(hDB, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, (<span class="keywordtype">char</span> *) (pevent + 1),
<a name="l03574"></a>03574                         pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>, 0) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l03575"></a>03575          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_odb&quot;</span>, <span class="stringliteral">&quot;event #%d size mismatch&quot;</span>, pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l03576"></a>03576    }
<a name="l03577"></a>03577 
<a name="l03578"></a>03578    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03579"></a>03579 }
<a name="l03580"></a>03580 
<a name="l03581"></a>03581 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03582"></a>03582 
<a name="l03583"></a>03583 <span class="keyword">struct </span>{
<a name="l03584"></a><a class="code" href="mana_8cpp.html#aff774cc3164dec02768f4104c5466c61">03584</a>    <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l03585"></a><a class="code" href="mana_8cpp.html#a5fecce64b1b883ada4ac0bc410fb3304">03585</a>    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mevb_8cpp.html#a5fecce64b1b883ada4ac0bc410fb3304">last_time</a>;
<a name="l03586"></a>03586 } <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[50];
<a name="l03587"></a>03587 
<a name="l03588"></a><a class="code" href="mana_8cpp.html#a3eb68b44171b0cd2d0c55c51a10188a4">03588</a> <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> *<a class="code" href="mana_8cpp.html#a3eb68b44171b0cd2d0c55c51a10188a4">_current_par</a>;
<a name="l03589"></a>03589 
<a name="l03590"></a><a class="code" href="mana_8cpp.html#aaaa4a125e1a58b328027f929bc2ec7db">03590</a> <span class="keywordtype">void</span> <a class="code" href="mana_8cpp.html#aaaa4a125e1a58b328027f929bc2ec7db">correct_num_events</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i)
<a name="l03591"></a>03591 {
<a name="l03592"></a>03592    <span class="keywordflow">if</span> (_current_par)
<a name="l03593"></a>03593       _current_par-&gt;<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a> += i - 1;
<a name="l03594"></a>03594 }
<a name="l03595"></a>03595 
<a name="l03596"></a><a class="code" href="mana_8cpp.html#adc93a18c662e7f5f7447c311e8ed7cac">03596</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(<a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> * par, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent)
<a name="l03597"></a>03597 {
<a name="l03598"></a>03598    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, status = <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>, ch;
<a name="l03599"></a>03599    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l03600"></a>03600    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l03601"></a>03601    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l03602"></a>03602    <span class="keyword">static</span> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> last_time_kb = 0;
<a name="l03603"></a>03603    <span class="keyword">static</span> <span class="keywordtype">char</span> *orig_event = NULL;
<a name="l03604"></a>03604 
<a name="l03605"></a>03605    <span class="comment">/* verbose output */</span>
<a name="l03606"></a>03606    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.verbose)
<a name="l03607"></a>03607       printf(<span class="stringliteral">&quot;event %d, number %d, total size %d\n&quot;</span>,
<a name="l03608"></a>03608              (<span class="keywordtype">int</span>) pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>,
<a name="l03609"></a>03609              (<span class="keywordtype">int</span>) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>,
<a name="l03610"></a>03610              (<span class="keywordtype">int</span>) (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)));
<a name="l03611"></a>03611 
<a name="l03612"></a>03612    <span class="comment">/* save analyze_request for event number correction */</span>
<a name="l03613"></a>03613    _current_par = par;
<a name="l03614"></a>03614 
<a name="l03615"></a>03615    <span class="comment">/* check keyboard once every second */</span>
<a name="l03616"></a>03616    actual_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l03617"></a>03617    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online &amp;&amp; actual_time - last_time_kb &gt; 1000 &amp;&amp; !<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet &amp;&amp; !pvm_slave) {
<a name="l03618"></a>03618       last_time_kb = actual_time;
<a name="l03619"></a>03619 
<a name="l03620"></a>03620       <span class="keywordflow">while</span> (<a class="code" href="group__msectionh.html#gae96b0ebe47aa1d54f800e4f2e7f564b9">ss_kbhit</a>()) {
<a name="l03621"></a>03621          ch = <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(0);
<a name="l03622"></a>03622          <span class="keywordflow">if</span> (ch == -1)
<a name="l03623"></a>03623             ch = getchar();
<a name="l03624"></a>03624 
<a name="l03625"></a>03625          <span class="keywordflow">if</span> ((<span class="keywordtype">char</span>) ch == <span class="charliteral">&apos;!&apos;</span>)
<a name="l03626"></a>03626             <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l03627"></a>03627       }
<a name="l03628"></a>03628    }
<a name="l03629"></a>03629 
<a name="l03630"></a>03630    <span class="keywordflow">if</span> (par == NULL) {
<a name="l03631"></a>03631       <span class="comment">/* load ODB with BOR event */</span>
<a name="l03632"></a>03632       <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> == <a class="code" href="group__mbufferh.html#gaea58a47233f988dd2f9a0320d99734dc">EVENTID_BOR</a>) {
<a name="l03633"></a>03633          <span class="comment">/* get run number from BOR event */</span>
<a name="l03634"></a>03634          current_run_number = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>;
<a name="l03635"></a>03635 
<a name="l03636"></a>03636          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;process_event&quot;</span>, <span class="stringliteral">&quot;Set run number %d in ODB&quot;</span>, current_run_number);
<a name="l03637"></a>03637          assert(current_run_number &gt; 0);
<a name="l03638"></a>03638 
<a name="l03639"></a>03639          <span class="comment">/* set run number in ODB */</span>
<a name="l03640"></a>03640          status = <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(hDB, 0, <span class="stringliteral">&quot;/Runinfo/Run number&quot;</span>, &amp;current_run_number,
<a name="l03641"></a>03641                                <span class="keyword">sizeof</span>(current_run_number), 1, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l03642"></a>03642          assert(status == <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>);
<a name="l03643"></a>03643 
<a name="l03644"></a>03644          <span class="comment">/* load ODB from event */</span>
<a name="l03645"></a>03645          <a class="code" href="mana_8cpp.html#abe1e94ccaf2f7b108ef3291550a119c6">odb_load</a>(pevent);
<a name="l03646"></a>03646 
<a name="l03647"></a>03647 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l03648"></a>03648 <span class="preprocessor"></span>         PVM_DEBUG(<span class="stringliteral">&quot;process_event: ODB load&quot;</span>);
<a name="l03649"></a>03649 <span class="preprocessor">#endif</span>
<a name="l03650"></a>03650 <span class="preprocessor"></span>      }
<a name="l03651"></a>03651    } <span class="keywordflow">else</span>
<a name="l03652"></a>03652       <span class="comment">/* increment event counter */</span>
<a name="l03653"></a>03653       par-&gt;<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a>++;
<a name="l03654"></a>03654 
<a name="l03655"></a>03655 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l03656"></a>03656 <span class="preprocessor"></span>
<a name="l03657"></a>03657    <span class="comment">/* if master, distribute events to clients */</span>
<a name="l03658"></a>03658    <span class="keywordflow">if</span> (pvm_master) {
<a name="l03659"></a>03659       status = pvm_distribute(par, pevent);
<a name="l03660"></a>03660       <span class="keywordflow">return</span> status;
<a name="l03661"></a>03661    }
<a name="l03662"></a>03662 <span class="preprocessor">#endif</span>
<a name="l03663"></a>03663 <span class="preprocessor"></span>
<a name="l03664"></a>03664    <span class="comment">/* don&apos;t analyze special (BOR,MESSAGE,...) events */</span>
<a name="l03665"></a>03665    <span class="keywordflow">if</span> (par == NULL)
<a name="l03666"></a>03666       <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03667"></a>03667 
<a name="l03668"></a>03668    <span class="comment">/* swap event if necessary */</span>
<a name="l03669"></a>03669    event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l03670"></a>03670    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l03671"></a>03671       <span class="keywordflow">return</span> 0;
<a name="l03672"></a>03672 
<a name="l03673"></a>03673    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>)
<a name="l03674"></a>03674       <a class="code" href="group__msectionh.html#gacc5a45e8cd3b781a7622c4e00bdc348a">bk_swap</a>((<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1), <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l03675"></a>03675 
<a name="l03676"></a>03676    <span class="comment">/* keep copy of original event */</span>
<a name="l03677"></a>03677    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.filter) {
<a name="l03678"></a>03678       <span class="keywordflow">if</span> (orig_event == NULL)
<a name="l03679"></a>03679          orig_event = (<span class="keywordtype">char</span> *) malloc(<a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l03680"></a>03680       memcpy(orig_event, pevent, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l03681"></a>03681    } 
<a name="l03682"></a>03682 
<a name="l03683"></a>03683   <span class="comment">/* skip events after end of run when online */</span>
<a name="l03684"></a>03684   <span class="keywordflow">if</span>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online &amp;&amp; now_stopping) {
<a name="l03685"></a>03685     <span class="keywordflow">return</span> 0;
<a name="l03686"></a>03686   }
<a name="l03687"></a>03687 
<a name="l03688"></a>03688   <span class="comment">/*---- analyze event ----*/</span>
<a name="l03689"></a>03689 
<a name="l03690"></a>03690    <span class="comment">/* call non-modular analyzer if defined */</span>
<a name="l03691"></a>03691    <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#gae0728031c8b33ebc32851d6c2099a8f9">analyzer</a>) {
<a name="l03692"></a>03692       status = par-&gt;<a class="code" href="group__midasincludecode.html#gae0728031c8b33ebc32851d6c2099a8f9">analyzer</a>(pevent, (<span class="keywordtype">void</span> *) (pevent + 1));
<a name="l03693"></a>03693 
<a name="l03694"></a>03694       <span class="comment">/* don&apos;t continue if event was rejected */</span>
<a name="l03695"></a>03695       <span class="keywordflow">if</span> (status == <a class="code" href="group__midasincludecode.html#ga0ab5be4c0e2780166a0b7ed977fe3f01">ANA_SKIP</a>)
<a name="l03696"></a>03696          <span class="keywordflow">return</span> 0;
<a name="l03697"></a>03697    }
<a name="l03698"></a>03698 
<a name="l03699"></a>03699    <span class="comment">/* loop over analyzer modules */</span>
<a name="l03700"></a>03700    module = par-&gt;<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l03701"></a>03701    <span class="keywordflow">for</span> (i = 0; module != NULL &amp;&amp; module[i] != NULL; i++) {
<a name="l03702"></a>03702       <span class="keywordflow">if</span> (module[i]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>) {
<a name="l03703"></a>03703         <span class="comment">//printf(&quot;%s\n&quot;, module[i]-&gt;name);</span>
<a name="l03704"></a>03704          status = module[i]-&gt;<a class="code" href="group__midasincludecode.html#gaf3d6511a274c1946ce0bf45e7000e756">analyzer</a>(pevent, (<span class="keywordtype">void</span> *) (pevent + 1));
<a name="l03705"></a>03705 
<a name="l03706"></a>03706          <span class="comment">/* don&apos;t continue if event was rejected */</span>
<a name="l03707"></a>03707          <span class="keywordflow">if</span> (status == <a class="code" href="group__midasincludecode.html#ga0ab5be4c0e2780166a0b7ed977fe3f01">ANA_SKIP</a>)
<a name="l03708"></a>03708             <span class="keywordflow">return</span> 0;
<a name="l03709"></a>03709       }
<a name="l03710"></a>03710    }
<a name="l03711"></a>03711 
<a name="l03712"></a>03712    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l03713"></a>03713       <span class="comment">/* check if event got too large */</span>
<a name="l03714"></a>03714       i = <a class="code" href="group__msectionh.html#ga825db64c9ef9b4656698c890fca37c05">bk_size</a>(pevent + 1);
<a name="l03715"></a>03715 <span class="comment">//      if (i &gt; MAX_EVENT_SIZE)</span>
<a name="l03716"></a>03716       <span class="keywordflow">if</span> (i &gt;= 8*<a class="code" href="mana_8cpp.html#a2cfad5b8da98c11be16500fc15dba5aa">EXT_EVENT_SIZE</a>/10)
<a name="l03717"></a>03717          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;process_event&quot;</span>, <span class="stringliteral">&quot;Event got too large (%d Bytes) in analyzer&quot;</span>, i); 
<a name="l03718"></a>03718 
<a name="l03719"></a>03719       <span class="comment">/* correct for increased event size */</span>
<a name="l03720"></a>03720       pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = i;
<a name="l03721"></a>03721    }
<a name="l03722"></a>03722 
<a name="l03723"></a>03723    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>) {
<a name="l03724"></a>03724       <span class="comment">/* check if event got too large */</span>
<a name="l03725"></a>03725       i = <a class="code" href="group__ybosincludecode.html#gab97b7d0d9ea164c791c36374826d19fe">ybk_size</a>((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) (pevent + 1));
<a name="l03726"></a>03726       <span class="keywordflow">if</span> (i &gt; <a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>)
<a name="l03727"></a>03727          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;process_event&quot;</span>, <span class="stringliteral">&quot;Event got too large (%d Bytes) in analyzer&quot;</span>, i);
<a name="l03728"></a>03728 
<a name="l03729"></a>03729       <span class="comment">/* correct for increased event size */</span>
<a name="l03730"></a>03730       pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = i;
<a name="l03731"></a>03731    }
<a name="l03732"></a>03732 
<a name="l03733"></a>03733    <span class="comment">/* increment tests */</span>
<a name="l03734"></a>03734    <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga08306810e609b1e3854d3e19abe3a919">use_tests</a>)
<a name="l03735"></a>03735       <a class="code" href="fal_8c.html#a5d0c60b46806a49cf44b5db6053b1e0f">test_increment</a>();
<a name="l03736"></a>03736 
<a name="l03737"></a>03737    <span class="comment">/* in filter mode, use original event */</span>
<a name="l03738"></a>03738    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.filter)
<a name="l03739"></a>03739       pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) orig_event;
<a name="l03740"></a>03740 
<a name="l03741"></a>03741    <span class="comment">/* write resulting event */</span>
<a name="l03742"></a>03742    <span class="keywordflow">if</span> (out_file) {
<a name="l03743"></a>03743 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l03744"></a>03744 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#gac3a857e4820ecdaa22f9a66a560dccad">FORMAT_HBOOK</a>)
<a name="l03745"></a>03745          status = <a class="code" href="fal_8c.html#a2ba1d8e79f061e622f62471ae9bc7063">write_event_hbook</a>(out_file, pevent, par);
<a name="l03746"></a>03746 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l03747"></a>03747 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l03748"></a>03748 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#ga9663ae12f7cbf4295b3804ebd335e408">FORMAT_ROOT</a>)
<a name="l03749"></a>03749          status = write_event_ttree(out_file, pevent, par);
<a name="l03750"></a>03750 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l03751"></a>03751       <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>)
<a name="l03752"></a>03752          status = <a class="code" href="mana_8cpp.html#a548ba840d1c3a1f2a18009e48513f245">write_event_ascii</a>(out_file, pevent, par);
<a name="l03753"></a>03753       <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>)
<a name="l03754"></a>03754          status = <a class="code" href="mana_8cpp.html#a75ddaf388f46748e2585fa04d22278f2">write_event_midas</a>(out_file, pevent, par);
<a name="l03755"></a>03755 
<a name="l03756"></a>03756       <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {
<a name="l03757"></a>03757          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;process_event&quot;</span>, <span class="stringliteral">&quot;Error writing to file (Disk full?)&quot;</span>);
<a name="l03758"></a>03758          <span class="keywordflow">return</span> -1;
<a name="l03759"></a>03759       }
<a name="l03760"></a>03760 
<a name="l03761"></a>03761       par-&gt;<a class="code" href="group__midasincludecode.html#gaeaa47cc2392bfdc8a1ee1a459082c876">events_written</a>++;
<a name="l03762"></a>03762    }
<a name="l03763"></a>03763 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l03764"></a>03764 <span class="preprocessor"></span>   <span class="comment">/* fill shared memory */</span>
<a name="l03765"></a>03765    <span class="keywordflow">if</span> ((<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online || <a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <span class="stringliteral">&quot;OFLN&quot;</span>))
<a name="l03766"></a>03766        &amp;&amp; par-&gt;<a class="code" href="group__midasincludecode.html#gab9f17100ff718ee4da42cdd86a7f3cab">rwnt_buffer_size</a> &gt; 0)
<a name="l03767"></a>03767       <a class="code" href="fal_8c.html#a2ba1d8e79f061e622f62471ae9bc7063">write_event_hbook</a>(NULL, pevent, par);
<a name="l03768"></a>03768 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l03769"></a>03769 
<a name="l03770"></a>03770    <span class="comment">/* put event in ODB once every second */</span>
<a name="l03771"></a>03771    <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.events_to_odb)
<a name="l03772"></a>03772       <span class="keywordflow">for</span> (i = 0; i &lt; 50; i++) {
<a name="l03773"></a>03773          <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> == pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>) {
<a name="l03774"></a>03774             <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a1f9fe59026081d85b2ee6ad8645e060b">type</a> == <a class="code" href="group__mdefineh.html#ga58e919e4e401b299c1834be965c3e78c">EQ_PERIODIC</a> ||
<a name="l03775"></a>03775                 event_def-&gt;<a class="code" href="structEVENT__DEF.html#a1f9fe59026081d85b2ee6ad8645e060b">type</a> == <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a> ||
<a name="l03776"></a>03776                 actual_time - <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].last_time &gt; 1000) {
<a name="l03777"></a>03777                <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].last_time = actual_time;
<a name="l03778"></a>03778                <a class="code" href="fal_8c.html#ab55e3bbd032e2ede908194386fdd0dc3">write_event_odb</a>(pevent);
<a name="l03779"></a>03779             }
<a name="l03780"></a>03780             <span class="keywordflow">break</span>;
<a name="l03781"></a>03781          }
<a name="l03782"></a>03782          <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> == 0) {
<a name="l03783"></a>03783             <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].event_id = pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>;
<a name="l03784"></a>03784             <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].last_time = actual_time;
<a name="l03785"></a>03785             <a class="code" href="fal_8c.html#ab55e3bbd032e2ede908194386fdd0dc3">write_event_odb</a>(pevent);
<a name="l03786"></a>03786             <span class="keywordflow">break</span>;
<a name="l03787"></a>03787          }
<a name="l03788"></a>03788       }
<a name="l03789"></a>03789 
<a name="l03790"></a>03790    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03791"></a>03791 }
<a name="l03792"></a>03792 
<a name="l03793"></a>03793 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03794"></a>03794 
<a name="l03795"></a><a class="code" href="mana_8cpp.html#ae64a9e12504afe61b5d065dd43b6c637">03795</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a54200266ef010a58dcf76468aadace0b">receive_event</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> buffer_handle, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> request_id, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pheader,
<a name="l03796"></a>03796                    <span class="keywordtype">void</span> *pevent)
<a name="l03797"></a>03797 <span class="comment">/* receive online event */</span>
<a name="l03798"></a>03798 {
<a name="l03799"></a>03799    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i;
<a name="l03800"></a>03800    <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> *par;
<a name="l03801"></a>03801    <span class="keyword">static</span> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a> = 0;
<a name="l03802"></a>03802    <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> = NULL;
<a name="l03803"></a>03803    <span class="keywordtype">char</span> *pb;
<a name="l03804"></a>03804 
<a name="l03805"></a>03805    <span class="keywordflow">if</span> (buffer == NULL) {
<a name="l03806"></a>03806       buffer = (<span class="keywordtype">char</span> *) malloc(<a class="code" href="mana_8cpp.html#a2cfad5b8da98c11be16500fc15dba5aa">EXT_EVENT_SIZE</a>);
<a name="l03807"></a>03807 
<a name="l03808"></a>03808       <span class="keywordflow">if</span> (buffer == NULL) {
<a name="l03809"></a>03809          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;receive_event&quot;</span>, <span class="stringliteral">&quot;Not enough memory to buffer event of size %d&quot;</span>,
<a name="l03810"></a>03810                 buffer_size);
<a name="l03811"></a>03811          <span class="keywordflow">return</span>;
<a name="l03812"></a>03812       }
<a name="l03813"></a>03813    }
<a name="l03814"></a>03814 
<a name="l03815"></a>03815    <span class="comment">/* align buffer */</span>
<a name="l03816"></a>03816    pb = (<span class="keywordtype">char</span> *) <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>((<a class="code" href="group__midasincludecode.html#ga790216a8e71233fed28657b16a052e36">PTYPE</a>) buffer);
<a name="l03817"></a>03817 
<a name="l03818"></a>03818    <span class="comment">/* copy event to local buffer */</span>
<a name="l03819"></a>03819    memcpy(pb, pheader, pheader-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l03820"></a>03820 
<a name="l03821"></a>03821    par = analyze_request;
<a name="l03822"></a>03822 
<a name="l03823"></a>03823    <span class="keywordflow">for</span> (i = 0; par-&gt;<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; par++)
<a name="l03824"></a>03824       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#gafe5109f95d2a2c6406d5b6a6c661479e">buffer_handle</a> == buffer_handle &amp;&amp; par-&gt;<a class="code" href="group__midasincludecode.html#ga2ee7a01967465e8a725bb968246c01de">request_id</a> == request_id) {
<a name="l03825"></a>03825          <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(par, (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) pb);
<a name="l03826"></a>03826       }
<a name="l03827"></a>03827 }
<a name="l03828"></a>03828 
<a name="l03829"></a>03829 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03830"></a>03830 
<a name="l03831"></a><a class="code" href="mana_8cpp.html#a44060bd07543e42cf3d05407fc8909c8">03831</a> <span class="keywordtype">void</span> <a class="code" href="mana_8cpp.html#a44060bd07543e42cf3d05407fc8909c8">update_request</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hDB, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="keywordtype">void</span> *info)
<a name="l03832"></a>03832 {
<a name="l03833"></a>03833    <a class="code" href="structAR__INFO.html">AR_INFO</a> *ar_info;
<a name="l03834"></a>03834    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i;
<a name="l03835"></a>03835 
<a name="l03836"></a>03836    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online)
<a name="l03837"></a>03837       <span class="keywordflow">return</span>;
<a name="l03838"></a>03838 
<a name="l03839"></a>03839    <span class="comment">/* check which request&apos;s key has changed */</span>
<a name="l03840"></a>03840    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++)
<a name="l03841"></a>03841       <span class="keywordflow">if</span> (analyze_request[i].hkey_common == hKey) {
<a name="l03842"></a>03842          ar_info = &amp;analyze_request[i].<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>;
<a name="l03843"></a>03843 
<a name="l03844"></a>03844          <span class="comment">/* remove previous request */</span>
<a name="l03845"></a>03845          <span class="keywordflow">if</span> (analyze_request[i].request_id != -1)
<a name="l03846"></a>03846             <a class="code" href="group__msectionh.html#ga642e51b416da6cd6e27035fdd43ed71b">bm_delete_request</a>(analyze_request[i].request_id);
<a name="l03847"></a>03847 
<a name="l03848"></a>03848          <span class="comment">/* if enabled, add new request */</span>
<a name="l03849"></a>03849          <span class="keywordflow">if</span> (ar_info-&gt;<a class="code" href="group__midasincludecode.html#ga00b6cb7dc5fefe2d78d04caf3eb257cd">enabled</a>)
<a name="l03850"></a>03850             <a class="code" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event</a>(analyze_request[i].buffer_handle, (<span class="keywordtype">short</span>) ar_info-&gt;<a class="code" href="structAR__INFO.html#acb0cf26c5067b0c8eb7a895b70e42f11">event_id</a>,
<a name="l03851"></a>03851                              (<span class="keywordtype">short</span>) ar_info-&gt;<a class="code" href="group__midasincludecode.html#ga947c408489c2b8cd8ea2fc8b2df83388">trigger_mask</a>, ar_info-&gt;<a class="code" href="group__midasincludecode.html#ga023ac635bfecdb696c795dc7120209b7">sampling_type</a>,
<a name="l03852"></a>03852                              &amp;analyze_request[i].<a class="code" href="group__midasincludecode.html#ga2ee7a01967465e8a725bb968246c01de">request_id</a>, <a class="code" href="fal_8c.html#a54200266ef010a58dcf76468aadace0b">receive_event</a>);
<a name="l03853"></a>03853          <span class="keywordflow">else</span>
<a name="l03854"></a>03854             analyze_request[i].<a class="code" href="group__midasincludecode.html#ga2ee7a01967465e8a725bb968246c01de">request_id</a> = -1;
<a name="l03855"></a>03855       }
<a name="l03856"></a>03856 
<a name="l03857"></a>03857 }
<a name="l03858"></a>03858 
<a name="l03859"></a>03859 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03860"></a>03860 
<a name="l03861"></a><a class="code" href="mana_8cpp.html#a1a2128d90a2986636c9e80968c0d5c67">03861</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a1a2128d90a2986636c9e80968c0d5c67">register_requests</a>(<span class="keywordtype">void</span>)
<a name="l03862"></a>03862 {
<a name="l03863"></a>03863    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> index, status;
<a name="l03864"></a>03864    <span class="keywordtype">char</span> str[256];
<a name="l03865"></a>03865    <a class="code" href="structAR__INFO.html">AR_INFO</a> *ar_info;
<a name="l03866"></a>03866    <a class="code" href="structAR__STATS.html">AR_STATS</a> *ar_stats;
<a name="l03867"></a>03867    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l03868"></a>03868 
<a name="l03869"></a>03869    <span class="comment">/* scan ANALYZE_REQUEST table from ANALYZE.C */</span>
<a name="l03870"></a>03870    <span class="keywordflow">for</span> (index = 0; analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; index++) {
<a name="l03871"></a>03871       ar_info = &amp;analyze_request[index].<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>;
<a name="l03872"></a>03872       ar_stats = &amp;analyze_request[index].<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>;
<a name="l03873"></a>03873 
<a name="l03874"></a>03874       <span class="comment">/* create common subtree from analyze_request table in analyze.c */</span>
<a name="l03875"></a>03875       sprintf(str, <span class="stringliteral">&quot;/%s/%s/Common&quot;</span>, analyzer_name, analyze_request[index].event_name);
<a name="l03876"></a>03876       <a class="code" href="group__msectionh.html#gaba7341fc6e27b70739734a50b489ef4f">db_check_record</a>(hDB, 0, str, <a class="code" href="fal_8c.html#a9b830b651a8c873d619d16eb495097af">ANALYZER_REQUEST_STR</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03877"></a>03877       <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hKey);
<a name="l03878"></a>03878       analyze_request[index].<a class="code" href="group__midasincludecode.html#ga7c9dd18e861558a006b694b3c9f197a1">hkey_common</a> = hKey;
<a name="l03879"></a>03879 
<a name="l03880"></a>03880       strcpy(ar_info-&gt;<a class="code" href="group__midasincludecode.html#ga1331a0c0525a7f42a0f9c23d897cf46c">client_name</a>, analyzer_name);
<a name="l03881"></a>03881       gethostname(ar_info-&gt;<a class="code" href="group__midasincludecode.html#gae70ac5ffc29fabfaf9a87e717f75dae0">host</a>, <span class="keyword">sizeof</span>(ar_info-&gt;<a class="code" href="group__midasincludecode.html#gae70ac5ffc29fabfaf9a87e717f75dae0">host</a>));
<a name="l03882"></a>03882       <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(hDB, hKey, ar_info, <span class="keyword">sizeof</span>(<a class="code" href="structAR__INFO.html">AR_INFO</a>), 0);
<a name="l03883"></a>03883 
<a name="l03884"></a>03884       <span class="comment">/* open hot link to analyzer request info */</span>
<a name="l03885"></a>03885       <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(hDB, hKey, ar_info, <span class="keyword">sizeof</span>(<a class="code" href="structAR__INFO.html">AR_INFO</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="mana_8cpp.html#a44060bd07543e42cf3d05407fc8909c8">update_request</a>,
<a name="l03886"></a>03886                      NULL);
<a name="l03887"></a>03887 
<a name="l03888"></a>03888       <span class="comment">/* create statistics tree */</span>
<a name="l03889"></a>03889       sprintf(str, <span class="stringliteral">&quot;/%s/%s/Statistics&quot;</span>, analyzer_name, analyze_request[index].event_name);
<a name="l03890"></a>03890       <a class="code" href="group__msectionh.html#gaba7341fc6e27b70739734a50b489ef4f">db_check_record</a>(hDB, 0, str, <a class="code" href="fal_8c.html#a407acb59ee878974632978f7682e8d23">ANALYZER_STATS_STR</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03891"></a>03891       <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hKey);
<a name="l03892"></a>03892       assert(hKey);
<a name="l03893"></a>03893 
<a name="l03894"></a>03894       ar_stats-&gt;<a class="code" href="structAR__STATS.html#ae75a481fd926f515b17a3e2b63ee283a">events_received</a> = 0;
<a name="l03895"></a>03895       ar_stats-&gt;<a class="code" href="group__midasincludecode.html#ga3695a89775259f076f838bf46af2e00f">events_per_sec</a> = 0;
<a name="l03896"></a>03896       ar_stats-&gt;<a class="code" href="group__midasincludecode.html#ga142015e81c965f9e9fba58f5a6322525">events_written</a> = 0;
<a name="l03897"></a>03897 
<a name="l03898"></a>03898       <span class="comment">/* open hot link to statistics tree */</span>
<a name="l03899"></a>03899       status =
<a name="l03900"></a>03900           <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(hDB, hKey, ar_stats, <span class="keyword">sizeof</span>(<a class="code" href="structAR__STATS.html">AR_STATS</a>), <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a>, NULL, NULL);
<a name="l03901"></a>03901       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l03902"></a>03902          printf(<span class="stringliteral">&quot;Cannot open statistics record, probably other analyzer is using it\n&quot;</span>);
<a name="l03903"></a>03903 
<a name="l03904"></a>03904       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online) {
<a name="l03905"></a>03905       <span class="comment">/*---- open event buffer ---------------------------------------*/</span>
<a name="l03906"></a>03906          <a class="code" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer</a>(ar_info-&gt;<a class="code" href="group__midasincludecode.html#ga8b5be2917680552f8f9850c8bd7f9b4b">buffer</a>, <a class="code" href="group__midasincludecode.html#gacc4dda1aaabc9862fe79fd94e0b722bf">EVENT_BUFFER_SIZE</a>,
<a name="l03907"></a>03907                         &amp;analyze_request[index].<a class="code" href="group__midasincludecode.html#gafe5109f95d2a2c6406d5b6a6c661479e">buffer_handle</a>);
<a name="l03908"></a>03908 
<a name="l03909"></a>03909 <span class="comment">//         /* set the default buffer cache size */</span>
<a name="l03910"></a>03910 <span class="comment">//         bm_set_cache_size(analyze_request[index].buffer_handle, 100000, 0);</span>
<a name="l03911"></a>03911          <span class="comment">/* turn off buffer cache */</span>
<a name="l03912"></a>03912          <a class="code" href="group__msectionh.html#ga3d70a1e1e38b6ccf6bde4bc5b436ae5b">bm_set_cache_size</a>(analyze_request[index].buffer_handle, 0, 0);
<a name="l03913"></a>03913 
<a name="l03914"></a>03914       <span class="comment">/*---- request event -------------------------------------------*/</span>
<a name="l03915"></a>03915          <span class="keywordflow">if</span> (ar_info-&gt;<a class="code" href="group__midasincludecode.html#ga00b6cb7dc5fefe2d78d04caf3eb257cd">enabled</a>)
<a name="l03916"></a>03916             <a class="code" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event</a>(analyze_request[index].buffer_handle,
<a name="l03917"></a>03917                              (<span class="keywordtype">short</span>) ar_info-&gt;<a class="code" href="structAR__INFO.html#acb0cf26c5067b0c8eb7a895b70e42f11">event_id</a>, (<span class="keywordtype">short</span>) ar_info-&gt;<a class="code" href="group__midasincludecode.html#ga947c408489c2b8cd8ea2fc8b2df83388">trigger_mask</a>,
<a name="l03918"></a>03918                              ar_info-&gt;<a class="code" href="group__midasincludecode.html#ga023ac635bfecdb696c795dc7120209b7">sampling_type</a>, &amp;analyze_request[index].<a class="code" href="group__midasincludecode.html#ga2ee7a01967465e8a725bb968246c01de">request_id</a>,
<a name="l03919"></a>03919                              <a class="code" href="fal_8c.html#a54200266ef010a58dcf76468aadace0b">receive_event</a>);
<a name="l03920"></a>03920          <span class="keywordflow">else</span>
<a name="l03921"></a>03921             analyze_request[index].<a class="code" href="group__midasincludecode.html#ga2ee7a01967465e8a725bb968246c01de">request_id</a> = -1;
<a name="l03922"></a>03922       }
<a name="l03923"></a>03923    }
<a name="l03924"></a>03924 }
<a name="l03925"></a>03925 
<a name="l03926"></a>03926 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03927"></a>03927 
<a name="l03928"></a><a class="code" href="mana_8cpp.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">03928</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>()
<a name="l03929"></a>03929 {
<a name="l03930"></a>03930    <span class="keywordtype">int</span> i;
<a name="l03931"></a>03931    <a class="code" href="structAR__STATS.html">AR_STATS</a> *ar_stats;
<a name="l03932"></a>03932    <span class="keyword">static</span> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mevb_8cpp.html#a5fecce64b1b883ada4ac0bc410fb3304">last_time</a> = 0;
<a name="l03933"></a>03933    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l03934"></a>03934 
<a name="l03935"></a>03935    actual_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l03936"></a>03936 
<a name="l03937"></a>03937    <span class="keywordflow">if</span> (last_time == 0)
<a name="l03938"></a>03938       last_time = actual_time;
<a name="l03939"></a>03939 
<a name="l03940"></a>03940    <span class="keywordflow">if</span> (actual_time - last_time == 0)
<a name="l03941"></a>03941       <span class="keywordflow">return</span>;
<a name="l03942"></a>03942 
<a name="l03943"></a>03943    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l03944"></a>03944       ar_stats = &amp;analyze_request[i].<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>;
<a name="l03945"></a>03945       ar_stats-&gt;<a class="code" href="structAR__STATS.html#ae75a481fd926f515b17a3e2b63ee283a">events_received</a> += analyze_request[i].<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a>;
<a name="l03946"></a>03946       ar_stats-&gt;<a class="code" href="group__midasincludecode.html#ga142015e81c965f9e9fba58f5a6322525">events_written</a> += analyze_request[i].<a class="code" href="group__midasincludecode.html#gaeaa47cc2392bfdc8a1ee1a459082c876">events_written</a>;
<a name="l03947"></a>03947       ar_stats-&gt;<a class="code" href="group__midasincludecode.html#ga3695a89775259f076f838bf46af2e00f">events_per_sec</a> =
<a name="l03948"></a>03948           (analyze_request[i].<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a> / ((actual_time - last_time) / 1000.0));
<a name="l03949"></a>03949       analyze_request[i].<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a> = 0;
<a name="l03950"></a>03950       analyze_request[i].<a class="code" href="group__midasincludecode.html#gaeaa47cc2392bfdc8a1ee1a459082c876">events_written</a> = 0;
<a name="l03951"></a>03951    }
<a name="l03952"></a>03952 
<a name="l03953"></a>03953    <span class="comment">/* propagate new statistics to ODB */</span>
<a name="l03954"></a>03954    <a class="code" href="group__msectionh.html#ga90c77b8a4ca06f60b0f595c8f16a39bc">db_send_changed_records</a>();
<a name="l03955"></a>03955 
<a name="l03956"></a>03956    <span class="comment">/* save tests in ODB */</span>
<a name="l03957"></a>03957    <a class="code" href="fal_8c.html#a29da9175b91a9b8fbadf2499e84c11e3">test_write</a>();
<a name="l03958"></a>03958 
<a name="l03959"></a>03959    last_time = actual_time;
<a name="l03960"></a>03960 }
<a name="l03961"></a>03961 
<a name="l03962"></a>03962 
<a name="l03963"></a>03963 <span class="comment">/*-- Clear histos --------------------------------------------------*/</span>
<a name="l03964"></a>03964 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l03965"></a>03965 <span class="preprocessor"></span><a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> clear_histos_hbook(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> id1, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> id2)
<a name="l03966"></a>03966 {
<a name="l03967"></a>03967    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i;
<a name="l03968"></a>03968 
<a name="l03969"></a>03969    <span class="keywordflow">if</span> (id1 != id2) {
<a name="l03970"></a>03970       printf(<span class="stringliteral">&quot;Clear ID %d to ID %d\n&quot;</span>, id1, id2);
<a name="l03971"></a>03971       <span class="keywordflow">for</span> (i = id1; i &lt;= id2; i++)
<a name="l03972"></a>03972          <span class="keywordflow">if</span> (<a class="code" href="hbook_8h.html#a3efc0c35b6588eb50787985bb6440719">HEXIST</a>(i))
<a name="l03973"></a>03973             <a class="code" href="hbook_8h.html#aabf9d6f4996c66f08569c299f1f48f8c">HRESET</a>(i, bstr);
<a name="l03974"></a>03974    } <span class="keywordflow">else</span> {
<a name="l03975"></a>03975       printf(<span class="stringliteral">&quot;Clear ID %d\n&quot;</span>, id1);
<a name="l03976"></a>03976       <a class="code" href="hbook_8h.html#aabf9d6f4996c66f08569c299f1f48f8c">HRESET</a>(id1, bstr);
<a name="l03977"></a>03977    }
<a name="l03978"></a>03978 
<a name="l03979"></a>03979    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03980"></a>03980 }
<a name="l03981"></a>03981 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l03982"></a>03982 
<a name="l03983"></a>03983 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03984"></a>03984 
<a name="l03985"></a><a class="code" href="group__msectionh.html#gae9ff90314dfa68157afd60af1a5ab817">03985</a> <span class="keywordtype">void</span> <a class="code" href="group__msectionh.html#gae9ff90314dfa68157afd60af1a5ab817">lock_histo</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <span class="keywordtype">id</span>)
<a name="l03986"></a>03986 {
<a name="l03987"></a>03987    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i;
<a name="l03988"></a>03988 
<a name="l03989"></a>03989    <span class="keywordflow">for</span> (i = 0; i &lt; 10000; i++)
<a name="l03990"></a>03990       <span class="keywordflow">if</span> (lock_list[i] == 0)
<a name="l03991"></a>03991          <span class="keywordflow">break</span>;
<a name="l03992"></a>03992 
<a name="l03993"></a>03993    lock_list[i] = id;
<a name="l03994"></a>03994 }
<a name="l03995"></a>03995 
<a name="l03996"></a>03996 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03997"></a>03997 
<a name="l03998"></a>03998 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l03999"></a>03999 <span class="preprocessor"></span><a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a6286c3b1e900cb783d0b57e910d06f8a">ana_callback</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> index, <span class="keywordtype">void</span> *prpc_param[])
<a name="l04000"></a>04000 {
<a name="l04001"></a>04001    <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#gab04cd68bb2484fcbaa62d2eda3100250">RPC_ANA_CLEAR_HISTOS</a>)
<a name="l04002"></a>04002       clear_histos_hbook(<a class="code" href="group__msectionh.html#ga187949f830579556334ed017deea814c">CINT</a>(0), <a class="code" href="group__msectionh.html#ga187949f830579556334ed017deea814c">CINT</a>(1));
<a name="l04003"></a>04003    <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>;
<a name="l04004"></a>04004 }
<a name="l04005"></a>04005 <span class="preprocessor">#endif</span>
<a name="l04006"></a>04006 <span class="preprocessor"></span>
<a name="l04007"></a>04007 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04008"></a>04008 
<a name="l04009"></a><a class="code" href="mana_8cpp.html#a0e79fc9202ddba8e379b10912fe709aa">04009</a> <span class="keywordtype">void</span> <a class="code" href="mana_8cpp.html#a0e79fc9202ddba8e379b10912fe709aa">load_last_histos</a>()
<a name="l04010"></a>04010 {
<a name="l04011"></a>04011    <span class="keywordtype">char</span> str[256];
<a name="l04012"></a>04012 
<a name="l04013"></a>04013    <span class="comment">/* load previous online histos */</span>
<a name="l04014"></a>04014    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.no_load) {
<a name="l04015"></a>04015       strcpy(str, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.last_histo_filename);
<a name="l04016"></a>04016 
<a name="l04017"></a>04017       <span class="keywordflow">if</span> (strchr(str, <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>) == NULL)
<a name="l04018"></a>04018          <a class="code" href="group__msectionh.html#ga42926f9062f24eb432ffb6414cde67e8">add_data_dir</a>(str, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.last_histo_filename);
<a name="l04019"></a>04019 
<a name="l04020"></a>04020 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l04021"></a>04021 <span class="preprocessor"></span>      {
<a name="l04022"></a>04022          FILE *f;
<a name="l04023"></a>04023          <span class="keywordtype">char</span> str2[256];
<a name="l04024"></a>04024          <span class="keywordtype">int</span> i;
<a name="l04025"></a>04025 
<a name="l04026"></a>04026          <span class="keywordflow">for</span> (i = 0; i &lt; (int) strlen(str); i++)
<a name="l04027"></a>04027             <span class="keywordflow">if</span> (isupper(str[i]))
<a name="l04028"></a>04028                <span class="keywordflow">break</span>;
<a name="l04029"></a>04029 
<a name="l04030"></a>04030          <span class="keywordflow">if</span> (i &lt; (<span class="keywordtype">int</span>) strlen(str)) {
<a name="l04031"></a>04031             printf
<a name="l04032"></a>04032                 (<span class="stringliteral">&quot;Error: Due to a limitation in HBOOK, directoy names may not contain uppercase\n&quot;</span>);
<a name="l04033"></a>04033             printf(<span class="stringliteral">&quot;       characters. Histogram loading from %s will not work.\n&quot;</span>, str);
<a name="l04034"></a>04034          } <span class="keywordflow">else</span> {
<a name="l04035"></a>04035             f = fopen(str, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l04036"></a>04036             <span class="keywordflow">if</span> (f != NULL) {
<a name="l04037"></a>04037                fclose(f);
<a name="l04038"></a>04038                printf(<span class="stringliteral">&quot;Loading previous online histos from %s\n&quot;</span>, str);
<a name="l04039"></a>04039                strcpy(str2, <span class="stringliteral">&quot;A&quot;</span>);
<a name="l04040"></a>04040                <a class="code" href="hbook_8h.html#a11968ef8e1e4fa504ea4e4fdb43d8e8f">HRGET</a>(0, str, str2);
<a name="l04041"></a>04041 
<a name="l04042"></a>04042                <span class="comment">/* fix wrongly booked N-tuples at ID 100000 */</span>
<a name="l04043"></a>04043                <span class="keywordflow">if</span> (<a class="code" href="hbook_8h.html#a3efc0c35b6588eb50787985bb6440719">HEXIST</a>(100000))
<a name="l04044"></a>04044                   <a class="code" href="hbook_8h.html#a3d7fcc23e32f4f11cb69aa1f97073ac0">HDELET</a>(100000);
<a name="l04045"></a>04045             }
<a name="l04046"></a>04046          }
<a name="l04047"></a>04047       }
<a name="l04048"></a>04048 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l04049"></a>04049 
<a name="l04050"></a>04050 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l04051"></a>04051 <span class="preprocessor"></span>      printf(<span class="stringliteral">&quot;Loading previous online histos from %s\n&quot;</span>, str);
<a name="l04052"></a>04052       LoadRootHistograms(<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a>, str);
<a name="l04053"></a>04053 <span class="preprocessor">#endif</span>
<a name="l04054"></a>04054 <span class="preprocessor"></span>   }
<a name="l04055"></a>04055 }
<a name="l04056"></a>04056 
<a name="l04057"></a>04057 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04058"></a>04058 
<a name="l04059"></a><a class="code" href="mana_8cpp.html#ad767414c61d6a24611888cbdb899af31">04059</a> <span class="keywordtype">void</span> <a class="code" href="mana_8cpp.html#ad767414c61d6a24611888cbdb899af31">save_last_histos</a>()
<a name="l04060"></a>04060 {
<a name="l04061"></a>04061    <span class="keywordtype">char</span> str[256];
<a name="l04062"></a>04062 
<a name="l04063"></a>04063    <span class="comment">/* save online histos */</span>
<a name="l04064"></a>04064    strcpy(str, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.last_histo_filename);
<a name="l04065"></a>04065    <span class="keywordflow">if</span> (strchr(str, <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>) == NULL)
<a name="l04066"></a>04066       <a class="code" href="group__msectionh.html#ga42926f9062f24eb432ffb6414cde67e8">add_data_dir</a>(str, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.last_histo_filename);
<a name="l04067"></a>04067 
<a name="l04068"></a>04068    printf(<span class="stringliteral">&quot;Saving current online histos to %s\n&quot;</span>, str);
<a name="l04069"></a>04069 
<a name="l04070"></a>04070 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l04071"></a>04071 <span class="preprocessor"></span>   {
<a name="l04072"></a>04072       <span class="keywordtype">int</span> i;
<a name="l04073"></a>04073       <span class="keywordtype">char</span> str2[256];
<a name="l04074"></a>04074 
<a name="l04075"></a>04075       <span class="keywordflow">for</span> (i = 0; i &lt; (int) strlen(str); i++)
<a name="l04076"></a>04076          <span class="keywordflow">if</span> (isupper(str[i]))
<a name="l04077"></a>04077             <span class="keywordflow">break</span>;
<a name="l04078"></a>04078 
<a name="l04079"></a>04079       <span class="keywordflow">if</span> (i &lt; (<span class="keywordtype">int</span>) strlen(str)) {
<a name="l04080"></a>04080          printf
<a name="l04081"></a>04081              (<span class="stringliteral">&quot;Error: Due to a limitation in HBOOK, directoy names may not contain uppercase\n&quot;</span>);
<a name="l04082"></a>04082          printf(<span class="stringliteral">&quot;       characters. Histogram saving to %s will not work.\n&quot;</span>, str);
<a name="l04083"></a>04083       } <span class="keywordflow">else</span> {
<a name="l04084"></a>04084          strcpy(str2, <span class="stringliteral">&quot;NT&quot;</span>);
<a name="l04085"></a>04085          <a class="code" href="hbook_8h.html#afebb35542c02eb885020475cb221afaf">HRPUT</a>(0, str, str2);
<a name="l04086"></a>04086       }
<a name="l04087"></a>04087    }
<a name="l04088"></a>04088 <span class="preprocessor">#endif</span>
<a name="l04089"></a>04089 <span class="preprocessor"></span>
<a name="l04090"></a>04090 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l04091"></a>04091 <span class="preprocessor"></span>   SaveRootHistograms(<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a>, str);
<a name="l04092"></a>04092 <span class="preprocessor">#endif</span>
<a name="l04093"></a>04093 <span class="preprocessor"></span>
<a name="l04094"></a>04094 }
<a name="l04095"></a>04095 
<a name="l04096"></a>04096 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04097"></a>04097 
<a name="l04098"></a><a class="code" href="mana_8cpp.html#adce2146eee6315ed1feed2dc301f2427">04098</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#adce2146eee6315ed1feed2dc301f2427">loop_online</a>()
<a name="l04099"></a>04099 {
<a name="l04100"></a>04100    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status = <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l04101"></a>04101    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> last_time_loop, last_time_update, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l04102"></a>04102    <span class="keywordtype">int</span> ch;
<a name="l04103"></a>04103 
<a name="l04104"></a>04104    printf(<span class="stringliteral">&quot;Running analyzer online. Stop with \&quot;!\&quot;\n&quot;</span>);
<a name="l04105"></a>04105 
<a name="l04106"></a>04106    <span class="comment">/* main loop */</span>
<a name="l04107"></a>04107    last_time_update = 0;
<a name="l04108"></a>04108    last_time_loop = 0;
<a name="l04109"></a>04109 
<a name="l04110"></a>04110    <span class="keywordflow">do</span> {
<a name="l04111"></a>04111       <span class="comment">/* calculate events per second */</span>
<a name="l04112"></a>04112       actual_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l04113"></a>04113 
<a name="l04114"></a>04114       <span class="keywordflow">if</span> (actual_time - last_time_update &gt; 1000) {
<a name="l04115"></a>04115          <span class="comment">/* update statistics */</span>
<a name="l04116"></a>04116          <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l04117"></a>04117          last_time_update = actual_time;
<a name="l04118"></a>04118 
<a name="l04119"></a>04119          <span class="comment">/* check keyboard */</span>
<a name="l04120"></a>04120          ch = 0;
<a name="l04121"></a>04121          <span class="keywordflow">while</span> (<a class="code" href="group__msectionh.html#gae96b0ebe47aa1d54f800e4f2e7f564b9">ss_kbhit</a>()) {
<a name="l04122"></a>04122             ch = <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(0);
<a name="l04123"></a>04123             <span class="keywordflow">if</span> (ch == -1)
<a name="l04124"></a>04124                ch = getchar();
<a name="l04125"></a>04125 
<a name="l04126"></a>04126             <span class="keywordflow">if</span> ((<span class="keywordtype">char</span>) ch == <span class="charliteral">&apos;!&apos;</span>)
<a name="l04127"></a>04127                <span class="keywordflow">break</span>;
<a name="l04128"></a>04128          }
<a name="l04129"></a>04129 
<a name="l04130"></a>04130          <span class="keywordflow">if</span> ((<span class="keywordtype">char</span>) ch == <span class="charliteral">&apos;!&apos;</span>)
<a name="l04131"></a>04131             <span class="keywordflow">break</span>;
<a name="l04132"></a>04132       }
<a name="l04133"></a>04133 
<a name="l04134"></a>04134       <span class="keywordflow">if</span> (analyzer_loop_period == 0)
<a name="l04135"></a>04135          status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(1000);
<a name="l04136"></a>04136       <span class="keywordflow">else</span> {
<a name="l04137"></a>04137          <span class="keywordflow">if</span> (actual_time - last_time_loop &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) analyzer_loop_period) {
<a name="l04138"></a>04138             last_time_loop = actual_time;
<a name="l04139"></a>04139             <a class="code" href="analyzer_8cpp.html#a7173b35a859f0740c437df5f68ccf80b">analyzer_loop</a>();
<a name="l04140"></a>04140          }
<a name="l04141"></a>04141 
<a name="l04142"></a>04142          status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(analyzer_loop_period);
<a name="l04143"></a>04143       }
<a name="l04144"></a>04144 
<a name="l04145"></a>04145    } <span class="keywordflow">while</span> (status != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> &amp;&amp; status != <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>);
<a name="l04146"></a>04146 
<a name="l04147"></a>04147    <span class="comment">/* update statistics */</span>
<a name="l04148"></a>04148    <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l04149"></a>04149 
<a name="l04150"></a>04150    <span class="keywordflow">return</span> status;
<a name="l04151"></a>04151 }
<a name="l04152"></a>04152 
<a name="l04153"></a>04153 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04154"></a>04154 
<a name="l04155"></a><a class="code" href="mana_8cpp.html#a3faaffbd2cd679eb4a39eb234e4aef3b">04155</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a9527329c5d4ec01a728dfc43ad33b2fa">init_module_parameters</a>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> bclose)
<a name="l04156"></a>04156 {
<a name="l04157"></a>04157    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, j, status, size;
<a name="l04158"></a>04158    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l04159"></a>04159    <span class="keywordtype">char</span> str[80];
<a name="l04160"></a>04160    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l04161"></a>04161 
<a name="l04162"></a>04162    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l04163"></a>04163       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l04164"></a>04164       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++) {
<a name="l04165"></a>04165          <span class="keywordflow">if</span> (module[j]-&gt;parameters != NULL) {
<a name="l04166"></a>04166             sprintf(str, <span class="stringliteral">&quot;/%s/Parameters/%s&quot;</span>, analyzer_name, module[j]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l04167"></a>04167 
<a name="l04168"></a>04168             <span class="keywordflow">if</span> (bclose) {
<a name="l04169"></a>04169                <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l04170"></a>04170                <a class="code" href="group__msectionh.html#gae60eb33ad37ee9a9ce1cbc872db2fb19">db_close_record</a>(hDB, hkey);
<a name="l04171"></a>04171             } <span class="keywordflow">else</span> {
<a name="l04172"></a>04172                status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l04173"></a>04173                <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l04174"></a>04174                   <a class="code" href="group__msectionh.html#ga1880903c0ebb0d58809f48f6b2d59704">db_get_record_size</a>(hDB, hkey, 0, &amp;size);
<a name="l04175"></a>04175                   <span class="keywordflow">if</span> (size != module[j]-&gt;param_size)
<a name="l04176"></a>04176                      status = 0;
<a name="l04177"></a>04177                }
<a name="l04178"></a>04178                <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a> &amp;&amp; module[j]-&gt;init_str) {
<a name="l04179"></a>04179                   <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaba7341fc6e27b70739734a50b489ef4f">db_check_record</a>(hDB, 0, str, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(module[j]-&gt;init_str), <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) !=
<a name="l04180"></a>04180                       <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l04181"></a>04181                      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;init_module_parameters&quot;</span>,
<a name="l04182"></a>04182                             <span class="stringliteral">&quot;Cannot create/check \&quot;%s\&quot; parameters in ODB&quot;</span>, str);
<a name="l04183"></a>04183                      <span class="keywordflow">return</span> 0;
<a name="l04184"></a>04184                   }
<a name="l04185"></a>04185                }
<a name="l04186"></a>04186 
<a name="l04187"></a>04187                <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l04188"></a>04188                assert(hkey);
<a name="l04189"></a>04189 
<a name="l04190"></a>04190                <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(hDB, hkey, module[j]-&gt;parameters, module[j]-&gt;param_size,
<a name="l04191"></a>04191                                   <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l04192"></a>04192                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;init_module_parameters&quot;</span>,
<a name="l04193"></a>04193                          <span class="stringliteral">&quot;Cannot open \&quot;%s\&quot; parameters in ODB&quot;</span>, str);
<a name="l04194"></a>04194                   <span class="keywordflow">return</span> 0;
<a name="l04195"></a>04195                }
<a name="l04196"></a>04196             }
<a name="l04197"></a>04197          }
<a name="l04198"></a>04198       }
<a name="l04199"></a>04199    }
<a name="l04200"></a>04200 
<a name="l04201"></a>04201    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l04202"></a>04202 }
<a name="l04203"></a>04203 
<a name="l04204"></a>04204 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04205"></a>04205 
<a name="l04206"></a><a class="code" href="mana_8cpp.html#ab4b3cf3c50a5b66e9c00af61e2b715cc">04206</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#ab4b3cf3c50a5b66e9c00af61e2b715cc">bevid_2_mheader</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> * pybos)
<a name="l04207"></a>04207 {
<a name="l04208"></a>04208    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status;
<a name="l04209"></a>04209    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bklen, bktyp, *pdata;
<a name="l04210"></a>04210    <a class="code" href="structYBOS__BANK__HEADER.html">YBOS_BANK_HEADER</a> *pybk;
<a name="l04211"></a>04211 
<a name="l04212"></a>04212    <span class="comment">/* check if EVID is present if so display its content */</span>
<a name="l04213"></a>04213    <span class="keywordflow">if</span> ((status = <a class="code" href="group__ybosincludecode.html#ga9f326548ddf809e142d16ff26a48e1a9">ybk_find</a>(pybos, <span class="stringliteral">&quot;EVID&quot;</span>, &amp;bklen, &amp;bktyp, (<span class="keywordtype">void</span> **) &amp;pybk)) == <a class="code" href="group__yboserrorh.html#gaf3834f9669e9c611d56b2b8b71f29869">YB_SUCCESS</a>) {
<a name="l04214"></a>04214       pdata = (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) ((<a class="code" href="structYBOS__BANK__HEADER.html">YBOS_BANK_HEADER</a> *) pybk + 1);
<a name="l04215"></a>04215       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.verbose) {
<a name="l04216"></a>04216          printf(<span class="stringliteral">&quot;--------- EVID --------- Event# %i ------Run#:%i--------\n&quot;</span>,
<a name="l04217"></a>04217                 (<span class="keywordtype">int</span>) (<a class="code" href="group__ybosmacroh.html#gac47f8cd70b6a4857e158b1db1cabd03f">YBOS_EVID_EVENT_NB</a>(pdata)), (<span class="keywordtype">int</span>) (<a class="code" href="group__ybosmacroh.html#gaf76637492097ef968ebe97d512e19b8d">YBOS_EVID_RUN_NUMBER</a>(pdata)));
<a name="l04218"></a>04218          printf(<span class="stringliteral">&quot;Evid:%4.4x- Mask:%4.4x- Serial:%i- Time:0x%x- Dsize:%i/0x%x&quot;</span>,
<a name="l04219"></a>04219                 (<span class="keywordtype">int</span>) <a class="code" href="group__ybosmacroh.html#gaa20b5bd51971a3dbf65ffa09dbda00db">YBOS_EVID_EVENT_ID</a>(pdata), (<span class="keywordtype">int</span>) <a class="code" href="group__ybosmacroh.html#gaf95ed2186275c9508470d03257254759">YBOS_EVID_TRIGGER_MASK</a>(pdata)
<a name="l04220"></a>04220                 , (<span class="keywordtype">int</span>) <a class="code" href="group__ybosmacroh.html#ga5b01530723b63088e380d00404f8860f">YBOS_EVID_SERIAL</a>(pdata), (<span class="keywordtype">int</span>) <a class="code" href="group__ybosmacroh.html#gaaa8203df912fab8c9315ce77bbfda60f">YBOS_EVID_TIME</a>(pdata)
<a name="l04221"></a>04221                 , (<span class="keywordtype">int</span>) pybk-&gt;length, (<span class="keywordtype">int</span>) pybk-&gt;length);
<a name="l04222"></a>04222       }
<a name="l04223"></a>04223       pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = <a class="code" href="group__ybosmacroh.html#gaa20b5bd51971a3dbf65ffa09dbda00db">YBOS_EVID_EVENT_ID</a>(pdata);
<a name="l04224"></a>04224       pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = <a class="code" href="group__ybosmacroh.html#gaf95ed2186275c9508470d03257254759">YBOS_EVID_TRIGGER_MASK</a>(pdata);
<a name="l04225"></a>04225       pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> = <a class="code" href="group__ybosmacroh.html#ga5b01530723b63088e380d00404f8860f">YBOS_EVID_SERIAL</a>(pdata);
<a name="l04226"></a>04226       pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = <a class="code" href="group__ybosmacroh.html#gaaa8203df912fab8c9315ce77bbfda60f">YBOS_EVID_TIME</a>(pdata);
<a name="l04227"></a>04227       pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = pybk-&gt;length;
<a name="l04228"></a>04228    }
<a name="l04229"></a>04229    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l04230"></a>04230 }
<a name="l04231"></a>04231 
<a name="l04232"></a>04232 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04233"></a>04233 
<a name="l04234"></a><a class="code" href="mana_8cpp.html#abe1e94ccaf2f7b108ef3291550a119c6">04234</a> <span class="keywordtype">void</span> <a class="code" href="mana_8cpp.html#abe1e94ccaf2f7b108ef3291550a119c6">odb_load</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent)
<a name="l04235"></a>04235 {
<a name="l04236"></a>04236    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l04237"></a>04237    <span class="keywordtype">int</span> size, i, status;
<a name="l04238"></a>04238    <span class="keywordtype">char</span> str[256];
<a name="l04239"></a>04239    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, hKeyRoot, hKeyEq;
<a name="l04240"></a>04240 
<a name="l04241"></a>04241    flag = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04242"></a>04242    size = <span class="keyword">sizeof</span>(flag);
<a name="l04243"></a>04243    sprintf(str, <span class="stringliteral">&quot;/%s/ODB Load&quot;</span>, analyzer_name);
<a name="l04244"></a>04244    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, str, &amp;flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04245"></a>04245 
<a name="l04246"></a>04246    <span class="keywordflow">if</span> (flag) {
<a name="l04247"></a>04247       <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++)
<a name="l04248"></a>04248          <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.protect[i][0] &amp;&amp; !<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet)
<a name="l04249"></a>04249             printf(<span class="stringliteral">&quot;Protect ODB tree \&quot;%s\&quot;\n&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.protect[i]);
<a name="l04250"></a>04250 
<a name="l04251"></a>04251       <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet)
<a name="l04252"></a>04252          printf(<span class="stringliteral">&quot;Load ODB from run %d...&quot;</span>, (<span class="keywordtype">int</span>) current_run_number);
<a name="l04253"></a>04253 
<a name="l04254"></a>04254       <span class="keywordflow">if</span> (flag == 1) {
<a name="l04255"></a>04255          <span class="comment">/* lock all ODB values except run parameters */</span>
<a name="l04256"></a>04256          <a class="code" href="group__msectionh.html#ga1ff4f06d1c0c4301454b49daaf998a4c">db_set_mode</a>(hDB, 0, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04257"></a>04257 
<a name="l04258"></a>04258          <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, <span class="stringliteral">&quot;/Experiment/Run Parameters&quot;</span>, &amp;hKey);
<a name="l04259"></a>04259          <span class="keywordflow">if</span> (hKey)
<a name="l04260"></a>04260             <a class="code" href="group__msectionh.html#ga1ff4f06d1c0c4301454b49daaf998a4c">db_set_mode</a>(hDB, hKey, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a> | <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a> | <a class="code" href="group__mdefineh.html#ga75f614b7ebb2b887b9e8f13c1b53ca6f">MODE_DELETE</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04261"></a>04261 
<a name="l04262"></a>04262          <span class="comment">/* and analyzer parameters */</span>
<a name="l04263"></a>04263          sprintf(str, <span class="stringliteral">&quot;/%s/Parameters&quot;</span>, analyzer_name);
<a name="l04264"></a>04264          <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hKey);
<a name="l04265"></a>04265          <span class="keywordflow">if</span> (hKey)
<a name="l04266"></a>04266             <a class="code" href="group__msectionh.html#ga1ff4f06d1c0c4301454b49daaf998a4c">db_set_mode</a>(hDB, hKey, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a> | <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a> | <a class="code" href="group__mdefineh.html#ga75f614b7ebb2b887b9e8f13c1b53ca6f">MODE_DELETE</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04267"></a>04267 
<a name="l04268"></a>04268          <span class="comment">/* and equipment (except /variables) */</span>
<a name="l04269"></a>04269          <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, <span class="stringliteral">&quot;/Equipment&quot;</span>, &amp;hKeyRoot);
<a name="l04270"></a>04270          <span class="keywordflow">if</span> (hKeyRoot) {
<a name="l04271"></a>04271             <a class="code" href="group__msectionh.html#ga1ff4f06d1c0c4301454b49daaf998a4c">db_set_mode</a>(hDB, hKeyRoot, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a> | <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a> | <a class="code" href="group__mdefineh.html#ga75f614b7ebb2b887b9e8f13c1b53ca6f">MODE_DELETE</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04272"></a>04272 
<a name="l04273"></a>04273             <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l04274"></a>04274                status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, hKeyRoot, i, &amp;hKeyEq);
<a name="l04275"></a>04275                <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l04276"></a>04276                   <span class="keywordflow">break</span>;
<a name="l04277"></a>04277 
<a name="l04278"></a>04278                <a class="code" href="group__msectionh.html#ga1ff4f06d1c0c4301454b49daaf998a4c">db_set_mode</a>(hDB, hKeyEq, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a> | <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a> | <a class="code" href="group__mdefineh.html#ga75f614b7ebb2b887b9e8f13c1b53ca6f">MODE_DELETE</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04279"></a>04279 
<a name="l04280"></a>04280                <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, hKeyEq, <span class="stringliteral">&quot;Variables&quot;</span>, &amp;hKey);
<a name="l04281"></a>04281                <span class="keywordflow">if</span> (hKey)
<a name="l04282"></a>04282                   <a class="code" href="group__msectionh.html#ga1ff4f06d1c0c4301454b49daaf998a4c">db_set_mode</a>(hDB, hKey, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04283"></a>04283             }
<a name="l04284"></a>04284          }
<a name="l04285"></a>04285 
<a name="l04286"></a>04286          <span class="comment">/* lock protected trees */</span>
<a name="l04287"></a>04287          <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++)
<a name="l04288"></a>04288             <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.protect[i][0]) {
<a name="l04289"></a>04289                <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.protect[i], &amp;hKey);
<a name="l04290"></a>04290                <span class="keywordflow">if</span> (hKey)
<a name="l04291"></a>04291                   <a class="code" href="group__msectionh.html#ga1ff4f06d1c0c4301454b49daaf998a4c">db_set_mode</a>(hDB, hKey, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04292"></a>04292             }
<a name="l04293"></a>04293       }
<a name="l04294"></a>04294 
<a name="l04295"></a>04295       <span class="comment">/* close open records to parameters */</span>
<a name="l04296"></a>04296       <a class="code" href="fal_8c.html#a9527329c5d4ec01a728dfc43ad33b2fa">init_module_parameters</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04297"></a>04297 
<a name="l04298"></a>04298       <a class="code" href="group__msectionh.html#ga99680031cca96d7eb7b4ac7cd20ae0fa">db_paste</a>(hDB, 0, (<span class="keywordtype">char</span> *) (pevent + 1));
<a name="l04299"></a>04299 
<a name="l04300"></a>04300       <span class="keywordflow">if</span> (flag == 1)
<a name="l04301"></a>04301          <a class="code" href="group__msectionh.html#ga1ff4f06d1c0c4301454b49daaf998a4c">db_set_mode</a>(hDB, 0, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a> | <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a> | <a class="code" href="group__mdefineh.html#ga75f614b7ebb2b887b9e8f13c1b53ca6f">MODE_DELETE</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04302"></a>04302 
<a name="l04303"></a>04303       <span class="comment">/* reinit structured opened by user analyzer */</span>
<a name="l04304"></a>04304       <a class="code" href="analyzer_8cpp.html#afeea792d4dbe0001bd025397e494ab5b">analyzer_init</a>();
<a name="l04305"></a>04305 
<a name="l04306"></a>04306       <span class="comment">/* reload parameter files after BOR event */</span>
<a name="l04307"></a>04307       <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet)
<a name="l04308"></a>04308          printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l04309"></a>04309       <a class="code" href="mana_8cpp.html#ae20b777778d5dcd241cf1dfb0dd2230f">load_parameters</a>(current_run_number);
<a name="l04310"></a>04310 
<a name="l04311"></a>04311       <span class="comment">/* open module parameters again */</span>
<a name="l04312"></a>04312       <a class="code" href="fal_8c.html#a9527329c5d4ec01a728dfc43ad33b2fa">init_module_parameters</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04313"></a>04313    }
<a name="l04314"></a>04314 }
<a name="l04315"></a>04315 
<a name="l04316"></a>04316 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04317"></a>04317 
<a name="l04318"></a><a class="code" href="mana_8cpp.html#a4f16e89aa9b9e0a0407f8611e0bfd17a">04318</a> <span class="preprocessor">#define MA_DEVICE_DISK        1</span>
<a name="l04319"></a><a class="code" href="mana_8cpp.html#a1cfcef8fe3f0c8bca70aa08ffc445936">04319</a> <span class="preprocessor"></span><span class="preprocessor">#define MA_DEVICE_TAPE        2</span>
<a name="l04320"></a><a class="code" href="mana_8cpp.html#a5238aca03baa556f4f1c6786e9de8af2">04320</a> <span class="preprocessor"></span><span class="preprocessor">#define MA_DEVICE_FTP         3</span>
<a name="l04321"></a><a class="code" href="mana_8cpp.html#ae97c2576e5febbb750a3482a935da95f">04321</a> <span class="preprocessor"></span><span class="preprocessor">#define MA_DEVICE_PVM         4</span>
<a name="l04322"></a>04322 <span class="preprocessor"></span>
<a name="l04323"></a><a class="code" href="mana_8cpp.html#a1595dea1508a366356bdc23083505ded">04323</a> <span class="preprocessor">#define MA_FORMAT_MIDAS       (1&lt;&lt;0)</span>
<a name="l04324"></a><a class="code" href="mana_8cpp.html#af861b11d02a59ddde8874692b3c59737">04324</a> <span class="preprocessor"></span><span class="preprocessor">#define MA_FORMAT_YBOS        (1&lt;&lt;2)</span>
<a name="l04325"></a><a class="code" href="mana_8cpp.html#af3f0df89b84a84b6e98576e1dc3a1989">04325</a> <span class="preprocessor"></span><span class="preprocessor">#define MA_FORMAT_GZIP        (1&lt;&lt;3)</span>
<a name="l04326"></a>04326 <span class="preprocessor"></span>
<a name="l04327"></a><a class="code" href="structMA__FILE.html">04327</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l04328"></a><a class="code" href="structMA__FILE.html#ad357c0f8ebc9dec3d3c00f7fa0b35402">04328</a>    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256];
<a name="l04329"></a><a class="code" href="structMA__FILE.html#a52d038c118c4fba1a02c520c620a10dd">04329</a>    <span class="keywordtype">int</span> format;
<a name="l04330"></a><a class="code" href="structMA__FILE.html#af882f0918954b8a2e9917fd143923180">04330</a>    <span class="keywordtype">int</span> device;
<a name="l04331"></a><a class="code" href="structMA__FILE.html#ac31c4f9608b1c20763016da63746edc3">04331</a>    <span class="keywordtype">int</span> fd;
<a name="l04332"></a><a class="code" href="structMA__FILE.html#a9e6cc8290f83cf202d54b4d17b039225">04332</a>    <a class="code" href="zlib_8h.html#acd0143ddd532551631ecc7093fd7adfc">gzFile</a> gzfile;
<a name="l04333"></a><a class="code" href="structMA__FILE.html#a906a4f95ffc31bc4332faa57c8b0ff03">04333</a>    <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>;
<a name="l04334"></a><a class="code" href="structMA__FILE.html#a804f30da1e7d7f25740b19e0be74e66c">04334</a>    <span class="keywordtype">int</span> wp, rp;
<a name="l04335"></a>04335    <span class="comment">/*FTP_CON ftp_con; */</span>
<a name="l04336"></a>04336 } <a class="code" href="structMA__FILE.html">MA_FILE</a>;
<a name="l04337"></a>04337 
<a name="l04338"></a>04338 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04339"></a>04339 
<a name="l04340"></a><a class="code" href="mana_8cpp.html#acf053885bc02fc8661b8c5d23501be0f">04340</a> <a class="code" href="structMA__FILE.html">MA_FILE</a> *<a class="code" href="mana_8cpp.html#acf053885bc02fc8661b8c5d23501be0f">ma_open</a>(<span class="keywordtype">char</span> *<a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>)
<a name="l04341"></a>04341 {
<a name="l04342"></a>04342    <span class="keywordtype">char</span> *ext_str;
<a name="l04343"></a>04343    <span class="keywordtype">int</span> status;
<a name="l04344"></a>04344    <a class="code" href="structMA__FILE.html">MA_FILE</a> *file;
<a name="l04345"></a>04345 
<a name="l04346"></a>04346    <span class="comment">/* allocate MA_FILE structure */</span>
<a name="l04347"></a>04347    file = (<a class="code" href="structMA__FILE.html">MA_FILE</a> *) calloc(<span class="keyword">sizeof</span>(<a class="code" href="structMA__FILE.html">MA_FILE</a>), 1);
<a name="l04348"></a>04348    <span class="keywordflow">if</span> (file == NULL) {
<a name="l04349"></a>04349       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_input_file&quot;</span>, <span class="stringliteral">&quot;Cannot allocate MA file structure&quot;</span>);
<a name="l04350"></a>04350       <span class="keywordflow">return</span> NULL;
<a name="l04351"></a>04351    }
<a name="l04352"></a>04352 
<a name="l04353"></a>04353    <span class="comment">/* save file name */</span>
<a name="l04354"></a>04354    strcpy(file-&gt;<a class="code" href="structMA__FILE.html#ad357c0f8ebc9dec3d3c00f7fa0b35402">file_name</a>, file_name);
<a name="l04355"></a>04355 
<a name="l04356"></a>04356    <span class="comment">/* for now, just read from disk */</span>
<a name="l04357"></a>04357    file-&gt;<a class="code" href="structMA__FILE.html#af882f0918954b8a2e9917fd143923180">device</a> = <a class="code" href="mana_8cpp.html#a4f16e89aa9b9e0a0407f8611e0bfd17a">MA_DEVICE_DISK</a>;
<a name="l04358"></a>04358 
<a name="l04359"></a>04359    <span class="comment">/* or from PVM */</span>
<a name="l04360"></a>04360    <span class="keywordflow">if</span> (pvm_slave) {
<a name="l04361"></a>04361       file-&gt;<a class="code" href="structMA__FILE.html#af882f0918954b8a2e9917fd143923180">device</a> = <a class="code" href="mana_8cpp.html#ae97c2576e5febbb750a3482a935da95f">MA_DEVICE_PVM</a>;
<a name="l04362"></a>04362       file-&gt;<a class="code" href="structMA__FILE.html#a906a4f95ffc31bc4332faa57c8b0ff03">buffer</a> = (<span class="keywordtype">char</span> *) malloc(<a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>);
<a name="l04363"></a>04363       file-&gt;<a class="code" href="structMA__FILE.html#a804f30da1e7d7f25740b19e0be74e66c">wp</a> = file-&gt;<a class="code" href="structMA__FILE.html#a69151ddb38db163d85ed4e43fc9e46a9">rp</a> = 0;
<a name="l04364"></a>04364    }
<a name="l04365"></a>04365 
<a name="l04366"></a>04366    <span class="comment">/* check input file extension */</span>
<a name="l04367"></a>04367    <span class="keywordflow">if</span> (strchr(file_name, <span class="charliteral">&apos;.&apos;</span>)) {
<a name="l04368"></a>04368       ext_str = file_name + strlen(file_name) - 1;
<a name="l04369"></a>04369       <span class="keywordflow">while</span> (*ext_str != <span class="charliteral">&apos;.&apos;</span>)
<a name="l04370"></a>04370          ext_str--;
<a name="l04371"></a>04371    } <span class="keywordflow">else</span>
<a name="l04372"></a>04372       ext_str = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04373"></a>04373 
<a name="l04374"></a>04374    <span class="keywordflow">if</span> (strncmp(ext_str, <span class="stringliteral">&quot;.gz&quot;</span>, 3) == 0) {
<a name="l04375"></a>04375       ext_str--;
<a name="l04376"></a>04376       <span class="keywordflow">while</span> (*ext_str != <span class="charliteral">&apos;.&apos;</span> &amp;&amp; ext_str &gt; file_name)
<a name="l04377"></a>04377          ext_str--;
<a name="l04378"></a>04378    }
<a name="l04379"></a>04379 
<a name="l04380"></a>04380    <span class="keywordflow">if</span> (strncmp(file_name, <span class="stringliteral">&quot;/dev/&quot;</span>, 4) == 0)     <span class="comment">/* assume MIDAS tape */</span>
<a name="l04381"></a>04381       file-&gt;<a class="code" href="structMA__FILE.html#a52d038c118c4fba1a02c520c620a10dd">format</a> = <a class="code" href="mana_8cpp.html#a1595dea1508a366356bdc23083505ded">MA_FORMAT_MIDAS</a>;
<a name="l04382"></a>04382    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(ext_str, <span class="stringliteral">&quot;.mid&quot;</span>, 4) == 0)
<a name="l04383"></a>04383       file-&gt;<a class="code" href="structMA__FILE.html#a52d038c118c4fba1a02c520c620a10dd">format</a> = <a class="code" href="mana_8cpp.html#a1595dea1508a366356bdc23083505ded">MA_FORMAT_MIDAS</a>;
<a name="l04384"></a>04384    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(ext_str, <span class="stringliteral">&quot;.ybs&quot;</span>, 4) == 0)
<a name="l04385"></a>04385       file-&gt;<a class="code" href="structMA__FILE.html#a52d038c118c4fba1a02c520c620a10dd">format</a> = <a class="code" href="mana_8cpp.html#af861b11d02a59ddde8874692b3c59737">MA_FORMAT_YBOS</a>;
<a name="l04386"></a>04386    <span class="keywordflow">else</span> {
<a name="l04387"></a>04387       printf
<a name="l04388"></a>04388           (<span class="stringliteral">&quot;Unknown input data format \&quot;%s\&quot;. Please use file extension .mid or mid.gz.\n&quot;</span>,
<a name="l04389"></a>04389            ext_str);
<a name="l04390"></a>04390       <span class="keywordflow">return</span> NULL;
<a name="l04391"></a>04391    }
<a name="l04392"></a>04392 
<a name="l04393"></a>04393    <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structMA__FILE.html#af882f0918954b8a2e9917fd143923180">device</a> == <a class="code" href="mana_8cpp.html#a4f16e89aa9b9e0a0407f8611e0bfd17a">MA_DEVICE_DISK</a>) {
<a name="l04394"></a>04394       <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structMA__FILE.html#a52d038c118c4fba1a02c520c620a10dd">format</a> == <a class="code" href="mana_8cpp.html#af861b11d02a59ddde8874692b3c59737">MA_FORMAT_YBOS</a>) {
<a name="l04395"></a>04395          status = <a class="code" href="group__ybosincludecode.html#gaa4ba04457fe9576c87b2710fea69f770">yb_any_file_ropen</a>(file_name, <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>);
<a name="l04396"></a>04396          <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>)
<a name="l04397"></a>04397             <span class="keywordflow">return</span> NULL;
<a name="l04398"></a>04398          <span class="keywordflow">if</span> (<a class="code" href="group__ybosincludecode.html#ga6a13d257d54a1d5e5c0bf126ae85edc9">yb_any_physrec_skip</a>(<a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>, -1) != <a class="code" href="group__yboserrorh.html#gaf3834f9669e9c611d56b2b8b71f29869">YB_SUCCESS</a>)
<a name="l04399"></a>04399             <span class="keywordflow">return</span> (NULL);
<a name="l04400"></a>04400       } <span class="keywordflow">else</span> {
<a name="l04401"></a>04401          file-&gt;<a class="code" href="structMA__FILE.html#a9e6cc8290f83cf202d54b4d17b039225">gzfile</a> = gzopen(file_name, <span class="stringliteral">&quot;rb&quot;</span>);
<a name="l04402"></a>04402          <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structMA__FILE.html#a9e6cc8290f83cf202d54b4d17b039225">gzfile</a> == NULL)
<a name="l04403"></a>04403             <span class="keywordflow">return</span> NULL;
<a name="l04404"></a>04404       }
<a name="l04405"></a>04405    }
<a name="l04406"></a>04406 
<a name="l04407"></a>04407    <span class="keywordflow">return</span> file;
<a name="l04408"></a>04408 }
<a name="l04409"></a>04409 
<a name="l04410"></a>04410 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04411"></a>04411 
<a name="l04412"></a><a class="code" href="mana_8cpp.html#a715e03caa3809d9dce4e01e9be5d3232">04412</a> <span class="keywordtype">int</span> <a class="code" href="mana_8cpp.html#a715e03caa3809d9dce4e01e9be5d3232">ma_close</a>(<a class="code" href="structMA__FILE.html">MA_FILE</a> * file)
<a name="l04413"></a>04413 {
<a name="l04414"></a>04414    <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structMA__FILE.html#a52d038c118c4fba1a02c520c620a10dd">format</a> == <a class="code" href="mana_8cpp.html#af861b11d02a59ddde8874692b3c59737">MA_FORMAT_YBOS</a>)
<a name="l04415"></a>04415       <a class="code" href="group__ybosincludecode.html#gaad6fca852eb2016b4a4547272512e0ae">yb_any_file_rclose</a>(<a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>);
<a name="l04416"></a>04416    <span class="keywordflow">else</span>
<a name="l04417"></a>04417       gzclose(file-&gt;<a class="code" href="structMA__FILE.html#a9e6cc8290f83cf202d54b4d17b039225">gzfile</a>);
<a name="l04418"></a>04418 
<a name="l04419"></a>04419    free(file);
<a name="l04420"></a>04420    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l04421"></a>04421 }
<a name="l04422"></a>04422 
<a name="l04423"></a>04423 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04424"></a>04424 
<a name="l04425"></a><a class="code" href="mana_8cpp.html#a86d00d374a6aed95075c5778cb25b321">04425</a> <span class="keywordtype">int</span> <a class="code" href="mana_8cpp.html#a86d00d374a6aed95075c5778cb25b321">ma_read_event</a>(<a class="code" href="structMA__FILE.html">MA_FILE</a> * file, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <span class="keywordtype">int</span> size)
<a name="l04426"></a>04426 {
<a name="l04427"></a>04427    <span class="keywordtype">int</span> status, n;
<a name="l04428"></a>04428 
<a name="l04429"></a>04429    <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structMA__FILE.html#af882f0918954b8a2e9917fd143923180">device</a> == <a class="code" href="mana_8cpp.html#a4f16e89aa9b9e0a0407f8611e0bfd17a">MA_DEVICE_DISK</a>) {
<a name="l04430"></a>04430       <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structMA__FILE.html#a52d038c118c4fba1a02c520c620a10dd">format</a> == <a class="code" href="mana_8cpp.html#a1595dea1508a366356bdc23083505ded">MA_FORMAT_MIDAS</a>) {
<a name="l04431"></a>04431          <span class="keywordflow">if</span> (size &lt; (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)) {
<a name="l04432"></a>04432             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;ma_read_event&quot;</span>, <span class="stringliteral">&quot;Buffer size too small&quot;</span>);
<a name="l04433"></a>04433             <span class="keywordflow">return</span> -1;
<a name="l04434"></a>04434          }
<a name="l04435"></a>04435 
<a name="l04436"></a>04436          <span class="comment">/* read event header */</span>
<a name="l04437"></a>04437          n = gzread(file-&gt;<a class="code" href="structMA__FILE.html#a9e6cc8290f83cf202d54b4d17b039225">gzfile</a>, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l04438"></a>04438          <span class="keywordflow">if</span> (n &lt; (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)) {
<a name="l04439"></a>04439             <span class="keywordflow">if</span> (n &gt; 0)
<a name="l04440"></a>04440                printf(<span class="stringliteral">&quot;Unexpected end of file %s, last event skipped\n&quot;</span>, file-&gt;<a class="code" href="structMA__FILE.html#ad357c0f8ebc9dec3d3c00f7fa0b35402">file_name</a>);
<a name="l04441"></a>04441             <span class="keywordflow">return</span> -1;
<a name="l04442"></a>04442          }
<a name="l04443"></a>04443 
<a name="l04444"></a>04444          <span class="comment">/* swap event header if in wrong format */</span>
<a name="l04445"></a>04445          <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> &gt; 0x1000000) {
<a name="l04446"></a>04446             <a class="code" href="group__msmacroh.html#ga4670ac841b4b8e3c3141a91a743bc61d">WORD_SWAP</a>(&amp;pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l04447"></a>04447             <a class="code" href="group__msmacroh.html#ga4670ac841b4b8e3c3141a91a743bc61d">WORD_SWAP</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>);
<a name="l04448"></a>04448             <a class="code" href="group__msmacroh.html#gadb40ea04e4e009bbde68c027a8f95039">DWORD_SWAP</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
<a name="l04449"></a>04449             <a class="code" href="group__msmacroh.html#gadb40ea04e4e009bbde68c027a8f95039">DWORD_SWAP</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>);
<a name="l04450"></a>04450             <a class="code" href="group__msmacroh.html#gadb40ea04e4e009bbde68c027a8f95039">DWORD_SWAP</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l04451"></a>04451          }
<a name="l04452"></a>04452 
<a name="l04453"></a>04453          <span class="comment">/* read event */</span>
<a name="l04454"></a>04454          n = 0;
<a name="l04455"></a>04455          <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> &gt; 0) {
<a name="l04456"></a>04456             <span class="keywordflow">if</span> (size &lt; (<span class="keywordtype">int</span>) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)) {
<a name="l04457"></a>04457                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;ma_read_event&quot;</span>, <span class="stringliteral">&quot;Buffer size too small&quot;</span>);
<a name="l04458"></a>04458                <span class="keywordflow">return</span> -1;
<a name="l04459"></a>04459             }
<a name="l04460"></a>04460 
<a name="l04461"></a>04461             n = gzread(file-&gt;<a class="code" href="structMA__FILE.html#a9e6cc8290f83cf202d54b4d17b039225">gzfile</a>, pevent + 1, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l04462"></a>04462             <span class="keywordflow">if</span> (n != (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l04463"></a>04463                printf(<span class="stringliteral">&quot;Unexpected end of file %s, last event skipped\n&quot;</span>, file-&gt;<a class="code" href="structMA__FILE.html#ad357c0f8ebc9dec3d3c00f7fa0b35402">file_name</a>);
<a name="l04464"></a>04464                <span class="keywordflow">return</span> -1;
<a name="l04465"></a>04465             }
<a name="l04466"></a>04466          }
<a name="l04467"></a>04467 
<a name="l04468"></a>04468          <span class="keywordflow">return</span> n + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l04469"></a>04469       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structMA__FILE.html#a52d038c118c4fba1a02c520c620a10dd">format</a> == <a class="code" href="mana_8cpp.html#af861b11d02a59ddde8874692b3c59737">MA_FORMAT_YBOS</a>) {
<a name="l04470"></a>04470          <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *pybos, readn;
<a name="l04471"></a>04471          <span class="keywordflow">if</span> (<a class="code" href="group__ybosincludecode.html#ga195a8275899e64304dbbff765293795c">ybos_event_get</a>(&amp;pybos, &amp;readn) != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>)
<a name="l04472"></a>04472             <span class="keywordflow">return</span> -1;
<a name="l04473"></a>04473          status = <a class="code" href="group__ybosincludecode.html#ga851698587a1300be6b8f1f1b0e3e03ea">yb_any_event_swap</a>(<a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>, pybos);
<a name="l04474"></a>04474          memcpy((<span class="keywordtype">char</span> *) (pevent + 1), (<span class="keywordtype">char</span> *) pybos, readn);
<a name="l04475"></a>04475          status = <a class="code" href="mana_8cpp.html#ab4b3cf3c50a5b66e9c00af61e2b715cc">bevid_2_mheader</a>(pevent, pybos);
<a name="l04476"></a>04476          <span class="keywordflow">return</span> readn;
<a name="l04477"></a>04477       }
<a name="l04478"></a>04478    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structMA__FILE.html#af882f0918954b8a2e9917fd143923180">device</a> == <a class="code" href="mana_8cpp.html#ae97c2576e5febbb750a3482a935da95f">MA_DEVICE_PVM</a>) {
<a name="l04479"></a>04479 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l04480"></a>04480 <span class="preprocessor"></span>      <span class="keywordtype">int</span> bufid, len, <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, tid;
<a name="l04481"></a>04481       <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pe;
<a name="l04482"></a>04482       <span class="keyword">struct </span>timeval timeout;
<a name="l04483"></a>04483 
<a name="l04484"></a>04484       <span class="comment">/* check if anything in buffer */</span>
<a name="l04485"></a>04485       <span class="keywordflow">if</span> (file-&gt;<a class="code" href="structMA__FILE.html#a804f30da1e7d7f25740b19e0be74e66c">wp</a> &gt; file-&gt;<a class="code" href="structMA__FILE.html#a69151ddb38db163d85ed4e43fc9e46a9">rp</a>) {
<a name="l04486"></a>04486          pe = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (file-&gt;<a class="code" href="structMA__FILE.html#a906a4f95ffc31bc4332faa57c8b0ff03">buffer</a> + file-&gt;<a class="code" href="structMA__FILE.html#a69151ddb38db163d85ed4e43fc9e46a9">rp</a>);
<a name="l04487"></a>04487          size = <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) + pe-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l04488"></a>04488          memcpy(pevent, pe, size);
<a name="l04489"></a>04489          file-&gt;<a class="code" href="structMA__FILE.html#a69151ddb38db163d85ed4e43fc9e46a9">rp</a> += size;
<a name="l04490"></a>04490          <span class="keywordflow">return</span> size;
<a name="l04491"></a>04491       }
<a name="l04492"></a>04492 
<a name="l04493"></a>04493       <span class="comment">/* send data request */</span>
<a name="l04494"></a>04494       pvm_initsend(<a class="code" href="pvm3_8h.html#a4a488c409eabcd4587ced64938f4c43f">PvmDataInPlace</a>);
<a name="l04495"></a>04495       pvm_send(pvm_myparent, TAG_DATA);
<a name="l04496"></a>04496 
<a name="l04497"></a>04497       <span class="comment">/* receive data */</span>
<a name="l04498"></a>04498       timeout.tv_sec = 60;
<a name="l04499"></a>04499       timeout.tv_usec = 0;
<a name="l04500"></a>04500 
<a name="l04501"></a>04501       bufid = pvm_trecv(-1, -1, &amp;timeout);
<a name="l04502"></a>04502       <span class="keywordflow">if</span> (bufid &lt; 0) {
<a name="l04503"></a>04503          pvm_perror(<span class="stringliteral">&quot;pvm_recv&quot;</span>);
<a name="l04504"></a>04504          <span class="keywordflow">return</span> -1;
<a name="l04505"></a>04505       }
<a name="l04506"></a>04506       <span class="keywordflow">if</span> (bufid == 0) {
<a name="l04507"></a>04507          PVM_DEBUG(<span class="stringliteral">&quot;ma_read_event: timeout receiving data, aborting analyzer.\n&quot;</span>);
<a name="l04508"></a>04508          <span class="keywordflow">return</span> -1;
<a name="l04509"></a>04509       }
<a name="l04510"></a>04510 
<a name="l04511"></a>04511       status = pvm_bufinfo(bufid, &amp;len, &amp;tag, &amp;tid);
<a name="l04512"></a>04512       <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l04513"></a>04513          pvm_perror(<span class="stringliteral">&quot;pvm_bufinfo&quot;</span>);
<a name="l04514"></a>04514          <span class="keywordflow">return</span> -1;
<a name="l04515"></a>04515       }
<a name="l04516"></a>04516 
<a name="l04517"></a>04517       PVM_DEBUG(<span class="stringliteral">&quot;ma_read_event: receive tag %d, buflen %d&quot;</span>, tag, len);
<a name="l04518"></a>04518 
<a name="l04519"></a>04519       <span class="keywordflow">if</span> (tag == TAG_EOR || tag == TAG_EXIT)
<a name="l04520"></a>04520          <span class="keywordflow">return</span> -1;
<a name="l04521"></a>04521 
<a name="l04522"></a>04522       file-&gt;<a class="code" href="structMA__FILE.html#a804f30da1e7d7f25740b19e0be74e66c">wp</a> = len;
<a name="l04523"></a>04523       file-&gt;<a class="code" href="structMA__FILE.html#a69151ddb38db163d85ed4e43fc9e46a9">rp</a> = 0;
<a name="l04524"></a>04524       status = pvm_upkbyte((<span class="keywordtype">char</span> *) file-&gt;<a class="code" href="structMA__FILE.html#a906a4f95ffc31bc4332faa57c8b0ff03">buffer</a>, len, 1);
<a name="l04525"></a>04525       <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l04526"></a>04526          pvm_perror(<span class="stringliteral">&quot;pvm_upkbyte&quot;</span>);
<a name="l04527"></a>04527          <span class="keywordflow">return</span> -1;
<a name="l04528"></a>04528       }
<a name="l04529"></a>04529 
<a name="l04530"></a>04530       <span class="comment">/* no new data available, sleep some time to reduce network traffic */</span>
<a name="l04531"></a>04531       <span class="keywordflow">if</span> (len == 0)
<a name="l04532"></a>04532          <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(200);
<a name="l04533"></a>04533 
<a name="l04534"></a>04534       <span class="comment">/* re-call this function */</span>
<a name="l04535"></a>04535       <span class="keywordflow">return</span> <a class="code" href="mana_8cpp.html#a86d00d374a6aed95075c5778cb25b321">ma_read_event</a>(file, pevent, size);
<a name="l04536"></a>04536 <span class="preprocessor">#endif</span>
<a name="l04537"></a>04537 <span class="preprocessor"></span>   }
<a name="l04538"></a>04538 
<a name="l04539"></a>04539    <span class="keywordflow">return</span> 0;
<a name="l04540"></a>04540 }
<a name="l04541"></a>04541 
<a name="l04542"></a>04542 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04543"></a>04543 
<a name="l04544"></a><a class="code" href="mana_8cpp.html#ab4bcdcd2d272279d3afbaec8fc7e01a1">04544</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#ab4bcdcd2d272279d3afbaec8fc7e01a1">analyze_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *<a class="code" href="mana_8cpp.html#a96deaa7886d0996592e850e04aea1795">input_file_name</a>, <span class="keywordtype">char</span> *<a class="code" href="mana_8cpp.html#a1be2956569ea7201e80da80d2517ae0f">output_file_name</a>)
<a name="l04545"></a>04545 {
<a name="l04546"></a>04546    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent, *pevent_unaligned;
<a name="l04547"></a>04547    <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> *par;
<a name="l04548"></a>04548    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, n, size;
<a name="l04549"></a>04549    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> num_events_in, num_events_out;
<a name="l04550"></a>04550    <span class="keywordtype">char</span> error[256], str[256];
<a name="l04551"></a>04551    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status = <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l04552"></a>04552    <a class="code" href="structMA__FILE.html">MA_FILE</a> *file;
<a name="l04553"></a>04553    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> skip;
<a name="l04554"></a>04554    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="old__mevb_8cpp.html#af4211e1ba0e676018599e88cfae3537a">start_time</a>;
<a name="l04555"></a>04555 
<a name="l04556"></a>04556    <span class="comment">/* set output file name and flags in ODB */</span>
<a name="l04557"></a>04557    sprintf(str, <span class="stringliteral">&quot;/%s/Output/Filename&quot;</span>, analyzer_name);
<a name="l04558"></a>04558    <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(hDB, 0, str, output_file_name, 256, 1, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>);
<a name="l04559"></a>04559 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l04560"></a>04560 <span class="preprocessor"></span>   sprintf(str, <span class="stringliteral">&quot;/%s/Output/RWNT&quot;</span>, analyzer_name);
<a name="l04561"></a>04561    <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(hDB, 0, str, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt, <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>), 1, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>);
<a name="l04562"></a>04562 <span class="preprocessor">#endif</span>
<a name="l04563"></a>04563 <span class="preprocessor"></span>
<a name="l04564"></a>04564    <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;analyze_run&quot;</span>, <span class="stringliteral">&quot;Set run number %d in ODB&quot;</span>, run_number);
<a name="l04565"></a>04565    <span class="comment">//assert(run_number &gt; 0);</span>
<a name="l04566"></a>04566 
<a name="l04567"></a>04567    <span class="comment">/* set run number in ODB */</span>
<a name="l04568"></a>04568    status =
<a name="l04569"></a>04569        <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(hDB, 0, <span class="stringliteral">&quot;/Runinfo/Run number&quot;</span>, &amp;run_number, <span class="keyword">sizeof</span>(run_number), 1,
<a name="l04570"></a>04570                     <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l04571"></a>04571    assert(status == <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>);
<a name="l04572"></a>04572 
<a name="l04573"></a>04573    <span class="comment">/* set file name in out_info */</span>
<a name="l04574"></a>04574    strcpy(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename, output_file_name);
<a name="l04575"></a>04575 
<a name="l04576"></a>04576    <span class="comment">/* let changes propagate to modules */</span>
<a name="l04577"></a>04577    <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(0);
<a name="l04578"></a>04578 
<a name="l04579"></a>04579    <span class="comment">/* open input file, will be changed to ma_open_file later... */</span>
<a name="l04580"></a>04580    file = <a class="code" href="mana_8cpp.html#acf053885bc02fc8661b8c5d23501be0f">ma_open</a>(input_file_name);
<a name="l04581"></a>04581    <span class="keywordflow">if</span> (file == NULL) {
<a name="l04582"></a>04582       printf(<span class="stringliteral">&quot;Cannot open input file \&quot;%s\&quot;\n&quot;</span>, input_file_name);
<a name="l04583"></a>04583       <span class="keywordflow">return</span> -1;
<a name="l04584"></a>04584    }
<a name="l04585"></a>04585 
<a name="l04586"></a>04586    pevent_unaligned = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) malloc(<a class="code" href="mana_8cpp.html#a2cfad5b8da98c11be16500fc15dba5aa">EXT_EVENT_SIZE</a>);
<a name="l04587"></a>04587    <span class="keywordflow">if</span> (pevent_unaligned == NULL) {
<a name="l04588"></a>04588       printf(<span class="stringliteral">&quot;Not enough memeory\n&quot;</span>);
<a name="l04589"></a>04589       <span class="keywordflow">return</span> -1;
<a name="l04590"></a>04590    }
<a name="l04591"></a>04591    pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>((<a class="code" href="group__midasincludecode.html#ga790216a8e71233fed28657b16a052e36">PTYPE</a>) pevent_unaligned);
<a name="l04592"></a>04592 
<a name="l04593"></a>04593    <span class="comment">/* call analyzer bor routines */</span>
<a name="l04594"></a>04594    <a class="code" href="mana_8cpp.html#aad9e8ec0221ce200e2bd2fd32f77833b">bor</a>(run_number, error);
<a name="l04595"></a>04595 
<a name="l04596"></a>04596    num_events_in = num_events_out = 0;
<a name="l04597"></a>04597 
<a name="l04598"></a>04598    start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l04599"></a>04599 
<a name="l04600"></a>04600    <span class="comment">/* event loop */</span>
<a name="l04601"></a>04601    <span class="keywordflow">do</span> {
<a name="l04602"></a>04602       <span class="comment">/* read next event */</span>
<a name="l04603"></a>04603       memset(pevent_unaligned, 0, <a class="code" href="mana_8cpp.html#a2cfad5b8da98c11be16500fc15dba5aa">EXT_EVENT_SIZE</a>);
<a name="l04604"></a>04604       n = <a class="code" href="mana_8cpp.html#a86d00d374a6aed95075c5778cb25b321">ma_read_event</a>(file, pevent, <a class="code" href="mana_8cpp.html#a2cfad5b8da98c11be16500fc15dba5aa">EXT_EVENT_SIZE</a>);
<a name="l04605"></a>04605       <span class="keywordflow">if</span> (n &lt;= 0)
<a name="l04606"></a>04606          <span class="keywordflow">break</span>;
<a name="l04607"></a>04607 
<a name="l04608"></a>04608       num_events_in++;
<a name="l04609"></a>04609 
<a name="l04610"></a>04610       <span class="comment">/* copy system events (BOR, EOR, MESSAGE) to output file */</span>
<a name="l04611"></a>04611       <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &lt; 0) {
<a name="l04612"></a>04612          status = <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(NULL, pevent);
<a name="l04613"></a>04613          <span class="keywordflow">if</span> (status &lt; 0 || status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)      <span class="comment">/* disk full/stop analyzer */</span>
<a name="l04614"></a>04614             <span class="keywordflow">break</span>;
<a name="l04615"></a>04615 
<a name="l04616"></a>04616          <span class="keywordflow">if</span> (out_file &amp;&amp; out_format == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l04617"></a>04617             size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l04618"></a>04618             <span class="keywordflow">if</span> (out_gzip)
<a name="l04619"></a>04619                status = gzwrite(out_file, pevent, size) == size ? <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l04620"></a>04620             <span class="keywordflow">else</span>
<a name="l04621"></a>04621                status =
<a name="l04622"></a>04622                    fwrite(pevent, 1, size,
<a name="l04623"></a>04623                           out_file) == (size_t) size ? <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l04624"></a>04624 
<a name="l04625"></a>04625             <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {
<a name="l04626"></a>04626                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;analyze_run&quot;</span>, <span class="stringliteral">&quot;Error writing to file (Disk full?)&quot;</span>);
<a name="l04627"></a>04627                <span class="keywordflow">return</span> -1;
<a name="l04628"></a>04628             }
<a name="l04629"></a>04629 
<a name="l04630"></a>04630             num_events_out++;
<a name="l04631"></a>04631          }
<a name="l04632"></a>04632 
<a name="l04633"></a>04633          <span class="comment">/* reinit start time after BOR event */</span>
<a name="l04634"></a>04634          <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> == <a class="code" href="group__mbufferh.html#gaea58a47233f988dd2f9a0320d99734dc">EVENTID_BOR</a>)
<a name="l04635"></a>04635             start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l04636"></a>04636       }
<a name="l04637"></a>04637 
<a name="l04638"></a>04638       <span class="comment">/* check if event is in event limit */</span>
<a name="l04639"></a>04639       skip = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04640"></a>04640 
<a name="l04641"></a>04641       <span class="keywordflow">if</span> (!pvm_slave) {
<a name="l04642"></a>04642          <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n[0] &gt; 0 || <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n[1] &gt; 0) {
<a name="l04643"></a>04643             <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n[1] == 0) {
<a name="l04644"></a>04644                <span class="comment">/* treat n[0] as upper limit */</span>
<a name="l04645"></a>04645                <span class="keywordflow">if</span> (num_events_in &gt; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n[0]) {
<a name="l04646"></a>04646                   num_events_in--;
<a name="l04647"></a>04647                   status = <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l04648"></a>04648                   <span class="keywordflow">break</span>;
<a name="l04649"></a>04649                }
<a name="l04650"></a>04650             } <span class="keywordflow">else</span> {
<a name="l04651"></a>04651                <span class="keywordflow">if</span> (num_events_in &gt; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n[1]) {
<a name="l04652"></a>04652                   status = <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l04653"></a>04653                   <span class="keywordflow">break</span>;
<a name="l04654"></a>04654                }
<a name="l04655"></a>04655                <span class="keywordflow">if</span> (num_events_in &lt; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n[0])
<a name="l04656"></a>04656                   skip = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04657"></a>04657                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n[2] &gt; 0 &amp;&amp; num_events_in % <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n[2] != 0)
<a name="l04658"></a>04658                   skip = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04659"></a>04659             }
<a name="l04660"></a>04660          }
<a name="l04661"></a>04661       }
<a name="l04662"></a>04662 
<a name="l04663"></a>04663       <span class="keywordflow">if</span> (!skip) {
<a name="l04664"></a>04664          <span class="comment">/* find request belonging to this event */</span>
<a name="l04665"></a>04665          par = analyze_request;
<a name="l04666"></a>04666          status = <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l04667"></a>04667          <span class="keywordflow">for</span> (i = 0; par-&gt;<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; par++)
<a name="l04668"></a>04668             <span class="keywordflow">if</span> ((par-&gt;<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="structAR__INFO.html#acb0cf26c5067b0c8eb7a895b70e42f11">event_id</a> == <a class="code" href="group__mdefineh.html#gabd88aa902705997125b541db3b94578c">EVENTID_ALL</a> ||
<a name="l04669"></a>04669                  par-&gt;<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="structAR__INFO.html#acb0cf26c5067b0c8eb7a895b70e42f11">event_id</a> == pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>) &amp;&amp;
<a name="l04670"></a>04670                 (par-&gt;<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="group__midasincludecode.html#ga947c408489c2b8cd8ea2fc8b2df83388">trigger_mask</a> == <a class="code" href="group__mdefineh.html#ga26aa4bcea89857cb7ca669339695ceac">TRIGGER_ALL</a> ||
<a name="l04671"></a>04671                  (par-&gt;<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="group__midasincludecode.html#ga947c408489c2b8cd8ea2fc8b2df83388">trigger_mask</a> &amp; pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>)) &amp;&amp;
<a name="l04672"></a>04672                 par-&gt;<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="group__midasincludecode.html#ga00b6cb7dc5fefe2d78d04caf3eb257cd">enabled</a>) {
<a name="l04673"></a>04673                <span class="comment">/* analyze this event */</span>
<a name="l04674"></a>04674                status = <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(par, pevent);
<a name="l04675"></a>04675                <span class="keywordflow">if</span> (status == <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l04676"></a>04676                   num_events_out++;
<a name="l04677"></a>04677                <span class="keywordflow">if</span> (status &lt; 0 || status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)        <span class="comment">/* disk full/stop analyzer */</span>
<a name="l04678"></a>04678                   <span class="keywordflow">break</span>;
<a name="l04679"></a>04679 
<a name="l04680"></a>04680                <span class="comment">/* check for Ctrl-C */</span>
<a name="l04681"></a>04681                status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(0);
<a name="l04682"></a>04682             }
<a name="l04683"></a>04683          <span class="keywordflow">if</span> (status &lt; 0 || status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l04684"></a>04684             <span class="keywordflow">break</span>;
<a name="l04685"></a>04685       }
<a name="l04686"></a>04686 
<a name="l04687"></a>04687       <span class="comment">/* update ODB statistics once every 100 events */</span>
<a name="l04688"></a>04688       <span class="keywordflow">if</span> (num_events_in % 100 == 0) {
<a name="l04689"></a>04689          <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l04690"></a>04690          <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet) {
<a name="l04691"></a>04691             <span class="keywordflow">if</span> (out_file)
<a name="l04692"></a>04692                printf(<span class="stringliteral">&quot;%s:%d  %s:%d  events\r&quot;</span>, input_file_name, (<span class="keywordtype">int</span>) num_events_in,
<a name="l04693"></a>04693                       <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename, (<span class="keywordtype">int</span>) num_events_out);
<a name="l04694"></a>04694             <span class="keywordflow">else</span>
<a name="l04695"></a>04695                printf(<span class="stringliteral">&quot;%s:%d  events\r&quot;</span>, input_file_name, (<span class="keywordtype">int</span>) num_events_in);
<a name="l04696"></a>04696 
<a name="l04697"></a>04697 <span class="preprocessor">#ifndef OS_WINNT</span>
<a name="l04698"></a>04698 <span class="preprocessor"></span>            fflush(stdout);
<a name="l04699"></a>04699 <span class="preprocessor">#endif</span>
<a name="l04700"></a>04700 <span class="preprocessor"></span>         }
<a name="l04701"></a>04701       }
<a name="l04702"></a>04702    } <span class="keywordflow">while</span> (1);
<a name="l04703"></a>04703 
<a name="l04704"></a>04704 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l04705"></a>04705 <span class="preprocessor"></span>   PVM_DEBUG(<span class="stringliteral">&quot;analyze_run: event loop finished, status = %d&quot;</span>, status);
<a name="l04706"></a>04706 <span class="preprocessor">#endif</span>
<a name="l04707"></a>04707 <span class="preprocessor"></span>
<a name="l04708"></a>04708    <span class="comment">/* signal EOR to slaves */</span>
<a name="l04709"></a>04709 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l04710"></a>04710 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (pvm_master) {
<a name="l04711"></a>04711       <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l04712"></a>04712          printf(<span class="stringliteral">&quot;\nShutting down distributed analyzers, please wait...\n&quot;</span>);
<a name="l04713"></a>04713       pvm_eor(status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> ? TAG_EXIT : TAG_EOR);
<a name="l04714"></a>04714 
<a name="l04715"></a>04715       <span class="comment">/* merge slave output files */</span>
<a name="l04716"></a>04716       <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename[0] &amp;&amp; !out_append)
<a name="l04717"></a>04717          status = pvm_merge();
<a name="l04718"></a>04718 
<a name="l04719"></a>04719       start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time;
<a name="l04720"></a>04720 
<a name="l04721"></a>04721       <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l04722"></a>04722       <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet) {
<a name="l04723"></a>04723          <span class="keywordflow">if</span> (out_file)
<a name="l04724"></a>04724             printf(<span class="stringliteral">&quot;%s:%d  %s:%d  events, %1.2lfs\n&quot;</span>, input_file_name, num_events_in,
<a name="l04725"></a>04725                    <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename, num_events_out, start_time / 1000.0);
<a name="l04726"></a>04726          <span class="keywordflow">else</span>
<a name="l04727"></a>04727             printf(<span class="stringliteral">&quot;%s:%d  events, %1.2lfs\n&quot;</span>, input_file_name, num_events_in,
<a name="l04728"></a>04728                    start_time / 1000.0);
<a name="l04729"></a>04729       }
<a name="l04730"></a>04730    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pvm_slave) {
<a name="l04731"></a>04731       start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time;
<a name="l04732"></a>04732 
<a name="l04733"></a>04733       <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l04734"></a>04734       <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet) {
<a name="l04735"></a>04735          <span class="keywordflow">if</span> (out_file)
<a name="l04736"></a>04736             printf(<span class="stringliteral">&quot;%s:%d  %s:%d  events, %1.2lfs\n&quot;</span>, input_file_name, num_events_in,
<a name="l04737"></a>04737                    <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename, num_events_out, start_time / 1000.0);
<a name="l04738"></a>04738          <span class="keywordflow">else</span>
<a name="l04739"></a>04739             printf(<span class="stringliteral">&quot;%s:%d  events, %1.2lfs\n&quot;</span>, input_file_name, num_events_in,
<a name="l04740"></a>04740                    start_time / 1000.0);
<a name="l04741"></a>04741       }
<a name="l04742"></a>04742 
<a name="l04743"></a>04743       <a class="code" href="mana_8cpp.html#accdfb5cb6649097a857202444fbc3aa6">eor</a>(current_run_number, error);
<a name="l04744"></a>04744 
<a name="l04745"></a>04745       <span class="comment">/* send back tests */</span>
<a name="l04746"></a>04746       pvm_initsend(<a class="code" href="pvm3_8h.html#a4a488c409eabcd4587ced64938f4c43f">PvmDataInPlace</a>);
<a name="l04747"></a>04747 
<a name="l04748"></a>04748       <span class="keywordflow">for</span> (i = 0; i &lt; n_test; i++)
<a name="l04749"></a>04749          pvm_pkbyte((<span class="keywordtype">char</span> *) tl[i], <span class="keyword">sizeof</span>(<a class="code" href="structANA__TEST.html">ANA_TEST</a>), 1);
<a name="l04750"></a>04750 
<a name="l04751"></a>04751       PVM_DEBUG(<span class="stringliteral">&quot;analyze_run: send %d tests back to master&quot;</span>, n_test);
<a name="l04752"></a>04752 
<a name="l04753"></a>04753       status = pvm_send(pvm_myparent, TAG_EOR);
<a name="l04754"></a>04754       <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l04755"></a>04755          pvm_perror(<span class="stringliteral">&quot;pvm_send&quot;</span>);
<a name="l04756"></a>04756          <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l04757"></a>04757       }
<a name="l04758"></a>04758    } <span class="keywordflow">else</span> {
<a name="l04759"></a>04759       start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time;
<a name="l04760"></a>04760 
<a name="l04761"></a>04761       <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l04762"></a>04762       <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet) {
<a name="l04763"></a>04763          <span class="keywordflow">if</span> (out_file)
<a name="l04764"></a>04764             printf(<span class="stringliteral">&quot;%s:%d  %s:%d  events, %1.2lfs\n&quot;</span>, input_file_name, num_events_in,
<a name="l04765"></a>04765                    <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename, num_events_out, start_time / 1000.0);
<a name="l04766"></a>04766          <span class="keywordflow">else</span>
<a name="l04767"></a>04767             printf(<span class="stringliteral">&quot;%s:%d  events, %1.2lfs\n&quot;</span>, input_file_name, num_events_in,
<a name="l04768"></a>04768                    start_time / 1000.0);
<a name="l04769"></a>04769       }
<a name="l04770"></a>04770 
<a name="l04771"></a>04771       <span class="comment">/* call analyzer eor routines */</span>
<a name="l04772"></a>04772       <a class="code" href="mana_8cpp.html#accdfb5cb6649097a857202444fbc3aa6">eor</a>(current_run_number, error);
<a name="l04773"></a>04773    }
<a name="l04774"></a>04774 <span class="preprocessor">#else</span>
<a name="l04775"></a>04775 <span class="preprocessor"></span>
<a name="l04776"></a>04776    start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time;
<a name="l04777"></a>04777 
<a name="l04778"></a>04778    <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l04779"></a>04779    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet) {
<a name="l04780"></a>04780       <span class="keywordflow">if</span> (out_file)
<a name="l04781"></a>04781          printf(<span class="stringliteral">&quot;%s:%d  %s:%d  events, %1.2lfs\n&quot;</span>, input_file_name, (<span class="keywordtype">int</span>) num_events_in,
<a name="l04782"></a>04782                 <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename, (<span class="keywordtype">int</span>) num_events_out, start_time / 1000.0);
<a name="l04783"></a>04783       <span class="keywordflow">else</span>
<a name="l04784"></a>04784          printf(<span class="stringliteral">&quot;%s:%d  events, %1.2lfs\n&quot;</span>, input_file_name, (<span class="keywordtype">int</span>) num_events_in,
<a name="l04785"></a>04785                 start_time / 1000.0);
<a name="l04786"></a>04786    }
<a name="l04787"></a>04787 
<a name="l04788"></a>04788    <span class="comment">/* call analyzer eor routines */</span>
<a name="l04789"></a>04789    <a class="code" href="mana_8cpp.html#accdfb5cb6649097a857202444fbc3aa6">eor</a>(current_run_number, error);
<a name="l04790"></a>04790 
<a name="l04791"></a>04791 <span class="preprocessor">#endif</span>
<a name="l04792"></a>04792 <span class="preprocessor"></span>
<a name="l04793"></a>04793    <a class="code" href="mana_8cpp.html#a715e03caa3809d9dce4e01e9be5d3232">ma_close</a>(file);
<a name="l04794"></a>04794 
<a name="l04795"></a>04795    free(pevent_unaligned);
<a name="l04796"></a>04796 
<a name="l04797"></a>04797    <span class="keywordflow">return</span> status;
<a name="l04798"></a>04798 }
<a name="l04799"></a>04799 
<a name="l04800"></a>04800 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04801"></a>04801 
<a name="l04802"></a><a class="code" href="mana_8cpp.html#a6b0a51747fb7d6f42a04aa7813d88cd7">04802</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a6b0a51747fb7d6f42a04aa7813d88cd7">loop_runs_offline</a>()
<a name="l04803"></a>04803 {
<a name="l04804"></a>04804    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, status, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>;
<a name="l04805"></a>04805    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a96deaa7886d0996592e850e04aea1795">input_file_name</a>[256], <a class="code" href="mana_8cpp.html#a1be2956569ea7201e80da80d2517ae0f">output_file_name</a>[256], *prn;
<a name="l04806"></a>04806    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l04807"></a>04807 
<a name="l04808"></a>04808    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet)
<a name="l04809"></a>04809       printf(<span class="stringliteral">&quot;Running analyzer offline. Stop with \&quot;!\&quot;\n&quot;</span>);
<a name="l04810"></a>04810 
<a name="l04811"></a>04811    run_number = 0;
<a name="l04812"></a>04812    out_append = ((strchr(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.input_file_name[0], <span class="charliteral">&apos;%&apos;</span>) != NULL) &amp;&amp;
<a name="l04813"></a>04813                  (strchr(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <span class="charliteral">&apos;%&apos;</span>) == NULL)) ||
<a name="l04814"></a>04814        <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.input_file_name[1][0];
<a name="l04815"></a>04815 
<a name="l04816"></a>04816    <span class="comment">/* loop over range of files */</span>
<a name="l04817"></a>04817    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.run_number[0] &gt; 0) {
<a name="l04818"></a>04818       <span class="keywordflow">if</span> (strchr(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.input_file_name[0], <span class="charliteral">&apos;%&apos;</span>) == NULL) {
<a name="l04819"></a>04819          printf
<a name="l04820"></a>04820              (<span class="stringliteral">&quot;Input file name must contain a wildcard like \&quot;%%05d\&quot; when using a range.\n&quot;</span>);
<a name="l04821"></a>04821          <span class="keywordflow">return</span> 0;
<a name="l04822"></a>04822       }
<a name="l04823"></a>04823 
<a name="l04824"></a>04824       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.run_number[0] == 0) {
<a name="l04825"></a>04825          printf(<span class="stringliteral">&quot;End of range not specified.\n&quot;</span>);
<a name="l04826"></a>04826          <span class="keywordflow">return</span> 0;
<a name="l04827"></a>04827       }
<a name="l04828"></a>04828 
<a name="l04829"></a>04829       <span class="keywordflow">for</span> (run_number = <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.run_number[0]; run_number &lt;= <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.run_number[1]; run_number++) {
<a name="l04830"></a>04830          sprintf(input_file_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.input_file_name[0], run_number);
<a name="l04831"></a>04831          <span class="keywordflow">if</span> (strchr(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <span class="charliteral">&apos;%&apos;</span>) != NULL)
<a name="l04832"></a>04832             sprintf(output_file_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, run_number);
<a name="l04833"></a>04833          <span class="keywordflow">else</span>
<a name="l04834"></a>04834             strcpy(output_file_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name);
<a name="l04835"></a>04835 
<a name="l04836"></a>04836          status = <a class="code" href="mana_8cpp.html#ab4bcdcd2d272279d3afbaec8fc7e01a1">analyze_run</a>(run_number, input_file_name, output_file_name);
<a name="l04837"></a>04837          <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l04838"></a>04838             <span class="keywordflow">break</span>;
<a name="l04839"></a>04839       }
<a name="l04840"></a>04840    } <span class="keywordflow">else</span> {
<a name="l04841"></a>04841       <span class="comment">/* loop over input file names */</span>
<a name="l04842"></a>04842       <span class="keywordflow">for</span> (i = 0; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.input_file_name[i][0] &amp;&amp; i &lt; 10; i++) {
<a name="l04843"></a>04843          strcpy(input_file_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.input_file_name[i]);
<a name="l04844"></a>04844 
<a name="l04845"></a>04845          <span class="comment">/* get run number from input file */</span>
<a name="l04846"></a>04846          prn = input_file_name;
<a name="l04847"></a>04847          <span class="keywordflow">while</span> (strchr(prn, <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>) != NULL)
<a name="l04848"></a>04848             prn = strchr(prn, <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>) + 1;
<a name="l04849"></a>04849 
<a name="l04850"></a>04850          <span class="keywordflow">if</span> (strpbrk(prn, <span class="stringliteral">&quot;0123456789&quot;</span>))
<a name="l04851"></a>04851             run_number = atoi(strpbrk(prn, <span class="stringliteral">&quot;0123456789&quot;</span>));
<a name="l04852"></a>04852 
<a name="l04853"></a>04853          <span class="keywordflow">if</span> (strchr(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <span class="charliteral">&apos;%&apos;</span>) != NULL) {
<a name="l04854"></a>04854             <span class="keywordflow">if</span> (run_number == 0) {
<a name="l04855"></a>04855                printf(<span class="stringliteral">&quot;Cannot extract run number from input file name.\n&quot;</span>);
<a name="l04856"></a>04856                <span class="keywordflow">return</span> 0;
<a name="l04857"></a>04857             }
<a name="l04858"></a>04858             sprintf(output_file_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, run_number);
<a name="l04859"></a>04859          } <span class="keywordflow">else</span>
<a name="l04860"></a>04860             strcpy(output_file_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name);
<a name="l04861"></a>04861 
<a name="l04862"></a>04862          status = <a class="code" href="mana_8cpp.html#ab4bcdcd2d272279d3afbaec8fc7e01a1">analyze_run</a>(run_number, input_file_name, output_file_name);
<a name="l04863"></a>04863          <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l04864"></a>04864             <span class="keywordflow">break</span>;
<a name="l04865"></a>04865       }
<a name="l04866"></a>04866    }
<a name="l04867"></a>04867 
<a name="l04868"></a>04868    <span class="comment">/* close output file in append mode */</span>
<a name="l04869"></a>04869    <span class="keywordflow">if</span> (out_file &amp;&amp; out_append) {
<a name="l04870"></a>04870       <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#gac3a857e4820ecdaa22f9a66a560dccad">FORMAT_HBOOK</a>) {
<a name="l04871"></a>04871 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l04872"></a>04872 <span class="preprocessor"></span>         <span class="keywordtype">char</span> str[80];
<a name="l04873"></a>04873 
<a name="l04874"></a>04874          <a class="code" href="hbook_8h.html#aa909f5e02f93a1b3fadcf02ecfb1c460">HROUT</a>(0, i, bstr);
<a name="l04875"></a>04875          strcpy(str, <span class="stringliteral">&quot;OFFLINE&quot;</span>);
<a name="l04876"></a>04876          <a class="code" href="hbook_8h.html#ab87aad0525ef5d5966116b420c2bc24e">HREND</a>(str);
<a name="l04877"></a>04877 <span class="preprocessor">#else</span>
<a name="l04878"></a>04878 <span class="preprocessor"></span>         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;loop_runs_offline&quot;</span>, <span class="stringliteral">&quot;HBOOK support is not compiled in&quot;</span>);
<a name="l04879"></a>04879 <span class="preprocessor">#endif</span>
<a name="l04880"></a>04880 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#ga9663ae12f7cbf4295b3804ebd335e408">FORMAT_ROOT</a>) {
<a name="l04881"></a>04881 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l04882"></a>04882 <span class="preprocessor"></span>         CloseRootOutputFile();
<a name="l04883"></a>04883 <span class="preprocessor">#else</span>
<a name="l04884"></a>04884 <span class="preprocessor"></span>         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;loop_runs_offline&quot;</span>, <span class="stringliteral">&quot;ROOT support is not compiled in&quot;</span>);
<a name="l04885"></a>04885 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l04886"></a>04886       } <span class="keywordflow">else</span> {
<a name="l04887"></a>04887          <span class="keywordflow">if</span> (out_gzip)
<a name="l04888"></a>04888             gzclose(out_file);
<a name="l04889"></a>04889          <span class="keywordflow">else</span>
<a name="l04890"></a>04890             fclose(out_file);
<a name="l04891"></a>04891       }
<a name="l04892"></a>04892 
<a name="l04893"></a>04893       <span class="comment">/* free bank buffer */</span>
<a name="l04894"></a>04894       <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l04895"></a>04895          bank_list = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l04896"></a>04896 
<a name="l04897"></a>04897          <span class="keywordflow">if</span> (bank_list == NULL)
<a name="l04898"></a>04898             <span class="keywordflow">continue</span>;
<a name="l04899"></a>04899 
<a name="l04900"></a>04900          <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++)
<a name="l04901"></a>04901             <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>) {
<a name="l04902"></a>04902                free(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a>);
<a name="l04903"></a>04903                bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga1c924a02fd91149314d805f025d52d40">addr</a> = NULL;
<a name="l04904"></a>04904             }
<a name="l04905"></a>04905       }
<a name="l04906"></a>04906    }
<a name="l04907"></a>04907 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l04908"></a>04908 <span class="preprocessor"></span>   <span class="comment">/* merge slave output files */</span>
<a name="l04909"></a>04909    <span class="keywordflow">if</span> (pvm_master &amp;&amp; <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename[0] &amp;&amp; out_append)
<a name="l04910"></a>04910       pvm_merge();
<a name="l04911"></a>04911 <span class="preprocessor">#endif</span>
<a name="l04912"></a>04912 <span class="preprocessor"></span>
<a name="l04913"></a>04913    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l04914"></a>04914 }
<a name="l04915"></a>04915 
<a name="l04916"></a>04916 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04917"></a>04917 
<a name="l04918"></a>04918 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l04919"></a>04919 <span class="preprocessor"></span>
<a name="l04920"></a>04920 <span class="keywordtype">int</span> pvm_main(<span class="keywordtype">char</span> *argv[])
<a name="l04921"></a>04921 {
<a name="l04922"></a>04922    <span class="keywordtype">int</span> mytid, status, i, j, dtid, *pvm_tid, bufid;
<a name="l04923"></a>04923    <span class="keywordtype">char</span> path[256];
<a name="l04924"></a>04924    <span class="keyword">struct </span>timeval <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>;
<a name="l04925"></a>04925 
<a name="l04926"></a>04926    getcwd(path, 256);
<a name="l04927"></a>04927 
<a name="l04928"></a>04928    mytid = pvm_mytid();
<a name="l04929"></a>04929    <span class="keywordflow">if</span> (mytid &lt; 0) {
<a name="l04930"></a>04930       pvm_perror(<span class="stringliteral">&quot;pvm_mytid&quot;</span>);
<a name="l04931"></a>04931       <span class="keywordflow">return</span> 0;
<a name="l04932"></a>04932    }
<a name="l04933"></a>04933 
<a name="l04934"></a>04934    chdir(path);
<a name="l04935"></a>04935 
<a name="l04936"></a>04936    status = pvm_setopt(<a class="code" href="pvm3_8h.html#aefa7e224938806c6a9b06bf7b4e56c95">PvmRoute</a>, <a class="code" href="pvm3_8h.html#a043b0330118d778e0a2463655b38e820">PvmRouteDirect</a>);
<a name="l04937"></a>04937    <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l04938"></a>04938       pvm_perror(<span class="stringliteral">&quot;pvm_setopt&quot;</span>);
<a name="l04939"></a>04939       pvm_exit();
<a name="l04940"></a>04940       <span class="keywordflow">return</span> 0;
<a name="l04941"></a>04941    }
<a name="l04942"></a>04942 
<a name="l04943"></a>04943    pvm_myparent = pvm_parent();
<a name="l04944"></a>04944    <span class="keywordflow">if</span> (pvm_myparent &lt; 0 &amp;&amp; pvm_myparent != <a class="code" href="pvm3_8h.html#a2c61fb991805dbbe225fbf2f9f19293d">PvmNoParent</a>) {
<a name="l04945"></a>04945       pvm_perror(<span class="stringliteral">&quot;pvm_parent&quot;</span>);
<a name="l04946"></a>04946       pvm_exit();
<a name="l04947"></a>04947       <span class="keywordflow">return</span> 0;
<a name="l04948"></a>04948    }
<a name="l04949"></a>04949 
<a name="l04950"></a>04950    <span class="comment">/* check if master */</span>
<a name="l04951"></a>04951    <span class="keywordflow">if</span> (pvm_myparent == <a class="code" href="pvm3_8h.html#a2c61fb991805dbbe225fbf2f9f19293d">PvmNoParent</a>) {
<a name="l04952"></a>04952       <span class="keyword">struct </span><a class="code" href="structpvmhostinfo.html">pvmhostinfo</a> *hostp;
<a name="l04953"></a>04953       <span class="keywordtype">int</span> n_host, n_arch;
<a name="l04954"></a>04954 
<a name="l04955"></a>04955 <span class="preprocessor">#ifdef WIN32</span>
<a name="l04956"></a>04956 <span class="preprocessor"></span>      <span class="keywordtype">char</span> *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>;
<a name="l04957"></a>04957 
<a name="l04958"></a>04958       <span class="comment">/* use no path, executable must be under $PVM_ROOT$/bin/WIN32 */</span>
<a name="l04959"></a>04959       p = argv[0] + strlen(argv[0]) - 1;
<a name="l04960"></a>04960       <span class="keywordflow">while</span> (p &gt; argv[0] &amp;&amp; *p != <span class="charliteral">&apos;\\&apos;</span>)
<a name="l04961"></a>04961          p--;
<a name="l04962"></a>04962       <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;\\&apos;</span>)
<a name="l04963"></a>04963          p++;
<a name="l04964"></a>04964       strcpy(path, p);
<a name="l04965"></a>04965 <span class="preprocessor">#else</span>
<a name="l04966"></a>04966 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (strchr(argv[0], <span class="charliteral">&apos;/&apos;</span>) == 0) {
<a name="l04967"></a>04967          getcwd(path, 256);
<a name="l04968"></a>04968          strcat(path, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l04969"></a>04969          strcat(path, argv[0]);
<a name="l04970"></a>04970       } <span class="keywordflow">else</span>
<a name="l04971"></a>04971          strcpy(path, argv[0]);
<a name="l04972"></a>04972 <span class="preprocessor">#endif</span>
<a name="l04973"></a>04973 <span class="preprocessor"></span>
<a name="l04974"></a>04974       <span class="comment">/* return if no parallelization selected */</span>
<a name="l04975"></a>04975       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n_task == -1)
<a name="l04976"></a>04976          <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l04977"></a>04977 
<a name="l04978"></a>04978       <span class="comment">/* Set number of slaves to start */</span>
<a name="l04979"></a>04979       pvm_config(&amp;n_host, &amp;n_arch, &amp;hostp);
<a name="l04980"></a>04980 
<a name="l04981"></a>04981       pvm_n_task = n_host - 1;
<a name="l04982"></a>04982       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n_task != 0)
<a name="l04983"></a>04983          pvm_n_task = <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n_task;
<a name="l04984"></a>04984 
<a name="l04985"></a>04985       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.n_task != 1 &amp;&amp; pvm_n_task &gt; n_host - 1)
<a name="l04986"></a>04986          pvm_n_task = n_host - 1;
<a name="l04987"></a>04987 
<a name="l04988"></a>04988       <span class="keywordflow">if</span> (pvm_n_task == 0)
<a name="l04989"></a>04989          <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l04990"></a>04990 
<a name="l04991"></a>04991       pvm_master = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04992"></a>04992 
<a name="l04993"></a>04993       pvm_tid = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * pvm_n_task);
<a name="l04994"></a>04994       pvmc = malloc(<span class="keyword">sizeof</span>(PVM_CLIENT) * pvm_n_task);
<a name="l04995"></a>04995 
<a name="l04996"></a>04996       <span class="keywordflow">if</span> (pvm_tid == NULL || pvmc == NULL) {
<a name="l04997"></a>04997          free(pvm_tid);
<a name="l04998"></a>04998          printf(<span class="stringliteral">&quot;Not enough memory to allocate PVM structures.\n&quot;</span>);
<a name="l04999"></a>04999          pvm_exit();
<a name="l05000"></a>05000          <span class="keywordflow">return</span> 0;
<a name="l05001"></a>05001       }
<a name="l05002"></a>05002 
<a name="l05003"></a>05003       memset(pvmc, 0, <span class="keyword">sizeof</span>(PVM_CLIENT) * pvm_n_task);
<a name="l05004"></a>05004 
<a name="l05005"></a>05005       <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++) {
<a name="l05006"></a>05006          pvmc[i].buffer = malloc(<a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>);
<a name="l05007"></a>05007          <span class="keywordflow">if</span> (pvmc[i].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> == NULL) {
<a name="l05008"></a>05008             free(pvm_tid);
<a name="l05009"></a>05009             free(pvmc);
<a name="l05010"></a>05010             printf(<span class="stringliteral">&quot;Not enough memory to allocate PVM buffers.\n&quot;</span>);
<a name="l05011"></a>05011             pvm_exit();
<a name="l05012"></a>05012             <span class="keywordflow">return</span> 0;
<a name="l05013"></a>05013          }
<a name="l05014"></a>05014       }
<a name="l05015"></a>05015 
<a name="l05016"></a>05016       <span class="comment">/* spawn slaves */</span>
<a name="l05017"></a>05017       printf(<span class="stringliteral">&quot;Parallelizing analyzer on %d machines\n&quot;</span>, pvm_n_task);
<a name="l05018"></a>05018       <span class="keywordflow">if</span> (pvm_n_task == 1)
<a name="l05019"></a>05019          status = pvm_spawn(path, argv + 1, <a class="code" href="pvm3_8h.html#a9f8c014fbb08d5a747693fd143b864f0">PvmTaskDefault</a>, NULL, pvm_n_task, pvm_tid);
<a name="l05020"></a>05020       <span class="keywordflow">else</span>
<a name="l05021"></a>05021          status =
<a name="l05022"></a>05022              pvm_spawn(path, argv + 1, <a class="code" href="pvm3_8h.html#a6a2f4905d64686d17b7a45ac4912e15e">PvmTaskHost</a> | <a class="code" href="pvm3_8h.html#a82296bfbcd48f238c42aa3b583f38cc2">PvmHostCompl</a>, <span class="stringliteral">&quot;.&quot;</span>, pvm_n_task,
<a name="l05023"></a>05023                        pvm_tid);
<a name="l05024"></a>05024       <span class="keywordflow">if</span> (status == 0) {
<a name="l05025"></a>05025          pvm_perror(<span class="stringliteral">&quot;pvm_spawn&quot;</span>);
<a name="l05026"></a>05026          pvm_exit();
<a name="l05027"></a>05027          free(pvm_tid);
<a name="l05028"></a>05028          free(pvmc);
<a name="l05029"></a>05029          <span class="keywordflow">return</span> 0;
<a name="l05030"></a>05030       }
<a name="l05031"></a>05031 
<a name="l05032"></a>05032       <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++) {
<a name="l05033"></a>05033          pvmc[i].tid = pvm_tid[i];
<a name="l05034"></a>05034          pvmc[i].wp = 0;
<a name="l05035"></a>05035          pvmc[i].n_events = 0;
<a name="l05036"></a>05036          pvmc[i].time = 0;
<a name="l05037"></a>05037          dtid = pvm_tidtohost(pvm_tid[i]);
<a name="l05038"></a>05038          <span class="keywordflow">for</span> (j = 0; j &lt; n_host; j++)
<a name="l05039"></a>05039             <span class="keywordflow">if</span> (dtid == hostp[j].<a class="code" href="structpvmhostinfo.html#af585c7525dfc84f6b109a2e1aab68045">hi_tid</a>)
<a name="l05040"></a>05040                strcpy(pvmc[i].host, hostp[j].<a class="code" href="structpvmhostinfo.html#ae68121e09d54f3338b1c917bf55e528e">hi_name</a>);
<a name="l05041"></a>05041       }
<a name="l05042"></a>05042 
<a name="l05043"></a>05043       PVM_DEBUG(<span class="stringliteral">&quot;Spawing on hosts:&quot;</span>);
<a name="l05044"></a>05044       <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++)
<a name="l05045"></a>05045          PVM_DEBUG(<span class="stringliteral">&quot;%s&quot;</span>, pvmc[i].host);
<a name="l05046"></a>05046 
<a name="l05047"></a>05047       <span class="keywordflow">if</span> (status &lt; pvm_n_task) {
<a name="l05048"></a>05048          printf(<span class="stringliteral">&quot;Trouble spawning slaves. Aborting. Error codes are:\n&quot;</span>);
<a name="l05049"></a>05049          <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++)
<a name="l05050"></a>05050             printf(<span class="stringliteral">&quot;TID %d %d\n&quot;</span>, i, pvm_tid[i]);
<a name="l05051"></a>05051 
<a name="l05052"></a>05052          pvm_exit();
<a name="l05053"></a>05053          free(pvm_tid);
<a name="l05054"></a>05054          free(pvmc);
<a name="l05055"></a>05055          <span class="keywordflow">return</span> 0;
<a name="l05056"></a>05056       }
<a name="l05057"></a>05057 
<a name="l05058"></a>05058       <span class="comment">/* send slave index */</span>
<a name="l05059"></a>05059       <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++) {
<a name="l05060"></a>05060          pvm_initsend(<a class="code" href="pvm3_8h.html#afc6decb90a987ce3c94cd51d4fca6dff">PvmDataDefault</a>);
<a name="l05061"></a>05061 
<a name="l05062"></a>05062          pvm_pkint(&amp;i, 1, 1);
<a name="l05063"></a>05063 
<a name="l05064"></a>05064          PVM_DEBUG(<span class="stringliteral">&quot;pvm_main: send index to client %d&quot;</span>, i);
<a name="l05065"></a>05065 
<a name="l05066"></a>05066          status = pvm_send(pvmc[i].tid, TAG_INIT);
<a name="l05067"></a>05067          <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05068"></a>05068             pvm_perror(<span class="stringliteral">&quot;pvm_send&quot;</span>);
<a name="l05069"></a>05069             <span class="keywordflow">return</span> 0;
<a name="l05070"></a>05070          }
<a name="l05071"></a>05071       }
<a name="l05072"></a>05072 
<a name="l05073"></a>05073       free(pvm_tid);
<a name="l05074"></a>05074    } <span class="keywordflow">else</span> {
<a name="l05075"></a>05075       <span class="keywordtype">char</span> path[256];
<a name="l05076"></a>05076 
<a name="l05077"></a>05077       pvm_master = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l05078"></a>05078       pvm_slave = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05079"></a>05079 
<a name="l05080"></a>05080       <span class="comment">/* go to path from argv[0] */</span>
<a name="l05081"></a>05081       strcpy(path, argv[0]);
<a name="l05082"></a>05082       <span class="keywordflow">for</span> (i = strlen(path); i &gt; 0 &amp;&amp; path[i] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>; i--)
<a name="l05083"></a>05083          path[i] = 0;
<a name="l05084"></a>05084       <span class="keywordflow">if</span> (i &gt; 0)
<a name="l05085"></a>05085          path[i] = 0;
<a name="l05086"></a>05086 
<a name="l05087"></a>05087       chdir(path);
<a name="l05088"></a>05088       PVM_DEBUG(<span class="stringliteral">&quot;PATH=%s&quot;</span>, path);
<a name="l05089"></a>05089 
<a name="l05090"></a>05090       <span class="comment">/* receive slave index */</span>
<a name="l05091"></a>05091       <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_sec = 10;
<a name="l05092"></a>05092       <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_usec = 0;
<a name="l05093"></a>05093 
<a name="l05094"></a>05094       bufid = pvm_trecv(-1, -1, &amp;<a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>);
<a name="l05095"></a>05095       <span class="keywordflow">if</span> (bufid &lt; 0) {
<a name="l05096"></a>05096          pvm_perror(<span class="stringliteral">&quot;pvm_recv&quot;</span>);
<a name="l05097"></a>05097          <span class="keywordflow">return</span> 0;
<a name="l05098"></a>05098       }
<a name="l05099"></a>05099       <span class="keywordflow">if</span> (bufid == 0) {
<a name="l05100"></a>05100          PVM_DEBUG(<span class="stringliteral">&quot;pvm_main: timeout receiving index, aborting analyzer.\n&quot;</span>);
<a name="l05101"></a>05101          <span class="keywordflow">return</span> 0;
<a name="l05102"></a>05102       }
<a name="l05103"></a>05103 
<a name="l05104"></a>05104       status = pvm_upkint(&amp;pvm_client_index, 1, 1);
<a name="l05105"></a>05105       <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05106"></a>05106          pvm_perror(<span class="stringliteral">&quot;pvm_upkint&quot;</span>);
<a name="l05107"></a>05107          <span class="keywordflow">return</span> 0;
<a name="l05108"></a>05108       }
<a name="l05109"></a>05109 
<a name="l05110"></a>05110       PVM_DEBUG(<span class="stringliteral">&quot;Received client ID %d&quot;</span>, pvm_client_index);
<a name="l05111"></a>05111    }
<a name="l05112"></a>05112 
<a name="l05113"></a>05113    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l05114"></a>05114 }
<a name="l05115"></a>05115 
<a name="l05116"></a>05116 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l05117"></a>05117 
<a name="l05118"></a>05118 <span class="keywordtype">int</span> pvm_send_event(<span class="keywordtype">int</span> index, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent)
<a name="l05119"></a>05119 {
<a name="l05120"></a>05120    <span class="keyword">struct </span>timeval <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>;
<a name="l05121"></a>05121    <span class="keywordtype">int</span> bufid, len, <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, tid, status;
<a name="l05122"></a>05122 
<a name="l05123"></a>05123    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt;= <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>) {
<a name="l05124"></a>05124       printf(<span class="stringliteral">&quot;Event too large (%d) for PVM buffer (%d), analyzer aborted\n&quot;</span>,
<a name="l05125"></a>05125              pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>);
<a name="l05126"></a>05126       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05127"></a>05127    }
<a name="l05128"></a>05128 
<a name="l05129"></a>05129    <span class="comment">/* wait on event request */</span>
<a name="l05130"></a>05130    <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_sec = 60;
<a name="l05131"></a>05131    <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_usec = 0;
<a name="l05132"></a>05132 
<a name="l05133"></a>05133    bufid = pvm_trecv(pvmc[index].tid, -1, &amp;<a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>);
<a name="l05134"></a>05134    <span class="keywordflow">if</span> (bufid &lt; 0) {
<a name="l05135"></a>05135       pvm_perror(<span class="stringliteral">&quot;pvm_recv&quot;</span>);
<a name="l05136"></a>05136       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05137"></a>05137    }
<a name="l05138"></a>05138    <span class="keywordflow">if</span> (bufid == 0) {
<a name="l05139"></a>05139       printf(<span class="stringliteral">&quot;Timeout receiving data requests from %s, aborting analyzer.\n&quot;</span>,
<a name="l05140"></a>05140              pvmc[index].host);
<a name="l05141"></a>05141       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05142"></a>05142    }
<a name="l05143"></a>05143 
<a name="l05144"></a>05144    status = pvm_bufinfo(bufid, &amp;len, &amp;tag, &amp;tid);
<a name="l05145"></a>05145    <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05146"></a>05146       pvm_perror(<span class="stringliteral">&quot;pvm_bufinfo&quot;</span>);
<a name="l05147"></a>05147       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05148"></a>05148    }
<a name="l05149"></a>05149 
<a name="l05150"></a>05150    PVM_DEBUG(<span class="stringliteral">&quot;pvm_send_event: received request from client %d&quot;</span>, index);
<a name="l05151"></a>05151 
<a name="l05152"></a>05152    <span class="comment">/* send event */</span>
<a name="l05153"></a>05153    pvm_initsend(<a class="code" href="pvm3_8h.html#a4a488c409eabcd4587ced64938f4c43f">PvmDataInPlace</a>);
<a name="l05154"></a>05154 
<a name="l05155"></a>05155    pvm_pkbyte((<span class="keywordtype">char</span> *) pevent, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), 1);
<a name="l05156"></a>05156 
<a name="l05157"></a>05157    PVM_DEBUG(<span class="stringliteral">&quot;pvm_send_event: send events to client %d&quot;</span>, index);
<a name="l05158"></a>05158 
<a name="l05159"></a>05159    status = pvm_send(tid, TAG_DATA);
<a name="l05160"></a>05160    <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05161"></a>05161       pvm_perror(<span class="stringliteral">&quot;pvm_send&quot;</span>);
<a name="l05162"></a>05162       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05163"></a>05163    }
<a name="l05164"></a>05164 
<a name="l05165"></a>05165    pvmc[index].time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l05166"></a>05166 
<a name="l05167"></a>05167    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l05168"></a>05168 }
<a name="l05169"></a>05169 
<a name="l05170"></a>05170 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l05171"></a>05171 
<a name="l05172"></a>05172 <span class="keywordtype">int</span> pvm_send_buffer(<span class="keywordtype">int</span> index)
<a name="l05173"></a>05173 {
<a name="l05174"></a>05174    <span class="keyword">struct </span>timeval <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>;
<a name="l05175"></a>05175    <span class="keywordtype">int</span> i, bufid, len, tag, tid, status;
<a name="l05176"></a>05176 
<a name="l05177"></a>05177    PVM_DEBUG(<span class="stringliteral">&quot;pvm_send_buffer: index %d&quot;</span>, index);
<a name="l05178"></a>05178 
<a name="l05179"></a>05179    <span class="keywordflow">if</span> (index == -2) {
<a name="l05180"></a>05180       bufid = pvm_nrecv(-1, -1);
<a name="l05181"></a>05181    } <span class="keywordflow">else</span> {
<a name="l05182"></a>05182       <span class="comment">/* wait on event request with timeout */</span>
<a name="l05183"></a>05183       <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_sec = 60;
<a name="l05184"></a>05184       <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_usec = 0;
<a name="l05185"></a>05185 
<a name="l05186"></a>05186       bufid = pvm_trecv(-1, -1, &amp;<a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>);
<a name="l05187"></a>05187    }
<a name="l05188"></a>05188 
<a name="l05189"></a>05189    <span class="keywordflow">if</span> (bufid &lt; 0) {
<a name="l05190"></a>05190       pvm_perror(<span class="stringliteral">&quot;pvm_recv&quot;</span>);
<a name="l05191"></a>05191       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05192"></a>05192    }
<a name="l05193"></a>05193    <span class="keywordflow">if</span> (bufid == 0) {
<a name="l05194"></a>05194       <span class="keywordflow">if</span> (index == -2)
<a name="l05195"></a>05195          <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l05196"></a>05196 
<a name="l05197"></a>05197       printf(<span class="stringliteral">&quot;Timeout receiving data requests, aborting analyzer.\n&quot;</span>);
<a name="l05198"></a>05198       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05199"></a>05199    }
<a name="l05200"></a>05200 
<a name="l05201"></a>05201    status = pvm_bufinfo(bufid, &amp;len, &amp;tag, &amp;tid);
<a name="l05202"></a>05202    <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05203"></a>05203       pvm_perror(<span class="stringliteral">&quot;pvm_bufinfo&quot;</span>);
<a name="l05204"></a>05204       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05205"></a>05205    }
<a name="l05206"></a>05206 
<a name="l05207"></a>05207    <span class="comment">/* find index of that client */</span>
<a name="l05208"></a>05208    <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++)
<a name="l05209"></a>05209       <span class="keywordflow">if</span> (pvmc[i].tid == tid)
<a name="l05210"></a>05210          <span class="keywordflow">break</span>;
<a name="l05211"></a>05211 
<a name="l05212"></a>05212    <span class="keywordflow">if</span> (i == pvm_n_task) {
<a name="l05213"></a>05213       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;pvm_send_buffer&quot;</span>, <span class="stringliteral">&quot;received message from unknown client %d&quot;</span>, tid);
<a name="l05214"></a>05214       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05215"></a>05215    }
<a name="l05216"></a>05216 
<a name="l05217"></a>05217    PVM_DEBUG(<span class="stringliteral">&quot;pvm_send_buffer: received request from client %d&quot;</span>, i);
<a name="l05218"></a>05218 
<a name="l05219"></a>05219    <span class="comment">/* send event */</span>
<a name="l05220"></a>05220    pvm_initsend(<a class="code" href="pvm3_8h.html#a4a488c409eabcd4587ced64938f4c43f">PvmDataInPlace</a>);
<a name="l05221"></a>05221 
<a name="l05222"></a>05222    pvm_pkbyte((<span class="keywordtype">char</span> *) pvmc[i].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>, pvmc[i].wp, 1);
<a name="l05223"></a>05223 
<a name="l05224"></a>05224    PVM_DEBUG(<span class="stringliteral">&quot;pvm_send_buffer: send %d events (%1.1lfkB) to client %d&quot;</span>,
<a name="l05225"></a>05225              pvmc[i].n_events, pvmc[i].wp / 1024.0, i);
<a name="l05226"></a>05226 
<a name="l05227"></a>05227    status = pvm_send(tid, TAG_DATA);
<a name="l05228"></a>05228    <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05229"></a>05229       pvm_perror(<span class="stringliteral">&quot;pvm_send&quot;</span>);
<a name="l05230"></a>05230       <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05231"></a>05231    }
<a name="l05232"></a>05232 
<a name="l05233"></a>05233    pvmc[i].wp = 0;
<a name="l05234"></a>05234    pvmc[i].n_events = 0;
<a name="l05235"></a>05235    pvmc[i].time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l05236"></a>05236 
<a name="l05237"></a>05237    <span class="comment">/* if specific client is requested and not emptied, try again */</span>
<a name="l05238"></a>05238    <span class="keywordflow">if</span> (index &gt;= 0 &amp;&amp; index != i)
<a name="l05239"></a>05239       <span class="keywordflow">return</span> pvm_send_buffer(index);
<a name="l05240"></a>05240 
<a name="l05241"></a>05241    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l05242"></a>05242 }
<a name="l05243"></a>05243 
<a name="l05244"></a>05244 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l05245"></a>05245 
<a name="l05246"></a>05246 <span class="keywordtype">int</span> pvm_distribute(<a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> * par, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent)
<a name="l05247"></a>05247 {
<a name="l05248"></a>05248    <span class="keywordtype">char</span> str[256];
<a name="l05249"></a>05249    <span class="keywordtype">int</span> i, index, size, status, min, max;
<a name="l05250"></a>05250 
<a name="l05251"></a>05251    <span class="keywordflow">if</span> (par == NULL &amp;&amp; pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> == <a class="code" href="group__mbufferh.html#gaea58a47233f988dd2f9a0320d99734dc">EVENTID_BOR</a>) {
<a name="l05252"></a>05252       <span class="comment">/* distribute ODB dump */</span>
<a name="l05253"></a>05253       <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++) {
<a name="l05254"></a>05254          status = pvm_send_event(i, pevent);
<a name="l05255"></a>05255          <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l05256"></a>05256             <span class="keywordflow">return</span> status;
<a name="l05257"></a>05257       }
<a name="l05258"></a>05258 
<a name="l05259"></a>05259       <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l05260"></a>05260    }
<a name="l05261"></a>05261 
<a name="l05262"></a>05262    size = <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) + pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l05263"></a>05263 
<a name="l05264"></a>05264    <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (par == NULL || (par-&gt;<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="group__midasincludecode.html#ga023ac635bfecdb696c795dc7120209b7">sampling_type</a> &amp; <a class="code" href="group__mdefineh.html#ga42172205845de032a731da642c1e7e0c">GET_FARM</a>) == 0) {
<a name="l05265"></a>05265       <span class="comment">/* if not farmed, copy to all client buffers */</span>
<a name="l05266"></a>05266       <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++) {
<a name="l05267"></a>05267          <span class="comment">/* if buffer full, empty it */</span>
<a name="l05268"></a>05268          <span class="keywordflow">if</span> (pvmc[i].wp + size &gt;= <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.pvm_buf_size) {
<a name="l05269"></a>05269             status = pvm_send_buffer(i);
<a name="l05270"></a>05270             <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l05271"></a>05271                <span class="keywordflow">return</span> status;
<a name="l05272"></a>05272          }
<a name="l05273"></a>05273 
<a name="l05274"></a>05274          <span class="keywordflow">if</span> (size &gt;= <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>) {
<a name="l05275"></a>05275             printf(<span class="stringliteral">&quot;Event too large (%d) for PVM buffer (%d), analyzer aborted\n&quot;</span>,
<a name="l05276"></a>05276                    size, <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>);
<a name="l05277"></a>05277             <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05278"></a>05278          }
<a name="l05279"></a>05279 
<a name="l05280"></a>05280          memcpy(pvmc[i].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> + pvmc[i].wp, pevent, size);
<a name="l05281"></a>05281          pvmc[i].wp += size;
<a name="l05282"></a>05282          pvmc[i].n_events++;
<a name="l05283"></a>05283       }
<a name="l05284"></a>05284    } <span class="keywordflow">else</span> {
<a name="l05285"></a>05285       <span class="comment">/* farmed: look for buffer with lowest level */</span>
<a name="l05286"></a>05286       min = <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>;
<a name="l05287"></a>05287       index = 0;
<a name="l05288"></a>05288       <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++)
<a name="l05289"></a>05289          <span class="keywordflow">if</span> (pvmc[i].wp &lt; min) {
<a name="l05290"></a>05290             min = pvmc[i].wp;
<a name="l05291"></a>05291             index = i;
<a name="l05292"></a>05292          }
<a name="l05293"></a>05293 
<a name="l05294"></a>05294       <span class="comment">/* if buffer full, empty it */</span>
<a name="l05295"></a>05295       <span class="keywordflow">if</span> (pvmc[index].wp + size &gt;= <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.pvm_buf_size) {
<a name="l05296"></a>05296          status = pvm_send_buffer(index);
<a name="l05297"></a>05297          <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l05298"></a>05298             <span class="keywordflow">return</span> status;
<a name="l05299"></a>05299       }
<a name="l05300"></a>05300 
<a name="l05301"></a>05301       <span class="keywordflow">if</span> (pvmc[index].wp + size &gt;= <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>) {
<a name="l05302"></a>05302          printf(<span class="stringliteral">&quot;Event too large (%d) for PVM buffer (%d), analyzer aborted\n&quot;</span>,
<a name="l05303"></a>05303                 size, <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>);
<a name="l05304"></a>05304          <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05305"></a>05305       }
<a name="l05306"></a>05306 
<a name="l05307"></a>05307       <span class="comment">/* copy to &quot;index&quot; buffer */</span>
<a name="l05308"></a>05308       memcpy(pvmc[index].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> + pvmc[index].wp, pevent, size);
<a name="l05309"></a>05309       pvmc[index].wp += size;
<a name="l05310"></a>05310       pvmc[index].n_events++;
<a name="l05311"></a>05311    }
<a name="l05312"></a>05312 
<a name="l05313"></a>05313    sprintf(str, <span class="stringliteral">&quot;%1.3lf:  &quot;</span>, (<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - pvm_start_time) / 1000.0);
<a name="l05314"></a>05314    <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++)
<a name="l05315"></a>05315       <span class="keywordflow">if</span> (i == index)
<a name="l05316"></a>05316          sprintf(str + strlen(str), <span class="stringliteral">&quot;#%d# &quot;</span>, pvmc[i].wp);
<a name="l05317"></a>05317       <span class="keywordflow">else</span>
<a name="l05318"></a>05318          sprintf(str + strlen(str), <span class="stringliteral">&quot;%d &quot;</span>, pvmc[i].wp);
<a name="l05319"></a>05319    <span class="comment">//PVM_DEBUG(str);</span>
<a name="l05320"></a>05320 
<a name="l05321"></a>05321    <span class="comment">/* find min/max buffer level */</span>
<a name="l05322"></a>05322    min = <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>;
<a name="l05323"></a>05323    max = 0;
<a name="l05324"></a>05324    <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++) {
<a name="l05325"></a>05325       <span class="keywordflow">if</span> (pvmc[i].wp &gt; max)
<a name="l05326"></a>05326          max = pvmc[i].wp;
<a name="l05327"></a>05327       <span class="keywordflow">if</span> (pvmc[i].wp &lt; min)
<a name="l05328"></a>05328          min = pvmc[i].wp;
<a name="l05329"></a>05329    }
<a name="l05330"></a>05330 
<a name="l05331"></a>05331    <span class="comment">/* don&apos;t send events if all buffers are less than half full */</span>
<a name="l05332"></a>05332    <span class="keywordflow">if</span> (max &lt; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.pvm_buf_size / 2)
<a name="l05333"></a>05333       <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l05334"></a>05334 
<a name="l05335"></a>05335    <span class="comment">/* if all buffer are more than half full, wait for next request */</span>
<a name="l05336"></a>05336    <span class="keywordflow">if</span> (min &gt; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.pvm_buf_size / 2) {
<a name="l05337"></a>05337       status = pvm_send_buffer(-1);
<a name="l05338"></a>05338       <span class="keywordflow">return</span> status;
<a name="l05339"></a>05339    }
<a name="l05340"></a>05340 
<a name="l05341"></a>05341    <span class="comment">/* probe new requests */</span>
<a name="l05342"></a>05342    status = pvm_send_buffer(-2);
<a name="l05343"></a>05343 
<a name="l05344"></a>05344    <span class="keywordflow">return</span> status;
<a name="l05345"></a>05345 }
<a name="l05346"></a>05346 
<a name="l05347"></a>05347 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l05348"></a>05348 
<a name="l05349"></a>05349 <span class="keywordtype">int</span> pvm_eor(<span class="keywordtype">int</span> eor_tag)
<a name="l05350"></a>05350 {
<a name="l05351"></a>05351    <span class="keyword">struct </span>timeval <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>;
<a name="l05352"></a>05352    <span class="keywordtype">int</span> bufid, len, tag, tid, i, j, status, size;
<a name="l05353"></a>05353    <a class="code" href="structANA__TEST.html">ANA_TEST</a> *tst_buf;
<a name="l05354"></a>05354    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>;
<a name="l05355"></a>05355    <span class="keywordtype">char</span> str[256];
<a name="l05356"></a>05356 
<a name="l05357"></a>05357    printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l05358"></a>05358 
<a name="l05359"></a>05359    <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++)
<a name="l05360"></a>05360       pvmc[i].eor_sent = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l05361"></a>05361 
<a name="l05362"></a>05362    <span class="keywordflow">do</span> {
<a name="l05363"></a>05363       <span class="comment">/* flush remaining buffers */</span>
<a name="l05364"></a>05364       <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_sec = 60;
<a name="l05365"></a>05365       <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_usec = 0;
<a name="l05366"></a>05366 
<a name="l05367"></a>05367       bufid = pvm_trecv(-1, -1, &amp;<a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>);
<a name="l05368"></a>05368       <span class="keywordflow">if</span> (bufid &lt; 0) {
<a name="l05369"></a>05369          pvm_perror(<span class="stringliteral">&quot;pvm_recv&quot;</span>);
<a name="l05370"></a>05370          <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05371"></a>05371       }
<a name="l05372"></a>05372       <span class="keywordflow">if</span> (bufid == 0) {
<a name="l05373"></a>05373          printf(<span class="stringliteral">&quot;Timeout receiving data request, aborting analyzer.\n&quot;</span>);
<a name="l05374"></a>05374          <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05375"></a>05375       }
<a name="l05376"></a>05376 
<a name="l05377"></a>05377       status = pvm_bufinfo(bufid, &amp;len, &amp;tag, &amp;tid);
<a name="l05378"></a>05378       <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05379"></a>05379          pvm_perror(<span class="stringliteral">&quot;pvm_bufinfo&quot;</span>);
<a name="l05380"></a>05380          <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05381"></a>05381       }
<a name="l05382"></a>05382 
<a name="l05383"></a>05383       <span class="comment">/* find index of that client */</span>
<a name="l05384"></a>05384       <span class="keywordflow">for</span> (j = 0; j &lt; pvm_n_task; j++)
<a name="l05385"></a>05385          <span class="keywordflow">if</span> (pvmc[j].tid == tid)
<a name="l05386"></a>05386             <span class="keywordflow">break</span>;
<a name="l05387"></a>05387 
<a name="l05388"></a>05388       <span class="keywordflow">if</span> (j == pvm_n_task) {
<a name="l05389"></a>05389          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;pvm_eor&quot;</span>, <span class="stringliteral">&quot;received message from unknown client %d&quot;</span>, tid);
<a name="l05390"></a>05390          <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05391"></a>05391       }
<a name="l05392"></a>05392 
<a name="l05393"></a>05393       PVM_DEBUG(<span class="stringliteral">&quot;pvm_eor: received request from client %d&quot;</span>, j);
<a name="l05394"></a>05394 
<a name="l05395"></a>05395       <span class="comment">/* send remaining buffer if data available */</span>
<a name="l05396"></a>05396       <span class="keywordflow">if</span> (eor_tag == TAG_EOR &amp;&amp; pvmc[j].wp &gt; 0) {
<a name="l05397"></a>05397          pvm_initsend(<a class="code" href="pvm3_8h.html#a4a488c409eabcd4587ced64938f4c43f">PvmDataInPlace</a>);
<a name="l05398"></a>05398 
<a name="l05399"></a>05399          pvm_pkbyte((<span class="keywordtype">char</span> *) pvmc[j].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>, pvmc[j].wp, 1);
<a name="l05400"></a>05400 
<a name="l05401"></a>05401          PVM_DEBUG(<span class="stringliteral">&quot;pvm_eor: send %d events (%1.1lfkB) to client %d&quot;</span>,
<a name="l05402"></a>05402                    pvmc[j].n_events, pvmc[j].wp / 1024.0, j);
<a name="l05403"></a>05403 
<a name="l05404"></a>05404          status = pvm_send(tid, TAG_DATA);
<a name="l05405"></a>05405          <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05406"></a>05406             pvm_perror(<span class="stringliteral">&quot;pvm_send&quot;</span>);
<a name="l05407"></a>05407             <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05408"></a>05408          }
<a name="l05409"></a>05409 
<a name="l05410"></a>05410          pvmc[j].wp = 0;
<a name="l05411"></a>05411          pvmc[j].n_events = 0;
<a name="l05412"></a>05412          pvmc[j].time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l05413"></a>05413       } <span class="keywordflow">else</span> {
<a name="l05414"></a>05414          <span class="comment">/* send EOR */</span>
<a name="l05415"></a>05415          pvm_initsend(<a class="code" href="pvm3_8h.html#afc6decb90a987ce3c94cd51d4fca6dff">PvmDataDefault</a>);
<a name="l05416"></a>05416 
<a name="l05417"></a>05417          <span class="keywordflow">if</span> (eor_tag == TAG_EOR)
<a name="l05418"></a>05418             PVM_DEBUG(<span class="stringliteral">&quot;pvm_eor: send EOR to client %d&quot;</span>, j);
<a name="l05419"></a>05419          <span class="keywordflow">else</span>
<a name="l05420"></a>05420             PVM_DEBUG(<span class="stringliteral">&quot;pvm_eor: send EXIT to client %d&quot;</span>, j);
<a name="l05421"></a>05421 
<a name="l05422"></a>05422          printf(<span class="stringliteral">&quot;Shutting down %s               \r&quot;</span>, pvmc[j].host);
<a name="l05423"></a>05423          fflush(stdout);
<a name="l05424"></a>05424 
<a name="l05425"></a>05425          status = pvm_send(tid, eor_tag);
<a name="l05426"></a>05426          <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05427"></a>05427             pvm_perror(<span class="stringliteral">&quot;pvm_send&quot;</span>);
<a name="l05428"></a>05428             <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05429"></a>05429          }
<a name="l05430"></a>05430 
<a name="l05431"></a>05431          pvmc[j].eor_sent = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05432"></a>05432 
<a name="l05433"></a>05433          <span class="comment">/* wait for EOR reply */</span>
<a name="l05434"></a>05434          <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_sec = 60;
<a name="l05435"></a>05435          <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>.tv_usec = 0;
<a name="l05436"></a>05436 
<a name="l05437"></a>05437          bufid = pvm_trecv(tid, -1, &amp;<a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>);
<a name="l05438"></a>05438          <span class="keywordflow">if</span> (bufid &lt; 0) {
<a name="l05439"></a>05439             pvm_perror(<span class="stringliteral">&quot;pvm_recv&quot;</span>);
<a name="l05440"></a>05440             <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05441"></a>05441          }
<a name="l05442"></a>05442          <span class="keywordflow">if</span> (bufid == 0) {
<a name="l05443"></a>05443             printf(<span class="stringliteral">&quot;Timeout receiving EOR request, aborting analyzer.\n&quot;</span>);
<a name="l05444"></a>05444             <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05445"></a>05445          }
<a name="l05446"></a>05446 
<a name="l05447"></a>05447          status = pvm_bufinfo(bufid, &amp;len, &amp;tag, &amp;tid);
<a name="l05448"></a>05448          <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l05449"></a>05449             pvm_perror(<span class="stringliteral">&quot;pvm_bufinfo&quot;</span>);
<a name="l05450"></a>05450             <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l05451"></a>05451          }
<a name="l05452"></a>05452 
<a name="l05453"></a>05453          PVM_DEBUG(<span class="stringliteral">&quot;\nGot %d bytes&quot;</span>, len);
<a name="l05454"></a>05454 
<a name="l05455"></a>05455          tst_buf = malloc(len);
<a name="l05456"></a>05456          pvm_upkbyte((<span class="keywordtype">char</span> *) tst_buf, len, 1);
<a name="l05457"></a>05457 
<a name="l05458"></a>05458          <span class="comment">/* write tests to ODB */</span>
<a name="l05459"></a>05459          <span class="keywordflow">for</span> (i = 0; i &lt; (int) (len / <span class="keyword">sizeof</span>(<a class="code" href="structANA__TEST.html">ANA_TEST</a>)); i++) {
<a name="l05460"></a>05460             sprintf(str, <span class="stringliteral">&quot;/%s/Tests/%s&quot;</span>, analyzer_name, tst_buf[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l05461"></a>05461             count = 0;
<a name="l05462"></a>05462             size = <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>);
<a name="l05463"></a>05463             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, str, &amp;count, &amp;size, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l05464"></a>05464             count += tst_buf[i].<a class="code" href="group__midasincludecode.html#ga76f53e0e2afd1fcfc50195a05d715227">count</a>;
<a name="l05465"></a>05465 
<a name="l05466"></a>05466             <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(hDB, 0, str, &amp;count, <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>), 1, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>);
<a name="l05467"></a>05467          }
<a name="l05468"></a>05468 
<a name="l05469"></a>05469          free(tst_buf);
<a name="l05470"></a>05470       }
<a name="l05471"></a>05471 
<a name="l05472"></a>05472       <span class="comment">/* check if EOR sent to all clients */</span>
<a name="l05473"></a>05473       <span class="keywordflow">for</span> (j = 0; j &lt; pvm_n_task; j++)
<a name="l05474"></a>05474          <span class="keywordflow">if</span> (!pvmc[j].eor_sent)
<a name="l05475"></a>05475             <span class="keywordflow">break</span>;
<a name="l05476"></a>05476 
<a name="l05477"></a>05477    } <span class="keywordflow">while</span> (j &lt; pvm_n_task);
<a name="l05478"></a>05478 
<a name="l05479"></a>05479    printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l05480"></a>05480 
<a name="l05481"></a>05481    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l05482"></a>05482 }
<a name="l05483"></a>05483 
<a name="l05484"></a>05484 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l05485"></a>05485 
<a name="l05486"></a>05486 <span class="keywordtype">int</span> pvm_merge()
<a name="l05487"></a>05487 {
<a name="l05488"></a>05488    <span class="keywordtype">int</span> i, j;
<a name="l05489"></a>05489    <span class="keywordtype">char</span> fn[10][8], str[256], <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256], error[256];
<a name="l05490"></a>05490    <span class="keywordtype">char</span> <a class="code" href="mhttpd_8c.html#acbbdcdfacfc8c43d7d6ba5412ea70365">ext</a>[10], *p;
<a name="l05491"></a>05491 
<a name="l05492"></a>05492    strcpy(str, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.filename);
<a name="l05493"></a>05493    <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>) != NULL)
<a name="l05494"></a>05494       sprintf(file_name, str, current_run_number);
<a name="l05495"></a>05495    <span class="keywordflow">else</span>
<a name="l05496"></a>05496       strcpy(file_name, str);
<a name="l05497"></a>05497 
<a name="l05498"></a>05498    <span class="comment">/* check output file extension */</span>
<a name="l05499"></a>05499    out_gzip = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l05500"></a>05500    ext[0] = 0;
<a name="l05501"></a>05501    <span class="keywordflow">if</span> (strchr(file_name, <span class="charliteral">&apos;.&apos;</span>)) {
<a name="l05502"></a>05502       p = file_name + strlen(file_name) - 1;
<a name="l05503"></a>05503       <span class="keywordflow">while</span> (*p != <span class="charliteral">&apos;.&apos;</span>)
<a name="l05504"></a>05504          p--;
<a name="l05505"></a>05505       strcpy(ext, p);
<a name="l05506"></a>05506    }
<a name="l05507"></a>05507    <span class="keywordflow">if</span> (strncmp(ext, <span class="stringliteral">&quot;.gz&quot;</span>, 3) == 0) {
<a name="l05508"></a>05508       out_gzip = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05509"></a>05509       *p = 0;
<a name="l05510"></a>05510       p--;
<a name="l05511"></a>05511       <span class="keywordflow">while</span> (*p != <span class="charliteral">&apos;.&apos;</span> &amp;&amp; p &gt; file_name)
<a name="l05512"></a>05512          p--;
<a name="l05513"></a>05513       strcpy(ext, p);
<a name="l05514"></a>05514    }
<a name="l05515"></a>05515 
<a name="l05516"></a>05516    <span class="keywordflow">if</span> (strncmp(ext, <span class="stringliteral">&quot;.asc&quot;</span>, 4) == 0)
<a name="l05517"></a>05517       out_format = <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>;
<a name="l05518"></a>05518    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(ext, <span class="stringliteral">&quot;.mid&quot;</span>, 4) == 0)
<a name="l05519"></a>05519       out_format = <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>;
<a name="l05520"></a>05520    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(ext, <span class="stringliteral">&quot;.rz&quot;</span>, 3) == 0)
<a name="l05521"></a>05521       out_format = <a class="code" href="group__mdefineh.html#gac3a857e4820ecdaa22f9a66a560dccad">FORMAT_HBOOK</a>;
<a name="l05522"></a>05522    <span class="keywordflow">else</span> {
<a name="l05523"></a>05523       strcpy(error,
<a name="l05524"></a>05524              <span class="stringliteral">&quot;Unknown output data format. Please use file extension .asc, .mid or .rz.\n&quot;</span>);
<a name="l05525"></a>05525       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;pvm_merge&quot;</span>, error);
<a name="l05526"></a>05526       <span class="keywordflow">return</span> 0;
<a name="l05527"></a>05527    }
<a name="l05528"></a>05528 
<a name="l05529"></a>05529    <span class="keywordflow">if</span> (out_format == <a class="code" href="group__mdefineh.html#gac3a857e4820ecdaa22f9a66a560dccad">FORMAT_HBOOK</a>) {
<a name="l05530"></a>05530       <span class="keywordflow">if</span> (pvm_n_task &lt;= 10) {
<a name="l05531"></a>05531          <span class="keywordflow">for</span> (i = 0; i &lt; pvm_n_task; i++)
<a name="l05532"></a>05532             sprintf(fn[i], <span class="stringliteral">&quot;n%d.rz&quot;</span>, i);
<a name="l05533"></a>05533 
<a name="l05534"></a>05534          HMERGE(pvm_n_task, fn, file_name);
<a name="l05535"></a>05535       } <span class="keywordflow">else</span> {
<a name="l05536"></a>05536          <span class="keywordflow">for</span> (i = 0; i &lt;= pvm_n_task / 10; i++) {
<a name="l05537"></a>05537             <span class="keywordflow">for</span> (j = 0; j &lt; 10 &amp;&amp; j + i * 10 &lt; pvm_n_task; j++)
<a name="l05538"></a>05538                sprintf(fn[j], <span class="stringliteral">&quot;n%d.rz&quot;</span>, j + i * 10);
<a name="l05539"></a>05539 
<a name="l05540"></a>05540             sprintf(str, <span class="stringliteral">&quot;t%d.rz&quot;</span>, i);
<a name="l05541"></a>05541             printf(<span class="stringliteral">&quot;Merging %d files to %s:\n&quot;</span>, j, str);
<a name="l05542"></a>05542             HMERGE(j, fn, str);
<a name="l05543"></a>05543          }
<a name="l05544"></a>05544          <span class="keywordflow">for</span> (i = 0; i &lt;= pvm_n_task / 10; i++)
<a name="l05545"></a>05545             sprintf(fn[i], <span class="stringliteral">&quot;t%d.rz&quot;</span>, i);
<a name="l05546"></a>05546 
<a name="l05547"></a>05547          printf(<span class="stringliteral">&quot;Merging %d files to %s:\n&quot;</span>, i, file_name);
<a name="l05548"></a>05548          HMERGE(i, fn, file_name);
<a name="l05549"></a>05549       }
<a name="l05550"></a>05550    }
<a name="l05551"></a>05551 
<a name="l05552"></a>05552    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l05553"></a>05553 }
<a name="l05554"></a>05554 
<a name="l05555"></a>05555 <span class="preprocessor">#endif                          </span><span class="comment">/* PVM */</span>
<a name="l05556"></a>05556 
<a name="l05557"></a>05557 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l05558"></a>05558 
<a name="l05559"></a>05559 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l05560"></a>05560 <span class="preprocessor"></span>
<a name="l05561"></a>05561 <span class="keywordtype">void</span> *server_thread(<span class="keywordtype">void</span> *arg)
<a name="l05562"></a>05562 <span class="comment">/*</span>
<a name="l05563"></a>05563 <span class="comment">  Server histograms to remove clients</span>
<a name="l05564"></a>05564 <span class="comment">*/</span>
<a name="l05565"></a>05565 {
<a name="l05566"></a>05566    <span class="keywordtype">int</span> i;
<a name="l05567"></a>05567    <span class="keywordtype">char</span> str[256];
<a name="l05568"></a>05568 
<a name="l05569"></a>05569    TSocket *s = (TSocket *) arg;
<a name="l05570"></a>05570 
<a name="l05571"></a>05571    <span class="keywordflow">do</span> {
<a name="l05572"></a>05572       <span class="keywordflow">if</span> (s-&gt;Recv(str, <span class="keyword">sizeof</span>(str)) &lt;= 0) {
<a name="l05573"></a>05573          printf(<span class="stringliteral">&quot;Closed connection from %s\n&quot;</span>, s-&gt;GetInetAddress().GetHostName());
<a name="l05574"></a>05574          s-&gt;Close();
<a name="l05575"></a>05575          <span class="keyword">delete</span> s;
<a name="l05576"></a>05576          <span class="keywordflow">return</span> NULL;
<a name="l05577"></a>05577       } <span class="keywordflow">else</span> {
<a name="l05578"></a>05578          printf(<span class="stringliteral">&quot;Received \&quot;%s\&quot;\n&quot;</span>, str);
<a name="l05579"></a>05579 
<a name="l05580"></a>05580          TMessage *mess = <span class="keyword">new</span> TMessage(kMESS_OBJECT);
<a name="l05581"></a>05581 
<a name="l05582"></a>05582          <span class="keywordflow">if</span> (strcmp(str, <span class="stringliteral">&quot;LIST&quot;</span>) == 0) {
<a name="l05583"></a>05583             <span class="comment">/* build name array */</span>
<a name="l05584"></a>05584 
<a name="l05585"></a>05585             TObjArray *names = <span class="keyword">new</span> TObjArray(100);
<a name="l05586"></a>05586 
<a name="l05587"></a>05587             TIter next(<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a>-&gt;GetList());
<a name="l05588"></a>05588             <span class="keywordflow">while</span> (TObject * obj = next())
<a name="l05589"></a>05589                <span class="keywordflow">if</span> (obj-&gt;InheritsFrom(<span class="stringliteral">&quot;TH1&quot;</span>))
<a name="l05590"></a>05590                   names-&gt;Add(<span class="keyword">new</span> TObjString(obj-&gt;GetName()));
<a name="l05591"></a>05591 
<a name="l05592"></a>05592             <span class="comment">/* send &quot;names&quot; array */</span>
<a name="l05593"></a>05593             mess-&gt;Reset();
<a name="l05594"></a>05594             mess-&gt;WriteObject(names);
<a name="l05595"></a>05595             s-&gt;Send(*mess);
<a name="l05596"></a>05596 
<a name="l05597"></a>05597             <span class="keywordflow">for</span> (i = 0; i &lt; names-&gt;GetLast() + 1; i++)
<a name="l05598"></a>05598                <span class="keyword">delete</span>(TObjString *) names-&gt;At(i);
<a name="l05599"></a>05599 
<a name="l05600"></a>05600             <span class="keyword">delete</span> names;
<a name="l05601"></a>05601          }
<a name="l05602"></a>05602 
<a name="l05603"></a>05603          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(str, <span class="stringliteral">&quot;GET&quot;</span>, 3) == 0) {
<a name="l05604"></a>05604             <span class="comment">/* search histo */</span>
<a name="l05605"></a>05605             TObject *obj;
<a name="l05606"></a>05606             TIter next(<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a>-&gt;GetList());
<a name="l05607"></a>05607 
<a name="l05608"></a>05608             <span class="keywordflow">while</span> ((obj = next())) {
<a name="l05609"></a>05609                <span class="keywordflow">if</span> (strcmp(str + 4, obj-&gt;GetName()) == 0)
<a name="l05610"></a>05610                   <span class="keywordflow">break</span>;
<a name="l05611"></a>05611             }
<a name="l05612"></a>05612 
<a name="l05613"></a>05613             <span class="keywordflow">if</span> (!obj) {
<a name="l05614"></a>05614                s-&gt;Send(<span class="stringliteral">&quot;Error&quot;</span>);
<a name="l05615"></a>05615             } <span class="keywordflow">else</span> {
<a name="l05616"></a>05616                <span class="comment">/* send single histo */</span>
<a name="l05617"></a>05617                mess-&gt;Reset();
<a name="l05618"></a>05618                mess-&gt;WriteObject(obj);
<a name="l05619"></a>05619                s-&gt;Send(*mess);
<a name="l05620"></a>05620             }
<a name="l05621"></a>05621          }
<a name="l05622"></a>05622 
<a name="l05623"></a>05623          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(str, <span class="stringliteral">&quot;CLEAR&quot;</span>, 5) == 0) {
<a name="l05624"></a>05624             <span class="comment">/* search histo */</span>
<a name="l05625"></a>05625             TObject *obj;
<a name="l05626"></a>05626             TIter next(<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a>-&gt;GetList());
<a name="l05627"></a>05627 
<a name="l05628"></a>05628             <span class="keywordflow">while</span> ((obj = next())) {
<a name="l05629"></a>05629                <span class="keywordflow">if</span> (strcmp(str + 6, obj-&gt;GetName()) == 0)
<a name="l05630"></a>05630                   <span class="keywordflow">break</span>;
<a name="l05631"></a>05631             }
<a name="l05632"></a>05632 
<a name="l05633"></a>05633             <span class="keywordflow">if</span> (!obj) {
<a name="l05634"></a>05634                s-&gt;Send(<span class="stringliteral">&quot;Error&quot;</span>);
<a name="l05635"></a>05635             } <span class="keywordflow">else</span> {
<a name="l05636"></a>05636                <span class="comment">/* clear histo */</span>
<a name="l05637"></a>05637 <span class="preprocessor">#ifdef OS_LINUX</span>
<a name="l05638"></a>05638 <span class="preprocessor"></span>               TThread::Lock();
<a name="l05639"></a>05639                ((<a class="code" href="c8051F000_8h.html#a4ae730549ffdf484b18e051fcddbe8ff">TH1</a> *) obj)-&gt;Reset();
<a name="l05640"></a>05640                TThread::UnLock();
<a name="l05641"></a>05641 <span class="preprocessor">#endif</span>
<a name="l05642"></a>05642 <span class="preprocessor"></span>
<a name="l05643"></a>05643                <span class="comment">/* send single histo */</span>
<a name="l05644"></a>05644                s-&gt;Send(<span class="stringliteral">&quot;OK&quot;</span>);
<a name="l05645"></a>05645             }
<a name="l05646"></a>05646          }
<a name="l05647"></a>05647 
<a name="l05648"></a>05648          <span class="keyword">delete</span> mess;
<a name="l05649"></a>05649       }
<a name="l05650"></a>05650 
<a name="l05651"></a>05651    } <span class="keywordflow">while</span> (1);                 <span class="comment">/* do forever */</span>
<a name="l05652"></a>05652 }
<a name="l05653"></a>05653 
<a name="l05654"></a>05654 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l05655"></a>05655 
<a name="l05656"></a>05656 <span class="keywordtype">void</span> *root_server_loop(<span class="keywordtype">void</span> *arg)
<a name="l05657"></a>05657 <span class="comment">/*</span>
<a name="l05658"></a>05658 <span class="comment">   Server loop listening for incoming network connections on port</span>
<a name="l05659"></a>05659 <span class="comment">   specified by command line option -s. Starts a searver_thread for </span>
<a name="l05660"></a>05660 <span class="comment">   each connection.</span>
<a name="l05661"></a>05661 <span class="comment">*/</span>
<a name="l05662"></a>05662 {
<a name="l05663"></a>05663    printf(<span class="stringliteral">&quot;Root server listening on port %d...\n&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.root_port);
<a name="l05664"></a>05664    TServerSocket *lsock = <span class="keyword">new</span> TServerSocket(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.root_port, kTRUE);
<a name="l05665"></a>05665 
<a name="l05666"></a>05666    <span class="keywordflow">do</span> {
<a name="l05667"></a>05667       TSocket *s = lsock-&gt;Accept();
<a name="l05668"></a>05668       s-&gt;Send(<span class="stringliteral">&quot;RMSERV 1.0&quot;</span>);
<a name="l05669"></a>05669       printf(<span class="stringliteral">&quot;New connection from %s\n&quot;</span>, s-&gt;GetInetAddress().GetHostName());
<a name="l05670"></a>05670 
<a name="l05671"></a>05671       <span class="comment">/* start a new server thread */</span>
<a name="l05672"></a>05672 <span class="preprocessor">#ifdef OS_LINUX</span>
<a name="l05673"></a>05673 <span class="preprocessor"></span>      TThread *th = <span class="keyword">new</span> TThread(<span class="stringliteral">&quot;server_thread&quot;</span>, server_thread, s);
<a name="l05674"></a>05674       th-&gt;Run();
<a name="l05675"></a>05675 <span class="preprocessor">#endif</span>
<a name="l05676"></a>05676 <span class="preprocessor"></span>   } <span class="keywordflow">while</span> (1);
<a name="l05677"></a>05677 
<a name="l05678"></a>05678    <span class="keywordflow">return</span> NULL;
<a name="l05679"></a>05679 }
<a name="l05680"></a>05680 
<a name="l05681"></a>05681 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l05682"></a>05682 
<a name="l05683"></a>05683 <span class="keywordtype">void</span> *root_event_loop(<span class="keywordtype">void</span> *arg)
<a name="l05684"></a>05684 <span class="comment">/*</span>
<a name="l05685"></a>05685 <span class="comment">  Thread wrapper around main event loop</span>
<a name="l05686"></a>05686 <span class="comment">*/</span>
<a name="l05687"></a>05687 {
<a name="l05688"></a>05688    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online)
<a name="l05689"></a>05689       <a class="code" href="mana_8cpp.html#adce2146eee6315ed1feed2dc301f2427">loop_online</a>();
<a name="l05690"></a>05690    <span class="keywordflow">else</span>
<a name="l05691"></a>05691       <a class="code" href="mana_8cpp.html#a6b0a51747fb7d6f42a04aa7813d88cd7">loop_runs_offline</a>();
<a name="l05692"></a>05692 
<a name="l05693"></a>05693    gSystem-&gt;ExitLoop();
<a name="l05694"></a>05694 
<a name="l05695"></a>05695    <span class="keywordflow">return</span> NULL;
<a name="l05696"></a>05696 }
<a name="l05697"></a>05697 
<a name="l05698"></a>05698 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l05699"></a>05699 
<a name="l05700"></a>05700 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l05701"></a>05701 
<a name="l05702"></a><a class="code" href="mana_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">05702</a> <span class="keywordtype">int</span> <a class="code" href="mucap__compress_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l05703"></a>05703 {
<a name="l05704"></a>05704    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status, size;
<a name="l05705"></a>05705    <span class="keywordtype">char</span> str[256];
<a name="l05706"></a>05706    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l05707"></a>05707 
<a name="l05708"></a>05708    <span class="comment">/* read in command line parameters into clp structure */</span>
<a name="l05709"></a>05709    status = <a class="code" href="mana_8cpp.html#ac965acb06ece6889fd3b68d82ca916c5">getparam</a>(argc, argv);
<a name="l05710"></a>05710    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l05711"></a>05711       <span class="keywordflow">return</span> 1;
<a name="l05712"></a>05712    <span class="comment">/* Determine the run number from the input file - Kiburg 1/24/2008 */</span>
<a name="l05713"></a>05713    <span class="keywordtype">int</span> myrunnumber=0;
<a name="l05714"></a>05714    <span class="keywordtype">int</span> mystrlen=0;
<a name="l05715"></a>05715    <span class="keywordtype">char</span> mystr[256];
<a name="l05716"></a>05716    strcpy(mystr,<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.input_file_name[0]);
<a name="l05717"></a>05717    mystrlen = strlen(mystr);
<a name="l05718"></a>05718    <span class="keywordflow">if</span> (mystrlen&gt;8){ 
<a name="l05719"></a>05719      <span class="keywordtype">char</span> tmpstr[]={mystr[mystrlen-9], 
<a name="l05720"></a>05720                     mystr[mystrlen-8],
<a name="l05721"></a>05721                     mystr[mystrlen-7],
<a name="l05722"></a>05722                     mystr[mystrlen-6], 
<a name="l05723"></a>05723                     mystr[mystrlen-5]};
<a name="l05724"></a>05724      myrunnumber=atoi(tmpstr);
<a name="l05725"></a>05725      printf(<span class="stringliteral">&quot;This file indicates the run number is %d\n&quot;</span>,myrunnumber);
<a name="l05726"></a>05726    }
<a name="l05727"></a>05727    <span class="comment">/* myrunnumber now contains the current run number, or 0 if it was not poss */</span>
<a name="l05728"></a>05728 
<a name="l05729"></a>05729 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l05730"></a>05730 <span class="preprocessor"></span>   <span class="keywordtype">int</span> i;
<a name="l05731"></a>05731 
<a name="l05732"></a>05732    str[0] = 0;
<a name="l05733"></a>05733    <span class="keywordflow">for</span> (i = 0; i &lt; argc; i++) {
<a name="l05734"></a>05734       strcat(str, argv[i]);
<a name="l05735"></a>05735       strcat(str, <span class="stringliteral">&quot; &quot;</span>);
<a name="l05736"></a>05736    }
<a name="l05737"></a>05737    PVM_DEBUG(<span class="stringliteral">&quot;Analyzer started: %s&quot;</span>, str);
<a name="l05738"></a>05738 <span class="preprocessor">#endif</span>
<a name="l05739"></a>05739 <span class="preprocessor"></span>
<a name="l05740"></a>05740 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l05741"></a>05741 <span class="preprocessor"></span>   <span class="keywordtype">char</span> **rargv;
<a name="l05742"></a>05742    <span class="keywordtype">int</span> rargc;
<a name="l05743"></a>05743 
<a name="l05744"></a>05744    <span class="comment">/* copy first argument */</span>
<a name="l05745"></a>05745    rargc = 0;
<a name="l05746"></a>05746    rargv = (<span class="keywordtype">char</span> **) malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *) * 2);
<a name="l05747"></a>05747    rargv[rargc] = (<span class="keywordtype">char</span> *) malloc(strlen(argv[rargc]) + 1);
<a name="l05748"></a>05748    strcpy(rargv[rargc], argv[rargc]);
<a name="l05749"></a>05749    rargc++;
<a name="l05750"></a>05750 
<a name="l05751"></a>05751    <span class="comment">/* append argument &quot;-b&quot; for batch mode without graphics, unless graphics */</span>
<a name="l05752"></a>05752    <span class="comment">/* mode has been requested. */</span>
<a name="l05753"></a>05753    <span class="keywordflow">if</span>(!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.graphics) {
<a name="l05754"></a>05754      rargv[rargc] = (<span class="keywordtype">char</span> *) malloc(3);
<a name="l05755"></a>05755      rargv[rargc++] = <span class="stringliteral">&quot;-b&quot;</span>;
<a name="l05756"></a>05756    }
<a name="l05757"></a>05757    <a class="code" href="MDQ__Amplitude_8cpp.html#afd64558b184072361ea06d2b253ae428">manaApp</a> = <span class="keyword">new</span> TApplication(<span class="stringliteral">&quot;ranalyzer&quot;</span>, &amp;rargc, rargv);
<a name="l05758"></a>05758 
<a name="l05759"></a>05759    <span class="comment">/* free argument memory */</span>
<a name="l05760"></a>05760    free(rargv[0]);
<a name="l05761"></a>05761    <span class="keywordflow">if</span>(rargc == 2) {
<a name="l05762"></a>05762      free(rargv[1]);
<a name="l05763"></a>05763    }
<a name="l05764"></a>05764    free(rargv);
<a name="l05765"></a>05765 
<a name="l05766"></a>05766    <span class="comment">/* default server port */</span>
<a name="l05767"></a>05767    <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.root_port = 9090;
<a name="l05768"></a>05768 <span class="preprocessor">#endif</span>
<a name="l05769"></a>05769 <span class="preprocessor"></span>
<a name="l05770"></a>05770    <span class="comment">/* get default from environment */</span>
<a name="l05771"></a>05771    <a class="code" href="patch__mevb_8cpp.html#aa598123f60ccd5496f2421c7bf2fabbf">cm_get_environment</a>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.host_name, <span class="keyword">sizeof</span>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.host_name), <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.exp_name,
<a name="l05772"></a>05772                       <span class="keyword">sizeof</span>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.exp_name));
<a name="l05773"></a>05773 
<a name="l05774"></a>05774 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l05775"></a>05775 <span class="preprocessor"></span>   <span class="comment">/* set default lrec size */</span>
<a name="l05776"></a>05776    <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.lrec = <a class="code" href="mana_8cpp.html#a4f4d653810d83035206144299458b3d0">HBOOK_LREC</a>;
<a name="l05777"></a>05777 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l05778"></a>05778 
<a name="l05779"></a>05779 
<a name="l05780"></a>05780    <span class="comment">/* become a daemon */</span>
<a name="l05781"></a>05781    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.daemon) {
<a name="l05782"></a>05782       printf(<span class="stringliteral">&quot;Becoming a daemon...\n&quot;</span>);
<a name="l05783"></a>05783       <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05784"></a>05784       <a class="code" href="group__msystemincludecode.html#ga957613d29ce8b6e66f075ace4f32c1e1">ss_daemon_init</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l05785"></a>05785    } 
<a name="l05786"></a>05786  
<a name="l05787"></a>05787    <span class="comment">/* set default buffer size */</span>
<a name="l05788"></a>05788    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.pvm_buf_size == 0)
<a name="l05789"></a>05789       <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.pvm_buf_size = 512 * 1024;
<a name="l05790"></a>05790    <span class="keywordflow">else</span>
<a name="l05791"></a>05791       <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.pvm_buf_size *= 1024;
<a name="l05792"></a>05792    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.pvm_buf_size &gt; <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a>) {
<a name="l05793"></a>05793       printf(<span class="stringliteral">&quot;Buffer size cannot be larger than %dkB\n&quot;</span>, <a class="code" href="mana_8cpp.html#a87dfd475372bf9bce289d185b3bc5cf4">PVM_BUFFER_SIZE</a> / 1024);
<a name="l05794"></a>05794       <span class="keywordflow">return</span> 1;
<a name="l05795"></a>05795    }
<a name="l05796"></a>05796 
<a name="l05797"></a>05797    <span class="comment">/* set online mode if no input filename is given */</span>
<a name="l05798"></a>05798    <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online = (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.input_file_name[0][0] == 0);
<a name="l05799"></a>05799 
<a name="l05800"></a>05800   <span class="comment">/* Don&apos;t run offline if MIDAS_DIR is not defined */</span> 
<a name="l05801"></a>05801    <span class="keywordflow">if</span> ( ! <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online ) 
<a name="l05802"></a>05802      { 
<a name="l05803"></a>05803        <span class="keywordflow">if</span> ( !getenv(<span class="stringliteral">&quot;MIDAS_DIR&quot;</span>) ) 
<a name="l05804"></a>05804          { 
<a name="l05805"></a>05805            printf(<span class="stringliteral">&quot;For offline running the directory MIDAS_DIR must be defined\n&quot;</span>); 
<a name="l05806"></a>05806            <span class="keywordflow">return</span> 1; 
<a name="l05807"></a>05807          } 
<a name="l05808"></a>05808      } 
<a name="l05809"></a>05809 
<a name="l05810"></a>05810 
<a name="l05811"></a>05811 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l05812"></a>05812 <span class="preprocessor"></span>   <span class="comment">/* set Ntuple format to RWNT if online */</span>
<a name="l05813"></a>05813    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online || <a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <span class="stringliteral">&quot;OFLN&quot;</span>))
<a name="l05814"></a>05814       <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.rwnt = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05815"></a>05815 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l05816"></a>05816 
<a name="l05817"></a>05817 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l05818"></a>05818 <span class="preprocessor"></span>   status = pvm_main(argv);
<a name="l05819"></a>05819    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l05820"></a>05820       <span class="keywordflow">return</span> 1;
<a name="l05821"></a>05821 <span class="preprocessor">#endif</span>
<a name="l05822"></a>05822 <span class="preprocessor"></span>
<a name="l05823"></a>05823 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l05824"></a>05824 <span class="preprocessor"></span>   <span class="comment">/* workaround for multi-threading with midas system calls */</span>
<a name="l05825"></a>05825    <a class="code" href="group__msystemincludecode.html#gae2d1c335b2d2b6a7d904e36e1a9e1d93">ss_force_single_thread</a>();
<a name="l05826"></a>05826 <span class="preprocessor">#endif</span>
<a name="l05827"></a>05827 <span class="preprocessor"></span>
<a name="l05828"></a>05828    <span class="comment">/* now connect to server */</span>
<a name="l05829"></a>05829    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online) {
<a name="l05830"></a>05830       <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.host_name[0])
<a name="l05831"></a>05831          printf(<span class="stringliteral">&quot;Connect to experiment %s on host %s...&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.exp_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.host_name);
<a name="l05832"></a>05832       <span class="keywordflow">else</span>
<a name="l05833"></a>05833          printf(<span class="stringliteral">&quot;Connect to experiment %s...&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.exp_name);
<a name="l05834"></a>05834    }
<a name="l05835"></a>05835 
<a name="l05836"></a>05836    status =
<a name="l05837"></a>05837        <a class="code" href="group__msectionh.html#gae2c7dedc142d472208e2e67f920b91e2">cm_connect_experiment1</a>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.host_name, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.exp_name, analyzer_name, NULL, odb_size,
<a name="l05838"></a>05838                               <a class="code" href="group__midasincludecode.html#ga277afc8607c7a55aafffc11d69be143c">DEFAULT_WATCHDOG_TIMEOUT</a>);
<a name="l05839"></a>05839 
<a name="l05840"></a>05840    <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga10f9c3f1a23d0f63f86edf36143c849d">CM_UNDEF_EXP</a>) {
<a name="l05841"></a>05841       printf(<span class="stringliteral">&quot;\nError: Experiment \&quot;%s\&quot; not defined.\n&quot;</span>, <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.exp_name);
<a name="l05842"></a>05842       <span class="keywordflow">if</span> (getenv(<span class="stringliteral">&quot;MIDAS_DIR&quot;</span>)) {
<a name="l05843"></a>05843          printf
<a name="l05844"></a>05844              (<span class="stringliteral">&quot;Note that \&quot;MIDAS_DIR\&quot; is defined, which results in a single experiment\n&quot;</span>);
<a name="l05845"></a>05845          printf
<a name="l05846"></a>05846              (<span class="stringliteral">&quot;called \&quot;Default\&quot;. If you want to use the \&quot;exptab\&quot; file, undefine \&quot;MIDAS_DIR\&quot;.\n&quot;</span>);
<a name="l05847"></a>05847       }
<a name="l05848"></a>05848       <span class="keywordflow">return</span> 1;
<a name="l05849"></a>05849    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l05850"></a>05850       <a class="code" href="group__msectionh.html#gabfcb4ad0fdc5fe978b8dc0f606306215">cm_get_error</a>(status, str);
<a name="l05851"></a>05851       printf(<span class="stringliteral">&quot;\nError: %s\n&quot;</span>, str);
<a name="l05852"></a>05852       <span class="keywordflow">return</span> 1;
<a name="l05853"></a>05853    }
<a name="l05854"></a>05854 
<a name="l05855"></a>05855    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online)
<a name="l05856"></a>05856       printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l05857"></a>05857 
<a name="l05858"></a>05858    <span class="comment">/* set online/offline mode */</span>
<a name="l05859"></a>05859    <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;hDB, NULL);
<a name="l05860"></a>05860    <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(hDB, 0, <span class="stringliteral">&quot;/Runinfo/Online Mode&quot;</span>, &amp;<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online, <span class="keyword">sizeof</span>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online), 1,
<a name="l05861"></a>05861                 <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l05862"></a>05862    <span class="comment">/* set run number in the database -- Brendan Kiburg 1/24/2008 */</span>
<a name="l05863"></a>05863    <span class="comment">/* commented out by VT on 11/25/2013 */</span>
<a name="l05864"></a>05864    <span class="comment">//db_set_value(hDB, 0, &quot;/Runinfo/Run number&quot;, &amp;myrunnumber, sizeof(int), 1, TID_INT);</span>
<a name="l05865"></a>05865 
<a name="l05866"></a>05866    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online) {
<a name="l05867"></a>05867       <span class="comment">/* check for duplicate name */</span>
<a name="l05868"></a>05868       status = <a class="code" href="group__msectionh.html#gafe2e23ec2e5c20fbc65ee238bd6cd48e">cm_exist</a>(analyzer_name, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l05869"></a>05869       <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l05870"></a>05870          <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l05871"></a>05871          printf(<span class="stringliteral">&quot;An analyzer named \&quot;%s\&quot; is already running in this experiment.\n&quot;</span>,
<a name="l05872"></a>05872                 analyzer_name);
<a name="l05873"></a>05873          printf
<a name="l05874"></a>05874              (<span class="stringliteral">&quot;Please select another analyzer name in analyzer.c or stop other analyzer.\n&quot;</span>);
<a name="l05875"></a>05875          <span class="keywordflow">return</span> 1;
<a name="l05876"></a>05876       }
<a name="l05877"></a>05877 
<a name="l05878"></a>05878       <span class="comment">/* register transitions if started online */</span>
<a name="l05879"></a>05879       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>, <a class="code" href="patch__mevb_8cpp.html#a6e149fe266abfc4575be750a5ae1d3b0">tr_prestart</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l05880"></a>05880           <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, <a class="code" href="patch__mevb_8cpp.html#a29971c513f4451dd5c79373edd928ca0">tr_stop</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l05881"></a>05881           <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga11713399cfb35e58b8fae045836c0d88">TR_PAUSE</a>, <a class="code" href="crate9_2mfe__mucap_8c.html#a7b3b6a2f570d0b31b1ad13c34536db5a">tr_pause</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l05882"></a>05882           <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">tr_resume</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l05883"></a>05883          printf(<span class="stringliteral">&quot;Failed to start local RPC server&quot;</span>);
<a name="l05884"></a>05884          <span class="keywordflow">return</span> 1;
<a name="l05885"></a>05885       }
<a name="l05886"></a>05886    } <span class="keywordflow">else</span> {
<a name="l05887"></a>05887       <span class="keywordflow">if</span> (!pvm_slave) {         <span class="comment">/* slave could run on same machine... */</span>
<a name="l05888"></a>05888          status = <a class="code" href="group__msectionh.html#gafe2e23ec2e5c20fbc65ee238bd6cd48e">cm_exist</a>(analyzer_name, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l05889"></a>05889          <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l05890"></a>05890             <span class="comment">/* kill hanging previous analyzer */</span>
<a name="l05891"></a>05891             <a class="code" href="group__msectionh.html#ga2bb78358bf566eb83197810aee9c59b5">cm_cleanup</a>(analyzer_name, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l05892"></a>05892 
<a name="l05893"></a>05893             status = <a class="code" href="group__msectionh.html#gafe2e23ec2e5c20fbc65ee238bd6cd48e">cm_exist</a>(analyzer_name, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l05894"></a>05894             <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l05895"></a>05895                <span class="comment">/* analyzer may only run once if offline */</span>
<a name="l05896"></a>05896                status = <a class="code" href="group__msectionh.html#ga5c224ebc90480c8df5bc2a7dd81ff27c">cm_shutdown</a>(analyzer_name, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l05897"></a>05897                <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga76db0fac26b6f3dcdc29ec8b640c5a5f">CM_SHUTDOWN</a>)
<a name="l05898"></a>05898                   printf(<span class="stringliteral">&quot;Previous analyzer stopped\n&quot;</span>);
<a name="l05899"></a>05899             }
<a name="l05900"></a>05900          }
<a name="l05901"></a>05901       }
<a name="l05902"></a>05902    }
<a name="l05903"></a>05903 
<a name="l05904"></a>05904 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l05905"></a>05905 <span class="preprocessor"></span>   <span class="comment">/* register callback for clearing histos */</span>
<a name="l05906"></a>05906    <a class="code" href="group__msectionh.html#gad3115b4913387a49fb131e5144509557">cm_register_function</a>(<a class="code" href="group__mrpcdefineh.html#gab04cd68bb2484fcbaa62d2eda3100250">RPC_ANA_CLEAR_HISTOS</a>, <a class="code" href="fal_8c.html#a6286c3b1e900cb783d0b57e910d06f8a">ana_callback</a>);
<a name="l05907"></a>05907 <span class="preprocessor">#endif</span>
<a name="l05908"></a>05908 <span class="preprocessor"></span>
<a name="l05909"></a>05909    <span class="comment">/* turn on keepalive messages */</span>
<a name="l05910"></a>05910    <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="group__midasincludecode.html#ga39d21da28bfcbf0caba6bd19ef551f36">DEFAULT_RPC_TIMEOUT</a>);
<a name="l05911"></a>05911 
<a name="l05912"></a>05912    <span class="comment">/* decrease watchdog timeout in offline mode */</span>
<a name="l05913"></a>05913    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online)
<a name="l05914"></a>05914       <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, 2000);
<a name="l05915"></a>05915 
<a name="l05916"></a>05916    <span class="comment">/* turn off watchdog if in debug mode */</span>
<a name="l05917"></a>05917    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.debug)
<a name="l05918"></a>05918       <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(0, 0);
<a name="l05919"></a>05919 
<a name="l05920"></a>05920    <span class="comment">/* initialize module parameters */</span>
<a name="l05921"></a>05921    <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a9527329c5d4ec01a728dfc43ad33b2fa">init_module_parameters</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l05922"></a>05922       <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l05923"></a>05923       <span class="keywordflow">return</span> 1;
<a name="l05924"></a>05924    }
<a name="l05925"></a>05925 
<a name="l05926"></a>05926    <span class="comment">/* create ODB structure for output */</span>
<a name="l05927"></a>05927    sprintf(str, <span class="stringliteral">&quot;/%s/Output&quot;</span>, analyzer_name);
<a name="l05928"></a>05928    <a class="code" href="group__msectionh.html#gaba7341fc6e27b70739734a50b489ef4f">db_check_record</a>(hDB, 0, str, <a class="code" href="fal_8c.html#a7c5689a91d273a5acdde5b6d6fd2a0b0">OUT_INFO_STR</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l05929"></a>05929    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l05930"></a>05930    assert(hkey);
<a name="l05931"></a>05931    size = <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>);
<a name="l05932"></a>05932    <a class="code" href="group__msectionh.html#gaae4cf88eaadf5d2dd9eefa3e1b6389e6">db_get_record</a>(hDB, hkey, &amp;<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>, &amp;size, 0);
<a name="l05933"></a>05933 
<a name="l05934"></a>05934 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l05935"></a>05935 <span class="preprocessor"></span>   <span class="comment">/* create the directory for analyzer histograms */</span>
<a name="l05936"></a>05936    <a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a> = <span class="keyword">new</span> TDirectory(<span class="stringliteral">&quot;MidasHists&quot;</span>, <span class="stringliteral">&quot;MIDAS Analyzer Histograms&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05937"></a>05937    assert(<a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a> != NULL);
<a name="l05938"></a>05938 
<a name="l05939"></a>05939    <span class="comment">/* make all ROOT objects created in user module init() functions to into gManaHistsDir */</span>
<a name="l05940"></a>05940    <a class="code" href="MDQ__Amplitude_8cpp.html#a0908e10bfc0059b6be675134c75599d4">gManaHistsDir</a>-&gt;cd();
<a name="l05941"></a>05941 
<a name="l05942"></a>05942    <span class="comment">/* convert .rz names to .root names */</span>
<a name="l05943"></a>05943    <span class="keywordflow">if</span> (strstr(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.last_histo_filename, <span class="stringliteral">&quot;.rz&quot;</span>))
<a name="l05944"></a>05944       strcpy(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.last_histo_filename, <span class="stringliteral">&quot;last.root&quot;</span>);
<a name="l05945"></a>05945 
<a name="l05946"></a>05946    <span class="keywordflow">if</span> (strstr(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.histo_dump_filename, <span class="stringliteral">&quot;.rz&quot;</span>))
<a name="l05947"></a>05947       strcpy(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.histo_dump_filename, <span class="stringliteral">&quot;his%05d.root&quot;</span>);
<a name="l05948"></a>05948 
<a name="l05949"></a>05949    <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(hDB, hkey, &amp;<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>, <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>), 0);
<a name="l05950"></a>05950 
<a name="l05951"></a>05951 <span class="preprocessor">#ifdef OS_LINUX</span>
<a name="l05952"></a>05952 <span class="preprocessor"></span>   <span class="comment">/* start socket server */</span>
<a name="l05953"></a>05953    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online &amp;&amp; <a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.root_port) {
<a name="l05954"></a>05954       TThread *th1 = <span class="keyword">new</span> TThread(<span class="stringliteral">&quot;root_server_loop&quot;</span>, root_server_loop, NULL);
<a name="l05955"></a>05955       th1-&gt;Run();
<a name="l05956"></a>05956    }
<a name="l05957"></a>05957 <span class="preprocessor">#endif</span>
<a name="l05958"></a>05958 <span class="preprocessor"></span>
<a name="l05959"></a>05959 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_ROOT */</span>
<a name="l05960"></a>05960 
<a name="l05961"></a>05961 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l05962"></a>05962 <span class="preprocessor"></span>   <span class="comment">/* convert .root names to .rz names */</span>
<a name="l05963"></a>05963    <span class="keywordflow">if</span> (strstr(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.last_histo_filename, <span class="stringliteral">&quot;.root&quot;</span>))
<a name="l05964"></a>05964       strcpy(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.last_histo_filename, <span class="stringliteral">&quot;last.rz&quot;</span>);
<a name="l05965"></a>05965 
<a name="l05966"></a>05966    <span class="keywordflow">if</span> (strstr(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.histo_dump_filename, <span class="stringliteral">&quot;.root&quot;</span>))
<a name="l05967"></a>05967       strcpy(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.histo_dump_filename, <span class="stringliteral">&quot;his%05d.rz&quot;</span>);
<a name="l05968"></a>05968 
<a name="l05969"></a>05969    <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(hDB, hkey, &amp;<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>, <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>), 0);
<a name="l05970"></a>05970 <span class="preprocessor">#endif</span>
<a name="l05971"></a>05971 <span class="preprocessor"></span>
<a name="l05972"></a>05972 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l05973"></a>05973 <span class="preprocessor"></span>   <span class="comment">/* create global memory */</span>
<a name="l05974"></a>05974    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online) {
<a name="l05975"></a>05975       <a class="code" href="hbook_8h.html#ac41e1ed0bb8347eadf199c22a759b0ba">HLIMAP</a>(pawc_size / 4, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.global_memory_name);
<a name="l05976"></a>05976       printf(<span class="stringliteral">&quot;\nGLOBAL MEMORY NAME = %s\n&quot;</span>, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.global_memory_name);
<a name="l05977"></a>05977    } <span class="keywordflow">else</span> {
<a name="l05978"></a>05978       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.output_file_name, <span class="stringliteral">&quot;OFLN&quot;</span>)) {
<a name="l05979"></a>05979          strcpy(str, <span class="stringliteral">&quot;OFLN&quot;</span>);
<a name="l05980"></a>05980          <a class="code" href="hbook_8h.html#ac41e1ed0bb8347eadf199c22a759b0ba">HLIMAP</a>(pawc_size / 4, str);
<a name="l05981"></a>05981          printf(<span class="stringliteral">&quot;\nGLOBAL MEMORY NAME = %s\n&quot;</span>, <span class="stringliteral">&quot;OFLN&quot;</span>);
<a name="l05982"></a>05982       } <span class="keywordflow">else</span>
<a name="l05983"></a>05983          <a class="code" href="hbook_8h.html#a91bcdef204bed62580e3bae742de1a24">HLIMIT</a>(pawc_size / 4);
<a name="l05984"></a>05984    }
<a name="l05985"></a>05985 <span class="preprocessor">#endif                          </span><span class="comment">/* HAVE_HBOOK */</span>
<a name="l05986"></a>05986 
<a name="l05987"></a>05987 <span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l05988"></a>05988 <span class="preprocessor"></span>   <span class="comment">/* load histos from last.xxx */</span>
<a name="l05989"></a>05989    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online)
<a name="l05990"></a>05990       <a class="code" href="mana_8cpp.html#a0e79fc9202ddba8e379b10912fe709aa">load_last_histos</a>();
<a name="l05991"></a>05991 <span class="preprocessor">#endif</span>
<a name="l05992"></a>05992 <span class="preprocessor"></span>
<a name="l05993"></a>05993    <span class="comment">/* analyzer init function */</span>
<a name="l05994"></a>05994    <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a12f9d4b93e18856d7ea847512163fc3b">mana_init</a>() != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l05995"></a>05995       <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l05996"></a>05996       <span class="keywordflow">return</span> 1;
<a name="l05997"></a>05997    }
<a name="l05998"></a>05998 <span class="preprocessor">#ifdef HAVE_HBOOK</span>
<a name="l05999"></a>05999 <span class="preprocessor"></span>   <span class="comment">/* load histos from last.xxx */</span>
<a name="l06000"></a>06000    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online)
<a name="l06001"></a>06001       <a class="code" href="mana_8cpp.html#a0e79fc9202ddba8e379b10912fe709aa">load_last_histos</a>();
<a name="l06002"></a>06002 <span class="preprocessor">#endif</span>
<a name="l06003"></a>06003 <span class="preprocessor"></span>
<a name="l06004"></a>06004    <span class="comment">/* reqister event requests */</span>
<a name="l06005"></a>06005    <a class="code" href="fal_8c.html#a1a2128d90a2986636c9e80968c0d5c67">register_requests</a>();
<a name="l06006"></a>06006 
<a name="l06007"></a>06007    <span class="comment">/* initialize ss_getchar */</span>
<a name="l06008"></a>06008    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet &amp;&amp; !pvm_slave)
<a name="l06009"></a>06009       <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(0);
<a name="l06010"></a>06010 
<a name="l06011"></a>06011   <span class="comment">/*---- start main loop ----*/</span>
<a name="l06012"></a>06012 
<a name="l06013"></a>06013 <span class="comment">/* multi-threaded root server only under Linux */</span>
<a name="l06014"></a>06014 <span class="comment">//#if defined(HAVE_ROOT) &amp;&amp; defined(OS_LINUX)</span>
<a name="l06015"></a>06015 <span class="preprocessor">#if 0</span>
<a name="l06016"></a>06016 <span class="preprocessor"></span>   <span class="comment">/* start event thread */</span>
<a name="l06017"></a>06017    TThread *th2 = <span class="keyword">new</span> TThread(<span class="stringliteral">&quot;root_event_loop&quot;</span>, root_event_loop, NULL);
<a name="l06018"></a>06018    th2-&gt;Run();
<a name="l06019"></a>06019 
<a name="l06020"></a>06020    <a class="code" href="MDQ__Amplitude_8cpp.html#afd64558b184072361ea06d2b253ae428">manaApp</a>-&gt;Run();
<a name="l06021"></a>06021 <span class="preprocessor">#else</span>
<a name="l06022"></a>06022 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_ROOT</span>
<a name="l06023"></a>06023 <span class="preprocessor"></span>   <span class="keywordflow">if</span>(<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.graphics){
<a name="l06024"></a>06024      <span class="comment">/* start event thread */</span>
<a name="l06025"></a>06025      TThread *th2 = <span class="keyword">new</span> TThread(<span class="stringliteral">&quot;root_event_loop&quot;</span>, root_event_loop, NULL);
<a name="l06026"></a>06026      th2-&gt;Run();
<a name="l06027"></a>06027      
<a name="l06028"></a>06028      <a class="code" href="MDQ__Amplitude_8cpp.html#afd64558b184072361ea06d2b253ae428">manaApp</a>-&gt;Run();
<a name="l06029"></a>06029    }
<a name="l06030"></a>06030 <span class="preprocessor">#endif // HAVE_ROOT</span>
<a name="l06031"></a>06031 <span class="preprocessor"></span>
<a name="l06032"></a>06032    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online)
<a name="l06033"></a>06033       <a class="code" href="mana_8cpp.html#adce2146eee6315ed1feed2dc301f2427">loop_online</a>();
<a name="l06034"></a>06034    <span class="keywordflow">else</span>
<a name="l06035"></a>06035       <a class="code" href="mana_8cpp.html#a6b0a51747fb7d6f42a04aa7813d88cd7">loop_runs_offline</a>();
<a name="l06036"></a>06036 <span class="preprocessor">#endif</span>
<a name="l06037"></a>06037 <span class="preprocessor"></span>
<a name="l06038"></a>06038    <span class="comment">/* reset terminal */</span>
<a name="l06039"></a>06039    <span class="keywordflow">if</span> (!<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.quiet &amp;&amp; !pvm_slave)
<a name="l06040"></a>06040       <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l06041"></a>06041 
<a name="l06042"></a>06042    <span class="comment">/* call exit function */</span>
<a name="l06043"></a>06043    <a class="code" href="fal_8c.html#a11a24986d9abfd2f14209cf7c8893f52">mana_exit</a>();
<a name="l06044"></a>06044 
<a name="l06045"></a>06045    <span class="comment">/* save histos to last.xxx */</span>
<a name="l06046"></a>06046    <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a7484bad03a04a43d5913b7a44f9e8199">clp</a>.online)
<a name="l06047"></a>06047       <a class="code" href="mana_8cpp.html#ad767414c61d6a24611888cbdb899af31">save_last_histos</a>();
<a name="l06048"></a>06048 
<a name="l06049"></a>06049 <span class="preprocessor">#ifdef HAVE_PVM</span>
<a name="l06050"></a>06050 <span class="preprocessor"></span>
<a name="l06051"></a>06051    PVM_DEBUG(<span class="stringliteral">&quot;Analyzer stopped&quot;</span>);
<a name="l06052"></a>06052 
<a name="l06053"></a>06053    <span class="comment">/* exit PVM */</span>
<a name="l06054"></a>06054    pvm_exit();
<a name="l06055"></a>06055 
<a name="l06056"></a>06056    <span class="comment">/* if PVM slave, don&apos;t write *SHM file back */</span>
<a name="l06057"></a>06057    <span class="keywordflow">if</span> (pvm_slave)
<a name="l06058"></a>06058       <a class="code" href="group__msfunctionc.html#ga92e8e4e8fae25311b5816a776399a0c1">disable_shm_write</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l06059"></a>06059 
<a name="l06060"></a>06060 <span class="preprocessor">#endif</span>
<a name="l06061"></a>06061 <span class="preprocessor"></span>
<a name="l06062"></a>06062    <span class="comment">/* disconnect from experiment */</span>
<a name="l06063"></a>06063    <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l06064"></a>06064 
<a name="l06065"></a>06065    <span class="keywordflow">return</span> 0;
<a name="l06066"></a>06066 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
