<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ: midas/examples/lowlevel/consume.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>midas/examples/lowlevel/consume.c</h1><a href="consume_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Name:         consume.c</span>
<a name="l00004"></a>00004 <span class="comment">  Created by:   Stefan Ritt</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Contents:     Buffer manager test program. Simple consumer connec-</span>
<a name="l00007"></a>00007 <span class="comment">                ting to a SYSTEM buffer and receiving some data.</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">  $Log: consume.c,v $</span>
<a name="l00010"></a>00010 <span class="comment">  Revision 1.1.1.1  2005/06/20 23:37:11  mucap</span>
<a name="l00011"></a>00011 <span class="comment">  Importing release 1.9.5 of the MIDAS source code as distributed by PSI.</span>
<a name="l00012"></a>00012 <span class="comment">  (Next, I&apos;ll commit our local customizations.)</span>
<a name="l00013"></a>00013 <span class="comment"></span>
<a name="l00014"></a>00014 <span class="comment">  Revision 1.7  2004/05/03 11:30:36  midas</span>
<a name="l00015"></a>00015 <span class="comment">  Implemented cm_query_transition()</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  Revision 1.6  2004/01/08 08:40:09  midas</span>
<a name="l00018"></a>00018 <span class="comment">  Implemented standard indentation</span>
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">  Revision 1.5  2000/03/03 22:48:31  midas</span>
<a name="l00021"></a>00021 <span class="comment">  Changed MDEBUG to MERROR (to see it in the log file)</span>
<a name="l00022"></a>00022 <span class="comment"></span>
<a name="l00023"></a>00023 <span class="comment">  Revision 1.4  2000/03/03 20:55:56  midas</span>
<a name="l00024"></a>00024 <span class="comment">  Added serial number check for multiple events (id&lt;10)</span>
<a name="l00025"></a>00025 <span class="comment"></span>
<a name="l00026"></a>00026 <span class="comment">  Revision 1.3  1999/04/30 13:19:53  midas</span>
<a name="l00027"></a>00027 <span class="comment">  Changed inter-process communication (ss_resume, bm_notify_clients, etc)</span>
<a name="l00028"></a>00028 <span class="comment">  to strings so that server process can receive it&apos;s own watchdog produced</span>
<a name="l00029"></a>00029 <span class="comment">  messages (pass buffer name insteas buffer handle)</span>
<a name="l00030"></a>00030 <span class="comment"></span>
<a name="l00031"></a>00031 <span class="comment">  Revision 1.2  1998/10/12 12:18:59  midas</span>
<a name="l00032"></a>00032 <span class="comment">  Added Log tag in header</span>
<a name="l00033"></a>00033 <span class="comment"></span>
<a name="l00034"></a>00034 <span class="comment"></span>
<a name="l00035"></a>00035 <span class="comment">\********************************************************************/</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="consume_8c.html#a6257e3a612f5456b21fbf6c4afa7d986">00041</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="consume_8c.html#a6257e3a612f5456b21fbf6c4afa7d986">all_flag</a>;
<a name="l00042"></a><a class="code" href="consume_8c.html#aadb2ab70bbe5be9990fd7e3a695d8bdd">00042</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="consume_8c.html#aadb2ab70bbe5be9990fd7e3a695d8bdd">hBufEvent</a>;
<a name="l00043"></a><a class="code" href="consume_8c.html#a881e3cadecfb2fe6d53b7e33e74ac6d2">00043</a> <span class="keywordtype">char</span> <a class="code" href="consume_8c.html#a881e3cadecfb2fe6d53b7e33e74ac6d2">event_buffer</a>[<a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>];
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">/*----- process_message --------------------------------------------*/</span>
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="consume_8c.html#ab0e43e220405cef78640f06420fb2186">00047</a> <span class="keywordtype">void</span> <a class="code" href="consume_8c.html#ab0e43e220405cef78640f06420fb2186">process_message</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="minife_8c.html#ae7ddc6297773b75bea52d05c7a3ff5e5">hBuf</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <span class="keywordtype">id</span>, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pheader, <span class="keywordtype">void</span> *<a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>)
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049    <span class="comment">/* just print message text which comes after event header */</span>
<a name="l00050"></a>00050    printf(<span class="stringliteral">&quot;%s\n&quot;</span>, message);
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">/*----- process_message --------------------------------------------*/</span>
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="consume_8c.html#a57ea8e97d5c3956d2893febbe9f6de82">00055</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#aed2a9a6c57de716dc564331cca8f0a85">transition</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error)
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057    printf(<span class="stringliteral">&quot;Transition, run #%d\n&quot;</span>, run_number);
<a name="l00058"></a>00058    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="comment">/*----- process_event ----------------------------------------------*/</span>
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="consume_8c.html#a681f90cedc0c323da19bfef26d8854b5">00063</a> <span class="keywordtype">void</span> <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="minife_8c.html#ae7ddc6297773b75bea52d05c7a3ff5e5">hBuf</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> request_id, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pheader, <span class="keywordtype">void</span> *pevent)
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065    <span class="keyword">static</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> ser[10], <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>, <a class="code" href="old__mevb_8cpp.html#af4211e1ba0e676018599e88cfae3537a">start_time</a>, jam = 0;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mevb_8cpp.html#aa27c44984703cbd8fb250f9d117470c5">stop_time</a>;
<a name="l00068"></a>00068    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, *pdata, id;
<a name="l00069"></a>00069    <a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a> buffer_header;
<a name="l00070"></a>00070    <span class="keywordtype">double</span> rate;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072    <span class="comment">/* accumulate received event size */</span>
<a name="l00073"></a>00073    size = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l00074"></a>00074    <span class="keywordtype">id</span> = pheader-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>;
<a name="l00075"></a>00075    <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &gt; 9)
<a name="l00076"></a>00076       <span class="keywordtype">id</span> = 9;
<a name="l00077"></a>00077    count += size;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079    <span class="comment">/* check if first and last word inside event is equal</span>
<a name="l00080"></a>00080 <span class="comment">      to size to check that nothing was overwritten... */</span>
<a name="l00081"></a>00081 
<a name="l00082"></a>00082    <span class="keywordflow">if</span> (!jam) {
<a name="l00083"></a>00083       <span class="comment">/* only test once */</span>
<a name="l00084"></a>00084       pdata = (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) (pheader + 1);
<a name="l00085"></a>00085       <span class="keywordflow">if</span> (pdata[0] != size || pdata[size / 4 - 1] != size)
<a name="l00086"></a>00086          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;process_event&quot;</span>, <span class="stringliteral">&quot;--&gt; data jam &lt;--&quot;</span>);
<a name="l00087"></a>00087       jam = 1;
<a name="l00088"></a>00088    }
<a name="l00089"></a>00089 
<a name="l00090"></a>00090    <span class="comment">/* if only some events are requested, sleep a little bit</span>
<a name="l00091"></a>00091 <span class="comment">      to simulate a random event consumer */</span>
<a name="l00092"></a>00092    <span class="keywordflow">if</span> (!<a class="code" href="consume_8c.html#a6257e3a612f5456b21fbf6c4afa7d986">all_flag</a>)
<a name="l00093"></a>00093       <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(10);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095    <span class="comment">/* if all events are requested, now check the serial number</span>
<a name="l00096"></a>00096 <span class="comment">      if no events are missing */</span>
<a name="l00097"></a>00097    <span class="keywordflow">if</span> (<a class="code" href="consume_8c.html#a6257e3a612f5456b21fbf6c4afa7d986">all_flag</a> &amp;&amp; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> != ser[<span class="keywordtype">id</span>] + 1)
<a name="l00098"></a>00098       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;process_event&quot;</span>,
<a name="l00099"></a>00099              <span class="stringliteral">&quot;Serial number mismatch: Ser: %ld, OldSer: %ld, ID: %d, size: %ld\n&quot;</span>,
<a name="l00100"></a>00100              pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>, ser[<span class="keywordtype">id</span>], pheader-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, pheader-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l00101"></a>00101 
<a name="l00102"></a>00102    ser[id] = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104    <span class="comment">/* calculate rates each second */</span>
<a name="l00105"></a>00105    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time &gt; 1000) {
<a name="l00106"></a>00106       stop_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l00107"></a>00107       rate = count / 1024.0 / 1024.0 / ((stop_time - start_time) / 1000.0);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109       <span class="comment">/* get information about filling level of the buffer */</span>
<a name="l00110"></a>00110       <a class="code" href="group__msectionh.html#ga2e5fda90530548defcc34d8bbcacf74b">bm_get_buffer_info</a>(<a class="code" href="consume_8c.html#aadb2ab70bbe5be9990fd7e3a695d8bdd">hBufEvent</a>, &amp;buffer_header);
<a name="l00111"></a>00111       size = buffer_header.<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> - buffer_header.<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l00112"></a>00112       <span class="keywordflow">if</span> (size &lt;= 0)
<a name="l00113"></a>00113          size += buffer_header.<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l00114"></a>00114       printf(<span class="stringliteral">&quot;Level: %4.1lf %%, &quot;</span>, 100 - 100.0 * size / buffer_header.<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>);
<a name="l00115"></a>00115 
<a name="l00116"></a>00116       printf(<span class="stringliteral">&quot;Rate: %1.2lf MB/sec\n&quot;</span>, rate);
<a name="l00117"></a>00117       start_time = stop_time;
<a name="l00118"></a>00118       count = 0;
<a name="l00119"></a>00119    }
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="consume_8c.html#a51af30a60f9f02777c6396b8247e356f">00124</a> <a class="code" href="mucap__compress_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>()
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, trans, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>;
<a name="l00127"></a>00127    <span class="keywordtype">char</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[256], <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[32];
<a name="l00128"></a>00128    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>, request_id;
<a name="l00129"></a>00129    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mevb_8cpp.html#a5fecce64b1b883ada4ac0bc410fb3304">last_time</a>;
<a name="l00130"></a>00130    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mdump_8c.html#a4deeb2ac62e5773e359c09b905e99544">via_callback</a>;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132    <span class="comment">/* get parameters */</span>
<a name="l00133"></a>00133 
<a name="l00134"></a>00134    printf(<span class="stringliteral">&quot;ID of event to request: &quot;</span>);
<a name="l00135"></a>00135    <a class="code" href="group__msectionh.html#ga062aca860070d963b86c98e8012dc43a">ss_gets</a>(str, 32);
<a name="l00136"></a>00136    event_id = atoi(str);
<a name="l00137"></a>00137 
<a name="l00138"></a>00138    printf(<span class="stringliteral">&quot;Host to connect: &quot;</span>);
<a name="l00139"></a>00139    <a class="code" href="group__msectionh.html#ga062aca860070d963b86c98e8012dc43a">ss_gets</a>(host_name, 256);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141    printf(<span class="stringliteral">&quot;Get all events (0/1): &quot;</span>);
<a name="l00142"></a>00142    <a class="code" href="group__msectionh.html#ga062aca860070d963b86c98e8012dc43a">ss_gets</a>(str, 32);
<a name="l00143"></a>00143    <a class="code" href="consume_8c.html#a6257e3a612f5456b21fbf6c4afa7d986">all_flag</a> = atoi(str);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145    printf(<span class="stringliteral">&quot;Receive via callback ([y]/n): &quot;</span>);
<a name="l00146"></a>00146    <a class="code" href="group__msectionh.html#ga062aca860070d963b86c98e8012dc43a">ss_gets</a>(str, 32);
<a name="l00147"></a>00147    via_callback = str[0] != <span class="charliteral">&apos;n&apos;</span>;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    <span class="comment">/* connect to experiment */</span>
<a name="l00150"></a>00150    status = <a class="code" href="group__msectionh.html#gae12b15703f10f41044e599520e665f5a">cm_connect_experiment</a>(host_name, <span class="stringliteral">&quot;&quot;</span>,
<a name="l00151"></a>00151                                   <a class="code" href="consume_8c.html#a6257e3a612f5456b21fbf6c4afa7d986">all_flag</a> ? <span class="stringliteral">&quot;Power Consumer&quot;</span> : <span class="stringliteral">&quot;Consumer&quot;</span>, NULL);
<a name="l00152"></a>00152    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l00153"></a>00153       <span class="keywordflow">return</span> 1;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155    <span class="comment">/* open the &quot;system&quot; buffer, 1M size */</span>
<a name="l00156"></a>00156    <a class="code" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer</a>(<span class="stringliteral">&quot;SYSTEM&quot;</span>, <a class="code" href="group__midasincludecode.html#gacc4dda1aaabc9862fe79fd94e0b722bf">EVENT_BUFFER_SIZE</a>, &amp;<a class="code" href="consume_8c.html#aadb2ab70bbe5be9990fd7e3a695d8bdd">hBufEvent</a>);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158    <span class="comment">/* set the buffer cache size */</span>
<a name="l00159"></a>00159    <a class="code" href="group__msectionh.html#ga3d70a1e1e38b6ccf6bde4bc5b436ae5b">bm_set_cache_size</a>(<a class="code" href="consume_8c.html#aadb2ab70bbe5be9990fd7e3a695d8bdd">hBufEvent</a>, 100000, 0);
<a name="l00160"></a>00160 
<a name="l00161"></a>00161    <span class="comment">/* place a request for a specific event id */</span>
<a name="l00162"></a>00162    <a class="code" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event</a>(<a class="code" href="consume_8c.html#aadb2ab70bbe5be9990fd7e3a695d8bdd">hBufEvent</a>, (<a class="code" href="unionWORD.html">WORD</a>) event_id, <a class="code" href="group__mdefineh.html#ga26aa4bcea89857cb7ca669339695ceac">TRIGGER_ALL</a>,
<a name="l00163"></a>00163                     <a class="code" href="consume_8c.html#a6257e3a612f5456b21fbf6c4afa7d986">all_flag</a> ? <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a> : <a class="code" href="group__mdefineh.html#ga94a2c8eedfa072ecaf9f339f14c52a08">GET_SOME</a>, &amp;request_id,
<a name="l00164"></a>00164                     via_callback ? <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a> : NULL);
<a name="l00165"></a>00165 
<a name="l00166"></a>00166    <span class="comment">/* place a request for system messages */</span>
<a name="l00167"></a>00167    <a class="code" href="group__msectionh.html#ga73f40964dfd745537f41ce13fbcc2fa4">cm_msg_register</a>(<a class="code" href="consume_8c.html#ab0e43e220405cef78640f06420fb2186">process_message</a>);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169    <span class="comment">/* place a request for transition notification */</span>
<a name="l00170"></a>00170    <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>, via_callback? <a class="code" href="fal_8c.html#aed2a9a6c57de716dc564331cca8f0a85">transition</a> : NULL);
<a name="l00171"></a>00171 
<a name="l00172"></a>00172    last_time = 0;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174    <span class="keywordflow">do</span> {
<a name="l00175"></a>00175       <span class="keywordflow">if</span> (via_callback)
<a name="l00176"></a>00176          status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(1000);
<a name="l00177"></a>00177       <span class="keywordflow">else</span> {
<a name="l00178"></a>00178          <span class="comment">/* receive event &quot;manually&quot; and call receive_event */</span>
<a name="l00179"></a>00179          size = <span class="keyword">sizeof</span>(<a class="code" href="consume_8c.html#a881e3cadecfb2fe6d53b7e33e74ac6d2">event_buffer</a>);
<a name="l00180"></a>00180          status = <a class="code" href="group__msectionh.html#ga0f5bcc113e8cb6023e1f3a61f6c78c48">bm_receive_event</a>(<a class="code" href="consume_8c.html#aadb2ab70bbe5be9990fd7e3a695d8bdd">hBufEvent</a>, <a class="code" href="consume_8c.html#a881e3cadecfb2fe6d53b7e33e74ac6d2">event_buffer</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>);
<a name="l00181"></a>00181          <span class="keywordflow">if</span> (status == <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l00182"></a>00182             <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(<a class="code" href="consume_8c.html#aadb2ab70bbe5be9990fd7e3a695d8bdd">hBufEvent</a>, request_id, (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="consume_8c.html#a881e3cadecfb2fe6d53b7e33e74ac6d2">event_buffer</a>,
<a name="l00183"></a>00183                           (<span class="keywordtype">void</span> *) (((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) event_buffer) + 1));
<a name="l00184"></a>00184 
<a name="l00185"></a>00185          <span class="comment">/* receive transitions &quot;manually&quot; */</span>
<a name="l00186"></a>00186          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gabcf4eae43ac71e347eb6b7c36d58ae69">cm_query_transition</a>(&amp;trans, &amp;run_number, NULL))
<a name="l00187"></a>00187             <a class="code" href="fal_8c.html#aed2a9a6c57de716dc564331cca8f0a85">transition</a>(run_number, NULL);
<a name="l00188"></a>00188 
<a name="l00189"></a>00189          <span class="comment">/* call yield once every 100 ms */</span>
<a name="l00190"></a>00190          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - last_time &gt; 100) {
<a name="l00191"></a>00191             last_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l00192"></a>00192             status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(0);
<a name="l00193"></a>00193          }
<a name="l00194"></a>00194       }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196    } <span class="keywordflow">while</span> (status != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> &amp;&amp; status != <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198    <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l00199"></a>00199 
<a name="l00200"></a>00200    <span class="keywordflow">return</span> 1;
<a name="l00201"></a>00201 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
