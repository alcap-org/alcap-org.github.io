<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ: midas/src/lazylogger.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>midas/src/lazylogger.c</h1><a href="lazylogger_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment">  Name:         lazylogger.c</span>
<a name="l00003"></a>00003 <span class="comment">  Created by:   Pierre-Andre Amaudruz</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">  Contents:     Disk to Tape copier for background job.</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">  $Log: lazylogger.c,v $</span>
<a name="l00008"></a>00008 <span class="comment">  Revision 1.1.1.1  2005/06/20 23:37:30  mucap</span>
<a name="l00009"></a>00009 <span class="comment">  Importing release 1.9.5 of the MIDAS source code as distributed by PSI.</span>
<a name="l00010"></a>00010 <span class="comment">  (Next, I&apos;ll commit our local customizations.)</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">  Revision 1.39  2004/01/08 08:40:09  midas</span>
<a name="l00013"></a>00013 <span class="comment">  Implemented standard indentation</span>
<a name="l00014"></a>00014 <span class="comment"></span>
<a name="l00015"></a>00015 <span class="comment">  Revision 1.38  2003/12/12 09:50:32  midas</span>
<a name="l00016"></a>00016 <span class="comment">  Changed watchdog_timeout from INT to DWORD to avoid compiler warnings</span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment">  Revision 1.37  2003/12/12 09:48:30  midas</span>
<a name="l00019"></a>00019 <span class="comment">  Removed ^M at each end of line</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">  Revision 1.36  2003/11/11 02:00:25  pierre</span>
<a name="l00022"></a>00022 <span class="comment">  change FTP filename, fix DIR_SEPARATOR for Recover.odb</span>
<a name="l00023"></a>00023 <span class="comment"></span>
<a name="l00024"></a>00024 <span class="comment">  Revision 1.35  2003/11/07 05:51:10  pierre</span>
<a name="l00025"></a>00025 <span class="comment">  delete temp /Programs/Lazy, fix rate</span>
<a name="l00026"></a>00026 <span class="comment"></span>
<a name="l00027"></a>00027 <span class="comment">  Revision 1.34  2003/11/01 00:38:11  olchansk</span>
<a name="l00028"></a>00028 <span class="comment">  abort if cannot read Runinfo/Run number</span>
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">  Revision 1.33  2003/06/12 18:35:51  pierre</span>
<a name="l00031"></a>00031 <span class="comment">  remove ss_tape_get_blockn</span>
<a name="l00032"></a>00032 <span class="comment"></span>
<a name="l00033"></a>00033 <span class="comment">  Revision 1.32  2003/05/09 07:40:04  midas</span>
<a name="l00034"></a>00034 <span class="comment">  Added extra parameter to cm_get_environment</span>
<a name="l00035"></a>00035 <span class="comment"></span>
<a name="l00036"></a>00036 <span class="comment">  Revision 1.31  2003/04/25 04:50:29  pierre</span>
<a name="l00037"></a>00037 <span class="comment">  Fixed compiler warning</span>
<a name="l00038"></a>00038 <span class="comment"></span>
<a name="l00039"></a>00039 <span class="comment">  Revision 1.30  2003/04/15 22:29:45  pierre</span>
<a name="l00040"></a>00040 <span class="comment">  fix for compilation with -Wall</span>
<a name="l00041"></a>00041 <span class="comment"></span>
<a name="l00042"></a>00042 <span class="comment">  Revision 1.29  2002/10/22 03:45:09  pierre</span>
<a name="l00043"></a>00043 <span class="comment">  add SS_NO_TAPE</span>
<a name="l00044"></a>00044 <span class="comment"></span>
<a name="l00045"></a>00045 <span class="comment">  Revision 1.28  2002/09/27 20:03:30  pierre</span>
<a name="l00046"></a>00046 <span class="comment"></span>
<a name="l00047"></a>00047 <span class="comment">  - Add before/after write tape ss_command for script functions</span>
<a name="l00048"></a>00048 <span class="comment">  - Add Modulo.Position option for split lazy channel (see doc)</span>
<a name="l00049"></a>00049 <span class="comment">  - Add Tape Data Append flag for moving to EOD on stream device</span>
<a name="l00050"></a>00050 <span class="comment">  - Add Block number in msg for Tape operation.</span>
<a name="l00051"></a>00051 <span class="comment">  - Corrected msg comments.</span>
<a name="l00052"></a>00052 <span class="comment"></span>
<a name="l00053"></a>00053 <span class="comment">  Revision 1.27  2002/06/03 06:07:14  midas</span>
<a name="l00054"></a>00054 <span class="comment">  Added extra parameter to ss_daemon_init to keep stdout</span>
<a name="l00055"></a>00055 <span class="comment"></span>
<a name="l00056"></a>00056 <span class="comment">  Revision 1.26  2002/05/08 19:54:40  midas</span>
<a name="l00057"></a>00057 <span class="comment">  Added extra parameter to function db_get_value()</span>
<a name="l00058"></a>00058 <span class="comment"></span>
<a name="l00059"></a>00059 <span class="comment">  Revision 1.25  2001/07/25 07:54:01  midas</span>
<a name="l00060"></a>00060 <span class="comment">  Fixed compiler warnings</span>
<a name="l00061"></a>00061 <span class="comment"></span>
<a name="l00062"></a>00062 <span class="comment">  Revision 1.24  2001/07/25 06:53:18  midas</span>
<a name="l00063"></a>00063 <span class="comment">  Fixed bug with appended &quot;/&quot; for tape logging</span>
<a name="l00064"></a>00064 <span class="comment"></span>
<a name="l00065"></a>00065 <span class="comment">  Revision 1.23  2001/07/23 22:58:16  pierre</span>
<a name="l00066"></a>00066 <span class="comment">  - Fix condition line parsing.</span>
<a name="l00067"></a>00067 <span class="comment"></span>
<a name="l00068"></a>00068 <span class="comment">  Revision 1.22  2000/10/17 21:12:39  pierre</span>
<a name="l00069"></a>00069 <span class="comment">  - Return KB rate to B and correct code (*1000)</span>
<a name="l00070"></a>00070 <span class="comment">  - Fix ss_system for single arg</span>
<a name="l00071"></a>00071 <span class="comment"></span>
<a name="l00072"></a>00072 <span class="comment">  Revision 1.21  2000/10/17 20:56:50  pierre</span>
<a name="l00073"></a>00073 <span class="comment">  *** empty log message ***</span>
<a name="l00074"></a>00074 <span class="comment"></span>
<a name="l00075"></a>00075 <span class="comment">  Revision 1.20  2000/10/12 18:59:34  pierre</span>
<a name="l00076"></a>00076 <span class="comment">  - Correct label for &quot;Copy Rate&quot; in KB</span>
<a name="l00077"></a>00077 <span class="comment"></span>
<a name="l00078"></a>00078 <span class="comment">  Revision 1.19  2000/09/29 16:05:48  pierre</span>
<a name="l00079"></a>00079 <span class="comment">  - Fix &amp;arg on db_calls with TID_STRING</span>
<a name="l00080"></a>00080 <span class="comment"></span>
<a name="l00081"></a>00081 <span class="comment">  Revision 1.18  2000/03/30 06:38:35  pierre</span>
<a name="l00082"></a>00082 <span class="comment">  - Added field &quot;../settings/Execute after rewind&quot; for &quot;after rewind&quot; execution.</span>
<a name="l00083"></a>00083 <span class="comment"></span>
<a name="l00084"></a>00084 <span class="comment">  Revision 1.17  1999/12/13 23:23:47  pierre</span>
<a name="l00085"></a>00085 <span class="comment">  - Add rm_time, cp_time in log message</span>
<a name="l00086"></a>00086 <span class="comment">  - Save &lt;channel&gt;_recover.odb with untouched &quot;list label&quot;</span>
<a name="l00087"></a>00087 <span class="comment">  - Change DIR_SEPARATOR to &quot;/&quot; for FTP connection</span>
<a name="l00088"></a>00088 <span class="comment"></span>
<a name="l00089"></a>00089 <span class="comment">  Revision 1.16  1999/12/08 00:38:41  pierre</span>
<a name="l00090"></a>00090 <span class="comment">  - Add creation/update of &quot;&lt;channel&gt;_recover.odb&quot; after each copy</span>
<a name="l00091"></a>00091 <span class="comment"></span>
<a name="l00092"></a>00092 <span class="comment">  Revision 1.15  1999/11/08 15:08:04  midas</span>
<a name="l00093"></a>00093 <span class="comment">  Added new parameters to al_trigger_alarm</span>
<a name="l00094"></a>00094 <span class="comment"></span>
<a name="l00095"></a>00095 <span class="comment">  Revision 1.14  1999/10/22 10:58:56  midas</span>
<a name="l00096"></a>00096 <span class="comment">  Fixed compiler warnings</span>
<a name="l00097"></a>00097 <span class="comment"></span>
<a name="l00098"></a>00098 <span class="comment">  Revision 1.13  1999/10/22 00:30:45  pierre</span>
<a name="l00099"></a>00099 <span class="comment">  - add hot link on settings for maintain space.</span>
<a name="l00100"></a>00100 <span class="comment"></span>
<a name="l00101"></a>00101 <span class="comment">  Revision 1.12  1999/10/18 14:41:50  midas</span>
<a name="l00102"></a>00102 <span class="comment">  Use /programs/&lt;name&gt;/Watchdog timeout in all programs as timeout value. The</span>
<a name="l00103"></a>00103 <span class="comment">  default value can be submitted by calling cm_connect_experiment1(..., timeout)</span>
<a name="l00104"></a>00104 <span class="comment"></span>
<a name="l00105"></a>00105 <span class="comment">  Revision 1.11  1999/10/18 11:40:53  midas</span>
<a name="l00106"></a>00106 <span class="comment">  Changed %9.2e[MB] to %1.3lfMB for NEWS message to be the same as for the COPIED msg.</span>
<a name="l00107"></a>00107 <span class="comment"></span>
<a name="l00108"></a>00108 <span class="comment">  Revision 1.10  1999/10/18 11:31:47  midas</span>
<a name="l00109"></a>00109 <span class="comment">  - Fixed problem that lazy_main returned occasionally before releasing mutex</span>
<a name="l00110"></a>00110 <span class="comment">  - Changed ss_tape_rewind to ss_tape_unload, use increased timeout</span>
<a name="l00111"></a>00111 <span class="comment">  - Changed al_trigger_class to al_trigger_alarm</span>
<a name="l00112"></a>00112 <span class="comment"></span>
<a name="l00113"></a>00113 <span class="comment">  Revision 1.9  1999/10/15 23:13:13  pierre</span>
<a name="l00114"></a>00114 <span class="comment">  - Added synchronization on purge between list and source dir</span>
<a name="l00115"></a>00115 <span class="comment">  - fix duplicated copy bug</span>
<a name="l00116"></a>00116 <span class="comment">  - move mutex outside purge</span>
<a name="l00117"></a>00117 <span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">  Revision 1.8  1999/10/15 12:44:19  midas</span>
<a name="l00119"></a>00119 <span class="comment">  Increase timeout</span>
<a name="l00120"></a>00120 <span class="comment"></span>
<a name="l00121"></a>00121 <span class="comment">  Revision 1.7  1999/10/13 19:31:28  pierre</span>
<a name="l00122"></a>00122 <span class="comment">  - Restore mod from version 1.2 and merge by hand! mod &apos;til 1.6</span>
<a name="l00123"></a>00123 <span class="comment">  - Implement single &quot;Maintain free space&quot; check.</span>
<a name="l00124"></a>00124 <span class="comment">  - change purge free space test to INT (+/- 1%)</span>
<a name="l00125"></a>00125 <span class="comment"></span>
<a name="l00126"></a>00126 <span class="comment">  Revision 1.6  1999/10/13 00:29:26  pierre</span>
<a name="l00127"></a>00127 <span class="comment">  - Added -D for daemon</span>
<a name="l00128"></a>00128 <span class="comment">  - fix return code for ss_file_remove in lazy_main</span>
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="comment">  Revision 1.5  1999/10/08 08:01:09  midas</span>
<a name="l00131"></a>00131 <span class="comment">  Changed format from %lf to %1.0lf for postponed message</span>
<a name="l00132"></a>00132 <span class="comment"></span>
<a name="l00133"></a>00133 <span class="comment">  Revision 1.4  1999/10/08 07:58:18  midas</span>
<a name="l00134"></a>00134 <span class="comment">  Fixed following bugs (hopefully):</span>
<a name="l00135"></a>00135 <span class="comment">  - Error message ss_remove_file was produced in a loop filling up log file,</span>
<a name="l00136"></a>00136 <span class="comment">    now it&apos;s only produced once and the file is nevertheless removed from</span>
<a name="l00137"></a>00137 <span class="comment">    the lazy list.</span>
<a name="l00138"></a>00138 <span class="comment">  - debug variable was not initialized properly</span>
<a name="l00139"></a>00139 <span class="comment">  - &quot;abort postponed..&quot; message used wrong format (%d instead %lf)</span>
<a name="l00140"></a>00140 <span class="comment"></span>
<a name="l00141"></a>00141 <span class="comment">  Revision 1.3  1999/10/07 09:32:54  midas</span>
<a name="l00142"></a>00142 <span class="comment">  Fixed bug that &apos;/&apos; was added to the tape name which caused the lazylogger</span>
<a name="l00143"></a>00143 <span class="comment">  to crash since a device /dev/nst0/ does not exist (OS complains that the</span>
<a name="l00144"></a>00144 <span class="comment">  device is no directory). The additional &apos;/&apos; is now only added in the message.</span>
<a name="l00145"></a>00145 <span class="comment"></span>
<a name="l00146"></a>00146 <span class="comment">  Revision 1.1  1999/10/06 07:05:10  midas</span>
<a name="l00147"></a>00147 <span class="comment">  Moved lazylogger from utils to src</span>
<a name="l00148"></a>00148 <span class="comment"></span>
<a name="l00149"></a>00149 <span class="comment">  Revision 1.14  1999/10/06 00:42:28  pierre</span>
<a name="l00150"></a>00150 <span class="comment">  - added -c &lt;lazy_channel&gt; option</span>
<a name="l00151"></a>00151 <span class="comment">  - fix log message path and index</span>
<a name="l00152"></a>00152 <span class="comment"></span>
<a name="l00153"></a>00153 <span class="comment">  Revision 1.13  1999/09/27 16:23:56  pierre</span>
<a name="l00154"></a>00154 <span class="comment">  - Changed KB to Bytes references</span>
<a name="l00155"></a>00155 <span class="comment"></span>
<a name="l00156"></a>00156 <span class="comment">  Revision 1.12  1999/09/24 00:05:50  pierre</span>
<a name="l00157"></a>00157 <span class="comment">  - Modified for multiple lazy channel.</span>
<a name="l00158"></a>00158 <span class="comment">  - Remove lazy.log and log to midas.log</span>
<a name="l00159"></a>00159 <span class="comment"></span>
<a name="l00160"></a>00160 <span class="comment">  Revision 1.11  1999/07/01 11:31:19  midas</span>
<a name="l00161"></a>00161 <span class="comment">  Change lazy_log_update for FTP mode</span>
<a name="l00162"></a>00162 <span class="comment"></span>
<a name="l00163"></a>00163 <span class="comment">  Revision 1.10  1999/06/30 14:43:00  midas</span>
<a name="l00164"></a>00164 <span class="comment">  Increased str length in lazy_log_updata</span>
<a name="l00165"></a>00165 <span class="comment"></span>
<a name="l00166"></a>00166 <span class="comment">  Revision 1.9  1999/06/23 09:48:42  midas</span>
<a name="l00167"></a>00167 <span class="comment">  Added FTP functionality</span>
<a name="l00168"></a>00168 <span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">  Revision 1.8  1999/05/06 19:18:53  pierre</span>
<a name="l00170"></a>00170 <span class="comment">  - replace [%] by (%)</span>
<a name="l00171"></a>00171 <span class="comment"></span>
<a name="l00172"></a>00172 <span class="comment">  Revision 1.7  1999/02/19 21:54:08  pierre</span>
<a name="l00173"></a>00173 <span class="comment">  - incorporate hot links on Settings</span>
<a name="l00174"></a>00174 <span class="comment"></span>
<a name="l00175"></a>00175 <span class="comment">  Revision 1.6  1999/02/05 23:51:11  pierre</span>
<a name="l00176"></a>00176 <span class="comment">  - Cleanup /settings structure</span>
<a name="l00177"></a>00177 <span class="comment">  - Enable FTP channel</span>
<a name="l00178"></a>00178 <span class="comment">  - Add examples in -h switch</span>
<a name="l00179"></a>00179 <span class="comment"></span>
<a name="l00180"></a>00180 <span class="comment">  Revision 1.5  1999/01/18 18:21:13  pierre</span>
<a name="l00181"></a>00181 <span class="comment">  - Changed the setting structure.</span>
<a name="l00182"></a>00182 <span class="comment">  - Added running condition test</span>
<a name="l00183"></a>00183 <span class="comment">  - Adapted to ybos prototypes.</span>
<a name="l00184"></a>00184 <span class="comment"></span>
<a name="l00185"></a>00185 <span class="comment">  Revision 1.4  1998/11/20 15:02:01  pierre</span>
<a name="l00186"></a>00186 <span class="comment">  Added MIDAS fmt support</span>
<a name="l00187"></a>00187 <span class="comment">  No FTP channel support yet!</span>
<a name="l00188"></a>00188 <span class="comment"></span>
<a name="l00189"></a>00189 <span class="comment">  Revision 1.3  1998/10/19 17:48:48  pierre</span>
<a name="l00190"></a>00190 <span class="comment">  - restructure of setting and statistics</span>
<a name="l00191"></a>00191 <span class="comment">  - add disk to disk support</span>
<a name="l00192"></a>00192 <span class="comment">  - add lazy.log log file and cleanup of List tree</span>
<a name="l00193"></a>00193 <span class="comment">  - NO support for MIDAS format yet</span>
<a name="l00194"></a>00194 <span class="comment"></span>
<a name="l00195"></a>00195 <span class="comment">  Revision 1.2  1998/10/12 12:19:03  midas</span>
<a name="l00196"></a>00196 <span class="comment">  Added Log tag in header</span>
<a name="l00197"></a>00197 <span class="comment">\********************************************************************/</span>
<a name="l00198"></a>00198 <span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<a name="l00199"></a>00199 <span class="preprocessor">#include &quot;<a class="code" href="msystem_8h.html">msystem.h</a>&quot;</span>
<a name="l00200"></a>00200 <span class="preprocessor">#include &quot;<a class="code" href="ybos_8h.html">ybos.h</a>&quot;</span>
<a name="l00201"></a>00201 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00202"></a>00202 
<a name="l00203"></a><a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">00203</a> <span class="preprocessor">#define NOTHING_TODO  0</span>
<a name="l00204"></a><a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">00204</a> <span class="preprocessor"></span><span class="preprocessor">#define FORCE_EXIT    1</span>
<a name="l00205"></a><a class="code" href="lazylogger_8c.html#a4b5a4ed2c294492ec8721c9428f41eb0">00205</a> <span class="preprocessor"></span><span class="preprocessor">#define NEW_FILE      1</span>
<a name="l00206"></a><a class="code" href="lazylogger_8c.html#a26897d4a481db39514d1fa84d0fc659e">00206</a> <span class="preprocessor"></span><span class="preprocessor">#define REMOVE_FILE   2</span>
<a name="l00207"></a><a class="code" href="lazylogger_8c.html#a43527bf47b67c185a10867fcb93fc4e4">00207</a> <span class="preprocessor"></span><span class="preprocessor">#define REMOVE_ENTRY  3</span>
<a name="l00208"></a><a class="code" href="lazylogger_8c.html#a869fa7fe9076c407092370aaf05831c6">00208</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_LAZY_CHANNEL 4</span>
<a name="l00209"></a><a class="code" href="lazylogger_8c.html#aad9cc64d45a76ba0d37c00f8cd9caa37">00209</a> <span class="preprocessor"></span><span class="preprocessor">#define TRACE</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span>
<a name="l00211"></a><a class="code" href="structDIRLOG.html">00211</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00212"></a><a class="code" href="structDIRLOG.html#ac2982d556eeba054e3b7a233c879ac52">00212</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>;
<a name="l00213"></a><a class="code" href="structDIRLOG.html#ab694cc7e8e54248118407f79e94ec09e">00213</a>    <span class="keywordtype">double</span> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l00214"></a>00214 } <a class="code" href="structDIRLOG.html">DIRLOG</a>;
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="lazylogger_8c.html#a629e5d73e788fe4c26b1cc6c8acc2d20">00216</a> <span class="preprocessor">#define LAZY_SETTINGS_STRING &quot;\</span>
<a name="l00217"></a>00217 <span class="preprocessor">Maintain free space(%) = INT : 0\n\</span>
<a name="l00218"></a>00218 <span class="preprocessor">Stay behind = INT : -3\n\</span>
<a name="l00219"></a>00219 <span class="preprocessor">Alarm Class = STRING : [32]\n\</span>
<a name="l00220"></a>00220 <span class="preprocessor">Running condition = STRING : [128] ALWAYS\n\</span>
<a name="l00221"></a>00221 <span class="preprocessor">Data dir = STRING : [256] \n\</span>
<a name="l00222"></a>00222 <span class="preprocessor">Data format = STRING : [8] MIDAS\n\</span>
<a name="l00223"></a>00223 <span class="preprocessor">Filename format = STRING : [128] run%05d.mid\n\</span>
<a name="l00224"></a>00224 <span class="preprocessor">Backup type = STRING : [8] Tape\n\</span>
<a name="l00225"></a>00225 <span class="preprocessor">Execute after rewind = STRING : [64]\n\</span>
<a name="l00226"></a>00226 <span class="preprocessor">Path = STRING : [128] \n\</span>
<a name="l00227"></a>00227 <span class="preprocessor">Capacity (Bytes) = FLOAT : 5e9\n\</span>
<a name="l00228"></a>00228 <span class="preprocessor">List label= STRING : [128] \n\</span>
<a name="l00229"></a>00229 <span class="preprocessor">Execute before writing file = STRING : [64]\n\</span>
<a name="l00230"></a>00230 <span class="preprocessor">Execute after writing file = STRING : [64]\n\</span>
<a name="l00231"></a>00231 <span class="preprocessor">Modulo.Position = STRING : [8]\n\</span>
<a name="l00232"></a>00232 <span class="preprocessor">Tape Data Append = BOOL : y\n\</span>
<a name="l00233"></a>00233 <span class="preprocessor">&quot;</span>
<a name="l00234"></a><a class="code" href="lazylogger_8c.html#a991b3924ecbf649846565843d28f4f74">00234</a> <span class="preprocessor"></span><span class="preprocessor">#define LAZY_STATISTICS_STRING &quot;\</span>
<a name="l00235"></a>00235 <span class="preprocessor">Backup file = STRING : [128] none \n\</span>
<a name="l00236"></a>00236 <span class="preprocessor">File size [Bytes] = FLOAT : 0.0\n\</span>
<a name="l00237"></a>00237 <span class="preprocessor">KBytes copied = FLOAT : 0.0\n\</span>
<a name="l00238"></a>00238 <span class="preprocessor">Total Bytes copied = FLOAT : 0.0\n\</span>
<a name="l00239"></a>00239 <span class="preprocessor">Copy progress [%] = FLOAT : 0\n\</span>
<a name="l00240"></a>00240 <span class="preprocessor">Copy Rate [bytes per s] = FLOAT : 0\n\</span>
<a name="l00241"></a>00241 <span class="preprocessor">Backup status [%] = FLOAT : 0\n\</span>
<a name="l00242"></a>00242 <span class="preprocessor">Number of Files = INT : 0\n\</span>
<a name="l00243"></a>00243 <span class="preprocessor">Current Lazy run = INT : 0\n\</span>
<a name="l00244"></a>00244 <span class="preprocessor">&quot;</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span>
<a name="l00246"></a><a class="code" href="structLAZY__SETTING.html">00246</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00247"></a><a class="code" href="structLAZY__SETTING.html#acf3ba60fcf6662dbb0ef7a0707c6d422">00247</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> pupercent;               <span class="comment">/* 0:100 % of disk space to keep free */</span>
<a name="l00248"></a><a class="code" href="structLAZY__SETTING.html#a15df4ce395a553a2859e4b96148f741a">00248</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> staybehind;              <span class="comment">/* keep x run file between current Acq and backup</span>
<a name="l00249"></a>00249 <span class="comment">                                   -x same as x but starting from oldest */</span>
<a name="l00250"></a><a class="code" href="structLAZY__SETTING.html#a3a9db40f4c34db2f35ae5806b99ed7bb">00250</a>    <span class="keywordtype">char</span> alarm[32];              <span class="comment">/* Alarm Class */</span>
<a name="l00251"></a><a class="code" href="structLAZY__SETTING.html#a0f62a56d81568e4cd455d5ad7a63db54">00251</a>    <span class="keywordtype">char</span> condition[128];         <span class="comment">/* key condition */</span>
<a name="l00252"></a><a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">00252</a>    <span class="keywordtype">char</span> dir[256];               <span class="comment">/* path to the data dir */</span>
<a name="l00253"></a><a class="code" href="structLAZY__SETTING.html#a3964f0947a90e90ac81d1cd7172201b4">00253</a>    <span class="keywordtype">char</span> <a class="code" href="webpaw_8c.html#a6113855b8e5965f1e91ee407b4026ab7">format</a>[8];              <span class="comment">/* Data format (YBOS, MIDAS) */</span>
<a name="l00254"></a><a class="code" href="structLAZY__SETTING.html#a681ec7fec002c3aa7686867f14394c48">00254</a>    <span class="keywordtype">char</span> backfmt[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>]; <span class="comment">/* format for the run files run%05d.mid */</span>
<a name="l00255"></a><a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">00255</a>    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>[8];                <span class="comment">/* Backup device type  (Disk, Tape, Ftp) */</span>
<a name="l00256"></a><a class="code" href="structLAZY__SETTING.html#a234ecd2a8a13fd563d450b15398f6c50">00256</a>    <span class="keywordtype">char</span> command[64];            <span class="comment">/* command to run after rewind */</span>
<a name="l00257"></a><a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">00257</a>    <span class="keywordtype">char</span> path[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];    <span class="comment">/* backup device name */</span>
<a name="l00258"></a><a class="code" href="structLAZY__SETTING.html#a2d138f987eb40a796eb348569c6b3785">00258</a>    <span class="keywordtype">float</span> capacity;              <span class="comment">/* backup device max byte size */</span>
<a name="l00259"></a><a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">00259</a>    <span class="keywordtype">char</span> backlabel[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];       <span class="comment">/* label of the array in ~/list. if empty like active = 0 */</span>
<a name="l00260"></a><a class="code" href="structLAZY__SETTING.html#a655e1b19cdf53876f36ccbcd22e84093">00260</a>    <span class="keywordtype">char</span> commandBefore[64];      <span class="comment">/* command to run Before writing a file */</span>
<a name="l00261"></a><a class="code" href="structLAZY__SETTING.html#a04dc0ed775b48d8bd7daa02e03f81bbf">00261</a>    <span class="keywordtype">char</span> commandAfter[64];       <span class="comment">/* command to run After writing a file */</span>
<a name="l00262"></a><a class="code" href="structLAZY__SETTING.html#a6b668961a269f6856d706e364e9646e7">00262</a>    <span class="keywordtype">char</span> modulo[8];              <span class="comment">/* Modulo for multiple lazy client */</span>
<a name="l00263"></a><a class="code" href="structLAZY__SETTING.html#afb7591433b60071b41a72fd6f991f188">00263</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> tapeAppend;             <span class="comment">/* Flag for appending data to the Tape */</span>
<a name="l00264"></a>00264 } <a class="code" href="structLAZY__SETTING.html">LAZY_SETTING</a>;
<a name="l00265"></a><a class="code" href="lazylogger_8c.html#adec3e8b6069f08f06fb57a48a1b02399">00265</a> <a class="code" href="structLAZY__SETTING.html">LAZY_SETTING</a> <a class="code" href="lazylogger_8c.html#adec3e8b6069f08f06fb57a48a1b02399">lazy</a>;
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="structLAZY__STATISTICS.html">00267</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00268"></a><a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">00268</a>    <span class="keywordtype">char</span> backfile[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];        <span class="comment">/* current or last lazy file done (for info only) */</span>
<a name="l00269"></a><a class="code" href="structLAZY__STATISTICS.html#a7759604df39f4a0923e7711d12ac092b">00269</a>    <span class="keywordtype">float</span> file_size;             <span class="comment">/* file size in bytes */</span>
<a name="l00270"></a><a class="code" href="structLAZY__STATISTICS.html#a7bb4f126f3eceeb30af4d19d29c4a539">00270</a>    <span class="keywordtype">float</span> cur_size;              <span class="comment">/* current bytes copied */</span>
<a name="l00271"></a><a class="code" href="structLAZY__STATISTICS.html#a96f3d631abc3ff0170e87f761b1485a1">00271</a>    <span class="keywordtype">float</span> cur_dev_size;          <span class="comment">/* Total bytes backup on device */</span>
<a name="l00272"></a><a class="code" href="structLAZY__STATISTICS.html#a3c8c8b2e1497798143f4f16e9fbbefab">00272</a>    <span class="keywordtype">float</span> progress;              <span class="comment">/* copy % */</span>
<a name="l00273"></a><a class="code" href="structLAZY__STATISTICS.html#a285009f5daddc39f4e669b0473af049f">00273</a>    <span class="keywordtype">float</span> copy_rate;             <span class="comment">/* copy rate Kb/s */</span>
<a name="l00274"></a><a class="code" href="structLAZY__STATISTICS.html#ab5308323c830c8c2ba5887700e26f98d">00274</a>    <span class="keywordtype">float</span> bckfill;               <span class="comment">/* backup fill % */</span>
<a name="l00275"></a><a class="code" href="structLAZY__STATISTICS.html#a6ad47530044b284a85aafa79bbe748fc">00275</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> nfiles;                  <span class="comment">/* # of backuped files */</span>
<a name="l00276"></a><a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">00276</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> cur_run;                 <span class="comment">/* current or last lazy run number done (for info only) */</span>
<a name="l00277"></a>00277 } <a class="code" href="structLAZY__STATISTICS.html">LAZY_STATISTICS</a>;
<a name="l00278"></a><a class="code" href="lazylogger_8c.html#a35259e31983a0cf1ea650553621580fb">00278</a> <a class="code" href="structLAZY__STATISTICS.html">LAZY_STATISTICS</a> <a class="code" href="lazylogger_8c.html#a35259e31983a0cf1ea650553621580fb">lazyst</a>;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 
<a name="l00281"></a><a class="code" href="structLAZY__INFO.html">00281</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00282"></a><a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">00282</a>    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l00283"></a><a class="code" href="structLAZY__INFO.html#a9e4e633f2a1b62d5b2367c4416317a53">00283</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> active;
<a name="l00284"></a><a class="code" href="structLAZY__INFO.html#ab4c04a13dfbfd2b9cf7c3027ed87a575">00284</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="msc_8c.html#ac882565d6dced9dd3517656f6200eb3d">match</a>;
<a name="l00285"></a><a class="code" href="structLAZY__INFO.html#a01014a800074f3317847557c39bcb2df">00285</a>    <span class="keywordtype">char</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>[32];
<a name="l00286"></a>00286 } <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a>;
<a name="l00287"></a>00287 
<a name="l00288"></a><a class="code" href="lazylogger_8c.html#a5cf20217a3782d4feade46538ab76e23">00288</a> <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> <a class="code" href="lazylogger_8c.html#a5cf20217a3782d4feade46538ab76e23">lazyinfo</a>[<a class="code" href="lazylogger_8c.html#a869fa7fe9076c407092370aaf05831c6">MAX_LAZY_CHANNEL</a>] = { {0, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;Tape&quot;</span>}, {0, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;&quot;</span>}
<a name="l00289"></a>00289 , {0, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;&quot;</span>}, {0, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;&quot;</span>}
<a name="l00290"></a>00290 };
<a name="l00291"></a><a class="code" href="lazylogger_8c.html#a7728c597c88e0bc9b73912265b2f7665">00291</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> = -1;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 <span class="comment">/* Globals */</span>
<a name="l00294"></a><a class="code" href="lazylogger_8c.html#ad82767a8569bed318543d968cb2827e4">00294</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#ad82767a8569bed318543d968cb2827e4">lazy_mutex</a>;
<a name="l00295"></a><a class="code" href="lazylogger_8c.html#ac6ff92e529008dd5866223bde86e808d">00295</a> <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <a class="code" href="lazylogger_8c.html#ac6ff92e529008dd5866223bde86e808d">pcurrent_hKey</a>;
<a name="l00296"></a><a class="code" href="lazylogger_8c.html#af66a172e1d1f56385eec5bbd52e97a66">00296</a> <span class="keywordtype">float</span> <a class="code" href="lazylogger_8c.html#af66a172e1d1f56385eec5bbd52e97a66">lastsz</a>;
<a name="l00297"></a><a class="code" href="lazylogger_8c.html#affc2c1ae6ae328e611c4825cc47c05f6">00297</a> <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="lazylogger_8c.html#affc2c1ae6ae328e611c4825cc47c05f6">hKeyst</a>;
<a name="l00298"></a><a class="code" href="lazylogger_8c.html#a6391c3dee66f9029ace9906bd5a58ae4">00298</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>, <a class="code" href="lazylogger_8c.html#a6391c3dee66f9029ace9906bd5a58ae4">tot_do_size</a>, <a class="code" href="lazylogger_8c.html#a9cf6c66bbf8da33919c7941123d52e2b">tot_dirlog_size</a>, <a class="code" href="lazylogger_8c.html#ae76a80a4eaf2de79a5f51b86df5a5857">hDev</a>;
<a name="l00299"></a><a class="code" href="lazylogger_8c.html#a0ef9ee54f7de740c695f9258b8f3dd5c">00299</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="lazylogger_8c.html#a0ef9ee54f7de740c695f9258b8f3dd5c">zap_flag</a>, <a class="code" href="lazylogger_8c.html#ab2f0c1e68c31ad3f94f2f056bd1fdf9e">msg_flag</a>;
<a name="l00300"></a><a class="code" href="lazylogger_8c.html#abd54fd671b0bb3081a52eeae7aa4cefe">00300</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="lazylogger_8c.html#abd54fd671b0bb3081a52eeae7aa4cefe">copy_continue</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00301"></a><a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">00301</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#aad8ec8a870ba39f5ec40234403f06f77">data_fmt</a>, <a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a>;
<a name="l00302"></a><a class="code" href="lazylogger_8c.html#a77bacfd6de2ea9b41fdd0d6f0433e092">00302</a> <span class="keywordtype">char</span> <a class="code" href="lazylogger_8c.html#a77bacfd6de2ea9b41fdd0d6f0433e092">lazylog</a>[<a class="code" href="group__msystemincludecode.html#ga6789ebc0df71a8ef76bfbb4fb5f74aad">MAX_STRING_LENGTH</a>];
<a name="l00303"></a><a class="code" href="lazylogger_8c.html#af46961b06b084613767839d2ac89a707">00303</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="lazylogger_8c.html#a5da880f19a743e3ae097deaafd1913d4">full_bck_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="lazylogger_8c.html#af46961b06b084613767839d2ac89a707">maintain_touched</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00304"></a><a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">00304</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a> = 0;
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="lazylogger_8c.html#abf89628d486477bd0db5a5890cd38a05">00306</a> <span class="preprocessor">#define WATCHDOG_TIMEOUT 60000  </span><span class="comment">/* 60 sec for tape access */</span>
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">/* prototypes */</span>
<a name="l00309"></a>00309 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#ade28934d8862501e383d4c314a613b20">moduloCheck</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ebuser_8cpp.html#a931a4ca265e2b03c9b59e773b628c1d2" title="Global var for testing.">lModulo</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> lPosition, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> lrun);
<a name="l00310"></a>00310 <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="lazylogger_8c.html#a84a74353d808bc45785ea45768bdfd34">lazy_file_exists</a>(<span class="keywordtype">char</span> *dir, <span class="keywordtype">char</span> *file);
<a name="l00311"></a>00311 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a2bd150be563935695ecf7aab6b9fcea6">lazy_main</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>, <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> *);
<a name="l00312"></a>00312 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a428a0b34622866ee9c1692ce2d362774">lazy_copy</a>(<span class="keywordtype">char</span> *<a class="code" href="vmedrv_8c.html#a8910285a0352a5c710e65ec9ecbe32a1">dev</a>, <span class="keywordtype">char</span> *file);
<a name="l00313"></a>00313 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a1fa437aa64a922839bd4124310107fe1">lazy_file_compose</a>(<span class="keywordtype">char</span> *<a class="code" href="ybos_8c.html#a7ab994c987ffba39688c74f10907429c">fmt</a>, <span class="keywordtype">char</span> *dir, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> num, <span class="keywordtype">char</span> *ffile, <span class="keywordtype">char</span> *file);
<a name="l00314"></a>00314 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a0d08e8d13b285a8754d67871c5a874f3">lazy_update_list</a>(<a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> *, <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> cp);
<a name="l00315"></a>00315 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a4776a2fa363c13eef86dc0a59e1186d0">lazy_select_purge</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> ch, <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> *, <span class="keywordtype">char</span> *<a class="code" href="ybos_8c.html#a7ab994c987ffba39688c74f10907429c">fmt</a>, <span class="keywordtype">char</span> *dir, <span class="keywordtype">char</span> *pufile,
<a name="l00316"></a>00316                       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> * <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>);
<a name="l00317"></a>00317 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a5f4336c986c91cabbd2a2a3fd31efc96">lazy_load_params</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>);
<a name="l00318"></a>00318 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a7c506cdc6c2ca31d03184f8b674198cf">build_log_list</a>(<span class="keywordtype">char</span> *<a class="code" href="ybos_8c.html#a7ab994c987ffba39688c74f10907429c">fmt</a>, <span class="keywordtype">char</span> *dir, <a class="code" href="structDIRLOG.html">DIRLOG</a> ** plog);
<a name="l00319"></a>00319 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#aa7ddec3eef679124780e21119710ac6a">build_done_list</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> **);
<a name="l00320"></a>00320 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a6db080ca2b79410341401d24c1687848">cmp_log2donelist</a>(<a class="code" href="structDIRLOG.html">DIRLOG</a> * plog, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> * pdo);
<a name="l00321"></a>00321 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a141d3e82085549ca775e167e8334de52">lazy_log_update</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> action, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>, <span class="keywordtype">char</span> *label, <span class="keywordtype">char</span> *file, <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> rm);
<a name="l00322"></a>00322 <span class="keywordtype">int</span> <a class="code" href="lazylogger_8c.html#ab3161802cbf757fc6aa250446ddd61d6">lazy_remove_entry</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> ch, <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> *, <span class="keywordtype">int</span> <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>);
<a name="l00323"></a>00323 <span class="keywordtype">void</span> <a class="code" href="lazylogger_8c.html#aa990fe8387881e9fd696493186e090af">lazy_settings_hotlink</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="keywordtype">void</span> *info);
<a name="l00324"></a>00324 <span class="keywordtype">void</span> <a class="code" href="lazylogger_8c.html#a34002378b03a28414a0e4cd300372d55">lazy_maintain_check</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> * pLall);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00327"></a><a class="code" href="lazylogger_8c.html#a0a05d37ed20144ae90ad3a0e2bf06147">00327</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a0a05d37ed20144ae90ad3a0e2bf06147">ss_run_extract</a>(<span class="keywordtype">char</span> *<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>)
<a name="l00328"></a>00328 <span class="comment">/********************************************************************\</span>
<a name="l00329"></a>00329 <span class="comment">Routine: ss_run_extract</span>
<a name="l00330"></a>00330 <span class="comment">Purpose: extract the contigious digit from the string to make up a</span>
<a name="l00331"></a>00331 <span class="comment">run number.</span>
<a name="l00332"></a>00332 <span class="comment">Input:</span>
<a name="l00333"></a>00333 <span class="comment">char * name    string to search</span>
<a name="l00334"></a>00334 <span class="comment">Output:</span>
<a name="l00335"></a>00335 <span class="comment">Function value:</span>
<a name="l00336"></a>00336 <span class="comment">INT        run number</span>
<a name="l00337"></a>00337 <span class="comment">0 if no extraction</span>
<a name="l00338"></a>00338 <span class="comment">\********************************************************************/</span>
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340    <span class="keywordtype">char</span> run_str[32], *pb, *pe;
<a name="l00341"></a>00341    <span class="keywordtype">int</span> <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a> = 0, <a class="code" href="patch__mevb_8cpp.html#a408216eef095a35ba3963fc6f4f4d7a8">found</a> = 0;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343    pb = pe = NULL;
<a name="l00344"></a>00344    memset(run_str, 0, <span class="keyword">sizeof</span>(run_str));
<a name="l00345"></a>00345    <span class="keywordflow">for</span> (j = 0; j &lt; (int) strlen(name); j++) {
<a name="l00346"></a>00346       <span class="keywordflow">if</span> (!<a class="code" href="patch__mevb_8cpp.html#a408216eef095a35ba3963fc6f4f4d7a8">found</a>) {
<a name="l00347"></a>00347          <span class="keywordflow">if</span> (isdigit(name[j])) {
<a name="l00348"></a>00348             <a class="code" href="patch__mevb_8cpp.html#a408216eef095a35ba3963fc6f4f4d7a8">found</a> = 1;
<a name="l00349"></a>00349             pb = name + j;
<a name="l00350"></a>00350          }
<a name="l00351"></a>00351       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isdigit(name[j]) == 0) {
<a name="l00352"></a>00352          pe = name + j;
<a name="l00353"></a>00353          <span class="keywordflow">break</span>;
<a name="l00354"></a>00354       }
<a name="l00355"></a>00355    }
<a name="l00356"></a>00356    strncpy(run_str, pb, pe - pb);
<a name="l00357"></a>00357    <span class="keywordflow">return</span> (atoi(run_str));
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00361"></a><a class="code" href="lazylogger_8c.html#a7725a98f93531e9d3594fe8455d2009e">00361</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a7725a98f93531e9d3594fe8455d2009e">lazy_file_remove</a>(<span class="keywordtype">char</span> *pufile)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> fHandle, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365    <span class="comment">/* open device */</span>
<a name="l00366"></a>00366    fHandle = open(pufile, O_RDONLY, 0644);
<a name="l00367"></a>00367    <span class="keywordflow">if</span> (fHandle == -1)
<a name="l00368"></a>00368       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga77e57c8c5c8a676e50f7b757294044f5">SS_INVALID_NAME</a>;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370    close(fHandle);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372    status = <a class="code" href="group__msectionh.html#ga6ba0f9037781ad63ac92396bd3271cb0">ss_file_remove</a>(pufile);
<a name="l00373"></a>00373    <span class="keywordflow">if</span> (status != 0)
<a name="l00374"></a>00374       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l00375"></a>00375    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00379"></a><a class="code" href="lazylogger_8c.html#a141d3e82085549ca775e167e8334de52">00379</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a141d3e82085549ca775e167e8334de52">lazy_log_update</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> action, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>, <span class="keywordtype">char</span> *label, <span class="keywordtype">char</span> *file, <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> perf_time)
<a name="l00380"></a>00380 {
<a name="l00381"></a>00381    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];
<a name="l00382"></a>00382    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> blocks;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384    <span class="comment">/* log Lazy logger to midas.log only */</span>
<a name="l00385"></a>00385    <span class="keywordflow">if</span> (action == <a class="code" href="lazylogger_8c.html#a4b5a4ed2c294492ec8721c9428f41eb0">NEW_FILE</a>) {
<a name="l00386"></a>00386       <span class="comment">/* keep track of number of file on that channel */</span>
<a name="l00387"></a>00387       lazyst.<a class="code" href="structLAZY__STATISTICS.html#a6ad47530044b284a85aafa79bbe748fc">nfiles</a>++;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">type</a>, <span class="stringliteral">&quot;FTP&quot;</span>))
<a name="l00390"></a>00390          sprintf(str, <span class="stringliteral">&quot;%s: (cp:%.1fs) %s %1.3lfMB file COPIED&quot;</span>,
<a name="l00391"></a>00391                  label, (<span class="keywordtype">float</span>) perf_time / 1000., lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>,
<a name="l00392"></a>00392                  lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7759604df39f4a0923e7711d12ac092b">file_size</a> / 1024.0 / 1024.0);
<a name="l00393"></a>00393       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">type</a>, <span class="stringliteral">&quot;Disk&quot;</span>)) {
<a name="l00394"></a>00394          <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>[0] != 0)
<a name="l00395"></a>00395             <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>[strlen(lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l00396"></a>00396                strcat(lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l00397"></a>00397          sprintf(str, <span class="stringliteral">&quot;%s[%i] (cp:%.1fs) %s%s %1.3lfMB  file NEW&quot;</span>,
<a name="l00398"></a>00398                  label, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a6ad47530044b284a85aafa79bbe748fc">nfiles</a>, (<span class="keywordtype">float</span>) perf_time / 1000.,
<a name="l00399"></a>00399                  lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7759604df39f4a0923e7711d12ac092b">file_size</a> / 1024.0 / 1024.0);
<a name="l00400"></a>00400       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">type</a>, <span class="stringliteral">&quot;Tape&quot;</span>)) {
<a name="l00401"></a>00401          blocks = (int) (lazyst.<a class="code" href="structLAZY__STATISTICS.html#a96f3d631abc3ff0170e87f761b1485a1">cur_dev_size</a> / 32.0 / 1024.0) + lazyst.<a class="code" href="structLAZY__STATISTICS.html#a6ad47530044b284a85aafa79bbe748fc">nfiles</a>;
<a name="l00402"></a>00402          <span class="comment">/* June 2002, use variable blockn from the real tape position */</span>
<a name="l00403"></a>00403          sprintf(str, <span class="stringliteral">&quot;%s[%i] (cp:%.1fs) %s/%s %1.3lfMB  file NEW (position at block %d)&quot;</span>,
<a name="l00404"></a>00404                  label, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a6ad47530044b284a85aafa79bbe748fc">nfiles</a>, (<span class="keywordtype">float</span>) perf_time / 1000.,
<a name="l00405"></a>00405                  lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7759604df39f4a0923e7711d12ac092b">file_size</a> / 1024.0 / 1024.0, <a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a>);
<a name="l00406"></a>00406          <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a04dc0ed775b48d8bd7daa02e03f81bbf">commandAfter</a>[0]) {
<a name="l00407"></a>00407             <span class="keywordtype">char</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>[256];
<a name="l00408"></a>00408             sprintf(cmd, <span class="stringliteral">&quot;%s %s %i %s/%s %1.3lf %d&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a04dc0ed775b48d8bd7daa02e03f81bbf">commandAfter</a>,
<a name="l00409"></a>00409                     lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a6ad47530044b284a85aafa79bbe748fc">nfiles</a>, lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>,
<a name="l00410"></a>00410                     lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7759604df39f4a0923e7711d12ac092b">file_size</a> / 1024.0 / 1024.0, <a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a>);
<a name="l00411"></a>00411             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Exec post file write script:%s&quot;</span>, cmd);
<a name="l00412"></a>00412             <a class="code" href="group__msystemincludecode.html#ga7a14ecba483c2767fe699633d0bc677e">ss_system</a>(cmd);
<a name="l00413"></a>00413          }
<a name="l00414"></a>00414       }
<a name="l00415"></a>00415    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="lazylogger_8c.html#a26897d4a481db39514d1fa84d0fc659e">REMOVE_FILE</a>)
<a name="l00416"></a>00416       sprintf(str, <span class="stringliteral">&quot;%i (rm:%ldms) %s file REMOVED&quot;</span>, run, perf_time, file);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="lazylogger_8c.html#a43527bf47b67c185a10867fcb93fc4e4">REMOVE_ENTRY</a>)
<a name="l00419"></a>00419       sprintf(str, <span class="stringliteral">&quot;%s run#%i entry REMOVED&quot;</span>, label, run);
<a name="l00420"></a>00420 
<a name="l00421"></a>00421    <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;lazy_log_update&quot;</span>, str);
<a name="l00422"></a>00422    <span class="comment">/* Now add this info also to a special log file */</span>
<a name="l00423"></a>00423    <a class="code" href="group__msectionh.html#ga183ed99cb10ac91bd5391f4623401468">cm_msg1</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;lazy_log_update&quot;</span>, <span class="stringliteral">&quot;lazy&quot;</span>, str);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425    <span class="keywordflow">return</span> 0;
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00429"></a><a class="code" href="lazylogger_8c.html#ade28934d8862501e383d4c314a613b20">00429</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#ade28934d8862501e383d4c314a613b20">moduloCheck</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ebuser_8cpp.html#a931a4ca265e2b03c9b59e773b628c1d2" title="Global var for testing.">lModulo</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> lPosition, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> lrun)
<a name="l00430"></a>00430 <span class="comment">/********************************************************************\</span>
<a name="l00431"></a>00431 <span class="comment">Routine: moduleCheck</span>
<a name="l00432"></a>00432 <span class="comment">Purpose: return valid run number in case of Modulo function enabled</span>
<a name="l00433"></a>00433 <span class="comment">         or zero if not.</span>
<a name="l00434"></a>00434 <span class="comment">Input:</span>
<a name="l00435"></a>00435 <span class="comment">lModulo   : number of lazy channel</span>
<a name="l00436"></a>00436 <span class="comment">lPosition : Position of the current channel</span>
<a name="l00437"></a>00437 <span class="comment">lrun      : current run to test</span>
<a name="l00438"></a>00438 <span class="comment">Function value:</span>
<a name="l00439"></a>00439 <span class="comment">valid run number (0=skip run)</span>
<a name="l00440"></a>00440 <span class="comment">\********************************************************************/</span>
<a name="l00441"></a>00441 {
<a name="l00442"></a>00442    <span class="keywordflow">if</span> (lModulo) {
<a name="l00443"></a>00443       <span class="keywordflow">if</span> ((lrun % lModulo) == lPosition)
<a name="l00444"></a>00444          <span class="keywordflow">return</span> lrun;
<a name="l00445"></a>00445       <span class="keywordflow">else</span>
<a name="l00446"></a>00446          <span class="keywordflow">return</span> 0;
<a name="l00447"></a>00447    } <span class="keywordflow">else</span>
<a name="l00448"></a>00448       <span class="keywordflow">return</span> lrun;
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00452"></a><a class="code" href="lazylogger_8c.html#a7c506cdc6c2ca31d03184f8b674198cf">00452</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a7c506cdc6c2ca31d03184f8b674198cf">build_log_list</a>(<span class="keywordtype">char</span> *<a class="code" href="ybos_8c.html#a7ab994c987ffba39688c74f10907429c">fmt</a>, <span class="keywordtype">char</span> *dir, <a class="code" href="structDIRLOG.html">DIRLOG</a> ** plog)
<a name="l00453"></a>00453 <span class="comment">/********************************************************************\</span>
<a name="l00454"></a>00454 <span class="comment">Routine: build_log_list</span>
<a name="l00455"></a>00455 <span class="comment">Purpose: build an internal directory file list from the disk directory</span>
<a name="l00456"></a>00456 <span class="comment">Input:</span>
<a name="l00457"></a>00457 <span class="comment">* fmt     format of the file to search for (ie:run%05d.ybs)</span>
<a name="l00458"></a>00458 <span class="comment">* dir     path to the directory for the search</span>
<a name="l00459"></a>00459 <span class="comment">Output:</span>
<a name="l00460"></a>00460 <span class="comment">**plog     internal file list struct</span>
<a name="l00461"></a>00461 <span class="comment">Function value:</span>
<a name="l00462"></a>00462 <span class="comment">number of elements</span>
<a name="l00463"></a>00463 <span class="comment">\********************************************************************/</span>
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> nfile, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, l;
<a name="l00466"></a>00466    <span class="keywordtype">char</span> *<a class="code" href="namespacemodules.html#a12afb64f27b8a4e356d665de83e78ad3">list</a> = NULL;
<a name="l00467"></a>00467    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];
<a name="l00468"></a>00468    <a class="code" href="structDIRLOG.html">DIRLOG</a> <a class="code" href="scs__400_8c.html#aa9011d9cfe9fd83bd4d338d4912c4146">temp</a>;
<a name="l00469"></a>00469    <span class="keywordtype">char</span> *dot;
<a name="l00470"></a>00470    <span class="keywordtype">int</span> <a class="code" href="ebuser_8cpp.html#a931a4ca265e2b03c9b59e773b628c1d2" title="Global var for testing.">lModulo</a> = 0, lPosition = 0;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472    <span class="comment">/* substitue %xx by * */</span>
<a name="l00473"></a>00473    strcpy(str, fmt);
<a name="l00474"></a>00474    <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>)) {
<a name="l00475"></a>00475       *strchr(str, <span class="charliteral">&apos;%&apos;</span>) = <span class="charliteral">&apos;*&apos;</span>;
<a name="l00476"></a>00476       <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;.&apos;</span>))
<a name="l00477"></a>00477          strcpy((strchr(str, <span class="charliteral">&apos;*&apos;</span>) + 1), strchr(str, <span class="charliteral">&apos;.&apos;</span>));
<a name="l00478"></a>00478    }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480    <span class="comment">/* create dir listing with given criteria */</span>
<a name="l00481"></a>00481    <span class="keywordflow">if</span> (dir[0] != 0)
<a name="l00482"></a>00482       <span class="keywordflow">if</span> (dir[strlen(dir) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l00483"></a>00483          strcat(dir, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l00484"></a>00484    nfile = <a class="code" href="group__msectionh.html#ga720c036bbaddcb54dae415a44c33e39a">ss_file_find</a>(dir, str, &amp;list);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486    <span class="comment">/* check */</span>
<a name="l00487"></a>00487    <span class="comment">/*</span>
<a name="l00488"></a>00488 <span class="comment">      for (j=0;j&lt;nfile;j++)</span>
<a name="l00489"></a>00489 <span class="comment">      printf (&quot;list[%i]:%s\n&quot;,j, list+j*MAX_STRING_LENGTH);</span>
<a name="l00490"></a>00490 <span class="comment">    */</span>
<a name="l00491"></a>00491 
<a name="l00492"></a>00492    <span class="comment">/* allocate memory */</span>
<a name="l00493"></a>00493    <a class="code" href="lazylogger_8c.html#a9cf6c66bbf8da33919c7941123d52e2b">tot_dirlog_size</a> = (nfile * <span class="keyword">sizeof</span>(<a class="code" href="structDIRLOG.html">DIRLOG</a>));
<a name="l00494"></a>00494    *plog = realloc(*plog, <a class="code" href="lazylogger_8c.html#a9cf6c66bbf8da33919c7941123d52e2b">tot_dirlog_size</a>);
<a name="l00495"></a>00495    memset(*plog, 0, <a class="code" href="lazylogger_8c.html#a9cf6c66bbf8da33919c7941123d52e2b">tot_dirlog_size</a>);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497    <span class="comment">/* Check Modulo option */</span>
<a name="l00498"></a>00498    <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a6b668961a269f6856d706e364e9646e7">modulo</a>[0]) {
<a name="l00499"></a>00499       <span class="comment">/* Modulo enabled, extract modulo and position */</span>
<a name="l00500"></a>00500       dot = strchr(lazy.<a class="code" href="structLAZY__SETTING.html#a6b668961a269f6856d706e364e9646e7">modulo</a>, <span class="charliteral">&apos;.&apos;</span>);
<a name="l00501"></a>00501       <span class="keywordflow">if</span> (dot) {
<a name="l00502"></a>00502          *dot = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00503"></a>00503          lModulo = atoi(lazy.<a class="code" href="structLAZY__SETTING.html#a6b668961a269f6856d706e364e9646e7">modulo</a>);
<a name="l00504"></a>00504          lPosition = atoi(dot + 1);
<a name="l00505"></a>00505          *dot = <span class="charliteral">&apos;.&apos;</span>;
<a name="l00506"></a>00506       }
<a name="l00507"></a>00507    }
<a name="l00508"></a>00508    <span class="comment">/* fill structure */</span>
<a name="l00509"></a>00509    <span class="keywordflow">for</span> (j = 0, l = 0; j &lt; nfile; j++) {
<a name="l00510"></a>00510       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> strl, lrun;
<a name="l00511"></a>00511       <span class="comment">/* extract run number */</span>
<a name="l00512"></a>00512       lrun = <a class="code" href="lazylogger_8c.html#a0a05d37ed20144ae90ad3a0e2bf06147">ss_run_extract</a>(list + j * <a class="code" href="group__msystemincludecode.html#ga6789ebc0df71a8ef76bfbb4fb5f74aad">MAX_STRING_LENGTH</a>);
<a name="l00513"></a>00513       <span class="comment">/* apply the modulo if enabled */</span>
<a name="l00514"></a>00514       lrun = <a class="code" href="lazylogger_8c.html#ade28934d8862501e383d4c314a613b20">moduloCheck</a>(lModulo, lPosition, lrun);
<a name="l00515"></a>00515       <span class="comment">/* if modulo enable skip */</span>
<a name="l00516"></a>00516       <span class="keywordflow">if</span> (lrun == 0)
<a name="l00517"></a>00517          <span class="keywordflow">continue</span>;
<a name="l00518"></a>00518       (*plog + l)-&gt;<a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a> = lrun;
<a name="l00519"></a>00519       strcpy(str, dir);
<a name="l00520"></a>00520       strl = strlen(list + j * MAX_STRING_LENGTH);
<a name="l00521"></a>00521       strncat(str, list + j * MAX_STRING_LENGTH, strl);
<a name="l00522"></a>00522       (*plog + l)-&gt;<a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a> = <a class="code" href="group__msectionh.html#ga8a1804a9ff96e7ba88836fcc411d5384">ss_file_size</a>(str);
<a name="l00523"></a>00523       l++;
<a name="l00524"></a>00524    }
<a name="l00525"></a>00525    <span class="comment">/* correct number of file after the modulo */</span>
<a name="l00526"></a>00526    nfile = l;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528    free(list);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530    <span class="comment">/* Sort list */</span>
<a name="l00531"></a>00531    <span class="keywordflow">for</span> (j = 0; j &lt; nfile; j++) {
<a name="l00532"></a>00532       <span class="keywordflow">for</span> (i = j; i &lt; nfile; i++) {
<a name="l00533"></a>00533          <span class="keywordflow">if</span> ((*plog + j)-&gt;<a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a> &gt; (*plog + i)-&gt;<a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>) {
<a name="l00534"></a>00534             memcpy(&amp;temp, (*plog + i), <span class="keyword">sizeof</span>(<a class="code" href="structDIRLOG.html">DIRLOG</a>));
<a name="l00535"></a>00535             memcpy((*plog + i), (*plog + j), <span class="keyword">sizeof</span>(<a class="code" href="structDIRLOG.html">DIRLOG</a>));
<a name="l00536"></a>00536             memcpy((*plog + j), &amp;temp, <span class="keyword">sizeof</span>(<a class="code" href="structDIRLOG.html">DIRLOG</a>));
<a name="l00537"></a>00537          }
<a name="l00538"></a>00538       }
<a name="l00539"></a>00539    }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541    <span class="keywordflow">return</span> nfile;
<a name="l00542"></a>00542 }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00545"></a><a class="code" href="lazylogger_8c.html#aa7ddec3eef679124780e21119710ac6a">00545</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#aa7ddec3eef679124780e21119710ac6a">build_done_list</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hLch, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> ** pdo)
<a name="l00546"></a>00546 <span class="comment">/********************************************************************\</span>
<a name="l00547"></a>00547 <span class="comment">Routine: build_done_list</span>
<a name="l00548"></a>00548 <span class="comment">Purpose: build a sorted internal /lazy/list list (pdo) tree.</span>
<a name="l00549"></a>00549 <span class="comment">Input:</span>
<a name="l00550"></a>00550 <span class="comment">HNDLE             Key of the Lazy channel</span>
<a name="l00551"></a>00551 <span class="comment">**pdo     /lazy_xxx/list run listing</span>
<a name="l00552"></a>00552 <span class="comment">Output:</span>
<a name="l00553"></a>00553 <span class="comment">**pdo     /lazy_xxx/list run listing</span>
<a name="l00554"></a>00554 <span class="comment">Function value:      number of elements</span>
<a name="l00555"></a>00555 <span class="comment">\********************************************************************/</span>
<a name="l00556"></a>00556 {
<a name="l00557"></a>00557    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <a class="code" href="mevb_8cpp.html#aac58a320ae0ebf75ec6d8a273184b463">hSubkey</a>;
<a name="l00558"></a>00558    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l00559"></a>00559    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, tot_nelement, nelement, <a class="code" href="scs__400_8c.html#aa9011d9cfe9fd83bd4d338d4912c4146">temp</a>;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hLch, <span class="stringliteral">&quot;List&quot;</span>, &amp;hKey) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00562"></a>00562       *pdo[0] = 0;
<a name="l00563"></a>00563       <span class="keywordflow">return</span> 0;
<a name="l00564"></a>00564    }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566    tot_nelement = <a class="code" href="lazylogger_8c.html#a6391c3dee66f9029ace9906bd5a58ae4">tot_do_size</a> = 0;
<a name="l00567"></a>00567    <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l00568"></a>00568       <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, i, &amp;hSubkey);
<a name="l00569"></a>00569       <span class="keywordflow">if</span> (!hSubkey)
<a name="l00570"></a>00570          <span class="keywordflow">break</span>;
<a name="l00571"></a>00571       <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hSubkey, &amp;key);
<a name="l00572"></a>00572       nelement = key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l00573"></a>00573       <a class="code" href="lazylogger_8c.html#a6391c3dee66f9029ace9906bd5a58ae4">tot_do_size</a> += nelement * <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>);
<a name="l00574"></a>00574       *pdo = realloc(*pdo, <a class="code" href="lazylogger_8c.html#a6391c3dee66f9029ace9906bd5a58ae4">tot_do_size</a>);
<a name="l00575"></a>00575       size = nelement * <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>);
<a name="l00576"></a>00576       <a class="code" href="group__msectionh.html#gad6e53374f24813cdba8713781683c556">db_get_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hSubkey, (<span class="keywordtype">char</span> *) (*pdo + tot_nelement), &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l00577"></a>00577       tot_nelement += nelement;
<a name="l00578"></a>00578    }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580    <span class="keywordflow">for</span> (j = 0; j &lt; tot_nelement - 1; j++) {
<a name="l00581"></a>00581       <span class="keywordflow">for</span> (i = j + 1; i &lt; tot_nelement; i++) {
<a name="l00582"></a>00582          <span class="keywordflow">if</span> (*(*pdo + j) &gt; *(*pdo + i)) {
<a name="l00583"></a>00583             memcpy(&amp;temp, (*pdo + i), <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l00584"></a>00584             memcpy((*pdo + i), (*pdo + j), <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l00585"></a>00585             memcpy((*pdo + j), &amp;temp, <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l00586"></a>00586          }
<a name="l00587"></a>00587       }
<a name="l00588"></a>00588    }
<a name="l00589"></a>00589    <span class="keywordflow">return</span> tot_nelement;
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00593"></a><a class="code" href="lazylogger_8c.html#a6db080ca2b79410341401d24c1687848">00593</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a6db080ca2b79410341401d24c1687848">cmp_log2donelist</a>(<a class="code" href="structDIRLOG.html">DIRLOG</a> * plog, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> * pdo)
<a name="l00594"></a>00594 <span class="comment">/********************************************************************\</span>
<a name="l00595"></a>00595 <span class="comment">Routine: cmp_log2donelist</span>
<a name="l00596"></a>00596 <span class="comment">Purpose: return the run number to be backed up comparing the</span>
<a name="l00597"></a>00597 <span class="comment">plog struct to the pdo struct</span>
<a name="l00598"></a>00598 <span class="comment">the condition being : run# in (plog AND !pdo)</span>
<a name="l00599"></a>00599 <span class="comment">marks the run present in both list by tagging them with *= -1</span>
<a name="l00600"></a>00600 <span class="comment">Input:</span>
<a name="l00601"></a>00601 <span class="comment">*plog :   disk file listing</span>
<a name="l00602"></a>00602 <span class="comment">*pdo  :   /lazy/list run listing</span>
<a name="l00603"></a>00603 <span class="comment">Output:</span>
<a name="l00604"></a>00604 <span class="comment">Function value:</span>
<a name="l00605"></a>00605 <span class="comment">Run number</span>
<a name="l00606"></a>00606 <span class="comment">-1       : run not found</span>
<a name="l00607"></a>00607 <span class="comment">\********************************************************************/</span>
<a name="l00608"></a>00608 {
<a name="l00609"></a>00609    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, ndo, nlog;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611    ndo = <a class="code" href="lazylogger_8c.html#a6391c3dee66f9029ace9906bd5a58ae4">tot_do_size</a> / <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>);
<a name="l00612"></a>00612    nlog = <a class="code" href="lazylogger_8c.html#a9cf6c66bbf8da33919c7941123d52e2b">tot_dirlog_size</a> / <span class="keyword">sizeof</span>(<a class="code" href="structDIRLOG.html">DIRLOG</a>);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614    <span class="keywordflow">for</span> (j = 0; j &lt; nlog; j++) {
<a name="l00615"></a>00615       <span class="keywordflow">for</span> (i = 0; i &lt; ndo; i++) {
<a name="l00616"></a>00616          <span class="keywordflow">if</span> ((plog + j)-&gt;run == pdo[i])
<a name="l00617"></a>00617             (plog + j)-&gt;run *= -1;
<a name="l00618"></a>00618       }
<a name="l00619"></a>00619    }
<a name="l00620"></a>00620    <span class="keywordflow">for</span> (j = 0; j &lt; nlog; j++) {
<a name="l00621"></a>00621       <span class="keywordflow">if</span> ((plog + j)-&gt;run &gt; 0)
<a name="l00622"></a>00622          <span class="keywordflow">return</span> (plog + j)-&gt;run;
<a name="l00623"></a>00623    }
<a name="l00624"></a>00624    <span class="keywordflow">return</span> -1;
<a name="l00625"></a>00625 }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00628"></a><a class="code" href="lazylogger_8c.html#a4776a2fa363c13eef86dc0a59e1186d0">00628</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a4776a2fa363c13eef86dc0a59e1186d0">lazy_select_purge</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>, <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> * pLall, <span class="keywordtype">char</span> *<a class="code" href="ybos_8c.html#a7ab994c987ffba39688c74f10907429c">fmt</a>, <span class="keywordtype">char</span> *dir,
<a name="l00629"></a>00629                       <span class="keywordtype">char</span> *fpufile, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> * <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>)
<a name="l00630"></a>00630 <span class="comment">/********************************************************************\</span>
<a name="l00631"></a>00631 <span class="comment">Routine: lazy_select_purge</span>
<a name="l00632"></a>00632 <span class="comment">Purpose: Search oldest run number which can be purged</span>
<a name="l00633"></a>00633 <span class="comment">condition : oldest run# in (pdo AND present in plog)</span>
<a name="l00634"></a>00634 <span class="comment">AND scan all the other channels based on the following</span>
<a name="l00635"></a>00635 <span class="comment">conditions:</span>
<a name="l00636"></a>00636 <span class="comment">&quot;data dir&quot; &amp;&amp; &quot;filename format&quot; are the same &amp;&amp;</span>
<a name="l00637"></a>00637 <span class="comment">the /list/run_number exists in all the above condition.</span>
<a name="l00638"></a>00638 <span class="comment">Input:</span>
<a name="l00639"></a>00639 <span class="comment">hKey      : Current channel key</span>
<a name="l00640"></a>00640 <span class="comment">channel   : Current channel number</span>
<a name="l00641"></a>00641 <span class="comment">*pLall    : Pointer to all channels</span>
<a name="l00642"></a>00642 <span class="comment">fmt       : Format string</span>
<a name="l00643"></a>00643 <span class="comment">dir       : Directory string</span>
<a name="l00644"></a>00644 <span class="comment">Output:</span>
<a name="l00645"></a>00645 <span class="comment">fpufile   : file to purge</span>
<a name="l00646"></a>00646 <span class="comment">run       : corresponding run# to be purged</span>
<a name="l00647"></a>00647 <span class="comment">Function value:</span>
<a name="l00648"></a>00648 <span class="comment">0          success</span>
<a name="l00649"></a>00649 <span class="comment">-1         run not found</span>
<a name="l00650"></a>00650 <span class="comment">\********************************************************************/</span>
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652    <a class="code" href="structDIRLOG.html">DIRLOG</a> *pdirlog = NULL;
<a name="l00653"></a>00653    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *pdonelist = NULL, *potherlist = NULL, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l00654"></a>00654    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="odbhist_8c.html#a43fa990200c3ddd47c35f151bd4d66bf">k</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, ndone, nother, nfile;
<a name="l00655"></a>00655    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> mark;
<a name="l00656"></a>00656    <span class="keywordtype">char</span> pufile[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];
<a name="l00657"></a>00657    <span class="keywordtype">char</span> ddir[256], ff[128], strmodulo[8];
<a name="l00658"></a>00658    <span class="keywordtype">char</span> cdir[256], cff[128];
<a name="l00659"></a>00659 
<a name="l00660"></a>00660    <span class="comment">/* Scan donelist from first element (oldest)</span>
<a name="l00661"></a>00661 <span class="comment">      check if run exists in dirlog</span>
<a name="l00662"></a>00662 <span class="comment">      if yes return file and run number */</span>
<a name="l00663"></a>00663 
<a name="l00664"></a>00664    <span class="comment">/* get current specification */</span>
<a name="l00665"></a>00665    size = <span class="keyword">sizeof</span>(cdir);
<a name="l00666"></a>00666    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Settings/Data dir&quot;</span>, cdir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00667"></a>00667    size = <span class="keyword">sizeof</span>(cff);
<a name="l00668"></a>00668    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Settings/filename format&quot;</span>, cff, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00669"></a>00669    <span class="keywordflow">while</span> (1) {
<a name="l00670"></a>00670       <span class="comment">/* try to find the oldest matching run present in the list AND on disk */</span>
<a name="l00671"></a>00671       <span class="comment">/* build current done list */</span>
<a name="l00672"></a>00672       <span class="keywordflow">if</span> (pdonelist == NULL)
<a name="l00673"></a>00673          pdonelist = malloc(<span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l00674"></a>00674       <span class="keywordflow">if</span> (potherlist == NULL)
<a name="l00675"></a>00675          potherlist = malloc(<span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l00676"></a>00676 
<a name="l00677"></a>00677       <span class="comment">/* Build current done list (run list already backed up) */</span>
<a name="l00678"></a>00678       ndone = <a class="code" href="lazylogger_8c.html#aa7ddec3eef679124780e21119710ac6a">build_done_list</a>(hKey, &amp;pdonelist);
<a name="l00679"></a>00679 
<a name="l00680"></a>00680       <span class="comment">/* build matching dir and file format (ff) */</span>
<a name="l00681"></a>00681       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="lazylogger_8c.html#a869fa7fe9076c407092370aaf05831c6">MAX_LAZY_CHANNEL</a>; i++) {
<a name="l00682"></a>00682          (pLall + i)-&gt;<a class="code" href="msc_8c.html#ac882565d6dced9dd3517656f6200eb3d">match</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00683"></a>00683          <span class="comment">/* Check if key present &amp;&amp; key different than currrent</span>
<a name="l00684"></a>00684 <span class="comment">            and if modulo is off */</span>
<a name="l00685"></a>00685          <span class="keywordflow">if</span> (((pLall + i)-&gt;hKey) &amp;&amp; (hKey != (pLall + i)-&gt;hKey)) {
<a name="l00686"></a>00686             <span class="comment">/* extract dir and ff */</span>
<a name="l00687"></a>00687             size = <span class="keyword">sizeof</span>(strmodulo);
<a name="l00688"></a>00688             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, (pLall + i)-&gt;hKey, <span class="stringliteral">&quot;Settings/Modulo.Position&quot;</span>, strmodulo,
<a name="l00689"></a>00689                          &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00690"></a>00690             <span class="keywordflow">if</span> (strmodulo[0]) {
<a name="l00691"></a>00691                <span class="comment">/* Modulo enabled, skip this channel */</span>
<a name="l00692"></a>00692                <span class="keywordflow">continue</span>;
<a name="l00693"></a>00693             }
<a name="l00694"></a>00694             size = <span class="keyword">sizeof</span>(ddir);
<a name="l00695"></a>00695             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, (pLall + i)-&gt;hKey, <span class="stringliteral">&quot;Settings/Data dir&quot;</span>, ddir, &amp;size,
<a name="l00696"></a>00696                          <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00697"></a>00697             size = <span class="keyword">sizeof</span>(ff);
<a name="l00698"></a>00698             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, (pLall + i)-&gt;hKey, <span class="stringliteral">&quot;Settings/filename format&quot;</span>, ff, &amp;size,
<a name="l00699"></a>00699                          <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701             <span class="comment">/* if same dir &amp;&amp; same ff =&gt; mark lazy channel */</span>
<a name="l00702"></a>00702             <span class="keywordflow">if</span> ((strcmp(ddir, cdir) == 0) &amp;&amp; (strcmp(ff, cff) == 0))
<a name="l00703"></a>00703                (pLall + i)-&gt;<a class="code" href="msc_8c.html#ac882565d6dced9dd3517656f6200eb3d">match</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00704"></a>00704          }
<a name="l00705"></a>00705       }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707       <span class="comment">/* scan matching run number */</span>
<a name="l00708"></a>00708       <span class="keywordflow">for</span> (i = 0; i &lt; MAX_LAZY_CHANNEL; i++) {
<a name="l00709"></a>00709          <span class="comment">/* For all matches channels, build done list */</span>
<a name="l00710"></a>00710          <span class="keywordflow">if</span> ((pLall + i)-&gt;match) {
<a name="l00711"></a>00711             <span class="comment">/* build done list for that channel */</span>
<a name="l00712"></a>00712             nother = <a class="code" href="lazylogger_8c.html#aa7ddec3eef679124780e21119710ac6a">build_done_list</a>((pLall + i)-&gt;hKey, &amp;potherlist);
<a name="l00713"></a>00713 
<a name="l00714"></a>00714             <span class="comment">/* search for run match */</span>
<a name="l00715"></a>00715             <span class="keywordflow">for</span> (k = 0; k &lt; ndone; k++) {
<a name="l00716"></a>00716                mark = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00717"></a>00717                <span class="keywordflow">for</span> (j = 0; j &lt; nother; j++) {
<a name="l00718"></a>00718                   <span class="keywordflow">if</span> ((potherlist[j] == pdonelist[k]) &amp;&amp; (pdonelist[k] != 0))
<a name="l00719"></a>00719                      mark = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00720"></a>00720                }
<a name="l00721"></a>00721                <span class="keywordflow">if</span> (!mark)
<a name="l00722"></a>00722                   pdonelist[k] = 0;
<a name="l00723"></a>00723             }
<a name="l00724"></a>00724          }
<a name="l00725"></a>00725       }
<a name="l00726"></a>00726 
<a name="l00727"></a>00727       <span class="comment">/* Take the first run from pdonelist (already sorted) to purge */</span>
<a name="l00728"></a>00728       <span class="keywordflow">for</span> (i = 0; i &lt; ndone; i++) {
<a name="l00729"></a>00729          <span class="keywordflow">if</span> (pdonelist[i] != 0)
<a name="l00730"></a>00730             <span class="keywordflow">break</span>;
<a name="l00731"></a>00731       }
<a name="l00732"></a>00732       <span class="comment">/* return -1 if no run found */</span>
<a name="l00733"></a>00733       <span class="keywordflow">if</span> (i == ndone)
<a name="l00734"></a>00734          <span class="keywordflow">return</span> -1;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736       <span class="comment">/* pdonelist[i] is the oldest run common to all the valid channels */</span>
<a name="l00737"></a>00737       *run = pdonelist[i];
<a name="l00738"></a>00738       <span class="keywordflow">if</span> (pdonelist)
<a name="l00739"></a>00739          free(pdonelist);
<a name="l00740"></a>00740       pdonelist = NULL;
<a name="l00741"></a>00741       <span class="keywordflow">if</span> (potherlist)
<a name="l00742"></a>00742          free(potherlist);
<a name="l00743"></a>00743       potherlist = NULL;
<a name="l00744"></a>00744 
<a name="l00745"></a>00745       <span class="comment">/* check if file is in the dir log (exists) */</span>
<a name="l00746"></a>00746       <span class="keywordflow">if</span> (pdirlog == NULL)
<a name="l00747"></a>00747          pdirlog = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structDIRLOG.html">DIRLOG</a>));
<a name="l00748"></a>00748       nfile = <a class="code" href="lazylogger_8c.html#a7c506cdc6c2ca31d03184f8b674198cf">build_log_list</a>(fmt, dir, &amp;pdirlog);
<a name="l00749"></a>00749       <span class="keywordflow">for</span> (i = 0; i &lt; nfile; i++) {
<a name="l00750"></a>00750          <span class="keywordflow">if</span> (pdirlog[i].run == *run) {
<a name="l00751"></a>00751             status = <a class="code" href="lazylogger_8c.html#a1fa437aa64a922839bd4124310107fe1">lazy_file_compose</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a681ec7fec002c3aa7686867f14394c48">backfmt</a>, lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, *run, fpufile, pufile);
<a name="l00752"></a>00752             <span class="keywordflow">if</span> (pdirlog)
<a name="l00753"></a>00753                free(pdirlog);
<a name="l00754"></a>00754             pdirlog = NULL;
<a name="l00755"></a>00755             <span class="keywordflow">return</span> 0;           <span class="comment">/* found can be selected */</span>
<a name="l00756"></a>00756          }
<a name="l00757"></a>00757       }
<a name="l00758"></a>00758       <span class="keywordflow">if</span> (pdirlog)
<a name="l00759"></a>00759          free(pdirlog);
<a name="l00760"></a>00760       pdirlog = NULL;
<a name="l00761"></a>00761 
<a name="l00762"></a>00762       <span class="comment">/* file not found synchronize listings and try again */</span>
<a name="l00763"></a>00763       status = <a class="code" href="lazylogger_8c.html#ab3161802cbf757fc6aa250446ddd61d6">lazy_remove_entry</a>(channel, pLall, *run);
<a name="l00764"></a>00764    }
<a name="l00765"></a>00765 }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00768"></a><a class="code" href="lazylogger_8c.html#aa990fe8387881e9fd696493186e090af">00768</a> <span class="keywordtype">void</span> <a class="code" href="lazylogger_8c.html#aa990fe8387881e9fd696493186e090af">lazy_settings_hotlink</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="keywordtype">void</span> *info)
<a name="l00769"></a>00769 {
<a name="l00770"></a>00770    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, maintain;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772    <span class="comment">/* check if Maintain has been touched */</span>
<a name="l00773"></a>00773    size = <span class="keyword">sizeof</span>(maintain);
<a name="l00774"></a>00774    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, hKey, <span class="stringliteral">&quot;Maintain free space(%)&quot;</span>, &amp;maintain, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00775"></a>00775    <span class="keywordflow">if</span> (maintain != 0)
<a name="l00776"></a>00776       <a class="code" href="lazylogger_8c.html#af46961b06b084613767839d2ac89a707">maintain_touched</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00777"></a>00777    <span class="keywordflow">else</span>
<a name="l00778"></a>00778       <a class="code" href="lazylogger_8c.html#af46961b06b084613767839d2ac89a707">maintain_touched</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00779"></a>00779 }
<a name="l00780"></a>00780 
<a name="l00781"></a>00781 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00782"></a><a class="code" href="lazylogger_8c.html#a34002378b03a28414a0e4cd300372d55">00782</a> <span class="keywordtype">void</span> <a class="code" href="lazylogger_8c.html#a34002378b03a28414a0e4cd300372d55">lazy_maintain_check</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> * pLall)
<a name="l00783"></a>00783 <span class="comment">/********************************************************************\</span>
<a name="l00784"></a>00784 <span class="comment">Routine: lazy_maintain_check</span>
<a name="l00785"></a>00785 <span class="comment">Purpose: Check if the &quot;maintain free space&quot; of any of the other matching</span>
<a name="l00786"></a>00786 <span class="comment">channels is != 0. matching correspond to the condition:</span>
<a name="l00787"></a>00787 <span class="comment">&quot;data dir&quot; &amp;&amp; &quot;filename format&quot;</span>
<a name="l00788"></a>00788 <span class="comment">if found != 0 then set to 0 and inform</span>
<a name="l00789"></a>00789 <span class="comment">Input:</span>
<a name="l00790"></a>00790 <span class="comment">hKey   :   Current lazy channel key</span>
<a name="l00791"></a>00791 <span class="comment">*pLall :   Pointer to all channels</span>
<a name="l00792"></a>00792 <span class="comment">\********************************************************************/</span>
<a name="l00793"></a>00793 {
<a name="l00794"></a>00794    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l00795"></a>00795    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, maintain;
<a name="l00796"></a>00796    <span class="keywordtype">char</span> dir[256], ff[128];
<a name="l00797"></a>00797    <span class="keywordtype">char</span> cdir[256], cff[128];
<a name="l00798"></a>00798    <span class="keywordtype">char</span> cmodulostr[8], modulostr[8];
<a name="l00799"></a>00799 
<a name="l00800"></a>00800    <span class="comment">/* do test only if maintain has been touched */</span>
<a name="l00801"></a>00801    <span class="keywordflow">if</span> (!<a class="code" href="lazylogger_8c.html#af46961b06b084613767839d2ac89a707">maintain_touched</a>)
<a name="l00802"></a>00802       <span class="keywordflow">return</span>;
<a name="l00803"></a>00803    <a class="code" href="lazylogger_8c.html#af46961b06b084613767839d2ac89a707">maintain_touched</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805    <span class="comment">/* check is Maintain free is enabled */</span>
<a name="l00806"></a>00806    size = <span class="keyword">sizeof</span>(maintain);
<a name="l00807"></a>00807    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Settings/Maintain free space(%)&quot;</span>, &amp;maintain, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>,
<a name="l00808"></a>00808                 <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00809"></a>00809    <span class="keywordflow">if</span> (maintain != 0) {
<a name="l00810"></a>00810       <span class="comment">/* scan other channels */</span>
<a name="l00811"></a>00811 
<a name="l00812"></a>00812       <span class="comment">/* get current specification */</span>
<a name="l00813"></a>00813       size = <span class="keyword">sizeof</span>(cdir);
<a name="l00814"></a>00814       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Settings/Data dir&quot;</span>, cdir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00815"></a>00815       size = <span class="keyword">sizeof</span>(cff);
<a name="l00816"></a>00816       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Settings/filename format&quot;</span>, cff, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00817"></a>00817       size = <span class="keyword">sizeof</span>(modulostr);
<a name="l00818"></a>00818       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Settings/Modulo.Position&quot;</span>, cmodulostr, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>,
<a name="l00819"></a>00819                    <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00820"></a>00820 
<a name="l00821"></a>00821       <span class="comment">/* build matching dir and ff */</span>
<a name="l00822"></a>00822       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="lazylogger_8c.html#a869fa7fe9076c407092370aaf05831c6">MAX_LAZY_CHANNEL</a>; i++) {
<a name="l00823"></a>00823          <span class="keywordflow">if</span> (((pLall + i)-&gt;hKey) &amp;&amp; (hKey != (pLall + i)-&gt;hKey)) {      <span class="comment">/* valid channel */</span>
<a name="l00824"></a>00824             size = <span class="keyword">sizeof</span>(dir);
<a name="l00825"></a>00825             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, (pLall + i)-&gt;hKey, <span class="stringliteral">&quot;Settings/Data dir&quot;</span>, dir, &amp;size,
<a name="l00826"></a>00826                          <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00827"></a>00827             size = <span class="keyword">sizeof</span>(ff);
<a name="l00828"></a>00828             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, (pLall + i)-&gt;hKey, <span class="stringliteral">&quot;Settings/filename format&quot;</span>, ff, &amp;size,
<a name="l00829"></a>00829                          <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00830"></a>00830             size = <span class="keyword">sizeof</span>(modulostr);
<a name="l00831"></a>00831             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, (pLall + i)-&gt;hKey, <span class="stringliteral">&quot;Settings/Modulo.Position&quot;</span>, modulostr,
<a name="l00832"></a>00832                          &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834 
<a name="l00835"></a>00835             <span class="keywordflow">if</span> ((strcmp(dir, cdir) == 0) &amp;&amp; (strcmp(ff, cff) == 0) &amp;&amp; !cmodulostr[0]
<a name="l00836"></a>00836                 &amp;&amp; !modulostr[0]) {
<a name="l00837"></a>00837                <span class="comment">/* check &quot;maintain free space&quot; */</span>
<a name="l00838"></a>00838                size = <span class="keyword">sizeof</span>(maintain);
<a name="l00839"></a>00839                <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, (pLall + i)-&gt;hKey, <span class="stringliteral">&quot;Settings/Maintain free space(%)&quot;</span>,
<a name="l00840"></a>00840                             &amp;maintain, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00841"></a>00841                <span class="keywordflow">if</span> (maintain) {
<a name="l00842"></a>00842                   <span class="comment">/* disable and inform */</span>
<a name="l00843"></a>00843                   size = <span class="keyword">sizeof</span>(maintain);
<a name="l00844"></a>00844                   maintain = 0;
<a name="l00845"></a>00845                   <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, (pLall + i)-&gt;hKey, <span class="stringliteral">&quot;Settings/Maintain free space(%)&quot;</span>,
<a name="l00846"></a>00846                                &amp;maintain, size, 1, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l00847"></a>00847                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;lazy_maintain_check&quot;</span>,
<a name="l00848"></a>00848                          <span class="stringliteral">&quot;Maintain free space on channel %s has been disable&quot;</span>,
<a name="l00849"></a>00849                          (pLall + i)-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l00850"></a>00850                }
<a name="l00851"></a>00851             }
<a name="l00852"></a>00852          }
<a name="l00853"></a>00853       }
<a name="l00854"></a>00854    }
<a name="l00855"></a>00855 }
<a name="l00856"></a>00856 
<a name="l00857"></a>00857 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00858"></a><a class="code" href="lazylogger_8c.html#ab3161802cbf757fc6aa250446ddd61d6">00858</a> <span class="keywordtype">int</span> <a class="code" href="lazylogger_8c.html#ab3161802cbf757fc6aa250446ddd61d6">lazy_remove_entry</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>, <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> * pLall, <span class="keywordtype">int</span> <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>)
<a name="l00859"></a>00859 <span class="comment">/********************************************************************\</span>
<a name="l00860"></a>00860 <span class="comment">Routine: lazy_remove_entry</span>
<a name="l00861"></a>00861 <span class="comment">Purpose: remove run entry in all the /Lazy_.../list being marked by</span>
<a name="l00862"></a>00862 <span class="comment">         lazy_select_purge</span>
<a name="l00863"></a>00863 <span class="comment">Input:</span>
<a name="l00864"></a>00864 <span class="comment">channel : Current Channel</span>
<a name="l00865"></a>00865 <span class="comment">*pLall  : Pointer to all channels</span>
<a name="l00866"></a>00866 <span class="comment">run     : run number to be removed</span>
<a name="l00867"></a>00867 <span class="comment">Output:</span>
<a name="l00868"></a>00868 <span class="comment">Function value:</span>
<a name="l00869"></a>00869 <span class="comment">0             success</span>
<a name="l00870"></a>00870 <span class="comment">-1            run not found</span>
<a name="l00871"></a>00871 <span class="comment">\********************************************************************/</span>
<a name="l00872"></a>00872 {
<a name="l00873"></a>00873    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="odbhist_8c.html#a43fa990200c3ddd47c35f151bd4d66bf">k</a>;
<a name="l00874"></a>00874    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *potherlist = NULL, nother;
<a name="l00875"></a>00875    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="patch__mevb_8cpp.html#a408216eef095a35ba3963fc6f4f4d7a8">found</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00876"></a>00876    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#aac58a320ae0ebf75ec6d8a273184b463">hSubkey</a>;
<a name="l00877"></a>00877    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l00878"></a>00878 
<a name="l00879"></a>00879    <span class="comment">/* mark current channel for removing entry too */</span>
<a name="l00880"></a>00880    (pLall + channel)-&gt;<a class="code" href="msc_8c.html#ac882565d6dced9dd3517656f6200eb3d">match</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00881"></a>00881    <span class="keywordflow">if</span> (potherlist == NULL)
<a name="l00882"></a>00882       potherlist = malloc(<span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l00883"></a>00883 
<a name="l00884"></a>00884    <span class="comment">/* scan matching run number */</span>
<a name="l00885"></a>00885    <span class="keywordflow">for</span> (k = 0; k &lt; <a class="code" href="lazylogger_8c.html#a869fa7fe9076c407092370aaf05831c6">MAX_LAZY_CHANNEL</a>; k++) {     <span class="comment">/* skip if no dir and no ff match */</span>
<a name="l00886"></a>00886       <span class="keywordflow">if</span> ((pLall + k)-&gt;<a class="code" href="msc_8c.html#ac882565d6dced9dd3517656f6200eb3d">match</a>) {
<a name="l00887"></a>00887          <span class="comment">/* search for the proper array to remove the entry */</span>
<a name="l00888"></a>00888          <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l00889"></a>00889             found = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00890"></a>00890             <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, (pLall + k)-&gt;<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="stringliteral">&quot;List&quot;</span>, &amp;<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00891"></a>00891                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;lazy_entry_remove&quot;</span>, <span class="stringliteral">&quot;Did not found %s/list&quot;</span>,
<a name="l00892"></a>00892                       (pLall + k)-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l00893"></a>00893                <span class="keywordflow">return</span> -1;
<a name="l00894"></a>00894             }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896             <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, i, &amp;hSubkey);
<a name="l00897"></a>00897             <span class="keywordflow">if</span> (!hSubkey)
<a name="l00898"></a>00898                <span class="keywordflow">break</span>;
<a name="l00899"></a>00899             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hSubkey, &amp;key);
<a name="l00900"></a>00900             size = key.<a class="code" href="group__midasincludecode.html#ga553ba6fe87ca0b1dd08bcdc8fa15e6fa">total_size</a>;
<a name="l00901"></a>00901             nother = key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l00902"></a>00902             potherlist = (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) realloc(potherlist, size);
<a name="l00903"></a>00903             <a class="code" href="group__msectionh.html#gaae4cf88eaadf5d2dd9eefa3e1b6389e6">db_get_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hSubkey, (<span class="keywordtype">char</span> *) potherlist, &amp;size, 0);
<a name="l00904"></a>00904             <span class="comment">/* match run number */</span>
<a name="l00905"></a>00905             <span class="keywordflow">for</span> (j = 0; j &lt; nother; j++) {
<a name="l00906"></a>00906                <span class="keywordflow">if</span> (*(potherlist + j) == run)
<a name="l00907"></a>00907                   found = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00908"></a>00908                <span class="keywordflow">if</span> (found)
<a name="l00909"></a>00909                   <span class="keywordflow">if</span> (j + 1 &lt; nother)
<a name="l00910"></a>00910                      *(potherlist + j) = *(potherlist + j + 1);
<a name="l00911"></a>00911             }
<a name="l00912"></a>00912             <span class="comment">/* delete label[] or update label[] */</span>
<a name="l00913"></a>00913             <span class="keywordflow">if</span> (found) {
<a name="l00914"></a>00914                nother--;
<a name="l00915"></a>00915                <span class="keywordflow">if</span> (nother &gt; 0)
<a name="l00916"></a>00916                   <a class="code" href="group__msectionh.html#ga6b98aa5ac9036c49023c0cc9353922d4">db_set_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hSubkey, potherlist, nother * <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>), nother,
<a name="l00917"></a>00917                               <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l00918"></a>00918                <span class="keywordflow">else</span>
<a name="l00919"></a>00919                   <a class="code" href="group__msectionh.html#ga91277a012e0bfddbc32885da450409e0">db_delete_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hSubkey, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00920"></a>00920                <a class="code" href="lazylogger_8c.html#a141d3e82085549ca775e167e8334de52">lazy_log_update</a>(<a class="code" href="lazylogger_8c.html#a43527bf47b67c185a10867fcb93fc4e4">REMOVE_ENTRY</a>, run, (pLall + k)-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, NULL, 0);
<a name="l00921"></a>00921             }
<a name="l00922"></a>00922          }
<a name="l00923"></a>00923       }
<a name="l00924"></a>00924    }
<a name="l00925"></a>00925    <span class="keywordflow">if</span> (potherlist)
<a name="l00926"></a>00926       free(potherlist);
<a name="l00927"></a>00927    potherlist = NULL;
<a name="l00928"></a>00928    <span class="keywordflow">return</span> 0;
<a name="l00929"></a>00929 }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00932"></a><a class="code" href="lazylogger_8c.html#a0d08e8d13b285a8754d67871c5a874f3">00932</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a0d08e8d13b285a8754d67871c5a874f3">lazy_update_list</a>(<a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> * pLinfo, <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> cp)
<a name="l00933"></a>00933 <span class="comment">/********************************************************************\</span>
<a name="l00934"></a>00934 <span class="comment">Routine: lazy_update_list</span>
<a name="l00935"></a>00935 <span class="comment">Purpose: update the /lazy/list tree with the info from lazy{}</span>
<a name="l00936"></a>00936 <span class="comment">Input:</span>
<a name="l00937"></a>00937 <span class="comment">*lLinfo: Current channel structure</span>
<a name="l00938"></a>00938 <span class="comment">cp     : Copy time in seconds</span>
<a name="l00939"></a>00939 <span class="comment">Output:</span>
<a name="l00940"></a>00940 <span class="comment">Function value:</span>
<a name="l00941"></a>00941 <span class="comment">DB_SUCCESS   : update ok</span>
<a name="l00942"></a>00942 <span class="comment">\********************************************************************/</span>
<a name="l00943"></a>00943 {
<a name="l00944"></a>00944    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, ifiles;
<a name="l00945"></a>00945    <span class="keywordtype">char</span> *ptape = NULL, <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];
<a name="l00946"></a>00946    <a class="code" href="structKEY.html">KEY</a> Keylabel;
<a name="l00947"></a>00947    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> mone = -1;
<a name="l00948"></a>00948 
<a name="l00949"></a>00949    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hKeylabel;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    <span class="comment">/* check if dir exists */</span>
<a name="l00952"></a>00952    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, pLinfo-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, <span class="stringliteral">&quot;List&quot;</span>, &amp;<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {   <span class="comment">/* list doesn&apos;t exists */</span>
<a name="l00953"></a>00953       sprintf(str, <span class="stringliteral">&quot;List/%s&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>);
<a name="l00954"></a>00954       <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, pLinfo-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, str, &amp;mone, <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>), 1, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l00955"></a>00955       <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, pLinfo-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, <span class="stringliteral">&quot;List&quot;</span>, &amp;<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>);
<a name="l00956"></a>00956    }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958    <span class="comment">/*  record the saved run */</span>
<a name="l00959"></a>00959    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>, &amp;hKeylabel) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {      <span class="comment">/* run array already present ==&gt; append run */</span>
<a name="l00960"></a>00960       <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeylabel, &amp;Keylabel);
<a name="l00961"></a>00961       ifiles = Keylabel.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l00962"></a>00962       ptape = malloc(Keylabel.<a class="code" href="group__midasincludecode.html#ga553ba6fe87ca0b1dd08bcdc8fa15e6fa">total_size</a>);
<a name="l00963"></a>00963       size = Keylabel.<a class="code" href="group__midasincludecode.html#ga553ba6fe87ca0b1dd08bcdc8fa15e6fa">total_size</a>;
<a name="l00964"></a>00964       <a class="code" href="group__msectionh.html#gad6e53374f24813cdba8713781683c556">db_get_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeylabel, ptape, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l00965"></a>00965       <span class="keywordflow">if</span> ((size == <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>)) &amp;&amp; (*ptape == -1)) {
<a name="l00966"></a>00966          ifiles = 1;
<a name="l00967"></a>00967          size = <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>);
<a name="l00968"></a>00968          memcpy((<span class="keywordtype">char</span> *) ptape, (<span class="keywordtype">char</span> *) &amp;lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a>, <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l00969"></a>00969       } <span class="keywordflow">else</span> {
<a name="l00970"></a>00970          ptape = realloc((<span class="keywordtype">char</span> *) ptape, size + <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l00971"></a>00971          memcpy((<span class="keywordtype">char</span> *) ptape + size, (<span class="keywordtype">char</span> *) &amp;lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a>, <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l00972"></a>00972          ifiles += 1;
<a name="l00973"></a>00973          size += <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>);
<a name="l00974"></a>00974       }
<a name="l00975"></a>00975       <a class="code" href="group__msectionh.html#ga6b98aa5ac9036c49023c0cc9353922d4">db_set_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeylabel, (<span class="keywordtype">char</span> *) ptape, size, ifiles, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l00976"></a>00976    } <span class="keywordflow">else</span> {                     <span class="comment">/* new run array ==&gt; */</span>
<a name="l00977"></a>00977       size = <span class="keyword">sizeof</span>(lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a>);
<a name="l00978"></a>00978       <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>, &amp;lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a>, size, 1, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l00979"></a>00979    }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981    <a class="code" href="lazylogger_8c.html#a141d3e82085549ca775e167e8334de52">lazy_log_update</a>(<a class="code" href="lazylogger_8c.html#a4b5a4ed2c294492ec8721c9428f41eb0">NEW_FILE</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a>, lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>, cp);
<a name="l00982"></a>00982 
<a name="l00983"></a>00983    <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#ab2f0c1e68c31ad3f94f2f056bd1fdf9e">msg_flag</a>)
<a name="l00984"></a>00984       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;         lazy job %s done!&quot;</span>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>);
<a name="l00985"></a>00985 
<a name="l00986"></a>00986    <span class="keywordflow">if</span> (ptape)
<a name="l00987"></a>00987       free(ptape);
<a name="l00988"></a>00988 
<a name="l00989"></a>00989    <a class="code" href="group__msectionh.html#ga90c77b8a4ca06f60b0f595c8f16a39bc">db_send_changed_records</a>();
<a name="l00990"></a>00990    <span class="keywordflow">return</span> <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>;
<a name="l00991"></a>00991 }
<a name="l00992"></a>00992 
<a name="l00993"></a>00993 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00994"></a><a class="code" href="lazylogger_8c.html#a1fa437aa64a922839bd4124310107fe1">00994</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a1fa437aa64a922839bd4124310107fe1">lazy_file_compose</a>(<span class="keywordtype">char</span> *<a class="code" href="ybos_8c.html#a7ab994c987ffba39688c74f10907429c">fmt</a>, <span class="keywordtype">char</span> *dir, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> num, <span class="keywordtype">char</span> *ffile, <span class="keywordtype">char</span> *file)
<a name="l00995"></a>00995 <span class="comment">/********************************************************************\</span>
<a name="l00996"></a>00996 <span class="comment">Routine: lazy_file_compose</span>
<a name="l00997"></a>00997 <span class="comment">Purpose: compose &quot;file&quot; with the args</span>
<a name="l00998"></a>00998 <span class="comment">Input:</span>
<a name="l00999"></a>00999 <span class="comment">char * fmt       file format</span>
<a name="l01000"></a>01000 <span class="comment">char * dir       data directory</span>
<a name="l01001"></a>01001 <span class="comment">INT num          run number</span>
<a name="l01002"></a>01002 <span class="comment">Output:</span>
<a name="l01003"></a>01003 <span class="comment">char * ffile     composed full file name (include path)</span>
<a name="l01004"></a>01004 <span class="comment">char * file      composed file name (translated with fmt only)</span>
<a name="l01005"></a>01005 <span class="comment">Function value:</span>
<a name="l01006"></a>01006 <span class="comment">0           success</span>
<a name="l01007"></a>01007 <span class="comment">\********************************************************************/</span>
<a name="l01008"></a>01008 {
<a name="l01009"></a>01009    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];
<a name="l01010"></a>01010    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l01011"></a>01011 
<a name="l01012"></a>01012    size = <span class="keyword">sizeof</span>(dir);
<a name="l01013"></a>01013    <span class="keywordflow">if</span> (dir[0] != 0)
<a name="l01014"></a>01014       <span class="keywordflow">if</span> (dir[strlen(dir) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l01015"></a>01015          strcat(dir, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l01016"></a>01016    strcpy(str, dir);
<a name="l01017"></a>01017    strcat(str, fmt);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019    <span class="comment">/* substitue &quot;%d&quot; by current run number [Full file name] */</span>
<a name="l01020"></a>01020    <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>))
<a name="l01021"></a>01021       sprintf(ffile, str, num);
<a name="l01022"></a>01022    <span class="keywordflow">else</span>
<a name="l01023"></a>01023       strcpy(ffile, str);
<a name="l01024"></a>01024 
<a name="l01025"></a>01025    <span class="comment">/* substitue &quot;%d&quot; by current run number */</span>
<a name="l01026"></a>01026    strcpy(str, fmt);
<a name="l01027"></a>01027    <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>))
<a name="l01028"></a>01028       sprintf(file, str, num);
<a name="l01029"></a>01029    <span class="keywordflow">else</span>
<a name="l01030"></a>01030       strcpy(file, str);
<a name="l01031"></a>01031    <span class="keywordflow">return</span> 0;
<a name="l01032"></a>01032 }
<a name="l01033"></a>01033 
<a name="l01034"></a>01034 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01035"></a><a class="code" href="lazylogger_8c.html#a6e9cca13c2c01408370627dc6da67e7c">01035</a> <span class="keywordtype">void</span> <a class="code" href="lazylogger_8c.html#a6e9cca13c2c01408370627dc6da67e7c">lazy_statistics_update</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> cploop_time)
<a name="l01036"></a>01036 <span class="comment">/********************************************************************\</span>
<a name="l01037"></a>01037 <span class="comment">Routine: lazy_statistics_update</span>
<a name="l01038"></a>01038 <span class="comment">Purpose: update the /lazy/statistics</span>
<a name="l01039"></a>01039 <span class="comment">Input:</span>
<a name="l01040"></a>01040 <span class="comment">INT cploop_time : time of the last call</span>
<a name="l01041"></a>01041 <span class="comment">Output:</span>
<a name="l01042"></a>01042 <span class="comment">Function value:</span>
<a name="l01043"></a>01043 <span class="comment">0           success</span>
<a name="l01044"></a>01044 <span class="comment">\********************************************************************/</span>
<a name="l01045"></a>01045 {
<a name="l01046"></a>01046    <span class="comment">/* update rate [kb/s] statistics */</span>
<a name="l01047"></a>01047    <span class="keywordflow">if</span> ((<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - cploop_time) &gt; 100)
<a name="l01048"></a>01048       lazyst.<a class="code" href="structLAZY__STATISTICS.html#a285009f5daddc39f4e669b0473af049f">copy_rate</a> =
<a name="l01049"></a>01049           1000.f * (lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7bb4f126f3eceeb30af4d19d29c4a539">cur_size</a> - <a class="code" href="lazylogger_8c.html#af66a172e1d1f56385eec5bbd52e97a66">lastsz</a>) / (<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - cploop_time);
<a name="l01050"></a>01050    <span class="keywordflow">if</span> (lazyst.<a class="code" href="structLAZY__STATISTICS.html#a285009f5daddc39f4e669b0473af049f">copy_rate</a> &lt; 0.0)
<a name="l01051"></a>01051       lazyst.<a class="code" href="structLAZY__STATISTICS.html#a285009f5daddc39f4e669b0473af049f">copy_rate</a> = 0.0;
<a name="l01052"></a>01052 
<a name="l01053"></a>01053    <span class="comment">/* update % statistics */</span>
<a name="l01054"></a>01054    <span class="keywordflow">if</span> (lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7759604df39f4a0923e7711d12ac092b">file_size</a> != 0.0f)
<a name="l01055"></a>01055       lazyst.<a class="code" href="structLAZY__STATISTICS.html#a3c8c8b2e1497798143f4f16e9fbbefab">progress</a> = (100.0f * (lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7bb4f126f3eceeb30af4d19d29c4a539">cur_size</a> / lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7759604df39f4a0923e7711d12ac092b">file_size</a>));
<a name="l01056"></a>01056    <span class="keywordflow">else</span>
<a name="l01057"></a>01057       lazyst.<a class="code" href="structLAZY__STATISTICS.html#a3c8c8b2e1497798143f4f16e9fbbefab">progress</a> = 0.0f;
<a name="l01058"></a>01058 
<a name="l01059"></a>01059    <span class="comment">/* update backup % statistics */</span>
<a name="l01060"></a>01060    <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a2d138f987eb40a796eb348569c6b3785">capacity</a> &gt; 0.0f)
<a name="l01061"></a>01061       lazyst.<a class="code" href="structLAZY__STATISTICS.html#ab5308323c830c8c2ba5887700e26f98d">bckfill</a> = 100.0f * (lazyst.<a class="code" href="structLAZY__STATISTICS.html#a96f3d631abc3ff0170e87f761b1485a1">cur_dev_size</a> / lazy.<a class="code" href="structLAZY__SETTING.html#a2d138f987eb40a796eb348569c6b3785">capacity</a>);
<a name="l01062"></a>01062    <span class="keywordflow">else</span>
<a name="l01063"></a>01063       lazyst.<a class="code" href="structLAZY__STATISTICS.html#ab5308323c830c8c2ba5887700e26f98d">bckfill</a> = 0.0f;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065    <a class="code" href="lazylogger_8c.html#af66a172e1d1f56385eec5bbd52e97a66">lastsz</a> = lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7bb4f126f3eceeb30af4d19d29c4a539">cur_size</a>;
<a name="l01066"></a>01066    <span class="comment">/* udate ODB statistics */</span>
<a name="l01067"></a>01067    <a class="code" href="group__msectionh.html#ga90c77b8a4ca06f60b0f595c8f16a39bc">db_send_changed_records</a>();
<a name="l01068"></a>01068 }
<a name="l01069"></a>01069 
<a name="l01070"></a>01070 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01071"></a><a class="code" href="lazylogger_8c.html#ad438c7673adf3c4cd97b8cef90d072b9">01071</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="lazylogger_8c.html#ad438c7673adf3c4cd97b8cef90d072b9">condition_test</a>(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>)
<a name="l01072"></a>01072 <span class="comment">/********************************************************************\</span>
<a name="l01073"></a>01073 <span class="comment">Routine: condition_check</span>
<a name="l01074"></a>01074 <span class="comment">Purpose: return TRUE or FALSE depending if condition is satisfied</span>
<a name="l01075"></a>01075 <span class="comment">I expect a statement of the following form:</span>
<a name="l01076"></a>01076 <span class="comment">&lt;key&gt; &lt;operator&gt; &lt;value&gt;</span>
<a name="l01077"></a>01077 <span class="comment">with &lt;key&gt; : either link or key[index] or key(index)</span>
<a name="l01078"></a>01078 <span class="comment">&lt;operator&gt; : either: = &lt; &gt;</span>
<a name="l01079"></a>01079 <span class="comment">&lt;value&gt; : [+/-][digits]</span>
<a name="l01080"></a>01080 <span class="comment">Input: char * string to decode and test</span>
<a name="l01081"></a>01081 <span class="comment">Output:</span>
<a name="l01082"></a>01082 <span class="comment">Function value:</span>
<a name="l01083"></a>01083 <span class="comment">TRUE           condition TRUE  (carry on the copy)</span>
<a name="l01084"></a>01084 <span class="comment">FALSE          condition FALSE (hold the copy)</span>
<a name="l01085"></a>01085 <span class="comment">\********************************************************************/</span>
<a name="l01086"></a>01086 {
<a name="l01087"></a>01087    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l01088"></a>01088    <span class="keywordtype">float</span> <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>;
<a name="l01089"></a>01089    <span class="keywordtype">double</span> lcond_value;
<a name="l01090"></a>01090    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01091"></a>01091    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[128], left[64], right[64];
<a name="l01092"></a>01092    <span class="keywordtype">char</span> *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a> = NULL, *pp, *ppl, *pc, *lp;
<a name="l01093"></a>01093 
<a name="l01094"></a>01094    index = 0;
<a name="l01095"></a>01095    p = string;
<a name="l01096"></a>01096    <span class="keywordflow">if</span> (p) {
<a name="l01097"></a>01097       <span class="keywordflow">while</span> (isspace(*p))
<a name="l01098"></a>01098          p++;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100       pc = strpbrk(p, <span class="stringliteral">&quot;&lt;=&gt;&quot;</span>);
<a name="l01101"></a>01101       <span class="keywordflow">if</span> (pc) {
<a name="l01102"></a>01102          strncpy(left, p, pc - p);
<a name="l01103"></a>01103          lp = left + (pc - p - 1);
<a name="l01104"></a>01104          <span class="keywordflow">while</span> (isspace(*lp))
<a name="l01105"></a>01105             lp--;
<a name="l01106"></a>01106          *(lp + 1) = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01107"></a>01107          strncpy(right, pc + 1, (strlen(p) - strlen(left)));
<a name="l01108"></a>01108          right[strlen(p) - strlen(left) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01109"></a>01109       }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111       <span class="keywordflow">if</span> ((pp = strpbrk(left, <span class="stringliteral">&quot;[(&quot;</span>)) != NULL) {
<a name="l01112"></a>01112          <span class="keywordflow">if</span> ((ppl = strpbrk(left, <span class="stringliteral">&quot;])&quot;</span>)) != NULL) {
<a name="l01113"></a>01113             *pp = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01114"></a>01114             *ppl = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01115"></a>01115             index = atoi(pp + 1);
<a name="l01116"></a>01116          }
<a name="l01117"></a>01117          *pp = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01118"></a>01118       }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120       <span class="comment">/* convert value */</span>
<a name="l01121"></a>01121       value = (float) (atoi(right));
<a name="l01122"></a>01122 
<a name="l01123"></a>01123       status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, left, &amp;<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>);
<a name="l01124"></a>01124       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01125"></a>01125          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;condition_check&quot;</span>, <span class="stringliteral">&quot;Key %s not found&quot;</span>, left);
<a name="l01126"></a>01126          <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01127"></a>01127       }
<a name="l01128"></a>01128       status = <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, &amp;key);
<a name="l01129"></a>01129       <span class="keywordflow">if</span> ((status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) &amp;&amp; (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> &lt;= <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>)) {
<a name="l01130"></a>01130          <span class="comment">/* get value of the condition */</span>
<a name="l01131"></a>01131          size = <span class="keyword">sizeof</span>(lcond_value);
<a name="l01132"></a>01132          <a class="code" href="group__msectionh.html#gae5fdb22d30254c06d074236a1f93b0d6">db_get_data_index</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, &amp;lcond_value, &amp;size, index, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l01133"></a>01133          <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(str, &amp;lcond_value, key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>, 0, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l01134"></a>01134          lcond_value = atof(str);
<a name="l01135"></a>01135       }
<a name="l01136"></a>01136 
<a name="l01137"></a>01137       <span class="comment">/*  printf(&quot;string:%s\n condition: %s %f %c %f \n&quot;</span>
<a name="l01138"></a>01138 <span class="comment">         , string, left, lcond_value, *pc, value);</span>
<a name="l01139"></a>01139 <span class="comment">       */</span>
<a name="l01140"></a>01140       <span class="comment">/*</span>
<a name="l01141"></a>01141 <span class="comment">         if (pv == NULL)</span>
<a name="l01142"></a>01142 <span class="comment">         return TRUE;</span>
<a name="l01143"></a>01143 <span class="comment">       */</span>
<a name="l01144"></a>01144       <span class="comment">/* perform condition check */</span>
<a name="l01145"></a>01145       <span class="keywordflow">if</span> (((*pc == <span class="charliteral">&apos;&gt;&apos;</span>) &amp;&amp; ((<span class="keywordtype">float</span>) lcond_value &gt; value)) ||
<a name="l01146"></a>01146           ((*pc == <span class="charliteral">&apos;=&apos;</span>) &amp;&amp; ((<span class="keywordtype">float</span>) lcond_value == value)) ||
<a name="l01147"></a>01147           ((*pc == <span class="charliteral">&apos;&lt;&apos;</span>) &amp;&amp; ((<span class="keywordtype">float</span>) lcond_value &lt; value)))
<a name="l01148"></a>01148          <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01149"></a>01149       <span class="keywordflow">else</span>
<a name="l01150"></a>01150          <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01151"></a>01151    }
<a name="l01152"></a>01152    <span class="comment">/* catch wrong argument in the condition as TRUE */</span>
<a name="l01153"></a>01153    <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01154"></a>01154 }
<a name="l01155"></a>01155 
<a name="l01156"></a>01156 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01157"></a><a class="code" href="lazylogger_8c.html#a17c1df99fd2455deb17d8c4d7760b61e">01157</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="lazylogger_8c.html#a17c1df99fd2455deb17d8c4d7760b61e">lazy_condition_check</a>(<span class="keywordtype">void</span>)
<a name="l01158"></a>01158 <span class="comment">/********************************************************************\</span>
<a name="l01159"></a>01159 <span class="comment">Routine: lazy_condition_check</span>
<a name="l01160"></a>01160 <span class="comment">Purpose: Check if the copy should continue.</span>
<a name="l01161"></a>01161 <span class="comment">The condition can have the following setting:</span>
<a name="l01162"></a>01162 <span class="comment">ALWAYS, NEVER, WHILE_NO_ACQ_RUNNING, key&lt;=&gt;value</span>
<a name="l01163"></a>01163 <span class="comment">Input:</span>
<a name="l01164"></a>01164 <span class="comment">Output:</span>
<a name="l01165"></a>01165 <span class="comment">Function value:</span>
<a name="l01166"></a>01166 <span class="comment">BOOL :  new copy condition</span>
<a name="l01167"></a>01167 <span class="comment">\********************************************************************/</span>
<a name="l01168"></a>01168 {
<a name="l01169"></a>01169    <span class="comment">/* Get condition */</span>
<a name="l01170"></a>01170    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a0f62a56d81568e4cd455d5ad7a63db54">condition</a>, <span class="stringliteral">&quot;ALWAYS&quot;</span>))
<a name="l01171"></a>01171       <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01172"></a>01172    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a0f62a56d81568e4cd455d5ad7a63db54">condition</a>, <span class="stringliteral">&quot;NEVER&quot;</span>))
<a name="l01173"></a>01173       <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01174"></a>01174    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a0f62a56d81568e4cd455d5ad7a63db54">condition</a>, <span class="stringliteral">&quot;WHILE_ACQ_NOT_RUNNING&quot;</span>)) {
<a name="l01175"></a>01175       <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>)
<a name="l01176"></a>01176          <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01177"></a>01177       <span class="keywordflow">else</span>
<a name="l01178"></a>01178          <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01179"></a>01179    } <span class="keywordflow">else</span>
<a name="l01180"></a>01180       <span class="keywordflow">return</span> (<a class="code" href="lazylogger_8c.html#ad438c7673adf3c4cd97b8cef90d072b9">condition_test</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a0f62a56d81568e4cd455d5ad7a63db54">condition</a>));
<a name="l01181"></a>01181 }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01184"></a><a class="code" href="lazylogger_8c.html#a428a0b34622866ee9c1692ce2d362774">01184</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a428a0b34622866ee9c1692ce2d362774">lazy_copy</a>(<span class="keywordtype">char</span> *outfile, <span class="keywordtype">char</span> *infile)
<a name="l01185"></a>01185 <span class="comment">/********************************************************************\</span>
<a name="l01186"></a>01186 <span class="comment">Routine: lazy_copy</span>
<a name="l01187"></a>01187 <span class="comment">Purpose: backup file to backup device</span>
<a name="l01188"></a>01188 <span class="comment">every 2 second will update the statistics and yield</span>
<a name="l01189"></a>01189 <span class="comment">if condition requires no copy, every 5 second will yield</span>
<a name="l01190"></a>01190 <span class="comment">Input:</span>
<a name="l01191"></a>01191 <span class="comment">char * outfile   backup destination file</span>
<a name="l01192"></a>01192 <span class="comment">char * infile    source file to be backed up</span>
<a name="l01193"></a>01193 <span class="comment">Output:</span>
<a name="l01194"></a>01194 <span class="comment">Function value:</span>
<a name="l01195"></a>01195 <span class="comment">0           success</span>
<a name="l01196"></a>01196 <span class="comment">\********************************************************************/</span>
<a name="l01197"></a>01197 {
<a name="l01198"></a>01198    <span class="keywordtype">void</span> *plazy = NULL;
<a name="l01199"></a>01199    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> szlazy;
<a name="l01200"></a>01200    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, no_cpy_last_time = 0;
<a name="l01201"></a>01201    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mevb_8cpp.html#a5fecce64b1b883ada4ac0bc410fb3304">last_time</a>, cpy_loop_time;
<a name="l01202"></a>01202    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> watchdog_timeout;
<a name="l01203"></a>01203    <span class="keyword">static</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> last_error = 0;
<a name="l01204"></a>01204    <span class="keywordtype">char</span> *pext;
<a name="l01205"></a>01205    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> watchdog_flag;
<a name="l01206"></a>01206 
<a name="l01207"></a>01207    pext = malloc(strlen(infile));
<a name="l01208"></a>01208    strcpy(pext, infile);
<a name="l01209"></a>01209 
<a name="l01210"></a>01210    <span class="comment">/* find out what format it is from the extension. */</span>
<a name="l01211"></a>01211    <span class="keywordflow">if</span> (strncmp(pext + strlen(pext) - 3, <span class="stringliteral">&quot;.gz&quot;</span>, 3) == 0) {
<a name="l01212"></a>01212       <span class="comment">/* extension .gz terminator on . */</span>
<a name="l01213"></a>01213       *(pext + strlen(pext) - 3) = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01214"></a>01214    }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216    <span class="comment">/* init copy variables */</span>
<a name="l01217"></a>01217    lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7bb4f126f3eceeb30af4d19d29c4a539">cur_size</a> = 0.0f;
<a name="l01218"></a>01218    last_time = 0;
<a name="l01219"></a>01219 
<a name="l01220"></a>01220    <span class="comment">/* open any logging file (output) */</span>
<a name="l01221"></a>01221    <span class="keywordflow">if</span> ((status = <a class="code" href="group__ybosincludecode.html#ga4807aee158169da8f746c87ec1175407">yb_any_file_wopen</a>(<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a>, <a class="code" href="lazylogger_8c.html#aad8ec8a870ba39f5ec40234403f06f77">data_fmt</a>, outfile, &amp;<a class="code" href="lazylogger_8c.html#ae76a80a4eaf2de79a5f51b86df5a5857">hDev</a>)) != 1) {
<a name="l01222"></a>01222       <span class="keywordflow">if</span> ((<a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>() - last_error) &gt; 60) {
<a name="l01223"></a>01223          last_error = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>();
<a name="l01224"></a>01224          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;Lazy_copy&quot;</span>, <span class="stringliteral">&quot;cannot open %s, error %d&quot;</span>, outfile, status);
<a name="l01225"></a>01225       }
<a name="l01226"></a>01226       <span class="keywordflow">return</span> (<a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">FORCE_EXIT</a>);
<a name="l01227"></a>01227    }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229    <span class="comment">/* New lazy copy if TAPE &amp; append required force a mv to EOD */</span>
<a name="l01230"></a>01230    <span class="keywordflow">if</span> ((<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>) &amp;&amp; lazy.<a class="code" href="structLAZY__SETTING.html#afb7591433b60071b41a72fd6f991f188">tapeAppend</a>) {
<a name="l01231"></a>01231       <span class="comment">/* Position Tape to end of Data */</span>
<a name="l01232"></a>01232       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Positioning Tape to EOD&quot;</span>);
<a name="l01233"></a>01233 
<a name="l01234"></a>01234       <a class="code" href="group__msectionh.html#ga324df07c9a3003f1d1ce41e0fa51539e">cm_get_watchdog_params</a>(&amp;watchdog_flag, &amp;watchdog_timeout);
<a name="l01235"></a>01235       <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(watchdog_flag, 300000);    <span class="comment">/* 5 min for tape rewind */</span>
<a name="l01236"></a>01236       status = <a class="code" href="group__msectionh.html#ga8c25d848a532d101a8a17a3455cc954b">ss_tape_spool</a>(<a class="code" href="lazylogger_8c.html#ae76a80a4eaf2de79a5f51b86df5a5857">hDev</a>);
<a name="l01237"></a>01237       <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(watchdog_flag, watchdog_timeout);
<a name="l01238"></a>01238       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l01239"></a>01239          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Error while Positioning Tape to EOD (%d)&quot;</span>, status);
<a name="l01240"></a>01240          <a class="code" href="group__msectionh.html#ga4a9420e0e9ef8bd23b41f7594bad7395">ss_tape_close</a>(<a class="code" href="lazylogger_8c.html#ae76a80a4eaf2de79a5f51b86df5a5857">hDev</a>);
<a name="l01241"></a>01241          <span class="keywordflow">return</span> (<a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">FORCE_EXIT</a>);
<a name="l01242"></a>01242       }
<a name="l01243"></a>01243    }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245    <span class="comment">/* reset error message */</span>
<a name="l01246"></a>01246    last_error = 0;
<a name="l01247"></a>01247 
<a name="l01248"></a>01248    <span class="comment">/* open input data file */</span>
<a name="l01249"></a>01249    <span class="keywordflow">if</span> (<a class="code" href="group__ybosincludecode.html#gaa4ba04457fe9576c87b2710fea69f770">yb_any_file_ropen</a>(infile, <a class="code" href="lazylogger_8c.html#aad8ec8a870ba39f5ec40234403f06f77">data_fmt</a>) != <a class="code" href="group__yboserrorh.html#gaf3834f9669e9c611d56b2b8b71f29869">YB_SUCCESS</a>)
<a name="l01250"></a>01250       <span class="keywordflow">return</span> (<a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">FORCE_EXIT</a>);
<a name="l01251"></a>01251 
<a name="l01252"></a>01252    <span class="comment">/* run shell command if available */</span>
<a name="l01253"></a>01253    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">type</a>, <span class="stringliteral">&quot;Tape&quot;</span>)) {
<a name="l01254"></a>01254       <span class="comment">/* get the block number. If -1 it probably means that the tape</span>
<a name="l01255"></a>01255 <span class="comment">         is not ready. Wait for a while  */</span>
<a name="l01256"></a>01256       <a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a> = -1;
<a name="l01257"></a>01257       <span class="keywordflow">while</span> (<a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a> &lt; 0) {
<a name="l01258"></a>01258          <a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a> = <a class="code" href="group__msectionh.html#ga5ac2f3495bedf4a9683dcc5881ad0d03">ss_tape_get_blockn</a>(<a class="code" href="lazylogger_8c.html#ae76a80a4eaf2de79a5f51b86df5a5857">hDev</a>);
<a name="l01259"></a>01259          <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a> &gt;= 0)
<a name="l01260"></a>01260             <span class="keywordflow">break</span>;
<a name="l01261"></a>01261          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Tape is not ready&quot;</span>);
<a name="l01262"></a>01262          <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(3000);
<a name="l01263"></a>01263       }
<a name="l01264"></a>01264       <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a655e1b19cdf53876f36ccbcd22e84093">commandBefore</a>[0]) {
<a name="l01265"></a>01265          <span class="keywordtype">char</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>[256];
<a name="l01266"></a>01266          sprintf(cmd, <span class="stringliteral">&quot;%s %s %s %d %s %i&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a655e1b19cdf53876f36ccbcd22e84093">commandBefore</a>,
<a name="l01267"></a>01267                  infile, outfile, <a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a>, lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a6ad47530044b284a85aafa79bbe748fc">nfiles</a>);
<a name="l01268"></a>01268          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Exec pre file write script:%s&quot;</span>, cmd);
<a name="l01269"></a>01269          <a class="code" href="group__msystemincludecode.html#ga7a14ecba483c2767fe699633d0bc677e">ss_system</a>(cmd);
<a name="l01270"></a>01270       }
<a name="l01271"></a>01271    }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273    <span class="comment">/* force a statistics update on the first loop */</span>
<a name="l01274"></a>01274    cpy_loop_time = -2000;
<a name="l01275"></a>01275    {
<a name="l01276"></a>01276       <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];
<a name="l01277"></a>01277       sprintf(str, <span class="stringliteral">&quot;Starting lazy job on %s at block %d&quot;</span>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>, <a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a>);
<a name="l01278"></a>01278       <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#ab2f0c1e68c31ad3f94f2f056bd1fdf9e">msg_flag</a>)
<a name="l01279"></a>01279          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, str);
<a name="l01280"></a>01280       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, str);
<a name="l01281"></a>01281       <a class="code" href="group__msectionh.html#ga183ed99cb10ac91bd5391f4623401468">cm_msg1</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;lazy_log_update&quot;</span>, <span class="stringliteral">&quot;lazy&quot;</span>, str);
<a name="l01282"></a>01282    }
<a name="l01283"></a>01283 
<a name="l01284"></a>01284    <span class="comment">/* infinite loop while copying */</span>
<a name="l01285"></a>01285    <span class="keywordflow">while</span> (1) {
<a name="l01286"></a>01286       <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#abd54fd671b0bb3081a52eeae7aa4cefe">copy_continue</a>) {
<a name="l01287"></a>01287          <span class="keywordflow">if</span> (<a class="code" href="group__ybosincludecode.html#ga31f960e7ce2d1a571f8bc48cccb8658f">yb_any_physrec_get</a>(<a class="code" href="lazylogger_8c.html#aad8ec8a870ba39f5ec40234403f06f77">data_fmt</a>, &amp;plazy, &amp;szlazy) == <a class="code" href="group__yboserrorh.html#gaf3834f9669e9c611d56b2b8b71f29869">YB_SUCCESS</a>) {
<a name="l01288"></a>01288             status = <a class="code" href="group__ybosincludecode.html#gabca198523c3b536693ca97fd2bdfd4ba">yb_any_log_write</a>(<a class="code" href="lazylogger_8c.html#ae76a80a4eaf2de79a5f51b86df5a5857">hDev</a>, <a class="code" href="lazylogger_8c.html#aad8ec8a870ba39f5ec40234403f06f77">data_fmt</a>, <a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a>, plazy, szlazy);
<a name="l01289"></a>01289             <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l01290"></a>01290                <span class="comment">/* close source file */</span>
<a name="l01291"></a>01291                <a class="code" href="group__ybosincludecode.html#gaad6fca852eb2016b4a4547272512e0ae">yb_any_file_rclose</a>(<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a>);
<a name="l01292"></a>01292                <span class="comment">/* close output data file */</span>
<a name="l01293"></a>01293                <a class="code" href="group__ybosincludecode.html#ga74c5b4dfcac48b8d86eb6a2e9f5ed9c3">yb_any_file_wclose</a>(<a class="code" href="lazylogger_8c.html#ae76a80a4eaf2de79a5f51b86df5a5857">hDev</a>, <a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a>, <a class="code" href="lazylogger_8c.html#aad8ec8a870ba39f5ec40234403f06f77">data_fmt</a>);
<a name="l01294"></a>01294                <span class="comment">/* szlazy is the requested block size. Why is it copied to cm_msg?</span>
<a name="l01295"></a>01295 <span class="comment">                  cm_msg(MERROR,&quot;lazy_copy&quot;,&quot;Write error %i&quot;,szlazy); */</span>
<a name="l01296"></a>01296                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;lazy_copy&quot;</span>, <span class="stringliteral">&quot;Write error &quot;</span>);
<a name="l01297"></a>01297                <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#gafe95d7246d004e42c34c3ede15d44648">SS_NO_SPACE</a>)
<a name="l01298"></a>01298                   <span class="keywordflow">return</span> status;
<a name="l01299"></a>01299                <span class="keywordflow">return</span> (<a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">FORCE_EXIT</a>);
<a name="l01300"></a>01300             }
<a name="l01301"></a>01301             lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7bb4f126f3eceeb30af4d19d29c4a539">cur_size</a> += (float) szlazy;
<a name="l01302"></a>01302             lazyst.<a class="code" href="structLAZY__STATISTICS.html#a96f3d631abc3ff0170e87f761b1485a1">cur_dev_size</a> += (float) szlazy;
<a name="l01303"></a>01303             <span class="keywordflow">if</span> ((<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - cpy_loop_time) &gt; 2000) {
<a name="l01304"></a>01304                <span class="comment">/* update statistics */</span>
<a name="l01305"></a>01305                <a class="code" href="lazylogger_8c.html#a6e9cca13c2c01408370627dc6da67e7c">lazy_statistics_update</a>(cpy_loop_time);
<a name="l01306"></a>01306 
<a name="l01307"></a>01307                <span class="comment">/* check conditions */</span>
<a name="l01308"></a>01308                <a class="code" href="lazylogger_8c.html#abd54fd671b0bb3081a52eeae7aa4cefe">copy_continue</a> = <a class="code" href="lazylogger_8c.html#a17c1df99fd2455deb17d8c4d7760b61e">lazy_condition_check</a>();
<a name="l01309"></a>01309 
<a name="l01310"></a>01310                <span class="comment">/* update check loop */</span>
<a name="l01311"></a>01311                cpy_loop_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01312"></a>01312 
<a name="l01313"></a>01313                <span class="comment">/* yield quickly */</span>
<a name="l01314"></a>01314                status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(1);
<a name="l01315"></a>01315                <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> || status == <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>)
<a name="l01316"></a>01316                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Abort postponed until end of copy %1.0lf[%%]&quot;</span>,
<a name="l01317"></a>01317                          (<span class="keywordtype">double</span>) lazyst.<a class="code" href="structLAZY__STATISTICS.html#a3c8c8b2e1497798143f4f16e9fbbefab">progress</a>);
<a name="l01318"></a>01318             }
<a name="l01319"></a>01319          } <span class="comment">/* get physrec */</span>
<a name="l01320"></a>01320          <span class="keywordflow">else</span>
<a name="l01321"></a>01321             <span class="keywordflow">break</span>;
<a name="l01322"></a>01322       } <span class="comment">/* copy_continue */</span>
<a name="l01323"></a>01323       <span class="keywordflow">else</span> {                    <span class="comment">/* !copy_continue */</span>
<a name="l01324"></a>01324          status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(1000);
<a name="l01325"></a>01325          <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> || status == <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>)
<a name="l01326"></a>01326             <span class="keywordflow">return</span> (<a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">FORCE_EXIT</a>);
<a name="l01327"></a>01327          <span class="keywordflow">if</span> ((<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - no_cpy_last_time) &gt; 5000) {
<a name="l01328"></a>01328             <a class="code" href="lazylogger_8c.html#abd54fd671b0bb3081a52eeae7aa4cefe">copy_continue</a> = <a class="code" href="lazylogger_8c.html#a17c1df99fd2455deb17d8c4d7760b61e">lazy_condition_check</a>();
<a name="l01329"></a>01329             no_cpy_last_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01330"></a>01330          }
<a name="l01331"></a>01331       }                         <span class="comment">/* !copy_continue */</span>
<a name="l01332"></a>01332    }                            <span class="comment">/* while forever */</span>
<a name="l01333"></a>01333 
<a name="l01334"></a>01334    <span class="comment">/* update for last the statistics */</span>
<a name="l01335"></a>01335    <a class="code" href="lazylogger_8c.html#a6e9cca13c2c01408370627dc6da67e7c">lazy_statistics_update</a>(cpy_loop_time);
<a name="l01336"></a>01336 
<a name="l01337"></a>01337    <span class="comment">/* close input log device */</span>
<a name="l01338"></a>01338    <a class="code" href="group__ybosincludecode.html#gaad6fca852eb2016b4a4547272512e0ae">yb_any_file_rclose</a>(<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a>);
<a name="l01339"></a>01339 
<a name="l01340"></a>01340    <span class="comment">/* close output data file */</span>
<a name="l01341"></a>01341    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">type</a>, <span class="stringliteral">&quot;Tape&quot;</span>)) {
<a name="l01342"></a>01342       <a class="code" href="lazylogger_8c.html#a19fa64d2b40c88b268bc67808bec655d">blockn</a> = <a class="code" href="group__msectionh.html#ga5ac2f3495bedf4a9683dcc5881ad0d03">ss_tape_get_blockn</a>(<a class="code" href="lazylogger_8c.html#ae76a80a4eaf2de79a5f51b86df5a5857">hDev</a>);
<a name="l01343"></a>01343    }
<a name="l01344"></a>01344    status = <a class="code" href="group__ybosincludecode.html#ga74c5b4dfcac48b8d86eb6a2e9f5ed9c3">yb_any_file_wclose</a>(<a class="code" href="lazylogger_8c.html#ae76a80a4eaf2de79a5f51b86df5a5857">hDev</a>, <a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a>, <a class="code" href="lazylogger_8c.html#aad8ec8a870ba39f5ec40234403f06f77">data_fmt</a>);
<a name="l01345"></a>01345    <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l01346"></a>01346       <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#gafe95d7246d004e42c34c3ede15d44648">SS_NO_SPACE</a>)
<a name="l01347"></a>01347          <span class="keywordflow">return</span> status;
<a name="l01348"></a>01348       <span class="keywordflow">return</span> (<a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">FORCE_EXIT</a>);
<a name="l01349"></a>01349    }
<a name="l01350"></a>01350    <span class="comment">/* request exit */</span>
<a name="l01351"></a>01351    <span class="keywordflow">return</span> 0;
<a name="l01352"></a>01352 }
<a name="l01353"></a>01353 
<a name="l01354"></a>01354 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01355"></a><a class="code" href="lazylogger_8c.html#a84a74353d808bc45785ea45768bdfd34">01355</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="lazylogger_8c.html#a84a74353d808bc45785ea45768bdfd34">lazy_file_exists</a>(<span class="keywordtype">char</span> *dir, <span class="keywordtype">char</span> *file)
<a name="l01356"></a>01356 <span class="comment">/********************************************************************\</span>
<a name="l01357"></a>01357 <span class="comment">Routine: lazy_file_exists</span>
<a name="l01358"></a>01358 <span class="comment">Purpose: check if file exists in dir by extracting its size</span>
<a name="l01359"></a>01359 <span class="comment">Input:</span>
<a name="l01360"></a>01360 <span class="comment">char * dir       data directory</span>
<a name="l01361"></a>01361 <span class="comment">char * file      file to be checked</span>
<a name="l01362"></a>01362 <span class="comment">Output:</span>
<a name="l01363"></a>01363 <span class="comment">Function value:</span>
<a name="l01364"></a>01364 <span class="comment">TRUE           file found</span>
<a name="l01365"></a>01365 <span class="comment">FALSE          file not found</span>
<a name="l01366"></a>01366 <span class="comment">\********************************************************************/</span>
<a name="l01367"></a>01367 {
<a name="l01368"></a>01368    <span class="keywordtype">char</span> *<a class="code" href="namespacemodules.html#a12afb64f27b8a4e356d665de83e78ad3">list</a>;
<a name="l01369"></a>01369    <span class="keywordtype">char</span> fullfile[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>] = { <span class="charliteral">&apos;\0&apos;</span> };
<a name="l01370"></a>01370    <span class="keywordtype">double</span> file_size = 0;
<a name="l01371"></a>01371 
<a name="l01372"></a>01372    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> ret = <a class="code" href="group__msectionh.html#ga720c036bbaddcb54dae415a44c33e39a">ss_file_find</a>(dir, file, &amp;list);
<a name="l01373"></a>01373    <span class="comment">//printf(&quot;calling ss_file_find: dir = [%s] file = [%s] ret=[%i]\n&quot;,dir,file,ret);</span>
<a name="l01374"></a>01374    <span class="keywordflow">if</span> ( ret == 1) {
<a name="l01375"></a>01375       strcat(fullfile, dir);
<a name="l01376"></a>01376       strcat(fullfile, file);
<a name="l01377"></a>01377       file_size = <a class="code" href="group__msectionh.html#ga8a1804a9ff96e7ba88836fcc411d5384">ss_file_size</a>(fullfile);
<a name="l01378"></a>01378       <span class="comment">//printf(&quot;file [%s] size = [%f] \n&quot;,fullfile, file_size);</span>
<a name="l01379"></a>01379       <span class="keywordflow">if</span> ((lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7759604df39f4a0923e7711d12ac092b">file_size</a> = file_size) &gt; 0) {
<a name="l01380"></a>01380         free(list);
<a name="l01381"></a>01381         <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01382"></a>01382       }
<a name="l01383"></a>01383    }
<a name="l01384"></a>01384    free(list);
<a name="l01385"></a>01385    <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01386"></a>01386 }
<a name="l01387"></a>01387 
<a name="l01388"></a>01388 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01389"></a><a class="code" href="lazylogger_8c.html#a2bd150be563935695ecf7aab6b9fcea6">01389</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="lazylogger_8c.html#a2bd150be563935695ecf7aab6b9fcea6">lazy_main</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>, <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> * pLall)
<a name="l01390"></a>01390 <span class="comment">/********************************************************************\</span>
<a name="l01391"></a>01391 <span class="comment">Routine: lazy_main</span>
<a name="l01392"></a>01392 <span class="comment">Purpose: check if backup is necessary...</span>
<a name="l01393"></a>01393 <span class="comment">Input:</span>
<a name="l01394"></a>01394 <span class="comment">channel: Current channel number</span>
<a name="l01395"></a>01395 <span class="comment">*pLall :   Pointer to all channels</span>
<a name="l01396"></a>01396 <span class="comment">Output:</span>
<a name="l01397"></a>01397 <span class="comment">Function value:</span>
<a name="l01398"></a>01398 <span class="comment">\********************************************************************/</span>
<a name="l01399"></a>01399 {
<a name="l01400"></a>01400    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> cp_time;
<a name="l01401"></a>01401    <a class="code" href="structDIRLOG.html">DIRLOG</a> *pdirlog = NULL;
<a name="l01402"></a>01402    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *pdonelist = NULL;
<a name="l01403"></a>01403    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, cur_acq_run, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, tobe_backup, purun;
<a name="l01404"></a>01404    <span class="keywordtype">double</span> freepercent, svfree;
<a name="l01405"></a>01405    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>], pufile[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>], inffile[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>],
<a name="l01406"></a>01406        outffile[<a class="code" href="group__ybosincludecode.html#ga263efd24d550124313df51247f07457a">MAX_FILE_PATH</a>];
<a name="l01407"></a>01407    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> donepurge, watchdog_flag;
<a name="l01408"></a>01408    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> watchdog_timeout;
<a name="l01409"></a>01409    <a class="code" href="structLAZY__INFO.html">LAZY_INFO</a> *pLch;
<a name="l01410"></a>01410    <span class="keyword">static</span> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> eot_reached = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01411"></a>01411 
<a name="l01412"></a>01412    <span class="comment">/* current channel */</span>
<a name="l01413"></a>01413    pLch = &amp;pLall[channel];
<a name="l01414"></a>01414 
<a name="l01415"></a>01415    <span class="comment">/* extract Data format from the struct */</span>
<a name="l01416"></a>01416    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a3964f0947a90e90ac81d1cd7172201b4">format</a>, <span class="stringliteral">&quot;YBOS&quot;</span>))
<a name="l01417"></a>01417       <a class="code" href="lazylogger_8c.html#aad8ec8a870ba39f5ec40234403f06f77">data_fmt</a> = <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>;
<a name="l01418"></a>01418    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a3964f0947a90e90ac81d1cd7172201b4">format</a>, <span class="stringliteral">&quot;MIDAS&quot;</span>))
<a name="l01419"></a>01419       <a class="code" href="lazylogger_8c.html#aad8ec8a870ba39f5ec40234403f06f77">data_fmt</a> = <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>;
<a name="l01420"></a>01420    <span class="keywordflow">else</span> {
<a name="l01421"></a>01421       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Unknown data format %s (MIDAS, YBOS)&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a3964f0947a90e90ac81d1cd7172201b4">format</a>);
<a name="l01422"></a>01422       <span class="keywordflow">return</span> <a class="code" href="group__err23.html#ga467b0af34b1011481919088b6af86b95">DB_NO_ACCESS</a>;
<a name="l01423"></a>01423    }
<a name="l01424"></a>01424 
<a name="l01425"></a>01425    <span class="comment">/* extract Device type from the struct */</span>
<a name="l01426"></a>01426    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">type</a>, <span class="stringliteral">&quot;DISK&quot;</span>))
<a name="l01427"></a>01427       <a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> = <a class="code" href="group__msystemincludecode.html#ga20f4ff7cce85df2eb7ead9718d5961ba">LOG_TYPE_DISK</a>;
<a name="l01428"></a>01428    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">type</a>, <span class="stringliteral">&quot;TAPE&quot;</span>))
<a name="l01429"></a>01429       <a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> = <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>;
<a name="l01430"></a>01430    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(lazy.<a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">type</a>, <span class="stringliteral">&quot;FTP&quot;</span>))
<a name="l01431"></a>01431       <a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> = <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>;
<a name="l01432"></a>01432    <span class="keywordflow">else</span> {
<a name="l01433"></a>01433       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Unknown device type %s (Disk, Tape, FTP)&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#af62fd8c345f193ee75d52c47274382fa">type</a>);
<a name="l01434"></a>01434       <span class="keywordflow">return</span> <a class="code" href="group__err23.html#ga467b0af34b1011481919088b6af86b95">DB_NO_ACCESS</a>;
<a name="l01435"></a>01435    }
<a name="l01436"></a>01436 
<a name="l01437"></a>01437    <span class="comment">/* make sure that we don&apos;t operate on the current DAQ file if so set to oldest */</span>
<a name="l01438"></a>01438    <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a15df4ce395a553a2859e4b96148f741a">staybehind</a> == 0) {
<a name="l01439"></a>01439       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Stay behind cannot be 0&quot;</span>);
<a name="l01440"></a>01440       <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01441"></a>01441    }
<a name="l01442"></a>01442 
<a name="l01443"></a>01443    <span class="comment">/* Check if Tape is OK */</span>
<a name="l01444"></a>01444    <span class="comment">/* ... */</span>
<a name="l01445"></a>01445 
<a name="l01446"></a>01446    <span class="comment">/* check if space on device (not empty tape label) */</span>
<a name="l01447"></a>01447    <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>[0] == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01448"></a>01448       <a class="code" href="lazylogger_8c.html#a5da880f19a743e3ae097deaafd1913d4">full_bck_flag</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01449"></a>01449       <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01450"></a>01450    } <span class="keywordflow">else</span> {
<a name="l01451"></a>01451       <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#a5da880f19a743e3ae097deaafd1913d4">full_bck_flag</a>) {
<a name="l01452"></a>01452          <a class="code" href="lazylogger_8c.html#a5da880f19a743e3ae097deaafd1913d4">full_bck_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01453"></a>01453          size = <span class="keyword">sizeof</span>(lazyst);
<a name="l01454"></a>01454          memset(&amp;lazyst, 0, size);
<a name="l01455"></a>01455          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, pLch-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, <span class="stringliteral">&quot;Statistics&quot;</span>, &amp;<a class="code" href="lazylogger_8c.html#affc2c1ae6ae328e611c4825cc47c05f6">hKeyst</a>) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01456"></a>01456             status = <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="lazylogger_8c.html#affc2c1ae6ae328e611c4825cc47c05f6">hKeyst</a>, &amp;lazyst, size, 0);
<a name="l01457"></a>01457             <span class="comment">/* New session of lazy, apply append in case of Tape */</span>
<a name="l01458"></a>01458             <span class="comment">/* DISK for debugging */</span>
<a name="l01459"></a>01459             <span class="keywordflow">if</span> ((<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> == <a class="code" href="group__msystemincludecode.html#ga20f4ff7cce85df2eb7ead9718d5961ba">LOG_TYPE_DISK</a>) &amp;&amp; lazy.<a class="code" href="structLAZY__SETTING.html#afb7591433b60071b41a72fd6f991f188">tapeAppend</a>) {
<a name="l01460"></a>01460                <span class="comment">/* Position Tape to end of Data */</span>
<a name="l01461"></a>01461                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Positioning Tape to EOD&quot;</span>);
<a name="l01462"></a>01462             }
<a name="l01463"></a>01463          } <span class="keywordflow">else</span>
<a name="l01464"></a>01464             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;lazy_main&quot;</span>,
<a name="l01465"></a>01465                    <span class="stringliteral">&quot;did not find /Lazy/Lazy_%s/Statistics for zapping&quot;</span>, pLch-&gt;<a class="code" href="structLAZY__INFO.html#a01014a800074f3317847557c39bcb2df">name</a>);
<a name="l01466"></a>01466          <span class="comment">// INT al_reset_alarm(char *alarm_name)</span>
<a name="l01467"></a>01467          <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>)
<a name="l01468"></a>01468             <a class="code" href="group__msectionh.html#ga906bbe1c84d87510755d6bf71e933edc">al_reset_alarm</a>(<span class="stringliteral">&quot;Tape&quot;</span>);
<a name="l01469"></a>01469       }
<a name="l01470"></a>01470    }
<a name="l01471"></a>01471    <span class="comment">/* check if data dir is none empty */</span>
<a name="l01472"></a>01472    <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>[0] == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01473"></a>01473       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Please setup Data dir for input source path!&quot;</span>);
<a name="l01474"></a>01474       <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01475"></a>01475    }
<a name="l01476"></a>01476 
<a name="l01477"></a>01477    <span class="comment">/* check if device path is set */</span>
<a name="l01478"></a>01478    <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>[0] == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01479"></a>01479       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Please setup backup device path too!&quot;</span>);
<a name="l01480"></a>01480       <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01481"></a>01481    }
<a name="l01482"></a>01482 
<a name="l01483"></a>01483    <span class="comment">/* build logger dir listing */</span>
<a name="l01484"></a>01484    <span class="keywordflow">if</span> (pdirlog == NULL)
<a name="l01485"></a>01485       pdirlog = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structDIRLOG.html">DIRLOG</a>));
<a name="l01486"></a>01486    <a class="code" href="lazylogger_8c.html#a7c506cdc6c2ca31d03184f8b674198cf">build_log_list</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a681ec7fec002c3aa7686867f14394c48">backfmt</a>, lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, &amp;pdirlog);
<a name="l01487"></a>01487 
<a name="l01488"></a>01488    <span class="comment">/* build donelist comparing pdirlog and /Lazy/List */</span>
<a name="l01489"></a>01489    <span class="keywordflow">if</span> (pdonelist == NULL)
<a name="l01490"></a>01490       pdonelist = malloc(<span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l01491"></a>01491    <a class="code" href="lazylogger_8c.html#aa7ddec3eef679124780e21119710ac6a">build_done_list</a>(pLch-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, &amp;pdonelist);
<a name="l01492"></a>01492 
<a name="l01493"></a>01493    <span class="comment">/* compare list : run NOT in donelist AND run in dirlog */</span>
<a name="l01494"></a>01494    tobe_backup = <a class="code" href="lazylogger_8c.html#a6db080ca2b79410341401d24c1687848">cmp_log2donelist</a>(pdirlog, pdonelist);
<a name="l01495"></a>01495    <span class="comment">/* cleanup memory */</span>
<a name="l01496"></a>01496    <span class="keywordflow">if</span> (pdirlog)
<a name="l01497"></a>01497       free(pdirlog);
<a name="l01498"></a>01498    pdirlog = NULL;
<a name="l01499"></a>01499    <span class="keywordflow">if</span> (pdonelist)
<a name="l01500"></a>01500       free(pdonelist);
<a name="l01501"></a>01501    pdonelist = NULL;
<a name="l01502"></a>01502 
<a name="l01503"></a>01503    <span class="keywordflow">if</span> (tobe_backup &lt; 0)
<a name="l01504"></a>01504       <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01505"></a>01505 
<a name="l01506"></a>01506    <span class="comment">/* ckeck if mode is on oldest (staybehind = -x)</span>
<a name="l01507"></a>01507 <span class="comment">      else take current run - keep file */</span>
<a name="l01508"></a>01508    <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a15df4ce395a553a2859e4b96148f741a">staybehind</a> &lt; 0)
<a name="l01509"></a>01509       lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a> = tobe_backup;
<a name="l01510"></a>01510    <span class="keywordflow">else</span>
<a name="l01511"></a>01511       lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a> -= lazy.<a class="code" href="structLAZY__SETTING.html#a15df4ce395a553a2859e4b96148f741a">staybehind</a>;
<a name="l01512"></a>01512 
<a name="l01513"></a>01513    <span class="comment">/* Get current run number */</span>
<a name="l01514"></a>01514    size = <span class="keyword">sizeof</span>(cur_acq_run);
<a name="l01515"></a>01515    status =
<a name="l01516"></a>01516        <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;Runinfo/Run number&quot;</span>, &amp;cur_acq_run, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01517"></a>01517    assert(status == <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>);
<a name="l01518"></a>01518 
<a name="l01519"></a>01519    <span class="comment">/* update &quot;maintain free space&quot; */</span>
<a name="l01520"></a>01520    <a class="code" href="lazylogger_8c.html#a34002378b03a28414a0e4cd300372d55">lazy_maintain_check</a>(pLch-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, pLall);
<a name="l01521"></a>01521 
<a name="l01522"></a>01522   <span class="comment">/***** Lock other clients out of this following code as</span>
<a name="l01523"></a>01523 <span class="comment">  it may access the other client info tree   *****/</span>
<a name="l01524"></a>01524    status = <a class="code" href="group__msystemincludecode.html#gad3c6b30fd77b7be3d4d3d6db5f106b45">ss_mutex_wait_for</a>(<a class="code" href="lazylogger_8c.html#ad82767a8569bed318543d968cb2827e4">lazy_mutex</a>, 5000);
<a name="l01525"></a>01525    <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l01526"></a>01526       <span class="comment">/* exit for now and come back later */</span>
<a name="l01527"></a>01527       <span class="keywordflow">if</span> (pdirlog != NULL)
<a name="l01528"></a>01528          free(pdirlog);
<a name="l01529"></a>01529       pdirlog = NULL;
<a name="l01530"></a>01530       <span class="keywordflow">if</span> (pdonelist != NULL)
<a name="l01531"></a>01531          free(pdonelist);
<a name="l01532"></a>01532       pdonelist = NULL;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534       <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01535"></a>01535    }
<a name="l01536"></a>01536 
<a name="l01537"></a>01537    <span class="comment">/* check SPACE and purge if necessary = % (1:99) */</span>
<a name="l01538"></a>01538    <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#acf3ba60fcf6662dbb0ef7a0707c6d422">pupercent</a> &gt; 0) {
<a name="l01539"></a>01539       <span class="keywordflow">if</span> (pdirlog == NULL)
<a name="l01540"></a>01540          pdirlog = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structDIRLOG.html">DIRLOG</a>));
<a name="l01541"></a>01541       <span class="comment">/* cleanup memory */</span>
<a name="l01542"></a>01542       donepurge = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01543"></a>01543       svfree = freepercent = 100. * <a class="code" href="group__msectionh.html#ga20c42d723b154e7b7915151178b2cef7">ss_disk_free</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>) / <a class="code" href="group__msectionh.html#gaae258ebfb801fba1e788c81b453e3244">ss_disk_size</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545 
<a name="l01546"></a>01546       <span class="comment">/* check purging action */</span>
<a name="l01547"></a>01547       <span class="keywordflow">while</span> (freepercent &lt;= (<span class="keywordtype">double</span>) lazy.<a class="code" href="structLAZY__SETTING.html#acf3ba60fcf6662dbb0ef7a0707c6d422">pupercent</a>) {
<a name="l01548"></a>01548          <span class="comment">/* search file to purge : run in donelist AND run in dirlog */</span>
<a name="l01549"></a>01549          <span class="comment">/* synchronize donelist to dir log in case user has purged</span>
<a name="l01550"></a>01550 <span class="comment">            some file by hand. Basically remove the run in the list if the</span>
<a name="l01551"></a>01551 <span class="comment">            file is not anymore in the source dir. */</span>
<a name="l01552"></a>01552          <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#a4776a2fa363c13eef86dc0a59e1186d0">lazy_select_purge</a>
<a name="l01553"></a>01553              (pLch-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, channel, pLall, lazy.<a class="code" href="structLAZY__SETTING.html#a681ec7fec002c3aa7686867f14394c48">backfmt</a>, lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, pufile, &amp;purun) == 0) {
<a name="l01554"></a>01554             <span class="comment">/* check if beyond keep file + 1 */</span>
<a name="l01555"></a>01555             <span class="keywordflow">if</span> (purun &lt; (cur_acq_run - <a class="code" href="generic_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a15df4ce395a553a2859e4b96148f741a">staybehind</a>) - 1)) {
<a name="l01556"></a>01556                <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> rm_time;
<a name="l01557"></a>01557                <span class="comment">/* remove file */</span>
<a name="l01558"></a>01558                rm_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01559"></a>01559                status = <a class="code" href="lazylogger_8c.html#a7725a98f93531e9d3594fe8455d2009e">lazy_file_remove</a>(pufile);
<a name="l01560"></a>01560                rm_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - rm_time;
<a name="l01561"></a>01561                <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>)
<a name="l01562"></a>01562                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;lazy_file_remove failed on file %s&quot;</span>, pufile);
<a name="l01563"></a>01563                <span class="keywordflow">else</span> {
<a name="l01564"></a>01564                   status = <a class="code" href="lazylogger_8c.html#a141d3e82085549ca775e167e8334de52">lazy_log_update</a>(<a class="code" href="lazylogger_8c.html#a26897d4a481db39514d1fa84d0fc659e">REMOVE_FILE</a>, purun, NULL, pufile, rm_time);
<a name="l01565"></a>01565                   donepurge = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01566"></a>01566 
<a name="l01567"></a>01567                   <span class="comment">/* update donelist (remove run entry as the file has been deleted */</span>
<a name="l01568"></a>01568                   <span class="keywordflow">if</span> ((status = <a class="code" href="lazylogger_8c.html#ab3161802cbf757fc6aa250446ddd61d6">lazy_remove_entry</a>(channel, pLall, purun)) != 0)
<a name="l01569"></a>01569                      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;remove_entry not performed %d&quot;</span>, status);
<a name="l01570"></a>01570                }
<a name="l01571"></a>01571             }
<a name="l01572"></a>01572             freepercent = 100. * <a class="code" href="group__msectionh.html#ga20c42d723b154e7b7915151178b2cef7">ss_disk_free</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>) / <a class="code" href="group__msectionh.html#gaae258ebfb801fba1e788c81b453e3244">ss_disk_size</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>);
<a name="l01573"></a>01573             <span class="keywordflow">if</span> ((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) svfree == (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) freepercent)
<a name="l01574"></a>01574                <span class="keywordflow">break</span>;
<a name="l01575"></a>01575          } <span class="keywordflow">else</span> {
<a name="l01576"></a>01576             <span class="keywordflow">if</span> (donepurge)
<a name="l01577"></a>01577                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Can&apos;t purge more for now!&quot;</span>);
<a name="l01578"></a>01578             <span class="keywordflow">break</span>;
<a name="l01579"></a>01579          }
<a name="l01580"></a>01580       }
<a name="l01581"></a>01581    }
<a name="l01582"></a>01582 
<a name="l01583"></a>01583    <span class="comment">/* end of if pupercent &gt; 0 */</span>
<a name="l01584"></a>01584    <span class="comment">/* cleanup memory */</span>
<a name="l01585"></a>01585    <span class="keywordflow">if</span> (pdirlog != NULL)
<a name="l01586"></a>01586       free(pdirlog);
<a name="l01587"></a>01587    pdirlog = NULL;
<a name="l01588"></a>01588    <span class="keywordflow">if</span> (pdonelist != NULL)
<a name="l01589"></a>01589       free(pdonelist);
<a name="l01590"></a>01590    pdonelist = NULL;
<a name="l01591"></a>01591 
<a name="l01592"></a>01592   <span class="comment">/***** Release the mutex  *****/</span>
<a name="l01593"></a>01593    status = <a class="code" href="group__msystemincludecode.html#gae9746bf50ec478e587bb9d981f8eb9da">ss_mutex_release</a>(<a class="code" href="lazylogger_8c.html#ad82767a8569bed318543d968cb2827e4">lazy_mutex</a>);
<a name="l01594"></a>01594 
<a name="l01595"></a>01595    <span class="comment">/* check if backup run is beyond keep */</span>
<a name="l01596"></a>01596    <span class="keywordflow">if</span> (lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a> &gt;= (cur_acq_run - <a class="code" href="generic_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a15df4ce395a553a2859e4b96148f741a">staybehind</a>)))
<a name="l01597"></a>01597       <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01598"></a>01598 
<a name="l01599"></a>01599    <span class="comment">/* Compose the proper file name */</span>
<a name="l01600"></a>01600    status =
<a name="l01601"></a>01601        <a class="code" href="lazylogger_8c.html#a1fa437aa64a922839bd4124310107fe1">lazy_file_compose</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a681ec7fec002c3aa7686867f14394c48">backfmt</a>, lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a>, inffile,
<a name="l01602"></a>01602                          lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>);
<a name="l01603"></a>01603    <span class="keywordflow">if</span> (status != 0) {
<a name="l01604"></a>01604       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;composition of file failed -%s-%s-%d-&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a681ec7fec002c3aa7686867f14394c48">backfmt</a>,
<a name="l01605"></a>01605              lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a>);
<a name="l01606"></a>01606       <span class="keywordflow">return</span> status;
<a name="l01607"></a>01607    }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609    <span class="comment">/* Check again if the backup file is present in the logger dir */</span>
<a name="l01610"></a>01610    <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#a84a74353d808bc45785ea45768bdfd34">lazy_file_exists</a>(lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>)) {
<a name="l01611"></a>01611       <span class="comment">/* compose the destination file name */</span>
<a name="l01612"></a>01612       <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> == <a class="code" href="group__msystemincludecode.html#ga20f4ff7cce85df2eb7ead9718d5961ba">LOG_TYPE_DISK</a>) {
<a name="l01613"></a>01613          <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>[0] != 0)
<a name="l01614"></a>01614             <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>[strlen(lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l01615"></a>01615                strcat(lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l01616"></a>01616          strcpy(outffile, lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>);
<a name="l01617"></a>01617          strcat(outffile, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>);
<a name="l01618"></a>01618       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>)
<a name="l01619"></a>01619          strcpy(outffile, lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>);
<a name="l01620"></a>01620       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>) {
<a name="l01621"></a>01621          <span class="comment">/* Format for FTP</span>
<a name="l01622"></a>01622 <span class="comment">            lazy.path=host,port,user,password,directory,filename[,umask]</span>
<a name="l01623"></a>01623 <span class="comment">            expect filename in format such as &quot;bck%08d.mid&quot; */</span>
<a name="l01624"></a>01624 
<a name="l01625"></a>01625          <span class="comment">/*</span>
<a name="l01626"></a>01626 <span class="comment">            if (lazy.path[0] != 0)</span>
<a name="l01627"></a>01627 <span class="comment">            if (lazy.path[strlen(lazy.path)-1] != DIR_SEPARATOR)</span>
<a name="l01628"></a>01628 <span class="comment">            strcat(lazy.path, DIR_SEPARATOR_STR);</span>
<a name="l01629"></a>01629 <span class="comment">          */</span>
<a name="l01630"></a>01630 
<a name="l01631"></a>01631          strcpy(str, lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>);
<a name="l01632"></a>01632          <span class="comment">/* substitue &quot;%d&quot; for current run number */</span>
<a name="l01633"></a>01633          <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>))
<a name="l01634"></a>01634             sprintf(outffile, str, lazyst.<a class="code" href="structLAZY__STATISTICS.html#aec9267f43d221c80166afba6a22e2308">cur_run</a>);
<a name="l01635"></a>01635          <span class="keywordflow">else</span>
<a name="l01636"></a>01636             strcpy(outffile, str);
<a name="l01637"></a>01637 
<a name="l01638"></a>01638          <span class="comment">//if (lazy.path[0] != 0)</span>
<a name="l01639"></a>01639          <span class="comment">//  if (lazy.path[strlen(lazy.path)-1] != &apos;/&apos;)</span>
<a name="l01640"></a>01640          <span class="comment">//    strcat(lazy.path, &quot;/&quot;);</span>
<a name="l01641"></a>01641          <span class="comment">//  strcpy(outffile, lazy.path);</span>
<a name="l01642"></a>01642          <span class="comment">//  strcat(outffile, &quot;,&quot;);</span>
<a name="l01643"></a>01643          <span class="comment">//  strcat(outffile, lazyst.backfile);</span>
<a name="l01644"></a>01644       }
<a name="l01645"></a>01645 
<a name="l01646"></a>01646       <span class="comment">/* check if space on backup device */</span>
<a name="l01647"></a>01647       <span class="keywordflow">if</span> ((lazy.<a class="code" href="structLAZY__SETTING.html#a2d138f987eb40a796eb348569c6b3785">capacity</a> &lt; (lazyst.<a class="code" href="structLAZY__STATISTICS.html#a96f3d631abc3ff0170e87f761b1485a1">cur_dev_size</a> + lazyst.<a class="code" href="structLAZY__STATISTICS.html#a7759604df39f4a0923e7711d12ac092b">file_size</a>)) || eot_reached) {
<a name="l01648"></a>01648          <span class="keywordtype">char</span> pre_label[32];
<a name="l01649"></a>01649          <span class="comment">/* save the last label for shell script */</span>
<a name="l01650"></a>01650          strcpy(pre_label, lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>);
<a name="l01651"></a>01651 
<a name="l01652"></a>01652          <span class="comment">/* Reset EOT reached */</span>
<a name="l01653"></a>01653          eot_reached = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01654"></a>01654 
<a name="l01655"></a>01655          <span class="comment">/* not enough space =&gt; reset list label */</span>
<a name="l01656"></a>01656          lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01657"></a>01657          size = <span class="keyword">sizeof</span>(lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>);
<a name="l01658"></a>01658          <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, pLch-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, <span class="stringliteral">&quot;Settings/List label&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#ae2ce4753a9d59b9c7de3897fd21c2739">backlabel</a>, size, 1,
<a name="l01659"></a>01659                       <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>);
<a name="l01660"></a>01660          <a class="code" href="lazylogger_8c.html#a5da880f19a743e3ae097deaafd1913d4">full_bck_flag</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01661"></a>01661          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Not enough space for next copy on backup device!&quot;</span>);
<a name="l01662"></a>01662 
<a name="l01663"></a>01663          <span class="comment">/* rewind device if TAPE type */</span>
<a name="l01664"></a>01664          <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#afdab04938f90f5af428a9e7e1c14ec46">dev_type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>) {
<a name="l01665"></a>01665             <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status, channel;
<a name="l01666"></a>01666             <span class="keywordtype">char</span> str[128];
<a name="l01667"></a>01667 
<a name="l01668"></a>01668             sprintf(str, <span class="stringliteral">&quot;Tape %s is full with %d files&quot;</span>, pre_label, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a6ad47530044b284a85aafa79bbe748fc">nfiles</a>);
<a name="l01669"></a>01669             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, str);
<a name="l01670"></a>01670 
<a name="l01671"></a>01671             <span class="comment">/* Setup alarm */</span>
<a name="l01672"></a>01672             lazy.<a class="code" href="structLAZY__SETTING.html#a3a9db40f4c34db2f35ae5806b99ed7bb">alarm</a>[0] = 0;
<a name="l01673"></a>01673             size = <span class="keyword">sizeof</span>(lazy.<a class="code" href="structLAZY__SETTING.html#a3a9db40f4c34db2f35ae5806b99ed7bb">alarm</a>);
<a name="l01674"></a>01674             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, pLch-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, <span class="stringliteral">&quot;Settings/Alarm Class&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a3a9db40f4c34db2f35ae5806b99ed7bb">alarm</a>, &amp;size,
<a name="l01675"></a>01675                          <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01676"></a>01676 
<a name="l01677"></a>01677             <span class="comment">/* trigger alarm if defined */</span>
<a name="l01678"></a>01678             <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a3a9db40f4c34db2f35ae5806b99ed7bb">alarm</a>[0])
<a name="l01679"></a>01679                <a class="code" href="group__msectionh.html#ga084fb58f29f3fab1170966190462b29c">al_trigger_alarm</a>(<span class="stringliteral">&quot;Tape&quot;</span>,
<a name="l01680"></a>01680                                 <span class="stringliteral">&quot;Tape full, Please remove current tape and load new one!&quot;</span>,
<a name="l01681"></a>01681                                 lazy.<a class="code" href="structLAZY__SETTING.html#a3a9db40f4c34db2f35ae5806b99ed7bb">alarm</a>, <span class="stringliteral">&quot;Tape full&quot;</span>, <a class="code" href="group__malarmh.html#ga0aecd2654d62ebd6b3d8d57ef8ccf2d9">AT_INTERNAL</a>);
<a name="l01682"></a>01682 
<a name="l01683"></a>01683             <span class="comment">/* run shell command if available */</span>
<a name="l01684"></a>01684             <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a234ecd2a8a13fd563d450b15398f6c50">command</a>[0]) {
<a name="l01685"></a>01685                <span class="keywordtype">char</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>[256];
<a name="l01686"></a>01686                sprintf(cmd, <span class="stringliteral">&quot;%s %s %s %s&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a234ecd2a8a13fd563d450b15398f6c50">command</a>, lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>, pLch-&gt;<a class="code" href="structLAZY__INFO.html#a01014a800074f3317847557c39bcb2df">name</a>,
<a name="l01687"></a>01687                        pre_label);
<a name="l01688"></a>01688                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Exec post-rewind script:%s&quot;</span>, cmd);
<a name="l01689"></a>01689                <a class="code" href="group__msystemincludecode.html#ga7a14ecba483c2767fe699633d0bc677e">ss_system</a>(cmd);
<a name="l01690"></a>01690             }
<a name="l01691"></a>01691 
<a name="l01692"></a>01692             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;backup device rewinding...&quot;</span>);
<a name="l01693"></a>01693             <a class="code" href="group__msectionh.html#ga324df07c9a3003f1d1ce41e0fa51539e">cm_get_watchdog_params</a>(&amp;watchdog_flag, &amp;watchdog_timeout);
<a name="l01694"></a>01694             <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(watchdog_flag, 300000);      <span class="comment">/* 5 min for tape rewind */</span>
<a name="l01695"></a>01695             status = <a class="code" href="group__msectionh.html#gad5ba805f539d5dd8d3248cf52ec6b510">ss_tape_open</a>(outffile, O_RDONLY, &amp;channel);
<a name="l01696"></a>01696             <span class="keywordflow">if</span> (channel &lt; 0) {
<a name="l01697"></a>01697                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Cannot rewind tape %s - %d - %d&quot;</span>, outffile,
<a name="l01698"></a>01698                       channel, status);
<a name="l01699"></a>01699                <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01700"></a>01700             }
<a name="l01701"></a>01701             <span class="comment">//else</span>
<a name="l01702"></a>01702             <span class="comment">//    cm_msg(MINFO,&quot;Lazy&quot;, &quot;After call ss_tape_open used to rewind tape %s - %d - %d&quot;, outffile, channel, status);</span>
<a name="l01703"></a>01703             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Calling ss_tape_unmount&quot;</span>);
<a name="l01704"></a>01704             <a class="code" href="group__msectionh.html#gab152ff20030ae5bd6d553709e10a1b1c">ss_tape_unmount</a>(channel);
<a name="l01705"></a>01705             <a class="code" href="group__msectionh.html#ga4a9420e0e9ef8bd23b41f7594bad7395">ss_tape_close</a>(channel);
<a name="l01706"></a>01706             <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(watchdog_flag, watchdog_timeout);
<a name="l01707"></a>01707             <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01708"></a>01708          }
<a name="l01709"></a>01709       }
<a name="l01710"></a>01710 
<a name="l01711"></a>01711       <span class="comment">/* Finally do the copy */</span>
<a name="l01712"></a>01712       cp_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01713"></a>01713       <span class="keywordflow">if</span> ((status = <a class="code" href="lazylogger_8c.html#a428a0b34622866ee9c1692ce2d362774">lazy_copy</a>(outffile, inffile)) != 0) {
<a name="l01714"></a>01714          <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#gafe95d7246d004e42c34c3ede15d44648">SS_NO_SPACE</a>) {
<a name="l01715"></a>01715             <span class="comment">/* Consider this case as EOT reached */</span>
<a name="l01716"></a>01716             eot_reached = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01717"></a>01717             <span class="keywordflow">return</span> status;
<a name="l01718"></a>01718          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">FORCE_EXIT</a>)
<a name="l01719"></a>01719             <span class="keywordflow">return</span> status;
<a name="l01720"></a>01720          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;copy failed -%s-%s-%i&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a57a26eab511e547f2f2926fe55cac8a3">path</a>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>,
<a name="l01721"></a>01721                 status);
<a name="l01722"></a>01722          <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">FORCE_EXIT</a>;
<a name="l01723"></a>01723       }
<a name="l01724"></a>01724    } <span class="comment">/* file exists */</span>
<a name="l01725"></a>01725    <span class="keywordflow">else</span> {
<a name="l01726"></a>01726       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;lazy_file_exists file %s doesn&apos;t exists&quot;</span>, lazyst.<a class="code" href="structLAZY__STATISTICS.html#a5b3e0bcc527f5b4b0750821fb62744b8">backfile</a>);
<a name="l01727"></a>01727       <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01728"></a>01728    }
<a name="l01729"></a>01729 
<a name="l01730"></a>01730    <span class="comment">/* Update the list */</span>
<a name="l01731"></a>01731    cp_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - cp_time;
<a name="l01732"></a>01732    <span class="keywordflow">if</span> ((status = <a class="code" href="lazylogger_8c.html#a0d08e8d13b285a8754d67871c5a874f3">lazy_update_list</a>(pLch, cp_time)) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01733"></a>01733       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;lazy_update failed&quot;</span>);
<a name="l01734"></a>01734       <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01735"></a>01735    }
<a name="l01736"></a>01736 
<a name="l01737"></a>01737    <span class="comment">/* generate/update a &lt;channel&gt;_recover.odb file when everything is Ok</span>
<a name="l01738"></a>01738 <span class="comment">      after each file copy */</span>
<a name="l01739"></a>01739    {
<a name="l01740"></a>01740       <span class="keywordtype">char</span> str[128];
<a name="l01741"></a>01741       <span class="comment">/* leave &quot;list label&quot; as it is, as long as the _recover.odb is loaded before</span>
<a name="l01742"></a>01742 <span class="comment">         the lazylogger is started with NO -z things should be fine */</span>
<a name="l01743"></a>01743       <span class="comment">/* save the recover with &quot;List Label&quot; empty */</span>
<a name="l01744"></a>01744       <span class="keywordflow">if</span> (lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>[strlen(lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l01745"></a>01745          sprintf(str, <span class="stringliteral">&quot;%s%c%s_recover.odb&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>, pLch-&gt;<a class="code" href="structLAZY__INFO.html#a01014a800074f3317847557c39bcb2df">name</a>);
<a name="l01746"></a>01746       <span class="keywordflow">else</span>
<a name="l01747"></a>01747          sprintf(str, <span class="stringliteral">&quot;%s%s_recover.odb&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, pLch-&gt;<a class="code" href="structLAZY__INFO.html#a01014a800074f3317847557c39bcb2df">name</a>);
<a name="l01748"></a>01748 
<a name="l01749"></a>01749       <a class="code" href="group__msectionh.html#gae875429ee4761ff043d26882cd48d251">db_save</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, pLch-&gt;<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>, str, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01750"></a>01750    }
<a name="l01751"></a>01751 
<a name="l01752"></a>01752    <span class="keywordflow">return</span> <a class="code" href="lazylogger_8c.html#aa608f079e50199b1a547aad8fbaab752">NOTHING_TODO</a>;
<a name="l01753"></a>01753 }
<a name="l01754"></a>01754 
<a name="l01755"></a>01755 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01756"></a><a class="code" href="lazylogger_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">01756</a> <span class="keywordtype">int</span> <a class="code" href="mucap__compress_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
<a name="l01757"></a>01757 {
<a name="l01758"></a>01758    <span class="keywordtype">char</span> channel_name[32];
<a name="l01759"></a>01759    <span class="keywordtype">char</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[<a class="code" href="group__midasincludecode.html#ga2010c9ed4ef21c3171de778157b9c494">HOST_NAME_LENGTH</a>];
<a name="l01760"></a>01760    <span class="keywordtype">char</span> <a class="code" href="mevb_8cpp.html#a72ed5035970a7c95a9a3e9faeb64cc1c">expt_name</a>[<a class="code" href="group__midasincludecode.html#ga2010c9ed4ef21c3171de778157b9c494">HOST_NAME_LENGTH</a>];
<a name="l01761"></a>01761    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a>, <a class="code" href="mana_8cpp.html#a96203468e98720f55cbede5bb1f8cffe">daemon</a>;
<a name="l01762"></a>01762    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, msg, ch, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, mainlast_time;
<a name="l01763"></a>01763 
<a name="l01764"></a>01764    <span class="comment">/* set default */</span>
<a name="l01765"></a>01765    host_name[0] = 0;
<a name="l01766"></a>01766    expt_name[0] = 0;
<a name="l01767"></a>01767    channel_name[0] = 0;
<a name="l01768"></a>01768    <a class="code" href="lazylogger_8c.html#a0ef9ee54f7de740c695f9258b8f3dd5c">zap_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01769"></a>01769    <a class="code" href="lazylogger_8c.html#ab2f0c1e68c31ad3f94f2f056bd1fdf9e">msg_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01770"></a>01770    debug = daemon = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01771"></a>01771 
<a name="l01772"></a>01772    <span class="comment">/* set default */</span>
<a name="l01773"></a>01773    <a class="code" href="patch__mevb_8cpp.html#aa598123f60ccd5496f2421c7bf2fabbf">cm_get_environment</a>(host_name, <span class="keyword">sizeof</span>(host_name), expt_name, <span class="keyword">sizeof</span>(expt_name));
<a name="l01774"></a>01774 
<a name="l01775"></a>01775    <span class="comment">/* get parameters */</span>
<a name="l01776"></a>01776    <span class="keywordflow">for</span> (i = 1; i &lt; argc; i++) {
<a name="l01777"></a>01777       <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; argv[i][1] == <span class="charliteral">&apos;d&apos;</span>)
<a name="l01778"></a>01778          debug = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01779"></a>01779       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; argv[i][1] == <span class="charliteral">&apos;D&apos;</span>)
<a name="l01780"></a>01780          daemon = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01781"></a>01781       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(argv[i], <span class="stringliteral">&quot;-z&quot;</span>, 2) == 0)
<a name="l01782"></a>01782          <a class="code" href="lazylogger_8c.html#a0ef9ee54f7de740c695f9258b8f3dd5c">zap_flag</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01783"></a>01783       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(argv[i], <span class="stringliteral">&quot;-t&quot;</span>, 2) == 0)
<a name="l01784"></a>01784          <a class="code" href="lazylogger_8c.html#ab2f0c1e68c31ad3f94f2f056bd1fdf9e">msg_flag</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01785"></a>01785       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l01786"></a>01786          <span class="keywordflow">if</span> (i + 1 &gt;= argc || argv[i + 1][0] == <span class="charliteral">&apos;-&apos;</span>)
<a name="l01787"></a>01787             <span class="keywordflow">goto</span> <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>;
<a name="l01788"></a>01788          <span class="keywordflow">if</span> (strncmp(argv[i], <span class="stringliteral">&quot;-e&quot;</span>, 2) == 0)
<a name="l01789"></a>01789             strcpy(expt_name, argv[++i]);
<a name="l01790"></a>01790          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(argv[i], <span class="stringliteral">&quot;-h&quot;</span>, 2) == 0)
<a name="l01791"></a>01791             strcpy(host_name, argv[++i]);
<a name="l01792"></a>01792          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(argv[i], <span class="stringliteral">&quot;-c&quot;</span>, 2) == 0)
<a name="l01793"></a>01793             strcpy(channel_name, argv[++i]);
<a name="l01794"></a>01794       } <span class="keywordflow">else</span> {
<a name="l01795"></a>01795        <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>:
<a name="l01796"></a>01796          printf(<span class="stringliteral">&quot;Lazylogger: Multi channel background data copier\n&quot;</span>);
<a name="l01797"></a>01797          printf(<span class="stringliteral">&quot;usage: lazylogger [-h &lt;Hostname&gt;] [-e &lt;Experiment&gt;]\n&quot;</span>);
<a name="l01798"></a>01798          printf(<span class="stringliteral">&quot;                  [-z zap statistics] [-t (talk msg)\n&quot;</span>);
<a name="l01799"></a>01799          printf(<span class="stringliteral">&quot;                  [-c channel name (Disk) -D to start as a daemon\n\n&quot;</span>);
<a name="l01800"></a>01800          printf(<span class="stringliteral">&quot;Quick man :\n&quot;</span>);
<a name="l01801"></a>01801          printf(<span class="stringliteral">&quot;The Lazy/Settings tree is composed of the following parameters:\n&quot;</span>);
<a name="l01802"></a>01802          printf
<a name="l01803"></a>01803              (<span class="stringliteral">&quot;Maintain free space [%%](0): purge source device to maintain free space on the source directory\n&quot;</span>);
<a name="l01804"></a>01804          printf(<span class="stringliteral">&quot;                      (0) : no purge      \n&quot;</span>);
<a name="l01805"></a>01805          printf
<a name="l01806"></a>01806              (<span class="stringliteral">&quot;Stay behind  (-3)         : If negative number : lazylog runs starting from the OLDEST\n&quot;</span>);
<a name="l01807"></a>01807          printf
<a name="l01808"></a>01808              (<span class="stringliteral">&quot;                             run file sitting in the &apos;Dir data&apos; to the current acquisition\n&quot;</span>);
<a name="l01809"></a>01809          printf(<span class="stringliteral">&quot;                             run minus the &apos;Stay behind number&apos;\n&quot;</span>);
<a name="l01810"></a>01810          printf
<a name="l01811"></a>01811              (<span class="stringliteral">&quot;                            If positive number : lazylog starts from the current\n&quot;</span>);
<a name="l01812"></a>01812          printf
<a name="l01813"></a>01813              (<span class="stringliteral">&quot;                             acquisition run minus &apos;Stay behind number&apos; \n&quot;</span>);
<a name="l01814"></a>01814          printf
<a name="l01815"></a>01815              (<span class="stringliteral">&quot;Alarm Class               : Specify the Class to be used in case of Tape Full condition\n&quot;</span>);
<a name="l01816"></a>01816          printf
<a name="l01817"></a>01817              (<span class="stringliteral">&quot;Running condition         : active/deactive lazylogger under given condition i.e:\n&quot;</span>);
<a name="l01818"></a>01818          printf
<a name="l01819"></a>01819              (<span class="stringliteral">&quot;                           &apos;ALWAYS&apos; (default)     : Independent of the ACQ state ...\n&quot;</span>);
<a name="l01820"></a>01820          printf(<span class="stringliteral">&quot;                           &apos;NEVER&apos;                : ...\n&quot;</span>);
<a name="l01821"></a>01821          printf(<span class="stringliteral">&quot;                           &apos;WHILE_ACQ_NOT_RUNNING&apos;: ...\n&quot;</span>);
<a name="l01822"></a>01822          printf
<a name="l01823"></a>01823              (<span class="stringliteral">&quot;                           &apos;/alias/max_rate &lt; 200&apos;    (max_rate is a link)\n&quot;</span>);
<a name="l01824"></a>01824          printf
<a name="l01825"></a>01825              (<span class="stringliteral">&quot;                           &apos;/equipment/scaler/variables/scal[4] &lt; 23.45&apos;\n&quot;</span>);
<a name="l01826"></a>01826          printf
<a name="l01827"></a>01827              (<span class="stringliteral">&quot;                           &apos;/equipment/trigger/statistics/events per sec. &lt; 400&apos;\n&quot;</span>);
<a name="l01828"></a>01828          printf(<span class="stringliteral">&quot;Data dir                  : Directory of the run to be lazylogged \n&quot;</span>);
<a name="l01829"></a>01829          printf(<span class="stringliteral">&quot;Data format               : Data format (YBOS/MIDAS)\n&quot;</span>);
<a name="l01830"></a>01830          printf(<span class="stringliteral">&quot;Filename format           : Run format i.e. run%%05d.mid \n&quot;</span>);
<a name="l01831"></a>01831          printf(<span class="stringliteral">&quot;List label                : Label of destination save_set.\n&quot;</span>);
<a name="l01832"></a>01832          printf(<span class="stringliteral">&quot;                            Prevent lazylogger to run if not given.\n&quot;</span>);
<a name="l01833"></a>01833          printf
<a name="l01834"></a>01834              (<span class="stringliteral">&quot;                            Will be reset if maximum capacity reached.\n&quot;</span>);
<a name="l01835"></a>01835          printf
<a name="l01836"></a>01836              (<span class="stringliteral">&quot;Execute after rewind      : Execute the command &lt;cmd&gt; after rewind complete\n&quot;</span>);
<a name="l01837"></a>01837          printf
<a name="l01838"></a>01838              (<span class="stringliteral">&quot;                          : args passed are: &apos;device path&apos; &apos;channel name&apos; &apos;list label&apos;\n&quot;</span>);
<a name="l01839"></a>01839          printf
<a name="l01840"></a>01840              (<span class="stringliteral">&quot;                          : The actual command will look like: &lt;cmd&gt; /dev/nst0 Tape Data_2000\n&quot;</span>);
<a name="l01841"></a>01841          printf
<a name="l01842"></a>01842              (<span class="stringliteral">&quot;Backup type               : Destination device type (Disk, Tape, FTP)\n&quot;</span>);
<a name="l01843"></a>01843          printf
<a name="l01844"></a>01844              (<span class="stringliteral">&quot;Path                      : Destination path (file.ext, /dev/nst0, ftp...)\n&quot;</span>);
<a name="l01845"></a>01845          printf
<a name="l01846"></a>01846              (<span class="stringliteral">&quot;                            in case of FTP type, the &apos;Path&apos; entry should be:\n&quot;</span>);
<a name="l01847"></a>01847          printf
<a name="l01848"></a>01848              (<span class="stringliteral">&quot;                            host, port, user, password, directory, run%%05d.mid\n&quot;</span>);
<a name="l01849"></a>01849          printf
<a name="l01850"></a>01850              (<span class="stringliteral">&quot;Capacity (Bytes)          : Maximum capacity of the destination device.\n&quot;</span>);
<a name="l01851"></a>01851          printf
<a name="l01852"></a>01852              (<span class="stringliteral">&quot;modulo                    : Enable multiple lazy on same source. Ex: 3ch : 3.0, 3.1, 3.2\n&quot;</span>);
<a name="l01853"></a>01853          printf
<a name="l01854"></a>01854              (<span class="stringliteral">&quot;tapeAppend                : Enable positioning of the TAPE to EOD before each lazy copy\n&quot;</span>);
<a name="l01855"></a>01855          <span class="keywordflow">return</span> 0;
<a name="l01856"></a>01856       }
<a name="l01857"></a>01857    }
<a name="l01858"></a>01858 
<a name="l01859"></a>01859    <span class="comment">/* Handle SIGPIPE signals generated from errors on the pipe */</span>
<a name="l01860"></a>01860 <span class="preprocessor">#ifdef SIGPIPE</span>
<a name="l01861"></a>01861 <span class="preprocessor"></span>   signal(SIGPIPE, SIG_IGN);
<a name="l01862"></a>01862 <span class="preprocessor">#endif</span>
<a name="l01863"></a>01863 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (daemon) {
<a name="l01864"></a>01864       printf(<span class="stringliteral">&quot;Becoming a daemon...\n&quot;</span>);
<a name="l01865"></a>01865       <a class="code" href="group__msystemincludecode.html#ga957613d29ce8b6e66f075ace4f32c1e1">ss_daemon_init</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01866"></a>01866    }
<a name="l01867"></a>01867 
<a name="l01868"></a>01868    <span class="comment">/* connect to experiment */</span>
<a name="l01869"></a>01869    status =
<a name="l01870"></a>01870        <a class="code" href="group__msectionh.html#gae2c7dedc142d472208e2e67f920b91e2">cm_connect_experiment1</a>(host_name, expt_name, <span class="stringliteral">&quot;Lazy&quot;</span>, 0, <a class="code" href="group__midasincludecode.html#gac5b414ae3a2f854b099c08f5e63e8671">DEFAULT_ODB_SIZE</a>,
<a name="l01871"></a>01871                               <a class="code" href="lazylogger_8c.html#abf89628d486477bd0db5a5890cd38a05">WATCHDOG_TIMEOUT</a>);
<a name="l01872"></a>01872    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01873"></a>01873       <span class="keywordflow">return</span> 1;
<a name="l01874"></a>01874 
<a name="l01875"></a>01875    <span class="comment">/* create a common mutex for the independent lazylogger */</span>
<a name="l01876"></a>01876    status = <a class="code" href="group__msystemincludecode.html#ga518ac9986c25e4f472f7d731a98ca2f3">ss_mutex_create</a>(<span class="stringliteral">&quot;LAZY&quot;</span>, &amp;<a class="code" href="lazylogger_8c.html#ad82767a8569bed318543d968cb2827e4">lazy_mutex</a>);
<a name="l01877"></a>01877 
<a name="l01878"></a>01878    <span class="comment">/* check lazy status for multiple channels */</span>
<a name="l01879"></a>01879    <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, &amp;<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>);
<a name="l01880"></a>01880    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Lazy&quot;</span>, &amp;<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01881"></a>01881       <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#aac58a320ae0ebf75ec6d8a273184b463">hSubkey</a>;
<a name="l01882"></a>01882       <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l01883"></a>01883       <span class="keywordtype">char</span> strclient[32];
<a name="l01884"></a>01884       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a> = 0;
<a name="l01885"></a>01885       <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01886"></a>01886          <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, i, &amp;hSubkey);
<a name="l01887"></a>01887          <span class="keywordflow">if</span> (!hSubkey)
<a name="l01888"></a>01888             <span class="keywordflow">break</span>;
<a name="l01889"></a>01889          <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hSubkey, &amp;key);
<a name="l01890"></a>01890          <span class="keywordflow">if</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> == <a class="code" href="group__mdefineh.html#ga15ae151ae0b7588b3327bd8451d9bcb8">TID_KEY</a>) {
<a name="l01891"></a>01891             <span class="comment">/* compose client name */</span>
<a name="l01892"></a>01892             sprintf(strclient, <span class="stringliteral">&quot;Lazy_%s&quot;</span>, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01893"></a>01893             <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gafe2e23ec2e5c20fbc65ee238bd6cd48e">cm_exist</a>(strclient, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01894"></a>01894                lazyinfo[j].<a class="code" href="structLAZY__INFO.html#a9e4e633f2a1b62d5b2367c4416317a53">active</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01895"></a>01895             <span class="keywordflow">else</span>
<a name="l01896"></a>01896                lazyinfo[j].<a class="code" href="structLAZY__INFO.html#a9e4e633f2a1b62d5b2367c4416317a53">active</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01897"></a>01897             strcpy(lazyinfo[j].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01898"></a>01898 
<a name="l01899"></a>01899             lazyinfo[j].<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a> = hSubkey;
<a name="l01900"></a>01900             j++;
<a name="l01901"></a>01901          }
<a name="l01902"></a>01902       }
<a name="l01903"></a>01903    } <span class="keywordflow">else</span> {
<a name="l01904"></a>01904       <span class="comment">/* create settings tree */</span>
<a name="l01905"></a>01905       <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[32];
<a name="l01906"></a>01906       <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> = 0;
<a name="l01907"></a>01907       <span class="keywordflow">if</span> (channel_name[0] != 0)
<a name="l01908"></a>01908          sprintf(lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, channel_name);
<a name="l01909"></a>01909       sprintf(str, <span class="stringliteral">&quot;/Lazy/%s/Settings&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].name);
<a name="l01910"></a>01910       <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="lazylogger_8c.html#a629e5d73e788fe4c26b1cc6c8acc2d20">LAZY_SETTINGS_STRING</a>);
<a name="l01911"></a>01911    }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913    {                            <span class="comment">/* Selection of client */</span>
<a name="l01914"></a>01914       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> i, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>;
<a name="l01915"></a>01915       <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[32];
<a name="l01916"></a>01916 
<a name="l01917"></a>01917       <span class="keywordflow">if</span> (lazyinfo[0].<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>) {
<a name="l01918"></a>01918          <span class="keywordflow">if</span> (channel_name[0] == 0) {
<a name="l01919"></a>01919             <span class="comment">/* command prompt */</span>
<a name="l01920"></a>01920             printf(<span class="stringliteral">&quot; Available Lazy channels to connect to:\n&quot;</span>);
<a name="l01921"></a>01921             i = 0;
<a name="l01922"></a>01922             j = 1;
<a name="l01923"></a>01923             <span class="keywordflow">while</span> (lazyinfo[i].hKey) {
<a name="l01924"></a>01924                <span class="keywordflow">if</span> (!lazyinfo[i].active)
<a name="l01925"></a>01925                   printf(<span class="stringliteral">&quot;%d) Lazy %s \n&quot;</span>, j, lazyinfo[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l01926"></a>01926                <span class="keywordflow">else</span>
<a name="l01927"></a>01927                   printf(<span class="stringliteral">&quot;.) Lazy %s already active\n&quot;</span>, lazyinfo[i].name);
<a name="l01928"></a>01928                j++;
<a name="l01929"></a>01929                i++;
<a name="l01930"></a>01930             }
<a name="l01931"></a>01931             printf(<span class="stringliteral">&quot;Enter client number or new lazy client name: &quot;</span>);
<a name="l01932"></a>01932             i = atoi(<a class="code" href="group__msectionh.html#ga062aca860070d963b86c98e8012dc43a">ss_gets</a>(str, 32));
<a name="l01933"></a>01933             <span class="keywordflow">if</span> ((i == 0) &amp;&amp; ((strlen(str) == 0) || (strncmp(str, <span class="stringliteral">&quot; &quot;</span>, 1) == 0))) {
<a name="l01934"></a>01934                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Please specify a valid channel name (%s)&quot;</span>, str);
<a name="l01935"></a>01935                <span class="keywordflow">goto</span> error;
<a name="l01936"></a>01936             }
<a name="l01937"></a>01937          } <span class="keywordflow">else</span> {
<a name="l01938"></a>01938             <span class="comment">/* Skip the command prompt for serving the -c option */</span>
<a name="l01939"></a>01939             <span class="comment">/*</span>
<a name="l01940"></a>01940 <span class="comment">               scan if channel_name already exists</span>
<a name="l01941"></a>01941 <span class="comment">               Yes : check if client is running</span>
<a name="l01942"></a>01942 <span class="comment">               Yes : get out (goto error)</span>
<a name="l01943"></a>01943 <span class="comment">               No  : connect (extract index)</span>
<a name="l01944"></a>01944 <span class="comment">               No  : new channel (i=0)</span>
<a name="l01945"></a>01945 <span class="comment">             */</span>
<a name="l01946"></a>01946             i = 0;
<a name="l01947"></a>01947             j = -1;
<a name="l01948"></a>01948             <span class="keywordflow">while</span> (lazyinfo[i].hKey) {
<a name="l01949"></a>01949                <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(channel_name, lazyinfo[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>)) {
<a name="l01950"></a>01950                   <span class="comment">/* correct name =&gt; check active  */</span>
<a name="l01951"></a>01951                   <span class="keywordflow">if</span> (lazyinfo[i].active) {
<a name="l01952"></a>01952                      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Lazy channel &quot;</span> <span class="stringliteral">&quot;%s&quot;</span> <span class="stringliteral">&quot; already running!&quot;</span>,
<a name="l01953"></a>01953                             lazyinfo[i].name);
<a name="l01954"></a>01954                      <span class="keywordflow">goto</span> error;
<a name="l01955"></a>01955                   }
<a name="l01956"></a>01956                   j = i;
<a name="l01957"></a>01957                }
<a name="l01958"></a>01958                i++;
<a name="l01959"></a>01959             }
<a name="l01960"></a>01960             <span class="keywordflow">if</span> (j == -1) {
<a name="l01961"></a>01961                <span class="comment">/* new entry */</span>
<a name="l01962"></a>01962                i = 0;
<a name="l01963"></a>01963                sprintf(str, <span class="stringliteral">&quot;%s&quot;</span>, channel_name);
<a name="l01964"></a>01964             } <span class="keywordflow">else</span> {
<a name="l01965"></a>01965                <span class="comment">/* connect to */</span>
<a name="l01966"></a>01966                i = j + 1;
<a name="l01967"></a>01967             }
<a name="l01968"></a>01968          }
<a name="l01969"></a>01969          <span class="keywordflow">if</span> (i == 0) {          <span class="comment">/* new entry */</span>
<a name="l01970"></a>01970             <span class="keywordtype">char</span> strclient[32];
<a name="l01971"></a>01971             <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="lazylogger_8c.html#a869fa7fe9076c407092370aaf05831c6">MAX_LAZY_CHANNEL</a>; j++) {
<a name="l01972"></a>01972                <span class="keywordflow">if</span> (lazyinfo[j].hKey == 0) {
<a name="l01973"></a>01973                   <span class="comment">/* compose client name */</span>
<a name="l01974"></a>01974                   sprintf(strclient, <span class="stringliteral">&quot;Lazy_%s&quot;</span>, str);
<a name="l01975"></a>01975                   <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gafe2e23ec2e5c20fbc65ee238bd6cd48e">cm_exist</a>(strclient, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01976"></a>01976                      lazyinfo[j].<a class="code" href="structLAZY__INFO.html#a9e4e633f2a1b62d5b2367c4416317a53">active</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01977"></a>01977                   <span class="keywordflow">else</span>
<a name="l01978"></a>01978                      lazyinfo[j].<a class="code" href="structLAZY__INFO.html#a9e4e633f2a1b62d5b2367c4416317a53">active</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01979"></a>01979                   strcpy(lazyinfo[j].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, str);
<a name="l01980"></a>01980                   lazyinfo[j].<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a> = 0;
<a name="l01981"></a>01981                   <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> = j;
<a name="l01982"></a>01982                   <span class="keywordflow">break</span>;
<a name="l01983"></a>01983                }
<a name="l01984"></a>01984             }
<a name="l01985"></a>01985          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!lazyinfo[i - 1].active)
<a name="l01986"></a>01986             <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> = i - 1;
<a name="l01987"></a>01987          <span class="keywordflow">else</span>
<a name="l01988"></a>01988             <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> = -1;
<a name="l01989"></a>01989       }
<a name="l01990"></a>01990 
<a name="l01991"></a>01991       <span class="keywordflow">if</span> ((<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> &lt; 0) &amp;&amp; (lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].hKey != 0))
<a name="l01992"></a>01992          <span class="keywordflow">goto</span> error;
<a name="l01993"></a>01993       <span class="keywordflow">if</span> (<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> &lt; 0)
<a name="l01994"></a>01994          <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a> = 0;
<a name="l01995"></a>01995 
<a name="l01996"></a>01996       {                         <span class="comment">/* creation of the lazy channel */</span>
<a name="l01997"></a>01997          <span class="keywordtype">char</span> str[128];
<a name="l01998"></a>01998 
<a name="l01999"></a>01999          <span class="keywordflow">if</span> (lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].hKey == 0)
<a name="l02000"></a>02000             printf(<span class="stringliteral">&quot; Creating Lazy channel %s\n&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l02001"></a>02001 
<a name="l02002"></a>02002          <span class="comment">/* create/update settings */</span>
<a name="l02003"></a>02003          sprintf(str, <span class="stringliteral">&quot;/Lazy/%s/Settings&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].name);
<a name="l02004"></a>02004          <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="lazylogger_8c.html#a629e5d73e788fe4c26b1cc6c8acc2d20">LAZY_SETTINGS_STRING</a>);
<a name="l02005"></a>02005          <span class="comment">/* create/update statistics */</span>
<a name="l02006"></a>02006          sprintf(str, <span class="stringliteral">&quot;/Lazy/%s/Statistics&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].name);
<a name="l02007"></a>02007          <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="lazylogger_8c.html#a991b3924ecbf649846565843d28f4f74">LAZY_STATISTICS_STRING</a>);
<a name="l02008"></a>02008          sprintf(str, <span class="stringliteral">&quot;/Lazy/%s&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].name);
<a name="l02009"></a>02009          <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].hKey);
<a name="l02010"></a>02010       }
<a name="l02011"></a>02011    }
<a name="l02012"></a>02012    <span class="comment">/* disconnect  from expriment */</span>
<a name="l02013"></a>02013    <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l02014"></a>02014 
<a name="l02015"></a>02015    {                            <span class="comment">/* reconnect to experiment with proper name */</span>
<a name="l02016"></a>02016       <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[32];
<a name="l02017"></a>02017       sprintf(str, <span class="stringliteral">&quot;Lazy_%s&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l02018"></a>02018       status =
<a name="l02019"></a>02019           <a class="code" href="group__msectionh.html#gae2c7dedc142d472208e2e67f920b91e2">cm_connect_experiment1</a>(host_name, expt_name, str, 0, <a class="code" href="group__midasincludecode.html#gac5b414ae3a2f854b099c08f5e63e8671">DEFAULT_ODB_SIZE</a>,
<a name="l02020"></a>02020                                  <a class="code" href="lazylogger_8c.html#abf89628d486477bd0db5a5890cd38a05">WATCHDOG_TIMEOUT</a>);
<a name="l02021"></a>02021    }
<a name="l02022"></a>02022    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02023"></a>02023       <span class="keywordflow">goto</span> error;
<a name="l02024"></a>02024 
<a name="l02025"></a>02025    <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, &amp;<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>);
<a name="l02026"></a>02026 
<a name="l02027"></a>02027    <span class="comment">/* Remove temporary Lazy entry */</span>
<a name="l02028"></a>02028    {
<a name="l02029"></a>02029       <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hPkey;
<a name="l02030"></a>02030 
<a name="l02031"></a>02031       status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;Programs/Lazy&quot;</span>, &amp;hPkey);
<a name="l02032"></a>02032       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02033"></a>02033          status = <a class="code" href="group__msectionh.html#ga91277a012e0bfddbc32885da450409e0">db_delete_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hPkey, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l02034"></a>02034          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02035"></a>02035             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;Cannot delete /Programs/Lazy&quot;</span>);
<a name="l02036"></a>02036          }
<a name="l02037"></a>02037       }
<a name="l02038"></a>02038    }
<a name="l02039"></a>02039 
<a name="l02040"></a>02040    <span class="comment">/* turn on keepalive messages with increased timeout */</span>
<a name="l02041"></a>02041    <span class="keywordflow">if</span> (debug)
<a name="l02042"></a>02042       <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, 0);
<a name="l02043"></a>02043 
<a name="l02044"></a>02044    printf(<span class="stringliteral">&quot;Lazy_%s starting... &quot;</span> <span class="stringliteral">&quot;!&quot;</span> <span class="stringliteral">&quot; to exit \n&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l02045"></a>02045 
<a name="l02046"></a>02046    <span class="keywordflow">if</span> (<a class="code" href="lazylogger_8c.html#a0ef9ee54f7de740c695f9258b8f3dd5c">zap_flag</a>) {
<a name="l02047"></a>02047       <span class="comment">/* reset the statistics */</span>
<a name="l02048"></a>02048       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;zapping %s/statistics content&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].name);
<a name="l02049"></a>02049       size = <span class="keyword">sizeof</span>(lazyst);
<a name="l02050"></a>02050       memset(&amp;lazyst, 0, size);
<a name="l02051"></a>02051       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="stringliteral">&quot;Statistics&quot;</span>, &amp;<a class="code" href="lazylogger_8c.html#affc2c1ae6ae328e611c4825cc47c05f6">hKeyst</a>) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l02052"></a>02052          status = <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="lazylogger_8c.html#affc2c1ae6ae328e611c4825cc47c05f6">hKeyst</a>, &amp;lazyst, size, 0);
<a name="l02053"></a>02053       <span class="keywordflow">else</span>
<a name="l02054"></a>02054          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;did not find %s/Statistics for zapping&quot;</span>,
<a name="l02055"></a>02055                 lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].name);
<a name="l02056"></a>02056    }
<a name="l02057"></a>02057 
<a name="l02058"></a>02058    <span class="comment">/* get value once &amp; hot links the run state */</span>
<a name="l02059"></a>02059    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/runinfo/state&quot;</span>, &amp;<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>);
<a name="l02060"></a>02060    size = <span class="keyword">sizeof</span>(<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>);
<a name="l02061"></a>02061    <a class="code" href="group__msectionh.html#gad6e53374f24813cdba8713781683c556">db_get_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, &amp;<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l02062"></a>02062    status =
<a name="l02063"></a>02063        <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, &amp;<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>, <span class="keyword">sizeof</span>(<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL);
<a name="l02064"></a>02064    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02065"></a>02065       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;cannot open /runinfo/state record&quot;</span>);
<a name="l02066"></a>02066    }
<a name="l02067"></a>02067    <span class="comment">/* hot link for statistics in write mode */</span>
<a name="l02068"></a>02068    size = <span class="keyword">sizeof</span>(lazyst);
<a name="l02069"></a>02069    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].<a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="stringliteral">&quot;Statistics&quot;</span>, &amp;hKey) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l02070"></a>02070       <a class="code" href="group__msectionh.html#gaae4cf88eaadf5d2dd9eefa3e1b6389e6">db_get_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;lazyst, &amp;size, 0);
<a name="l02071"></a>02071    status = <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;lazyst, <span class="keyword">sizeof</span>(lazyst), <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a>, NULL, NULL);
<a name="l02072"></a>02072    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02073"></a>02073       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;cannot open %s/Statistics record&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].name);
<a name="l02074"></a>02074    }
<a name="l02075"></a>02075    <span class="comment">/* get /settings once &amp; hot link settings in read mode */</span>
<a name="l02076"></a>02076    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].hKey, <span class="stringliteral">&quot;Settings&quot;</span>, &amp;hKey);
<a name="l02077"></a>02077    size = <span class="keyword">sizeof</span>(lazy);
<a name="l02078"></a>02078    status = <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;lazy, <span class="keyword">sizeof</span>(lazy)
<a name="l02079"></a>02079                            , <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="lazylogger_8c.html#aa990fe8387881e9fd696493186e090af">lazy_settings_hotlink</a>, NULL);
<a name="l02080"></a>02080    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02081"></a>02081       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Lazy&quot;</span>, <span class="stringliteral">&quot;cannot open %s/Settings record&quot;</span>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].name);
<a name="l02082"></a>02082    }
<a name="l02083"></a>02083 
<a name="l02084"></a>02084    <span class="comment">/* set global key for that channel */</span>
<a name="l02085"></a>02085    <a class="code" href="lazylogger_8c.html#ac6ff92e529008dd5866223bde86e808d">pcurrent_hKey</a> = lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].<a class="code" href="structLAZY__INFO.html#a113fdecbfdf9026aef03644295aebe6a">hKey</a>;
<a name="l02086"></a>02086 
<a name="l02087"></a>02087    <span class="comment">/* set Data dir from /logger if local is empty &amp; /logger exists */</span>
<a name="l02088"></a>02088    <span class="keywordflow">if</span> ((lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>[0] == <span class="charliteral">&apos;\0&apos;</span>) &amp;&amp;
<a name="l02089"></a>02089        (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Data dir&quot;</span>, &amp;hKey) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)) {
<a name="l02090"></a>02090       size = <span class="keyword">sizeof</span>(lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>);
<a name="l02091"></a>02091       <a class="code" href="group__msectionh.html#gad6e53374f24813cdba8713781683c556">db_get_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>);
<a name="l02092"></a>02092       <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, lazyinfo[<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>].hKey, <span class="stringliteral">&quot;Settings/Data dir&quot;</span>, lazy.<a class="code" href="structLAZY__SETTING.html#a733f6dc5b99c0db5a88c6c350b30ae2b">dir</a>, size, 1,
<a name="l02093"></a>02093                    <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>);
<a name="l02094"></a>02094    }
<a name="l02095"></a>02095 
<a name="l02096"></a>02096    mainlast_time = 0;
<a name="l02097"></a>02097 
<a name="l02098"></a>02098    <span class="comment">/* initialize ss_getchar() */</span>
<a name="l02099"></a>02099    <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(0);
<a name="l02100"></a>02100 
<a name="l02101"></a>02101    <span class="keywordflow">do</span> {
<a name="l02102"></a>02102       msg = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(2000);
<a name="l02103"></a>02103       <span class="keywordflow">if</span> ((<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - mainlast_time) &gt; 10000) {
<a name="l02104"></a>02104          status = <a class="code" href="lazylogger_8c.html#a2bd150be563935695ecf7aab6b9fcea6">lazy_main</a>(<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>, &amp;lazyinfo[0]);
<a name="l02105"></a>02105          <span class="keywordflow">if</span> (status == <a class="code" href="lazylogger_8c.html#a8a7b3cda6109a9172539c220ae1a65d9">FORCE_EXIT</a>) {
<a name="l02106"></a>02106             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;lazy&quot;</span>, <span class="stringliteral">&quot;Previous error forces task exit&quot;</span>);
<a name="l02107"></a>02107             <span class="keywordflow">break</span>;
<a name="l02108"></a>02108          }
<a name="l02109"></a>02109          mainlast_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l02110"></a>02110       }
<a name="l02111"></a>02111       ch = 0;
<a name="l02112"></a>02112       <span class="keywordflow">while</span> (<a class="code" href="group__msectionh.html#gae96b0ebe47aa1d54f800e4f2e7f564b9">ss_kbhit</a>()) {
<a name="l02113"></a>02113          ch = <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(0);
<a name="l02114"></a>02114          <span class="keywordflow">if</span> (ch == -1)
<a name="l02115"></a>02115             ch = getchar();
<a name="l02116"></a>02116          <span class="keywordflow">if</span> ((<span class="keywordtype">char</span>) ch == <span class="charliteral">&apos;!&apos;</span>)
<a name="l02117"></a>02117             <span class="keywordflow">break</span>;
<a name="l02118"></a>02118       }
<a name="l02119"></a>02119    } <span class="keywordflow">while</span> (msg != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> &amp;&amp; msg != <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a> &amp;&amp; ch != <span class="charliteral">&apos;!&apos;</span>);
<a name="l02120"></a>02120 
<a name="l02121"></a>02121  error:
<a name="l02122"></a>02122    <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l02123"></a>02123    <span class="keywordflow">return</span> 1;
<a name="l02124"></a>02124 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
