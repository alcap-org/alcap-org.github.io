<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ: CAEN/CAENUpgrader-1.4.1/cvUpgrade/src/cvupgrade.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>CAEN/CAENUpgrader-1.4.1/cvUpgrade/src/cvupgrade.c File Reference</h1><code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;malloc.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="cvUpgrade_2include_2flash_8h_source.html">flash.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cvUpgrade_2include_2CFASegment_8h_source.html">CFASegment.h</a>&quot;</code><br/>

<p><a href="cvupgrade_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structUpgradeParams.html">UpgradeParams</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#ad526597ab378f3faff87123d7742c79a">REVISION</a>&nbsp;&nbsp;&nbsp;&quot;2.4&quot;</td></tr>
<tr><td colspan="2"><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structUpgradeParams.html">UpgradeParams</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a0e340b9cb168fe33e68f8c271c81c1cd">cvUpgradeParams</a></td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#ae28fba57a1edfa47dfb0ed05fb38131c">Usage</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a3889b2b6bdef9d4f2f1a76c8c323defa">ReadConfigurationROM</a> (<a class="el" href="structFlashAccess.html">cvFlashAccess</a> *Flash, <a class="el" href="structCROM__MAP.html">CROM_MAP</a> *crom)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a42fb85b07498ef78b4b0e1005612c653">ReadLicense</a> (<a class="el" href="structFlashAccess.html">cvFlashAccess</a> *Flash, uint8_t licenseData[LICENSE_DATA_SIZE])</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#ada4976fd40aad52b34f8010ca33de5db">EraseLicense</a> (<a class="el" href="structFlashAccess.html">cvFlashAccess</a> *Flash)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#aca02ef2acaccca7fb14ce091ce7eee04">PrintCROM2File</a> (FILE *<a class="el" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>, const <a class="el" href="structCROM__MAP.html">CROM_MAP</a> *<a class="el" href="webpaw_8c.html#a7b00b1bfd666e26484471bd17a74eaa9">map</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a76a02ca4195151597e19a0a994fc5be1">KeyInfo</a> (<a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *Config, <a class="el" href="structFlashAccess.html">cvFlashAccess</a> *Flash)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a9b8aeb6281400048a5e077a4cac434bc">GetFWRel</a> (<a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *Config, <a class="el" href="structFlashAccess.html">cvFlashAccess</a> *Flash)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a6cce5469e2c46cc06d94a42bf5d058f4">License</a> (<a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *Config, <a class="el" href="structFlashAccess.html">cvFlashAccess</a> *Flash)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a8ec6be8108a0d3ec304985b3531b5f95">WriteKey</a> (<a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *Config, <a class="el" href="structFlashAccess.html">cvFlashAccess</a> *Flash)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a07b0b2272110318092e6111087618477">validateModel</a> (<a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *<a class="el" href="lrs2415_8c.html#a6992a43d742ef1981dc9ebd8a532c567">config</a>, <a class="el" href="structFlashAccess.html">cvFlashAccess</a> *flash, char **fwData, int *fwSize)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a21306ca2af895f8960daac342f3e5614">cvUpgrade</a> (<a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *Config, <a class="el" href="structFlashAccess.html">cvFlashAccess</a> *Flash)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="cvupgrade_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a> (int argc, char *argv[])</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ad526597ab378f3faff87123d7742c79a"></a><!-- doxytag: member="cvupgrade.c::REVISION" ref="ad526597ab378f3faff87123d7742c79a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define REVISION&nbsp;&nbsp;&nbsp;&quot;2.4&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00075">75</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00623">main()</a>.</p>

</div>
</div>
<hr/><h2>Typedef Documentation</h2>
<a class="anchor" id="a0e340b9cb168fe33e68f8c271c81c1cd"></a><!-- doxytag: member="cvupgrade.c::cvUpgradeParams" ref="a0e340b9cb168fe33e68f8c271c81c1cd" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structUpgradeParams.html">UpgradeParams</a>  <a class="el" href="structUpgradeParams.html">cvUpgradeParams</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a21306ca2af895f8960daac342f3e5614"></a><!-- doxytag: member="cvupgrade.c::cvUpgrade" ref="a21306ca2af895f8960daac342f3e5614" args="(cvUpgradeParams *Config, cvFlashAccess *Flash)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int cvUpgrade </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *&nbsp;</td>
          <td class="paramname"> <em>Config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structFlashAccess.html">cvFlashAccess</a> *&nbsp;</td>
          <td class="paramname"> <em>Flash</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00466">466</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="cvupgrade_8c_source.html#l00090">UpgradeParams::BaseAddress</a>, <a class="el" href="cvupgrade_8c_source.html#l00089">UpgradeParams::BdNum</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00003">c</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00026">CAENCOM_INVALID_FILE_HANDLE</a>, <a class="el" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac">CAENComm_CloseDevice()</a>, <a class="el" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice()</a>, <a class="el" href="CAENComm_8h_source.html#l00084">CAENComm_Success</a>, <a class="el" href="cvupgrade_8c_source.html#l00098">UpgradeParams::cfa</a>, <a class="el" href="cvupgrade_8c_source.html#l00099">UpgradeParams::ConfFile</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00079">CvUpgrade_CAENCommError</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00081">CvUpgrade_FileAccessError</a>, <a class="el" href="cvupgrade_8c_source.html#l00092">UpgradeParams::FirstPageBck</a>, <a class="el" href="cvupgrade_8c_source.html#l00091">UpgradeParams::FirstPageStd</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00067">FlashAccess::Handle</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="cvupgrade_8c_source.html#l00094">UpgradeParams::image</a>, <a class="el" href="odbhist_8c_source.html#l00058">j</a>, <a class="el" href="cvupgrade_8c_source.html#l00088">UpgradeParams::Link</a>, <a class="el" href="cvupgrade_8c_source.html#l00100">UpgradeParams::Models</a>, <a class="el" href="cvupgrade_8c_source.html#l00095">UpgradeParams::noverify</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00072">FlashAccess::PageSize</a>, <a class="el" href="CAENBridgeUpgrade_2src_2flash_8c_source.html#l00202">ReadFlashPage()</a>, <a class="el" href="cvupgrade_8c_source.html#l00087">UpgradeParams::Type</a>, <a class="el" href="generate-MODULES_8h_source.html#l00006">Usage</a>, <a class="el" href="CAENBridgeUpgrade_8c_source.html#l00099">validateModel()</a>, <a class="el" href="cvupgrade_8c_source.html#l00096">UpgradeParams::verifyonly</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00023">Wait_ms</a>, <a class="el" href="CAENBridgeUpgrade_2src_2flash_8c_source.html#l00186">WriteFlashPage()</a>, and <a class="el" href="cvupgrade_8c_source.html#l00377">WriteKey()</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00623">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00467"></a>00467 {
<a name="l00468"></a>00468     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, page, pa,  NumPages, err=0, done;    
<a name="l00469"></a>00469     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> CFsize;
<a name="l00470"></a>00470     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, *CFdata = NULL;
<a name="l00471"></a>00471     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> pdr[2048];
<a name="l00472"></a>00472     <span class="keywordtype">int</span> res;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     FILE *cf;
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="comment">/* initialize the connection */</span>
<a name="l00477"></a>00477     res = <a class="code" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice</a>(Config-&gt;<a class="code" href="structUpgradeParams.html#a748375db853b611f044d6be639acc2c6">Type</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#a2a720635715958998b24686be6734536">Link</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#aa3db4e8cff315090fe436657acd278dc">BdNum</a>,  Config-&gt;<a class="code" href="structUpgradeParams.html#a42e8c35c64e68590b9cca03ff1e042cb">BaseAddress</a>, &amp;Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00478"></a>00478     <span class="keywordflow">if</span> (res != <a class="code" href="CAENComm_8h.html#a957016b0c3a404d6ab61ea3edf310ad4ad3c23b64a7fcf3b2fb35960981352587">CAENComm_Success</a>) {
<a name="l00479"></a>00479         printf(<span class="stringliteral">&quot;Cannot open the Device!\n&quot;</span>);
<a name="l00480"></a>00480                 <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5a4d0c6446004ca3b35d499f71a6408e7f">CvUpgrade_CAENCommError</a>);
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="comment">// ************************************************</span>
<a name="l00485"></a>00485     <span class="comment">// Open Binary Configuration File</span>
<a name="l00486"></a>00486     <span class="comment">// ************************************************</span>
<a name="l00487"></a>00487         <span class="keywordflow">if</span> (!Config-&gt;<a class="code" href="structUpgradeParams.html#a47424e61651250061e6542f9fe54317a">cfa</a>) {
<a name="l00488"></a>00488                 <span class="comment">// open and read the configuration file</span>
<a name="l00489"></a>00489                 cf = fopen(Config-&gt;<a class="code" href="structUpgradeParams.html#ab029ec441d57f71ed526ad610db0f85d">ConfFile</a>,<span class="stringliteral">&quot;rb&quot;</span>);
<a name="l00490"></a>00490                 <span class="keywordflow">if</span>(cf == 0) {
<a name="l00491"></a>00491                         printf(<span class="stringliteral">&quot;Can&apos;t open file %s\n&quot;</span>,Config-&gt;<a class="code" href="structUpgradeParams.html#ab029ec441d57f71ed526ad610db0f85d">ConfFile</a>);
<a name="l00492"></a>00492                         <a class="code" href="generate-MODULES_8h.html#a3605307780f1adef4b64af88704d0861">Usage</a>();
<a name="l00493"></a>00493                         <a class="code" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac" title="Close the device.">CAENComm_CloseDevice</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00494"></a>00494                         <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00495"></a>00495                 }
<a name="l00496"></a>00496                 <span class="comment">// calculate the size</span>
<a name="l00497"></a>00497                 fseek (cf, 0, SEEK_END);
<a name="l00498"></a>00498                 CFsize = ftell (cf);
<a name="l00499"></a>00499                 fseek (cf, 0, SEEK_SET);
<a name="l00500"></a>00500                 <span class="keywordflow">if</span> ( (CFdata = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)malloc(CFsize)) == NULL ) {
<a name="l00501"></a>00501                         printf(<span class="stringliteral">&quot;Can&apos;t allocate %d bytes\n&quot;</span>,CFsize);
<a name="l00502"></a>00502                         <a class="code" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac" title="Close the device.">CAENComm_CloseDevice</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00503"></a>00503                         <span class="keywordflow">return</span>(-3);
<a name="l00504"></a>00504                 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506                 <span class="keywordflow">for</span>(i=0; i&lt;CFsize; i++) {
<a name="l00507"></a>00507                         <span class="comment">// read one byte from file and mirror it (lsb becomes msb)</span>
<a name="l00508"></a>00508                         c = (<span class="keywordtype">unsigned</span> char)fgetc(cf);
<a name="l00509"></a>00509                         CFdata[i]=0;
<a name="l00510"></a>00510                         <span class="keywordflow">for</span>(j=0; j&lt;8; j++)
<a name="l00511"></a>00511                                 CFdata[i] |= ( (c &gt;&gt; (7-j)) &amp; 1) &lt;&lt; j;
<a name="l00512"></a>00512                 }
<a name="l00513"></a>00513                 fclose(cf);
<a name="l00514"></a>00514 
<a name="l00515"></a>00515         } <span class="keywordflow">else</span> {
<a name="l00516"></a>00516                 printf(<span class="stringliteral">&quot;CFA Mode. Reading archive.\n&quot;</span>);
<a name="l00517"></a>00517                 <span class="keywordflow">if</span> (<a class="code" href="CAENBridgeUpgrade_8c.html#a7d5f93cc4bcf35fe9966498450b4d9e2">validateModel</a>(Config, Flash, &amp;CFdata, &amp;CFsize)) {
<a name="l00518"></a>00518                         printf(<span class="stringliteral">&quot;Error: no compatible firmware found in archive!\n&quot;</span>);
<a name="l00519"></a>00519                         <a class="code" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac" title="Close the device.">CAENComm_CloseDevice</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00520"></a>00520                         <span class="keywordflow">return</span> -99;
<a name="l00521"></a>00521                 }
<a name="l00522"></a>00522                 printf(<span class="stringliteral">&quot;Compatible firmware found in archive.\n&quot;</span>);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524                 <span class="keywordflow">for</span> (i=0; i&lt;CFsize; i++) {
<a name="l00525"></a>00525                         <span class="keywordtype">char</span> c = CFdata[i];
<a name="l00526"></a>00526                         CFdata[i] = 0;
<a name="l00527"></a>00527                         <span class="keywordflow">for</span> (j=0; j&lt;8; j++)
<a name="l00528"></a>00528                                 CFdata[i] |= ( (c &gt;&gt; (7-j)) &amp; 1) &lt;&lt; j;
<a name="l00529"></a>00529                 }
<a name="l00530"></a>00530         }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     NumPages = (CFsize % Flash-&gt;<a class="code" href="structFlashAccess.html#aa44c50badfa9330565180db7196d5051">PageSize</a> == 0) ? (CFsize / Flash-&gt;<a class="code" href="structFlashAccess.html#aa44c50badfa9330565180db7196d5051">PageSize</a>) : (CFsize / Flash-&gt;<a class="code" href="structFlashAccess.html#aa44c50badfa9330565180db7196d5051">PageSize</a>) + 1;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         printf(<span class="stringliteral">&quot;Board Types: %s\n&quot;</span>, Config-&gt;<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>);
<a name="l00536"></a>00536     <span class="keywordflow">if</span> (Config-&gt;<a class="code" href="structUpgradeParams.html#a0eb16aa91a2719879213114fde475e9f">image</a> == 0) {
<a name="l00537"></a>00537         <span class="keywordflow">if</span>(!Config-&gt;<a class="code" href="structUpgradeParams.html#a8e701080ed1d3de4bcf61c4f881e0ca7">verifyonly</a>)
<a name="l00538"></a>00538           printf(<span class="stringliteral">&quot;Overwriting Standard image of the firmware with %s\n&quot;</span>, Config-&gt;<a class="code" href="structUpgradeParams.html#ab029ec441d57f71ed526ad610db0f85d">ConfFile</a>);
<a name="l00539"></a>00539         <span class="keywordflow">else</span>
<a name="l00540"></a>00540             printf(<span class="stringliteral">&quot;Verifying Standard image of the firmware with %s\n&quot;</span>, Config-&gt;<a class="code" href="structUpgradeParams.html#ab029ec441d57f71ed526ad610db0f85d">ConfFile</a>);
<a name="l00541"></a>00541         pa = Config-&gt;<a class="code" href="structUpgradeParams.html#a69efa0f376669bfe96e47727025f2c89">FirstPageStd</a>;
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543     <span class="keywordflow">else</span> {
<a name="l00544"></a>00544         <span class="keywordflow">if</span>(!Config-&gt;<a class="code" href="structUpgradeParams.html#a8e701080ed1d3de4bcf61c4f881e0ca7">verifyonly</a>)
<a name="l00545"></a>00545             printf(<span class="stringliteral">&quot;Overwriting Backup image of the firmware with %s\n&quot;</span>, Config-&gt;<a class="code" href="structUpgradeParams.html#ab029ec441d57f71ed526ad610db0f85d">ConfFile</a>);
<a name="l00546"></a>00546         <span class="keywordflow">else</span>
<a name="l00547"></a>00547             printf(<span class="stringliteral">&quot;Verifying Backup image of the firmware with %s\n&quot;</span>, Config-&gt;<a class="code" href="structUpgradeParams.html#ab029ec441d57f71ed526ad610db0f85d">ConfFile</a>);
<a name="l00548"></a>00548         pa = Config-&gt;<a class="code" href="structUpgradeParams.html#a3ea68d12fa47009f08a7c03303a488a8">FirstPageBck</a>;
<a name="l00549"></a>00549     }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     printf(<span class="stringliteral">&quot;0%% Done\n&quot;</span>);
<a name="l00552"></a>00552     done = 10;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="comment">// ************************************************</span>
<a name="l00555"></a>00555     <span class="comment">// Start for loop</span>
<a name="l00556"></a>00556     <span class="comment">// ************************************************</span>
<a name="l00557"></a>00557     <span class="keywordflow">for</span>(page=0; page &lt; NumPages; page++)  {
<a name="l00558"></a>00558         <span class="keywordflow">if</span>(!Config-&gt;<a class="code" href="structUpgradeParams.html#a8e701080ed1d3de4bcf61c4f881e0ca7">verifyonly</a>) {
<a name="l00559"></a>00559             <span class="comment">// Write Page</span>
<a name="l00560"></a>00560             <span class="keywordflow">if</span> (<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a03253e79576c92f76029ccbe1b8c3f8c">WriteFlashPage</a>(Flash, CFdata + page*Flash-&gt;<a class="code" href="structFlashAccess.html#aa44c50badfa9330565180db7196d5051">PageSize</a>, pa + page) &lt; 0) {
<a name="l00561"></a>00561                 printf(<span class="stringliteral">&quot;\nCommunication Error: the board at Base Address %08X does not respond\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (Config-&gt;<a class="code" href="structUpgradeParams.html#a42e8c35c64e68590b9cca03ff1e042cb">BaseAddress</a>));
<a name="l00562"></a>00562                 err = 1;
<a name="l00563"></a>00563                 <span class="keywordflow">break</span>;
<a name="l00564"></a>00564                 }
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567         <span class="keywordflow">if</span>(!Config-&gt;<a class="code" href="structUpgradeParams.html#a51f6fd1ce1638853041f8f301f03c195">noverify</a>) {
<a name="l00568"></a>00568             <span class="comment">// Read Page</span>
<a name="l00569"></a>00569             <span class="keywordflow">if</span> (<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a63d7546c607af7f80e8787b9ce1d4f11">ReadFlashPage</a>(Flash, pdr, pa + page) &lt; 0) {
<a name="l00570"></a>00570                 printf(<span class="stringliteral">&quot;\nCommunication Error: the board at Base Address %08X does not respond\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (Config-&gt;<a class="code" href="structUpgradeParams.html#a42e8c35c64e68590b9cca03ff1e042cb">BaseAddress</a>));
<a name="l00571"></a>00571                 err = 1;
<a name="l00572"></a>00572                 <span class="keywordflow">break</span>;
<a name="l00573"></a>00573             }
<a name="l00574"></a>00574             <span class="comment">// Verify Page</span>
<a name="l00575"></a>00575             <span class="keywordflow">for</span>(i=0; (i&lt;Flash-&gt;<a class="code" href="structFlashAccess.html#aa44c50badfa9330565180db7196d5051">PageSize</a>) &amp;&amp; ((page*Flash-&gt;<a class="code" href="structFlashAccess.html#aa44c50badfa9330565180db7196d5051">PageSize</a>+i) &lt; CFsize); i++)  {
<a name="l00576"></a>00576                 <span class="keywordflow">if</span>(pdr[i] != CFdata[page*Flash-&gt;<a class="code" href="structFlashAccess.html#aa44c50badfa9330565180db7196d5051">PageSize</a> + i])  {
<a name="l00577"></a>00577                     printf(<span class="stringliteral">&quot;\nFlash verify error (byte %d of page %d)!\n&quot;</span>, i, pa + page);
<a name="l00578"></a>00578                     <span class="keywordflow">if</span> ((Config-&gt;<a class="code" href="structUpgradeParams.html#a0eb16aa91a2719879213114fde475e9f">image</a> == 0) &amp;&amp; !Config-&gt;<a class="code" href="structUpgradeParams.html#a8e701080ed1d3de4bcf61c4f881e0ca7">verifyonly</a>)
<a name="l00579"></a>00579                         printf(<span class="stringliteral">&quot;The STD image can be corrupted! \nMove the jumper to Backup image and cycle the power\n&quot;</span>);
<a name="l00580"></a>00580                     err = 1;
<a name="l00581"></a>00581                     <span class="keywordflow">break</span>;
<a name="l00582"></a>00582                 }
<a name="l00583"></a>00583             }
<a name="l00584"></a>00584         }
<a name="l00585"></a>00585         <span class="keywordflow">if</span> (err)
<a name="l00586"></a>00586             <span class="keywordflow">break</span>;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="keywordflow">if</span> (page == (NumPages-1)) {
<a name="l00589"></a>00589             printf(<span class="stringliteral">&quot;100%% Done\n&quot;</span>);
<a name="l00590"></a>00590         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( page &gt;= (NumPages*done/100) ) {
<a name="l00591"></a>00591             printf(<span class="stringliteral">&quot;%d%% Done\n&quot;</span>, done);
<a name="l00592"></a>00592             done += 10;
<a name="l00593"></a>00593         }
<a name="l00594"></a>00594     }  <span class="comment">// end of for loop</span>
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <span class="keywordflow">if</span>(!err) {
<a name="l00597"></a>00597         <span class="keywordflow">if</span> (Config-&gt;<a class="code" href="structUpgradeParams.html#a8e701080ed1d3de4bcf61c4f881e0ca7">verifyonly</a>) {
<a name="l00598"></a>00598             printf(<span class="stringliteral">&quot;\nFirmware verified successfully. Read %d bytes\n&quot;</span>, CFsize);
<a name="l00599"></a>00599         } <span class="keywordflow">else</span> {
<a name="l00600"></a>00600             printf(<span class="stringliteral">&quot;\nFirmware updated successfully. Written %d bytes\n&quot;</span>, CFsize);
<a name="l00601"></a>00601             printf(<span class="stringliteral">&quot;The new firmware will be loaded after a power cycle\n&quot;</span>);
<a name="l00602"></a>00602         }
<a name="l00603"></a>00603     }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="keywordflow">if</span> (CFdata != NULL) 
<a name="l00606"></a>00606         free(CFdata);
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         <span class="keywordflow">if</span>( !err) {
<a name="l00609"></a>00609                 err= <a class="code" href="cvupgrade_8c.html#a8ec6be8108a0d3ec304985b3531b5f95">WriteKey</a>( Config, Flash);
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611     <a class="code" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac" title="Close the device.">CAENComm_CloseDevice</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00612"></a>00612         Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>= <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a70512b9cb16089fefff47963506106bc">CAENCOM_INVALID_FILE_HANDLE</a>;
<a name="l00613"></a>00613     <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#ada7d9a75c4d9f54fc9aa680c8cf1044a">Wait_ms</a>(1000);
<a name="l00614"></a>00614  
<a name="l00615"></a>00615     <span class="keywordflow">return</span> err;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ada4976fd40aad52b34f8010ca33de5db"></a><!-- doxytag: member="cvupgrade.c::EraseLicense" ref="ada4976fd40aad52b34f8010ca33de5db" args="(cvFlashAccess *Flash)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int EraseLicense </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structFlashAccess.html">cvFlashAccess</a> *&nbsp;</td>
          <td class="paramname"> <em>Flash</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00187">187</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00041">AT45_PAGE_SIZE</a>, <a class="el" href="lrs1821_8c_source.html#l00038">data</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00033">LICENSE_FLASH_PAGE</a>, and <a class="el" href="CAENBridgeUpgrade_2src_2flash_8c_source.html#l00186">WriteFlashPage()</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00334">License()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00188"></a>00188 {
<a name="l00189"></a>00189   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>[<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#acf19e18da898d8fa43a44e6793b12f48a26d2b4386d457d2cc9ec4e202f62dc24">AT45_PAGE_SIZE</a>];
<a name="l00190"></a>00190 
<a name="l00191"></a>00191   memset( data, 0xff, <span class="keyword">sizeof</span>( data));
<a name="l00192"></a>00192   <span class="keywordflow">return</span> <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a03253e79576c92f76029ccbe1b8c3f8c">WriteFlashPage</a>(Flash, data, <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a07ef922a0ca6b086bfd692563cd0c253">LICENSE_FLASH_PAGE</a>);
<a name="l00193"></a>00193 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9b8aeb6281400048a5e077a4cac434bc"></a><!-- doxytag: member="cvupgrade.c::GetFWRel" ref="a9b8aeb6281400048a5e077a4cac434bc" args="(cvUpgradeParams *Config, cvFlashAccess *Flash)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int GetFWRel </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *&nbsp;</td>
          <td class="paramname"> <em>Config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structFlashAccess.html">cvFlashAccess</a> *&nbsp;</td>
          <td class="paramname"> <em>Flash</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00267">267</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="cvupgrade_8c_source.html#l00105">UpgradeParams::AMCFwm</a>, <a class="el" href="cvupgrade_8c_source.html#l00090">UpgradeParams::BaseAddress</a>, <a class="el" href="cvupgrade_8c_source.html#l00089">UpgradeParams::BdNum</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00026">CAENCOM_INVALID_FILE_HANDLE</a>, <a class="el" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac">CAENComm_CloseDevice()</a>, <a class="el" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice()</a>, <a class="el" href="CAENComm_8h.html#a0f912e235df9c015a0902382ab29ae93">CAENComm_Read16()</a>, <a class="el" href="CAENComm_8h.html#a7b8b1f753271d81c48ed433ad14d883b">CAENComm_Read32()</a>, <a class="el" href="CAENComm_8h_source.html#l00084">CAENComm_Success</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00081">CvUpgrade_FileAccessError</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00067">FlashAccess::Handle</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="cvupgrade_8c_source.html#l00088">UpgradeParams::Link</a>, <a class="el" href="cvupgrade_8c_source.html#l00100">UpgradeParams::Models</a>, <a class="el" href="cvupgrade_8c_source.html#l00104">UpgradeParams::ROCFwm</a>, and <a class="el" href="cvupgrade_8c_source.html#l00087">UpgradeParams::Type</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00623">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00267"></a>00267                                                                    {
<a name="l00268"></a>00268         <span class="comment">/* initialize the connection */</span>
<a name="l00269"></a>00269         <span class="keywordtype">int</span> ret,d32,<a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00270"></a>00270         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> x,y;
<a name="l00271"></a>00271         <span class="keywordtype">int</span> chNum = 2;
<a name="l00272"></a>00272         uint16_t BuildHexCode,d16;
<a name="l00273"></a>00273         <span class="keywordflow">if</span>( <a class="code" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice</a>(Config-&gt;<a class="code" href="structUpgradeParams.html#a748375db853b611f044d6be639acc2c6">Type</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#a2a720635715958998b24686be6734536">Link</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#aa3db4e8cff315090fe436657acd278dc">BdNum</a>,  Config-&gt;<a class="code" href="structUpgradeParams.html#a42e8c35c64e68590b9cca03ff1e042cb">BaseAddress</a>, &amp;Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>)!= <a class="code" href="CAENComm_8h.html#a957016b0c3a404d6ab61ea3edf310ad4ad3c23b64a7fcf3b2fb35960981352587">CAENComm_Success</a>){
<a name="l00274"></a>00274         printf(<span class="stringliteral">&quot;Cannot open the Device!\n&quot;</span>);
<a name="l00275"></a>00275         <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00276"></a>00276     }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="keywordflow">if</span> (strcmp(Config-&gt;<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>,<span class="stringliteral">&quot;DIGITIZERS&quot;</span>) == 0) { 
<a name="l00279"></a>00279                 <span class="comment">// DIGITIZERS</span>
<a name="l00280"></a>00280                 <span class="keywordflow">if</span> ((ret = <a class="code" href="CAENComm_8h.html#a7b8b1f753271d81c48ed433ad14d883b" title="Read a 32 bit data from the specified register.">CAENComm_Read32</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>,Config-&gt;<a class="code" href="structUpgradeParams.html#aa530f38e51ff317a04ec97691e54255b">ROCFwm</a>, &amp;d32)) != <a class="code" href="CAENComm_8h.html#a957016b0c3a404d6ab61ea3edf310ad4ad3c23b64a7fcf3b2fb35960981352587">CAENComm_Success</a>) {
<a name="l00281"></a>00281                         printf(<span class="stringliteral">&quot;unable to find ROC FPGA  release\n&quot;</span>);
<a name="l00282"></a>00282                         <span class="keywordflow">return</span> -1;
<a name="l00283"></a>00283                 }
<a name="l00284"></a>00284                 y = (uint8_t) (d32 &amp; 0xff);
<a name="l00285"></a>00285                 x = (uint8_t) ((d32 &amp; 0xff00)&gt;&gt; 8);
<a name="l00286"></a>00286                 BuildHexCode = (uint16_t) ((d32 &amp; 0xffff0000)&gt;&gt; 16);
<a name="l00287"></a>00287                 printf(<span class="stringliteral">&quot;ROC FPGA Release is %02d.%02d - Build %04X\n&quot;</span>,x,y, BuildHexCode);
<a name="l00288"></a>00288 
<a name="l00289"></a>00289                 <span class="keywordflow">for</span> (i = 0; i&lt; chNum; i++) {
<a name="l00290"></a>00290                         <span class="keywordflow">if</span> ((ret = <a class="code" href="CAENComm_8h.html#a7b8b1f753271d81c48ed433ad14d883b" title="Read a 32 bit data from the specified register.">CAENComm_Read32</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#acc3ca0e85469e9eca8487e45972199ad">AMCFwm</a> | (i&lt;&lt;8), &amp;d32)) == <a class="code" href="CAENComm_8h.html#a957016b0c3a404d6ab61ea3edf310ad4ad3c23b64a7fcf3b2fb35960981352587">CAENComm_Success</a>) {
<a name="l00291"></a>00291                                 <span class="keywordflow">if</span> ( (uint16_t)((d32 &amp; 0xffff0000)&gt;&gt; 16) != 0x0000 ) <span class="keywordflow">break</span>; <span class="comment">// HACK this is for x780 support! AMC Build must be != 0000</span>
<a name="l00292"></a>00292                         }
<a name="l00293"></a>00293                 }
<a name="l00294"></a>00294                 <span class="keywordflow">if</span> (i == (int32_t)chNum) {
<a name="l00295"></a>00295                         printf(<span class="stringliteral">&quot;unable to find AMC FPGA release\n&quot;</span>);
<a name="l00296"></a>00296                         <span class="keywordflow">return</span> -1;
<a name="l00297"></a>00297                 }
<a name="l00298"></a>00298                 y = (uint8_t) (d32 &amp; 0xff);
<a name="l00299"></a>00299                 x = (uint8_t) ((d32 &amp; 0xff00)&gt;&gt; 8);
<a name="l00300"></a>00300                 BuildHexCode = (uint16_t) ((d32 &amp; 0xffff0000)&gt;&gt; 16);
<a name="l00301"></a>00301                 printf(<span class="stringliteral">&quot;AMC FPGA Release is %02d.%02d - Build %04X&quot;</span>,x,y, BuildHexCode);
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303         <span class="keywordflow">else</span> {
<a name="l00304"></a>00304                 <span class="keywordflow">if</span> (strcmp(Config-&gt;<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>,<span class="stringliteral">&quot;V1190,V1290&quot;</span>) == 0) {
<a name="l00305"></a>00305                         <span class="keywordflow">if</span> ((ret = <a class="code" href="CAENComm_8h.html#a0f912e235df9c015a0902382ab29ae93" title="Read a 16 bit data from the specified register.">CAENComm_Read16</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>,Config-&gt;<a class="code" href="structUpgradeParams.html#aa530f38e51ff317a04ec97691e54255b">ROCFwm</a>, &amp;d16)) != <a class="code" href="CAENComm_8h.html#a957016b0c3a404d6ab61ea3edf310ad4ad3c23b64a7fcf3b2fb35960981352587">CAENComm_Success</a>) {
<a name="l00306"></a>00306                                 printf(<span class="stringliteral">&quot;unable to find firmware release\n&quot;</span>);
<a name="l00307"></a>00307                                 <span class="keywordflow">return</span> -1;
<a name="l00308"></a>00308                         }
<a name="l00309"></a>00309                         y = (uint8_t) (d16 &amp; 0xff);
<a name="l00310"></a>00310                         x = (uint8_t) ((d16 &amp; 0xff00)&gt;&gt; 8);
<a name="l00311"></a>00311                         printf(<span class="stringliteral">&quot;Firmware Release is %02d.%02d\n&quot;</span>,x,y);
<a name="l00312"></a>00312                 }
<a name="l00313"></a>00313                 <span class="keywordflow">else</span> {
<a name="l00314"></a>00314                         <span class="keywordflow">if</span> ((ret = <a class="code" href="CAENComm_8h.html#a7b8b1f753271d81c48ed433ad14d883b" title="Read a 32 bit data from the specified register.">CAENComm_Read32</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>,Config-&gt;<a class="code" href="structUpgradeParams.html#aa530f38e51ff317a04ec97691e54255b">ROCFwm</a>, &amp;d32)) != <a class="code" href="CAENComm_8h.html#a957016b0c3a404d6ab61ea3edf310ad4ad3c23b64a7fcf3b2fb35960981352587">CAENComm_Success</a>) {
<a name="l00315"></a>00315                                 printf(<span class="stringliteral">&quot;unable to find firmware release\n&quot;</span>);
<a name="l00316"></a>00316                                 <span class="keywordflow">return</span> -1;
<a name="l00317"></a>00317                         }
<a name="l00318"></a>00318                         y = (uint8_t) (d32 &amp; 0xff);
<a name="l00319"></a>00319                         x = (uint8_t) ((d32 &amp; 0xff00)&gt;&gt; 8);
<a name="l00320"></a>00320                         printf(<span class="stringliteral">&quot;Firmware Release is  %02d.%02d\n&quot;</span>,x,y);
<a name="l00321"></a>00321                 }
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323         <a class="code" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac" title="Close the device.">CAENComm_CloseDevice</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00324"></a>00324         Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>= <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a70512b9cb16089fefff47963506106bc">CAENCOM_INVALID_FILE_HANDLE</a>;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00327"></a>00327         printf(<span class="stringliteral">&quot;Program exits successfully.\n&quot;</span>);
<a name="l00328"></a>00328         <span class="keywordflow">return</span> 0;
<a name="l00329"></a>00329 }       
</pre></div></p>

</div>
</div>
<a class="anchor" id="a76a02ca4195151597e19a0a994fc5be1"></a><!-- doxytag: member="cvupgrade.c::KeyInfo" ref="a76a02ca4195151597e19a0a994fc5be1" args="(cvUpgradeParams *Config, cvFlashAccess *Flash)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int KeyInfo </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *&nbsp;</td>
          <td class="paramname"> <em>Config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structFlashAccess.html">cvFlashAccess</a> *&nbsp;</td>
          <td class="paramname"> <em>Flash</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00215">215</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00042">AT45_IDREG_LENGTH</a>, <a class="el" href="cvupgrade_8c_source.html#l00090">UpgradeParams::BaseAddress</a>, <a class="el" href="cvupgrade_8c_source.html#l00089">UpgradeParams::BdNum</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00026">CAENCOM_INVALID_FILE_HANDLE</a>, <a class="el" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac">CAENComm_CloseDevice()</a>, <a class="el" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice()</a>, <a class="el" href="CAENComm_8h_source.html#l00084">CAENComm_Success</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00060">CROM_MAP::crom_serial</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00081">CvUpgrade_FileAccessError</a>, <a class="el" href="cvupgrade_8c_source.html#l00103">UpgradeParams::filepath</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00067">FlashAccess::Handle</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="cvupgrade_8c_source.html#l00088">UpgradeParams::Link</a>, <a class="el" href="cvupgrade_8c_source.html#l00101">UpgradeParams::modelName</a>, <a class="el" href="cvupgrade_8c_source.html#l00198">PrintCROM2File()</a>, <a class="el" href="cvupgrade_8c_source.html#l00144">ReadConfigurationROM()</a>, <a class="el" href="CAENBridgeUpgrade_2src_2flash_8c_source.html#l00217">ReadFlashSecurityReg()</a>, and <a class="el" href="cvupgrade_8c_source.html#l00087">UpgradeParams::Type</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00623">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00215"></a>00215                                                                   {
<a name="l00216"></a>00216         <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00217"></a>00217         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> security_vme[<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#acf19e18da898d8fa43a44e6793b12f48a8f67f27a0c4f144bc4835356e655e8b4">AT45_IDREG_LENGTH</a>];
<a name="l00218"></a>00218         <span class="comment">// unsigned long vboard_base_address;</span>
<a name="l00219"></a>00219         <span class="keywordtype">char</span> KeyFilename[200];
<a name="l00220"></a>00220         FILE *cf = NULL;
<a name="l00221"></a>00221         <span class="keywordtype">int</span> res;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         <a class="code" href="structCROM__MAP.html">CROM_MAP</a> rom;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     <span class="comment">/* initialize the connection */</span>
<a name="l00226"></a>00226     res = <a class="code" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice</a>(Config-&gt;<a class="code" href="structUpgradeParams.html#a748375db853b611f044d6be639acc2c6">Type</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#a2a720635715958998b24686be6734536">Link</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#aa3db4e8cff315090fe436657acd278dc">BdNum</a>,  Config-&gt;<a class="code" href="structUpgradeParams.html#a42e8c35c64e68590b9cca03ff1e042cb">BaseAddress</a>, &amp;Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (res != <a class="code" href="CAENComm_8h.html#a957016b0c3a404d6ab61ea3edf310ad4ad3c23b64a7fcf3b2fb35960981352587">CAENComm_Success</a>) {
<a name="l00228"></a>00228         printf(<span class="stringliteral">&quot;Cannot open the Device!\n&quot;</span>);
<a name="l00229"></a>00229         <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231    
<a name="l00232"></a>00232         <span class="keywordflow">if</span> (<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a489e44691a1217af64884e58bf80a5e8">ReadFlashSecurityReg</a>(Flash, security_vme)) {
<a name="l00233"></a>00233       printf(<span class="stringliteral">&quot;Error while reading on-board flash memory!\n&quot;</span>);
<a name="l00234"></a>00234           <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00235"></a>00235         }
<a name="l00236"></a>00236         <span class="keywordflow">if</span> (<a class="code" href="cvupgrade_8c.html#a3889b2b6bdef9d4f2f1a76c8c323defa">ReadConfigurationROM</a>(Flash, &amp;rom)) {
<a name="l00237"></a>00237       printf(<span class="stringliteral">&quot;Error while reading on-board flash memory!\n&quot;</span>);
<a name="l00238"></a>00238           <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00239"></a>00239         }
<a name="l00240"></a>00240         <span class="keywordflow">if</span>( strlen( Config-&gt;<a class="code" href="structUpgradeParams.html#a6dbead67f52bb633d5c75b878ac6cbae">modelName</a>)) {
<a name="l00241"></a>00241                 sprintf(KeyFilename, <span class="stringliteral">&quot;%s/BoardInfo-%s-%d.dat&quot;</span>, Config-&gt;<a class="code" href="structUpgradeParams.html#a218860c6cd4230ea668493ae8f76fa91">filepath</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#a6dbead67f52bb633d5c75b878ac6cbae">modelName</a>, rom.<a class="code" href="structCROM__MAP.html#ad5c0c4ac342dc85e94bd7f2876346692">crom_serial</a>);
<a name="l00242"></a>00242         } <span class="keywordflow">else</span> {
<a name="l00243"></a>00243                 sprintf(KeyFilename, <span class="stringliteral">&quot;%s/BoardInfo-%d.dat&quot;</span>, Config-&gt;<a class="code" href="structUpgradeParams.html#a218860c6cd4230ea668493ae8f76fa91">filepath</a>, rom.<a class="code" href="structCROM__MAP.html#ad5c0c4ac342dc85e94bd7f2876346692">crom_serial</a>);
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245     cf = fopen(KeyFilename,<span class="stringliteral">&quot;w&quot;</span>);
<a name="l00246"></a>00246         <span class="keywordflow">if</span>(cf == 0) {
<a name="l00247"></a>00247       printf(<span class="stringliteral">&quot;Cannot open %s file! Exiting ...\n&quot;</span>, KeyFilename);
<a name="l00248"></a>00248       <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     printf(<span class="stringliteral">&quot;Writing output file %s\n&quot;</span>, KeyFilename);
<a name="l00252"></a>00252         <span class="keywordflow">for</span>(i=0; i &lt; 64; i++) {
<a name="l00253"></a>00253           fprintf(cf, <span class="stringliteral">&quot;%02X&quot;</span>, security_vme[64+i]);
<a name="l00254"></a>00254           fprintf(cf, (i &lt; 63) ? <span class="stringliteral">&quot;:&quot;</span> : <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256         <a class="code" href="cvupgrade_8c.html#aca02ef2acaccca7fb14ce091ce7eee04">PrintCROM2File</a>(cf, &amp;rom);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <a class="code" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac" title="Close the device.">CAENComm_CloseDevice</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00259"></a>00259         Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>= <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a70512b9cb16089fefff47963506106bc">CAENCOM_INVALID_FILE_HANDLE</a>;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00262"></a>00262         printf(<span class="stringliteral">&quot;Program exits successfully.\n&quot;</span>);
<a name="l00263"></a>00263     fclose(cf);
<a name="l00264"></a>00264         <span class="keywordflow">return</span> 0;
<a name="l00265"></a>00265 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6cce5469e2c46cc06d94a42bf5d058f4"></a><!-- doxytag: member="cvupgrade.c::License" ref="a6cce5469e2c46cc06d94a42bf5d058f4" args="(cvUpgradeParams *Config, cvFlashAccess *Flash)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int License </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *&nbsp;</td>
          <td class="paramname"> <em>Config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structFlashAccess.html">cvFlashAccess</a> *&nbsp;</td>
          <td class="paramname"> <em>Flash</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00334">334</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="cvupgrade_8c_source.html#l00090">UpgradeParams::BaseAddress</a>, <a class="el" href="cvupgrade_8c_source.html#l00089">UpgradeParams::BdNum</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00026">CAENCOM_INVALID_FILE_HANDLE</a>, <a class="el" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac">CAENComm_CloseDevice()</a>, <a class="el" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice()</a>, <a class="el" href="CAENComm_8h_source.html#l00084">CAENComm_Success</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00081">CvUpgrade_FileAccessError</a>, <a class="el" href="cvupgrade_8c_source.html#l00097">UpgradeParams::delete</a>, <a class="el" href="cvupgrade_8c_source.html#l00187">EraseLicense()</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00067">FlashAccess::Handle</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00035">LICENSE_DATA_SIZE</a>, <a class="el" href="cvupgrade_8c_source.html#l00088">UpgradeParams::Link</a>, <a class="el" href="cvupgrade_8c_source.html#l00171">ReadLicense()</a>, and <a class="el" href="cvupgrade_8c_source.html#l00087">UpgradeParams::Type</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00623">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00334"></a>00334                                                                   {
<a name="l00335"></a>00335 
<a name="l00336"></a>00336         <span class="comment">/* initialize the connection */</span>
<a name="l00337"></a>00337         <span class="keywordflow">if</span>( <a class="code" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice</a>(Config-&gt;<a class="code" href="structUpgradeParams.html#a748375db853b611f044d6be639acc2c6">Type</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#a2a720635715958998b24686be6734536">Link</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#aa3db4e8cff315090fe436657acd278dc">BdNum</a>,  Config-&gt;<a class="code" href="structUpgradeParams.html#a42e8c35c64e68590b9cca03ff1e042cb">BaseAddress</a>, &amp;Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>)!= <a class="code" href="CAENComm_8h.html#a957016b0c3a404d6ab61ea3edf310ad4ad3c23b64a7fcf3b2fb35960981352587">CAENComm_Success</a>){
<a name="l00338"></a>00338         printf(<span class="stringliteral">&quot;Cannot open the Device!\n&quot;</span>);
<a name="l00339"></a>00339         <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <span class="keywordflow">if</span>( Config-&gt;<a class="code" href="structUpgradeParams.html#a3a5e5519a0a73bf780a0c95879b299b1">delete</a>) {
<a name="l00343"></a>00343                 <span class="comment">// delete the license data</span>
<a name="l00344"></a>00344                 <span class="keywordflow">if</span>( <a class="code" href="cvupgrade_8c.html#ada4976fd40aad52b34f8010ca33de5db">EraseLicense</a>( Flash)) {
<a name="l00345"></a>00345                         printf(<span class="stringliteral">&quot;Error deleting license data! Exiting ...\n&quot;</span>);
<a name="l00346"></a>00346                         <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00347"></a>00347                 }
<a name="l00348"></a>00348         } <span class="keywordflow">else</span> {
<a name="l00349"></a>00349                 uint8_t licenseData[<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#abc448525b742d25f40b8d7823222bc50">LICENSE_DATA_SIZE</a>];
<a name="l00350"></a>00350                 <span class="keywordflow">if</span>( <a class="code" href="cvupgrade_8c.html#a42fb85b07498ef78b4b0e1005612c653">ReadLicense</a>( Flash, licenseData)) {
<a name="l00351"></a>00351                         printf(<span class="stringliteral">&quot;Error reading license data! Exiting ...\n&quot;</span>);
<a name="l00352"></a>00352                         <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00353"></a>00353                 }
<a name="l00354"></a>00354                 <span class="comment">// print the license data</span>
<a name="l00355"></a>00355                 <span class="comment">// check if a valid license</span>
<a name="l00356"></a>00356                 printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00357"></a>00357                 <span class="keywordflow">if</span>( ( licenseData[0]!= 0x00) || ( licenseData[1]!= 0x04)) {
<a name="l00358"></a>00358                         printf(<span class="stringliteral">&quot;No valid license found!&quot;</span>);
<a name="l00359"></a>00359                 } <span class="keywordflow">else</span> {
<a name="l00360"></a>00360                         <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00361"></a>00361                         <span class="keywordflow">for</span>( i= 0; i&lt; <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#abc448525b742d25f40b8d7823222bc50">LICENSE_DATA_SIZE</a>; i++) {
<a name="l00362"></a>00362                                 printf( <span class="stringliteral">&quot;%02X &quot;</span>, licenseData[i]);
<a name="l00363"></a>00363                         }
<a name="l00364"></a>00364                 }
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366         <a class="code" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac" title="Close the device.">CAENComm_CloseDevice</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00367"></a>00367         Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>= <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a70512b9cb16089fefff47963506106bc">CAENCOM_INVALID_FILE_HANDLE</a>;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00370"></a>00370         printf(<span class="stringliteral">&quot;Program exits successfully.\n&quot;</span>);
<a name="l00371"></a>00371         <span class="keywordflow">return</span> 0;
<a name="l00372"></a>00372 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0ddf1224851353fc92bfbff6f499fa97"></a><!-- doxytag: member="cvupgrade.c::main" ref="a0ddf1224851353fc92bfbff6f499fa97" args="(int argc, char *argv[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>argv</em>[]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00623">623</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="cvupgrade_8c_source.html#l00105">UpgradeParams::AMCFwm</a>, <a class="el" href="cvupgrade_8c_source.html#l00090">UpgradeParams::BaseAddress</a>, <a class="el" href="cvupgrade_8c_source.html#l00089">UpgradeParams::BdNum</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00026">CAENCOM_INVALID_FILE_HANDLE</a>, <a class="el" href="CAENComm_8h_source.html#l00077">CAENComm_PCI_OpticalLink</a>, <a class="el" href="CAENComm_8h_source.html#l00076">CAENComm_USB</a>, <a class="el" href="cvupgrade_8c_source.html#l00098">UpgradeParams::cfa</a>, <a class="el" href="cvupgrade_8c_source.html#l00099">UpgradeParams::ConfFile</a>, <a class="el" href="cvupgrade_8c_source.html#l00466">cvUpgrade()</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00078">CvUpgrade_GenericError</a>, <a class="el" href="cvupgrade_8c_source.html#l00097">UpgradeParams::delete</a>, <a class="el" href="cvupgrade_8c_source.html#l00102">UpgradeParams::family</a>, <a class="el" href="cvupgrade_8c_source.html#l00103">UpgradeParams::filepath</a>, <a class="el" href="cvupgrade_8c_source.html#l00092">UpgradeParams::FirstPageBck</a>, <a class="el" href="cvupgrade_8c_source.html#l00091">UpgradeParams::FirstPageStd</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00070">FlashAccess::FlashEnable</a>, <a class="el" href="cvupgrade_8c_source.html#l00267">GetFWRel()</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00067">FlashAccess::Handle</a>, <a class="el" href="cvupgrade_8c_source.html#l00094">UpgradeParams::image</a>, <a class="el" href="cvupgrade_8c_source.html#l00093">UpgradeParams::key</a>, <a class="el" href="mdump_8c_source.html#l00116">key</a>, <a class="el" href="cvupgrade_8c_source.html#l00215">KeyInfo()</a>, <a class="el" href="cvupgrade_8c_source.html#l00334">License()</a>, <a class="el" href="cvupgrade_8c_source.html#l00088">UpgradeParams::Link</a>, <a class="el" href="cvupgrade_8c_source.html#l00101">UpgradeParams::modelName</a>, <a class="el" href="cvupgrade_8c_source.html#l00100">UpgradeParams::Models</a>, <a class="el" href="cvupgrade_8c_source.html#l00095">UpgradeParams::noverify</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00072">FlashAccess::PageSize</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00071">FlashAccess::RegSize</a>, <a class="el" href="cvupgrade_8c_source.html#l00075">REVISION</a>, <a class="el" href="cvupgrade_8c_source.html#l00104">UpgradeParams::ROCFwm</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00068">FlashAccess::RW_Flash</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00069">FlashAccess::Sel_Flash</a>, <a class="el" href="mhist_8c_source.html#l00078">tmp()</a>, <a class="el" href="cvupgrade_8c_source.html#l00087">UpgradeParams::Type</a>, <a class="el" href="generate-MODULES_8h_source.html#l00006">Usage</a>, <a class="el" href="cvupgrade_8c_source.html#l00096">UpgradeParams::verifyonly</a>, and <a class="el" href="cvupgrade_8c_source.html#l00377">WriteKey()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00624"></a>00624 {
<a name="l00625"></a>00625     <span class="keywordtype">int</span> err=0;
<a name="l00626"></a>00626         <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a> = 0;
<a name="l00627"></a>00627         <span class="keywordtype">int</span> license = 0;
<a name="l00628"></a>00628         <span class="keywordtype">int</span> fwrel = 0;
<a name="l00629"></a>00629         <span class="keywordtype">int</span> writeKey= 0;
<a name="l00630"></a>00630     <a class="code" href="structUpgradeParams.html">cvUpgradeParams</a> Params;
<a name="l00631"></a>00631     <a class="code" href="structFlashAccess.html">cvFlashAccess</a>   FlashInfo;
<a name="l00632"></a>00632     <span class="keywordtype">char</span> ParamFile[1000] = <span class="stringliteral">&quot;cvUpgrade_params.txt&quot;</span>;
<a name="l00633"></a>00633         <span class="keywordtype">int</span> argIndex= 1;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     FILE *bdf;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00638"></a>00638     printf(<span class="stringliteral">&quot;********************************************************\n&quot;</span>);
<a name="l00639"></a>00639     printf(<span class="stringliteral">&quot; CAEN SpA - Front-End Division                          \n&quot;</span>);
<a name="l00640"></a>00640     printf(<span class="stringliteral">&quot;--------------------------------------------------------\n&quot;</span>);
<a name="l00641"></a>00641     printf(<span class="stringliteral">&quot; CAEN Board Firmware Upgrade                              \n&quot;</span>);
<a name="l00642"></a>00642     printf(<span class="stringliteral">&quot; Version %s                                             \n&quot;</span>, <a class="code" href="cvupgrade_8c.html#ad526597ab378f3faff87123d7742c79a">REVISION</a>);
<a name="l00643"></a>00643     printf(<span class="stringliteral">&quot;********************************************************\n\n&quot;</span>);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="comment">// Check command arguments (must be at least 2)</span>
<a name="l00646"></a>00646     <span class="keywordflow">if</span> (argc &lt; 3)  {
<a name="l00647"></a>00647         <a class="code" href="generate-MODULES_8h.html#a3605307780f1adef4b64af88704d0861">Usage</a>();
<a name="l00648"></a>00648         <span class="keywordflow">return</span>(-1);
<a name="l00649"></a>00649     }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651     <span class="comment">// Inizialize defaults </span>
<a name="l00652"></a>00652         FlashInfo.<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>= <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a70512b9cb16089fefff47963506106bc">CAENCOM_INVALID_FILE_HANDLE</a>;
<a name="l00653"></a>00653     FlashInfo.<a class="code" href="structFlashAccess.html#af87ac9a7d103e06c7c0bd0faaa26708b">FlashEnable</a> = 0;
<a name="l00654"></a>00654     Params.<a class="code" href="structUpgradeParams.html#a2a720635715958998b24686be6734536">Link</a> = 0;
<a name="l00655"></a>00655     Params.<a class="code" href="structUpgradeParams.html#aa3db4e8cff315090fe436657acd278dc">BdNum</a> = 0;
<a name="l00656"></a>00656     Params.<a class="code" href="structUpgradeParams.html#a0eb16aa91a2719879213114fde475e9f">image</a> = 0; <span class="comment">// Default = standard</span>
<a name="l00657"></a>00657         Params.<a class="code" href="structUpgradeParams.html#a51f6fd1ce1638853041f8f301f03c195">noverify</a> = 0;
<a name="l00658"></a>00658         Params.<a class="code" href="structUpgradeParams.html#a8e701080ed1d3de4bcf61c4f881e0ca7">verifyonly</a> = 0;
<a name="l00659"></a>00659     Params.<a class="code" href="structUpgradeParams.html#a42e8c35c64e68590b9cca03ff1e042cb">BaseAddress</a> = 0;
<a name="l00660"></a>00660     Params.<a class="code" href="structUpgradeParams.html#aff8a947b934d40fe8cc44aa28676d27c">key</a> = 0;
<a name="l00661"></a>00661         *Params.<a class="code" href="structUpgradeParams.html#a6dbead67f52bb633d5c75b878ac6cbae">modelName</a>= <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00662"></a>00662         Params.<a class="code" href="structUpgradeParams.html#a3a5e5519a0a73bf780a0c95879b299b1">delete</a> = 0;
<a name="l00663"></a>00663         Params.<a class="code" href="structUpgradeParams.html#a47424e61651250061e6542f9fe54317a">cfa</a> = 1;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     strstr(Params.<a class="code" href="structUpgradeParams.html#ab029ec441d57f71ed526ad610db0f85d">ConfFile</a>, <span class="stringliteral">&quot;cvUpgrade_params.txt&quot;</span>);
<a name="l00666"></a>00666         <span class="keywordflow">if</span> (strcmp(argv[argIndex],<span class="stringliteral">&quot;-KeyInfo&quot;</span>) == 0 ) {
<a name="l00667"></a>00667                 key = 1;
<a name="l00668"></a>00668         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[argIndex],<span class="stringliteral">&quot;-License&quot;</span>) == 0 ) {
<a name="l00669"></a>00669                 license = 1;
<a name="l00670"></a>00670         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[argIndex],<span class="stringliteral">&quot;-Key&quot;</span>) == 0 ) {
<a name="l00671"></a>00671                 sscanf(argv[++argIndex], <span class="stringliteral">&quot;%llx&quot;</span>, &amp;Params.<a class="code" href="structUpgradeParams.html#aff8a947b934d40fe8cc44aa28676d27c">key</a>); 
<a name="l00672"></a>00672                 writeKey = 1;
<a name="l00673"></a>00673         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[argIndex],<span class="stringliteral">&quot;-fwrel&quot;</span>) == 0 ) {
<a name="l00674"></a>00674                 fwrel = 1;
<a name="l00675"></a>00675         } <span class="keywordflow">else</span> {
<a name="l00676"></a>00676                 sprintf(Params.<a class="code" href="structUpgradeParams.html#ab029ec441d57f71ed526ad610db0f85d">ConfFile</a>, argv[argIndex]);
<a name="l00677"></a>00677         }
<a name="l00678"></a>00678         argIndex++;
<a name="l00679"></a>00679     <span class="keywordflow">if</span> (strcmp(argv[argIndex],<span class="stringliteral">&quot;USB&quot;</span>) == 0) Params.<a class="code" href="structUpgradeParams.html#a748375db853b611f044d6be639acc2c6">Type</a> = <a class="code" href="CAENComm_8h.html#a257c53a4356b25fcc2cca654b14bc6a7aa8da0980f26db41cd246d95a03d056b9">CAENComm_USB</a>;
<a name="l00680"></a>00680         <span class="keywordflow">if</span> (strcmp(argv[argIndex],<span class="stringliteral">&quot;OPTLINK&quot;</span>) == 0) Params.<a class="code" href="structUpgradeParams.html#a748375db853b611f044d6be639acc2c6">Type</a> = <a class="code" href="CAENComm_8h.html#a257c53a4356b25fcc2cca654b14bc6a7ab820c03230fb69fa9613b198a17424a4">CAENComm_PCI_OpticalLink</a>;
<a name="l00681"></a>00681 <span class="comment">//      if (strcmp(argv[argIndex],&quot;PCIE_OPTLINK&quot;) == 0) Params.Type = CAENComm_PCIE_OpticalLink;</span>
<a name="l00682"></a>00682         argIndex++;
<a name="l00683"></a>00683     <span class="keywordflow">for</span> (; argIndex&lt;argc; argIndex++) {
<a name="l00684"></a>00684         <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-backup&quot;</span>) == 0 )
<a name="l00685"></a>00685             Params.<a class="code" href="structUpgradeParams.html#a0eb16aa91a2719879213114fde475e9f">image</a> = 1;
<a name="l00686"></a>00686         <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-no_verify&quot;</span>) == 0 )
<a name="l00687"></a>00687             Params.<a class="code" href="structUpgradeParams.html#a51f6fd1ce1638853041f8f301f03c195">noverify</a> = 1;
<a name="l00688"></a>00688         <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-verify_only&quot;</span>) == 0 )
<a name="l00689"></a>00689             Params.<a class="code" href="structUpgradeParams.html#a8e701080ed1d3de4bcf61c4f881e0ca7">verifyonly</a> = 1;        
<a name="l00690"></a>00690         <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-param&quot;</span>) == 0 )
<a name="l00691"></a>00691             sprintf(ParamFile, <span class="stringliteral">&quot;%s&quot;</span>, argv[++argIndex]);
<a name="l00692"></a>00692                 <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-rbf&quot;</span>) == 0 )
<a name="l00693"></a>00693                         Params.<a class="code" href="structUpgradeParams.html#a47424e61651250061e6542f9fe54317a">cfa</a> = 0;
<a name="l00694"></a>00694                 <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-VMEbaseaddress&quot;</span>) == 0 )
<a name="l00695"></a>00695                         sscanf(argv[++argIndex], <span class="stringliteral">&quot;%x&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) (&amp;Params.<a class="code" href="structUpgradeParams.html#a42e8c35c64e68590b9cca03ff1e042cb">BaseAddress</a>));
<a name="l00696"></a>00696                 <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-key&quot;</span>) == 0 )
<a name="l00697"></a>00697                         sscanf(argv[++argIndex], <span class="stringliteral">&quot;%llx&quot;</span>, &amp;Params.<a class="code" href="structUpgradeParams.html#aff8a947b934d40fe8cc44aa28676d27c">key</a>); 
<a name="l00698"></a>00698         <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-link&quot;</span>) == 0 )
<a name="l00699"></a>00699             Params.<a class="code" href="structUpgradeParams.html#a2a720635715958998b24686be6734536">Link</a> = atoi(argv[++argIndex]);  
<a name="l00700"></a>00700         <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-bdnum&quot;</span>) == 0 )
<a name="l00701"></a>00701             Params.<a class="code" href="structUpgradeParams.html#aa3db4e8cff315090fe436657acd278dc">BdNum</a> = atoi(argv[++argIndex]);  
<a name="l00702"></a>00702                 <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-modelname&quot;</span>) == 0 ) {
<a name="l00703"></a>00703                         strncpy( Params.<a class="code" href="structUpgradeParams.html#a6dbead67f52bb633d5c75b878ac6cbae">modelName</a>, argv[++argIndex], <span class="keyword">sizeof</span>( Params.<a class="code" href="structUpgradeParams.html#a6dbead67f52bb633d5c75b878ac6cbae">modelName</a>));
<a name="l00704"></a>00704                         Params.<a class="code" href="structUpgradeParams.html#a6dbead67f52bb633d5c75b878ac6cbae">modelName</a>[ <span class="keyword">sizeof</span>( Params.<a class="code" href="structUpgradeParams.html#a6dbead67f52bb633d5c75b878ac6cbae">modelName</a>)- 1]= <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00705"></a>00705                 }
<a name="l00706"></a>00706                 <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-modelfamily&quot;</span>) == 0 ) {
<a name="l00707"></a>00707                         strncpy( Params.<a class="code" href="structUpgradeParams.html#a027cd18d971aec4535698a0a1124f6af">family</a>, argv[++argIndex], <span class="keyword">sizeof</span>( Params.<a class="code" href="structUpgradeParams.html#a027cd18d971aec4535698a0a1124f6af">family</a>));
<a name="l00708"></a>00708                         Params.<a class="code" href="structUpgradeParams.html#a027cd18d971aec4535698a0a1124f6af">family</a>[ <span class="keyword">sizeof</span>( Params.<a class="code" href="structUpgradeParams.html#a027cd18d971aec4535698a0a1124f6af">family</a>)- 1]= <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00709"></a>00709                 }
<a name="l00710"></a>00710                 <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-filepath&quot;</span>) == 0 ) {
<a name="l00711"></a>00711                         strncpy( Params.<a class="code" href="structUpgradeParams.html#a218860c6cd4230ea668493ae8f76fa91">filepath</a>, argv[++argIndex], <span class="keyword">sizeof</span>( Params.<a class="code" href="structUpgradeParams.html#a218860c6cd4230ea668493ae8f76fa91">filepath</a>));
<a name="l00712"></a>00712                         Params.<a class="code" href="structUpgradeParams.html#a218860c6cd4230ea668493ae8f76fa91">filepath</a>[ <span class="keyword">sizeof</span>( Params.<a class="code" href="structUpgradeParams.html#a218860c6cd4230ea668493ae8f76fa91">filepath</a>)- 1]= <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00713"></a>00713                 }
<a name="l00714"></a>00714         <span class="keywordflow">if</span> ( strcmp(argv[argIndex],<span class="stringliteral">&quot;-delete&quot;</span>) == 0 )
<a name="l00715"></a>00715             Params.<a class="code" href="structUpgradeParams.html#a3a5e5519a0a73bf780a0c95879b299b1">delete</a> = 1;
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="comment">// open the board descriptor file</span>
<a name="l00719"></a>00719         <span class="keywordflow">if</span> ((!Params.<a class="code" href="structUpgradeParams.html#a47424e61651250061e6542f9fe54317a">cfa</a>) || (fwrel)  || (license) || (key) | (writeKey)) {
<a name="l00720"></a>00720                 bdf = fopen(ParamFile,<span class="stringliteral">&quot;r&quot;</span>);
<a name="l00721"></a>00721                 <span class="keywordflow">if</span>(bdf == 0) {
<a name="l00722"></a>00722                         printf(<span class="stringliteral">&quot;Can&apos;t open file %s\n&quot;</span>, ParamFile);
<a name="l00723"></a>00723                         <a class="code" href="generate-MODULES_8h.html#a3605307780f1adef4b64af88704d0861">Usage</a>();
<a name="l00724"></a>00724                         <span class="keywordflow">return</span> (-2); 
<a name="l00725"></a>00725                 }
<a name="l00726"></a>00726 
<a name="l00727"></a>00727                 fscanf(bdf, <span class="stringliteral">&quot;%s&quot;</span>, Params.<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>);
<a name="l00728"></a>00728                 fscanf(bdf, <span class="stringliteral">&quot;%x&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) (&amp;FlashInfo.<a class="code" href="structFlashAccess.html#a94e461f65051ef4f7ae456fb450287ad">Sel_Flash</a>));
<a name="l00729"></a>00729                 fscanf(bdf, <span class="stringliteral">&quot;%x&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) (&amp;FlashInfo.<a class="code" href="structFlashAccess.html#a8632f270404018005c0f5e6774dd9d7c">RW_Flash</a>));
<a name="l00730"></a>00730                 fscanf(bdf, <span class="stringliteral">&quot;%d&quot;</span>, &amp;FlashInfo.<a class="code" href="structFlashAccess.html#a429e125d6178e06c8cc9d45ea3c90b10">RegSize</a>);
<a name="l00731"></a>00731                 fscanf(bdf, <span class="stringliteral">&quot;%d&quot;</span>, &amp;FlashInfo.<a class="code" href="structFlashAccess.html#aa44c50badfa9330565180db7196d5051">PageSize</a>);
<a name="l00732"></a>00732                 fscanf(bdf, <span class="stringliteral">&quot;%d&quot;</span>, &amp;Params.<a class="code" href="structUpgradeParams.html#a69efa0f376669bfe96e47727025f2c89">FirstPageStd</a>);
<a name="l00733"></a>00733                 fscanf(bdf, <span class="stringliteral">&quot;%d&quot;</span>, &amp;Params.<a class="code" href="structUpgradeParams.html#a3ea68d12fa47009f08a7c03303a488a8">FirstPageBck</a>);
<a name="l00734"></a>00734                 <span class="keywordflow">if</span> (!feof(bdf)) {
<a name="l00735"></a>00735                         <span class="keywordtype">int</span> <a class="code" href="mhist_8c.html#a1c4effcb9a2b3357fbfa63a6edfa0cc6">tmp</a>;
<a name="l00736"></a>00736                         <span class="keywordflow">if</span> (fscanf(bdf, <span class="stringliteral">&quot;%d&quot;</span>, &amp;tmp) &gt; 0)
<a name="l00737"></a>00737                                 FlashInfo.<a class="code" href="structFlashAccess.html#af87ac9a7d103e06c7c0bd0faaa26708b">FlashEnable</a> = tmp;
<a name="l00738"></a>00738                 }
<a name="l00739"></a>00739                 fscanf(bdf, <span class="stringliteral">&quot;%x&quot;</span>, &amp;Params.<a class="code" href="structUpgradeParams.html#aa530f38e51ff317a04ec97691e54255b">ROCFwm</a>);
<a name="l00740"></a>00740                 fscanf(bdf, <span class="stringliteral">&quot;%x&quot;</span>, &amp;Params.<a class="code" href="structUpgradeParams.html#acc3ca0e85469e9eca8487e45972199ad">AMCFwm</a>);
<a name="l00741"></a>00741                 fclose(bdf);
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="comment">// Call cvUpgrade function</span>
<a name="l00745"></a>00745         <span class="comment">//if (key == 0)</span>
<a name="l00746"></a>00746  <span class="comment">//     err = cvUpgrade(&amp;Params, &amp;FlashInfo);</span>
<a name="l00747"></a>00747         <span class="comment">//else {</span>
<a name="l00748"></a>00748         <span class="comment">//      if ((!strncmp(Params.Models,&quot;DIGITIZERS&quot;,1000)) || </span>
<a name="l00749"></a>00749         <span class="comment">//              (!strncmp(Params.Models,&quot;V1495&quot;,1000)) ) {</span>
<a name="l00750"></a>00750         <span class="comment">//                      err = KeyInfo(&amp;Params, &amp;FlashInfo);</span>
<a name="l00751"></a>00751         <span class="comment">//      }</span>
<a name="l00752"></a>00752         <span class="comment">//}</span>
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (key ) {
<a name="l00754"></a>00754                 <span class="keywordflow">if</span> ((!strncmp(Params.<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>,<span class="stringliteral">&quot;DIGITIZERS&quot;</span>,1000)) || 
<a name="l00755"></a>00755                         (!strncmp(Params.<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>,<span class="stringliteral">&quot;V1495&quot;</span>,1000)) ) {
<a name="l00756"></a>00756                                 err = <a class="code" href="cvupgrade_8c.html#a76a02ca4195151597e19a0a994fc5be1">KeyInfo</a>(&amp;Params, &amp;FlashInfo);
<a name="l00757"></a>00757                 }
<a name="l00758"></a>00758         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (license ) {
<a name="l00759"></a>00759                 <span class="keywordflow">if</span> ((!strncmp(Params.<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>,<span class="stringliteral">&quot;DIGITIZERS&quot;</span>,1000)) || 
<a name="l00760"></a>00760                         (!strncmp(Params.<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>,<span class="stringliteral">&quot;V1495&quot;</span>,1000)) ) {
<a name="l00761"></a>00761                                 err = <a class="code" href="cvupgrade_8c.html#a6cce5469e2c46cc06d94a42bf5d058f4">License</a>(&amp;Params, &amp;FlashInfo);
<a name="l00762"></a>00762                 }
<a name="l00763"></a>00763         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (writeKey ) {
<a name="l00764"></a>00764                 err = <a class="code" href="cvupgrade_8c.html#a8ec6be8108a0d3ec304985b3531b5f95">WriteKey</a>(&amp;Params, &amp;FlashInfo);
<a name="l00765"></a>00765         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fwrel ) {
<a name="l00766"></a>00766                 err = <a class="code" href="cvupgrade_8c.html#a9b8aeb6281400048a5e077a4cac434bc">GetFWRel</a>(&amp;Params, &amp;FlashInfo);
<a name="l00767"></a>00767         } <span class="keywordflow">else</span> {
<a name="l00768"></a>00768       err = <a class="code" href="cvupgrade_8c.html#a21306ca2af895f8960daac342f3e5614">cvUpgrade</a>(&amp;Params, &amp;FlashInfo);
<a name="l00769"></a>00769           <span class="keywordflow">if</span> (err) <span class="keywordflow">return</span> err;
<a name="l00770"></a>00770         }
<a name="l00771"></a>00771     <span class="keywordflow">if</span> (err)
<a name="l00772"></a>00772         <span class="keywordflow">return</span> (<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5acb2d13fca5dbf8188509d62c89d6da98">CvUpgrade_GenericError</a>);
<a name="l00773"></a>00773     <span class="keywordflow">else</span>
<a name="l00774"></a>00774         <span class="keywordflow">return</span> 0;
<a name="l00775"></a>00775 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aca02ef2acaccca7fb14ce091ce7eee04"></a><!-- doxytag: member="cvupgrade.c::PrintCROM2File" ref="aca02ef2acaccca7fb14ce091ce7eee04" args="(FILE *fp, const CROM_MAP *map)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void PrintCROM2File </td>
          <td>(</td>
          <td class="paramtype">FILE *&nbsp;</td>
          <td class="paramname"> <em>fp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structCROM__MAP.html">CROM_MAP</a> *&nbsp;</td>
          <td class="paramname"> <em>map</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00198">198</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00058">CROM_MAP::crom_board_id</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00054">CROM_MAP::crom_c_code</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00051">CROM_MAP::crom_chksum</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00052">CROM_MAP::crom_chksum_len</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00053">CROM_MAP::crom_const</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00056">CROM_MAP::crom_OUI</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00055">CROM_MAP::crom_r_code</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00059">CROM_MAP::crom_revision</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00060">CROM_MAP::crom_serial</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00061">CROM_MAP::crom_VCXO_type</a>, and <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00057">CROM_MAP::crom_version</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00215">KeyInfo()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00198"></a>00198                                                           {
<a name="l00199"></a>00199     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;Checksum        = %X\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#ac46b87f72a492189e6d93d62d7389c7d">crom_chksum</a>);
<a name="l00200"></a>00200     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;Checksum Length = %X\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#afb8f910950862182fc5a5f97b84c2483">crom_chksum_len</a>);
<a name="l00201"></a>00201     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;Constant field  = %X\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#a777bc83a0996fbadbe79bbfc9cd8b447">crom_const</a>);
<a name="l00202"></a>00202     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;C Code          = %X\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#a4d30d949e9c15c4987a1c79411a2be9b">crom_c_code</a>);
<a name="l00203"></a>00203     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;R Code          = %X\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#a41458ed2b1ff127936a1fb19fd795990">crom_r_code</a>);
<a name="l00204"></a>00204     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;OUI             = %X\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#a19c1bfb65421c1bf31d15bd70f9195fe">crom_OUI</a>);
<a name="l00205"></a>00205     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;Version         = %X\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#af0a120ba1eeff9dba1456e3d103393a2">crom_version</a>);
<a name="l00206"></a>00206     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;Board ID        = %X\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#af33781df0bfcf91c60ab03e41f1df887">crom_board_id</a>);
<a name="l00207"></a>00207     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;PCB Revision    = %d\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#ab9d9f87b372f609edf53896dd98aaee0">crom_revision</a>);
<a name="l00208"></a>00208     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;Serial Number   = %d\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#ad5c0c4ac342dc85e94bd7f2876346692">crom_serial</a>);
<a name="l00209"></a>00209     fprintf(<a class="code" href="mlxspeaker_8c.html#aa065f30aa9f5f9a42132c82c787ee70b">fp</a>,<span class="stringliteral">&quot;VCXO Type ID    = %d\n&quot;</span>, map-&gt;<a class="code" href="structCROM__MAP.html#a527f25d178b20bb7ec0e84cb66d6b6eb">crom_VCXO_type</a>);
<a name="l00210"></a>00210 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3889b2b6bdef9d4f2f1a76c8c323defa"></a><!-- doxytag: member="cvupgrade.c::ReadConfigurationROM" ref="a3889b2b6bdef9d4f2f1a76c8c323defa" args="(cvFlashAccess *Flash, CROM_MAP *crom)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int ReadConfigurationROM </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structFlashAccess.html">cvFlashAccess</a> *&nbsp;</td>
          <td class="paramname"> <em>Flash</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structCROM__MAP.html">CROM_MAP</a> *&nbsp;</td>
          <td class="paramname"> <em>crom</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00144">144</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00041">AT45_PAGE_SIZE</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00058">CROM_MAP::crom_board_id</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00054">CROM_MAP::crom_c_code</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00051">CROM_MAP::crom_chksum</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00052">CROM_MAP::crom_chksum_len</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00053">CROM_MAP::crom_const</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00056">CROM_MAP::crom_OUI</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00055">CROM_MAP::crom_r_code</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00059">CROM_MAP::crom_revision</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00060">CROM_MAP::crom_serial</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00061">CROM_MAP::crom_VCXO_type</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00057">CROM_MAP::crom_version</a>, <a class="el" href="lrs1821_8c_source.html#l00038">data</a>, <a class="el" href="CAENBridgeUpgrade_2src_2flash_8c_source.html#l00202">ReadFlashPage()</a>, and <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00032">ROM_FLASH_PAGE</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00215">KeyInfo()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00145"></a>00145 {
<a name="l00146"></a>00146   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>[<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#acf19e18da898d8fa43a44e6793b12f48a26d2b4386d457d2cc9ec4e202f62dc24">AT45_PAGE_SIZE</a>];
<a name="l00147"></a>00147   <span class="keywordtype">int</span> res = 0;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149   res = <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a63d7546c607af7f80e8787b9ce1d4f11">ReadFlashPage</a>(Flash, data, <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#aa2b083fa0a2febd760616e69882e7aea">ROM_FLASH_PAGE</a>);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151   <span class="keywordflow">if</span> (res == 0) {
<a name="l00152"></a>00152       crom-&gt;<a class="code" href="structCROM__MAP.html#ac46b87f72a492189e6d93d62d7389c7d">crom_chksum</a>     = (uint8_t)(data[0]);
<a name="l00153"></a>00153       crom-&gt;<a class="code" href="structCROM__MAP.html#afb8f910950862182fc5a5f97b84c2483">crom_chksum_len</a> = (uint32_t) ((data[1] &lt;&lt; 16) | (data[2] &lt;&lt; 8) | data[3]);
<a name="l00154"></a>00154       crom-&gt;<a class="code" href="structCROM__MAP.html#a777bc83a0996fbadbe79bbfc9cd8b447">crom_const</a>      = (uint32_t) ((data[4] &lt;&lt; 16) | (data[5] &lt;&lt; 8) | data[6]);
<a name="l00155"></a>00155       crom-&gt;<a class="code" href="structCROM__MAP.html#a4d30d949e9c15c4987a1c79411a2be9b">crom_c_code</a>     = (uint8_t)(data[7]);
<a name="l00156"></a>00156       crom-&gt;<a class="code" href="structCROM__MAP.html#a41458ed2b1ff127936a1fb19fd795990">crom_r_code</a>     = (uint8_t)(data[8]);
<a name="l00157"></a>00157       crom-&gt;<a class="code" href="structCROM__MAP.html#a19c1bfb65421c1bf31d15bd70f9195fe">crom_OUI</a>        = (uint32_t) ((data[9] &lt;&lt; 16) | (data[10] &lt;&lt; 8) | data[11]);
<a name="l00158"></a>00158       crom-&gt;<a class="code" href="structCROM__MAP.html#af0a120ba1eeff9dba1456e3d103393a2">crom_version</a>    = (uint8_t)(data[12]);
<a name="l00159"></a>00159       crom-&gt;<a class="code" href="structCROM__MAP.html#af33781df0bfcf91c60ab03e41f1df887">crom_board_id</a>   = (uint32_t) ((data[13] &lt;&lt; 16) | (data[14] &lt;&lt; 8) | data[15]);
<a name="l00160"></a>00160       crom-&gt;<a class="code" href="structCROM__MAP.html#ab9d9f87b372f609edf53896dd98aaee0">crom_revision</a>   = (uint32_t) ( (data[16] &lt;&lt; 24) | (data[17] &lt;&lt; 16) | (data[18] &lt;&lt; 8) | data[19]);
<a name="l00161"></a>00161       crom-&gt;<a class="code" href="structCROM__MAP.html#ad5c0c4ac342dc85e94bd7f2876346692">crom_serial</a>     = (uint16_t) ((data[32] &lt;&lt; 8) | (data[33]));
<a name="l00162"></a>00162       crom-&gt;<a class="code" href="structCROM__MAP.html#a527f25d178b20bb7ec0e84cb66d6b6eb">crom_VCXO_type</a>  = (uint8_t)(data[34]);
<a name="l00163"></a>00163   }
<a name="l00164"></a>00164   <span class="keywordflow">return</span> res;
<a name="l00165"></a>00165 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a42fb85b07498ef78b4b0e1005612c653"></a><!-- doxytag: member="cvupgrade.c::ReadLicense" ref="a42fb85b07498ef78b4b0e1005612c653" args="(cvFlashAccess *Flash, uint8_t licenseData[LICENSE_DATA_SIZE])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int ReadLicense </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structFlashAccess.html">cvFlashAccess</a> *&nbsp;</td>
          <td class="paramname"> <em>Flash</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&nbsp;</td>
          <td class="paramname"> <em>licenseData</em>[LICENSE_DATA_SIZE]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00171">171</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00041">AT45_PAGE_SIZE</a>, <a class="el" href="lrs1821_8c_source.html#l00038">data</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00033">LICENSE_FLASH_PAGE</a>, and <a class="el" href="CAENBridgeUpgrade_2src_2flash_8c_source.html#l00202">ReadFlashPage()</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00334">License()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00172"></a>00172 {
<a name="l00173"></a>00173   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>[<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#acf19e18da898d8fa43a44e6793b12f48a26d2b4386d457d2cc9ec4e202f62dc24">AT45_PAGE_SIZE</a>];
<a name="l00174"></a>00174   <span class="keywordtype">int</span> res = 0;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176   <span class="keywordflow">if</span>( (res = <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a63d7546c607af7f80e8787b9ce1d4f11">ReadFlashPage</a>(Flash, data, <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a07ef922a0ca6b086bfd692563cd0c253">LICENSE_FLASH_PAGE</a>))!= 0) {
<a name="l00177"></a>00177           <span class="keywordflow">return</span> res;
<a name="l00178"></a>00178   }
<a name="l00179"></a>00179   memcpy( licenseData, data, <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#abc448525b742d25f40b8d7823222bc50">LICENSE_DATA_SIZE</a>); 
<a name="l00180"></a>00180   <span class="keywordflow">return</span> 0;
<a name="l00181"></a>00181 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae28fba57a1edfa47dfb0ed05fb38131c"></a><!-- doxytag: member="cvupgrade.c::Usage" ref="ae28fba57a1edfa47dfb0ed05fb38131c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void Usage </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00109">109</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00109"></a>00109                     {
<a name="l00110"></a>00110         printf(<span class="stringliteral">&quot;Syntax: cvUpgrade ConfFile ConnType[USB|OPTLINK] [ConfigOptions][DeviceOptions]\n&quot;</span>);
<a name="l00111"></a>00111                 printf(<span class="stringliteral">&quot;Syntax: cvUpgrade -KeyInfo ConnType[USB|OPTLINK] [DeviceOptions]\n&quot;</span>);
<a name="l00112"></a>00112                 printf(<span class="stringliteral">&quot;Syntax: cvUpgrade -License ConnType[USB|OPTLINK] [LicenseOptions]\n&quot;</span>);
<a name="l00113"></a>00113         printf(<span class="stringliteral">&quot;Syntax: cvUpgrade -Key N ConnType[USB|OPTLINK] [DeviceOptions]\n\n&quot;</span>);
<a name="l00114"></a>00114                 printf(<span class="stringliteral">&quot;Syntax: cvUpgrade -fvrel ConnType[USB|OPTLINK] [DeviceOptions]\n\n&quot;</span>);
<a name="l00115"></a>00115         printf(<span class="stringliteral">&quot;Description: write the file &apos;ConfFile&apos; (Altera Raw Binary Format) into\n&quot;</span>);
<a name="l00116"></a>00116         printf(<span class="stringliteral">&quot;the flash memory of board connected by the specified connection type OR\n&quot;</span>);
<a name="l00117"></a>00117         printf(<span class="stringliteral">&quot;retrieve the keyinfo data from the board and store it on BoardInfo.dat file OR\n&quot;</span>);
<a name="l00118"></a>00118                 printf(<span class="stringliteral">&quot;retrieve or delete the license data from the board:\n&quot;</span>);
<a name="l00119"></a>00119                 printf(<span class="stringliteral">&quot;  to delete the license file you must specify -delete option\n\n&quot;</span>);
<a name="l00120"></a>00120         printf(<span class="stringliteral">&quot;ConfigOptions:\n\n&quot;</span>);
<a name="l00121"></a>00121         printf(<span class="stringliteral">&quot;-backup: write backup image\n\n&quot;</span>);
<a name="l00122"></a>00122                 printf(<span class="stringliteral">&quot;-key    N: The key value to enable the DPP firmware\n\n&quot;</span>); 
<a name="l00123"></a>00123         printf(<span class="stringliteral">&quot;-no_verify: disable verify (don&apos;t read and compare the flash content)\n\n&quot;</span>);
<a name="l00124"></a>00124         printf(<span class="stringliteral">&quot;-verify_only: read the flash content and compare with the ConfFile file\n\n&quot;</span>);
<a name="l00125"></a>00125                 printf(<span class="stringliteral">&quot;DeviceOptions:\n\n&quot;</span>);
<a name="l00126"></a>00126         printf(<span class="stringliteral">&quot;-param filename: allow to specify the file that contain the parameters for the\n&quot;</span>);
<a name="l00127"></a>00127         printf(<span class="stringliteral">&quot;                 board that is being upgraded (default is cvUpgrade_params.txt)\n&quot;</span>);
<a name="l00128"></a>00128                 printf(<span class="stringliteral">&quot;                                 With CFA files this option is not required.\n\n&quot;</span>);
<a name="l00129"></a>00129                 printf(<span class="stringliteral">&quot;-rbf: specifies that the config file to be updated is in RBF format.\n&quot;</span>);
<a name="l00130"></a>00130         printf(<span class="stringliteral">&quot;-link   N: when using CONET, it is the optical link number to be used\n&quot;</span>);
<a name="l00131"></a>00131                 printf(<span class="stringliteral">&quot;           when using USB, it is the USB device number to be used (default is 0)\n\n&quot;</span>);
<a name="l00132"></a>00132         printf(<span class="stringliteral">&quot;-bdnum  N: select board number in a chainable link (V2718 only)\n\n&quot;</span>);
<a name="l00133"></a>00133                 printf(<span class="stringliteral">&quot;-VMEbaseaddress   N: The base address of the VME slave board to be upgraded (Hex 32 bit)\n\n&quot;</span>);
<a name="l00134"></a>00134         printf(<span class="stringliteral">&quot;-modelname ModelName: specify the model name (e.g. V1724B)\n\n&quot;</span>);
<a name="l00135"></a>00135         printf(<span class="stringliteral">&quot;-filepath Folder: specify the folder where store the KeyInfo file\n\n&quot;</span>);
<a name="l00136"></a>00136                 printf(<span class="stringliteral">&quot;LicenseOptions:\n\n&quot;</span>);
<a name="l00137"></a>00137         printf(<span class="stringliteral">&quot;-delete : deletes the license data\n&quot;</span>);
<a name="l00138"></a>00138 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a07b0b2272110318092e6111087618477"></a><!-- doxytag: member="cvupgrade.c::validateModel" ref="a07b0b2272110318092e6111087618477" args="(cvUpgradeParams *config, cvFlashAccess *flash, char **fwData, int *fwSize)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int validateModel </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structFlashAccess.html">cvFlashAccess</a> *&nbsp;</td>
          <td class="paramname"> <em>flash</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>fwData</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>fwSize</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00413">413</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00045">CFASegmentType1_t::accessType</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00016">CFAModelType1_t::address</a>, <a class="el" href="scs__210__tc600_8c_source.html#l00074">address</a>, <a class="el" href="CAENComm_8h.html#a0f912e235df9c015a0902382ab29ae93">CAENComm_Read16()</a>, <a class="el" href="CAENComm_8h.html#a7b8b1f753271d81c48ed433ad14d883b">CAENComm_Read32()</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00009">CFA_SEGMENT_TYPE_1</a>, <a class="el" href="cvupgrade_8c_source.html#l00099">UpgradeParams::ConfFile</a>, <a class="el" href="CAENBridgeUpgrade_2src_2CFASegment_8c_source.html#l00063">deleteSegment()</a>, <a class="el" href="cvupgrade_8c_source.html#l00092">UpgradeParams::FirstPageBck</a>, <a class="el" href="cvupgrade_8c_source.html#l00091">UpgradeParams::FirstPageStd</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00050">CFASegmentType1_t::flashBckAddress</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00046">CFASegmentType1_t::flashCsAddress</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00047">CFASegmentType1_t::flashCwAddress</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00070">FlashAccess::FlashEnable</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00051">CFASegmentType1_t::flashEnLevel</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00048">CFASegmentType1_t::flashPageSize</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00049">CFASegmentType1_t::flashStdAddress</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00054">CFASegmentType1_t::fwData</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00042">CFASegmentType1_t::fwSizeBytes</a>, <a class="el" href="CAENBridgeUpgrade_2src_2CFASegment_8c_source.html#l00079">getSegmentType()</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00067">FlashAccess::Handle</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="odbhist_8c_source.html#l00058">j</a>, <a class="el" href="MFastSlowCorrelator_8cpp_source.html#l00063">last</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00014">CFAModelType1_t::modelId</a>, <a class="el" href="cvupgrade_8c_source.html#l00100">UpgradeParams::Models</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00053">CFASegmentType1_t::models</a>, <a class="el" href="CAENBridgeUpgrade_2src_2CFASegment_8c_source.html#l00008">newSegment()</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00015">CFAModelType1_t::numChecks</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00041">CFASegmentType1_t::numModels</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00072">FlashAccess::PageSize</a>, <a class="el" href="structCFAModelType1__t.html#a70268cfec80c6aa7871874d7107febd6">CFAModelType1_t::registerChecks</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00071">FlashAccess::RegSize</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00068">FlashAccess::RW_Flash</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00069">FlashAccess::Sel_Flash</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00082">toType1</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2CFASegment_8h_source.html#l00016">CFAModelType1_t::value</a>, and <a class="el" href="ADCS_8h_source.html#l00004">value</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00413"></a>00413                                                                                              {
<a name="l00414"></a>00414         FILE* fin = fopen(config-&gt;<a class="code" href="structUpgradeParams.html#ab029ec441d57f71ed526ad610db0f85d">ConfFile</a>, <span class="stringliteral">&quot;rb&quot;</span>);
<a name="l00415"></a>00415         <span class="keywordflow">while</span> (!feof(fin)) {
<a name="l00416"></a>00416                 <span class="keywordtype">int</span> <a class="code" href="MFastSlowCorrelator_8cpp.html#a3579fbbede9d99d8d4aafc118b3abed3">last</a>;
<a name="l00417"></a>00417                 <a class="code" href="CAENBridgeUpgrade_2inc_2CFASegment_8h.html#aafdf88beb07b294651158bcae73246ed">CFASegmentPtr</a> segm = <a class="code" href="CAENBridgeUpgrade_2inc_2CFASegment_8h.html#af88d28234c6bb2b3a5d39672cf1ff02f">newSegment</a>(fin, &amp;last);
<a name="l00418"></a>00418                 <span class="keywordflow">if</span> (segm == NULL) {
<a name="l00419"></a>00419                         fclose(fin);
<a name="l00420"></a>00420                         <span class="keywordflow">return</span> -2;
<a name="l00421"></a>00421                 }
<a name="l00422"></a>00422                 <span class="keywordflow">if</span> (<a class="code" href="CAENBridgeUpgrade_2inc_2CFASegment_8h.html#a7d76102a08d07184ce4c7e67f2079551">getSegmentType</a>(segm) == <a class="code" href="CAENBridgeUpgrade_2inc_2CFASegment_8h.html#a104cb8c42cdd3b4ed9e3bf90d788ff33ad2e1cc830200c3f6e5cc468e8d639008">CFA_SEGMENT_TYPE_1</a>) {
<a name="l00423"></a>00423                         <a class="code" href="structCFASegmentType1__t.html">CFASegmentType1</a>* t1s = <a class="code" href="CAENBridgeUpgrade_2inc_2CFASegment_8h.html#ad7c4fdb8eb5e667c602458d9a6035ccb">toType1</a>(segm);
<a name="l00424"></a>00424                         <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>;
<a name="l00425"></a>00425                         <span class="keywordflow">for</span> (i = 0; i &lt; t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a93ea49ca2eb74cdd7a0d7a738589d98c">numModels</a>; i++) {
<a name="l00426"></a>00426                                 <span class="keywordflow">for</span> (j = 0; j&lt;t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a4f73f199c1449b17b34772cdd1f37417">models</a>[i]-&gt;<a class="code" href="structCFAModelType1__t.html#ad089515093e0a37c2856b6b84b815966">numChecks</a>; j++) {
<a name="l00427"></a>00427                                         uint32_t <a class="code" href="scs__210__tc600_8c.html#a9ff470cb16fb31f83ca0b9192a33e402">address</a> = t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a4f73f199c1449b17b34772cdd1f37417">models</a>[i]-&gt;<a class="code" href="structCFAModelType1__t.html#a70268cfec80c6aa7871874d7107febd6">registerChecks</a>[j].<a class="code" href="structCFAModelType1__t.html#a29c622f159c4ca22ee986b9aa8e88a48">address</a>;
<a name="l00428"></a>00428                                         uint32_t <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>;
<a name="l00429"></a>00429                                         <span class="keywordflow">if</span> (t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a374834eee9d1a9e51aaf00de36bc4722">accessType</a> == 2) <a class="code" href="CAENComm_8h.html#a0f912e235df9c015a0902382ab29ae93" title="Read a 16 bit data from the specified register.">CAENComm_Read16</a>(flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>, address, (uint16_t*)&amp;value);
<a name="l00430"></a>00430                                         <span class="keywordflow">else</span> <a class="code" href="CAENComm_8h.html#a7b8b1f753271d81c48ed433ad14d883b" title="Read a 32 bit data from the specified register.">CAENComm_Read32</a>(flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>, address, &amp;value);
<a name="l00431"></a>00431                                         <span class="keywordflow">if</span> (value != t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a4f73f199c1449b17b34772cdd1f37417">models</a>[i]-&gt;<a class="code" href="structCFAModelType1__t.html#a70268cfec80c6aa7871874d7107febd6">registerChecks</a>[j].<a class="code" href="structCFAModelType1__t.html#ab5f35de8f2eb2bc14475aa07689fed48">value</a>) <span class="keywordflow">break</span>;
<a name="l00432"></a>00432                                 }
<a name="l00433"></a>00433                                 <span class="keywordflow">if</span> (j == t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a4f73f199c1449b17b34772cdd1f37417">models</a>[i]-&gt;<a class="code" href="structCFAModelType1__t.html#ad089515093e0a37c2856b6b84b815966">numChecks</a>) { <span class="comment">/* this means that all the checks match */</span>
<a name="l00434"></a>00434                                         flash-&gt;<a class="code" href="structFlashAccess.html#aa44c50badfa9330565180db7196d5051">PageSize</a> = t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a3fe33ef5087fb92df8bf28dd5ce2b970">flashPageSize</a>;
<a name="l00435"></a>00435                                         flash-&gt;<a class="code" href="structFlashAccess.html#a429e125d6178e06c8cc9d45ea3c90b10">RegSize</a> = t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a374834eee9d1a9e51aaf00de36bc4722">accessType</a>;
<a name="l00436"></a>00436                                         flash-&gt;<a class="code" href="structFlashAccess.html#a94e461f65051ef4f7ae456fb450287ad">Sel_Flash</a> = t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a04d4ab910f72a231a8e5c49920230356">flashCsAddress</a>;
<a name="l00437"></a>00437                                         flash-&gt;<a class="code" href="structFlashAccess.html#a8632f270404018005c0f5e6774dd9d7c">RW_Flash</a> = t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#aae5b950f1c3eb5f96bcfe7a51a3ec7f3">flashCwAddress</a>;
<a name="l00438"></a>00438                                         flash-&gt;<a class="code" href="structFlashAccess.html#af87ac9a7d103e06c7c0bd0faaa26708b">FlashEnable</a> = t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a5715dc6ba12a88c40c45fc0863d9a27d">flashEnLevel</a>;
<a name="l00439"></a>00439                                         config-&gt;<a class="code" href="structUpgradeParams.html#a69efa0f376669bfe96e47727025f2c89">FirstPageStd</a> = t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a6a90d50c4c7beebdcaa499f3d2bf8588">flashStdAddress</a>;
<a name="l00440"></a>00440                                         config-&gt;<a class="code" href="structUpgradeParams.html#a3ea68d12fa47009f08a7c03303a488a8">FirstPageBck</a> = t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a2a76775bbad2c0700b6d7bfc22ca1418">flashBckAddress</a>;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442                                         *fwData = malloc(t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#af9f0d69afda3cb4d97723f643f59dad5">fwSizeBytes</a>);
<a name="l00443"></a>00443                                         memcpy(*fwData, t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#acaa9a8c3c6f2d5e592190ac462a507d8">fwData</a>, t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#af9f0d69afda3cb4d97723f643f59dad5">fwSizeBytes</a>);
<a name="l00444"></a>00444                                         *fwSize = t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#af9f0d69afda3cb4d97723f643f59dad5">fwSizeBytes</a>;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446                                         sprintf(config-&gt;<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>, <span class="stringliteral">&quot;id %d&quot;</span>, t1s-&gt;<a class="code" href="structCFASegmentType1__t.html#a4f73f199c1449b17b34772cdd1f37417">models</a>[i]-&gt;<a class="code" href="structCFAModelType1__t.html#afa1a1ad8f82458665026a71f69e75991">modelId</a>);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448                                         <a class="code" href="CAENBridgeUpgrade_2inc_2CFASegment_8h.html#aad8f25df0c0068878a32f42410f5a66a">deleteSegment</a>(segm);
<a name="l00449"></a>00449                                         fclose(fin);
<a name="l00450"></a>00450                                         <span class="keywordflow">return</span> 0;
<a name="l00451"></a>00451                                 }
<a name="l00452"></a>00452                         }
<a name="l00453"></a>00453                 }
<a name="l00454"></a>00454                 <a class="code" href="CAENBridgeUpgrade_2inc_2CFASegment_8h.html#aad8f25df0c0068878a32f42410f5a66a">deleteSegment</a>(segm);
<a name="l00455"></a>00455                 <span class="keywordflow">if</span> (last) <span class="keywordflow">break</span>;
<a name="l00456"></a>00456         }
<a name="l00457"></a>00457         fclose(fin);
<a name="l00458"></a>00458         <span class="keywordflow">return</span> -1;
<a name="l00459"></a>00459 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8ec6be8108a0d3ec304985b3531b5f95"></a><!-- doxytag: member="cvupgrade.c::WriteKey" ref="a8ec6be8108a0d3ec304985b3531b5f95" args="(cvUpgradeParams *Config, cvFlashAccess *Flash)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int WriteKey </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structUpgradeParams.html">cvUpgradeParams</a> *&nbsp;</td>
          <td class="paramname"> <em>Config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structFlashAccess.html">cvFlashAccess</a> *&nbsp;</td>
          <td class="paramname"> <em>Flash</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="cvupgrade_8c_source.html#l00377">377</a> of file <a class="el" href="cvupgrade_8c_source.html">cvupgrade.c</a>.</p>

<p>References <a class="el" href="cvupgrade_8c_source.html#l00090">UpgradeParams::BaseAddress</a>, <a class="el" href="cvupgrade_8c_source.html#l00089">UpgradeParams::BdNum</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00026">CAENCOM_INVALID_FILE_HANDLE</a>, <a class="el" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac">CAENComm_CloseDevice()</a>, <a class="el" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice()</a>, <a class="el" href="CAENComm_8h_source.html#l00084">CAENComm_Success</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00081">CvUpgrade_FileAccessError</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00067">FlashAccess::Handle</a>, <a class="el" href="odbhist_8c_source.html#l00058">k</a>, <a class="el" href="cvupgrade_8c_source.html#l00093">UpgradeParams::key</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00035">LICENSE_DATA_SIZE</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00033">LICENSE_FLASH_PAGE</a>, <a class="el" href="cvupgrade_8c_source.html#l00088">UpgradeParams::Link</a>, <a class="el" href="cvupgrade_8c_source.html#l00100">UpgradeParams::Models</a>, <a class="el" href="cvupgrade_8c_source.html#l00087">UpgradeParams::Type</a>, <a class="el" href="CAENBridgeUpgrade_2inc_2flash_8h_source.html#l00023">Wait_ms</a>, and <a class="el" href="CAENBridgeUpgrade_2src_2flash_8c_source.html#l00186">WriteFlashPage()</a>.</p>

<p>Referenced by <a class="el" href="cvupgrade_8c_source.html#l00466">cvUpgrade()</a>, and <a class="el" href="cvupgrade_8c_source.html#l00623">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00378"></a>00378 {
<a name="l00379"></a>00379     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> err=0, res, handleToClose= 0;    
<a name="l00380"></a>00380         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> key_page[<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#abc448525b742d25f40b8d7823222bc50">LICENSE_DATA_SIZE</a>];
<a name="l00381"></a>00381     <span class="keywordtype">int</span> <a class="code" href="odbhist_8c.html#a43fa990200c3ddd47c35f151bd4d66bf">k</a>;    
<a name="l00382"></a>00382 
<a name="l00383"></a>00383         <span class="keywordflow">if</span> ((Config-&gt;<a class="code" href="structUpgradeParams.html#aff8a947b934d40fe8cc44aa28676d27c">key</a> != 0) &amp;&amp; 
<a name="l00384"></a>00384                 ((!strncmp(Config-&gt;<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>,<span class="stringliteral">&quot;DIGITIZERS&quot;</span>,1000)) || 
<a name="l00385"></a>00385                 (!strncmp(Config-&gt;<a class="code" href="structUpgradeParams.html#ac88aaf159a6a6e09ca554477351bd027">Models</a>,<span class="stringliteral">&quot;V1495&quot;</span>,1000)))) {
<a name="l00386"></a>00386                         <span class="keywordflow">if</span>( Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>== <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a70512b9cb16089fefff47963506106bc">CAENCOM_INVALID_FILE_HANDLE</a>) {
<a name="l00387"></a>00387                                 res = <a class="code" href="CAENComm_8h.html#a3c98d6ef0eb40520b50309cd11ecf30b">CAENComm_OpenDevice</a>(Config-&gt;<a class="code" href="structUpgradeParams.html#a748375db853b611f044d6be639acc2c6">Type</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#a2a720635715958998b24686be6734536">Link</a>, Config-&gt;<a class="code" href="structUpgradeParams.html#aa3db4e8cff315090fe436657acd278dc">BdNum</a>,  Config-&gt;<a class="code" href="structUpgradeParams.html#a42e8c35c64e68590b9cca03ff1e042cb">BaseAddress</a>, &amp;Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00388"></a>00388                                 <span class="keywordflow">if</span> (res != <a class="code" href="CAENComm_8h.html#a957016b0c3a404d6ab61ea3edf310ad4ad3c23b64a7fcf3b2fb35960981352587">CAENComm_Success</a>) {
<a name="l00389"></a>00389                                         printf(<span class="stringliteral">&quot;Cannot open the Device!\n&quot;</span>);
<a name="l00390"></a>00390                                         <span class="keywordflow">return</span>(<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a80be62738be283c67deda73a50a0dbf5aaccbec2e3667b29773de634762924ceb">CvUpgrade_FileAccessError</a>);
<a name="l00391"></a>00391                                 }
<a name="l00392"></a>00392                                 handleToClose= 1;
<a name="l00393"></a>00393                         }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395                         memset(key_page, 0, <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#abc448525b742d25f40b8d7823222bc50">LICENSE_DATA_SIZE</a>);
<a name="l00396"></a>00396                         <span class="keywordflow">for</span> (k = <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#abc448525b742d25f40b8d7823222bc50">LICENSE_DATA_SIZE</a>- 1; k &gt; -1; k--) {
<a name="l00397"></a>00397                                 key_page[<a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#abc448525b742d25f40b8d7823222bc50">LICENSE_DATA_SIZE</a>- 1- k] = (<span class="keywordtype">unsigned</span> char) ((Config-&gt;<a class="code" href="structUpgradeParams.html#aff8a947b934d40fe8cc44aa28676d27c">key</a> &gt;&gt; (k * 8)) &amp; 0xFF);
<a name="l00398"></a>00398                         }       
<a name="l00399"></a>00399                         <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a03253e79576c92f76029ccbe1b8c3f8c">WriteFlashPage</a>(Flash, key_page, <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a07ef922a0ca6b086bfd692563cd0c253">LICENSE_FLASH_PAGE</a>);
<a name="l00400"></a>00400                         <span class="keywordflow">if</span>( handleToClose) {
<a name="l00401"></a>00401                                 <a class="code" href="CAENComm_8h.html#a423a9a41d79ef6d1b678f62741a327ac" title="Close the device.">CAENComm_CloseDevice</a>(Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>);
<a name="l00402"></a>00402                                 <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#ada7d9a75c4d9f54fc9aa680c8cf1044a">Wait_ms</a>(1000);
<a name="l00403"></a>00403                                 Flash-&gt;<a class="code" href="structFlashAccess.html#a546ba016d8a06fa942f85bb2779a0e2b">Handle</a>= <a class="code" href="CAENBridgeUpgrade_2inc_2flash_8h.html#a70512b9cb16089fefff47963506106bc">CAENCOM_INVALID_FILE_HANDLE</a>;
<a name="l00404"></a>00404                         }
<a name="l00405"></a>00405             printf(<span class="stringliteral">&quot;\nKey written successfully\n&quot;</span>);
<a name="l00406"></a>00406         }
<a name="l00407"></a>00407     <span class="keywordflow">return</span> err;
<a name="l00408"></a>00408 }
</pre></div></p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
