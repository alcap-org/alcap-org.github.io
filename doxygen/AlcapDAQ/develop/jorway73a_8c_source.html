<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ: midas/drivers/bus/jorway73a.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>midas/drivers/bus/jorway73a.c</h1><a href="jorway73a_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">Name:         jorway73a.c</span>
<a name="l00004"></a>00004 <span class="comment">Created by:   Greg Hackman</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">(based on kcs2927.c by P.-A. A)</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">Contents:     LINUX Device driver for Jorway 73A</span>
<a name="l00009"></a>00009 <span class="comment">following the MIDAS CAMAC Standard for DirectIO</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">NOTE:  In this driver code, the number that you pass as &quot;crate&quot;</span>
<a name="l00012"></a>00012 <span class="comment">should be interpreted as the SCSI host adapter channel number </span>
<a name="l00013"></a>00013 <span class="comment">times 8 plus the thumbwheel setting.  Most systems will only </span>
<a name="l00014"></a>00014 <span class="comment">have one SCSI adapter in which case the &quot;crate&quot; becomes just the </span>
<a name="l00015"></a>00015 <span class="comment">thumbwheel setting.  To confrim this, &quot;cat /proc/scsi/scsi&quot; will</span>
<a name="l00016"></a>00016 <span class="comment">return something that looks like:</span>
<a name="l00017"></a>00017 <span class="comment">Host: scsi0 Channel: 00 Id: 01 Lun: 00</span>
<a name="l00018"></a>00018 <span class="comment">Vendor: JORWAY   Model: 73A              Rev: 300  </span>
<a name="l00019"></a>00019 <span class="comment">Type:   Processor                        ANSI SCSI revision: 02</span>
<a name="l00020"></a>00020 <span class="comment">In this case there is only one SCSI host adapter and the thumbwheel</span>
<a name="l00021"></a>00021 <span class="comment">on the 73A had been set to 1, so this 73A controls &quot;crate&quot; 1.</span>
<a name="l00022"></a>00022 <span class="comment">Note that -- depending on the order in which things are set up</span>
<a name="l00023"></a>00023 <span class="comment">during the boot process -- the channel number may not be 00; for example</span>
<a name="l00024"></a>00024 <span class="comment">if the &quot;iSCSI&quot; module gets installed before the &quot;real&quot; SCSI devices</span>
<a name="l00025"></a>00025 <span class="comment">are installed, then the channel number may be 1.</span>
<a name="l00026"></a>00026 <span class="comment"></span>
<a name="l00027"></a>00027 <span class="comment">Note that the definitions of &quot;branch&quot; and &quot;crate&quot; that are used in</span>
<a name="l00028"></a>00028 <span class="comment">the Jorway documentation, and in the Fermitools software on which this</span>
<a name="l00029"></a>00029 <span class="comment">driver is based, are different than what is used in the MIDAS CAMAC</span>
<a name="l00030"></a>00030 <span class="comment">standard software.</span>
<a name="l00031"></a>00031 <span class="comment"></span>
<a name="l00032"></a>00032 <span class="comment">THE NODMA FLAG:  If you define NODMA (e.g with -DNODMA when you</span>
<a name="l00033"></a>00033 <span class="comment">compile), then repeated CAMAC accesses are implemented as a bunch</span>
<a name="l00034"></a>00034 <span class="comment">of single-datum transfers, rather than as a block read or write.</span>
<a name="l00035"></a>00035 <span class="comment">The NODMA transfers are *much* slower than when this option is</span>
<a name="l00036"></a>00036 <span class="comment">not set.  All SCSI transfers involve about a 1 ms overhead before</span>
<a name="l00037"></a>00037 <span class="comment">any data is transfered, but if you do block transfers the data</span>
<a name="l00038"></a>00038 <span class="comment">is transferred at pretty much the CAMAC maximum speed of</span>
<a name="l00039"></a>00039 <span class="comment">one datum per 1.3 us.  So for example reading a full 4302 memory</span>
<a name="l00040"></a>00040 <span class="comment">takes almost 12 seconds in NODMA mode but occurs in a blistering</span>
<a name="l00041"></a>00041 <span class="comment">15 ms if block transfers are enabled.</span>
<a name="l00042"></a>00042 <span class="comment"></span>
<a name="l00043"></a>00043 <span class="comment">$Log: jorway73a.c,v $</span>
<a name="l00044"></a>00044 <span class="comment">Revision 1.1.1.1  2005/06/20 23:37:07  mucap</span>
<a name="l00045"></a>00045 <span class="comment">Importing release 1.9.5 of the MIDAS source code as distributed by PSI.</span>
<a name="l00046"></a>00046 <span class="comment">(Next, I&apos;ll commit our local customizations.)</span>
<a name="l00047"></a>00047 <span class="comment"></span>
<a name="l00048"></a>00048 <span class="comment">Revision 1.3  2004/01/08 08:40:08  midas</span>
<a name="l00049"></a>00049 <span class="comment">Implemented standard indentation</span>
<a name="l00050"></a>00050 <span class="comment"></span>
<a name="l00051"></a>00051 <span class="comment">Revision 1.2  2004/01/08 06:49:58  pierre</span>
<a name="l00052"></a>00052 <span class="comment">fix small bugs</span>
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a>00054 <span class="comment">Revision 1.1  2002/05/08 22:21:30  pierre</span>
<a name="l00055"></a>00055 <span class="comment">initial version</span>
<a name="l00056"></a>00056 <span class="comment"></span>
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 <span class="comment">\********************************************************************/</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="mcstd_8h.html">mcstd.h</a>&quot;</span>
<a name="l00063"></a><a class="code" href="jorway73a_8c.html#ad22121e0a09767a5cea4852f31c40106">00063</a> <span class="preprocessor">#define SJY73A</span>
<a name="l00064"></a><a class="code" href="jorway73a_8c.html#a7da18d77ccfa6cc0020cc81e7ed8e8b2">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define XDEFLG</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="jorway73a_8h.html">jorway73a.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#undef XDEFLG</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="preprocessor">#if defined( __MSDOS__ )</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#include &lt;dos.h&gt;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#define OUTP(_p, _d) outportb(_p, _d)</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#define OUTPW(_p, _d) outport(_p, _d)</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#define INP(_p) inportb(_p)</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span><span class="preprocessor">#define INPW(_p) inport(_p)</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor">#elif defined( _MSC_VER )</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#include &lt;windows.h&gt;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &lt;conio.h&gt;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#define OUTP(_p, _d) _outp((unsigned short) (_p), (int) (_d))</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#define OUTPW(_p, _d) _outpw((unsigned short) (_p), (unsigned short) (_d))</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="preprocessor">#define INP(_p) _inp((unsigned short) (_p))</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#define INPW(_p) _inpw((unsigned short) (_p))</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#elif defined(OS_LINUX)</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span><span class="preprocessor">#include &lt;asm/io.h&gt;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#define OUTP(_p, _d) outb(_d, _p)</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="preprocessor">#define OUTPW(_p, _d) outw(_d, _p)</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span><span class="preprocessor">#define INP(_p) inb(_p)</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span><span class="preprocessor">#define INPW(_p) inw(_p)</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span>
<a name="l00091"></a><a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">00091</a> <span class="preprocessor">#define NAFCMD(n,a,f) ( (SJY_CAMAC_EXT((f),(n),(a),1)) )        </span><span class="comment">/* Crate must = 1 */</span>
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">/* #define NODMA */</span>
<a name="l00094"></a>00094 <span class="comment">/* Don&apos;t Define the above if you want to use the 73A&apos;s DMA modes (Qstop)</span>
<a name="l00095"></a>00095 <span class="comment">or don&apos;t define it if you want to just mimic q-stop with a bunch</span>
<a name="l00096"></a>00096 <span class="comment">of single reads in a loop. */</span>
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="jorway73a_8c.html#ada419ee69c3cc4a4db37acdbf3ef3054">00098</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#ada419ee69c3cc4a4db37acdbf3ef3054">xdummy</a>, <a class="code" href="jorway73a_8c.html#a484211e5ca89857f6dc2b6e4bffbd3c6">qdummy</a>;             <span class="comment">/* for calls where x, q aren&apos;t important */</span>
<a name="l00099"></a><a class="code" href="jorway73a_8c.html#ad410b818c979ab5e33a7a55ebcf44913">00099</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#ad410b818c979ab5e33a7a55ebcf44913">ieee_last_Q</a> = 0;            <span class="comment">/* for compatibility with get_qx */</span>
<a name="l00100"></a><a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">00100</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a> = 0;
<a name="l00101"></a><a class="code" href="jorway73a_8c.html#aaf2adeb77e670e8de0dc898d9156cc33">00101</a> <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="jorway73a_8c.html#aaf2adeb77e670e8de0dc898d9156cc33">d16dummy</a>;                  <span class="comment">/* for calls where data isn&apos;t important */</span>
<a name="l00102"></a><a class="code" href="jorway73a_8c.html#a500340a6cd6375d4cdc049953a2bf68b">00102</a> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="jorway73a_8c.html#a500340a6cd6375d4cdc049953a2bf68b">d24dummy</a>;                 <span class="comment">/* ditto */</span>
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="jorway73a_8c.html#abb2fa0b92fd9278943cf4d22794b7ced">00104</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#abb2fa0b92fd9278943cf4d22794b7ced">jorway_crate_opened</a>[8] = { 0 };     <span class="comment">/* Set to 1 if crate has been opened */</span>
<a name="l00105"></a><a class="code" href="jorway73a_8c.html#ade30b3ebd96d09456989cf6da3a92e8f">00105</a> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="jorway73a_8c.html#ade30b3ebd96d09456989cf6da3a92e8f">jorway_crate_LAM</a>[8] = { 0 };      <span class="comment">/* There doesn&apos;t seem to ba a cmd    */</span>
<a name="l00106"></a>00106 <span class="comment">/* to read LAM mask off 73A.  Need   */</span>
<a name="l00107"></a>00107 <span class="comment">/* to keep track of it manually.     */</span>
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#ae35e57f6c23ab35a0d10e2e31ee6666e">cdchn</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>, <span class="keywordtype">int</span> <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>, <span class="keywordtype">int</span> route);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">/* Taking advantage of the various modes the SCSI controller actually */</span>
<a name="l00112"></a>00112 <span class="comment">/* supports ... */</span>
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00115"></a><a class="code" href="group__mcstdinclude.html#ga17a49433504fccff1b8a618aba63ac81">00115</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdinclude.html#ga17a49433504fccff1b8a618aba63ac81">cam8i</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>)
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00120"></a><a class="code" href="group__mcstdfunctionh.html#ga859bdf77e425ce09a21c873a86c8af70">00120</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga859bdf77e425ce09a21c873a86c8af70">cami</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <a class="code" href="unionWORD.html">WORD</a> * <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>)
<a name="l00121"></a>00121 {
<a name="l00122"></a>00122    <a class="code" href="group__mcstdfunctionh.html#gad17f339ee8254f1aad6b406e50ebd4a8">cam16i</a>(c, n, a, f, d);
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00126"></a><a class="code" href="group__mcstdfunctionh.html#gad17f339ee8254f1aad6b406e50ebd4a8">00126</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gad17f339ee8254f1aad6b406e50ebd4a8">cam16i</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <a class="code" href="unionWORD.html">WORD</a> * <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>)
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128    <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;
<a name="l00129"></a>00129    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> locdat[2] = { 0, 0 };
<a name="l00130"></a>00130    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);       <span class="comment">/* get cmd to pass to sjy_read */</span>
<a name="l00131"></a>00131    <span class="comment">/* According to Jorway docx, stop-on-word mode will xfer data */</span>
<a name="l00132"></a>00132    <span class="comment">/* EVEN IF q=0.  I think this is consistent with what I was   */</span>
<a name="l00133"></a>00133    <span class="comment">/* seeing with the 4434 module.                               */</span>
<a name="l00134"></a>00134    cmd = cmd | (<a class="code" href="jorway73a_8h.html#ab877659030a6d4f8c5ce1a9721931e71">SJY_STOP_ON_WORD</a> &lt;&lt; 16);
<a name="l00135"></a>00135    <a class="code" href="jorway73a_8c.html#a747d8b2e874a5416bc88493fa21a60cd">sjy_read</a>(c, cmd, &amp;locdat[0], <span class="keyword">sizeof</span>(<a class="code" href="unionWORD.html">WORD</a>));
<a name="l00136"></a>00136    *d = locdat[0];
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00140"></a><a class="code" href="group__mcstdfunctionh.html#ga84d45a99ef748664e1eead0a5da4d862">00140</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga84d45a99ef748664e1eead0a5da4d862">cam24i</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> * <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142    <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;                     <span class="comment">/* Take a page from sjy_cfsa.c */</span>
<a name="l00143"></a>00143    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);       <span class="comment">/* get cmd to pass to sjy_read */</span>
<a name="l00144"></a>00144    <span class="comment">/* See above notes regarding stop_on_word mode */</span>
<a name="l00145"></a>00145    cmd = cmd | (<a class="code" href="jorway73a_8h.html#ab877659030a6d4f8c5ce1a9721931e71">SJY_STOP_ON_WORD</a> &lt;&lt; 16) | <a class="code" href="jorway73a_8h.html#a9de43c528c125741c258d75222a0d0ae">SJY_D24_MODE</a>;
<a name="l00146"></a>00146    <a class="code" href="jorway73a_8c.html#a747d8b2e874a5416bc88493fa21a60cd">sjy_read</a>(c, cmd, d, <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>));
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00150"></a><a class="code" href="group__mcstdfunctionh.html#gad21ad710943e2ab5df6f8e609afeebfe">00150</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gad21ad710943e2ab5df6f8e609afeebfe">cam8i_q</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00151"></a>00151                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> *q)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153    fprintf(stderr, <span class="stringliteral">&quot;cam8i_q not implemented\n&quot;</span>);
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00157"></a><a class="code" href="group__mcstdfunctionh.html#ga2a515796e8020af32ea0e5aad490a170">00157</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga2a515796e8020af32ea0e5aad490a170">cam16i_q</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00158"></a>00158                      <a class="code" href="unionWORD.html">WORD</a> * <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> *q)
<a name="l00159"></a>00159 {
<a name="l00160"></a>00160    <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;                     <span class="comment">/* Take a page from sjy_cfsa.c */</span>
<a name="l00161"></a>00161    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> locdat[2] = { 0, 0 };
<a name="l00162"></a>00162    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);       <span class="comment">/* get cmd to pass to sjy_read */</span>
<a name="l00163"></a>00163    <span class="comment">/* According to Jorway docx, I should probably use Q_STOP mode even */</span>
<a name="l00164"></a>00164    <span class="comment">/* if it&apos;s only for one word, otherwise the controller responds as if */</span>
<a name="l00165"></a>00165    <span class="comment">/* q=1, even if it wasn&apos;t.   This is confirmed by Radfords code. */</span>
<a name="l00166"></a>00166    cmd = cmd | (<a class="code" href="jorway73a_8h.html#ac2b9f0af6193f92b82c6ba98ded73586">SJY_Q_STOP</a> &lt;&lt; 16);
<a name="l00167"></a>00167    <a class="code" href="jorway73a_8c.html#a747d8b2e874a5416bc88493fa21a60cd">sjy_read</a>(c, cmd, &amp;locdat[0], <span class="keyword">sizeof</span>(<a class="code" href="unionWORD.html">WORD</a>));
<a name="l00168"></a>00168    *d = locdat[0];
<a name="l00169"></a>00169    *q = <a class="code" href="jorway73a_8c.html#a9e64e5e231f1948397c994ff2ba9b768">sjy_get_qx</a>(c);
<a name="l00170"></a>00170    *x = <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a>;            <span class="comment">/* Need to get this from global variables I guess ... */</span>
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00174"></a><a class="code" href="group__mcstdfunctionh.html#ga0f1b4435d6f1fea0e5787a5c2388b41c">00174</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga0f1b4435d6f1fea0e5787a5c2388b41c">cam24i_q</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00175"></a>00175                      <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> * <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> *q)
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177    <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;                     <span class="comment">/* Take a page from sjy_cfsa.c */</span>
<a name="l00178"></a>00178    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);       <span class="comment">/* get cmd to pass to sjy_read */</span>
<a name="l00179"></a>00179    <span class="comment">/* See above discussions regarding modes */</span>
<a name="l00180"></a>00180    cmd = cmd | (<a class="code" href="jorway73a_8h.html#ac2b9f0af6193f92b82c6ba98ded73586">SJY_Q_STOP</a> &lt;&lt; 16) | <a class="code" href="jorway73a_8h.html#a9de43c528c125741c258d75222a0d0ae">SJY_D24_MODE</a>;
<a name="l00181"></a>00181    <a class="code" href="jorway73a_8c.html#a747d8b2e874a5416bc88493fa21a60cd">sjy_read</a>(c, cmd, d, <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>));
<a name="l00182"></a>00182    *q = <a class="code" href="jorway73a_8c.html#a9e64e5e231f1948397c994ff2ba9b768">sjy_get_qx</a>(c);
<a name="l00183"></a>00183    *x = <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a>;            <span class="comment">/* Need to get this from global variables I guess ... */</span>
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00187"></a><a class="code" href="group__mcstdfunctionh.html#ga2c3c3cdd300fee9d03e3c426dad38e7c">00187</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga2c3c3cdd300fee9d03e3c426dad38e7c">cam16i_r</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00188"></a>00188                      <a class="code" href="unionWORD.html">WORD</a> ** <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00189"></a>00189 {
<a name="l00190"></a>00190 <span class="preprocessor">#ifndef NODMA</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;
<a name="l00192"></a>00192    <span class="keywordtype">int</span> xferlen, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00193"></a>00193    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);       <span class="comment">/* get cmd to pass to sjy_write */</span>
<a name="l00194"></a>00194    cmd |= (<a class="code" href="jorway73a_8h.html#a265108074a183035550ee1985abd3f06">SJY_Q_REPEAT</a> &lt;&lt; 16); <span class="comment">/* set q-repeat mode */</span>
<a name="l00195"></a>00195    xferlen = r * <span class="keyword">sizeof</span>(<a class="code" href="unionWORD.html">WORD</a>);  <span class="comment">/* size, in bytes, of stuff to write */</span>
<a name="l00196"></a>00196    status = <a class="code" href="jorway73a_8c.html#a747d8b2e874a5416bc88493fa21a60cd">sjy_read</a>(c, cmd, *d, xferlen);
<a name="l00197"></a>00197    *d += r;                     <span class="comment">/* assume everything got xfered */</span>
<a name="l00198"></a>00198 <span class="preprocessor">#else</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00200"></a>00200    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++) {
<a name="l00201"></a>00201       <a class="code" href="group__mcstdfunctionh.html#gad17f339ee8254f1aad6b406e50ebd4a8">cam16i</a>(c, n, a, f, *d);
<a name="l00202"></a>00202       (*d)++;
<a name="l00203"></a>00203    }
<a name="l00204"></a>00204 <span class="preprocessor">#endif</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>}
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00208"></a><a class="code" href="group__mcstdfunctionh.html#gafe207e922a73f0b30e290e830808ec61">00208</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gafe207e922a73f0b30e290e830808ec61">cam24i_r</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00209"></a>00209                      <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> ** <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211 <span class="preprocessor">#ifndef NODMA</span>
<a name="l00212"></a>00212 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;
<a name="l00213"></a>00213    <span class="keywordtype">int</span> xferlen, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00214"></a>00214    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f) | <a class="code" href="jorway73a_8h.html#a9de43c528c125741c258d75222a0d0ae">SJY_D24_MODE</a>;        <span class="comment">/* get cmd to pass to sjy_write */</span>
<a name="l00215"></a>00215    cmd |= (<a class="code" href="jorway73a_8h.html#a265108074a183035550ee1985abd3f06">SJY_Q_REPEAT</a> &lt;&lt; 16); <span class="comment">/* set q-repeat mode */</span>
<a name="l00216"></a>00216    xferlen = r * <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>); <span class="comment">/* size, in bytes, of stuff to write */</span>
<a name="l00217"></a>00217    status = <a class="code" href="jorway73a_8c.html#a747d8b2e874a5416bc88493fa21a60cd">sjy_read</a>(c, cmd, *d, xferlen);
<a name="l00218"></a>00218    *d += r;                     <span class="comment">/* assume everything got xfered... */</span>
<a name="l00219"></a>00219 <span class="preprocessor">#else</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00221"></a>00221    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++) {
<a name="l00222"></a>00222       <a class="code" href="group__mcstdfunctionh.html#ga84d45a99ef748664e1eead0a5da4d862">cam24i</a>(c, n, a, f, *d);
<a name="l00223"></a>00223       (*d)++;
<a name="l00224"></a>00224    }
<a name="l00225"></a>00225 <span class="preprocessor">#endif</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span>}
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00229"></a><a class="code" href="group__mcstdfunctionh.html#ga4a234b702b8b906b0cca1bcbdb01ca27">00229</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga4a234b702b8b906b0cca1bcbdb01ca27">cam16i_rq</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00230"></a>00230                       <a class="code" href="unionWORD.html">WORD</a> ** <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232 <span class="preprocessor">#ifndef NODMA</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;
<a name="l00234"></a>00234    <span class="keywordtype">int</span> xferlen, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00235"></a>00235    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);       <span class="comment">/* get cmd to pass to sjy_write */</span>
<a name="l00236"></a>00236    cmd |= (<a class="code" href="jorway73a_8h.html#ac2b9f0af6193f92b82c6ba98ded73586">SJY_Q_STOP</a> &lt;&lt; 16);   <span class="comment">/* set q-repeat mode */</span>
<a name="l00237"></a>00237    xferlen = r * <span class="keyword">sizeof</span>(<a class="code" href="unionWORD.html">WORD</a>);  <span class="comment">/* size, in bytes, of stuff to write */</span>
<a name="l00238"></a>00238    status = <a class="code" href="jorway73a_8c.html#a747d8b2e874a5416bc88493fa21a60cd">sjy_read</a>(c, cmd, *d, xferlen);
<a name="l00239"></a>00239    *d += (status / <span class="keyword">sizeof</span>(<a class="code" href="unionWORD.html">WORD</a>));
<a name="l00240"></a>00240 <span class="preprocessor">#else</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, x, q;
<a name="l00242"></a>00242    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++) {
<a name="l00243"></a>00243       <a class="code" href="group__mcstdfunctionh.html#ga2a515796e8020af32ea0e5aad490a170">cam16i_q</a>(c, n, a, f, (*d)++, &amp;x, &amp;q);
<a name="l00244"></a>00244       <span class="keywordflow">if</span> (!q) {
<a name="l00245"></a>00245          (*d)--;
<a name="l00246"></a>00246          <span class="keywordflow">break</span>;
<a name="l00247"></a>00247       }
<a name="l00248"></a>00248    }
<a name="l00249"></a>00249 <span class="preprocessor">#endif</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>}
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00253"></a><a class="code" href="group__mcstdfunctionh.html#ga6a2d5a0785b2ccc27fc9e2769f749b10">00253</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga6a2d5a0785b2ccc27fc9e2769f749b10">cam24i_rq</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00254"></a>00254                       <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> ** <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00255"></a>00255 {
<a name="l00256"></a>00256 <span class="preprocessor">#ifndef NODMA</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;
<a name="l00258"></a>00258    <span class="keywordtype">int</span> xferlen, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00259"></a>00259    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f) | <a class="code" href="jorway73a_8h.html#a9de43c528c125741c258d75222a0d0ae">SJY_D24_MODE</a>;        <span class="comment">/* get cmd to pass to sjy_write */</span>
<a name="l00260"></a>00260    cmd |= (<a class="code" href="jorway73a_8h.html#ac2b9f0af6193f92b82c6ba98ded73586">SJY_Q_STOP</a> &lt;&lt; 16);   <span class="comment">/* set q-repeat mode */</span>
<a name="l00261"></a>00261    xferlen = r * <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>); <span class="comment">/* size, in bytes, of stuff to write */</span>
<a name="l00262"></a>00262    fprintf(stderr, <span class="stringliteral">&quot;cam24i_rq: xferlen=%d,&quot;</span>, xferlen);
<a name="l00263"></a>00263    status = <a class="code" href="jorway73a_8c.html#a747d8b2e874a5416bc88493fa21a60cd">sjy_read</a>(c, cmd, *d, xferlen);
<a name="l00264"></a>00264    fprintf(stderr, <span class="stringliteral">&quot;status=%d\n&quot;</span>, status);
<a name="l00265"></a>00265    *d += (status / <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>));
<a name="l00266"></a>00266 <span class="preprocessor">#else</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, x, q;
<a name="l00268"></a>00268    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++) {
<a name="l00269"></a>00269       <a class="code" href="group__mcstdfunctionh.html#ga0f1b4435d6f1fea0e5787a5c2388b41c">cam24i_q</a>(c, n, a, f, (*d)++, &amp;x, &amp;q);
<a name="l00270"></a>00270       <span class="keywordflow">if</span> (!q) {
<a name="l00271"></a>00271          (*d)--;
<a name="l00272"></a>00272          <span class="keywordflow">break</span>;
<a name="l00273"></a>00273       }
<a name="l00274"></a>00274    }
<a name="l00275"></a>00275 <span class="preprocessor">#endif</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span>}
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00279"></a><a class="code" href="group__mcstdfunctionh.html#ga2486ffaca1f0a3bef21952140957febe">00279</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga2486ffaca1f0a3bef21952140957febe">cam16i_sa</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00280"></a>00280                       <a class="code" href="unionWORD.html">WORD</a> ** <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282    <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, aa;
<a name="l00283"></a>00283    aa = a;
<a name="l00284"></a>00284    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++) {
<a name="l00285"></a>00285       <a class="code" href="group__mcstdfunctionh.html#gad17f339ee8254f1aad6b406e50ebd4a8">cam16i</a>(c, n, a, f, *d);
<a name="l00286"></a>00286       aa++;
<a name="l00287"></a>00287       (*d)++;
<a name="l00288"></a>00288    }
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00292"></a><a class="code" href="group__mcstdfunctionh.html#ga77a1df9e51c7cd35efb9575e48fac6b2">00292</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga77a1df9e51c7cd35efb9575e48fac6b2">cam24i_sa</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00293"></a>00293                       <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> ** <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00294"></a>00294 {
<a name="l00295"></a>00295    <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, aa;
<a name="l00296"></a>00296    aa = a;
<a name="l00297"></a>00297    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++) {
<a name="l00298"></a>00298       <a class="code" href="group__mcstdfunctionh.html#ga84d45a99ef748664e1eead0a5da4d862">cam24i</a>(c, n, a, f, *d);
<a name="l00299"></a>00299       aa++;
<a name="l00300"></a>00300       (*d)++;
<a name="l00301"></a>00301    }
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00305"></a><a class="code" href="group__mcstdfunctionh.html#gad17ca468489b8b10bb9317a72d139a05">00305</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gad17ca468489b8b10bb9317a72d139a05">cam16i_sn</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00306"></a>00306                       <a class="code" href="unionWORD.html">WORD</a> ** <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++)
<a name="l00311"></a>00311       <a class="code" href="group__mcstdfunctionh.html#gad17f339ee8254f1aad6b406e50ebd4a8">cam16i</a>(c, n + i, a, f, (*d)++);
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00315"></a><a class="code" href="group__mcstdfunctionh.html#gaeca899e6d3a4fd8992f3556fe0f78038">00315</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gaeca899e6d3a4fd8992f3556fe0f78038">cam24i_sn</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00316"></a>00316                       <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> ** <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00319"></a>00319    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++)
<a name="l00320"></a>00320       <a class="code" href="group__mcstdfunctionh.html#ga84d45a99ef748664e1eead0a5da4d862">cam24i</a>(c, n + i, a, f, (*d)++);
<a name="l00321"></a>00321 }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00324"></a><a class="code" href="group__mcstdfunctionh.html#gaf4fc105dccac5ca09337af789f554831">00324</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gaf4fc105dccac5ca09337af789f554831">cam8o</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>)
<a name="l00325"></a>00325 {
<a name="l00326"></a>00326    fprintf(stderr, <span class="stringliteral">&quot;cam8o not implemented\n&quot;</span>);
<a name="l00327"></a>00327 }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00330"></a><a class="code" href="group__mcstdfunctionh.html#ga0c0e5e0a19205781825e673e694db77f">00330</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga0c0e5e0a19205781825e673e694db77f">camo</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332    <a class="code" href="group__mcstdfunctionh.html#gadee944c3c864999f507a2df2a50f1f1f">cam16o</a>(c, n, a, f, d);
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00336"></a><a class="code" href="group__mcstdfunctionh.html#gadee944c3c864999f507a2df2a50f1f1f">00336</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gadee944c3c864999f507a2df2a50f1f1f">cam16o</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338    <a class="code" href="group__mcstdfunctionh.html#ga971dc315017a5801f0131c4c2d396d28">cam16o_q</a>(c, n, a, f, d, &amp;<a class="code" href="jorway73a_8c.html#ada419ee69c3cc4a4db37acdbf3ef3054">xdummy</a>, &amp;<a class="code" href="jorway73a_8c.html#a484211e5ca89857f6dc2b6e4bffbd3c6">qdummy</a>);
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00342"></a><a class="code" href="group__mcstdfunctionh.html#ga9916a212b322def800695ab893b245b3">00342</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga9916a212b322def800695ab893b245b3">cam24o</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>)
<a name="l00343"></a>00343 {
<a name="l00344"></a>00344    <a class="code" href="group__mcstdfunctionh.html#gaefe50b118a37b83b19a3804a6759d8bd">cam24o_q</a>(c, n, a, f, d, &amp;<a class="code" href="jorway73a_8c.html#ada419ee69c3cc4a4db37acdbf3ef3054">xdummy</a>, &amp;<a class="code" href="jorway73a_8c.html#a484211e5ca89857f6dc2b6e4bffbd3c6">qdummy</a>);
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00348"></a><a class="code" href="group__mcstdfunctionh.html#ga971dc315017a5801f0131c4c2d396d28">00348</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga971dc315017a5801f0131c4c2d396d28">cam16o_q</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00349"></a>00349                      <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> *q)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351    <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;                     <span class="comment">/* Take a page from sjy_cfsa.c */</span>
<a name="l00352"></a>00352    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> locdat[2] = { 0, 0 };
<a name="l00353"></a>00353    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);       <span class="comment">/* get cmd to pass to sjy_read */</span>
<a name="l00354"></a>00354    <span class="comment">/* Since this is a read we don&apos;t need to check function .. I hope .. */</span>
<a name="l00355"></a>00355    cmd = cmd | (<a class="code" href="jorway73a_8h.html#ab877659030a6d4f8c5ce1a9721931e71">SJY_STOP_ON_WORD</a> &lt;&lt; 16);
<a name="l00356"></a>00356    locdat[0] = d;
<a name="l00357"></a>00357    <a class="code" href="jorway73a_8c.html#a260ae21605888a68ed82db8dd25bcac4">sjy_write</a>(c, cmd, &amp;locdat[0], <span class="keyword">sizeof</span>(<a class="code" href="unionWORD.html">WORD</a>));
<a name="l00358"></a>00358    *q = <a class="code" href="jorway73a_8c.html#a9e64e5e231f1948397c994ff2ba9b768">sjy_get_qx</a>(c);
<a name="l00359"></a>00359    *x = <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a>;            <span class="comment">/* Need to get this from global variables I guess ... */</span>
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00364"></a><a class="code" href="group__mcstdfunctionh.html#gaefe50b118a37b83b19a3804a6759d8bd">00364</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gaefe50b118a37b83b19a3804a6759d8bd">cam24o_q</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00365"></a>00365                      <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> *q)
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367    <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;                     <span class="comment">/* Take a page from sjy_cfsa.c */</span>
<a name="l00368"></a>00368    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);       <span class="comment">/* get cmd to pass to sjy_read */</span>
<a name="l00369"></a>00369    <span class="comment">/* Since this is a read we don&apos;t need to check function .. I hope .. */</span>
<a name="l00370"></a>00370    cmd = cmd | (<a class="code" href="jorway73a_8h.html#ab877659030a6d4f8c5ce1a9721931e71">SJY_STOP_ON_WORD</a> &lt;&lt; 16) | <a class="code" href="jorway73a_8h.html#a9de43c528c125741c258d75222a0d0ae">SJY_D24_MODE</a>;
<a name="l00371"></a>00371    <a class="code" href="jorway73a_8c.html#a260ae21605888a68ed82db8dd25bcac4">sjy_write</a>(c, cmd, &amp;d, <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>));
<a name="l00372"></a>00372    *q = <a class="code" href="jorway73a_8c.html#a9e64e5e231f1948397c994ff2ba9b768">sjy_get_qx</a>(c);
<a name="l00373"></a>00373    *x = <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a>;            <span class="comment">/* Need to get this from global variables I guess ... */</span>
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00377"></a><a class="code" href="group__mcstdfunctionh.html#ga6a38e31772c0376e9a709cd42d6b94e7">00377</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga6a38e31772c0376e9a709cd42d6b94e7">cam8o_r</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00378"></a>00378                     <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> * <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00379"></a>00379 {
<a name="l00380"></a>00380 }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00383"></a><a class="code" href="group__mcstdfunctionh.html#ga775c859ad1eb0a301d8716b369d43400">00383</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga775c859ad1eb0a301d8716b369d43400">cam16o_r</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00384"></a>00384                      <a class="code" href="unionWORD.html">WORD</a> * <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00385"></a>00385 {
<a name="l00386"></a>00386 <span class="preprocessor">#ifndef NODMA</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;
<a name="l00388"></a>00388    <span class="keywordtype">int</span> xferlen, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00389"></a>00389    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);       <span class="comment">/* get cmd to pass to sjy_write */</span>
<a name="l00390"></a>00390    cmd |= (<a class="code" href="jorway73a_8h.html#a265108074a183035550ee1985abd3f06">SJY_Q_REPEAT</a> &lt;&lt; 16); <span class="comment">/* set q-repeat mode */</span>
<a name="l00391"></a>00391    xferlen = r * <span class="keyword">sizeof</span>(<a class="code" href="unionWORD.html">WORD</a>);  <span class="comment">/* size, in bytes, of stuff to write */</span>
<a name="l00392"></a>00392    status = <a class="code" href="jorway73a_8c.html#a260ae21605888a68ed82db8dd25bcac4">sjy_write</a>(c, cmd, d, xferlen);
<a name="l00393"></a>00393 <span class="preprocessor">#else</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00395"></a>00395    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++) {
<a name="l00396"></a>00396       <a class="code" href="group__mcstdfunctionh.html#gadee944c3c864999f507a2df2a50f1f1f">cam16o</a>(c, n, a, f, *d);
<a name="l00397"></a>00397       d++;
<a name="l00398"></a>00398    }
<a name="l00399"></a>00399 <span class="preprocessor">#endif</span>
<a name="l00400"></a>00400 <span class="preprocessor"></span>}
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00404"></a><a class="code" href="group__mcstdfunctionh.html#gae776beaa8eae13f75edf286ed0a75a88">00404</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gae776beaa8eae13f75edf286ed0a75a88">cam24o_r</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f,
<a name="l00405"></a>00405                      <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> * <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00406"></a>00406 {
<a name="l00407"></a>00407 <span class="preprocessor">#ifndef NODMA</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;
<a name="l00409"></a>00409    <span class="keywordtype">int</span> xferlen, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00410"></a>00410    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f) | <a class="code" href="jorway73a_8h.html#a9de43c528c125741c258d75222a0d0ae">SJY_D24_MODE</a>;        <span class="comment">/* get cmd to pass to sjy_write */</span>
<a name="l00411"></a>00411    cmd |= (<a class="code" href="jorway73a_8h.html#a265108074a183035550ee1985abd3f06">SJY_Q_REPEAT</a> &lt;&lt; 16); <span class="comment">/* set q-repeat mode */</span>
<a name="l00412"></a>00412    xferlen = r * <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>); <span class="comment">/* size, in bytes, of stuff to write */</span>
<a name="l00413"></a>00413    status = <a class="code" href="jorway73a_8c.html#a260ae21605888a68ed82db8dd25bcac4">sjy_write</a>(c, cmd, d, xferlen);
<a name="l00414"></a>00414 <span class="preprocessor">#else</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00416"></a>00416    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++) {
<a name="l00417"></a>00417       <a class="code" href="group__mcstdfunctionh.html#ga9916a212b322def800695ab893b245b3">cam24o</a>(c, n, a, f, *d);
<a name="l00418"></a>00418       d++;
<a name="l00419"></a>00419    }
<a name="l00420"></a>00420 <span class="preprocessor">#endif</span>
<a name="l00421"></a>00421 <span class="preprocessor"></span>}
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00424"></a><a class="code" href="group__mcstdfunctionh.html#gabffc7c8094fc71d3e2bcd6be9cd0c9a3">00424</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">int</span> <a class="code" href="group__mcstdfunctionh.html#gabffc7c8094fc71d3e2bcd6be9cd0c9a3">camc_chk</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426    <span class="comment">/* GH:  Interpret this as being a &quot;test unit ready&quot; as far as SCSI goes */</span>
<a name="l00427"></a>00427    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, ext_add;
<a name="l00428"></a>00428    status = <a class="code" href="jorway73a_8c.html#abaa46601bf81617267a3bacefb9c9571">sjy_tur</a>(c);
<a name="l00429"></a>00429    <span class="keywordflow">if</span> (status)
<a name="l00430"></a>00430       <span class="keywordflow">return</span> (-1);
<a name="l00431"></a>00431 
<a name="l00432"></a>00432    <span class="keywordflow">return</span> (0);
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00436"></a><a class="code" href="group__mcstdfunctionh.html#ga3840e8a0619db3b383cc2829b83b8e6a">00436</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga3840e8a0619db3b383cc2829b83b8e6a">camc</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f)
<a name="l00437"></a>00437 {
<a name="l00438"></a>00438    <span class="comment">/* Non-data command */</span>
<a name="l00439"></a>00439    <a class="code" href="group__mcstdfunctionh.html#gac33eb92d1f484fe1e76fdc001eefe48b">camc_q</a>(c, n, a, f, &amp;<a class="code" href="jorway73a_8c.html#a484211e5ca89857f6dc2b6e4bffbd3c6">qdummy</a>);
<a name="l00440"></a>00440 }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00443"></a><a class="code" href="group__mcstdfunctionh.html#gac33eb92d1f484fe1e76fdc001eefe48b">00443</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gac33eb92d1f484fe1e76fdc001eefe48b">camc_q</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <span class="keywordtype">int</span> *q)
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445    <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>;
<a name="l00446"></a>00446    cmd = <a class="code" href="jorway73a_8c.html#aec7ccf0b9920b7811ff800c050bffb77">NAFCMD</a>(n, a, f);
<a name="l00447"></a>00447    <a class="code" href="jorway73a_8c.html#aa606b4f43279fe1deb0f4a7e567c2bf8">sjy_nondata</a>(c, cmd);
<a name="l00448"></a>00448    *q = <a class="code" href="jorway73a_8c.html#a9e64e5e231f1948397c994ff2ba9b768">sjy_get_qx</a>(c);
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00452"></a><a class="code" href="group__mcstdfunctionh.html#ga27478b06e734c38fc4fe80dc09800885">00452</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga27478b06e734c38fc4fe80dc09800885">camc_sa</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00453"></a>00453 {
<a name="l00454"></a>00454    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00455"></a>00455    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++)
<a name="l00456"></a>00456       <a class="code" href="group__mcstdfunctionh.html#ga3840e8a0619db3b383cc2829b83b8e6a">camc</a>(c, n, a + i, f);
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00460"></a><a class="code" href="group__mcstdfunctionh.html#gac0cc56a7f806a800509f819a91a9e1c6">00460</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gac0cc56a7f806a800509f819a91a9e1c6">camc_sn</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> f, <span class="keyword">const</span> <span class="keywordtype">int</span> r)
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00463"></a>00463    <span class="keywordflow">for</span> (i = 0; i &lt; r; i++)
<a name="l00464"></a>00464       <a class="code" href="group__mcstdfunctionh.html#ga3840e8a0619db3b383cc2829b83b8e6a">camc</a>(c, n + i, a, f);
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00468"></a>00468 
<a name="l00469"></a><a class="code" href="group__mcstdfunctionh.html#ga6c97ce64e84d233efe4de457ec495d2f">00469</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">int</span> <a class="code" href="group__mcstdfunctionh.html#ga6c97ce64e84d233efe4de457ec495d2f">cam_init</a>(<span class="keywordtype">void</span>)
<a name="l00470"></a>00470 {
<a name="l00471"></a>00471    <span class="comment">/* Not the best way to do this ... but ... */</span>
<a name="l00472"></a>00472    <span class="comment">/* I&apos;ll handle this by opening EVERY available one. */</span>
<a name="l00473"></a>00473    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00474"></a>00474    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>[72];
<a name="l00475"></a>00475    <span class="keywordflow">for</span> (c = 0; c &lt;= <a class="code" href="jorway73a_8h.html#a6c693b96884f3b4f857642ceb9b8fcd5">SJY_BRANCH_MAX</a>; c++) {
<a name="l00476"></a>00476       <a class="code" href="jorway73a_8c.html#abb2fa0b92fd9278943cf4d22794b7ced">jorway_crate_opened</a>[c] = 0;
<a name="l00477"></a>00477       status = <a class="code" href="jorway73a_8c.html#a14be9712cd9a31585f46151e6a2069c5">sjy_getdev</a>(filename, c);
<a name="l00478"></a>00478       <span class="keywordflow">if</span> (status == <a class="code" href="jorway73a_8h.html#a1ac3848cc49cd53d6f10f175d60a388b">CAM_S_SUCCESS</a>) {    <span class="comment">/* Found the device ... */</span>
<a name="l00479"></a>00479          fprintf(stderr, <span class="stringliteral">&quot;cam_init: found crate %d on device %s, open it\n&quot;</span>, c, filename);
<a name="l00480"></a>00480          <span class="keywordflow">if</span> ((status = <a class="code" href="jorway73a_8c.html#ae35e57f6c23ab35a0d10e2e31ee6666e">cdchn</a>(c, 1, 0)) == <a class="code" href="jorway73a_8h.html#a1ac3848cc49cd53d6f10f175d60a388b">CAM_S_SUCCESS</a>);       <span class="comment">/* Opened the device */</span>
<a name="l00481"></a>00481          {
<a name="l00482"></a>00482             <a class="code" href="jorway73a_8c.html#a773592bef536c643b4538c7c1aa3c8d1">ccctype</a>(c, 0, 1);   <span class="comment">/* set as parallel */</span>
<a name="l00483"></a>00483             <a class="code" href="jorway73a_8c.html#abb2fa0b92fd9278943cf4d22794b7ced">jorway_crate_opened</a>[c] = 1;
<a name="l00484"></a>00484          }
<a name="l00485"></a>00485       }
<a name="l00486"></a>00486    }                            <span class="comment">/* proceed to next crate ... */</span>
<a name="l00487"></a>00487    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00488"></a>00488 }
<a name="l00489"></a>00489 
<a name="l00490"></a>00490 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00491"></a><a class="code" href="group__mcstdfunctionh.html#ga115c540e273dd1e07d72fe82da4ba98d">00491</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga115c540e273dd1e07d72fe82da4ba98d">cam_exit</a>(<span class="keywordtype">void</span>)
<a name="l00492"></a>00492 {
<a name="l00493"></a>00493    <span class="comment">/* Not the best way to do this ... but ... */</span>
<a name="l00494"></a>00494    <span class="comment">/* I&apos;ll handle this by opening EVERY available one. */</span>
<a name="l00495"></a>00495    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00496"></a>00496    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>[72];
<a name="l00497"></a>00497    <span class="keywordflow">for</span> (c = 0; c &lt;= <a class="code" href="jorway73a_8h.html#a6c693b96884f3b4f857642ceb9b8fcd5">SJY_BRANCH_MAX</a>; c++) {
<a name="l00498"></a>00498       <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#abb2fa0b92fd9278943cf4d22794b7ced">jorway_crate_opened</a>[c] == 1) {
<a name="l00499"></a>00499          fprintf(stderr, <span class="stringliteral">&quot;cam_exit: closing crate %d\n&quot;</span>, c);
<a name="l00500"></a>00500          status = <a class="code" href="jorway73a_8c.html#ae35e57f6c23ab35a0d10e2e31ee6666e">cdchn</a>(c, 0, 0);       <span class="comment">/* Close the device */</span>
<a name="l00501"></a>00501       }
<a name="l00502"></a>00502    }                            <span class="comment">/* proceed to next crate ... */</span>
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00506"></a><a class="code" href="group__mcstdfunctionh.html#gaa171934ed8e8ce2af3ec97f4192aa27b">00506</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gaa171934ed8e8ce2af3ec97f4192aa27b">cam_inhibit_set</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>)
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508    <a class="code" href="group__mcstdfunctionh.html#ga3840e8a0619db3b383cc2829b83b8e6a">camc</a>(c, 30, 9, 26);
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00512"></a><a class="code" href="group__mcstdfunctionh.html#gaaf50e8892fd5226754befa7185c9dc3a">00512</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gaaf50e8892fd5226754befa7185c9dc3a">cam_inhibit_clear</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>)
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514    <a class="code" href="group__mcstdfunctionh.html#ga3840e8a0619db3b383cc2829b83b8e6a">camc</a>(c, 30, 9, 24);
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00518"></a><a class="code" href="group__mcstdfunctionh.html#ga9fb70c7c5fb16d3807373902b137fe3e">00518</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga9fb70c7c5fb16d3807373902b137fe3e">cam_crate_clear</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>)
<a name="l00519"></a>00519 {
<a name="l00520"></a>00520    <a class="code" href="group__mcstdfunctionh.html#ga3840e8a0619db3b383cc2829b83b8e6a">camc</a>(c, 28, 9, 26);
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00524"></a><a class="code" href="group__mcstdfunctionh.html#ga476ffc902c4674e17aa3b544781023e4">00524</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga476ffc902c4674e17aa3b544781023e4">cam_crate_zinit</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526    <a class="code" href="group__mcstdfunctionh.html#ga3840e8a0619db3b383cc2829b83b8e6a">camc</a>(c, 28, 8, 26);
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00530"></a><a class="code" href="group__mcstdfunctionh.html#ga3b676540b901e12fc4fd6a8495d612eb">00530</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga3b676540b901e12fc4fd6a8495d612eb">cam_lam_enable</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l00531"></a>00531 {
<a name="l00532"></a>00532    <span class="comment">/* enable LAM mask for slot n in controller */</span>
<a name="l00533"></a>00533    <a class="code" href="jorway73a_8c.html#ade30b3ebd96d09456989cf6da3a92e8f">jorway_crate_LAM</a>[c] |= (1 &lt;&lt; (n - 1));
<a name="l00534"></a>00534    <a class="code" href="group__mcstdfunctionh.html#ga9916a212b322def800695ab893b245b3">cam24o</a>(c, 30, 0, 16, <a class="code" href="jorway73a_8c.html#ade30b3ebd96d09456989cf6da3a92e8f">jorway_crate_LAM</a>[c]);
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00538"></a><a class="code" href="group__mcstdfunctionh.html#gac24088d63d7b5b460a93eba5fbd32518">00538</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#gac24088d63d7b5b460a93eba5fbd32518">cam_lam_disable</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540    <span class="comment">/* disable LAM mask for slot n in controller */</span>
<a name="l00541"></a>00541    <a class="code" href="jorway73a_8c.html#ade30b3ebd96d09456989cf6da3a92e8f">jorway_crate_LAM</a>[c] &amp;= ~(1 &lt;&lt; (n - 1));
<a name="l00542"></a>00542    <a class="code" href="group__mcstdfunctionh.html#ga9916a212b322def800695ab893b245b3">cam24o</a>(c, 30, 0, 16, <a class="code" href="jorway73a_8c.html#ade30b3ebd96d09456989cf6da3a92e8f">jorway_crate_LAM</a>[c]);
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00546"></a><a class="code" href="group__mcstdfunctionh.html#ga39be24f9fa9fb8601023665fe896d401">00546</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga39be24f9fa9fb8601023665fe896d401">cam_lam_read</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> * lam)
<a name="l00547"></a>00547 {
<a name="l00548"></a>00548    <a class="code" href="group__mcstdfunctionh.html#ga84d45a99ef748664e1eead0a5da4d862">cam24i</a>(c, 30, 0, 26, lam);
<a name="l00549"></a>00549 }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00552"></a><a class="code" href="group__mcstdfunctionh.html#ga1ec1e961fe6664de573a78181b2f111c">00552</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga1ec1e961fe6664de573a78181b2f111c">cam_lam_clear</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l00553"></a>00553 {
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00557"></a><a class="code" href="group__mcstdfunctionh.html#ga5d95207e772c732839b0010706c1ecc9">00557</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga5d95207e772c732839b0010706c1ecc9">cam_interrupt_enable</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>)
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559    fprintf(stderr, <span class="stringliteral">&quot;cam_interrupt_enable not implemented\n&quot;</span>);
<a name="l00560"></a>00560 }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00563"></a><a class="code" href="group__mcstdfunctionh.html#ga21c6d5bd474679bf5a810560564c7677">00563</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">void</span> <a class="code" href="group__mcstdfunctionh.html#ga21c6d5bd474679bf5a810560564c7677">cam_interrupt_disable</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>)
<a name="l00564"></a>00564 {
<a name="l00565"></a>00565    fprintf(stderr, <span class="stringliteral">&quot;cam_interrupt_disable not implemented\n&quot;</span>);
<a name="l00566"></a>00566 }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00569"></a><a class="code" href="group__mcstdfunctionh.html#ga43ddc19c70912fb0eb4091579849e2ca">00569</a> <a class="code" href="camaclx_8c.html#a2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">int</span> <a class="code" href="group__mcstdfunctionh.html#ga43ddc19c70912fb0eb4091579849e2ca">cam_init_rpc</a>(<span class="keywordtype">char</span> *<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, <span class="keywordtype">char</span> *<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <span class="keywordtype">char</span> *fe_name,
<a name="l00570"></a>00570                         <span class="keywordtype">char</span> *client_name, <span class="keywordtype">char</span> *rpc_server)
<a name="l00571"></a>00571 {
<a name="l00572"></a>00572    <span class="keywordflow">return</span> 1;
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 <span class="comment">/* Specific stuff I need to add in order to make things work </span>
<a name="l00580"></a>00580 <span class="comment">somewhat self-containedly */</span>
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 
<a name="l00583"></a><a class="code" href="jorway73a_8h.html#a9e64e5e231f1948397c994ff2ba9b768">00583</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a9e64e5e231f1948397c994ff2ba9b768">sjy_get_qx</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>)
<a name="l00584"></a>00584 {
<a name="l00585"></a>00585    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="new__fadc0_8cpp.html#a1fe855c208bc17a51a4d34fefdb2d5b1">buf</a>;
<a name="l00586"></a>00586    <span class="keywordtype">int</span> *perrno = &amp;<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[<a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch)].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a>;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588    <span class="keywordflow">if</span> (*perrno == 0) {          <span class="comment">/* all OK */</span>
<a name="l00589"></a>00589       <a class="code" href="jorway73a_8c.html#ad410b818c979ab5e33a7a55ebcf44913">ieee_last_Q</a> = 1;
<a name="l00590"></a>00590       <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a> = 1;
<a name="l00591"></a>00591    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*perrno == ENODEV) {      <span class="comment">/* non data command, no Q */</span>
<a name="l00592"></a>00592       <a class="code" href="jorway73a_8c.html#ad410b818c979ab5e33a7a55ebcf44913">ieee_last_Q</a> = 0;
<a name="l00593"></a>00593       <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a> = 1;
<a name="l00594"></a>00594    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*perrno == EPIPE) {       <span class="comment">/* bad word count transfer on pdt */</span>
<a name="l00595"></a>00595       <a class="code" href="jorway73a_8c.html#ad410b818c979ab5e33a7a55ebcf44913">ieee_last_Q</a> = 0;
<a name="l00596"></a>00596       <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a> = 0;
<a name="l00597"></a>00597    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*perrno == EIO) { <span class="comment">/* SCSI error */</span>
<a name="l00598"></a>00598       <a class="code" href="jorway73a_8c.html#ad410b818c979ab5e33a7a55ebcf44913">ieee_last_Q</a> = 0;
<a name="l00599"></a>00599       <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a> = 0;
<a name="l00600"></a>00600    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*perrno == EFAULT) {      <span class="comment">/* CAMAC error */</span>
<a name="l00601"></a>00601       <a class="code" href="jorway73a_8c.html#ad410b818c979ab5e33a7a55ebcf44913">ieee_last_Q</a> = 0;
<a name="l00602"></a>00602       <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a> = 0;
<a name="l00603"></a>00603    } <span class="keywordflow">else</span> {
<a name="l00604"></a>00604       buf = <a class="code" href="jorway73a_8c.html#ac49188b0e974187159abf586ac202535">sjy_reqSense</a>(<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[<a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch)].fd);
<a name="l00605"></a>00605       <a class="code" href="jorway73a_8c.html#ad410b818c979ab5e33a7a55ebcf44913">ieee_last_Q</a> = 1 - (buf[8] &amp; 128) / 128;
<a name="l00606"></a>00606       <a class="code" href="jorway73a_8c.html#a13c4ff3d50c50df95e1d8bfa2eaae6a5">ieee_last_X</a> = 1 - (buf[8] &amp; 64) / 64;
<a name="l00607"></a>00607    }
<a name="l00608"></a>00608 
<a name="l00609"></a>00609    <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8c.html#ad410b818c979ab5e33a7a55ebcf44913">ieee_last_Q</a>);
<a name="l00610"></a>00610 }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612 <span class="comment">/* ------ Included from sjy_interface ------- */</span>
<a name="l00613"></a>00613 
<a name="l00614"></a>00614 <span class="comment">/* #define DEBUG */</span>
<a name="l00615"></a>00615 <span class="comment">/* #define GDEBUG */</span>
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00618"></a>00618 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00619"></a>00619 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00620"></a>00620 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00621"></a>00621 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00622"></a>00622 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00623"></a>00623 <span class="comment">/*#include &lt;scsi/sg.h&gt;*/</span>
<a name="l00624"></a>00624 <span class="preprocessor">#include &quot;/usr/src/linux/include/scsi/sg.h&quot;</span>
<a name="l00625"></a><a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">00625</a> <span class="preprocessor">#define SCSI_OFF sizeof(struct sg_header)</span>
<a name="l00626"></a><a class="code" href="jorway73a_8c.html#a3d3d953032f41cf9cf6c7ff4e6a61e1b">00626</a> <span class="preprocessor"></span><span class="preprocessor">#define USER_BUF_SIZE (SG_BIG_BUFF - (SCSI_OFF + 18 + 511))</span>
<a name="l00627"></a><a class="code" href="jorway73a_8c.html#a46d8c74b5360b1df7727d0ee6de59df2">00627</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_SIZE (SCSI_OFF + 18 + USER_BUF_SIZE)</span>
<a name="l00628"></a><a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">00628</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>[<a class="code" href="jorway73a_8c.html#a46d8c74b5360b1df7727d0ee6de59df2">CMD_SIZE</a>];     <span class="comment">/* SCSI command buffer */</span>
<a name="l00629"></a>00629 
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="comment">/*</span>
<a name="l00632"></a>00632 <span class="comment">** handle_scsi_cmd - process a scsi command using the generic scsi interface</span>
<a name="l00633"></a>00633 <span class="comment">**</span>
<a name="l00634"></a>00634 <span class="comment">** returns</span>
<a name="l00635"></a>00635 <span class="comment">**  success  int status - number of bytes read minus the sizeof(sg_header)</span>
<a name="l00636"></a>00636 <span class="comment">**  fail     CAM_S_INVLD_ARG -  bad function argument</span>
<a name="l00637"></a>00637 <span class="comment">**           CAM_S_GETSEM_FAIL - failed to get semaphore</span>
<a name="l00638"></a>00638 <span class="comment">**           CAM_S_DEV_IO_ERROR - scsi write or read returned bad status </span>
<a name="l00639"></a>00639 <span class="comment">**           CAM_S_PUTSEM_FAIL - failed to release semaphore</span>
<a name="l00640"></a>00640 <span class="comment">*/</span>
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 <span class="comment">/* static */</span>
<a name="l00643"></a><a class="code" href="jorway73a_8c.html#a3f644b94d637a6cdeb3149a7740f0ce7">00643</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a3f644b94d637a6cdeb3149a7740f0ce7">handle_scsi_cmd</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>, <span class="comment">/* CAMAC branch */</span>
<a name="l00644"></a>00644                     <span class="keywordtype">unsigned</span> <a class="code" href="mscbmain_8c.html#a199b43445abff5fb124a5283dd9ab416">cmd_len</a>,   <span class="comment">/* command length */</span>
<a name="l00645"></a>00645                     <span class="keywordtype">unsigned</span> in_size,   <span class="comment">/* input data size */</span>
<a name="l00646"></a>00646                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *i_buff,      <span class="comment">/* input buffer */</span>
<a name="l00647"></a>00647                     <span class="keywordtype">int</span> out_size,       <span class="comment">/* output data size */</span>
<a name="l00648"></a>00648                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *o_buff       <span class="comment">/* output buffer */</span>
<a name="l00649"></a>00649     )
<a name="l00650"></a>00650 {
<a name="l00651"></a>00651    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a> = 0;
<a name="l00652"></a>00652    <span class="keyword">struct </span>sg_header *sg_hd;
<a name="l00653"></a>00653    sigset_t newmask, oldmask;
<a name="l00654"></a>00654    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00655"></a>00655    <span class="keywordtype">int</span> idx = <a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch);
<a name="l00656"></a>00656    <span class="keywordtype">int</span> fd = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a68e422a3b6036ac67e22f0c4b1d6ec1b">fd</a>;
<a name="l00657"></a>00657    <span class="keywordtype">int</span> defecit = 0;
<a name="l00658"></a>00658 <span class="preprocessor">#ifdef GDEBUG</span>
<a name="l00659"></a>00659 <span class="preprocessor"></span>   fflush(stderr);
<a name="l00660"></a>00660    fflush(stdin);
<a name="l00661"></a>00661    fprintf(stderr,
<a name="l00662"></a>00662            <span class="stringliteral">&quot;handle_scsi_cmd: branch=%d, idx=%d, fd=%d, cmd_len=%d, in_size=%d, ibuff=0x%x, out_size=%d, o_buff=0x%x\n&quot;</span>,
<a name="l00663"></a>00663            branch, idx, fd, cmd_len, in_size, i_buff, out_size, o_buff);
<a name="l00664"></a>00664    fprintf(stderr, <span class="stringliteral">&quot;            cmd: 0x&quot;</span>);
<a name="l00665"></a>00665    <span class="keywordflow">for</span> (i = 0; i &lt; cmd_len; i++) {
<a name="l00666"></a>00666       fprintf(stderr, <span class="stringliteral">&quot; %02x&quot;</span>, i_buff[<a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + i]);
<a name="l00667"></a>00667    }
<a name="l00668"></a>00668    fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00669"></a>00669    fflush(stderr);
<a name="l00670"></a>00670    fflush(stdin);
<a name="l00671"></a>00671 <span class="preprocessor">#endif</span>
<a name="l00672"></a>00672 <span class="preprocessor"></span>   <span class="comment">/* safety checks */</span>
<a name="l00673"></a>00673    <span class="keywordflow">if</span> (!cmd_len)
<a name="l00674"></a>00674       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a674e2b9208ac7518c826b10e9cfa90fe">CAM_S_INVLD_ARG</a>); <span class="comment">/* need a cmd_len != 0 */</span>
<a name="l00675"></a>00675    <span class="keywordflow">if</span> (!i_buff)
<a name="l00676"></a>00676       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a674e2b9208ac7518c826b10e9cfa90fe">CAM_S_INVLD_ARG</a>); <span class="comment">/* need an input buffer != NULL */</span>
<a name="l00677"></a>00677 <span class="preprocessor">#ifdef SG_BIG_BUFF</span>
<a name="l00678"></a>00678 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + cmd_len + in_size &gt; SG_BIG_BUFF)
<a name="l00679"></a>00679       <span class="keywordflow">return</span> -1;
<a name="l00680"></a>00680    <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + out_size &gt; SG_BIG_BUFF)
<a name="l00681"></a>00681       <span class="keywordflow">return</span> -1;
<a name="l00682"></a>00682 <span class="preprocessor">#else</span>
<a name="l00683"></a>00683 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + cmd_len + in_size &gt; 4096)
<a name="l00684"></a>00684       <span class="keywordflow">return</span> -1;
<a name="l00685"></a>00685    <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + out_size &gt; 4096)
<a name="l00686"></a>00686       <span class="keywordflow">return</span> -1;
<a name="l00687"></a>00687 <span class="preprocessor">#endif</span>
<a name="l00688"></a>00688 <span class="preprocessor"></span>
<a name="l00689"></a>00689    <span class="keywordflow">if</span> (!o_buff)
<a name="l00690"></a>00690       out_size = 0;
<a name="l00691"></a>00691 
<a name="l00692"></a>00692    <span class="comment">/* generic scsi device header construction */</span>
<a name="l00693"></a>00693    sg_hd = (<span class="keyword">struct </span>sg_header *) i_buff;
<a name="l00694"></a>00694    sg_hd-&gt;reply_len = <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + out_size;
<a name="l00695"></a>00695    sg_hd-&gt;twelve_byte = cmd_len == 12;
<a name="l00696"></a>00696    sg_hd-&gt;result = 0;
<a name="l00697"></a>00697 <span class="preprocessor">#if     0</span>
<a name="l00698"></a>00698 <span class="preprocessor"></span>   sg_hd-&gt;pack_len = <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + cmd_len + in_size;      <span class="comment">/* not necessary */</span>
<a name="l00699"></a>00699    sg_hd-&gt;pack_id;              <span class="comment">/* not used */</span>
<a name="l00700"></a>00700    sg_hd-&gt;other_flags;          <span class="comment">/* not used */</span>
<a name="l00701"></a>00701 <span class="preprocessor">#endif</span>
<a name="l00702"></a>00702 <span class="preprocessor"></span>
<a name="l00703"></a>00703    <span class="comment">/* protect the write/read from being interrupted by ^C */</span>
<a name="l00704"></a>00704    sigemptyset(&amp;newmask);
<a name="l00705"></a>00705    sigaddset(&amp;newmask, SIGINT);
<a name="l00706"></a>00706    <span class="comment">/*  block SIGINT and save current signal mask */</span>
<a name="l00707"></a>00707    <span class="keywordflow">if</span> (sigprocmask(SIG_BLOCK, &amp;newmask, &amp;oldmask) &lt; 0)
<a name="l00708"></a>00708       fprintf(stderr, <span class="stringliteral">&quot;sjy_interface: SIG_BLOCK error&quot;</span>);
<a name="l00709"></a>00709    <span class="comment">/* protect the write/read section for multi-user */</span>
<a name="l00710"></a>00710    <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#a2f3b012918d1fa4a5472923f5269b459">sjy_getsem</a>() != 0) {
<a name="l00711"></a>00711       fprintf(stderr, <span class="stringliteral">&quot;sjy_interface: getsem failed&quot;</span>);
<a name="l00712"></a>00712       <a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">sjy_putsem</a>();
<a name="l00713"></a>00713       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a200b91a73af5bea360d3210c88aeb545">CAM_S_GETSEM_FAIL</a>);
<a name="l00714"></a>00714    }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716    <span class="comment">/* send command */</span>
<a name="l00717"></a>00717    status = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(fd, i_buff, <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + cmd_len + in_size);
<a name="l00718"></a>00718 <span class="preprocessor">#ifndef DEBUG</span>
<a name="l00719"></a>00719 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l00720"></a>00720       <a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">sjy_putsem</a>();
<a name="l00721"></a>00721       sigprocmask(SIG_SETMASK, &amp;oldmask, NULL);
<a name="l00722"></a>00722       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a535b85f08efa0cc43a01a0ea11ab5a44">CAM_S_DEV_IO_ERROR</a>);
<a name="l00723"></a>00723    }
<a name="l00724"></a>00724 <span class="preprocessor">#endif</span>
<a name="l00725"></a>00725 <span class="preprocessor"></span>
<a name="l00726"></a>00726 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00727"></a>00727 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (status &lt; 0 || status != SCSI_OFF + cmd_len + in_size || sg_hd-&gt;result) {
<a name="l00728"></a>00728       <span class="comment">/* some error happened */</span>
<a name="l00729"></a>00729       fprintf(stderr, <span class="stringliteral">&quot;write(generic) result = 0x%x cmd = 0x%x\n&quot;</span>,
<a name="l00730"></a>00730               sg_hd-&gt;result, i_buff[<a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>]);
<a name="l00731"></a>00731       <span class="keywordflow">if</span> (status &lt; 0)
<a name="l00732"></a>00732          perror(<span class="stringliteral">&quot;sjy_interface&quot;</span>);
<a name="l00733"></a>00733       <a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">sjy_putsem</a>();
<a name="l00734"></a>00734       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a535b85f08efa0cc43a01a0ea11ab5a44">CAM_S_DEV_IO_ERROR</a>);
<a name="l00735"></a>00735    }
<a name="l00736"></a>00736 <span class="preprocessor">#endif</span>
<a name="l00737"></a>00737 <span class="preprocessor"></span>
<a name="l00738"></a>00738 
<a name="l00739"></a>00739    <span class="comment">/* Since the sg.c driver _read_ always returns the sg_header, we must</span>
<a name="l00740"></a>00740 <span class="comment">    ** provide a buffer +SCSI_OFF in size. Since i_buff was already</span>
<a name="l00741"></a>00741 <span class="comment">    ** allocated as the largest size data buffer we could use (+SCSI_OFF),</span>
<a name="l00742"></a>00742 <span class="comment">    ** we use it. We have to copy the data read back to the user&apos;s </span>
<a name="l00743"></a>00743 <span class="comment">    ** buffer, but this ultimatly saves an extra malloc call.</span>
<a name="l00744"></a>00744 <span class="comment">    */</span>
<a name="l00745"></a>00745 
<a name="l00746"></a>00746    <span class="comment">/* retrieve result */</span>
<a name="l00747"></a>00747    status = <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(fd, i_buff, <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + out_size);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749    <span class="comment">/* return the semaphore */</span>
<a name="l00750"></a>00750    <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">sjy_putsem</a>() != 0) {
<a name="l00751"></a>00751       fprintf(stderr, <span class="stringliteral">&quot;sjy_interface: getsem failed&quot;</span>);
<a name="l00752"></a>00752       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#ad5503abe4c6d4a3ccf55b6ff3d5356d8">CAM_S_PUTSEM_FAIL</a>);
<a name="l00753"></a>00753    }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755    <span class="comment">/* reset signal mask which unblocks SIGINT */</span>
<a name="l00756"></a>00756    <span class="keywordflow">if</span> (sigprocmask(SIG_SETMASK, &amp;oldmask, NULL) &lt; 0)
<a name="l00757"></a>00757       fprintf(stderr, <span class="stringliteral">&quot;sjy_interface: SIG_SETMASK error&quot;</span>);
<a name="l00758"></a>00758 
<a name="l00759"></a>00759 
<a name="l00760"></a>00760    <span class="comment">/* copy data read back to the user buffer */</span>
<a name="l00761"></a>00761    <span class="comment">/* The generic scsi driver keeps an internal buffer with the</span>
<a name="l00762"></a>00762 <span class="comment">    ** last data read, and does not clear it when a subsequent SCSI</span>
<a name="l00763"></a>00763 <span class="comment">    ** command completes with a non-zero SCSI response. sg_hd-&gt;result</span>
<a name="l00764"></a>00764 <span class="comment">    ** does not contain the SCSI response as observed from a SCSI</span>
<a name="l00765"></a>00765 <span class="comment">    ** analyzer, so it is not used. The only alternative is to test</span>
<a name="l00766"></a>00766 <span class="comment">    ** for a non-zero sense buffer sense key field returned from the</span>
<a name="l00767"></a>00767 <span class="comment">    ** Jorway. If the sense key is non-zero, the user buffer is</span>
<a name="l00768"></a>00768 <span class="comment">    ** zeroed instead of returning stale data from the internal SCSI</span>
<a name="l00769"></a>00769 <span class="comment">    ** buffer.</span>
<a name="l00770"></a>00770 <span class="comment">    */</span>
<a name="l00771"></a>00771 
<a name="l00772"></a>00772    <span class="comment">/* by rex hubbard (jorway): before doing the above, check if the</span>
<a name="l00773"></a>00773 <span class="comment">    ** sensekey is 9, indicating a transfer stopped by q-response. If</span>
<a name="l00774"></a>00774 <span class="comment">    ** so, get the defecit from the sense data and adjust the return</span>
<a name="l00775"></a>00775 <span class="comment">    ** value. The data in the internal buffer is valid, so copy it.</span>
<a name="l00776"></a>00776 <span class="comment">    */</span>
<a name="l00777"></a>00777 
<a name="l00778"></a>00778    <span class="keywordflow">if</span> (!(sg_hd-&gt;sense_buffer[<a class="code" href="jorway73a_8h.html#a124960eca55d1db5f5b3740aaecf20c5">SENSEKEY</a>])) {
<a name="l00779"></a>00779       <span class="keywordflow">if</span> (o_buff) {
<a name="l00780"></a>00780          memcpy(o_buff, i_buff + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>, out_size);
<a name="l00781"></a>00781       }
<a name="l00782"></a>00782    } <span class="keywordflow">else</span> {
<a name="l00783"></a>00783       <span class="keywordflow">if</span> (sg_hd-&gt;sense_buffer[<a class="code" href="jorway73a_8h.html#a124960eca55d1db5f5b3740aaecf20c5">SENSEKEY</a>] == 9) {
<a name="l00784"></a>00784          defecit = sg_hd-&gt;sense_buffer[4] &lt;&lt; 8 | sg_hd-&gt;sense_buffer[5];
<a name="l00785"></a>00785          defecit = defecit &lt;&lt; 8 | sg_hd-&gt;sense_buffer[6];
<a name="l00786"></a>00786          <span class="keywordflow">if</span> (o_buff) {
<a name="l00787"></a>00787             memcpy(o_buff, i_buff + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>, out_size);
<a name="l00788"></a>00788          }
<a name="l00789"></a>00789       } <span class="keywordflow">else</span>
<a name="l00790"></a>00790          bzero(o_buff, out_size);
<a name="l00791"></a>00791    }
<a name="l00792"></a>00792 
<a name="l00793"></a>00793    <span class="comment">/* save scsi status and sense buffer */</span>
<a name="l00794"></a>00794    <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a518c03b64309b9d2de5e1ce69a21cfcd">result</a> = sg_hd-&gt;result;
<a name="l00795"></a>00795    memcpy(<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].sense_buffer, sg_hd-&gt;<a class="code" href="structSJY__CONTROLLER.html#a710433678e89290ef4a40354f573dd7c">sense_buffer</a>, <a class="code" href="jorway73a_8h.html#ac474b77e8d01885c6424d845d5fc3e49">SJY_SENSE_LENGTH</a>);
<a name="l00796"></a>00796    <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#ae28328f55bc09b61571bb1bbe20119d6">target_status</a> = (sg_hd-&gt;target_status) * 2;
<a name="l00797"></a>00797 <span class="preprocessor">#ifdef GDEBUG</span>
<a name="l00798"></a>00798 <span class="preprocessor"></span>   fflush(stderr);
<a name="l00799"></a>00799    fflush(stdin);
<a name="l00800"></a>00800    fprintf(stderr, <span class="stringliteral">&quot;handle_scsi_command:  target_status=0x%x\n&quot;</span>,
<a name="l00801"></a>00801            <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].target_status);
<a name="l00802"></a>00802 <span class="preprocessor">#if 0</span>
<a name="l00803"></a>00803 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].target_status != 0) &amp;&amp;
<a name="l00804"></a>00804        (<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].target_status != 0))
<a name="l00805"></a>00805 <span class="preprocessor">#endif</span>
<a name="l00806"></a>00806 <span class="preprocessor"></span>   {
<a name="l00807"></a>00807       fprintf(stderr, <span class="stringliteral">&quot;read(generic) sense &quot;</span>
<a name="l00808"></a>00808               <span class="stringliteral">&quot;%x %x %x %x %x %x %x %x %x %x %x %x %x %x %x %x\n&quot;</span>,
<a name="l00809"></a>00809               sg_hd-&gt;sense_buffer[0], sg_hd-&gt;sense_buffer[1],
<a name="l00810"></a>00810               sg_hd-&gt;sense_buffer[2], sg_hd-&gt;sense_buffer[3],
<a name="l00811"></a>00811               sg_hd-&gt;sense_buffer[4], sg_hd-&gt;sense_buffer[5],
<a name="l00812"></a>00812               sg_hd-&gt;sense_buffer[6], sg_hd-&gt;sense_buffer[7],
<a name="l00813"></a>00813               sg_hd-&gt;sense_buffer[8], sg_hd-&gt;sense_buffer[9],
<a name="l00814"></a>00814               sg_hd-&gt;sense_buffer[10], sg_hd-&gt;sense_buffer[11],
<a name="l00815"></a>00815               sg_hd-&gt;sense_buffer[12], sg_hd-&gt;sense_buffer[13],
<a name="l00816"></a>00816               sg_hd-&gt;sense_buffer[14], sg_hd-&gt;sense_buffer[15]);
<a name="l00817"></a>00817    }
<a name="l00818"></a>00818    fflush(stderr);
<a name="l00819"></a>00819    fflush(stdin);
<a name="l00820"></a>00820 <span class="preprocessor">#endif</span>
<a name="l00821"></a>00821 <span class="preprocessor"></span>
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 
<a name="l00824"></a>00824    <span class="comment">/* Unlike the Jorway 73A, the 411S returns SCSI status CONDITION_MET</span>
<a name="l00825"></a>00825 <span class="comment">    ** (0x04) for Q=1 on a data transfer. This is converted by the </span>
<a name="l00826"></a>00826 <span class="comment">    ** generic SCSI driver sg.c to EIO (0x05). The CAMAC completion routines</span>
<a name="l00827"></a>00827 <span class="comment">    ** ignore this status, but the following code segment does not.</span>
<a name="l00828"></a>00828 <span class="comment">    */</span>
<a name="l00829"></a>00829 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (status &lt; 0 || status != SCSI_OFF + out_size || sg_hd-&gt;result) {
<a name="l00831"></a>00831       <span class="comment">/* some error happened */</span>
<a name="l00832"></a>00832       fprintf(stderr, <span class="stringliteral">&quot;read(generic) result = 0x%x cmd = 0x%x\n&quot;</span>,
<a name="l00833"></a>00833               sg_hd-&gt;result, i_buff[<a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>]);
<a name="l00834"></a>00834       fprintf(stderr, <span class="stringliteral">&quot;read(generic) sense &quot;</span>
<a name="l00835"></a>00835               <span class="stringliteral">&quot;%x %x %x %x %x %x %x %x %x %x %x %x %x %x %x %x\n&quot;</span>,
<a name="l00836"></a>00836               sg_hd-&gt;sense_buffer[0], sg_hd-&gt;sense_buffer[1],
<a name="l00837"></a>00837               sg_hd-&gt;sense_buffer[2], sg_hd-&gt;sense_buffer[3],
<a name="l00838"></a>00838               sg_hd-&gt;sense_buffer[4], sg_hd-&gt;sense_buffer[5],
<a name="l00839"></a>00839               sg_hd-&gt;sense_buffer[6], sg_hd-&gt;sense_buffer[7],
<a name="l00840"></a>00840               sg_hd-&gt;sense_buffer[8], sg_hd-&gt;sense_buffer[9],
<a name="l00841"></a>00841               sg_hd-&gt;sense_buffer[10], sg_hd-&gt;sense_buffer[11],
<a name="l00842"></a>00842               sg_hd-&gt;sense_buffer[12], sg_hd-&gt;sense_buffer[13],
<a name="l00843"></a>00843               sg_hd-&gt;sense_buffer[14], sg_hd-&gt;sense_buffer[15]);
<a name="l00844"></a>00844       <span class="keywordflow">if</span> (status &lt; 0)
<a name="l00845"></a>00845          perror(<span class="stringliteral">&quot;sjy_interface&quot;</span>);
<a name="l00846"></a>00846       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a535b85f08efa0cc43a01a0ea11ab5a44">CAM_S_DEV_IO_ERROR</a>);
<a name="l00847"></a>00847    }
<a name="l00848"></a>00848 <span class="preprocessor">#endif</span>
<a name="l00849"></a>00849 <span class="preprocessor"></span>   <span class="keywordflow">return</span> (status - <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> - defecit);
<a name="l00850"></a>00850 }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852 <span class="comment">/*</span>
<a name="l00853"></a>00853 <span class="comment">** sjy_nondata - called by CAMAC IEEE routines. Sets up scsi command block non-data commands.</span>
<a name="l00854"></a>00854 <span class="comment">**</span>
<a name="l00855"></a>00855 <span class="comment">** returns</span>
<a name="l00856"></a>00856 <span class="comment">**  int status - return status from sjy_interface</span>
<a name="l00857"></a>00857 <span class="comment">**</span>
<a name="l00858"></a>00858 <span class="comment">*/</span>
<a name="l00859"></a>00859 
<a name="l00860"></a><a class="code" href="jorway73a_8h.html#a9999a989e272ce5c40f3e8ec45db3abe">00860</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#aa606b4f43279fe1deb0f4a7e567c2bf8">sjy_nondata</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>, <span class="keywordtype">int</span> camCmd)
<a name="l00861"></a>00861 {
<a name="l00862"></a>00862    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> scmdblk[6];
<a name="l00863"></a>00863    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> lcmdblk[12];    <span class="comment">/* required for commands 0xc0-0xff */</span>
<a name="l00864"></a>00864    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cmdblk;
<a name="l00865"></a>00865    <span class="keywordtype">int</span> cmdsize;
<a name="l00866"></a>00866    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00867"></a>00867    bzero(<a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, <a class="code" href="jorway73a_8c.html#a46d8c74b5360b1df7727d0ee6de59df2">CMD_SIZE</a>);
<a name="l00868"></a>00868    <span class="comment">/* cmdblk = scmdblk; */</span>
<a name="l00869"></a>00869    cmdblk = <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a> + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>;
<a name="l00870"></a>00870    cmdsize = 6;
<a name="l00871"></a>00871    cmdblk[0] = <a class="code" href="jorway73a_8h.html#af35abc9ab1dcaf42287a9fdb2299d37d">SJY_NONDATA_CMD</a>; <span class="comment">/* Op code */</span>
<a name="l00872"></a>00872    cmdblk[1] = (camCmd &gt;&gt; 24) &amp; 0x1F;   <span class="comment">/* lun/function code */</span>
<a name="l00873"></a>00873    cmdblk[2] = (camCmd &gt;&gt; 16) &amp; 0xFF;   <span class="comment">/* mode/station */</span>
<a name="l00874"></a>00874    cmdblk[3] = (camCmd &gt;&gt; 8) &amp; 0x0F;    <span class="comment">/* address */</span>
<a name="l00875"></a>00875    cmdblk[4] = 0;               <span class="comment">/* allocation length */</span>
<a name="l00876"></a>00876    cmdblk[5] = 0;               <span class="comment">/* control byte, always 0 */</span>
<a name="l00877"></a>00877    status = <a class="code" href="jorway73a_8c.html#a3f644b94d637a6cdeb3149a7740f0ce7">handle_scsi_cmd</a>(branch, cmdsize, 0, <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, 0, NULL);
<a name="l00878"></a>00878    <span class="comment">/*     sjy_notify_camac_nondata(branch, 0, status); */</span>
<a name="l00879"></a>00879    <a class="code" href="jorway73a_8c.html#a633fe0975b0b2a310e5df3c5609f988e">notify_camac_nondata</a>(branch, 0, status);
<a name="l00880"></a>00880    <span class="keywordflow">return</span> (status);
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 <span class="comment">/*</span>
<a name="l00884"></a>00884 <span class="comment">** sjy_write - called by CAMAC IEEE routines. Sets up scsi command block for writes</span>
<a name="l00885"></a>00885 <span class="comment">**             and non-data commands.</span>
<a name="l00886"></a>00886 <span class="comment">**</span>
<a name="l00887"></a>00887 <span class="comment">** returns</span>
<a name="l00888"></a>00888 <span class="comment">**  int status - return status from sjy_interface</span>
<a name="l00889"></a>00889 <span class="comment">**</span>
<a name="l00890"></a>00890 <span class="comment">*/</span>
<a name="l00891"></a>00891 
<a name="l00892"></a><a class="code" href="jorway73a_8h.html#af96ab5fcce432e3d43d81ad49a11a3d7">00892</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a260ae21605888a68ed82db8dd25bcac4">sjy_write</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>, <span class="keywordtype">int</span> camCmd, <span class="keywordtype">void</span> *dataBuffer, <span class="keywordtype">int</span> xferlen)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> scmdblk[6];
<a name="l00895"></a>00895    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> lcmdblk[10];
<a name="l00896"></a>00896    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cmdblk;
<a name="l00897"></a>00897    <span class="keywordtype">int</span> cmdsize;
<a name="l00898"></a>00898    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900    bzero(<a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, <a class="code" href="jorway73a_8c.html#a46d8c74b5360b1df7727d0ee6de59df2">CMD_SIZE</a>);
<a name="l00901"></a>00901    <span class="keywordflow">if</span> (xferlen &lt; 256) {         <span class="comment">/* This is also the nondata command block */</span>
<a name="l00902"></a>00902       <span class="comment">/* cmdblk = scmdblk; */</span>
<a name="l00903"></a>00903       cmdblk = <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a> + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>;
<a name="l00904"></a>00904       cmdblk[0] = <a class="code" href="jorway73a_8h.html#a3c545a41be73afcaf3a8ccfef9eeaa83">SJY_SHORTXFER_DATA_CMD</a>;       <span class="comment">/* Op code */</span>
<a name="l00905"></a>00905       cmdblk[1] = (camCmd &gt;&gt; 24) &amp; 0x1F;        <span class="comment">/* lun/function code */</span>
<a name="l00906"></a>00906       cmdblk[2] = (camCmd &gt;&gt; 16) &amp; 0xFF;        <span class="comment">/* mode/station */</span>
<a name="l00907"></a>00907       cmdblk[3] = (camCmd &gt;&gt; 8) &amp; 0x0F; <span class="comment">/* address */</span>
<a name="l00908"></a>00908       cmdblk[4] = xferlen;      <span class="comment">/* allocation length */</span>
<a name="l00909"></a>00909       cmdblk[5] = 0;            <span class="comment">/* control byte, always 0 */</span>
<a name="l00910"></a>00910    } <span class="keywordflow">else</span> {
<a name="l00911"></a>00911       <span class="comment">/* cmdblk = lcmdblk; */</span>
<a name="l00912"></a>00912       cmdblk = <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a> + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>;
<a name="l00913"></a>00913       cmdblk[0] = <a class="code" href="jorway73a_8h.html#aa87531dd8450cf97b498767f5a1910a5">SJY_LONGXFER_DATA_CMD</a>;        <span class="comment">/* Op code */</span>
<a name="l00914"></a>00914       cmdblk[1] = 0;            <span class="comment">/* lun/reserved */</span>
<a name="l00915"></a>00915       cmdblk[2] = (camCmd &gt;&gt; 24) &amp; 0x1F;        <span class="comment">/* reserved/function code */</span>
<a name="l00916"></a>00916       cmdblk[3] = (camCmd &gt;&gt; 16) &amp; 0xFF;        <span class="comment">/* mode/S/station */</span>
<a name="l00917"></a>00917       cmdblk[4] = (camCmd &gt;&gt; 8) &amp; 0x0F; <span class="comment">/* address */</span>
<a name="l00918"></a>00918       cmdblk[5] = 0;            <span class="comment">/* reserved */</span>
<a name="l00919"></a>00919       cmdblk[6] = (xferlen &gt;&gt; 16) &amp; 0xFF;       <span class="comment">/* transfer length (MSB) */</span>
<a name="l00920"></a>00920       cmdblk[7] = (xferlen &gt;&gt; 8) &amp; 0xFF;
<a name="l00921"></a>00921       cmdblk[8] = xferlen &amp; 0xFF;       <span class="comment">/* transfer length (LSB) */</span>
<a name="l00922"></a>00922       cmdblk[9] = 0;            <span class="comment">/* control byte, always 0 */</span>
<a name="l00923"></a>00923    }
<a name="l00924"></a>00924    <span class="keywordflow">if</span> (cmdblk[0] == <a class="code" href="jorway73a_8h.html#a3c545a41be73afcaf3a8ccfef9eeaa83">SJY_SHORTXFER_DATA_CMD</a>)
<a name="l00925"></a>00925       cmdsize = 6;
<a name="l00926"></a>00926    <span class="keywordflow">else</span>
<a name="l00927"></a>00927       cmdsize = 10;
<a name="l00928"></a>00928 
<a name="l00929"></a>00929    <span class="comment">/* memcpy( cmd + SCSI_OFF, cmdblk, cmdsize ); */</span>
<a name="l00930"></a>00930 
<a name="l00931"></a>00931    <span class="comment">/* copy user buffer behind cmdblk */</span>
<a name="l00932"></a>00932    <span class="keywordflow">if</span> (dataBuffer != NULL)
<a name="l00933"></a>00933       memcpy(<a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a> + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + cmdsize, dataBuffer, xferlen);
<a name="l00934"></a>00934 
<a name="l00935"></a>00935    status = <a class="code" href="jorway73a_8c.html#a3f644b94d637a6cdeb3149a7740f0ce7">handle_scsi_cmd</a>(branch, cmdsize, xferlen, <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, 0, NULL);
<a name="l00936"></a>00936    <span class="comment">/*  sjy_notify_camac_data(branch, xferlen, status); */</span>
<a name="l00937"></a>00937    <a class="code" href="jorway73a_8c.html#a752fa0f75faca1883f6c404ed95d0822">notify_camac_data</a>(branch, xferlen, status);
<a name="l00938"></a>00938    <span class="keywordflow">return</span> (status);
<a name="l00939"></a>00939 }
<a name="l00940"></a>00940 
<a name="l00941"></a>00941 
<a name="l00942"></a>00942 <span class="comment">/*</span>
<a name="l00943"></a>00943 <span class="comment">** sjy_read - called by CAMAC IEEE routines. Sets up scsi command block for reads.</span>
<a name="l00944"></a>00944 <span class="comment">**</span>
<a name="l00945"></a>00945 <span class="comment">** returns</span>
<a name="l00946"></a>00946 <span class="comment">**  int status - return status from sjy_interface</span>
<a name="l00947"></a>00947 <span class="comment">**</span>
<a name="l00948"></a>00948 <span class="comment">*/</span>
<a name="l00949"></a><a class="code" href="jorway73a_8h.html#aa8d02d72bfb7c4b8e8108b3f2446f45d">00949</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a747d8b2e874a5416bc88493fa21a60cd">sjy_read</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>, <span class="keywordtype">int</span> camCmd, <span class="keywordtype">void</span> *dataBuffer, <span class="keywordtype">int</span> xferlen)
<a name="l00950"></a>00950 {
<a name="l00951"></a>00951    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> scmdblk[6];
<a name="l00952"></a>00952    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> lcmdblk[10];
<a name="l00953"></a>00953    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cmdblk;
<a name="l00954"></a>00954    <span class="keywordtype">int</span> cmdsize;
<a name="l00955"></a>00955    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00956"></a>00956    bzero(<a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, <a class="code" href="jorway73a_8c.html#a46d8c74b5360b1df7727d0ee6de59df2">CMD_SIZE</a>);        <span class="comment">/* clear cmd for case of short transfers */</span>
<a name="l00957"></a>00957    <span class="keywordflow">if</span> (xferlen &lt; 256) {
<a name="l00958"></a>00958       <span class="comment">/* cmdblk = scmdblk; */</span>
<a name="l00959"></a>00959       cmdblk = <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a> + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>;
<a name="l00960"></a>00960       cmdblk[0] = <a class="code" href="jorway73a_8h.html#a3c545a41be73afcaf3a8ccfef9eeaa83">SJY_SHORTXFER_DATA_CMD</a>;       <span class="comment">/* Op code */</span>
<a name="l00961"></a>00961       cmdblk[1] = (camCmd &gt;&gt; 24) &amp; 0x1F;        <span class="comment">/* lun/function code */</span>
<a name="l00962"></a>00962       cmdblk[2] = (camCmd &gt;&gt; 16) &amp; 0xFF;        <span class="comment">/* mode/station */</span>
<a name="l00963"></a>00963       cmdblk[3] = (camCmd &gt;&gt; 8) &amp; 0x0F; <span class="comment">/* address */</span>
<a name="l00964"></a>00964       cmdblk[4] = xferlen;      <span class="comment">/* allocation length */</span>
<a name="l00965"></a>00965       cmdblk[5] = 0;            <span class="comment">/* control byte, always 0 */</span>
<a name="l00966"></a>00966    } <span class="keywordflow">else</span> {
<a name="l00967"></a>00967       <span class="comment">/* cmdblk = lcmdblk; */</span>
<a name="l00968"></a>00968       cmdblk = <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a> + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>;
<a name="l00969"></a>00969       cmdblk[0] = <a class="code" href="jorway73a_8h.html#aa87531dd8450cf97b498767f5a1910a5">SJY_LONGXFER_DATA_CMD</a>;        <span class="comment">/* Op code */</span>
<a name="l00970"></a>00970       cmdblk[1] = 0;            <span class="comment">/* lun/reserved */</span>
<a name="l00971"></a>00971       cmdblk[2] = (camCmd &gt;&gt; 24) &amp; 0x1F;        <span class="comment">/* reserved/function code */</span>
<a name="l00972"></a>00972       cmdblk[3] = (camCmd &gt;&gt; 16) &amp; 0xFF;        <span class="comment">/* mode/S/station */</span>
<a name="l00973"></a>00973       cmdblk[4] = (camCmd &gt;&gt; 8) &amp; 0x0F; <span class="comment">/* address */</span>
<a name="l00974"></a>00974       cmdblk[5] = 0;            <span class="comment">/* reserved */</span>
<a name="l00975"></a>00975       cmdblk[6] = (xferlen &gt;&gt; 16) &amp; 0xFF;       <span class="comment">/* transfer length (MSB) */</span>
<a name="l00976"></a>00976       cmdblk[7] = (xferlen &gt;&gt; 8) &amp; 0xFF;
<a name="l00977"></a>00977       cmdblk[8] = xferlen &amp; 0xFF;       <span class="comment">/* transfer length (LSB) */</span>
<a name="l00978"></a>00978       cmdblk[9] = 0;            <span class="comment">/* control byte, always 0 */</span>
<a name="l00979"></a>00979    }
<a name="l00980"></a>00980    <span class="keywordflow">if</span> (cmdblk[0] == <a class="code" href="jorway73a_8h.html#a3c545a41be73afcaf3a8ccfef9eeaa83">SJY_SHORTXFER_DATA_CMD</a>)
<a name="l00981"></a>00981       cmdsize = 6;
<a name="l00982"></a>00982    <span class="keywordflow">else</span>
<a name="l00983"></a>00983       cmdsize = 10;
<a name="l00984"></a>00984    <span class="comment">/* memcpy( cmd + SCSI_OFF, cmdblk, cmdsize ); */</span>
<a name="l00985"></a>00985    status = <a class="code" href="jorway73a_8c.html#a3f644b94d637a6cdeb3149a7740f0ce7">handle_scsi_cmd</a>(branch, cmdsize, 0, <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, xferlen, dataBuffer);
<a name="l00986"></a>00986    <a class="code" href="jorway73a_8c.html#a752fa0f75faca1883f6c404ed95d0822">notify_camac_data</a>(branch, xferlen, status);
<a name="l00987"></a>00987    <span class="keywordflow">return</span> (status);
<a name="l00988"></a>00988 }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 <span class="comment">/*</span>
<a name="l00992"></a>00992 <span class="comment">** sjy_inquiry - request information about the JORWAY</span>
<a name="l00993"></a>00993 <span class="comment">**</span>
<a name="l00994"></a>00994 <span class="comment">** returns</span>
<a name="l00995"></a>00995 <span class="comment">**  success - pointer to a static char buffer containing inquiry data</span>
<a name="l00996"></a>00996 <span class="comment">**  fail - pointer to an empty static char buffer</span>
<a name="l00997"></a>00997 <span class="comment">**</span>
<a name="l00998"></a>00998 <span class="comment">*/</span>
<a name="l00999"></a>00999 
<a name="l01000"></a>01000 <span class="comment">/* request vendor brand and model */</span>
<a name="l01001"></a><a class="code" href="jorway73a_8h.html#a98532319de57f3181b1486ab7a3ccae0">01001</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="jorway73a_8c.html#a98532319de57f3181b1486ab7a3ccae0">sjy_inquiry</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>)
<a name="l01002"></a>01002 {
<a name="l01003"></a>01003    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> Inqbuffer[<a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + <a class="code" href="jorway73a_8h.html#ae5cff71db43dec42095a92793acef67a">INQUIRY_REPLY_LEN</a>];
<a name="l01004"></a>01004    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l01005"></a>01005    <span class="keywordtype">char</span> *cptr;
<a name="l01006"></a>01006    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmdblk[<a class="code" href="jorway73a_8h.html#ad12cdb08a4854304008dd972477503d2">INQUIRY_CMDLEN</a>] = { <a class="code" href="jorway73a_8h.html#a9b43b18ada752599850497e638cfc900">INQUIRY_CMD</a>,        <span class="comment">/* command */</span>
<a name="l01007"></a>01007       0,                        <span class="comment">/* lun/reserved */</span>
<a name="l01008"></a>01008       0,                        <span class="comment">/* page code */</span>
<a name="l01009"></a>01009       0,                        <span class="comment">/* reserved */</span>
<a name="l01010"></a>01010       <a class="code" href="jorway73a_8h.html#ae5cff71db43dec42095a92793acef67a">INQUIRY_REPLY_LEN</a>,        <span class="comment">/* allocation length */</span>
<a name="l01011"></a>01011       0
<a name="l01012"></a>01012    };                           <span class="comment">/* reserved/flag/link */</span>
<a name="l01013"></a>01013 
<a name="l01014"></a>01014    memcpy(<a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a> + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>, cmdblk, <span class="keyword">sizeof</span>(cmdblk));
<a name="l01015"></a>01015    <span class="comment">/* clear the Inquiry buffer */</span>
<a name="l01016"></a>01016    <span class="comment">/*memset( Inqbuffer, &apos;\0&apos;, sizeof(Inqbuffer) ); */</span>
<a name="l01017"></a>01017 
<a name="l01018"></a>01018    <a class="code" href="jorway73a_8c.html#a3f644b94d637a6cdeb3149a7740f0ce7">handle_scsi_cmd</a>(branch, <span class="keyword">sizeof</span>(cmdblk), 0, <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>,
<a name="l01019"></a>01019                    <span class="keyword">sizeof</span>(Inqbuffer) - <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>, Inqbuffer);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021    <span class="comment">/* handle_scsi_cmd removes sg_header in the copy from i_buff to o_buff,</span>
<a name="l01022"></a>01022 <span class="comment">    ** so don&apos;t add SCSI_OFF offset to Inqbuffer</span>
<a name="l01023"></a>01023 <span class="comment">    */</span>
<a name="l01024"></a>01024    <span class="comment">/*</span>
<a name="l01025"></a>01025 <span class="comment">      fprintf(stderr,&quot;Inquiry buffer\n&quot;);</span>
<a name="l01026"></a>01026 <span class="comment">      fprintf(stderr,&quot;%s\n&quot;,Inqbuffer+INQUIRY_VENDOR);</span>
<a name="l01027"></a>01027 <span class="comment">    */</span>
<a name="l01028"></a>01028    <span class="keywordflow">return</span> (Inqbuffer);
<a name="l01029"></a>01029 }
<a name="l01030"></a>01030 
<a name="l01031"></a>01031 
<a name="l01032"></a>01032 <span class="comment">/*</span>
<a name="l01033"></a>01033 <span class="comment">** sjy_tur - sends Test Unit Ready command</span>
<a name="l01034"></a>01034 <span class="comment">**</span>
<a name="l01035"></a>01035 <span class="comment">** returns</span>
<a name="l01036"></a>01036 <span class="comment">**  int status - return status from sjy_interface </span>
<a name="l01037"></a>01037 <span class="comment">*/</span>
<a name="l01038"></a>01038 
<a name="l01039"></a><a class="code" href="jorway73a_8h.html#abaa46601bf81617267a3bacefb9c9571">01039</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#abaa46601bf81617267a3bacefb9c9571">sjy_tur</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>)
<a name="l01040"></a>01040 {
<a name="l01041"></a>01041    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l01042"></a>01042    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01043"></a>01043    <span class="comment">/* request READY status */</span>
<a name="l01044"></a>01044    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmdblk[<a class="code" href="jorway73a_8h.html#a513670ae627acc78cc128c1236ccf5c0">TESTUNITREADY_CMDLEN</a>] = {
<a name="l01045"></a>01045       <a class="code" href="jorway73a_8h.html#a1f7935b5a2b87b036c8dd4b17b106a69">TESTUNITREADY_CMD</a>,        <span class="comment">/* command */</span>
<a name="l01046"></a>01046       0,                        <span class="comment">/* lun/reserved */</span>
<a name="l01047"></a>01047       0,                        <span class="comment">/* reserved */</span>
<a name="l01048"></a>01048       0,                        <span class="comment">/* reserved */</span>
<a name="l01049"></a>01049       0,                        <span class="comment">/* reserved */</span>
<a name="l01050"></a>01050       0
<a name="l01051"></a>01051    };                           <span class="comment">/* reserved */</span>
<a name="l01052"></a>01052 
<a name="l01053"></a>01053    memcpy(<a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a> + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>, cmdblk, <span class="keyword">sizeof</span>(cmdblk));
<a name="l01054"></a>01054    <span class="comment">/* This must be done twice to get good status from power cycled Jorway */</span>
<a name="l01055"></a>01055    <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l01056"></a>01056       status = <a class="code" href="jorway73a_8c.html#a3f644b94d637a6cdeb3149a7740f0ce7">handle_scsi_cmd</a>(branch, <span class="keyword">sizeof</span>(cmdblk), 0, <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, 0, NULL);
<a name="l01057"></a>01057    }
<a name="l01058"></a>01058    <span class="keywordflow">if</span> (status)
<a name="l01059"></a>01059       perror(<span class="stringliteral">&quot;sjy_tur&quot;</span>);
<a name="l01060"></a>01060 
<a name="l01061"></a>01061    <span class="keywordflow">return</span> (status);
<a name="l01062"></a>01062 }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064 
<a name="l01065"></a>01065 
<a name="l01066"></a>01066 <span class="comment">/*</span>
<a name="l01067"></a>01067 <span class="comment">** sjy_reqSense - REQUEST_SENSE from the JORWAY. Normally issued after a CHECK</span>
<a name="l01068"></a>01068 <span class="comment">**                CONDITION status is returned by any command.</span>
<a name="l01069"></a>01069 <span class="comment">**</span>
<a name="l01070"></a>01070 <span class="comment">** returns</span>
<a name="l01071"></a>01071 <span class="comment">**  success - pointer to a static char buffer containing sense data</span>
<a name="l01072"></a>01072 <span class="comment">**  fail - pointer to an empty static char buffer</span>
<a name="l01073"></a>01073 <span class="comment">**</span>
<a name="l01074"></a>01074 <span class="comment">*/</span>
<a name="l01075"></a>01075 
<a name="l01076"></a><a class="code" href="jorway73a_8h.html#ac49188b0e974187159abf586ac202535">01076</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="jorway73a_8c.html#ac49188b0e974187159abf586ac202535">sjy_reqSense</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>)
<a name="l01077"></a>01077 {
<a name="l01078"></a>01078    <span class="keywordtype">int</span> idx = <a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch);
<a name="l01079"></a>01079    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> sensebuffer[<a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a> + <a class="code" href="jorway73a_8h.html#ac474b77e8d01885c6424d845d5fc3e49">SJY_SENSE_LENGTH</a>];
<a name="l01080"></a>01080 
<a name="l01081"></a>01081    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmdblk[<a class="code" href="jorway73a_8h.html#a20938c36cf8bdcce71855f0a74344c29">SENSE_CMDLEN</a>] = { <a class="code" href="jorway73a_8h.html#aece055c47e8513782fe09c6f88d52888">SENSE_CMD</a>,    <span class="comment">/* command */</span>
<a name="l01082"></a>01082       0,                        <span class="comment">/* lun/reserved */</span>
<a name="l01083"></a>01083       0,                        <span class="comment">/* reserved */</span>
<a name="l01084"></a>01084       0,                        <span class="comment">/* reserved */</span>
<a name="l01085"></a>01085       <a class="code" href="jorway73a_8h.html#ac474b77e8d01885c6424d845d5fc3e49">SJY_SENSE_LENGTH</a>,         <span class="comment">/* allocation length */</span>
<a name="l01086"></a>01086       0
<a name="l01087"></a>01087    };                           <span class="comment">/* reserved/flag/link */</span>
<a name="l01088"></a>01088 
<a name="l01089"></a>01089    memcpy(<a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a> + <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>, cmdblk, <span class="keyword">sizeof</span>(cmdblk));
<a name="l01090"></a>01090 
<a name="l01091"></a>01091    memset(sensebuffer, <span class="charliteral">&apos;\0&apos;</span>, <span class="keyword">sizeof</span>(sensebuffer));
<a name="l01092"></a>01092 
<a name="l01093"></a>01093    <a class="code" href="jorway73a_8c.html#a3f644b94d637a6cdeb3149a7740f0ce7">handle_scsi_cmd</a>(<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].fd, <span class="keyword">sizeof</span>(cmdblk), 0, <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>,
<a name="l01094"></a>01094                    <span class="keyword">sizeof</span>(sensebuffer) - <a class="code" href="jorway73a_8c.html#a552de447eaedaa97ddef2175bbe28b04">SCSI_OFF</a>, sensebuffer);
<a name="l01095"></a>01095 
<a name="l01096"></a>01096    <span class="comment">/* handle_scsi_cmd removes sg_header in the copy from i_buff to o_buff,</span>
<a name="l01097"></a>01097 <span class="comment">    ** so don&apos;t add SCSI_OFF offset to sensebuffer</span>
<a name="l01098"></a>01098 <span class="comment">    */</span>
<a name="l01099"></a>01099    <span class="keywordflow">return</span> (sensebuffer);
<a name="l01100"></a>01100 }
<a name="l01101"></a>01101 
<a name="l01102"></a>01102 
<a name="l01103"></a>01103 <span class="comment">/*</span>
<a name="l01104"></a>01104 <span class="comment">** sjy_notify_camac_data - SCSI command completion notification routine</span>
<a name="l01105"></a>01105 <span class="comment">**                         for CAMAC data transfers</span>
<a name="l01106"></a>01106 <span class="comment">**</span>
<a name="l01107"></a>01107 <span class="comment">** returns</span>
<a name="l01108"></a>01108 <span class="comment">**  int result - SCSI command completion result</span>
<a name="l01109"></a>01109 <span class="comment">*/</span>
<a name="l01110"></a>01110 
<a name="l01111"></a><a class="code" href="jorway73a_8h.html#adef903ece5a5b959f2d4fa1a43a47f1f">01111</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a13053d959bb40e97cfabd4089e70e8ec">sjy_notify_camac_data</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>,   <span class="comment">/* CAMAC branch */</span>
<a name="l01112"></a>01112                           <span class="keywordtype">int</span> xferlen,  <span class="comment">/* expected transfer length */</span>
<a name="l01113"></a>01113                           <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>)
<a name="l01114"></a>01114 {                               <span class="comment">/* actual transfer length */</span>
<a name="l01115"></a>01115    <span class="keywordtype">int</span> idx = <a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch);
<a name="l01116"></a>01116    <span class="keywordtype">int</span> sense_key = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a710433678e89290ef4a40354f573dd7c">sense_buffer</a>[<a class="code" href="jorway73a_8h.html#a124960eca55d1db5f5b3740aaecf20c5">SENSEKEY</a>];
<a name="l01117"></a>01117    <span class="keywordtype">int</span> add_sense = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a710433678e89290ef4a40354f573dd7c">sense_buffer</a>[<a class="code" href="jorway73a_8h.html#a23341b08faa22fce2b643daa0747ecd3">ADD_SENSECODE</a>];
<a name="l01118"></a>01118 
<a name="l01119"></a>01119 
<a name="l01120"></a>01120    <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = 0;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122    <span class="keywordflow">if</span> (sense_key) {
<a name="l01123"></a>01123       <span class="keywordflow">if</span> (add_sense == <a class="code" href="jorway73a_8h.html#a5418ec10543df88aa19ad79fe4405fcd">SJY_NO_Q</a>) {
<a name="l01124"></a>01124          <span class="comment">/* SCSI ok, CAMAC ok, no Q on transfer */</span>
<a name="l01125"></a>01125          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = ENODEV;
<a name="l01126"></a>01126       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (add_sense == <a class="code" href="jorway73a_8h.html#af2c6ac80f5695f8644677557d3021367">SJY_NO_X</a>) {
<a name="l01127"></a>01127          <span class="comment">/* SCSI ok, no X on transfer */</span>
<a name="l01128"></a>01128          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = EFAULT;
<a name="l01129"></a>01129       } <span class="keywordflow">else</span> {
<a name="l01130"></a>01130          <span class="comment">/* SCSI problem */</span>
<a name="l01131"></a>01131          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = EIO;
<a name="l01132"></a>01132       }
<a name="l01133"></a>01133    } <span class="keywordflow">else</span> {
<a name="l01134"></a>01134       <span class="keywordflow">if</span> (status == xferlen) {
<a name="l01135"></a>01135          <span class="comment">/* SCSI ok, CAMAC ok, assuming Q on transfer */</span>
<a name="l01136"></a>01136          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = 0;
<a name="l01137"></a>01137       }
<a name="l01138"></a>01138    }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140    <span class="keywordflow">return</span> <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a518c03b64309b9d2de5e1ce69a21cfcd">result</a>;
<a name="l01141"></a>01141 }
<a name="l01142"></a>01142 
<a name="l01143"></a>01143 
<a name="l01144"></a>01144 <span class="comment">/*</span>
<a name="l01145"></a>01145 <span class="comment">** sjy_notify_camac_nondata - SCSI command completion notification routine</span>
<a name="l01146"></a>01146 <span class="comment">**                            for CAMAC nondata transfers</span>
<a name="l01147"></a>01147 <span class="comment">**</span>
<a name="l01148"></a>01148 <span class="comment">** returns</span>
<a name="l01149"></a>01149 <span class="comment">**  int result - SCSI command completion result</span>
<a name="l01150"></a>01150 <span class="comment">*/</span>
<a name="l01151"></a>01151 
<a name="l01152"></a><a class="code" href="jorway73a_8h.html#abb0654ee284ce6f2c39b5b3a46ebfce0">01152</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#af75bfa9a3a209871ec6e27c4916df2d5">sjy_notify_camac_nondata</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>,        <span class="comment">/* CAMAC branch */</span>
<a name="l01153"></a>01153                              <span class="keywordtype">int</span> xferlen,       <span class="comment">/* expected transfer length */</span>
<a name="l01154"></a>01154                              <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>)
<a name="l01155"></a>01155 {                               <span class="comment">/* actual transfer length */</span>
<a name="l01156"></a>01156    <span class="keywordtype">int</span> idx = <a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch);
<a name="l01157"></a>01157    <span class="keywordtype">int</span> sense_key = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a710433678e89290ef4a40354f573dd7c">sense_buffer</a>[<a class="code" href="jorway73a_8h.html#a124960eca55d1db5f5b3740aaecf20c5">SENSEKEY</a>];
<a name="l01158"></a>01158    <span class="keywordtype">int</span> add_sense = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a710433678e89290ef4a40354f573dd7c">sense_buffer</a>[<a class="code" href="jorway73a_8h.html#a23341b08faa22fce2b643daa0747ecd3">ADD_SENSECODE</a>];
<a name="l01159"></a>01159 
<a name="l01160"></a>01160    <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = 0;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162    <span class="keywordflow">if</span> ((<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].result == <a class="code" href="jorway73a_8h.html#a013491703e205687f3e9205fed9b4334">SJY_GOOD</a>) &amp;&amp; !(sense_key)) {
<a name="l01163"></a>01163       <span class="comment">/* SCSI ok. CAMAC ok, no Q on transfer */</span>
<a name="l01164"></a>01164       <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = ENODEV;
<a name="l01165"></a>01165    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].result == <a class="code" href="jorway73a_8h.html#a52ca2b8dd2a270cb2582da93e4790f6d">SJY_CHECK_CONDITION</a>)
<a name="l01166"></a>01166               || (sense_key)) {
<a name="l01167"></a>01167       <span class="keywordflow">if</span> (add_sense == <a class="code" href="jorway73a_8h.html#a5418ec10543df88aa19ad79fe4405fcd">SJY_NO_Q</a>) {
<a name="l01168"></a>01168          <span class="comment">/* SCSI ok, CAMAC ok, no Q on transfer */</span>
<a name="l01169"></a>01169          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = ENODEV;
<a name="l01170"></a>01170       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (add_sense == <a class="code" href="jorway73a_8h.html#af2c6ac80f5695f8644677557d3021367">SJY_NO_X</a>) {       <span class="comment">/* SCSI ok, no X on transfer */</span>
<a name="l01171"></a>01171          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = EFAULT;
<a name="l01172"></a>01172       } <span class="keywordflow">else</span> {                  <span class="comment">/* SCSI problem */</span>
<a name="l01173"></a>01173          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = EIO;
<a name="l01174"></a>01174       }
<a name="l01175"></a>01175    } <span class="keywordflow">else</span> {                     <span class="comment">/* SCSI ok, CAMAC ok, assuming Q on transfer */</span>
<a name="l01176"></a>01176       <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = 0;
<a name="l01177"></a>01177    }
<a name="l01178"></a>01178    <span class="keywordflow">return</span> <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a518c03b64309b9d2de5e1ce69a21cfcd">result</a>;
<a name="l01179"></a>01179 }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181 
<a name="l01182"></a>01182 <span class="comment">/* ------ End of Included from sjy_interface ------------------- --- */</span>
<a name="l01183"></a>01183 
<a name="l01184"></a>01184 <span class="comment">/* sjy_cdchn.c */</span>
<a name="l01185"></a>01185 
<a name="l01186"></a>01186 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l01187"></a>01187 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l01188"></a>01188 
<a name="l01189"></a>01189 <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a14be9712cd9a31585f46151e6a2069c5">sjy_getdev</a>(<span class="keywordtype">char</span> *<a class="code" href="vmedrv_8c.html#a8910285a0352a5c710e65ec9ecbe32a1">dev</a>, <span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>);
<a name="l01190"></a>01190 
<a name="l01191"></a>01191 
<a name="l01192"></a><a class="code" href="jorway73a_8c.html#ae35e57f6c23ab35a0d10e2e31ee6666e">01192</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#ae35e57f6c23ab35a0d10e2e31ee6666e">cdchn</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>, <span class="keywordtype">int</span> <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>, <span class="keywordtype">int</span> route)
<a name="l01193"></a>01193 {
<a name="l01194"></a>01194    <span class="comment">/* -----------------------------------------------------------------------   */</span>
<a name="l01195"></a>01195    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>[72];
<a name="l01196"></a>01196    <span class="keywordtype">char</span> version[6];
<a name="l01197"></a>01197    <span class="keywordtype">int</span> fd;
<a name="l01198"></a>01198    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01199"></a>01199    <span class="keyword">struct </span>stat buf;
<a name="l01200"></a>01200    <span class="keywordtype">char</span> <a class="code" href="vmedrv_8c.html#a8910285a0352a5c710e65ec9ecbe32a1">dev</a>[32];
<a name="l01201"></a>01201    <span class="keywordtype">int</span> idx = <a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch);
<a name="l01202"></a>01202 
<a name="l01203"></a>01203 
<a name="l01204"></a>01204    <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8h.html#a4bfe115debc7f472dd7dfe4ef9679ca0">ID</a>(branch) &lt; 0 || <a class="code" href="jorway73a_8h.html#a4bfe115debc7f472dd7dfe4ef9679ca0">ID</a>(branch) &gt; <a class="code" href="jorway73a_8h.html#a6c693b96884f3b4f857642ceb9b8fcd5">SJY_BRANCH_MAX</a>)
<a name="l01205"></a>01205       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a41b625c282f10f6477f1b363bf0c6965">CAM_S_INVLD_BRANCH</a>);
<a name="l01206"></a>01206 
<a name="l01207"></a>01207    <span class="comment">/* close the SCSI device file */</span>
<a name="l01208"></a>01208    <span class="keywordflow">if</span> (channel == 0) {
<a name="l01209"></a>01209       <span class="keywordflow">if</span> (fstat(<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].fd, &amp;buf) != -1) {
<a name="l01210"></a>01210          close(<a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].fd);
<a name="l01211"></a>01211          <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a1ac3848cc49cd53d6f10f175d60a388b">CAM_S_SUCCESS</a>);
<a name="l01212"></a>01212       }
<a name="l01213"></a>01213       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a1e1f094d3201da2f95ee1954152285cd">CAM_S_SCSI_CLOSE_FAIL</a>);
<a name="l01214"></a>01214    }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216    <span class="comment">/* find the scsi device name based on our SCSI id and SCSI bus */</span>
<a name="l01217"></a>01217    status = <a class="code" href="jorway73a_8c.html#a14be9712cd9a31585f46151e6a2069c5">sjy_getdev</a>(filename, branch);
<a name="l01218"></a>01218    <span class="keywordflow">if</span> (status != <a class="code" href="jorway73a_8h.html#a1ac3848cc49cd53d6f10f175d60a388b">CAM_S_SUCCESS</a>) {
<a name="l01219"></a>01219       fprintf(stderr, <span class="stringliteral">&quot;CDCHN Error finding generic scsi device\n&quot;</span>);
<a name="l01220"></a>01220       <span class="keywordflow">return</span> (status);
<a name="l01221"></a>01221    }
<a name="l01222"></a>01222 
<a name="l01223"></a>01223    <span class="comment">/* create the semaphore */</span>
<a name="l01224"></a>01224    <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#abd733caa05d3cc5b9dc090f7993fedca">sjy_inisem</a>() == -1) {
<a name="l01225"></a>01225       perror(<span class="stringliteral">&quot;cdchn: inisem&quot;</span>);
<a name="l01226"></a>01226       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#ab00027438f0ff85c29802d8113dbd220">CAM_S_SEM_FAIL</a>);
<a name="l01227"></a>01227    }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229    <span class="comment">/* reserve the semaphore */</span>
<a name="l01230"></a>01230    <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#a2f3b012918d1fa4a5472923f5269b459">sjy_getsem</a>() != 0) {
<a name="l01231"></a>01231       perror(<span class="stringliteral">&quot;cdchn: getsem&quot;</span>);
<a name="l01232"></a>01232       <a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">sjy_putsem</a>();
<a name="l01233"></a>01233       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a200b91a73af5bea360d3210c88aeb545">CAM_S_GETSEM_FAIL</a>);
<a name="l01234"></a>01234    }
<a name="l01235"></a>01235 
<a name="l01236"></a>01236    <span class="comment">/* open the scsi device file */</span>
<a name="l01237"></a>01237    <span class="keywordflow">if</span> ((fd = open(filename, O_RDWR)) == -1) {
<a name="l01238"></a>01238       fprintf(stderr, <span class="stringliteral">&quot;CDCHN Error opening %s\n&quot;</span>, filename);
<a name="l01239"></a>01239       perror(<span class="stringliteral">&quot;CDCHN&quot;</span>);
<a name="l01240"></a>01240       <a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">sjy_putsem</a>();
<a name="l01241"></a>01241       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#aa17d92ecacf9147e61c078f172641f3c">CAM_S_DEV_OPEN_FAIL</a>);
<a name="l01242"></a>01242    }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244    <span class="comment">/* release the semaphore */</span>
<a name="l01245"></a>01245    <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">sjy_putsem</a>() != 0) {
<a name="l01246"></a>01246       perror(<span class="stringliteral">&quot;cdchn: putsem&quot;</span>);
<a name="l01247"></a>01247       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#ad5503abe4c6d4a3ccf55b6ff3d5356d8">CAM_S_PUTSEM_FAIL</a>);
<a name="l01248"></a>01248    }
<a name="l01249"></a>01249 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01250"></a>01250 <span class="preprocessor"></span>   fprintf(stderr, <span class="stringliteral">&quot;cdchn: filename = %s  fd = %d\n&quot;</span>, filename, fd);
<a name="l01251"></a>01251 <span class="preprocessor">#endif</span>
<a name="l01252"></a>01252 <span class="preprocessor"></span>
<a name="l01253"></a>01253    <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#ab4c172d309a87e863b12e6680096dca6">scsi_id</a> = <a class="code" href="jorway73a_8h.html#a4bfe115debc7f472dd7dfe4ef9679ca0">ID</a>(branch);
<a name="l01254"></a>01254    <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#af40442a6deafc9e8d82226bf899edff9">scsi_bus</a> = <a class="code" href="jorway73a_8h.html#a862084ca8bda595e2744a6d53d02917d">BUS</a>(branch);
<a name="l01255"></a>01255    <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a740859990b816d64b872b646fd09ea7f">serial</a> = 1;      <span class="comment">/* assume serial */</span>
<a name="l01256"></a>01256    <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a68e422a3b6036ac67e22f0c4b1d6ec1b">fd</a> = fd;
<a name="l01257"></a>01257 
<a name="l01258"></a>01258    <span class="comment">/* Send two Test Unit Ready Commands to Jorway */</span>
<a name="l01259"></a>01259    status = <a class="code" href="jorway73a_8c.html#abaa46601bf81617267a3bacefb9c9571">sjy_tur</a>(branch);
<a name="l01260"></a>01260    <span class="keywordflow">if</span> (status) {                <span class="comment">/* 0=success */</span>
<a name="l01261"></a>01261       fprintf(stderr, <span class="stringliteral">&quot;CDCHN Error executing Test Unit Ready\n&quot;</span>);
<a name="l01262"></a>01262       perror(<span class="stringliteral">&quot;cdchn&quot;</span>);
<a name="l01263"></a>01263       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#aa17d92ecacf9147e61c078f172641f3c">CAM_S_DEV_OPEN_FAIL</a>);
<a name="l01264"></a>01264    }
<a name="l01265"></a>01265 
<a name="l01266"></a>01266    <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a1ac3848cc49cd53d6f10f175d60a388b">CAM_S_SUCCESS</a>);
<a name="l01267"></a>01267 }
<a name="l01268"></a>01268 
<a name="l01269"></a><a class="code" href="jorway73a_8c.html#a46c254f440287e2529e83c8e49ed37ad">01269</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="jorway73a_8c.html#a46c254f440287e2529e83c8e49ed37ad">devtble</a>[] = { <span class="stringliteral">&quot;/dev/sga&quot;</span>,  <span class="comment">/* scsi generic devices */</span>
<a name="l01270"></a>01270    <span class="stringliteral">&quot;/dev/sgb&quot;</span>,
<a name="l01271"></a>01271    <span class="stringliteral">&quot;/dev/sgc&quot;</span>,
<a name="l01272"></a>01272    <span class="stringliteral">&quot;/dev/sgd&quot;</span>,
<a name="l01273"></a>01273    <span class="stringliteral">&quot;/dev/sge&quot;</span>,
<a name="l01274"></a>01274    <span class="stringliteral">&quot;/dev/sgf&quot;</span>,
<a name="l01275"></a>01275    <span class="stringliteral">&quot;/dev/sgh&quot;</span>,
<a name="l01276"></a>01276    <span class="stringliteral">&quot;/dev/sgg&quot;</span>,
<a name="l01277"></a>01277    <span class="stringliteral">&quot;/dev/sgh&quot;</span>
<a name="l01278"></a>01278 };
<a name="l01279"></a>01279 
<a name="l01280"></a><a class="code" href="jorway73a_8c.html#a14be9712cd9a31585f46151e6a2069c5">01280</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a14be9712cd9a31585f46151e6a2069c5">sjy_getdev</a>(<span class="keywordtype">char</span> *<a class="code" href="vmedrv_8c.html#a8910285a0352a5c710e65ec9ecbe32a1">dev</a>, <span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>)
<a name="l01281"></a>01281 {
<a name="l01282"></a>01282    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a> = 0;
<a name="l01283"></a>01283    <span class="keywordtype">char</span> charBuff[120];          <span class="comment">/* file line buffer */</span>
<a name="l01284"></a>01284 
<a name="l01285"></a>01285    FILE *g_rfp;                 <span class="comment">/* /proc/scsi/scsi file descriptor */</span>
<a name="l01286"></a>01286    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>[32] = { <span class="stringliteral">&quot;/proc/scsi/scsi&quot;</span> };   <span class="comment">/* file describing SCSI devices attached to system */</span>
<a name="l01287"></a>01287    <span class="keywordtype">int</span> bus;                     <span class="comment">/* SCSI bus */</span>
<a name="l01288"></a>01288    <span class="keywordtype">int</span> id;                      <span class="comment">/* SCSI id */</span>
<a name="l01289"></a>01289    <span class="keywordtype">char</span> vendor[10];             <span class="comment">/* SCSI device vendor */</span>
<a name="l01290"></a>01290    <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>[10];               <span class="comment">/* SCSI device type */</span>
<a name="l01291"></a>01291    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a408216eef095a35ba3963fc6f4f4d7a8">found</a> = 0;               <span class="comment">/* Jorway found flag */</span>
<a name="l01292"></a>01292    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a> = 0;                   <span class="comment">/* devtble index */</span>
<a name="l01293"></a>01293    <span class="keywordtype">int</span> devtblesz = 9;           <span class="comment">/* size of devtble */</span>
<a name="l01294"></a>01294 
<a name="l01295"></a>01295 
<a name="l01296"></a>01296    <span class="comment">/* open /proc/scsi/scsi */</span>
<a name="l01297"></a>01297    g_rfp = fopen(filename, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l01298"></a>01298    <span class="keywordflow">if</span> (g_rfp == NULL) {
<a name="l01299"></a>01299       fprintf(stderr, <span class="stringliteral">&quot;ScanSCSIDevices:  Cannot open %s&quot;</span>, filename);
<a name="l01300"></a>01300       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#aa17d92ecacf9147e61c078f172641f3c">CAM_S_DEV_OPEN_FAIL</a>);
<a name="l01301"></a>01301    }
<a name="l01302"></a>01302 
<a name="l01303"></a>01303    <span class="comment">/* read each line of filename */</span>
<a name="l01304"></a>01304    <span class="keywordflow">while</span> ((status == 0) &amp;&amp; (i &lt; devtblesz)) {
<a name="l01305"></a>01305 
<a name="l01306"></a>01306       status = <a class="code" href="jorway73a_8c.html#ae47975bb7a79b90263d39eca758397de">readFile</a>(g_rfp, filename, charBuff, <span class="keyword">sizeof</span>(charBuff));
<a name="l01307"></a>01307       <span class="keywordflow">if</span> (status == EOF) {      <span class="comment">/* end of file */</span>
<a name="l01308"></a>01308 
<a name="l01309"></a>01309          <span class="keywordflow">if</span> (!found)
<a name="l01310"></a>01310             status = <a class="code" href="jorway73a_8h.html#aa17d92ecacf9147e61c078f172641f3c">CAM_S_DEV_OPEN_FAIL</a>;
<a name="l01311"></a>01311          <span class="keywordflow">break</span>;
<a name="l01312"></a>01312 
<a name="l01313"></a>01313       } <span class="keywordflow">else</span> {                  <span class="comment">/* parse the file line */</span>
<a name="l01314"></a>01314 
<a name="l01315"></a>01315          <span class="comment">/* parse the Host line */</span>
<a name="l01316"></a>01316          <span class="keywordflow">if</span> (strncmp(charBuff, <span class="stringliteral">&quot;Host&quot;</span>, 4) == 0) {
<a name="l01317"></a>01317             sscanf(&amp;charBuff[10], <span class="stringliteral">&quot;%d&quot;</span>, &amp;bus);
<a name="l01318"></a>01318             sscanf(&amp;charBuff[29], <span class="stringliteral">&quot;%d&quot;</span>, &amp;<span class="keywordtype">id</span>);
<a name="l01319"></a>01319          }
<a name="l01320"></a>01320 
<a name="l01321"></a>01321          <span class="comment">/* parse the Vendor line */</span>
<a name="l01322"></a>01322          <span class="keywordflow">if</span> (strncmp(&amp;charBuff[2], <span class="stringliteral">&quot;Vendor&quot;</span>, 6) == 0) {
<a name="l01323"></a>01323             sscanf(&amp;charBuff[10], <span class="stringliteral">&quot;%s&quot;</span>, vendor);
<a name="l01324"></a>01324 
<a name="l01325"></a>01325             <span class="keywordflow">if</span> (strcmp(vendor, <span class="stringliteral">&quot;JORWAY&quot;</span>) == 0) {
<a name="l01326"></a>01326                <span class="keywordflow">if</span> ((<span class="keywordtype">id</span> == <a class="code" href="jorway73a_8h.html#a4bfe115debc7f472dd7dfe4ef9679ca0">ID</a>(branch)) &amp;&amp; (bus == <a class="code" href="jorway73a_8h.html#a862084ca8bda595e2744a6d53d02917d">BUS</a>(branch))) {
<a name="l01327"></a>01327                   <span class="comment">/* found our device by matching scsi id */</span>
<a name="l01328"></a>01328                   strcpy(dev, <a class="code" href="jorway73a_8c.html#a46c254f440287e2529e83c8e49ed37ad">devtble</a>[i]);
<a name="l01329"></a>01329                   found = 1;
<a name="l01330"></a>01330                   <span class="keywordflow">break</span>;
<a name="l01331"></a>01331                }
<a name="l01332"></a>01332             } <span class="keywordflow">else</span> {            <span class="comment">/* SCSI device found, but not a Jorway */</span>
<a name="l01333"></a>01333                i++;
<a name="l01334"></a>01334             }
<a name="l01335"></a>01335          }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337          <span class="comment">/* parse the Type line */</span>
<a name="l01338"></a>01338          <span class="keywordflow">if</span> (strncmp(&amp;charBuff[2], <span class="stringliteral">&quot;Type&quot;</span>, 4) == 0) {
<a name="l01339"></a>01339             sscanf(&amp;charBuff[10], <span class="stringliteral">&quot;%s&quot;</span>, type);
<a name="l01340"></a>01340 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01341"></a>01341 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (strcmp(type, <span class="stringliteral">&quot;Unknown&quot;</span>) || (strcmp(type, <span class="stringliteral">&quot;Processor&quot;</span>))) {
<a name="l01342"></a>01342                fprintf(stderr, <span class="stringliteral">&quot;Found type %s&quot;</span>, type);
<a name="l01343"></a>01343             }
<a name="l01344"></a>01344 <span class="preprocessor">#endif</span>
<a name="l01345"></a>01345 <span class="preprocessor"></span>         }
<a name="l01346"></a>01346       }                         <span class="comment">/* if status == 0 */</span>
<a name="l01347"></a>01347    }                            <span class="comment">/* while */</span>
<a name="l01348"></a>01348 
<a name="l01349"></a>01349    fclose(g_rfp);
<a name="l01350"></a>01350    <span class="keywordflow">if</span> (found)
<a name="l01351"></a>01351       status = <a class="code" href="jorway73a_8h.html#a1ac3848cc49cd53d6f10f175d60a388b">CAM_S_SUCCESS</a>;
<a name="l01352"></a>01352    <span class="keywordflow">return</span> (status);
<a name="l01353"></a>01353 }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355 
<a name="l01356"></a>01356 <span class="comment">/* </span>
<a name="l01357"></a>01357 <span class="comment">** Read file &quot;filename&quot; on stream g_rfp and return</span>
<a name="l01358"></a>01358 <span class="comment">** results in buffer charBuff.</span>
<a name="l01359"></a>01359 <span class="comment">*/</span>
<a name="l01360"></a>01360 
<a name="l01361"></a><a class="code" href="jorway73a_8c.html#ae47975bb7a79b90263d39eca758397de">01361</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#ae47975bb7a79b90263d39eca758397de">readFile</a>(FILE * g_rfp, <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>, <span class="keywordtype">char</span> charBuff[], <span class="keywordtype">int</span> charBuffsize)
<a name="l01362"></a>01362 {
<a name="l01363"></a>01363    <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01364"></a>01364    <span class="keywordflow">if</span> (fgets(charBuff, charBuffsize, g_rfp) != NULL) {
<a name="l01365"></a>01365       strtok(charBuff, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01366"></a>01366       status = 0;
<a name="l01367"></a>01367    } <span class="keywordflow">else</span> {                     <span class="comment">/* error or end of file found and no characters read */</span>
<a name="l01368"></a>01368       status = EOF;
<a name="l01369"></a>01369    }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371    <span class="keywordflow">return</span> (status);
<a name="l01372"></a>01372 }
<a name="l01373"></a>01373 
<a name="l01374"></a>01374 <span class="comment">/*----------------------- cctype ----------------------------*/</span>
<a name="l01375"></a><a class="code" href="jorway73a_8c.html#a773592bef536c643b4538c7c1aa3c8d1">01375</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a773592bef536c643b4538c7c1aa3c8d1">ccctype</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>, <span class="keywordtype">int</span> lserial, <span class="keywordtype">int</span> lparall)
<a name="l01376"></a>01376 {
<a name="l01377"></a>01377    <span class="keywordflow">if</span> (<a class="code" href="jorway73a_8h.html#a4bfe115debc7f472dd7dfe4ef9679ca0">ID</a>(branch) &lt; 0 || <a class="code" href="jorway73a_8h.html#a4bfe115debc7f472dd7dfe4ef9679ca0">ID</a>(branch) &gt; <a class="code" href="jorway73a_8h.html#a6c693b96884f3b4f857642ceb9b8fcd5">SJY_BRANCH_MAX</a>)
<a name="l01378"></a>01378       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a41b625c282f10f6477f1b363bf0c6965">CAM_S_INVLD_BRANCH</a>);
<a name="l01379"></a>01379    <span class="keywordflow">if</span> (lserial &amp; lparall)
<a name="l01380"></a>01380       <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#acbf2db7dc62a6f3178359e739e467821">CAM_S_SER_OR_PAR_ONLY</a>);
<a name="l01381"></a>01381    <span class="keywordflow">if</span> (lserial)
<a name="l01382"></a>01382       <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[<a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch)].<a class="code" href="structSJY__CONTROLLER.html#a740859990b816d64b872b646fd09ea7f">serial</a> = 1;
<a name="l01383"></a>01383    <span class="keywordflow">if</span> (lparall)
<a name="l01384"></a>01384       <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[<a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch)].<a class="code" href="structSJY__CONTROLLER.html#a740859990b816d64b872b646fd09ea7f">serial</a> = 0;
<a name="l01385"></a>01385    <span class="keywordflow">return</span> (<a class="code" href="jorway73a_8h.html#a1ac3848cc49cd53d6f10f175d60a388b">CAM_S_SUCCESS</a>);
<a name="l01386"></a>01386 }
<a name="l01387"></a>01387 
<a name="l01388"></a>01388 
<a name="l01389"></a>01389 <span class="comment">/*----------------------- SEMAPHORE stuff ------------------ */</span>
<a name="l01390"></a>01390 
<a name="l01391"></a>01391 <span class="comment">/* #define USESEMAPHORES */</span>
<a name="l01392"></a>01392 
<a name="l01393"></a>01393 <span class="preprocessor">#ifdef USESEMAPHORES</span>
<a name="l01394"></a>01394 <span class="preprocessor"></span><span class="comment">/* sjy_semops.c                         jms 6sep94 */</span>
<a name="l01395"></a>01395 <span class="comment">/* 21aug97 das Modified vsd_semops for Linux CAMAC */</span>
<a name="l01396"></a>01396 
<a name="l01397"></a>01397 <span class="comment">/* operations on the semaphores - init, get and put. </span>
<a name="l01398"></a>01398 <span class="comment">* sjy_inisem()          called in inicam</span>
<a name="l01399"></a>01399 <span class="comment">* sjy_getsem,putsem     called to reserve the semaphore</span>
<a name="l01400"></a>01400 <span class="comment">*</span>
<a name="l01401"></a>01401 <span class="comment">*/</span>
<a name="l01402"></a>01402 
<a name="l01403"></a>01403 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l01404"></a>01404 <span class="preprocessor">#include &lt;sys/ipc.h&gt;</span>
<a name="l01405"></a>01405 <span class="preprocessor">#include &lt;sys/sem.h&gt;</span>
<a name="l01406"></a>01406 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l01407"></a>01407 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l01408"></a>01408 
<a name="l01409"></a>01409 <span class="preprocessor">#ifdef VXWORKS</span>
<a name="l01410"></a>01410 <span class="preprocessor"></span><span class="preprocessor">#define SJY_SEM_TYPE SEM_ID</span>
<a name="l01411"></a>01411 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01412"></a>01412 <span class="preprocessor"></span><span class="preprocessor">#define SJY_SEM_TYPE int</span>
<a name="l01413"></a>01413 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01414"></a>01414 <span class="preprocessor"></span>
<a name="l01415"></a>01415 <span class="preprocessor">#define SJY_FILE &quot;/tmp/sjykeyfile&quot;</span>
<a name="l01416"></a>01416 <span class="preprocessor"></span>SJY_SEM_TYPE sjy_sem = (SJY_SEM_TYPE) - 1;
<a name="l01417"></a>01417 <span class="comment">/* Note for flags:</span>
<a name="l01418"></a>01418 <span class="comment">*       IPC_WAIT is default (dont sepecify IPC_NOWAIT)</span>
<a name="l01419"></a>01419 <span class="comment">*       SEM_UNDO aids clean up on exit(2), by changing semadj</span>
<a name="l01420"></a>01420 <span class="comment">*/</span>
<a name="l01421"></a>01421 <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#abd733caa05d3cc5b9dc090f7993fedca">sjy_inisem</a>()
<a name="l01422"></a>01422 {
<a name="l01423"></a>01423 <span class="preprocessor">#ifndef VXWORKS</span>
<a name="l01424"></a>01424 <span class="preprocessor"></span>   key_t sjy_key;
<a name="l01425"></a>01425    <span class="keyword">union </span>semun arg;
<a name="l01426"></a>01426 <span class="preprocessor">#endif</span>
<a name="l01427"></a>01427 <span class="preprocessor"></span>   <span class="keywordtype">int</span> fd;
<a name="l01428"></a>01428    <span class="comment">/* only initialize it once */</span>
<a name="l01429"></a>01429    <span class="keywordflow">if</span> (sjy_sem &gt; (SJY_SEM_TYPE) - 1)
<a name="l01430"></a>01430       <span class="keywordflow">return</span> ((<span class="keywordtype">int</span>) sjy_sem);
<a name="l01431"></a>01431 <span class="preprocessor">#ifdef VXWORKS</span>
<a name="l01432"></a>01432 <span class="preprocessor"></span>   sjy_sem = semBCreate(SEM_Q_PRIORITY, SEM_FULL);
<a name="l01433"></a>01433    <span class="keywordflow">return</span> ((<span class="keywordtype">int</span>) sjy_sem);
<a name="l01434"></a>01434 <span class="preprocessor">#else</span>
<a name="l01435"></a>01435 <span class="preprocessor"></span>   <span class="comment">/* create the key file */</span>
<a name="l01436"></a>01436    <span class="keywordflow">if</span> (fd = open(SJY_FILE, O_CREAT | O_EXCL, 664) &lt; 0) {
<a name="l01437"></a>01437       <span class="keywordflow">if</span> (errno != EEXIST) {
<a name="l01438"></a>01438          fprintf(stderr, <span class="stringliteral">&quot;sjy_semops: Severe Error, could not create key file %s, </span>
<a name="l01439"></a>01439 <span class="stringliteral">        error=%d\n&quot;</span>, SJY_FILE, errno);
<a name="l01440"></a>01440          <span class="keywordflow">return</span> (-1);
<a name="l01441"></a>01441       }
<a name="l01442"></a>01442    }
<a name="l01443"></a>01443 
<a name="l01444"></a>01444    <span class="comment">/* reserve the Semaphore */</span>
<a name="l01445"></a>01445    <span class="keywordflow">if</span> ((sjy_key = ftok(SJY_FILE, 1)) == -1) {
<a name="l01446"></a>01446       printf
<a name="l01447"></a>01447           (<span class="stringliteral">&quot;sjy_semops: Severe Error, could not get key for %s error=%d\n&quot;</span>,
<a name="l01448"></a>01448            SJY_FILE, errno);
<a name="l01449"></a>01449       <span class="keywordflow">return</span> (-1);
<a name="l01450"></a>01450    }
<a name="l01451"></a>01451 
<a name="l01452"></a>01452    <span class="comment">/* check to see if its already in system */</span>
<a name="l01453"></a>01453    sjy_sem = semget(sjy_key, 1, IPC_EXCL | IPC_CREAT | 0777);
<a name="l01454"></a>01454    <span class="keywordflow">if</span> (errno != EEXIST) {
<a name="l01455"></a>01455       <span class="comment">/* it didnt already exist, open it back up as non EXCL and set it to 1 */</span>
<a name="l01456"></a>01456       <span class="keywordflow">if</span> (semctl(sjy_sem, 0, IPC_RMID, arg) != 0) {
<a name="l01457"></a>01457          printf(<span class="stringliteral">&quot;sjy_semops: Severe Error, couldnt close semaphore\n&quot;</span>);
<a name="l01458"></a>01458          <span class="keywordflow">return</span> (-1);
<a name="l01459"></a>01459       }
<a name="l01460"></a>01460 
<a name="l01461"></a>01461       <span class="keywordflow">if</span> ((sjy_sem = semget(sjy_key, 1, IPC_CREAT | 0777)) == -1) {
<a name="l01462"></a>01462          printf(<span class="stringliteral">&quot;sjy_semops: Severe Error, couldnt reopen semaphore\n&quot;</span>);
<a name="l01463"></a>01463          <span class="keywordflow">return</span> (-1);
<a name="l01464"></a>01464       }
<a name="l01465"></a>01465 
<a name="l01466"></a>01466       <span class="comment">/* set the semval to 1 to let only 1 process use it at a time */</span>
<a name="l01467"></a>01467       arg.val = 1;
<a name="l01468"></a>01468       <span class="keywordflow">if</span> (semctl(sjy_sem, 0, SETVAL, arg) != 0) {
<a name="l01469"></a>01469          printf(<span class="stringliteral">&quot;sjy_semops: Severe Error, couldnt set semaphore\n&quot;</span>);
<a name="l01470"></a>01470          <span class="keywordflow">return</span> (-1);
<a name="l01471"></a>01471       }
<a name="l01472"></a>01472    }
<a name="l01473"></a>01473 
<a name="l01474"></a>01474    <span class="keywordflow">else</span> {
<a name="l01475"></a>01475       <span class="comment">/* it already existed, so just open it up */</span>
<a name="l01476"></a>01476       sjy_sem = semget(sjy_key, 1, IPC_CREAT | 0777);
<a name="l01477"></a>01477    }
<a name="l01478"></a>01478 
<a name="l01479"></a>01479    <span class="keywordflow">return</span> (sjy_sem);
<a name="l01480"></a>01480 <span class="preprocessor">#endif</span>
<a name="l01481"></a>01481 <span class="preprocessor"></span>}
<a name="l01482"></a>01482 
<a name="l01483"></a>01483 <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a2f3b012918d1fa4a5472923f5269b459">sjy_getsem</a>()
<a name="l01484"></a>01484 {
<a name="l01485"></a>01485    <span class="comment">/* get the sjy semaphore */</span>
<a name="l01486"></a>01486 
<a name="l01487"></a>01487 <span class="preprocessor">#ifdef VXWORKS</span>
<a name="l01488"></a>01488 <span class="preprocessor"></span>   <span class="keywordflow">return</span> (semTake(sjy_sem, WAIT_FOREVER));
<a name="l01489"></a>01489 <span class="preprocessor">#else</span>
<a name="l01490"></a>01490 <span class="preprocessor"></span>   <span class="keyword">struct </span>sembuf sops[1];
<a name="l01491"></a>01491    <span class="comment">/* load the sops structure */</span>
<a name="l01492"></a>01492    sops[0].sem_num = 0;
<a name="l01493"></a>01493    sops[0].sem_op = -1;
<a name="l01494"></a>01494    sops[0].sem_flg = SEM_UNDO;  <span class="comment">/* WAIT for it */</span>
<a name="l01495"></a>01495    <span class="keywordflow">return</span> (semop(sjy_sem, sops, 1));
<a name="l01496"></a>01496 <span class="preprocessor">#endif</span>
<a name="l01497"></a>01497 <span class="preprocessor"></span>}
<a name="l01498"></a>01498 
<a name="l01499"></a>01499 <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">sjy_putsem</a>()
<a name="l01500"></a>01500 {
<a name="l01501"></a>01501    <span class="comment">/* release the sjy semaphore */</span>
<a name="l01502"></a>01502 
<a name="l01503"></a>01503 <span class="preprocessor">#ifdef VXWORKS</span>
<a name="l01504"></a>01504 <span class="preprocessor"></span>   <span class="keywordflow">return</span> (semGive(sjy_sem));
<a name="l01505"></a>01505 <span class="preprocessor">#else</span>
<a name="l01506"></a>01506 <span class="preprocessor"></span>   <span class="keyword">struct </span>sembuf sops[1];
<a name="l01507"></a>01507    <span class="comment">/* load the sops structure */</span>
<a name="l01508"></a>01508    sops[0].sem_num = 0;
<a name="l01509"></a>01509    sops[0].sem_op = 1;
<a name="l01510"></a>01510    sops[0].sem_flg = SEM_UNDO;
<a name="l01511"></a>01511    <span class="keywordflow">return</span> (semop(sjy_sem, sops, 1));
<a name="l01512"></a>01512 <span class="preprocessor">#endif</span>
<a name="l01513"></a>01513 <span class="preprocessor"></span>}
<a name="l01514"></a>01514 <span class="preprocessor">#else                           </span><span class="comment">/* else for USESEMPOS */</span>
<a name="l01515"></a><a class="code" href="jorway73a_8c.html#abd733caa05d3cc5b9dc090f7993fedca">01515</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#abd733caa05d3cc5b9dc090f7993fedca">sjy_inisem</a>()
<a name="l01516"></a>01516 {
<a name="l01517"></a>01517    <span class="keywordflow">return</span> (1);
<a name="l01518"></a>01518 }
<a name="l01519"></a>01519 
<a name="l01520"></a><a class="code" href="jorway73a_8c.html#a2f3b012918d1fa4a5472923f5269b459">01520</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a2f3b012918d1fa4a5472923f5269b459">sjy_getsem</a>()
<a name="l01521"></a>01521 {
<a name="l01522"></a>01522    <span class="keywordflow">return</span> (0);
<a name="l01523"></a>01523 }                               <span class="comment">/* get the sjy semaphore */</span>
<a name="l01524"></a>01524 
<a name="l01525"></a><a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">01525</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#affa47cfeeb7d4af1452da226e03f4cc8">sjy_putsem</a>()
<a name="l01526"></a>01526 {
<a name="l01527"></a>01527    <span class="keywordflow">return</span> (0);
<a name="l01528"></a>01528 }                               <span class="comment">/* release the sjy semaphore */</span>
<a name="l01529"></a>01529 <span class="preprocessor">#endif</span>
<a name="l01530"></a>01530 <span class="preprocessor"></span>
<a name="l01531"></a>01531 
<a name="l01532"></a>01532 <span class="comment">/* ---------------------------------------------------------------- */</span>
<a name="l01533"></a>01533 <span class="comment">/* Replacement subroutines for deriving x, q response               */</span>
<a name="l01534"></a>01534 <span class="comment">/* ---------------------------------------------------------------- */</span>
<a name="l01535"></a>01535 
<a name="l01536"></a>01536 
<a name="l01537"></a><a class="code" href="jorway73a_8c.html#a633fe0975b0b2a310e5df3c5609f988e">01537</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a633fe0975b0b2a310e5df3c5609f988e">notify_camac_nondata</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>, <span class="keywordtype">int</span> xferlen, <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>)
<a name="l01538"></a>01538 <span class="comment">/* Greg&apos;s version of determining final status */</span>
<a name="l01539"></a>01539 <span class="comment">/* Essentially copied from before */</span>
<a name="l01540"></a>01540 {
<a name="l01541"></a>01541    <span class="keywordtype">int</span> idx = <a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch);
<a name="l01542"></a>01542    <span class="keywordtype">int</span> addsense = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a710433678e89290ef4a40354f573dd7c">sense_buffer</a>[<a class="code" href="jorway73a_8h.html#a23341b08faa22fce2b643daa0747ecd3">ADD_SENSECODE</a>];
<a name="l01543"></a>01543    <span class="keywordtype">int</span> target_status = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#ae28328f55bc09b61571bb1bbe20119d6">target_status</a>;
<a name="l01544"></a>01544    <span class="keywordflow">switch</span> (status) {
<a name="l01545"></a>01545    <span class="keywordflow">case</span> 0:
<a name="l01546"></a>01546       <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = ENODEV;
<a name="l01547"></a>01547       <span class="keywordflow">break</span>;                    <span class="comment">/* X=1,Q=0; see get_qx */</span>
<a name="l01548"></a>01548    <span class="keywordflow">case</span> 4:
<a name="l01549"></a>01549       <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = 0;
<a name="l01550"></a>01550       <span class="keywordflow">break</span>;                    <span class="comment">/* X=1,Q=1; see get_qx */</span>
<a name="l01551"></a>01551    <span class="keywordflow">case</span> 2:
<a name="l01552"></a>01552       <span class="keywordflow">switch</span> (addsense) {
<a name="l01553"></a>01553       <span class="keywordflow">case</span> <a class="code" href="jorway73a_8h.html#a5418ec10543df88aa19ad79fe4405fcd">SJY_NO_Q</a>:
<a name="l01554"></a>01554          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = ENODEV;
<a name="l01555"></a>01555          <span class="keywordflow">break</span>;                 <span class="comment">/* X=1,Q=0 */</span>
<a name="l01556"></a>01556       <span class="keywordflow">case</span> <a class="code" href="jorway73a_8h.html#af2c6ac80f5695f8644677557d3021367">SJY_NO_X</a>:
<a name="l01557"></a>01557          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = EFAULT;
<a name="l01558"></a>01558          <span class="keywordflow">break</span>;                 <span class="comment">/* X=0 but SCSI ok */</span>
<a name="l01559"></a>01559       <span class="keywordflow">default</span>:
<a name="l01560"></a>01560          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = EIO;
<a name="l01561"></a>01561          <span class="keywordflow">break</span>;                 <span class="comment">/* SCSI failed, too. */</span>
<a name="l01562"></a>01562       } <span class="comment">/* matches switch addsense */</span> ;
<a name="l01563"></a>01563       <span class="keywordflow">break</span>;                    <span class="comment">/* case 2 */</span>
<a name="l01564"></a>01564    <span class="keywordflow">default</span>:                    <span class="comment">/* Other status means soemthing&apos;s screwed up */</span>
<a name="l01565"></a>01565       fprintf(stderr, <span class="stringliteral">&quot;Invalid SCSI Status byte: 0x%02x\n&quot;</span>, target_status);
<a name="l01566"></a>01566    }
<a name="l01567"></a>01567 }
<a name="l01568"></a>01568 
<a name="l01569"></a>01569 <span class="comment">/* Greg&apos;s slightly modified notify_camac_data */</span>
<a name="l01570"></a>01570 <span class="comment">/* Takes advantage of the fact that I do have access to the */</span>
<a name="l01571"></a>01571 <span class="comment">/* target status byte. */</span>
<a name="l01572"></a>01572 <span class="comment">/* So I don&apos;t have to derive &quot;ok&quot; from lack of other errrors. */</span>
<a name="l01573"></a>01573 
<a name="l01574"></a><a class="code" href="jorway73a_8c.html#a752fa0f75faca1883f6c404ed95d0822">01574</a> <span class="keywordtype">int</span> <a class="code" href="jorway73a_8c.html#a752fa0f75faca1883f6c404ed95d0822">notify_camac_data</a>(<span class="keywordtype">int</span> <a class="code" href="caen170a_8c.html#a5b23e03d232f1c0e5e35b3700581a9e4">branch</a>,       <span class="comment">/* CAMAC branch */</span>
<a name="l01575"></a>01575                       <span class="keywordtype">int</span> xferlen,      <span class="comment">/* expected transfer length */</span>
<a name="l01576"></a>01576                       <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>)
<a name="l01577"></a>01577 {                               <span class="comment">/* actual transfer length */</span>
<a name="l01578"></a>01578    <span class="keywordtype">int</span> idx = <a class="code" href="jorway73a_8h.html#a5ef013284ffb7b7ec3ba7da15b7afe12">IDX</a>(branch);
<a name="l01579"></a>01579    <span class="keywordtype">int</span> sense_key = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a710433678e89290ef4a40354f573dd7c">sense_buffer</a>[<a class="code" href="jorway73a_8h.html#a124960eca55d1db5f5b3740aaecf20c5">SENSEKEY</a>];
<a name="l01580"></a>01580    <span class="keywordtype">int</span> add_sense = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a710433678e89290ef4a40354f573dd7c">sense_buffer</a>[<a class="code" href="jorway73a_8h.html#a23341b08faa22fce2b643daa0747ecd3">ADD_SENSECODE</a>];
<a name="l01581"></a>01581    <span class="keywordtype">int</span> target_status = <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#ae28328f55bc09b61571bb1bbe20119d6">target_status</a>;
<a name="l01582"></a>01582    <span class="keywordflow">if</span> (target_status == 0) {    <span class="comment">/* Good status -- no errors */</span>
<a name="l01583"></a>01583 <span class="preprocessor">#if GDEBUG</span>
<a name="l01584"></a>01584 <span class="preprocessor"></span>      fprintf(stderr, <span class="stringliteral">&quot;target_status=0x%02x\n&quot;</span>, target_status);
<a name="l01585"></a>01585 <span class="preprocessor">#endif</span>
<a name="l01586"></a>01586 <span class="preprocessor"></span>      <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = 0;
<a name="l01587"></a>01587       <span class="keywordflow">return</span>;
<a name="l01588"></a>01588    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (target_status != 2) {     <span class="comment">/* Improper status */</span>
<a name="l01589"></a>01589       <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = EIO;
<a name="l01590"></a>01590       fprintf(stderr, <span class="stringliteral">&quot;Invalid SCSI status byte: 0x%02x\n&quot;</span>, target_status);
<a name="l01591"></a>01591    } <span class="keywordflow">else</span> {                     <span class="comment">/* Status = 2, check condition */</span>
<a name="l01592"></a>01592 <span class="preprocessor">#if GDEBUG</span>
<a name="l01593"></a>01593 <span class="preprocessor"></span>      fprintf(stderr,
<a name="l01594"></a>01594               <span class="stringliteral">&quot;target_status=0x%02x,sense_key=0x%02x,add_sense=0x%02x\n&quot;</span>,
<a name="l01595"></a>01595               target_status, sense_key, add_sense);
<a name="l01596"></a>01596 <span class="preprocessor">#endif</span>
<a name="l01597"></a>01597 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (sense_key == 0) {     <span class="comment">/* Should only have to &quot;check condition&quot; if !=0 */</span>
<a name="l01598"></a>01598       }
<a name="l01599"></a>01599       <span class="keywordflow">if</span> (add_sense == <a class="code" href="jorway73a_8h.html#a5418ec10543df88aa19ad79fe4405fcd">SJY_NO_Q</a>) {      <span class="comment">/* SCSI ok, CAMAC ok, no Q on transfer */</span>
<a name="l01600"></a>01600          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = ENODEV;
<a name="l01601"></a>01601       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (add_sense == <a class="code" href="jorway73a_8h.html#af2c6ac80f5695f8644677557d3021367">SJY_NO_X</a>) {       <span class="comment">/* SCSI ok, no X on transfer */</span>
<a name="l01602"></a>01602          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = EFAULT;
<a name="l01603"></a>01603       } <span class="keywordflow">else</span> {                  <span class="comment">/* SCSI problem */</span>
<a name="l01604"></a>01604          <a class="code" href="jorway73a_8h.html#a7865bbd504262133b68ef11f3c862b23">sjy_controller</a>[idx].<a class="code" href="structSJY__CONTROLLER.html#a8efe5331ab1a93746528887ea361f3bd">errn</a> = EIO;
<a name="l01605"></a>01605       }
<a name="l01606"></a>01606    }
<a name="l01607"></a>01607 
<a name="l01608"></a>01608 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
