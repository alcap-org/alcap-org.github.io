<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ: rootana/src/TAP_generators/template_fitting/TemplateMultiFitter.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>rootana/src/TAP_generators/template_fitting/TemplateMultiFitter.cpp</h1><a href="TemplateMultiFitter_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="TemplateMultiFitter_8cpp.html#a694bd054e423eaf8c2fa5cb3b77366a7">00001</a> <span class="preprocessor">#define ALCAP_NO_DEBUG</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="TemplateMultiFitter_8h.html">TemplateMultiFitter.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &quot;<a class="code" href="MultiHistogramFitFCN_8h.html">MultiHistogramFitFCN.h</a>&quot;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &quot;<a class="code" href="SetupNavigator_8h.html">SetupNavigator.h</a>&quot;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="EventNavigator_8h.html">EventNavigator.h</a>&quot;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="debug__tools_8h.html">debug_tools.h</a>&quot;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;TMath.h&quot;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="keyword">using</span> std::cout;
<a name="l00012"></a>00012 <span class="keyword">using</span> std::endl;
<a name="l00013"></a>00013 
<a name="l00014"></a><a class="code" href="classTemplateMultiFitter.html#a2667cf144f5bfb9e32791292f11e0809">00014</a> <a class="code" href="classTemplateMultiFitter.html#a2667cf144f5bfb9e32791292f11e0809">TemplateMultiFitter::TemplateMultiFitter</a>(<span class="keyword">const</span> <a class="code" href="classIDs_1_1channel.html">IDs::channel</a>&amp; ch): 
<a name="l00015"></a>00015    fMinuitFitter(NULL), fFitFCN(NULL), fChannel(ch),fPedestal(0), fRefineFactor(0) {
<a name="l00016"></a>00016 
<a name="l00017"></a>00017   <span class="comment">// Calculate the max ADC value</span>
<a name="l00018"></a>00018   <a class="code" href="classTemplateMultiFitter.html#a774065f6731e9acc8082e06dadc9b620">fMinADC</a> = 0;
<a name="l00019"></a>00019   <a class="code" href="classTemplateMultiFitter.html#abf32cbeb98b5fc0b8f42716ac0998f9d">fMaxADC</a> = <a class="code" href="classEventNavigator.html#ad4099e1d7bb809c73abced326a4a09f8">EventNavigator::Instance</a>().<a class="code" href="classEventNavigator.html#a3cd69cd236b48644dca763e0541c8926">GetSetupRecord</a>().<a class="code" href="classSetupRecord.html#ac3b1748afba6411a913333d52092f98a" title="The maximum value recordable by the ADC i.e. 1 less than the overflow.">GetMaxADC</a>(<a class="code" href="classTemplateMultiFitter.html#ab395af0c08acd18019039067c69ef699">fChannel</a>);
<a name="l00020"></a>00020 }
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="classTemplateMultiFitter.html#a9dbbc16568869a15d43eb4819563708f">00022</a> <span class="keywordtype">void</span> <a class="code" href="classTemplateMultiFitter.html#a9dbbc16568869a15d43eb4819563708f">TemplateMultiFitter::Init</a>(){
<a name="l00023"></a>00023   <span class="keywordflow">if</span>(<a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a> || <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>) {
<a name="l00024"></a>00024      cout&lt;&lt; <span class="stringliteral">&quot;TemplateMultiFitter: Warning: trying to initialize fitter which was already initialised!&quot;</span>&lt;&lt;endl;
<a name="l00025"></a>00025      <span class="keywordflow">return</span>;
<a name="l00026"></a>00026   }
<a name="l00027"></a>00027 
<a name="l00028"></a>00028   <a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>=<span class="keyword">new</span> <a class="code" href="classMultiHistogramFitFCN.html">MultiHistogramFitFCN</a>(<a class="code" href="classTemplateMultiFitter.html#a16c5e6e2beb378e46976e2822c474438">fRefineFactor</a>);
<a name="l00029"></a>00029   <a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>-&gt;<a class="code" href="classMultiHistogramFitFCN.html#a638b24c422cc52b2c81f239f46a8b57e">SetRefineFactor</a>(<a class="code" href="classTemplateMultiFitter.html#a16c5e6e2beb378e46976e2822c474438">fRefineFactor</a>);
<a name="l00030"></a>00030   <span class="keywordflow">for</span>(<a class="code" href="namespacemodules.html#a5ce57c86284eadc5b573cfab0949bfdb">TemplateList::iterator</a> i_tpl=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin(); i_tpl!=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.end(); ++i_tpl){
<a name="l00031"></a>00031      <a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>-&gt;<a class="code" href="classMultiHistogramFitFCN.html#a29d99b49cceda364baa531c02c5aad12">AddTemplate</a>(i_tpl-&gt;fTemplate-&gt;GetHisto());
<a name="l00032"></a>00032   }
<a name="l00033"></a>00033  
<a name="l00034"></a>00034   <span class="keywordtype">int</span> num_params=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.size()+1; <span class="comment">//  1 parameter per template (amplitude) + global pedestal.</span>
<a name="l00035"></a>00035   <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a> = <span class="keyword">new</span> TFitterMinuit(num_params);
<a name="l00036"></a>00036   <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;SetMinuitFCN(<a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>);
<a name="l00037"></a>00037   <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;SetPrintLevel(-1); <span class="comment">// set the debug level to quiet (-1=quiet, 0=normal, 1=verbose)</span>
<a name="l00038"></a>00038 }
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="classTemplateMultiFitter.html#ad3d80235b8770459fe05da525c202067">00040</a> <a class="code" href="classTemplateMultiFitter.html#ad3d80235b8770459fe05da525c202067">TemplateMultiFitter::~TemplateMultiFitter</a>() {
<a name="l00041"></a>00041 }
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="classTemplateMultiFitter.html#a9021410b2d2064dffe2315a19a1aa799">00043</a> <span class="keywordtype">int</span> <a class="code" href="classTemplateMultiFitter.html#a9021410b2d2064dffe2315a19a1aa799">TemplateMultiFitter::FitWithOneTimeFree</a>(<span class="keywordtype">int</span> index, <span class="keyword">const</span> TH1D* hPulse){
<a name="l00044"></a>00044 
<a name="l00045"></a>00045   <span class="comment">// Get the template we&apos;re going to shift around</span>
<a name="l00046"></a>00046   <a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html">TemplateDetails_t</a>&amp; current=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.at(index);
<a name="l00047"></a>00047 
<a name="l00048"></a>00048   <span class="comment">// Prepare for minimizations</span>
<a name="l00049"></a>00049   <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;Clear();
<a name="l00050"></a>00050   <a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>-&gt;<a class="code" href="classMultiHistogramFitFCN.html#a08b3e9fd8664757e309331e46f828df8">SetPulseHist</a>(hPulse);
<a name="l00051"></a>00051   <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;CreateMinimizer(TFitterMinuit::kMigrad);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053   <span class="comment">// Loop through some time offsets ourselved</span>
<a name="l00054"></a>00054   <span class="keyword">const</span> <span class="keywordtype">double</span> offset_range = 10*<a class="code" href="classTemplateMultiFitter.html#a16c5e6e2beb378e46976e2822c474438">fRefineFactor</a>; <span class="comment">// maximum distance to go from the initial estimate</span>
<a name="l00055"></a>00055   <span class="keywordtype">double</span> best_time_offset = 0;
<a name="l00056"></a>00056   std::vector&lt;double&gt; best_parameters(1+<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.size());
<a name="l00057"></a>00057   <span class="keywordtype">double</span> best_chi2 = 1e34;
<a name="l00058"></a>00058   <span class="keywordtype">int</span> best_ndof = 0;
<a name="l00059"></a>00059   <span class="keywordtype">int</span> best_status = <a class="code" href="classTemplateMultiFitter.html#a16212298579752f945caa08e16d8d123a79260562368afab9cbb4e015bf4b97dd">kInitialised</a>;
<a name="l00060"></a>00060   <span class="keywordtype">int</span> status = <a class="code" href="classTemplateMultiFitter.html#a16212298579752f945caa08e16d8d123a79260562368afab9cbb4e015bf4b97dd">kInitialised</a>;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062   <span class="comment">// Calculate the bounds of the parameters</span>
<a name="l00063"></a>00063   <span class="keywordtype">int</span> min_offset = current.<a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html#a204e442951ed90324c761a68e7bb7dca">fTimeOffset</a> - offset_range;
<a name="l00064"></a>00064   <span class="keywordtype">int</span> max_offset = current.<a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html#a204e442951ed90324c761a68e7bb7dca">fTimeOffset</a> + offset_range;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066   std::vector&lt;double&gt; parameters(1+<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.size());
<a name="l00067"></a>00067   <span class="keywordflow">for</span> (<span class="keywordtype">double</span> time_offset = min_offset; time_offset &lt;= max_offset; ++time_offset) {
<a name="l00068"></a>00068     <a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>-&gt;<a class="code" href="classMultiHistogramFitFCN.html#a0dc9f40613a4c55eed0adf65f232376b">SetTimeOffset</a>(index, time_offset);
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="comment">// Reset the estimates</span>
<a name="l00071"></a>00071     <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;SetParameter(0, <span class="stringliteral">&quot;PedestalOffset&quot;</span>, <a class="code" href="classTemplateMultiFitter.html#a1408bd52c4f30c6f9292575b0a835dbf">fPedestal</a>, 0.1, <a class="code" href="classTemplateMultiFitter.html#a1408bd52c4f30c6f9292575b0a835dbf">fPedestal</a>-10, <a class="code" href="classTemplateMultiFitter.html#a1408bd52c4f30c6f9292575b0a835dbf">fPedestal</a>+10);
<a name="l00072"></a>00072     <span class="keywordflow">for</span>(<a class="code" href="namespacemodules.html#aecc7811d5380ed9d9e903c9b71a396aa">TemplateList::const_iterator</a> i_tpl=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin(); i_tpl!=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.end(); ++i_tpl){
<a name="l00073"></a>00073         <span class="keywordtype">int</span> i=i_tpl-<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin();
<a name="l00074"></a>00074         <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;SetParameter(i+1, Form(<span class="stringliteral">&quot;AmplitudeScaleFactor_%d&quot;</span>,i), i_tpl-&gt;fAmplitudeScaleFactor, 0.1, <a class="code" href="classTemplateMultiFitter.html#a774065f6731e9acc8082e06dadc9b620">fMinADC</a>, <a class="code" href="classTemplateMultiFitter.html#abf32cbeb98b5fc0b8f42716ac0998f9d">fMaxADC</a>);
<a name="l00075"></a>00075     }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="comment">// Minimize and notify if there was a problem</span>
<a name="l00078"></a>00078     status = <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;Minimize(1000); <span class="comment">// set limit of 1000 calls to FCN</span>
<a name="l00079"></a>00079     <a class="code" href="debug__tools_8h.html#a902eecd05809897fb1525d2ef9f02d08">DEBUG_VALUE</a>(status);
<a name="l00080"></a>00080     <span class="keywordflow">if</span>(status!=0) <span class="keywordflow">continue</span>;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082     <span class="comment">// Store the Chi2 and degrees of freedom</span>
<a name="l00083"></a>00083     parameters[0]=<a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;GetParameter(0); 
<a name="l00084"></a>00084     <span class="keywordflow">for</span>(<a class="code" href="namespacemodules.html#a5ce57c86284eadc5b573cfab0949bfdb">std::vector&lt;double&gt;::iterator</a> i_par=parameters.begin()+1; i_par!=parameters.end(); ++i_par){
<a name="l00085"></a>00085        <span class="keywordtype">int</span> n=i_par-parameters.begin();
<a name="l00086"></a>00086        *i_par= <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;GetParameter(n);
<a name="l00087"></a>00087     }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="comment">// Check the bounds</span>
<a name="l00090"></a>00090     <span class="keyword">const</span> <span class="keywordtype">double</span> delta_ped_offset_error = 1; <span class="comment">// if the given parameter is within this much of the boundaries, then we will ignore it</span>
<a name="l00091"></a>00091     <span class="keyword">const</span> <span class="keywordtype">double</span> delta_amp_sf_error = 0.001;
<a name="l00092"></a>00092     <span class="keywordflow">if</span> ( (parameters[0] &lt; delta_ped_offset_error ) || (parameters[0] &gt; <a class="code" href="classTemplateMultiFitter.html#abf32cbeb98b5fc0b8f42716ac0998f9d">fMaxADC</a> - delta_ped_offset_error) ) {
<a name="l00093"></a>00093       status = <a class="code" href="classTemplateMultiFitter.html#a16212298579752f945caa08e16d8d123a233707dada26b287438e7c62a77cc5bc">kPedestalOutOfBounds</a>;
<a name="l00094"></a>00094     } <span class="keywordflow">else</span> {
<a name="l00095"></a>00095        <span class="keywordflow">for</span>(<a class="code" href="namespacemodules.html#aecc7811d5380ed9d9e903c9b71a396aa">std::vector&lt;double&gt;::const_iterator</a> i_par=parameters.begin()+1; i_par!=parameters.end(); ++i_par){
<a name="l00096"></a>00096           <span class="keywordflow">if</span> (    ( *i_par &lt; <a class="code" href="classTemplateMultiFitter.html#a774065f6731e9acc8082e06dadc9b620">fMinADC</a> + delta_amp_sf_error ) || ( *i_par &gt; <a class="code" href="classTemplateMultiFitter.html#abf32cbeb98b5fc0b8f42716ac0998f9d">fMaxADC</a> - delta_amp_sf_error ) ) {
<a name="l00097"></a>00097                 <a class="code" href="debug__tools_8h.html#a902eecd05809897fb1525d2ef9f02d08">DEBUG_VALUE</a>(*i_par, delta_amp_sf_error, <a class="code" href="classTemplateMultiFitter.html#a774065f6731e9acc8082e06dadc9b620">fMinADC</a>, <a class="code" href="classTemplateMultiFitter.html#abf32cbeb98b5fc0b8f42716ac0998f9d">fMaxADC</a>);
<a name="l00098"></a>00098                 status = <a class="code" href="classTemplateMultiFitter.html#a16212298579752f945caa08e16d8d123ad661dfc43915be6043691ae3603e62d0">kAmplitudeOutOfBounds</a>;
<a name="l00099"></a>00099                 <span class="keywordflow">break</span>;
<a name="l00100"></a>00100           }
<a name="l00101"></a>00101        }
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="comment">// get the chi-2</span>
<a name="l00105"></a>00105     <a class="code" href="classTemplateMultiFitter.html#a7b11a532defa1386ca6ceb590a9c643f">fChi2</a> = (*fFitFCN)(parameters);
<a name="l00106"></a>00106     <a class="code" href="classTemplateMultiFitter.html#a0a484f277ee04d00751b195a38b1f836">fNDoF</a> = <a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>-&gt;<a class="code" href="classMultiHistogramFitFCN.html#ad2b0657d4f18967c4955008740d6e028">GetNDoF</a>();
<a name="l00107"></a>00107     <a class="code" href="debug__tools_8h.html#a902eecd05809897fb1525d2ef9f02d08">DEBUG_VALUE</a>(status,parameters[0],<a class="code" href="classTemplateMultiFitter.html#a7b11a532defa1386ca6ceb590a9c643f">fChi2</a>,fNDoF);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (status == 0 &amp;&amp; <a class="code" href="classTemplateMultiFitter.html#a7b11a532defa1386ca6ceb590a9c643f">fChi2</a> &lt; best_chi2) {
<a name="l00110"></a>00110       best_time_offset = time_offset;
<a name="l00111"></a>00111       best_parameters=parameters;
<a name="l00112"></a>00112       best_chi2 = <a class="code" href="classTemplateMultiFitter.html#a7b11a532defa1386ca6ceb590a9c643f">fChi2</a>;
<a name="l00113"></a>00113       best_status = status;
<a name="l00114"></a>00114       best_ndof = fNDoF;
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116   }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118   <span class="comment">// Store the final best values</span>
<a name="l00119"></a>00119   <a class="code" href="classTemplateMultiFitter.html#a7b11a532defa1386ca6ceb590a9c643f">fChi2</a> = best_chi2;
<a name="l00120"></a>00120   <a class="code" href="classTemplateMultiFitter.html#a0a484f277ee04d00751b195a38b1f836">fNDoF</a> = best_ndof;
<a name="l00121"></a>00121   current.<a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html#a204e442951ed90324c761a68e7bb7dca">fTimeOffset</a> = best_time_offset;
<a name="l00122"></a>00122   <a class="code" href="classTemplateMultiFitter.html#a1408bd52c4f30c6f9292575b0a835dbf">fPedestal</a> = best_parameters[0];
<a name="l00123"></a>00123   <span class="keywordflow">for</span>(<a class="code" href="namespacemodules.html#a5ce57c86284eadc5b573cfab0949bfdb">TemplateList::iterator</a> i_tpl=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin(); i_tpl!=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.end(); ++i_tpl){
<a name="l00124"></a>00124       i_tpl-&gt;fAmplitudeScaleFactor=best_parameters[i_tpl-<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin()+1];
<a name="l00125"></a>00125   }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127   <span class="keyword">static</span> <span class="keywordtype">int</span> offset_safety = 1;
<a name="l00128"></a>00128   <span class="keywordflow">if</span> ( (current.<a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html#a204e442951ed90324c761a68e7bb7dca">fTimeOffset</a> &lt; min_offset + offset_safety &amp;&amp; current.<a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html#a204e442951ed90324c761a68e7bb7dca">fTimeOffset</a> &gt; min_offset - offset_safety) ||
<a name="l00129"></a>00129        (current.<a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html#a204e442951ed90324c761a68e7bb7dca">fTimeOffset</a> &lt; max_offset + offset_safety &amp;&amp; current.<a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html#a204e442951ed90324c761a68e7bb7dca">fTimeOffset</a> &gt; max_offset - offset_safety) ) {
<a name="l00130"></a>00130 
<a name="l00131"></a>00131       best_status = <a class="code" href="classTemplateMultiFitter.html#a16212298579752f945caa08e16d8d123a125f000b80e864bdbbec4a207aa58847">kTimeOutOfBounds</a>;
<a name="l00132"></a>00132   }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   <span class="keywordflow">return</span> best_status; <span class="comment">// return status for the calling module to look at</span>
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a><a class="code" href="classTemplateMultiFitter.html#a637a5e9b892c0934d6735fe3f5b1cc9e">00137</a> <span class="keywordtype">int</span> <a class="code" href="classTemplateMultiFitter.html#a637a5e9b892c0934d6735fe3f5b1cc9e">TemplateMultiFitter::FitWithAllTimesFixed</a>( <span class="keyword">const</span> TH1D* hPulse){
<a name="l00138"></a>00138   <span class="comment">// Prepare for minimizations</span>
<a name="l00139"></a>00139   <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;Clear();
<a name="l00140"></a>00140   <a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>-&gt;<a class="code" href="classMultiHistogramFitFCN.html#a08b3e9fd8664757e309331e46f828df8">SetPulseHist</a>(hPulse);
<a name="l00141"></a>00141   <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;CreateMinimizer(TFitterMinuit::kMigrad);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <span class="comment">// initialise fit</span>
<a name="l00144"></a>00144   <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;SetParameter(0, <span class="stringliteral">&quot;PedestalOffset&quot;</span>, <a class="code" href="classTemplateMultiFitter.html#a1408bd52c4f30c6f9292575b0a835dbf">fPedestal</a>, 0.1, <a class="code" href="classTemplateMultiFitter.html#a774065f6731e9acc8082e06dadc9b620">fMinADC</a>, <a class="code" href="classTemplateMultiFitter.html#abf32cbeb98b5fc0b8f42716ac0998f9d">fMaxADC</a>);
<a name="l00145"></a>00145   <span class="keywordflow">for</span>(<a class="code" href="namespacemodules.html#aecc7811d5380ed9d9e903c9b71a396aa">TemplateList::const_iterator</a> i_tpl=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin(); i_tpl!=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.end(); ++i_tpl){
<a name="l00146"></a>00146       <span class="keywordtype">int</span> i=i_tpl-<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin();
<a name="l00147"></a>00147       <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;SetParameter(i+1, Form(<span class="stringliteral">&quot;AmplitudeScaleFactor_%d&quot;</span>,i), i_tpl-&gt;fAmplitudeScaleFactor, 0.1, <a class="code" href="classTemplateMultiFitter.html#a774065f6731e9acc8082e06dadc9b620">fMinADC</a>, <a class="code" href="classTemplateMultiFitter.html#abf32cbeb98b5fc0b8f42716ac0998f9d">fMaxADC</a>);
<a name="l00148"></a>00148       <a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>-&gt;<a class="code" href="classMultiHistogramFitFCN.html#a0dc9f40613a4c55eed0adf65f232376b">SetTimeOffset</a>(i, i_tpl-&gt;fTimeOffset);
<a name="l00149"></a>00149   }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151   <span class="comment">// run the fitter</span>
<a name="l00152"></a>00152   <span class="keywordtype">int</span> status = <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;Minimize(1000); 
<a name="l00153"></a>00153 
<a name="l00154"></a>00154   <span class="comment">// get fitted parameters</span>
<a name="l00155"></a>00155   std::vector&lt;double&gt; parameters(1+<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.size());
<a name="l00156"></a>00156   parameters[0]=<a class="code" href="classTemplateMultiFitter.html#a1408bd52c4f30c6f9292575b0a835dbf">fPedestal</a>=<a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;GetParameter(0); 
<a name="l00157"></a>00157   <span class="keywordflow">for</span>(<a class="code" href="namespacemodules.html#a5ce57c86284eadc5b573cfab0949bfdb">TemplateList::iterator</a> i_tpl=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin(); i_tpl!=<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.end(); ++i_tpl)
<a name="l00158"></a>00158      parameters[i_tpl-<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin()+1]=i_tpl-&gt;fAmplitudeScaleFactor= <a class="code" href="classTemplateMultiFitter.html#a90e2cd70d90405c9c9ba20a9021772e5">fMinuitFitter</a>-&gt;GetParameter(i_tpl-<a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.begin()+1);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160   <span class="comment">// check chi-2</span>
<a name="l00161"></a>00161   <a class="code" href="classTemplateMultiFitter.html#a7b11a532defa1386ca6ceb590a9c643f">fChi2</a> = (*fFitFCN)(parameters);
<a name="l00162"></a>00162   <a class="code" href="classTemplateMultiFitter.html#a0a484f277ee04d00751b195a38b1f836">fNDoF</a> = <a class="code" href="classTemplateMultiFitter.html#a3c187be7d5dbf79b81c8fbe5ca836ac5">fFitFCN</a>-&gt;<a class="code" href="classMultiHistogramFitFCN.html#ad2b0657d4f18967c4955008740d6e028">GetNDoF</a>();
<a name="l00163"></a>00163 
<a name="l00164"></a>00164   <span class="comment">// return status</span>
<a name="l00165"></a>00165   <span class="keywordflow">return</span> status;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="classTemplateMultiFitter.html#a31e53ab10ebad63cbe41bf48a3098fd4">00169</a> <span class="keywordtype">void</span> <a class="code" href="classTemplateMultiFitter.html#a31e53ab10ebad63cbe41bf48a3098fd4">TemplateMultiFitter::AddTemplate</a>(<a class="code" href="classTTemplate.html">TTemplate</a>* tpl){
<a name="l00170"></a>00170   <a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html">TemplateDetails_t</a> tmp;
<a name="l00171"></a>00171   tmp.<a class="code" href="structTemplateMultiFitter_1_1TemplateDetails__t.html#a242d297388de5ac9ed431067f6a2e106">fTemplate</a>=tpl;
<a name="l00172"></a>00172   <a class="code" href="classTemplateMultiFitter.html#a826c6a3900418b82a4de9d094969fd3f">fTemplates</a>.push_back(tmp);
<a name="l00173"></a>00173   <span class="keywordflow">if</span>(<a class="code" href="classTemplateMultiFitter.html#a16c5e6e2beb378e46976e2822c474438">fRefineFactor</a>==0) <a class="code" href="classTemplateMultiFitter.html#a16c5e6e2beb378e46976e2822c474438">fRefineFactor</a>=tpl-&gt;<a class="code" href="classTTemplate.html#acbf1a2f9a4d28429f24bdf00a518aac9">GetRefineFactor</a>();
<a name="l00174"></a>00174   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classTemplateMultiFitter.html#a16c5e6e2beb378e46976e2822c474438">fRefineFactor</a>!= tpl-&gt;<a class="code" href="classTTemplate.html#acbf1a2f9a4d28429f24bdf00a518aac9">GetRefineFactor</a>()){
<a name="l00175"></a>00175     <span class="keywordflow">throw</span> <a class="code" href="classExcept_1_1MismatchedTemplateRefineFactors.html">Except::MismatchedTemplateRefineFactors</a>();
<a name="l00176"></a>00176   }
<a name="l00177"></a>00177 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jan 2016 for AlcapDAQ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
