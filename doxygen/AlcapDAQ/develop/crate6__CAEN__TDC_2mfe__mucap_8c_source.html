<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ: crate6_CAEN_TDC/mfe_mucap.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>crate6_CAEN_TDC/mfe_mucap.c</h1><a href="crate6__CAEN__TDC_2mfe__mucap_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment">  Modified for muCap experiment to support PVIC transfers.</span>
<a name="l00003"></a>00003 <span class="comment">\********************************************************************/</span>
<a name="l00004"></a>00004 <span class="comment">/********************************************************************\</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Name:         mfe.c</span>
<a name="l00007"></a>00007 <span class="comment">  Created by:   Stefan Ritt</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">  Contents:     The system part of the MIDAS frontend. Has to be</span>
<a name="l00010"></a>00010 <span class="comment">                linked with user code to form a complete frontend</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">  $Log: mfe_mucap.c,v $</span>
<a name="l00013"></a>00013 <span class="comment">  Revision 1.2  2004/09/26 17:39:34  mucap</span>
<a name="l00014"></a>00014 <span class="comment">  Turned off MIDAS read/write buffer caching, since there have been many</span>
<a name="l00015"></a>00015 <span class="comment">  crashes of the mserver and event builder in code related to it.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  Revision 1.1  2004/09/23 10:06:57  mucap</span>
<a name="l00018"></a>00018 <span class="comment">  Adding mfe_mucap.c to the CVS repository (forgotten yesterday).</span>
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">  Revision 1.7  2003/08/21 07:31:30  mucap</span>
<a name="l00021"></a>00021 <span class="comment">  1. Moved extra cm_yield() calls from mfe_pvic.c to crate3.c, so they only</span>
<a name="l00022"></a>00022 <span class="comment">  happen while waiting for other crates to call in via RPC.</span>
<a name="l00023"></a>00023 <span class="comment"></span>
<a name="l00024"></a>00024 <span class="comment">  2. Only send updates to the equipment structure to the ODB when it has</span>
<a name="l00025"></a>00025 <span class="comment">  actually changed.</span>
<a name="l00026"></a>00026 <span class="comment"></span>
<a name="l00027"></a>00027 <span class="comment">  3. (Important) Force flush of event buffers at the beginning of each event&apos;s</span>
<a name="l00028"></a>00028 <span class="comment">  livetime.</span>
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">  4. Added some deadtime debugging information on VMIC output 8.  This should</span>
<a name="l00031"></a>00031 <span class="comment">  probably go away eventually.</span>
<a name="l00032"></a>00032 <span class="comment"></span>
<a name="l00033"></a>00033 <span class="comment">  Revision 1.6  2003/08/20 06:29:25  mucap</span>
<a name="l00034"></a>00034 <span class="comment">  Changes are from attempts at improving the throughput and reducing the</span>
<a name="l00035"></a>00035 <span class="comment">  deadtime of the DAQ.  Amongst other things, the DAQ now has zero-copy</span>
<a name="l00036"></a>00036 <span class="comment">  networking installed, as well as dual-threading of processes in crate3.</span>
<a name="l00037"></a>00037 <span class="comment"></span>
<a name="l00038"></a>00038 <span class="comment">  Revision 1.5  2003/08/01 02:31:56  mucap</span>
<a name="l00039"></a>00039 <span class="comment">  I performed this commit to record changes I made to crate3.cpp, that were</span>
<a name="l00040"></a>00040 <span class="comment">  intended to make the CAENs more robust regarding the DLL performance.</span>
<a name="l00041"></a>00041 <span class="comment">  However, Fred had made several changes in the past (to Makefile, crate12,</span>
<a name="l00042"></a>00042 <span class="comment">  crate3, and mfe_pvic) that were apparently never committed, so they are</span>
<a name="l00043"></a>00043 <span class="comment">  being comitted now.</span>
<a name="l00044"></a>00044 <span class="comment"></span>
<a name="l00045"></a>00045 <span class="comment">  Revision 1.4  2003/06/30 15:06:45  mucap</span>
<a name="l00046"></a>00046 <span class="comment">  mfe_pvic modified to call cm_yield less frequently (previously after every</span>
<a name="l00047"></a>00047 <span class="comment">  active cycle, now once per millisecond).</span>
<a name="l00048"></a>00048 <span class="comment"></span>
<a name="l00049"></a>00049 <span class="comment">  crate_common.h modified to give the CAEN and COMP temporary arrays bigger</span>
<a name="l00050"></a>00050 <span class="comment">  buffers.</span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">  crate3.cpp: eliminated 8-byte alignment, and some improved error handling.</span>
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a>00054 <span class="comment">  crate12.cpp: improved error-handling, particularly in the case when there</span>
<a name="l00055"></a>00055 <span class="comment">  were inexplicable bus errors while transferring data from a full, or nearly</span>
<a name="l00056"></a>00056 <span class="comment">  full, TDC400.  In this case, it retries the pread until all data is read,</span>
<a name="l00057"></a>00057 <span class="comment">  and a message is logged.  Also, reduced the elr &quot;full&quot; limit to 32K (from</span>
<a name="l00058"></a>00058 <span class="comment">  32K binary), so that there is some breathing room for when the TDC400 fills</span>
<a name="l00059"></a>00059 <span class="comment">  almost all the way (that is, time for the end_event signal to register, and</span>
<a name="l00060"></a>00060 <span class="comment">  prevent the TDC400 from wrapping around).</span>
<a name="l00061"></a>00061 <span class="comment"></span>
<a name="l00062"></a>00062 <span class="comment">  Revision 1.3  2003/05/27 16:22:14  mucap</span>
<a name="l00063"></a>00063 <span class="comment">  Update to new mfe.c from MIDAS CVS.</span>
<a name="l00064"></a>00064 <span class="comment"></span>
<a name="l00065"></a>00065 <span class="comment">  Revision 1.2  2003/04/28 07:48:29  mucap</span>
<a name="l00066"></a>00066 <span class="comment"></span>
<a name="l00067"></a>00067 <span class="comment">  No major changes here; just saving the current versions for security.</span>
<a name="l00068"></a>00068 <span class="comment"></span>
<a name="l00069"></a>00069 <span class="comment">  Revision 1.1  2003/04/23 07:50:04  mucap</span>
<a name="l00070"></a>00070 <span class="comment">  Grand reorganization of the CVS repository, dividing files into subdirectories.</span>
<a name="l00071"></a>00071 <span class="comment">  This also pulls in an updated version of the WFD frontend, since it had</span>
<a name="l00072"></a>00072 <span class="comment">  previously been languishing on mulandaq.</span>
<a name="l00073"></a>00073 <span class="comment"></span>
<a name="l00074"></a>00074 <span class="comment">  Revision 1.2  2003/04/23 07:17:48  mucap</span>
<a name="l00075"></a>00075 <span class="comment">  Performance improvements:</span>
<a name="l00076"></a>00076 <span class="comment">  - Eliminated 500 ms wait between calls to cm_yield(0) in mfe_pvic.c</span>
<a name="l00077"></a>00077 <span class="comment">  - Eliminated loop in poll_event in crate12.cpp and crate3.cpp</span>
<a name="l00078"></a>00078 <span class="comment">  - Eliminated ODB access for buffer allocation and deallocation in</span>
<a name="l00079"></a>00079 <span class="comment">     crate_common.cpp</span>
<a name="l00080"></a>00080 <span class="comment">  - Eliminated 10 ms sleep calls in ResetHardware() in crate3.cpp</span>
<a name="l00081"></a>00081 <span class="comment"></span>
<a name="l00082"></a>00082 <span class="comment">  Revision 1.1  2003/04/21 15:48:26  mucap</span>
<a name="l00083"></a>00083 <span class="comment"></span>
<a name="l00084"></a>00084 <span class="comment">  Final major DAQ step accomplished!  The crate programs crate12.cpp and</span>
<a name="l00085"></a>00085 <span class="comment">  crate3.cpp have been reconfigured so that the crates all operate now as</span>
<a name="l00086"></a>00086 <span class="comment">  MIDAS front ends.  There is substantial cleanup which remains to be done,</span>
<a name="l00087"></a>00087 <span class="comment">  the DAQ operation is nowhere near optimization (it&apos;s running very slowly</span>
<a name="l00088"></a>00088 <span class="comment">  for some reason), and there are lingering questions about &quot;re-entered&quot; RPC</span>
<a name="l00089"></a>00089 <span class="comment">  calls, but the DAQ is nevertheless running (repeatedly) without any major</span>
<a name="l00090"></a>00090 <span class="comment"> problems.</span>
<a name="l00091"></a>00091 <span class="comment"></span>
<a name="l00092"></a>00092 <span class="comment">   Revision 1.55  2003/05/09 07:40:04  midas</span>
<a name="l00093"></a>00093 <span class="comment">   Added extra parameter to cm_get_environment</span>
<a name="l00094"></a>00094 <span class="comment"></span>
<a name="l00095"></a>00095 <span class="comment">   Revision 1.54  2003/05/07 10:57:10  midas</span>
<a name="l00096"></a>00096 <span class="comment">   Removed tabs</span>
<a name="l00097"></a>00097 <span class="comment"></span>
<a name="l00098"></a>00098 <span class="comment">   Revision 1.53  2003/04/25 10:41:42  midas</span>
<a name="l00099"></a>00099 <span class="comment">   Removed FTCP mode in update_odb()</span>
<a name="l00100"></a>00100 <span class="comment"></span>
<a name="l00101"></a>00101 <span class="comment">   Revision 1.52  2003/04/25 07:45:03  midas</span>
<a name="l00102"></a>00102 <span class="comment">   Write first event to ODB only if logger uses ROOT format</span>
<a name="l00103"></a>00103 <span class="comment"></span>
<a name="l00104"></a>00104 <span class="comment">   Revision 1.51  2003/04/14 12:40:23  midas</span>
<a name="l00105"></a>00105 <span class="comment">   Create ODB entries for structured banks derived from BANK_LIST in frontend.c</span>
<a name="l00106"></a>00106 <span class="comment"></span>
<a name="l00107"></a>00107 <span class="comment">   Revision 1.50  2003/04/14 05:12:54  pierre</span>
<a name="l00108"></a>00108 <span class="comment">   fix send_event for handle=0</span>
<a name="l00109"></a>00109 <span class="comment"></span>
<a name="l00110"></a>00110 <span class="comment">   Revision 1.49  2003/04/01 19:22:44  pierre</span>
<a name="l00111"></a>00111 <span class="comment">   fix update_odb for hKeyl copy</span>
<a name="l00112"></a>00112 <span class="comment"></span>
<a name="l00113"></a>00113 <span class="comment">   Revision 1.48  2003/03/31 08:27:34  midas</span>
<a name="l00114"></a>00114 <span class="comment">   Fixed alignment bug for strings</span>
<a name="l00115"></a>00115 <span class="comment"></span>
<a name="l00116"></a>00116 <span class="comment">   Revision 1.47  2003/03/28 09:13:05  midas</span>
<a name="l00117"></a>00117 <span class="comment">   Added warning for uncreated structured banks</span>
<a name="l00118"></a>00118 <span class="comment"></span>
<a name="l00119"></a>00119 <span class="comment">   Revision 1.46  2003/03/28 08:55:11  midas</span>
<a name="l00120"></a>00120 <span class="comment">   Added code for structured banks</span>
<a name="l00121"></a>00121 <span class="comment"></span>
<a name="l00122"></a>00122 <span class="comment">   Revision 1.45  2002/10/15 18:44:23  olchansk</span>
<a name="l00123"></a>00123 <span class="comment">   fix printf() and cm_msg() format mismatches</span>
<a name="l00124"></a>00124 <span class="comment"></span>
<a name="l00125"></a>00125 <span class="comment">   Revision 1.44  2002/10/15 18:15:25  olchansk   </span>
<a name="l00126"></a>00126 <span class="comment">   disable dtsout, stderr buffering,</span>
<a name="l00127"></a>00127 <span class="comment">   catch-ignore SIGPIPE</span>
<a name="l00128"></a>00128 <span class="comment"></span>
<a name="l00129"></a>00129 <span class="comment">   Revision 1.43  2002/10/15 18:13:59  olchansk</span>
<a name="l00130"></a>00130 <span class="comment">   always recreate the statistics record.</span>
<a name="l00131"></a>00131 <span class="comment"></span>
<a name="l00132"></a>00132 <span class="comment">   Revision 1.42  2002/10/15 18:09:59  olchansk</span>
<a name="l00133"></a>00133 <span class="comment">   catch bm_xxx() errors and bail out from schedule(). This fixes infinite loop</span>
<a name="l00134"></a>00134 <span class="comment">ing after rpc timeouts.</span>
<a name="l00135"></a>00135 <span class="comment"></span>
<a name="l00136"></a>00136 <span class="comment">  Revision 1.41  2002/09/13 07:32:47  midas</span>
<a name="l00137"></a>00137 <span class="comment">  Added client name to cm_cleanup()</span>
<a name="l00138"></a>00138 <span class="comment"></span>
<a name="l00139"></a>00139 <span class="comment">  Revision 1.40  2002/06/03 06:07:15  midas</span>
<a name="l00140"></a>00140 <span class="comment">  Added extra parameter to ss_daemon_init to keep stdout</span>
<a name="l00141"></a>00141 <span class="comment"></span>
<a name="l00142"></a>00142 <span class="comment">  Revision 1.39  2002/05/15 23:43:56  midas</span>
<a name="l00143"></a>00143 <span class="comment">  Added event fragmentation</span>
<a name="l00144"></a>00144 <span class="comment"></span>
<a name="l00145"></a>00145 <span class="comment">  Revision 1.38  2002/05/10 01:41:19  midas</span>
<a name="l00146"></a>00146 <span class="comment">  Added optional debug output to cm_transition</span>
<a name="l00147"></a>00147 <span class="comment"></span>
<a name="l00148"></a>00148 <span class="comment">  Revision 1.37  2002/05/08 19:54:40  midas</span>
<a name="l00149"></a>00149 <span class="comment">  Added extra parameter to function db_get_value()</span>
<a name="l00150"></a>00150 <span class="comment"></span>
<a name="l00151"></a>00151 <span class="comment">  Revision 1.36  2001/11/21 08:37:32  midas</span>
<a name="l00152"></a>00152 <span class="comment">  Took out db_delete_key for statistics again (not needed)</span>
<a name="l00153"></a>00153 <span class="comment"></span>
<a name="l00154"></a>00154 <span class="comment">  Revision 1.35  2001/11/20 19:22:07  pierre</span>
<a name="l00155"></a>00155 <span class="comment">  - Add rpc_flush_event in case no periodic eqp</span>
<a name="l00156"></a>00156 <span class="comment">  - Force rpc_flush_event for low trigger rate</span>
<a name="l00157"></a>00157 <span class="comment">  - Patch /Statistics in case it exists but size=0</span>
<a name="l00158"></a>00158 <span class="comment"></span>
<a name="l00159"></a>00159 <span class="comment">  Revision 1.34  2001/06/27 12:34:49  midas</span>
<a name="l00160"></a>00160 <span class="comment">  Added -D flag to become a daemon</span>
<a name="l00161"></a>00161 <span class="comment"></span>
<a name="l00162"></a>00162 <span class="comment">  Revision 1.33  2001/04/06 04:13:40  midas</span>
<a name="l00163"></a>00163 <span class="comment">  Put cm_cleanup() in init code</span>
<a name="l00164"></a>00164 <span class="comment"></span>
<a name="l00165"></a>00165 <span class="comment">  Revision 1.32  2001/01/29 09:50:53  midas</span>
<a name="l00166"></a>00166 <span class="comment">  Changed send_event() parameter from event_id to equipment index</span>
<a name="l00167"></a>00167 <span class="comment"></span>
<a name="l00168"></a>00168 <span class="comment">  Revision 1.31  2000/11/14 08:30:03  midas</span>
<a name="l00169"></a>00169 <span class="comment">  SLOW events are not any more sent to the ODB when the history is on</span>
<a name="l00170"></a>00170 <span class="comment"></span>
<a name="l00171"></a>00171 <span class="comment">  Revision 1.30  2000/11/06 10:10:23  midas</span>
<a name="l00172"></a>00172 <span class="comment">  Flush events for set-ups with only non-periodic events</span>
<a name="l00173"></a>00173 <span class="comment"></span>
<a name="l00174"></a>00174 <span class="comment">  Revision 1.29  2000/10/23 14:19:06  midas</span>
<a name="l00175"></a>00175 <span class="comment">  Added idle period for slow control equipment</span>
<a name="l00176"></a>00176 <span class="comment"></span>
<a name="l00177"></a>00177 <span class="comment">  Revision 1.28  2000/09/28 13:16:02  midas</span>
<a name="l00178"></a>00178 <span class="comment">  Fixed bug that MANUAL_TRIG only events are not read out during transitions</span>
<a name="l00179"></a>00179 <span class="comment"></span>
<a name="l00180"></a>00180 <span class="comment">  Revision 1.27  2000/09/28 13:02:03  midas</span>
<a name="l00181"></a>00181 <span class="comment">  Added manual triggered events</span>
<a name="l00182"></a>00182 <span class="comment"></span>
<a name="l00183"></a>00183 <span class="comment">  Revision 1.26  2000/08/21 11:01:11  midas</span>
<a name="l00184"></a>00184 <span class="comment">  Changed comments</span>
<a name="l00185"></a>00185 <span class="comment"></span>
<a name="l00186"></a>00186 <span class="comment">  Revision 1.25  2000/08/21 10:44:58  midas</span>
<a name="l00187"></a>00187 <span class="comment">  Removed reconnect functionality, it&apos;s better to restart the frontend via</span>
<a name="l00188"></a>00188 <span class="comment">  /programs/frontend/auto restart.</span>
<a name="l00189"></a>00189 <span class="comment"></span>
<a name="l00190"></a>00190 <span class="comment">  Revision 1.24  2000/08/21 10:36:41  midas</span>
<a name="l00191"></a>00191 <span class="comment">  Reworked event and event buffer sizes:</span>
<a name="l00192"></a>00192 <span class="comment">  - Both max_event_size and event_buffer_size must be defined in user code</span>
<a name="l00193"></a>00193 <span class="comment">  - While max_event_size is used for frontend buffers, MAX_EVENT_SIZE is the</span>
<a name="l00194"></a>00194 <span class="comment">    system limit which must be larger than max_event_size</span>
<a name="l00195"></a>00195 <span class="comment">  - Event size returned from user readout routine is now checked against event</span>
<a name="l00196"></a>00196 <span class="comment">    size limits</span>
<a name="l00197"></a>00197 <span class="comment">  - Buffer settings are now always displayed, not only under VxWorks</span>
<a name="l00198"></a>00198 <span class="comment"></span>
<a name="l00199"></a>00199 <span class="comment">  Revision 1.23  2000/08/09 12:02:43  midas</span>
<a name="l00200"></a>00200 <span class="comment">  Evaluate return status in tr_xxx functions properly</span>
<a name="l00201"></a>00201 <span class="comment"></span>
<a name="l00202"></a>00202 <span class="comment">  Revision 1.22  2000/08/09 11:37:56  midas</span>
<a name="l00203"></a>00203 <span class="comment">  Rearranged serial number increments</span>
<a name="l00204"></a>00204 <span class="comment"></span>
<a name="l00205"></a>00205 <span class="comment">  Revision 1.21  2000/07/11 16:43:40  pierre</span>
<a name="l00206"></a>00206 <span class="comment">  - Fix serial number for POLL super event.</span>
<a name="l00207"></a>00207 <span class="comment"></span>
<a name="l00208"></a>00208 <span class="comment">  Revision 1.20  2000/04/03 12:27:43  midas</span>
<a name="l00209"></a>00209 <span class="comment">  Changed auto restart to 20 seconds in main loop</span>
<a name="l00210"></a>00210 <span class="comment"></span>
<a name="l00211"></a>00211 <span class="comment">  Revision 1.19  2000/03/22 14:42:48  midas</span>
<a name="l00212"></a>00212 <span class="comment">  Fixed bug with invalid pointer</span>
<a name="l00213"></a>00213 <span class="comment"></span>
<a name="l00214"></a>00214 <span class="comment">  Revision 1.18  2000/03/17 13:00:05  midas</span>
<a name="l00215"></a>00215 <span class="comment">  Frontends use default timeout fo 60 sec.</span>
<a name="l00216"></a>00216 <span class="comment"></span>
<a name="l00217"></a>00217 <span class="comment">  Revision 1.17  2000/03/01 23:29:20  midas</span>
<a name="l00218"></a>00218 <span class="comment">  Fixed bug with wrong event header data size in super eventsvents mfe.c</span>
<a name="l00219"></a>00219 <span class="comment"></span>
<a name="l00220"></a>00220 <span class="comment">  Revision 1.16  2000/02/29 21:59:45  midas</span>
<a name="l00221"></a>00221 <span class="comment">  Added auto restart</span>
<a name="l00222"></a>00222 <span class="comment"></span>
<a name="l00223"></a>00223 <span class="comment">  Revision 1.15  2000/02/26 01:25:54  midas</span>
<a name="l00224"></a>00224 <span class="comment">  Fixed bug that number of sent events was not cleared at start</span>
<a name="l00225"></a>00225 <span class="comment"></span>
<a name="l00226"></a>00226 <span class="comment">  Revision 1.14  2000/02/25 20:22:49  midas</span>
<a name="l00227"></a>00227 <span class="comment">  Added super-event scheme</span>
<a name="l00228"></a>00228 <span class="comment"></span>
<a name="l00229"></a>00229 <span class="comment">  Revision 1.13  2000/02/24 22:38:19  midas</span>
<a name="l00230"></a>00230 <span class="comment">  Outcommented USE_EVENT_CHANNEL</span>
<a name="l00231"></a>00231 <span class="comment"></span>
<a name="l00232"></a>00232 <span class="comment">  Revision 1.12  2000/02/24 22:29:24  midas</span>
<a name="l00233"></a>00233 <span class="comment">  Added deferred transitions</span>
<a name="l00234"></a>00234 <span class="comment"></span>
<a name="l00235"></a>00235 <span class="comment">  Revision 1.11  1999/12/08 00:50:29  pierre</span>
<a name="l00236"></a>00236 <span class="comment">  - fix EVID (ybos: strncpy to strncmp)</span>
<a name="l00237"></a>00237 <span class="comment"></span>
<a name="l00238"></a>00238 <span class="comment">  Revision 1.10  1999/11/24 00:49:59  pierre</span>
<a name="l00239"></a>00239 <span class="comment">  - YBOS reject EVID bank in udpate_odb with eb_functions</span>
<a name="l00240"></a>00240 <span class="comment"></span>
<a name="l00241"></a>00241 <span class="comment">  Revision 1.9  1999/11/23 18:25:25  pierre</span>
<a name="l00242"></a>00242 <span class="comment">  - YBOS reject EVID bank in udpate_odb</span>
<a name="l00243"></a>00243 <span class="comment"></span>
<a name="l00244"></a>00244 <span class="comment">  Revision 1.8  1999/10/18 14:41:51  midas</span>
<a name="l00245"></a>00245 <span class="comment">  Use /programs/&lt;name&gt;/Watchdog timeout in all programs as timeout value. The</span>
<a name="l00246"></a>00246 <span class="comment">  default value can be submitted by calling cm_connect_experiment1(..., timeout)</span>
<a name="l00247"></a>00247 <span class="comment"></span>
<a name="l00248"></a>00248 <span class="comment">  Revision 1.7  1999/10/15 12:17:52  midas</span>
<a name="l00249"></a>00249 <span class="comment">  Increased timeout</span>
<a name="l00250"></a>00250 <span class="comment"></span>
<a name="l00251"></a>00251 <span class="comment">  Revision 1.6  1999/09/27 13:49:04  midas</span>
<a name="l00252"></a>00252 <span class="comment">  Added bUnique parameter to cm_shutdown</span>
<a name="l00253"></a>00253 <span class="comment"></span>
<a name="l00254"></a>00254 <span class="comment">  Revision 1.5  1999/09/23 12:45:48  midas</span>
<a name="l00255"></a>00255 <span class="comment">  Added 32 bit banks</span>
<a name="l00256"></a>00256 <span class="comment"></span>
<a name="l00257"></a>00257 <span class="comment">  Revision 1.4  1999/06/23 09:38:51  midas</span>
<a name="l00258"></a>00258 <span class="comment">  - Added D8_BKTYPE</span>
<a name="l00259"></a>00259 <span class="comment">  - Fixed CAMAC server F24 bug</span>
<a name="l00260"></a>00260 <span class="comment">  - cm_synchronize only called for VxWorks</span>
<a name="l00261"></a>00261 <span class="comment"></span>
<a name="l00262"></a>00262 <span class="comment">  Revision 1.3  1998/12/10 12:50:47  midas</span>
<a name="l00263"></a>00263 <span class="comment">  Program abort with &quot;!&quot; now works without a return under UNIX</span>
<a name="l00264"></a>00264 <span class="comment"></span>
<a name="l00265"></a>00265 <span class="comment">  Revision 1.2  1998/10/12 12:19:01  midas</span>
<a name="l00266"></a>00266 <span class="comment">  Added Log tag in header</span>
<a name="l00267"></a>00267 <span class="comment"></span>
<a name="l00268"></a>00268 <span class="comment"></span>
<a name="l00269"></a>00269 <span class="comment">\********************************************************************/</span>
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00272"></a>00272 <span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<a name="l00273"></a>00273 <span class="preprocessor">#include &quot;<a class="code" href="msystem_8h.html">msystem.h</a>&quot;</span>
<a name="l00274"></a>00274 <span class="preprocessor">#include &quot;<a class="code" href="mcstd_8h.html">mcstd.h</a>&quot;</span>
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="preprocessor">#ifdef YBOS_SUPPORT</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="ybos_8h.html">ybos.h</a>&quot;</span>
<a name="l00278"></a>00278 <span class="preprocessor">#endif</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span>
<a name="l00280"></a>00280 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 <span class="comment">/* items defined in frontend.c */</span>
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="crate3_2crate_8cpp.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>;
<a name="l00285"></a>00285 <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="crate3_2crate_8cpp.html#aa045f89d0b0691cb1d05174b13369750">frontend_file_name</a>;
<a name="l00286"></a>00286 <span class="keyword">extern</span> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate3_2crate_8cpp.html#a0215c0a842a0e97fe65c7ef5fb7633a5">frontend_call_loop</a>;
<a name="l00287"></a>00287 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>;
<a name="l00288"></a>00288 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>;
<a name="l00289"></a>00289 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a>;
<a name="l00290"></a>00290 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>;
<a name="l00291"></a>00291 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#a34c51ae8c88f4717087b0604975516f4">frontend_init</a>(<span class="keywordtype">void</span>);
<a name="l00292"></a>00292 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#aea5c34cabeee99adba19dad1031f8cf5">frontend_early_init</a>(<span class="keywordtype">void</span>);
<a name="l00293"></a>00293 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#a15271255cca6c92978b28afd5a548382">frontend_exit</a>(<span class="keywordtype">void</span>);
<a name="l00294"></a>00294 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#ada66837c3c3d263974ad717921145e0a">frontend_loop</a>(<span class="keywordtype">void</span>);
<a name="l00295"></a>00295 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#ad8bfe703c49342b9f0275aba77dc7758">begin_of_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00296"></a>00296 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#af766efbcdb941457282517ccbaa1f5a3">pre_begin_of_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00297"></a>00297 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#ae6d798649008b7523c77222bae2d4187">end_of_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00298"></a>00298 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="examples_2macro_2midas__macro_8h.html#ac13d5e945d03bd84233e479cad2d892a">pause_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00299"></a>00299 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="examples_2macro_2midas__macro_8h.html#a392520a13432f29f450f40456e26960f">resume_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00300"></a>00300 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> source, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>, <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="sis3803_8c.html#a8fa8e4c8bef10b038f6a033f736d5bce">test</a>);
<a name="l00301"></a>00301 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> source, <a class="code" href="group__midasincludecode.html#ga790216a8e71233fed28657b16a052e36">PTYPE</a> adr);
<a name="l00302"></a>00302 <span class="preprocessor">#ifdef USE_PVIC</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pvic_pointer_get();
<a name="l00304"></a>00304 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> pvic_send_event(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> buffer_handle, <span class="keywordtype">void</span> *source, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> buf_size,
<a name="l00305"></a>00305                            <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> async_flag);
<a name="l00306"></a>00306 <span class="preprocessor">#endif</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span>
<a name="l00308"></a>00308 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 <span class="comment">/* globals */</span>
<a name="l00311"></a>00311 
<a name="l00312"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a78e85b2d6d76fbf2db95b68e29c5bb99">00312</a> <span class="preprocessor">#define USE_EVENT_CHANNEL 1</span>
<a name="l00313"></a>00313 <span class="preprocessor"></span>
<a name="l00314"></a>00314 <span class="comment">//#define SERVER_CACHE_SIZE  1000000 /* event cache before buffer */</span>
<a name="l00315"></a>00315 <span class="comment">// turned off cacheing to see if it improves stability</span>
<a name="l00316"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a022c39e327f494dda3664f8888f860f1">00316</a> <span class="preprocessor">#define SERVER_CACHE_SIZE  0 </span><span class="comment">/* event cache before buffer */</span>
<a name="l00317"></a>00317 
<a name="l00318"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a380a50d445745c2da54a29a1f2e5099e">00318</a> <span class="preprocessor">#define ODB_UPDATE_TIME      1000 </span><span class="comment">/* 1 seconds for ODB update */</span>
<a name="l00319"></a>00319 
<a name="l00320"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a093e717ef9582e83efcc2550ef0c28cb">00320</a> <span class="preprocessor">#define DEFAULT_FE_TIMEOUT  60000 </span><span class="comment">/* 60 seconds for watchdog timeout */</span>
<a name="l00321"></a>00321 
<a name="l00322"></a><a class="code" href="crate9_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">00322</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>   <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>;       <span class="comment">/* STATE_RUNNING, STATE_STOPPED, STATE_PAUSED */</span>
<a name="l00323"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">00323</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>;
<a name="l00324"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">00324</a> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;      <span class="comment">/* current time in seconds since 1970 */</span>
<a name="l00325"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">00325</a> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;       <span class="comment">/* current time in milliseconds */</span>
<a name="l00326"></a>00326 
<a name="l00327"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">00327</a> <span class="keywordtype">char</span>  <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[<a class="code" href="group__midasincludecode.html#ga2010c9ed4ef21c3171de778157b9c494">HOST_NAME_LENGTH</a>];
<a name="l00328"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">00328</a> <span class="keywordtype">char</span>  <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>];
<a name="l00329"></a>00329 
<a name="l00330"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">00330</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a>;
<a name="l00331"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a17033889b9f2e378c3bc26401a399550">00331</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a17033889b9f2e378c3bc26401a399550">optimize</a> = 0;      <span class="comment">/* set this to one to opimize TCP buffer size */</span>
<a name="l00332"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8432f49f703ed2d20248effc3125b0e1">00332</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8432f49f703ed2d20248effc3125b0e1">fe_stop</a> = 0;       <span class="comment">/* stop switch for VxWorks */</span>
<a name="l00333"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">00333</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>  <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a>;             <span class="comment">/* disable watchdog messages from server */</span>
<a name="l00334"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">00334</a> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = 0;  <span class="comment">/* restart run after event limit reached stop */</span>
<a name="l00335"></a>00335 
<a name="l00336"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ab1f60c53f74e806a3b9f687af38d7421">00336</a> <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="preprocessor">#ifdef YBOS_SUPPORT</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span><span class="keyword">struct </span>{
<a name="l00340"></a>00340   <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mfe_8c.html#a828e11dd0709056d2788881cfdd2cc45">ybos_type</a>;
<a name="l00341"></a>00341   <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mfe_8c.html#abcb124395ac9b3b5182782a33e3abf31">odb_type</a>;
<a name="l00342"></a>00342   <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mfe_8c.html#aa1506b3a082cd269e4e733382ba0df79">tsize</a>;
<a name="l00343"></a>00343 } <a class="code" href="mfe_8c.html#aa14e5ae35b977069fad12c300037429c">id_map</a>[] = {
<a name="l00344"></a>00344   {<a class="code" href="group__ybosdefineh.html#ga07cd0ef2852310d130deaf0d4ef7bfd4">A1_BKTYPE</a>, <a class="code" href="group__mdefineh.html#gad4af77af5f2910e73596592030e37ab7">TID_CHAR</a>, 1},
<a name="l00345"></a>00345   {<a class="code" href="group__ybosdefineh.html#ga37b2a5de4003dff9ef6837b6f99a0a69">I1_BKTYPE</a>, <a class="code" href="group__mdefineh.html#ga7499d3aa0ca98d255f5147494ab4f572">TID_BYTE</a>, 1},
<a name="l00346"></a>00346   {<a class="code" href="group__ybosdefineh.html#ga4b6b5459b4c74b76ee12197538fe6d1d">I2_BKTYPE</a>, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>, 2},
<a name="l00347"></a>00347   {<a class="code" href="group__ybosdefineh.html#gac78b656213d4a1fb1fd9bf9bd8c46f09">I4_BKTYPE</a>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, 4},
<a name="l00348"></a>00348   {<a class="code" href="group__ybosdefineh.html#ga07c32fd205319ee4bd3b6adde65058d6">F4_BKTYPE</a>, <a class="code" href="group__mdefineh.html#gae932ec1b283f6c4b9c30a6d489beea7f">TID_FLOAT</a>, 4},
<a name="l00349"></a>00349   {<a class="code" href="group__ybosdefineh.html#gaba3ee4247e6ef5302ba5a83079a338e0">D8_BKTYPE</a>, <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>, 8},
<a name="l00350"></a>00350   {0,0}
<a name="l00351"></a>00351 };
<a name="l00352"></a>00352 <span class="preprocessor">#endif</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span>
<a name="l00354"></a>00354 <span class="keyword">extern</span> <a class="code" href="structeqpmnt.html">EQUIPMENT</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#ae8b8f6d8b9bae4600c7eac6eee4e57b4">equipment</a>[];
<a name="l00355"></a>00355 
<a name="l00356"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ae08e1d173902a2cb83c58d268c6e4d3e">00356</a> <a class="code" href="structeqpmnt.html">EQUIPMENT</a>     *<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ae08e1d173902a2cb83c58d268c6e4d3e">interrupt_eq</a> = NULL;
<a name="l00357"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a60722870df369344fb7ad351892998ab">00357</a> <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>  *<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a60722870df369344fb7ad351892998ab">interrupt_odb_buffer</a>;
<a name="l00358"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aadf15a6e815e15b52fe5680277483e63">00358</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>          <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aadf15a6e815e15b52fe5680277483e63">interrupt_odb_buffer_valid</a>;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="keywordtype">int</span>  <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">send_event</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>);
<a name="l00361"></a>00361 <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#aed2a9a6c57de716dc564331cca8f0a85">transition</a>);
<a name="l00362"></a>00362 <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">interrupt_routine</a>(<span class="keywordtype">void</span>);
<a name="l00363"></a>00363 <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>);
<a name="l00364"></a>00364 <span class="keywordtype">void</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> bInit);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 <span class="comment">/*---- ODB records -------------------------------------------------*/</span>
<a name="l00367"></a>00367 
<a name="l00368"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac92b30327caaa939b1b6630775c78ecd">00368</a> <span class="preprocessor">#define EQUIPMENT_COMMON_STR &quot;\</span>
<a name="l00369"></a>00369 <span class="preprocessor">Event ID = WORD : 0\n\</span>
<a name="l00370"></a>00370 <span class="preprocessor">Trigger mask = WORD : 0\n\</span>
<a name="l00371"></a>00371 <span class="preprocessor">Buffer = STRING : [32] SYSTEM\n\</span>
<a name="l00372"></a>00372 <span class="preprocessor">Type = INT : 0\n\</span>
<a name="l00373"></a>00373 <span class="preprocessor">Source = INT : 0\n\</span>
<a name="l00374"></a>00374 <span class="preprocessor">Format = STRING : [8] FIXED\n\</span>
<a name="l00375"></a>00375 <span class="preprocessor">Enabled = BOOL : 0\n\</span>
<a name="l00376"></a>00376 <span class="preprocessor">Read on = INT : 0\n\</span>
<a name="l00377"></a>00377 <span class="preprocessor">Period = INT : 0\n\</span>
<a name="l00378"></a>00378 <span class="preprocessor">Event limit = DOUBLE : 0\n\</span>
<a name="l00379"></a>00379 <span class="preprocessor">Num subevents = DWORD : 0\n\</span>
<a name="l00380"></a>00380 <span class="preprocessor">Log history = INT : 0\n\</span>
<a name="l00381"></a>00381 <span class="preprocessor">Frontend host = STRING : [32] \n\</span>
<a name="l00382"></a>00382 <span class="preprocessor">Frontend name = STRING : [32] \n\</span>
<a name="l00383"></a>00383 <span class="preprocessor">Frontend file name = STRING : [256] \n\</span>
<a name="l00384"></a>00384 <span class="preprocessor">&quot;</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span>
<a name="l00386"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6064db0cc46885d207cedb497e3c355e">00386</a> <span class="preprocessor">#define EQUIPMENT_STATISTICS_STR &quot;\</span>
<a name="l00387"></a>00387 <span class="preprocessor">Events sent = DOUBLE : 0\n\</span>
<a name="l00388"></a>00388 <span class="preprocessor">Events per sec. = DOUBLE : 0\n\</span>
<a name="l00389"></a>00389 <span class="preprocessor">kBytes per sec. = DOUBLE : 0\n\</span>
<a name="l00390"></a>00390 <span class="preprocessor">&quot;</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span>
<a name="l00392"></a>00392 <span class="comment">/*-- transition callbacks ------------------------------------------*/</span>
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 <span class="comment">/*-- prestart ---------------------------------------------------------*/</span>
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#add7f1295fb688b84e58b96a50eae8df6">00396</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a6e149fe266abfc4575be750a5ae1d3b0">tr_prestart</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398   <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00399"></a>00399   status = <a class="code" href="crate3_2crate_8cpp.html#af766efbcdb941457282517ccbaa1f5a3">pre_begin_of_run</a>(rn, error);
<a name="l00400"></a>00400   <span class="keywordflow">return</span> status;
<a name="l00401"></a>00401 }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 <span class="comment">/*-- start ---------------------------------------------------------*/</span>
<a name="l00404"></a>00404 
<a name="l00405"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a5ed14877e514f13eeb65a16898b2ba32">00405</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a5ed14877e514f13eeb65a16898b2ba32">tr_start</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l00406"></a>00406 {
<a name="l00407"></a>00407 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409   <span class="comment">/* reset serial numbers */</span>
<a name="l00410"></a>00410   <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l00411"></a>00411     {
<a name="l00412"></a>00412     equipment[i].<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a> = 1;
<a name="l00413"></a>00413     equipment[i].<a class="code" href="group__midasincludecode.html#ga1649c4fed8b7c97441a167a860cae4af">subevent_number</a> = 0;
<a name="l00414"></a>00414     equipment[i].<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> = 0;
<a name="l00415"></a>00415     equipment[i].<a class="code" href="group__midasincludecode.html#gab487ff66b0ceb7677a3e664717158c51">odb_in</a> = equipment[i].<a class="code" href="group__midasincludecode.html#ga2ba622da82fc7a02605e5f630464b13f">odb_out</a> = 0;
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418   status = <a class="code" href="crate3_2crate_8cpp.html#ad8bfe703c49342b9f0275aba77dc7758">begin_of_run</a>(rn, error);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420   <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l00421"></a>00421     {
<a name="l00422"></a>00422     <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>;
<a name="l00423"></a>00423     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00428"></a>00428       {
<a name="l00429"></a>00429       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, 2, <span class="stringliteral">&quot;Running &quot;</span>);
<a name="l00430"></a>00430       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(36, 2, <span class="stringliteral">&quot;%d&quot;</span>, rn);
<a name="l00431"></a>00431       }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <span class="comment">/* enable interrupts */</span>
<a name="l00434"></a>00434     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     
<a name="l00437"></a>00437   <span class="keywordflow">return</span> status;
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 <span class="comment">/*-- prestop -------------------------------------------------------*/</span>
<a name="l00441"></a>00441 
<a name="l00442"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ab295972cdaac0046b6ca092aca0d1165">00442</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ab295972cdaac0046b6ca092aca0d1165">tr_prestop</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446   <span class="comment">/* disable interrupts */</span>
<a name="l00447"></a>00447   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449   status = <a class="code" href="crate3_2crate_8cpp.html#ae6d798649008b7523c77222bae2d4187">end_of_run</a>(rn, error);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451   <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l00452"></a>00452     {
<a name="l00453"></a>00453     <span class="comment">/* don&apos;t send events if already stopped */</span>
<a name="l00454"></a>00454     <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> != <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>)
<a name="l00455"></a>00455       <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>;
<a name="l00458"></a>00458     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00461"></a>00461       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, 2, <span class="stringliteral">&quot;Stopped &quot;</span>);
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463   <span class="keywordflow">else</span>
<a name="l00464"></a>00464     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466   <span class="comment">/* flush remaining buffered events */</span>
<a name="l00467"></a>00467   <a class="code" href="group__msectionh.html#ga0f78b1f2d6558798873b49801c9291e0">rpc_flush_event</a>();
<a name="l00468"></a>00468   <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l00469"></a>00469     <span class="keywordflow">if</span> (equipment[i].buffer_handle)
<a name="l00470"></a>00470       {
<a name="l00471"></a>00471     <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> err = <a class="code" href="group__msectionh.html#ga0116bb8954b16dfdc5d355f7c01127ad">bm_flush_cache</a>(equipment[i].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l00472"></a>00472     <span class="keywordflow">if</span> (err != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l00473"></a>00473       {
<a name="l00474"></a>00474         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>,<span class="stringliteral">&quot;tr_prestop&quot;</span>,<span class="stringliteral">&quot;bm_flush_cache(SYNC) error %d&quot;</span>,err);
<a name="l00475"></a>00475         <span class="keywordflow">return</span> err;
<a name="l00476"></a>00476       }
<a name="l00477"></a>00477       }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479   <span class="keywordflow">return</span> status;
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="comment">/*-- pause ---------------------------------------------------------*/</span>
<a name="l00483"></a>00483 
<a name="l00484"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aaf7c57c78866ef0ad7268908a0d777d3">00484</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aaf7c57c78866ef0ad7268908a0d777d3">tr_prepause</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   <span class="comment">/* disable interrupts */</span>
<a name="l00489"></a>00489   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491   status = <a class="code" href="examples_2macro_2midas__macro_8h.html#ac13d5e945d03bd84233e479cad2d892a">pause_run</a>(rn, error);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l00494"></a>00494     {
<a name="l00495"></a>00495     <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#gab08c47284371c683ba80d6b3244400f1">STATE_PAUSED</a>;
<a name="l00496"></a>00496     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#ga11713399cfb35e58b8fae045836c0d88">TR_PAUSE</a>);
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00501"></a>00501       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, 2, <span class="stringliteral">&quot;Paused  &quot;</span>);
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503   <span class="keywordflow">else</span>
<a name="l00504"></a>00504     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506   <span class="keywordflow">return</span> status;
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 <span class="comment">/*-- resume --------------------------------------------------------*/</span>
<a name="l00510"></a>00510 
<a name="l00511"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">00511</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">tr_resume</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l00512"></a>00512 {
<a name="l00513"></a>00513 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515   status = <a class="code" href="examples_2macro_2midas__macro_8h.html#a392520a13432f29f450f40456e26960f">resume_run</a>(rn, error);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517   <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l00518"></a>00518     {
<a name="l00519"></a>00519     <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>;
<a name="l00520"></a>00520     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a>);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00525"></a>00525       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, 2, <span class="stringliteral">&quot;Running &quot;</span>);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="comment">/* enable interrupts */</span>
<a name="l00528"></a>00528     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00529"></a>00529     }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531   <span class="keywordflow">return</span> status;
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00535"></a>00535 
<a name="l00536"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#abd8c095343249df7bf669d75ee933293">00536</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#abd8c095343249df7bf669d75ee933293">manual_trigger</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <span class="keywordtype">void</span> *prpc_param[])
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538 <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   event_id = <a class="code" href="group__msectionh.html#ga94a92016dc66b32a6c75df667df20866">CWORD</a>(0);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542   <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l00543"></a>00543     <span class="keywordflow">if</span> (equipment[i].info.event_id == event_id)
<a name="l00544"></a>00544       <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">send_event</a>(i);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00547"></a>00547     <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549   <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00553"></a>00553 
<a name="l00554"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ab834073e5b665fccaa4eff2a61bc9372">00554</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ab834073e5b665fccaa4eff2a61bc9372">register_equipment</a>(<span class="keywordtype">void</span>)
<a name="l00555"></a>00555 {
<a name="l00556"></a>00556 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>    <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="odbhist_8c.html#a43fa990200c3ddd47c35f151bd4d66bf">k</a>, <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>;
<a name="l00557"></a>00557 <span class="keywordtype">char</span>   <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l00558"></a>00558 <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l00559"></a>00559 <a class="code" href="structEQUIPMENT__STATS.html">EQUIPMENT_STATS</a> *eq_stats;
<a name="l00560"></a>00560 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>  <a class="code" href="old__mevb_8cpp.html#af4211e1ba0e676018599e88cfae3537a">start_time</a>, <a class="code" href="mchart_8c.html#a36255e64f0394c6b59219618ef099ff9">delta_time</a>;
<a name="l00561"></a>00561 <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>  <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l00562"></a>00562 <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>   manual_trig_flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00563"></a>00563 <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l00564"></a>00564 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>  dummy;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   <span class="comment">/* get current ODB run state */</span>
<a name="l00567"></a>00567   size = <span class="keyword">sizeof</span>(<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>);
<a name="l00568"></a>00568   <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>;
<a name="l00569"></a>00569   <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/State&quot;</span>, &amp;<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00570"></a>00570   size = <span class="keyword">sizeof</span>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l00571"></a>00571   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = 1;
<a name="l00572"></a>00572   <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/Run number&quot;</span>, &amp;<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574   <span class="comment">/* scan EQUIPMENT table from FRONTEND.C */</span>
<a name="l00575"></a>00575   <span class="keywordflow">for</span> (index=0 ; equipment[index].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; index++)
<a name="l00576"></a>00576     {
<a name="l00577"></a>00577     eq_info = &amp;equipment[index].<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l00578"></a>00578     eq_stats = &amp;equipment[index].<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a> == 0)
<a name="l00581"></a>00581       {
<a name="l00582"></a>00582       printf(<span class="stringliteral">&quot;Event ID 0 for %s not allowed\n&quot;</span>, equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l00583"></a>00583       <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(5000);
<a name="l00584"></a>00584       }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586     <span class="comment">/* init status */</span>
<a name="l00587"></a>00587     equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589     sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Common&quot;</span>, equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l00590"></a>00590     
<a name="l00591"></a>00591     <span class="comment">/* get last event limit from ODB */</span>
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> != <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>)
<a name="l00593"></a>00593       {
<a name="l00594"></a>00594       <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00595"></a>00595       size = <span class="keyword">sizeof</span>(double);
<a name="l00596"></a>00596       <span class="keywordflow">if</span> (hKey)
<a name="l00597"></a>00597         <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Event limit&quot;</span>, &amp;eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>, &amp;size, <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00598"></a>00598       }
<a name="l00599"></a>00599     
<a name="l00600"></a>00600     <span class="comment">/* Create common subtree */</span>
<a name="l00601"></a>00601     status = <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac92b30327caaa939b1b6630775c78ecd">EQUIPMENT_COMMON_STR</a>);
<a name="l00602"></a>00602     <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00603"></a>00603       {
<a name="l00604"></a>00604       printf(<span class="stringliteral">&quot;Cannot init equipment record, probably other FE is using it\n&quot;</span>);
<a name="l00605"></a>00605       <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l00606"></a>00606       }
<a name="l00607"></a>00607     <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga60d08f3eadb2b1f809d06d7a64b0bc5e">format</a>, <span class="stringliteral">&quot;YBOS&quot;</span>))
<a name="l00610"></a>00610       equipment[index].<a class="code" href="group__midasincludecode.html#gacad980d7699722234c72bfca6243203b">format</a> = <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>;
<a name="l00611"></a>00611     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga60d08f3eadb2b1f809d06d7a64b0bc5e">format</a>, <span class="stringliteral">&quot;FIXED&quot;</span>))
<a name="l00612"></a>00612       equipment[index].<a class="code" href="group__midasincludecode.html#gacad980d7699722234c72bfca6243203b">format</a> = <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>;
<a name="l00613"></a>00613     <span class="keywordflow">else</span> <span class="comment">/* default format is MIDAS */</span>
<a name="l00614"></a>00614       equipment[index].<a class="code" href="group__midasincludecode.html#gacad980d7699722234c72bfca6243203b">format</a> = <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     gethostname(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0f7f20fef7826740571d2ffa82da4dfd">frontend_host</a>, <span class="keyword">sizeof</span>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0f7f20fef7826740571d2ffa82da4dfd">frontend_host</a>));
<a name="l00617"></a>00617     strcpy(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga2cfd04e323109fe1cbb75ca8047aaa77">frontend_name</a>, <a class="code" href="crate3_2crate_8cpp.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>);
<a name="l00618"></a>00618     strcpy(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0788ebd106c11c952e09f99e142d8bbf">frontend_file_name</a>, <a class="code" href="crate3_2crate_8cpp.html#aa045f89d0b0691cb1d05174b13369750">frontend_file_name</a>);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <span class="comment">/* set record from equipment[] table in frontend.c */</span>
<a name="l00621"></a>00621     <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_info, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a>), 0);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623     <span class="comment">/* open hot link to equipment info */</span>
<a name="l00624"></a>00624     <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_info, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL);
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     <span class="comment">/*---- Create variables record ---------------------------------*/</span>
<a name="l00627"></a>00627     sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables&quot;</span>, equipment[index].name);
<a name="l00628"></a>00628     <span class="keywordflow">if</span> (equipment[index].event_descrip)
<a name="l00629"></a>00629       {
<a name="l00630"></a>00630       <span class="keywordflow">if</span> (equipment[index].<a class="code" href="webpaw_8c.html#a6113855b8e5965f1e91ee407b4026ab7">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>)
<a name="l00631"></a>00631         <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, (<span class="keywordtype">char</span> *)equipment[index].event_descrip);
<a name="l00632"></a>00632       <span class="keywordflow">else</span>
<a name="l00633"></a>00633         {
<a name="l00634"></a>00634         <span class="comment">/* create bank descriptions */</span>
<a name="l00635"></a>00635         bank_list = (<a class="code" href="structBANK__LIST.html">BANK_LIST</a> *)equipment[index].event_descrip;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0] ; bank_list++)
<a name="l00638"></a>00638           {
<a name="l00639"></a>00639           <span class="comment">/* mabye needed later...</span>
<a name="l00640"></a>00640 <span class="comment">          if (bank_list-&gt;output_flag == 0)</span>
<a name="l00641"></a>00641 <span class="comment">            continue;</span>
<a name="l00642"></a>00642 <span class="comment">          */</span>
<a name="l00643"></a>00643 
<a name="l00644"></a>00644           <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a> == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>)
<a name="l00645"></a>00645             {
<a name="l00646"></a>00646             sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, equipment[index].name, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l00647"></a>00647             <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga7ebd92f00cb428fcbb555f3ad30b86c8">init_str</a>));
<a name="l00648"></a>00648             }
<a name="l00649"></a>00649           <span class="keywordflow">else</span>
<a name="l00650"></a>00650             {
<a name="l00651"></a>00651             sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, equipment[index].name, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l00652"></a>00652             dummy = 0;
<a name="l00653"></a>00653             <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;dummy, <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>), 1, bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>);
<a name="l00654"></a>00654             }
<a name="l00655"></a>00655           }
<a name="l00656"></a>00656         }
<a name="l00657"></a>00657       }
<a name="l00658"></a>00658     <span class="keywordflow">else</span>
<a name="l00659"></a>00659       <a class="code" href="group__msectionh.html#ga1441e5b7ca1923cf8611f920cf2c31b4">db_create_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="group__mdefineh.html#ga15ae151ae0b7588b3327bd8451d9bcb8">TID_KEY</a>);
<a name="l00660"></a>00660 
<a name="l00661"></a>00661     sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables&quot;</span>, equipment[index].name);
<a name="l00662"></a>00662     <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00663"></a>00663     equipment[index].<a class="code" href="group__midasincludecode.html#gab6664c255e4c3fdc58806733ac04503b">hkey_variables</a> = hKey;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="comment">/*---- Create and initialize statistics tree -------------------*/</span>
<a name="l00666"></a>00666     sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Statistics&quot;</span>, equipment[index].name);
<a name="l00667"></a>00667     
<a name="l00668"></a>00668     <span class="comment">/*-PAA- Needed in case Statistics exists but size = 0 */</span>
<a name="l00669"></a>00669     <span class="comment">/*-SR- Not needed since db_create_record does a delete already */</span>
<a name="l00670"></a>00670 
<a name="l00671"></a>00671     status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00672"></a>00672     <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00673"></a>00673       {
<a name="l00674"></a>00674       status = <a class="code" href="group__msectionh.html#ga91277a012e0bfddbc32885da450409e0">db_delete_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00675"></a>00675       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00676"></a>00676         {
<a name="l00677"></a>00677           printf(<span class="stringliteral">&quot;Cannot delete statistics record, error %d\n&quot;</span>,status);
<a name="l00678"></a>00678           <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680       }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     status = <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6064db0cc46885d207cedb497e3c355e">EQUIPMENT_STATISTICS_STR</a>);
<a name="l00683"></a>00683     <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00684"></a>00684       {
<a name="l00685"></a>00685       printf(<span class="stringliteral">&quot;Cannot create statistics record, error %d\n&quot;</span>,status);
<a name="l00686"></a>00686       <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l00687"></a>00687       }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689     status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00690"></a>00690     <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00691"></a>00691       {
<a name="l00692"></a>00692       printf(<span class="stringliteral">&quot;Cannot find statistics record, error %d\n&quot;</span>,status);
<a name="l00693"></a>00693       <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l00694"></a>00694       }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     eq_stats-&gt;<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> = 0;
<a name="l00697"></a>00697     eq_stats-&gt;<a class="code" href="group__midasincludecode.html#ga218c744ea441413af262fbd5ddf3780f">events_per_sec</a> = 0;
<a name="l00698"></a>00698     eq_stats-&gt;<a class="code" href="group__midasincludecode.html#ga7a7a7d4b78841a36d156a0941616538f">kbytes_per_sec</a> = 0;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment">/* open hot link to statistics tree */</span>
<a name="l00701"></a>00701     status = <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_stats, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__STATS.html">EQUIPMENT_STATS</a>), <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a>, NULL, NULL);
<a name="l00702"></a>00702     <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00703"></a>00703       {
<a name="l00704"></a>00704       printf(<span class="stringliteral">&quot;Cannot open statistics record, error %d. Probably other FE is using it\n&quot;</span>,status);
<a name="l00705"></a>00705       <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l00706"></a>00706       }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="comment">/*---- open event buffer ---------------------------------------*/</span>
<a name="l00709"></a>00709     <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>[0])
<a name="l00710"></a>00710       {
<a name="l00711"></a>00711       status = <a class="code" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer</a>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>, <a class="code" href="group__midasincludecode.html#gacc4dda1aaabc9862fe79fd94e0b722bf">EVENT_BUFFER_SIZE</a>, &amp;equipment[index].<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>);
<a name="l00712"></a>00712       <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a> &amp;&amp; status != <a class="code" href="group__err22.html#gaf4d0ec9887b0864c100b8062d21f4c0b">BM_CREATED</a>)
<a name="l00713"></a>00713         {
<a name="l00714"></a>00714         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>, 
<a name="l00715"></a>00715                <span class="stringliteral">&quot;Cannot open event buffer. Try to reduce EVENT_BUFFER_SIZE in midas.h \</span>
<a name="l00716"></a>00716 <span class="stringliteral">and rebuild the system.&quot;</span>);
<a name="l00717"></a>00717         <span class="keywordflow">return</span> 0;         
<a name="l00718"></a>00718         }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720       <span class="comment">/* set the default buffer cache size */</span>
<a name="l00721"></a>00721       <a class="code" href="group__msectionh.html#ga3d70a1e1e38b6ccf6bde4bc5b436ae5b">bm_set_cache_size</a>(equipment[index].buffer_handle, 0, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a022c39e327f494dda3664f8888f860f1">SERVER_CACHE_SIZE</a>);
<a name="l00722"></a>00722       }
<a name="l00723"></a>00723     <span class="keywordflow">else</span>
<a name="l00724"></a>00724       equipment[index].<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a> = 0;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="comment">/*---- evaluate polling count ----------------------------------*/</span>
<a name="l00727"></a>00727     <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>)
<a name="l00728"></a>00728       {
<a name="l00729"></a>00729       <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00730"></a>00730         printf(<span class="stringliteral">&quot;\nCalibrating&quot;</span>);
<a name="l00731"></a>00731 
<a name="l00732"></a>00732       count = 1;
<a name="l00733"></a>00733       <span class="keywordflow">do</span>
<a name="l00734"></a>00734         {
<a name="l00735"></a>00735         <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00736"></a>00736           printf(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738         start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l00739"></a>00739 
<a name="l00740"></a>00740         <a class="code" href="crate3_2crate_8cpp.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(equipment[index].info.source, count, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742         delta_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         <span class="keywordflow">if</span> (delta_time &gt; 0)
<a name="l00745"></a>00745           count = (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) ((<span class="keywordtype">double</span>) count * 100 / delta_time);
<a name="l00746"></a>00746         <span class="keywordflow">else</span>
<a name="l00747"></a>00747           count*=100;
<a name="l00748"></a>00748         } <span class="keywordflow">while</span> (delta_time &gt; 120 || delta_time &lt; 80);
<a name="l00749"></a>00749 
<a name="l00750"></a>00750       equipment[index].<a class="code" href="group__midasincludecode.html#gae9bf94db8ff48533601c3833b1b20097">poll_count</a> = (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) ((<span class="keywordtype">double</span>) eq_info-&gt;<a class="code" href="group__midasincludecode.html#gaf7f674490636b6f9736fb680201001c2">period</a> / 100 * count);
<a name="l00751"></a>00751 
<a name="l00752"></a>00752       <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00753"></a>00753         printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l00754"></a>00754       }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756     <span class="comment">/*---- initialize interrupt events -----------------------------*/</span>
<a name="l00757"></a>00757     <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gad5ba2ec0f5d55139048dbe2d416da6ba">EQ_INTERRUPT</a>)
<a name="l00758"></a>00758       {
<a name="l00759"></a>00759       <span class="comment">/* install interrupt for interrupt events */</span>
<a name="l00760"></a>00760 
<a name="l00761"></a>00761       <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l00762"></a>00762         <span class="keywordflow">if</span> (equipment[i].info.eq_type &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>)
<a name="l00763"></a>00763           {
<a name="l00764"></a>00764           equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00765"></a>00765           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>, 
<a name="l00766"></a>00766             <span class="stringliteral">&quot;Interrupt readout cannot be combined with polled readout&quot;</span>);
<a name="l00767"></a>00767           }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769       <span class="keywordflow">if</span> (equipment[index].status != <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>)
<a name="l00770"></a>00770         {
<a name="l00771"></a>00771         <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>)
<a name="l00772"></a>00772           {
<a name="l00773"></a>00773           <span class="keywordflow">if</span> (interrupt_eq)
<a name="l00774"></a>00774             {
<a name="l00775"></a>00775             equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00776"></a>00776             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>, 
<a name="l00777"></a>00777               <span class="stringliteral">&quot;Defined more than one equipment with interrupt readout&quot;</span>);
<a name="l00778"></a>00778             }
<a name="l00779"></a>00779           <span class="keywordflow">else</span>
<a name="l00780"></a>00780             {
<a name="l00781"></a>00781             <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="group__err26.html#ga8a891110d186a3a4b02f6dfde253efb2">CMD_INTERRUPT_ATTACH</a>, eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga345e65d8874f6b968bedc00e76d4f431">source</a>, (<a class="code" href="group__midasincludecode.html#ga790216a8e71233fed28657b16a052e36">PTYPE</a>) <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">interrupt_routine</a>);
<a name="l00782"></a>00782             interrupt_eq = &amp;equipment[index];
<a name="l00783"></a>00783             interrupt_odb_buffer = malloc(<a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l00784"></a>00784             }
<a name="l00785"></a>00785           }
<a name="l00786"></a>00786         <span class="keywordflow">else</span>
<a name="l00787"></a>00787           {
<a name="l00788"></a>00788           equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00789"></a>00789           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>, <span class="stringliteral">&quot;Equipment %s disabled in file \&quot;frontend.c\&quot;&quot;</span>,
<a name="l00790"></a>00790                          equipment[index].name);
<a name="l00791"></a>00791           }
<a name="l00792"></a>00792         }
<a name="l00793"></a>00793       }
<a name="l00794"></a>00794     
<a name="l00795"></a>00795     <span class="comment">/*---- initialize slow control equipment -----------------------*/</span>
<a name="l00796"></a>00796     <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>)
<a name="l00797"></a>00797       {
<a name="l00798"></a>00798       <span class="comment">/* resolve duplicate device names */</span>
<a name="l00799"></a>00799       <span class="keywordflow">for</span> (i=0 ; equipment[index].<a class="code" href="group__midasincludecode.html#gaf19c464fc7092048c9418328ca4e4afc">driver</a>[i].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0] ; i++)
<a name="l00800"></a>00800         <span class="keywordflow">for</span> (j=i+1 ; equipment[index].<a class="code" href="group__midasincludecode.html#gaf19c464fc7092048c9418328ca4e4afc">driver</a>[j].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0] ; j++)
<a name="l00801"></a>00801           <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[i].name,
<a name="l00802"></a>00802                             equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[j].name))
<a name="l00803"></a>00803             {
<a name="l00804"></a>00804             strcpy(str, equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[i].name);
<a name="l00805"></a>00805             <span class="keywordflow">for</span> (k=0,n=0 ; equipment[index].<a class="code" href="group__midasincludecode.html#gaf19c464fc7092048c9418328ca4e4afc">driver</a>[k].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0] ; k++)
<a name="l00806"></a>00806               <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[k].name))
<a name="l00807"></a>00807                 sprintf(equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[k].name, <span class="stringliteral">&quot;%s_%d&quot;</span>, str, n++);
<a name="l00808"></a>00808             
<a name="l00809"></a>00809             <span class="keywordflow">break</span>;
<a name="l00810"></a>00810             }
<a name="l00811"></a>00811   
<a name="l00812"></a>00812       <span class="comment">/* loop over equipment list and call class driver&apos;s init method */</span>
<a name="l00813"></a>00813       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>)
<a name="l00814"></a>00814         equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = equipment[index].<a class="code" href="group__midasincludecode.html#gae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga2677fc43f8393bcf3bafc8bbface003f">CMD_INIT</a>, &amp;equipment[index]);
<a name="l00815"></a>00815       <span class="keywordflow">else</span>
<a name="l00816"></a>00816         {
<a name="l00817"></a>00817         equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00818"></a>00818         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>, <span class="stringliteral">&quot;Equipment %s disabled in file \&quot;frontend.c\&quot;&quot;</span>,
<a name="l00819"></a>00819                        equipment[index].name);
<a name="l00820"></a>00820         }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822       <span class="comment">/* let user read error messages */</span>
<a name="l00823"></a>00823       <span class="keywordflow">if</span> (equipment[index].status != <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l00824"></a>00824         <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l00825"></a>00825       }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="comment">/*---- register callback for manual triggered events -----------*/</span>
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gac73e1045dff2b724325100af2e946717">EQ_MANUAL_TRIG</a>)
<a name="l00829"></a>00829       {
<a name="l00830"></a>00830       <span class="keywordflow">if</span> (!manual_trig_flag)
<a name="l00831"></a>00831         <a class="code" href="group__msectionh.html#gad3115b4913387a49fb131e5144509557">cm_register_function</a>(<a class="code" href="group__mrpcdefineh.html#gaf820c7d84c71a1469983d23ebec18a8f">RPC_MANUAL_TRIG</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#abd8c095343249df7bf669d75ee933293">manual_trigger</a>); 
<a name="l00832"></a>00832 
<a name="l00833"></a>00833       manual_trig_flag = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00834"></a>00834       }
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837   <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00838"></a>00838 }
<a name="l00839"></a>00839 
<a name="l00840"></a>00840 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00841"></a>00841 
<a name="l00842"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#acca4a95b509b37c83c2e76cb88de232a">00842</a> <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="webpaw_8c.html#a6113855b8e5965f1e91ee407b4026ab7">format</a>)
<a name="l00843"></a>00843 {
<a name="l00844"></a>00844 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>               <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, ni4, <a class="code" href="mfe_8c.html#aa1506b3a082cd269e4e733382ba0df79">tsize</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, n_data;
<a name="l00845"></a>00845 <span class="keywordtype">void</span>              *pdata;
<a name="l00846"></a>00846 <span class="keywordtype">char</span>              <a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>[5];
<a name="l00847"></a>00847 <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a>       *pbh;
<a name="l00848"></a>00848 <a class="code" href="structBANK.html">BANK</a>              *pbk;
<a name="l00849"></a>00849 <a class="code" href="structBANK32.html">BANK32</a>            *pbk32;
<a name="l00850"></a>00850 <span class="keywordtype">void</span>              *pydata;
<a name="l00851"></a>00851 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>             <a class="code" href="mfe_8c.html#abcb124395ac9b3b5182782a33e3abf31">odb_type</a>;
<a name="l00852"></a>00852 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>             *pyevt, bkname;
<a name="l00853"></a>00853 <a class="code" href="unionWORD.html">WORD</a>              bktype;
<a name="l00854"></a>00854 <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>             hKeyRoot, hKeyl;
<a name="l00855"></a>00855 <a class="code" href="structKEY.html">KEY</a>               <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857   <span class="comment">/* outcommented sind db_find_key does not work in FTCP mode, SR 25.4.03</span>
<a name="l00858"></a>00858 <span class="comment">  rpc_set_option(-1, RPC_OTRANSPORT, RPC_FTCP); */</span>
<a name="l00859"></a>00859 
<a name="l00860"></a>00860   <span class="keywordflow">if</span> (format == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>)
<a name="l00861"></a>00861     {
<a name="l00862"></a>00862     <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, (<span class="keywordtype">char</span> *) (pevent+1),
<a name="l00863"></a>00863                       pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>, 0) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00864"></a>00864       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;update_odb&quot;</span>, <span class="stringliteral">&quot;event #%d size mismatch&quot;</span>, pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l00865"></a>00865     }
<a name="l00866"></a>00866   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>)
<a name="l00867"></a>00867     {
<a name="l00868"></a>00868     pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent+1);
<a name="l00869"></a>00869     pbk = NULL;
<a name="l00870"></a>00870     pbk32 = NULL;
<a name="l00871"></a>00871     <span class="keywordflow">do</span>
<a name="l00872"></a>00872       {
<a name="l00873"></a>00873       <span class="comment">/* scan all banks */</span>
<a name="l00874"></a>00874       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh))
<a name="l00875"></a>00875         {
<a name="l00876"></a>00876         size = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l00877"></a>00877         <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l00878"></a>00878           <span class="keywordflow">break</span>;
<a name="l00879"></a>00879         bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l00880"></a>00880         bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l00881"></a>00881         }
<a name="l00882"></a>00882       <span class="keywordflow">else</span>
<a name="l00883"></a>00883         {
<a name="l00884"></a>00884         size = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l00885"></a>00885         <span class="keywordflow">if</span> (pbk == NULL)
<a name="l00886"></a>00886           <span class="keywordflow">break</span>;
<a name="l00887"></a>00887         bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l00888"></a>00888         bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l00889"></a>00889         }
<a name="l00890"></a>00890       
<a name="l00891"></a>00891       n_data = size;
<a name="l00892"></a>00892       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF))
<a name="l00893"></a>00893         n_data /= <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF);
<a name="l00894"></a>00894   
<a name="l00895"></a>00895       <span class="comment">/* get bank key */</span>
<a name="l00896"></a>00896       *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) name) = bkname;
<a name="l00897"></a>00897       name[4] = 0;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899       <span class="keywordflow">if</span> (bktype == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>)
<a name="l00900"></a>00900         {
<a name="l00901"></a>00901         status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, name, &amp;hKeyRoot);
<a name="l00902"></a>00902         <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00903"></a>00903           {
<a name="l00904"></a>00904           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;update_odb&quot;</span>, <span class="stringliteral">&quot;please define bank %s in BANK_LIST in frontend.c&quot;</span>, name);
<a name="l00905"></a>00905           <span class="keywordflow">continue</span>;
<a name="l00906"></a>00906           }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908         <span class="comment">/* write structured bank */</span>
<a name="l00909"></a>00909         <span class="keywordflow">for</span> (i=0 ;; i++)
<a name="l00910"></a>00910           {
<a name="l00911"></a>00911           status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, i, &amp;hKeyl);
<a name="l00912"></a>00912           <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l00913"></a>00913             <span class="keywordflow">break</span>;
<a name="l00914"></a>00914 
<a name="l00915"></a>00915           <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyl, &amp;key);
<a name="l00916"></a>00916 
<a name="l00917"></a>00917           <span class="comment">/* adjust for alignment */</span>
<a name="l00918"></a>00918           <span class="keywordflow">if</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> != <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a> &amp;&amp; key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> != <a class="code" href="group__mdefineh.html#gaa63f41f547c7f46f828aaf35073807ea">TID_LINK</a>)
<a name="l00919"></a>00919             pdata = (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l00920"></a>00920 
<a name="l00921"></a>00921           status = <a class="code" href="group__msectionh.html#ga6b98aa5ac9036c49023c0cc9353922d4">db_set_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyl, pdata, key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>*key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>, 
<a name="l00922"></a>00922                                key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l00923"></a>00923           <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00924"></a>00924             {
<a name="l00925"></a>00925             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;update_odb&quot;</span>, <span class="stringliteral">&quot;cannot write %s to ODB&quot;</span>, name);
<a name="l00926"></a>00926             <span class="keywordflow">continue</span>;
<a name="l00927"></a>00927             }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929           <span class="comment">/* shift data pointer to next item */</span>
<a name="l00930"></a>00930           (<span class="keywordtype">char</span> *) pdata += key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>*key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l00931"></a>00931           }
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933       <span class="keywordflow">else</span>
<a name="l00934"></a>00934         {
<a name="l00935"></a>00935         <span class="comment">/* write variable length bank  */</span>
<a name="l00936"></a>00936         <span class="keywordflow">if</span> (n_data &gt; 0)
<a name="l00937"></a>00937           <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, name, pdata, size, n_data, bktype &amp; 0xFF);
<a name="l00938"></a>00938         }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940       } <span class="keywordflow">while</span> (1);
<a name="l00941"></a>00941     }
<a name="l00942"></a>00942   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>)
<a name="l00943"></a>00943     {
<a name="l00944"></a>00944 <span class="preprocessor">#ifdef YBOS_SUPPORT</span>
<a name="l00945"></a>00945 <span class="preprocessor"></span>    <a class="code" href="structYBOS__BANK__HEADER.html">YBOS_BANK_HEADER</a> *pybkh;
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     <span class="comment">/* skip the lrl (4 bytes per event) */</span>
<a name="l00948"></a>00948     pyevt = (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) (pevent+1);
<a name="l00949"></a>00949     pybkh = NULL;
<a name="l00950"></a>00950     <span class="keywordflow">do</span>
<a name="l00951"></a>00951         {
<a name="l00952"></a>00952         <span class="comment">/* scan all banks */</span>
<a name="l00953"></a>00953         ni4 = <a class="code" href="group__ybosincludecode.html#ga1460247a5eeb130851ec244920996d07">ybk_iterate</a>(pyevt, &amp;pybkh, &amp;pydata);
<a name="l00954"></a>00954         <span class="keywordflow">if</span> (pybkh == NULL || ni4 == 0)
<a name="l00955"></a>00955           <span class="keywordflow">break</span>;
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         <span class="comment">/* find the corresponding odb type */</span>
<a name="l00958"></a>00958         tsize = odb_type = 0;
<a name="l00959"></a>00959       <span class="keywordflow">for</span> (i=0;<a class="code" href="mfe_8c.html#aa14e5ae35b977069fad12c300037429c">id_map</a>[0].ybos_type &gt; 0; i++)
<a name="l00960"></a>00960           {
<a name="l00961"></a>00961         <span class="keywordflow">if</span> (pybkh-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> == <a class="code" href="mfe_8c.html#aa14e5ae35b977069fad12c300037429c">id_map</a>[i].ybos_type)
<a name="l00962"></a>00962           {
<a name="l00963"></a>00963               odb_type = <a class="code" href="mfe_8c.html#aa14e5ae35b977069fad12c300037429c">id_map</a>[i].odb_type;
<a name="l00964"></a>00964               tsize = <a class="code" href="mfe_8c.html#aa14e5ae35b977069fad12c300037429c">id_map</a>[i].tsize;
<a name="l00965"></a>00965               <span class="keywordflow">break</span>;
<a name="l00966"></a>00966           }
<a name="l00967"></a>00967           }
<a name="l00968"></a>00968 
<a name="l00969"></a>00969         <span class="comment">/* extract bank name (key name) */</span>
<a name="l00970"></a>00970         *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *)name) = pybkh-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#a48b75f0b13d19047668335154985c01d">name</a>;
<a name="l00971"></a>00971         name[4] = 0;
<a name="l00972"></a>00972 
<a name="l00973"></a>00973       <span class="comment">/* reject EVID bank */</span>
<a name="l00974"></a>00974       <span class="keywordflow">if</span> (strncmp(name, <span class="stringliteral">&quot;EVID&quot;</span>, 4) == 0)
<a name="l00975"></a>00975         <span class="keywordflow">continue</span>;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977       <span class="comment">/* correct YBS number of entries */</span>
<a name="l00978"></a>00978       <span class="keywordflow">if</span> (pybkh-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> == <a class="code" href="group__ybosdefineh.html#gaba3ee4247e6ef5302ba5a83079a338e0">D8_BKTYPE</a>)
<a name="l00979"></a>00979         ni4 /= 2;
<a name="l00980"></a>00980       <span class="keywordflow">if</span> (pybkh-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> == <a class="code" href="group__ybosdefineh.html#ga4b6b5459b4c74b76ee12197538fe6d1d">I2_BKTYPE</a>)
<a name="l00981"></a>00981         ni4 *= 2;
<a name="l00982"></a>00982       <span class="keywordflow">if</span> (pybkh-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> == <a class="code" href="group__ybosdefineh.html#ga37b2a5de4003dff9ef6837b6f99a0a69">I1_BKTYPE</a> || pybkh-&gt;<a class="code" href="structYBOS__BANK__HEADER.html#aeb97f805c9bebaf785de495da6297b64">type</a> == <a class="code" href="group__ybosdefineh.html#ga07cd0ef2852310d130deaf0d4ef7bfd4">A1_BKTYPE</a>)
<a name="l00983"></a>00983         ni4 *= 4;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985         <span class="comment">/* write bank to ODB, ni4 always in I*4 */</span>
<a name="l00986"></a>00986         size = ni4 * tsize;
<a name="l00987"></a>00987         <span class="keywordflow">if</span> ((status = <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, name, pydata, size, ni4, odb_type &amp; 0xFF)) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00988"></a>00988           {
<a name="l00989"></a>00989           printf(<span class="stringliteral">&quot;status:%i odb_type:%li name:%s ni4:%i size:%i tsize:%i\n&quot;</span>,
<a name="l00990"></a>00990                     status, odb_type, name, ni4, size, tsize);
<a name="l00991"></a>00991           <span class="keywordflow">for</span> (i=0;i&lt;6;i++)
<a name="l00992"></a>00992               printf(<span class="stringliteral">&quot;data: %f\n&quot;</span>,*((<span class="keywordtype">float</span> *)(pydata))++);
<a name="l00993"></a>00993           }
<a name="l00994"></a>00994       } <span class="keywordflow">while</span> (1);
<a name="l00995"></a>00995 <span class="preprocessor">#endif </span><span class="comment">/* YBOS_SUPPORT */</span>
<a name="l00996"></a>00996     }
<a name="l00997"></a>00997 
<a name="l00998"></a>00998   <a class="code" href="group__msectionh.html#ga3d863362443e54777f3e4033f1603980">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#ga9d0de5957c2c776323a0c74e668f544d">RPC_TCP</a>);
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01002"></a>01002 
<a name="l01003"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">01003</a> <span class="keywordtype">int</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">send_event</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>)
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005 <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l01006"></a>01006 <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>   *pevent, *pfragment;
<a name="l01007"></a>01007 <span class="keywordtype">char</span>           *pdata;
<a name="l01008"></a>01008 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>  *pd;
<a name="l01009"></a>01009 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>            <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01010"></a>01010 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>          sent, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l01011"></a>01011 <span class="keyword">static</span> <span class="keywordtype">void</span>    *frag_buffer = NULL;
<a name="l01012"></a>01012 
<a name="l01013"></a>01013   eq_info = &amp;equipment[index].<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015   <span class="comment">/* check for fragmented event */</span>
<a name="l01016"></a>01016   <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>)
<a name="l01017"></a>01017     {
<a name="l01018"></a>01018     <span class="keywordflow">if</span> (frag_buffer == NULL)
<a name="l01019"></a>01019       frag_buffer = malloc(<a class="code" href="crate3_2crate_8cpp.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021     <span class="keywordflow">if</span> (frag_buffer == NULL)
<a name="l01022"></a>01022       {
<a name="l01023"></a>01023       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;Not enough memory to allocate buffer for fragmented events&quot;</span>);
<a name="l01024"></a>01024       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l01025"></a>01025       }
<a name="l01026"></a>01026 
<a name="l01027"></a>01027     pevent = frag_buffer;
<a name="l01028"></a>01028     }
<a name="l01029"></a>01029   <span class="keywordflow">else</span>
<a name="l01030"></a>01030     {
<a name="l01031"></a>01031     <span class="comment">/* return value should be valid pointer. if NULL BIG error ==&gt; abort  */</span>
<a name="l01032"></a>01032     pevent = <a class="code" href="group__msystemincludecode.html#ga166e1796a9a96ae0652665475bd6cfb7">dm_pointer_get</a>();
<a name="l01033"></a>01033     <span class="keywordflow">if</span> (pevent == NULL)
<a name="l01034"></a>01034       {
<a name="l01035"></a>01035       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;dm_pointer_get not returning valid pointer&quot;</span>);
<a name="l01036"></a>01036       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l01037"></a>01037       }
<a name="l01038"></a>01038     }
<a name="l01039"></a>01039 
<a name="l01040"></a>01040   <span class="comment">/* compose MIDAS event header */</span>
<a name="l01041"></a>01041   pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>      = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l01042"></a>01042   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>  = eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l01043"></a>01043   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>     = 0;
<a name="l01044"></a>01044   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>    = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>();
<a name="l01045"></a>01045   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> = equipment[index].<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01046"></a>01046 
<a name="l01047"></a>01047   equipment[index].<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01048"></a>01048 
<a name="l01049"></a>01049   <span class="comment">/* call user readout routine */</span>
<a name="l01050"></a>01050   *((<a class="code" href="structeqpmnt.html">EQUIPMENT</a> **)(pevent+1)) = &amp;equipment[index];
<a name="l01051"></a>01051   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = equipment[index].<a class="code" href="group__midasincludecode.html#gab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent+1), 0);
<a name="l01052"></a>01052 
<a name="l01053"></a>01053   <span class="comment">/* send event */</span>
<a name="l01054"></a>01054   <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>)
<a name="l01055"></a>01055     {
<a name="l01056"></a>01056     <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>)
<a name="l01057"></a>01057       {
<a name="l01058"></a>01058 
<a name="l01059"></a>01059       <span class="comment">/* fragment event */</span>
<a name="l01060"></a>01060       <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) <a class="code" href="crate3_2crate_8cpp.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>)
<a name="l01061"></a>01061         {
<a name="l01062"></a>01062         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;Event size %ld larger than maximum size %d for frag. ev.&quot;</span>,
<a name="l01063"></a>01063           (<span class="keywordtype">long</span>)(pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)), max_event_size_frag);
<a name="l01064"></a>01064         <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l01065"></a>01065         }
<a name="l01066"></a>01066 
<a name="l01067"></a>01067       <span class="comment">/* compose fragments */</span>
<a name="l01068"></a>01068       pfragment = <a class="code" href="group__msystemincludecode.html#ga166e1796a9a96ae0652665475bd6cfb7">dm_pointer_get</a>();
<a name="l01069"></a>01069       <span class="keywordflow">if</span> (pfragment == NULL)
<a name="l01070"></a>01070         {
<a name="l01071"></a>01071         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;dm_pointer_get not returning valid pointer&quot;</span>);
<a name="l01072"></a>01072         <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l01073"></a>01073         }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075       <span class="comment">/* compose MIDAS event header */</span>
<a name="l01076"></a>01076       memcpy(pfragment, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01077"></a>01077       pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> |= <a class="code" href="group__mbufferh.html#gaae07538917933e32355933ac1e2e3d60">EVENTID_FRAG1</a>;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079       <span class="comment">/* store total event size */</span>
<a name="l01080"></a>01080       pd = (<span class="keywordtype">char</span> *)(pfragment+1);
<a name="l01081"></a>01081       size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l01082"></a>01082       <span class="keywordflow">for</span> (i=0 ; i&lt;4 ; i++)
<a name="l01083"></a>01083         {
<a name="l01084"></a>01084         pd[i] = (<span class="keywordtype">unsigned</span> char)(size &amp; 0xFF); <span class="comment">/* little endian, please! */</span>
<a name="l01085"></a>01085         size &gt;&gt;= 8;
<a name="l01086"></a>01086         }
<a name="l01087"></a>01087 
<a name="l01088"></a>01088       pfragment-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>);
<a name="l01089"></a>01089 
<a name="l01090"></a>01090       pdata=(<span class="keywordtype">char</span> *)(pevent+1);
<a name="l01091"></a>01091 
<a name="l01092"></a>01092       <span class="keywordflow">for</span> (i=0,sent=0 ; sent&lt;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> ; i++)
<a name="l01093"></a>01093         {
<a name="l01094"></a>01094         <span class="keywordflow">if</span> (i&gt;0)
<a name="l01095"></a>01095           {
<a name="l01096"></a>01096           pfragment = <a class="code" href="group__msystemincludecode.html#ga166e1796a9a96ae0652665475bd6cfb7">dm_pointer_get</a>();
<a name="l01097"></a>01097 
<a name="l01098"></a>01098           <span class="comment">/* compose MIDAS event header */</span>
<a name="l01099"></a>01099           memcpy(pfragment, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01100"></a>01100           pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> |= <a class="code" href="group__mbufferh.html#ga4fb6de5cc7e1f2da82266094a02d0ff7">EVENTID_FRAG</a>;
<a name="l01101"></a>01101 
<a name="l01102"></a>01102           <span class="comment">/* copy portion of event */</span>
<a name="l01103"></a>01103           size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> - sent; 
<a name="l01104"></a>01104           <span class="keywordflow">if</span> (size &gt; <a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>-<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l01105"></a>01105             size = <a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>-<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l01106"></a>01106 
<a name="l01107"></a>01107           memcpy(pfragment+1, pdata, size);
<a name="l01108"></a>01108           pfragment-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = size;
<a name="l01109"></a>01109           sent += size;
<a name="l01110"></a>01110           pdata += size;
<a name="l01111"></a>01111           }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113         <span class="comment">/* send event to buffer */</span>
<a name="l01114"></a>01114         <span class="keywordflow">if</span> (equipment[index].buffer_handle)
<a name="l01115"></a>01115           {
<a name="l01116"></a>01116 <span class="preprocessor">#ifdef USE_EVENT_CHANNEL</span>
<a name="l01117"></a>01117 <span class="preprocessor"></span>          <a class="code" href="group__msystemincludecode.html#gaf86511000a179574ea04744ccf04c452">dm_pointer_increment</a>(equipment[index].buffer_handle, 
<a name="l01118"></a>01118             pfragment-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01119"></a>01119 <span class="preprocessor">#else</span>
<a name="l01120"></a>01120 <span class="preprocessor"></span>          <a class="code" href="group__msectionh.html#ga0f78b1f2d6558798873b49801c9291e0">rpc_flush_event</a>();
<a name="l01121"></a>01121           status = <a class="code" href="group__msectionh.html#ga5ebc713e2f1e7f0b6d257f072221321f">bm_send_event</a>(equipment[index].buffer_handle, pfragment,
<a name="l01122"></a>01122                                  pfragment-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01123"></a>01123           <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l01124"></a>01124             {
<a name="l01125"></a>01125             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;bm_send_event(SYNC) error %d&quot;</span>, status);
<a name="l01126"></a>01126             <span class="keywordflow">return</span> status;
<a name="l01127"></a>01127             }
<a name="l01128"></a>01128 <span class="preprocessor">#endif</span>
<a name="l01129"></a>01129 <span class="preprocessor"></span>          }
<a name="l01130"></a>01130         }
<a name="l01131"></a>01131 
<a name="l01132"></a>01132       <span class="keywordflow">if</span> (equipment[index].buffer_handle) {
<a name="l01133"></a>01133 <span class="preprocessor">#ifndef USE_EVENT_CHANNEL</span>
<a name="l01134"></a>01134 <span class="preprocessor"></span>        status = <a class="code" href="group__msectionh.html#ga0116bb8954b16dfdc5d355f7c01127ad">bm_flush_cache</a>(equipment[index].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01135"></a>01135         <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l01136"></a>01136           {
<a name="l01137"></a>01137           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>,<span class="stringliteral">&quot;send_event&quot;</span>,<span class="stringliteral">&quot;bm_flush_cache(SYNC) error %d&quot;</span>, status);
<a name="l01138"></a>01138           <span class="keywordflow">return</span> status;
<a name="l01139"></a>01139           }
<a name="l01140"></a>01140 <span class="preprocessor">#endif</span>
<a name="l01141"></a>01141 <span class="preprocessor"></span>        }
<a name="l01142"></a>01142       }
<a name="l01143"></a>01143     <span class="keywordflow">else</span>
<a name="l01144"></a>01144       {
<a name="l01145"></a>01145       <span class="comment">/* send unfragmented event */</span>
<a name="l01146"></a>01146 
<a name="l01147"></a>01147       <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) <a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>)
<a name="l01148"></a>01148         {
<a name="l01149"></a>01149         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;Event size %ld larger than maximum size %d&quot;</span>,
<a name="l01150"></a>01150           (<span class="keywordtype">long</span>)(pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)), max_event_size);
<a name="l01151"></a>01151         <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l01152"></a>01152         }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154       <span class="comment">/* send event to buffer */</span>
<a name="l01155"></a>01155       <span class="keywordflow">if</span> (equipment[index].buffer_handle)
<a name="l01156"></a>01156         {
<a name="l01157"></a>01157 <span class="preprocessor">#ifdef USE_EVENT_CHANNEL</span>
<a name="l01158"></a>01158 <span class="preprocessor"></span>        <a class="code" href="group__msystemincludecode.html#gaf86511000a179574ea04744ccf04c452">dm_pointer_increment</a>(equipment[index].buffer_handle, 
<a name="l01159"></a>01159           pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01160"></a>01160 <span class="preprocessor">#else</span>
<a name="l01161"></a>01161 <span class="preprocessor"></span>        <a class="code" href="group__msectionh.html#ga0f78b1f2d6558798873b49801c9291e0">rpc_flush_event</a>();
<a name="l01162"></a>01162         status = <a class="code" href="group__msectionh.html#ga5ebc713e2f1e7f0b6d257f072221321f">bm_send_event</a>(equipment[index].buffer_handle, pevent,
<a name="l01163"></a>01163           pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01164"></a>01164         <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l01165"></a>01165           {
<a name="l01166"></a>01166           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>,<span class="stringliteral">&quot;send_event&quot;</span>,<span class="stringliteral">&quot;bm_send_event(SYNC) error %d&quot;</span>,status);
<a name="l01167"></a>01167           <span class="keywordflow">return</span> status;
<a name="l01168"></a>01168           }
<a name="l01169"></a>01169         status = <a class="code" href="group__msectionh.html#ga0116bb8954b16dfdc5d355f7c01127ad">bm_flush_cache</a>(equipment[index].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01170"></a>01170         <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l01171"></a>01171           {
<a name="l01172"></a>01172           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>,<span class="stringliteral">&quot;send_event&quot;</span>,<span class="stringliteral">&quot;bm_flush_cache(SYNC) error %d&quot;</span>,status);
<a name="l01173"></a>01173           <span class="keywordflow">return</span> status;
<a name="l01174"></a>01174           }
<a name="l01175"></a>01175 <span class="preprocessor">#endif</span>
<a name="l01176"></a>01176 <span class="preprocessor"></span>        }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178       <span class="comment">/* send event to ODB if RO_ODB flag is set or history is on. Do not</span>
<a name="l01179"></a>01179 <span class="comment">      send SLOW events since the class driver does that */</span>
<a name="l01180"></a>01180       <span class="keywordflow">if</span> ((eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a>) ||
<a name="l01181"></a>01181         (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga2740dd481bbbb7c8e417b5818ff8e064">history</a> &gt; 0 &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; ~<a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>)))
<a name="l01182"></a>01182         {
<a name="l01183"></a>01183         <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(pevent, equipment[index].hkey_variables, equipment[index].<a class="code" href="webpaw_8c.html#a6113855b8e5965f1e91ee407b4026ab7">format</a>);
<a name="l01184"></a>01184         equipment[index].<a class="code" href="group__midasincludecode.html#ga2ba622da82fc7a02605e5f630464b13f">odb_out</a>++;
<a name="l01185"></a>01185         }
<a name="l01186"></a>01186       }
<a name="l01187"></a>01187 
<a name="l01188"></a>01188     equipment[index].<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l01189"></a>01189     equipment[index].<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     equipment[index].<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> += equipment[index].<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>;
<a name="l01192"></a>01192     equipment[index].<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> = 0;
<a name="l01193"></a>01193    }
<a name="l01194"></a>01194   <span class="keywordflow">else</span>
<a name="l01195"></a>01195     equipment[index].<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>--;
<a name="l01196"></a>01196 
<a name="l01197"></a>01197   <span class="comment">/* emtpy event buffer */</span>
<a name="l01198"></a>01198 <span class="preprocessor">#ifdef USE_EVENT_CHANNEL</span>
<a name="l01199"></a>01199 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((status = <a class="code" href="group__msystemincludecode.html#ga5f455cbb7d25f4d6e2c4c76f763b5fb3">dm_area_flush</a>()) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01200"></a>01200       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>,<span class="stringliteral">&quot;send_event&quot;</span>,<span class="stringliteral">&quot;dm_area_flush: %i&quot;</span>, status);
<a name="l01201"></a>01201 <span class="preprocessor">#endif</span>
<a name="l01202"></a>01202 <span class="preprocessor"></span>
<a name="l01203"></a>01203   <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l01204"></a>01204     <span class="keywordflow">if</span> (equipment[i].buffer_handle)
<a name="l01205"></a>01205       {
<a name="l01206"></a>01206       status = <a class="code" href="group__msectionh.html#ga0116bb8954b16dfdc5d355f7c01127ad">bm_flush_cache</a>(equipment[i].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01207"></a>01207       <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l01208"></a>01208         {
<a name="l01209"></a>01209         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>,<span class="stringliteral">&quot;send_event&quot;</span>,<span class="stringliteral">&quot;bm_flush_cache(SYNC) error %d&quot;</span>, status);
<a name="l01210"></a>01210         <span class="keywordflow">return</span> status;
<a name="l01211"></a>01211         }
<a name="l01212"></a>01212       }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214   <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l01215"></a>01215 }
<a name="l01216"></a>01216 
<a name="l01217"></a>01217 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01218"></a>01218 
<a name="l01219"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">01219</a> <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#aed2a9a6c57de716dc564331cca8f0a85">transition</a>)
<a name="l01220"></a>01220 {
<a name="l01221"></a>01221   <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l01222"></a>01222   <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>            <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l01223"></a>01223 
<a name="l01224"></a>01224   <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l01225"></a>01225   {
<a name="l01226"></a>01226     eq_info = &amp;equipment[i].<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     <span class="keywordflow">if</span> (!eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga512d7966d5f96f8c75fec4ba1b1946c4">enabled</a> || equipment[i].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> != <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l01229"></a>01229       <span class="keywordflow">continue</span>;
<a name="l01230"></a>01230 
<a name="l01231"></a>01231     <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>  &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga88e94e1aadd86417c8eaa304d8c3b467">RO_BOR</a>)    == 0)
<a name="l01232"></a>01232       <span class="keywordflow">continue</span>;
<a name="l01233"></a>01233     <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>   &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga5b505930aa1fc780118b4fc75f771464">RO_EOR</a>)    == 0)
<a name="l01234"></a>01234       <span class="keywordflow">continue</span>;
<a name="l01235"></a>01235     <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#ga11713399cfb35e58b8fae045836c0d88">TR_PAUSE</a>  &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga55beb931c834300fea83d24014f235d8">RO_PAUSE</a>)  == 0)
<a name="l01236"></a>01236       <span class="keywordflow">continue</span>;
<a name="l01237"></a>01237     <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga549159f6ef3ef7c17261bcccecbe57ec">RO_RESUME</a>) == 0)
<a name="l01238"></a>01238       <span class="keywordflow">continue</span>;
<a name="l01239"></a>01239 
<a name="l01240"></a>01240     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">send_event</a>(i);
<a name="l01241"></a>01241   }
<a name="l01242"></a>01242 }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01245"></a>01245 
<a name="l01246"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a0bcbdb26f19446e99086a461e9ec8972">01246</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a0bcbdb26f19446e99086a461e9ec8972">interrupt_enabled</a>;
<a name="l01247"></a>01247 
<a name="l01248"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">01248</a> <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>)
<a name="l01249"></a>01249 {
<a name="l01250"></a>01250   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a0bcbdb26f19446e99086a461e9ec8972">interrupt_enabled</a> = flag;
<a name="l01251"></a>01251 
<a name="l01252"></a>01252   <span class="keywordflow">if</span> (interrupt_eq)
<a name="l01253"></a>01253   {
<a name="l01254"></a>01254     <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a0bcbdb26f19446e99086a461e9ec8972">interrupt_enabled</a>)
<a name="l01255"></a>01255       <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="group__err26.html#gaab5043b2fd69a86d3bcecfb3fd8f7af3">CMD_INTERRUPT_ENABLE</a>,0,0);
<a name="l01256"></a>01256     <span class="keywordflow">else</span>
<a name="l01257"></a>01257       <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="group__err26.html#gaa12884ae2e3cbffa489d7c5074a029f7">CMD_INTERRUPT_DISABLE</a>,0,0);
<a name="l01258"></a>01258   }
<a name="l01259"></a>01259 }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01262"></a>01262 
<a name="l01263"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">01263</a> <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">interrupt_routine</a>(<span class="keywordtype">void</span>)
<a name="l01264"></a>01264 {
<a name="l01265"></a>01265   <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l01266"></a>01266 
<a name="l01267"></a>01267   <span class="comment">/* get pointer for upcoming event.</span>
<a name="l01268"></a>01268 <span class="comment">  This is a blocking call if no space available */</span>
<a name="l01269"></a>01269 <span class="preprocessor">#ifndef USE_PVIC</span>
<a name="l01270"></a>01270 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ((pevent = <a class="code" href="group__msystemincludecode.html#ga166e1796a9a96ae0652665475bd6cfb7">dm_pointer_get</a>()) == NULL)
<a name="l01271"></a>01271     <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;interrupt_routine&quot;</span>, <span class="stringliteral">&quot;interrupt, dm_pointer_get returned NULL&quot;</span>);
<a name="l01272"></a>01272 <span class="preprocessor">#else</span>
<a name="l01273"></a>01273 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ((pevent = pvic_pointer_get()) == NULL)
<a name="l01274"></a>01274     <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;interrupt_routine&quot;</span>, <span class="stringliteral">&quot;interrupt, pvic_pointer_get returned NULL&quot;</span>);
<a name="l01275"></a>01275 <span class="preprocessor">#endif</span>
<a name="l01276"></a>01276 <span class="preprocessor"></span>  
<a name="l01277"></a>01277   <span class="comment">/* compose MIDAS event header */</span>
<a name="l01278"></a>01278   pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>      = interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l01279"></a>01279   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>  = interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#ga5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l01280"></a>01280   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>     = 0;
<a name="l01281"></a>01281   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>    = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l01282"></a>01282   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> = interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01283"></a>01283 
<a name="l01284"></a>01284   <span class="comment">/* call user readout routine */</span>
<a name="l01285"></a>01285   pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#gab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent+1), 0);
<a name="l01286"></a>01286 
<a name="l01287"></a>01287   <span class="comment">/* send event */</span>
<a name="l01288"></a>01288   <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>)
<a name="l01289"></a>01289   {
<a name="l01290"></a>01290     interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l01291"></a>01291     interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293     <span class="keywordflow">if</span> (interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>)
<a name="l01294"></a>01294     {
<a name="l01295"></a>01295 <span class="preprocessor">#ifdef USE_EVENT_CHANNEL</span>
<a name="l01296"></a>01296 <span class="preprocessor"></span>      <a class="code" href="group__msystemincludecode.html#gaf86511000a179574ea04744ccf04c452">dm_pointer_increment</a>(interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, 
<a name="l01297"></a>01297         pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01298"></a>01298 <span class="preprocessor">#else</span>
<a name="l01299"></a>01299 <span class="preprocessor"></span><span class="preprocessor">#ifdef USE_PVIC</span>
<a name="l01300"></a>01300 <span class="preprocessor"></span>      pvic_send_event(interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l01301"></a>01301         pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01302"></a>01302 <span class="preprocessor">#else</span>
<a name="l01303"></a>01303 <span class="preprocessor"></span>      <a class="code" href="group__msectionh.html#ga309d572c69985cd8005f02e78eab4964">rpc_send_event</a>(interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l01304"></a>01304         pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01305"></a>01305 <span class="preprocessor">#endif</span>
<a name="l01306"></a>01306 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01307"></a>01307 <span class="preprocessor"></span>   }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309     <span class="comment">/* send event to ODB */</span>
<a name="l01310"></a>01310     <span class="keywordflow">if</span> (interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a> ||
<a name="l01311"></a>01311       interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#ga2740dd481bbbb7c8e417b5818ff8e064">history</a>)
<a name="l01312"></a>01312     {
<a name="l01313"></a>01313       <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> &gt; <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a380a50d445745c2da54a29a1f2e5099e">ODB_UPDATE_TIME</a>)
<a name="l01314"></a>01314       {
<a name="l01315"></a>01315         interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l01316"></a>01316         memcpy(interrupt_odb_buffer, pevent, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01317"></a>01317         <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aadf15a6e815e15b52fe5680277483e63">interrupt_odb_buffer_valid</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01318"></a>01318         interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga2ba622da82fc7a02605e5f630464b13f">odb_out</a>++;
<a name="l01319"></a>01319       }
<a name="l01320"></a>01320     }
<a name="l01321"></a>01321   }
<a name="l01322"></a>01322   <span class="keywordflow">else</span>
<a name="l01323"></a>01323     interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>--;
<a name="l01324"></a>01324 
<a name="l01325"></a>01325 }
<a name="l01326"></a>01326 
<a name="l01327"></a>01327 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01328"></a>01328 
<a name="l01329"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4186dc25477a1b947c5d6ef64bcc4da0">01329</a> <span class="keywordtype">int</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4186dc25477a1b947c5d6ef64bcc4da0">message_print</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *msg)
<a name="l01330"></a>01330 {
<a name="l01331"></a>01331 <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[160];
<a name="l01332"></a>01332 
<a name="l01333"></a>01333   memset(str, <span class="charliteral">&apos; &apos;</span>, 159);
<a name="l01334"></a>01334   str[159] = 0;
<a name="l01335"></a>01335 
<a name="l01336"></a>01336   <span class="keywordflow">if</span> (msg[0] == <span class="charliteral">&apos;[&apos;</span>)
<a name="l01337"></a>01337     msg = strchr(msg, <span class="charliteral">&apos;]&apos;</span>)+2;
<a name="l01338"></a>01338 
<a name="l01339"></a>01339   memcpy(str, msg, strlen(msg));
<a name="l01340"></a>01340   <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 20, str);
<a name="l01341"></a>01341 
<a name="l01342"></a>01342   <span class="keywordflow">return</span> 0;
<a name="l01343"></a>01343 }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01346"></a>01346 
<a name="l01347"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4d77ab19483f67e8240c29a9ff9ca777">01347</a> <span class="keywordtype">void</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> bInit)
<a name="l01348"></a>01348 {
<a name="l01349"></a>01349 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>    <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01350"></a>01350 time_t full_time;
<a name="l01351"></a>01351 <span class="keywordtype">char</span>   <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[30];
<a name="l01352"></a>01352 
<a name="l01353"></a>01353   <span class="keywordflow">if</span> (bInit)
<a name="l01354"></a>01354     {
<a name="l01355"></a>01355     <a class="code" href="group__msectionh.html#ga8d56c0c36ceb913e9de1043fe5bc269e">ss_clear_screen</a>();
<a name="l01356"></a>01356 
<a name="l01357"></a>01357     <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[0])
<a name="l01358"></a>01358       strcpy(str, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>);
<a name="l01359"></a>01359     <span class="keywordflow">else</span>
<a name="l01360"></a>01360       strcpy(str, <span class="stringliteral">&quot;&lt;local&gt;&quot;</span>);
<a name="l01361"></a>01361 
<a name="l01362"></a>01362     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 0, <span class="stringliteral">&quot;%s connected to %s. Press \&quot;!\&quot; to exit&quot;</span>, <a class="code" href="crate3_2crate_8cpp.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>, str);
<a name="l01363"></a>01363     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 1, <span class="stringliteral">&quot;================================================================================&quot;</span>);
<a name="l01364"></a>01364     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 2, <span class="stringliteral">&quot;Run status:   %s&quot;</span>, <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a> ? <span class="stringliteral">&quot;Stopped&quot;</span> :
<a name="l01365"></a>01365                                         <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a> ? <span class="stringliteral">&quot;Running&quot;</span> :
<a name="l01366"></a>01366                                         <span class="stringliteral">&quot;Paused&quot;</span>);
<a name="l01367"></a>01367     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(25,2, <span class="stringliteral">&quot;Run number %d   &quot;</span>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l01368"></a>01368     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 3, <span class="stringliteral">&quot;================================================================================&quot;</span>);
<a name="l01369"></a>01369     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 4, <span class="stringliteral">&quot;Equipment     Status     Events     Events/sec Rate[kB/s] ODB-&gt;FE    FE-&gt;ODB&quot;</span>);
<a name="l01370"></a>01370     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 5, <span class="stringliteral">&quot;--------------------------------------------------------------------------------&quot;</span>);
<a name="l01371"></a>01371     <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l01372"></a>01372       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, i+6, <span class="stringliteral">&quot;%s&quot;</span>, equipment[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l01373"></a>01373     }
<a name="l01374"></a>01374 
<a name="l01375"></a>01375   <span class="comment">/* display time */</span>
<a name="l01376"></a>01376   <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>(&amp;full_time);
<a name="l01377"></a>01377   strcpy(str, ctime(&amp;full_time)+11);
<a name="l01378"></a>01378   str[8] = 0;
<a name="l01379"></a>01379   <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(72, 0, <span class="stringliteral">&quot;%s&quot;</span>, str);
<a name="l01380"></a>01380 
<a name="l01381"></a>01381   <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l01382"></a>01382     {
<a name="l01383"></a>01383     status = equipment[i].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a>;
<a name="l01384"></a>01384 
<a name="l01385"></a>01385     <span class="keywordflow">if</span> ((status == 0 || status == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>) &amp;&amp;
<a name="l01386"></a>01386         equipment[i].info.enabled)
<a name="l01387"></a>01387       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i+6, <span class="stringliteral">&quot;OK       &quot;</span>);
<a name="l01388"></a>01388     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!equipment[i].info.enabled)
<a name="l01389"></a>01389       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i+6, <span class="stringliteral">&quot;Disabled &quot;</span>);
<a name="l01390"></a>01390     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga8a0cc5de6ea758c61231a11b6a076e1f">FE_ERR_ODB</a>)
<a name="l01391"></a>01391       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i+6, <span class="stringliteral">&quot;ODB Error&quot;</span>);
<a name="l01392"></a>01392     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga9fea053c26a278026fa0d7501c300c4f">FE_ERR_HW</a>)
<a name="l01393"></a>01393       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i+6, <span class="stringliteral">&quot;HW Error &quot;</span>);
<a name="l01394"></a>01394     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>)
<a name="l01395"></a>01395       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i+6, <span class="stringliteral">&quot;Disabled &quot;</span>);
<a name="l01396"></a>01396     <span class="keywordflow">else</span>
<a name="l01397"></a>01397       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i+6, <span class="stringliteral">&quot;Unknown  &quot;</span>);
<a name="l01398"></a>01398 
<a name="l01399"></a>01399     <span class="keywordflow">if</span> (equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt; 1E9)
<a name="l01400"></a>01400       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(25, i+6, <span class="stringliteral">&quot;%1.3lfG     &quot;</span>, equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>/1E9);
<a name="l01401"></a>01401     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt; 1E6)
<a name="l01402"></a>01402       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(25, i+6, <span class="stringliteral">&quot;%1.3lfM     &quot;</span>, equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>/1E6);
<a name="l01403"></a>01403     <span class="keywordflow">else</span>
<a name="l01404"></a>01404       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(25, i+6, <span class="stringliteral">&quot;%1.0lf      &quot;</span>, equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>);
<a name="l01405"></a>01405     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(36, i+6, <span class="stringliteral">&quot;%1.1lf      &quot;</span>, equipment[i].stats.events_per_sec);
<a name="l01406"></a>01406     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(47, i+6, <span class="stringliteral">&quot;%1.1lf      &quot;</span>, equipment[i].stats.kbytes_per_sec);
<a name="l01407"></a>01407     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(58, i+6, <span class="stringliteral">&quot;%ld       &quot;</span>, equipment[i].odb_in);
<a name="l01408"></a>01408     <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(69, i+6, <span class="stringliteral">&quot;%ld       &quot;</span>, equipment[i].odb_out);
<a name="l01409"></a>01409     }
<a name="l01410"></a>01410 
<a name="l01411"></a>01411   <span class="comment">/* go to next line */</span>
<a name="l01412"></a>01412   <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, i+6, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01413"></a>01413 }
<a name="l01414"></a>01414 
<a name="l01415"></a>01415 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01416"></a>01416 
<a name="l01417"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ace89325172f363d2efd92735e52ec69e">01417</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ace89325172f363d2efd92735e52ec69e">logger_root</a>()
<a name="l01418"></a>01418 <span class="comment">/* check if logger uses ROOT format */</span>
<a name="l01419"></a>01419 {
<a name="l01420"></a>01420 <span class="keywordtype">int</span>   <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01421"></a>01421 <span class="keywordtype">char</span>  <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[80];
<a name="l01422"></a>01422 <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hKeyRoot, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424   <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Channels&quot;</span>, &amp;hKeyRoot) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01425"></a>01425     {
<a name="l01426"></a>01426     <span class="keywordflow">for</span> (i=0;  ; i++)
<a name="l01427"></a>01427       {
<a name="l01428"></a>01428       status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, i, &amp;hKey);
<a name="l01429"></a>01429       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01430"></a>01430         <span class="keywordflow">break</span>;
<a name="l01431"></a>01431 
<a name="l01432"></a>01432       strcpy(str, <span class="stringliteral">&quot;MIDAS&quot;</span>);
<a name="l01433"></a>01433       size = <span class="keyword">sizeof</span>(str);
<a name="l01434"></a>01434       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Settings/Format&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01435"></a>01435 
<a name="l01436"></a>01436       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;ROOT&quot;</span>))
<a name="l01437"></a>01437         <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01438"></a>01438       }
<a name="l01439"></a>01439     }
<a name="l01440"></a>01440 
<a name="l01441"></a>01441   <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01442"></a>01442 }
<a name="l01443"></a>01443 
<a name="l01444"></a>01444 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01445"></a>01445 
<a name="l01446"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a94c9987508c91ae4827cc231f43b577e">01446</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a94c9987508c91ae4827cc231f43b577e">scheduler</a>(<span class="keywordtype">void</span>)
<a name="l01447"></a>01447 {
<a name="l01448"></a>01448 <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l01449"></a>01449 <a class="code" href="structeqpmnt.html">EQUIPMENT</a>      *<a class="code" href="mdump_8c.html#a435a42b0c4c892426633a4295f59586e">eq</a>;
<a name="l01450"></a>01450 <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>   *pevent;
<a name="l01451"></a>01451 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>          last_time_network=0, last_time_display=0,
<a name="l01452"></a>01452                last_time_flush=0, readout_start;
<a name="l01453"></a>01453 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>            <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, ch, source, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, state;
<a name="l01454"></a>01454 <span class="keywordtype">char</span>           <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[80];
<a name="l01455"></a>01455 <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>           buffer_done, <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>, force_update = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01456"></a>01456 
<a name="l01457"></a>01457 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> opt_max=0, opt_index=0, opt_tcp_size=128, opt_cnt=0;
<a name="l01458"></a>01458 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> err;
<a name="l01459"></a>01459 
<a name="l01460"></a>01460 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l01461"></a>01461 <span class="preprocessor"></span>  <a class="code" href="group__msystemincludecode.html#ga557392f16da0dcf6fd1886c5a46e70c4">rpc_set_opt_tcp_size</a>(1024);
<a name="l01462"></a>01462 <span class="preprocessor">#ifdef PPCxxx</span>
<a name="l01463"></a>01463 <span class="preprocessor"></span>  <a class="code" href="group__msystemincludecode.html#ga557392f16da0dcf6fd1886c5a46e70c4">rpc_set_opt_tcp_size</a>(<a class="code" href="group__midasincludecode.html#ga31190e25ed33be085ff0af476af2c029">NET_TCP_SIZE</a>);
<a name="l01464"></a>01464 <span class="preprocessor">#endif</span>
<a name="l01465"></a>01465 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01466"></a>01466 <span class="preprocessor"></span>
<a name="l01467"></a>01467   <span class="comment">/*----------------- MAIN equipment loop ------------------------------*/</span>
<a name="l01468"></a>01468 
<a name="l01469"></a>01469   <span class="keywordflow">do</span>
<a name="l01470"></a>01470     {
<a name="l01471"></a>01471     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01472"></a>01472     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a> = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>();
<a name="l01473"></a>01473 
<a name="l01474"></a>01474     <span class="comment">/*---- loop over equipment table -------------------------------*/</span>
<a name="l01475"></a>01475     <span class="keywordflow">for</span> (index=0 ; ; index++)
<a name="l01476"></a>01476       {
<a name="l01477"></a>01477       eq = &amp;equipment[index];
<a name="l01478"></a>01478       eq_info = &amp;eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l01479"></a>01479 
<a name="l01480"></a>01480       <span class="comment">/* check if end of equipment list */</span>
<a name="l01481"></a>01481       <span class="keywordflow">if</span> (!eq-&gt;<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0])
<a name="l01482"></a>01482         <span class="keywordflow">break</span>;
<a name="l01483"></a>01483 
<a name="l01484"></a>01484       <span class="keywordflow">if</span> (!eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>)
<a name="l01485"></a>01485         <span class="keywordflow">continue</span>;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487       <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> != <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l01488"></a>01488         <span class="keywordflow">continue</span>;
<a name="l01489"></a>01489 
<a name="l01490"></a>01490       <span class="comment">/*---- call idle routine for slow control equipment ----*/</span>
<a name="l01491"></a>01491       <span class="keywordflow">if</span> ((eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) &amp;&amp;
<a name="l01492"></a>01492           eq-&gt;<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l01493"></a>01493         {
<a name="l01494"></a>01494         <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>&gt;0 &amp;&amp; <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>)
<a name="l01495"></a>01495           {
<a name="l01496"></a>01496           <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a> - eq-&gt;<a class="code" href="group__midasincludecode.html#ga8261688ef7d0d371cdf50023cf0447c1">last_idle</a> &gt;= (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>)
<a name="l01497"></a>01497             {
<a name="l01498"></a>01498             eq-&gt;<a class="code" href="group__midasincludecode.html#gae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga433697a25587c6ffe8a14f02e5be9066">CMD_IDLE</a>, eq);
<a name="l01499"></a>01499             eq-&gt;<a class="code" href="group__midasincludecode.html#ga8261688ef7d0d371cdf50023cf0447c1">last_idle</a> = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l01500"></a>01500             }
<a name="l01501"></a>01501           }
<a name="l01502"></a>01502         <span class="keywordflow">else</span>
<a name="l01503"></a>01503           eq-&gt;<a class="code" href="group__midasincludecode.html#gae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga433697a25587c6ffe8a14f02e5be9066">CMD_IDLE</a>, eq);
<a name="l01504"></a>01504         }
<a name="l01505"></a>01505 
<a name="l01506"></a>01506       <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga05a5abc619ab24e168695befc7c0b4be">RO_STOPPED</a>) == 0)
<a name="l01507"></a>01507         <span class="keywordflow">continue</span>;
<a name="l01508"></a>01508       <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gab08c47284371c683ba80d6b3244400f1">STATE_PAUSED</a>  &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga8a47b3b86a72a7db84a582277d4b7a39">RO_PAUSED</a>)  == 0)
<a name="l01509"></a>01509         <span class="keywordflow">continue</span>;
<a name="l01510"></a>01510       <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#gafc5ef41cae398b8500f9c3a42cef6d2c">RO_RUNNING</a>) == 0)
<a name="l01511"></a>01511         <span class="keywordflow">continue</span>;
<a name="l01512"></a>01512 
<a name="l01513"></a>01513       <span class="comment">/*---- check periodic events ----*/</span>
<a name="l01514"></a>01514       <span class="keywordflow">if</span> ((eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga58e919e4e401b299c1834be965c3e78c">EQ_PERIODIC</a>) || (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>))
<a name="l01515"></a>01515         {
<a name="l01516"></a>01516         <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#gaf7f674490636b6f9736fb680201001c2">period</a> == 0)
<a name="l01517"></a>01517           <span class="keywordflow">continue</span>;
<a name="l01518"></a>01518 
<a name="l01519"></a>01519         <span class="comment">/* check if period over */</span>
<a name="l01520"></a>01520         <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> &gt;= (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) eq_info-&gt;<a class="code" href="group__midasincludecode.html#gaf7f674490636b6f9736fb680201001c2">period</a>)
<a name="l01521"></a>01521           {
<a name="l01522"></a>01522           <span class="comment">/* disable interrupts during readout */</span>
<a name="l01523"></a>01523           <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525           <span class="comment">/* readout and send event */</span>
<a name="l01526"></a>01526           status = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">send_event</a>(index);
<a name="l01527"></a>01527 
<a name="l01528"></a>01528           <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01529"></a>01529             {
<a name="l01530"></a>01530             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;send_event error %d&quot;</span>,status);
<a name="l01531"></a>01531             <span class="keywordflow">goto</span> net_error;
<a name="l01532"></a>01532             }
<a name="l01533"></a>01533 
<a name="l01534"></a>01534           <span class="comment">/* re-enable the interrupt after periodic */</span>
<a name="l01535"></a>01535           <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01536"></a>01536           }
<a name="l01537"></a>01537         } <span class="comment">/* end of periodic equipments */</span>
<a name="l01538"></a>01538 
<a name="l01539"></a>01539       <span class="comment">/*---- check polled events ----*/</span>
<a name="l01540"></a>01540       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>)
<a name="l01541"></a>01541         {
<a name="l01542"></a>01542         readout_start = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l01543"></a>01543         pevent = NULL;
<a name="l01544"></a>01544 
<a name="l01545"></a>01545         <span class="keywordflow">while</span> ((source = <a class="code" href="crate3_2crate_8cpp.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga345e65d8874f6b968bedc00e76d4f431">source</a>, eq-&gt;<a class="code" href="group__midasincludecode.html#gae9bf94db8ff48533601c3833b1b20097">poll_count</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)) &gt; 0)
<a name="l01546"></a>01546           {
<a name="l01547"></a>01547 <span class="preprocessor">#ifndef USE_PVIC</span>
<a name="l01548"></a>01548 <span class="preprocessor"></span>          pevent = <a class="code" href="group__msystemincludecode.html#ga166e1796a9a96ae0652665475bd6cfb7">dm_pointer_get</a>();
<a name="l01549"></a>01549 <span class="preprocessor">#else</span>
<a name="l01550"></a>01550 <span class="preprocessor"></span>          pevent = pvic_pointer_get();
<a name="l01551"></a>01551 <span class="preprocessor">#endif</span>
<a name="l01552"></a>01552 <span class="preprocessor"></span>          <span class="keywordflow">if</span> (pevent == NULL)
<a name="l01553"></a>01553             {
<a name="l01554"></a>01554             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;polled, dm_pointer_get not returning valid pointer&quot;</span>);
<a name="l01555"></a>01555             status = <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l01556"></a>01556             <span class="keywordflow">goto</span> net_error;
<a name="l01557"></a>01557             }
<a name="l01558"></a>01558             
<a name="l01559"></a>01559           <span class="comment">/* compose MIDAS event header */</span>
<a name="l01560"></a>01560           pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>      = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l01561"></a>01561           pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>  = eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l01562"></a>01562           pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>     = 0;
<a name="l01563"></a>01563           pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>    = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l01564"></a>01564           pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> = eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>;
<a name="l01565"></a>01565 
<a name="l01566"></a>01566           <span class="comment">/* put source at beginning of event, will be overwritten by </span>
<a name="l01567"></a>01567 <span class="comment">             user readout code, just a special feature used by some </span>
<a name="l01568"></a>01568 <span class="comment">             multi-source applications */</span>
<a name="l01569"></a>01569           *(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) (pevent+1) = source;
<a name="l01570"></a>01570 
<a name="l01571"></a>01571           <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#gade7b61b85a73ed33545caf31b706acd3">num_subevents</a>)
<a name="l01572"></a>01572             {
<a name="l01573"></a>01573             eq-&gt;<a class="code" href="group__midasincludecode.html#ga1649c4fed8b7c97441a167a860cae4af">subevent_number</a> = 0;
<a name="l01574"></a>01574             <span class="keywordflow">do</span>
<a name="l01575"></a>01575               {
<a name="l01576"></a>01576               *(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) ((<span class="keywordtype">char</span> *)(pevent+1)+pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>) = source;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578               <span class="comment">/* call user readout routine for subevent indicating offset */</span>
<a name="l01579"></a>01579               size = eq-&gt;<a class="code" href="group__midasincludecode.html#gab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent+1), pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l01580"></a>01580               pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> += size;
<a name="l01581"></a>01581               <span class="keywordflow">if</span> (size &gt; 0)
<a name="l01582"></a>01582                 {
<a name="l01583"></a>01583                 <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) <a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>)
<a name="l01584"></a>01584                   {
<a name="l01585"></a>01585                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;Event size %ld larger than maximum size %d&quot;</span>,
<a name="l01586"></a>01586                          (<span class="keywordtype">long</span>)(pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)), max_event_size);
<a name="l01587"></a>01587                   }
<a name="l01588"></a>01588 
<a name="l01589"></a>01589                 eq-&gt;<a class="code" href="group__midasincludecode.html#ga1649c4fed8b7c97441a167a860cae4af">subevent_number</a>++;
<a name="l01590"></a>01590                 eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01591"></a>01591                 }
<a name="l01592"></a>01592 
<a name="l01593"></a>01593               <span class="comment">/* wait for next event */</span>
<a name="l01594"></a>01594               <span class="keywordflow">do</span>
<a name="l01595"></a>01595                 {
<a name="l01596"></a>01596                 source = <a class="code" href="crate3_2crate_8cpp.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga345e65d8874f6b968bedc00e76d4f431">source</a>, eq-&gt;<a class="code" href="group__midasincludecode.html#gae9bf94db8ff48533601c3833b1b20097">poll_count</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01597"></a>01597 
<a name="l01598"></a>01598                 <span class="keywordflow">if</span> (source == <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l01599"></a>01599                   {
<a name="l01600"></a>01600                   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01601"></a>01601 
<a name="l01602"></a>01602                   <span class="comment">/* repeat no more than period */</span>
<a name="l01603"></a>01603                   <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - readout_start &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) eq_info-&gt;<a class="code" href="group__midasincludecode.html#gaf7f674490636b6f9736fb680201001c2">period</a>)
<a name="l01604"></a>01604                     <span class="keywordflow">break</span>;
<a name="l01605"></a>01605                   }
<a name="l01606"></a>01606                 } <span class="keywordflow">while</span> (source == <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01607"></a>01607 
<a name="l01608"></a>01608               } <span class="keywordflow">while</span> (eq-&gt;<a class="code" href="group__midasincludecode.html#ga1649c4fed8b7c97441a167a860cae4af">subevent_number</a> &lt; eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#gade7b61b85a73ed33545caf31b706acd3">num_subevents</a> &amp;&amp; source);
<a name="l01609"></a>01609 
<a name="l01610"></a>01610             <span class="comment">/* notify readout routine about end of super-event */</span>
<a name="l01611"></a>01611             pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = eq-&gt;<a class="code" href="group__midasincludecode.html#gab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent+1), -1);
<a name="l01612"></a>01612             }
<a name="l01613"></a>01613           <span class="keywordflow">else</span>
<a name="l01614"></a>01614             {
<a name="l01615"></a>01615             <span class="comment">/* call user readout routine indicating event source */</span>
<a name="l01616"></a>01616             pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = eq-&gt;<a class="code" href="group__midasincludecode.html#gab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent+1), 0);
<a name="l01617"></a>01617 
<a name="l01618"></a>01618             <span class="comment">/* check event size */</span>
<a name="l01619"></a>01619             <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) <a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>)
<a name="l01620"></a>01620               {
<a name="l01621"></a>01621               <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;Event size %ld larger than maximum size %d&quot;</span>,
<a name="l01622"></a>01622                      (<span class="keywordtype">long</span>)(pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)), max_event_size);
<a name="l01623"></a>01623               }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625             <span class="comment">/* increment serial number if event read out sucessfully */</span>
<a name="l01626"></a>01626             <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>)
<a name="l01627"></a>01627               eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01628"></a>01628             }
<a name="l01629"></a>01629 
<a name="l01630"></a>01630           <span class="comment">/* send event */</span>
<a name="l01631"></a>01631           <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>)
<a name="l01632"></a>01632             {
<a name="l01633"></a>01633             <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>)
<a name="l01634"></a>01634               {
<a name="l01635"></a>01635               <span class="comment">/* send first event to ODB if logger writes in root format */</span>
<a name="l01636"></a>01636               <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> == 1)
<a name="l01637"></a>01637                 <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ace89325172f363d2efd92735e52ec69e">logger_root</a>())
<a name="l01638"></a>01638                   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(pevent, eq-&gt;<a class="code" href="group__midasincludecode.html#gab6664c255e4c3fdc58806733ac04503b">hkey_variables</a>, eq-&gt;<a class="code" href="group__midasincludecode.html#gacad980d7699722234c72bfca6243203b">format</a>);
<a name="l01639"></a>01639 
<a name="l01640"></a>01640 <span class="preprocessor">#ifdef USE_EVENT_CHANNEL</span>
<a name="l01641"></a>01641 <span class="preprocessor"></span>              <a class="code" href="group__msystemincludecode.html#gaf86511000a179574ea04744ccf04c452">dm_pointer_increment</a>(eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, 
<a name="l01642"></a>01642                                    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01643"></a>01643 <span class="preprocessor">#else</span>
<a name="l01644"></a>01644 <span class="preprocessor"></span><span class="preprocessor">#ifdef USE_PVIC</span>
<a name="l01645"></a>01645 <span class="preprocessor"></span>              status = pvic_send_event(eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l01646"></a>01646                              pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01647"></a>01647 <span class="preprocessor">#else</span>
<a name="l01648"></a>01648 <span class="preprocessor"></span>              status = <a class="code" href="group__msectionh.html#ga309d572c69985cd8005f02e78eab4964">rpc_send_event</a>(eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l01649"></a>01649                              pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01650"></a>01650 <span class="preprocessor">#endif</span>
<a name="l01651"></a>01651 <span class="preprocessor"></span>
<a name="l01652"></a>01652               <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l01653"></a>01653                 {
<a name="l01654"></a>01654                 <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;rpc_send_event error %d&quot;</span>, status);
<a name="l01655"></a>01655                 <span class="keywordflow">goto</span> net_error;
<a name="l01656"></a>01656                 }
<a name="l01657"></a>01657 <span class="preprocessor">#endif</span>
<a name="l01658"></a>01658 <span class="preprocessor"></span>
<a name="l01659"></a>01659               eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l01660"></a>01660 
<a name="l01661"></a>01661               <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#gade7b61b85a73ed33545caf31b706acd3">num_subevents</a>)
<a name="l01662"></a>01662                 eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> += eq-&gt;<a class="code" href="group__midasincludecode.html#ga1649c4fed8b7c97441a167a860cae4af">subevent_number</a>;
<a name="l01663"></a>01663               <span class="keywordflow">else</span>
<a name="l01664"></a>01664                 eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l01665"></a>01665               }
<a name="l01666"></a>01666             }
<a name="l01667"></a>01667 
<a name="l01668"></a>01668           <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01669"></a>01669 
<a name="l01670"></a>01670           <span class="comment">/* repeat no more than period */</span>
<a name="l01671"></a>01671           <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - readout_start &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) eq_info-&gt;<a class="code" href="group__midasincludecode.html#gaf7f674490636b6f9736fb680201001c2">period</a>)
<a name="l01672"></a>01672             <span class="keywordflow">break</span>;
<a name="l01673"></a>01673 
<a name="l01674"></a>01674           <span class="comment">/* quit if event limit is reached */</span>
<a name="l01675"></a>01675           <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &gt; 0 &amp;&amp;
<a name="l01676"></a>01676               eq-&gt;<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> + eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt;= eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>)
<a name="l01677"></a>01677             <span class="keywordflow">break</span>;
<a name="l01678"></a>01678           }
<a name="l01679"></a>01679 
<a name="l01680"></a>01680         <span class="comment">/* send event to ODB */</span>
<a name="l01681"></a>01681         <span class="keywordflow">if</span> (pevent &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a> || eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga2740dd481bbbb7c8e417b5818ff8e064">history</a>))
<a name="l01682"></a>01682           {
<a name="l01683"></a>01683           <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> &gt; <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a380a50d445745c2da54a29a1f2e5099e">ODB_UPDATE_TIME</a> &amp;&amp; pevent != NULL)
<a name="l01684"></a>01684             {
<a name="l01685"></a>01685             eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l01686"></a>01686             <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(pevent, eq-&gt;<a class="code" href="group__midasincludecode.html#gab6664c255e4c3fdc58806733ac04503b">hkey_variables</a>, eq-&gt;<a class="code" href="group__midasincludecode.html#gacad980d7699722234c72bfca6243203b">format</a>);
<a name="l01687"></a>01687             eq-&gt;<a class="code" href="group__midasincludecode.html#ga2ba622da82fc7a02605e5f630464b13f">odb_out</a>++;
<a name="l01688"></a>01688             }
<a name="l01689"></a>01689           }
<a name="l01690"></a>01690         }
<a name="l01691"></a>01691 
<a name="l01692"></a>01692       <span class="comment">/*---- send interrupt events ----*/</span>
<a name="l01693"></a>01693       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gad5ba2ec0f5d55139048dbe2d416da6ba">EQ_INTERRUPT</a>)
<a name="l01694"></a>01694         {
<a name="l01695"></a>01695         <span class="comment">/* not much to do as work being done independently in interrupt_routine() */</span>
<a name="l01696"></a>01696 
<a name="l01697"></a>01697         <span class="comment">/* update ODB */</span>
<a name="l01698"></a>01698         <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aadf15a6e815e15b52fe5680277483e63">interrupt_odb_buffer_valid</a>)
<a name="l01699"></a>01699           {
<a name="l01700"></a>01700           <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(interrupt_odb_buffer, interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#gab6664c255e4c3fdc58806733ac04503b">hkey_variables</a>,
<a name="l01701"></a>01701                      interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#gacad980d7699722234c72bfca6243203b">format</a>);
<a name="l01702"></a>01702           <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aadf15a6e815e15b52fe5680277483e63">interrupt_odb_buffer_valid</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01703"></a>01703           }
<a name="l01704"></a>01704 
<a name="l01705"></a>01705         }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707       <span class="comment">/*---- check if event limit is reached ----*/</span>
<a name="l01708"></a>01708       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> != <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a> &amp;&amp;
<a name="l01709"></a>01709           eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &gt; 0 &amp;&amp;
<a name="l01710"></a>01710           eq-&gt;<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> + eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt;= eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &amp;&amp;
<a name="l01711"></a>01711           <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>)
<a name="l01712"></a>01712         {
<a name="l01713"></a>01713         <span class="comment">/* stop run */</span>
<a name="l01714"></a>01714         <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga98ba67d921647dab7eb4f00e5dea7ba0">cm_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, 0, str, <span class="keyword">sizeof</span>(str), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01715"></a>01715           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;cannot stop run: %s&quot;</span>, str);
<a name="l01716"></a>01716 
<a name="l01717"></a>01717         <span class="comment">/* check if autorestart, main loop will take care of it */</span>
<a name="l01718"></a>01718         size = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l01719"></a>01719         flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01720"></a>01720         <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Auto restart&quot;</span>, &amp;flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01721"></a>01721 
<a name="l01722"></a>01722         <span class="keywordflow">if</span> (flag)
<a name="l01723"></a>01723           <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>() + 20; <span class="comment">/* restart in 20 sec. */</span>
<a name="l01724"></a>01724 
<a name="l01725"></a>01725         <span class="comment">/* update event display correctly */</span>
<a name="l01726"></a>01726         force_update = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01727"></a>01727         }
<a name="l01728"></a>01728       }
<a name="l01729"></a>01729 
<a name="l01730"></a>01730     <span class="comment">/*---- call frontend_loop periodically -------------------------*/</span>
<a name="l01731"></a>01731     <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a0215c0a842a0e97fe65c7ef5fb7633a5">frontend_call_loop</a>)
<a name="l01732"></a>01732       {
<a name="l01733"></a>01733       status = <a class="code" href="crate3_2crate_8cpp.html#ada66837c3c3d263974ad717921145e0a">frontend_loop</a>();
<a name="l01734"></a>01734       <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01735"></a>01735         status = <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l01736"></a>01736       }
<a name="l01737"></a>01737 
<a name="l01738"></a>01738     <span class="comment">/*---- check for deferred transitions --------------------------*/</span>
<a name="l01739"></a>01739     <a class="code" href="group__msectionh.html#ga77dc9e4c38a1303a6b4d3269a59a068e">cm_check_deferred_transition</a>();
<a name="l01740"></a>01740 
<a name="l01741"></a>01741     <span class="comment">/*---- calculate rates and update status page periodically -----*/</span>
<a name="l01742"></a>01742     <span class="keywordflow">if</span> (force_update ||
<a name="l01743"></a>01743         (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a> &amp;&amp; <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_display &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) <a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>) ||
<a name="l01744"></a>01744         (!display_period &amp;&amp; <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_display &gt; 3000))
<a name="l01745"></a>01745       {
<a name="l01746"></a>01746       force_update = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748       <span class="comment">/* calculate rates */</span>
<a name="l01749"></a>01749       <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> != last_time_display)
<a name="l01750"></a>01750         {
<a name="l01751"></a>01751         <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a> = 0;
<a name="l01752"></a>01752         <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l01753"></a>01753           {
<a name="l01754"></a>01754           eq = &amp;equipment[i];
<a name="l01755"></a>01755           eq-&gt;<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> += eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>;
<a name="l01756"></a>01756           eq-&gt;<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="group__midasincludecode.html#ga218c744ea441413af262fbd5ddf3780f">events_per_sec</a> =
<a name="l01757"></a>01757             eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>/((<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>-last_time_display)/1000.0);
<a name="l01758"></a>01758           eq-&gt;<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="group__midasincludecode.html#ga7a7a7d4b78841a36d156a0941616538f">kbytes_per_sec</a> =
<a name="l01759"></a>01759             eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a>/1024.0/((<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>-last_time_display)/1000.0);
<a name="l01760"></a>01760 
<a name="l01761"></a>01761           <span class="keywordflow">if</span> ((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> &gt; <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a>)
<a name="l01762"></a>01762             <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a> = eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a>;
<a name="l01763"></a>01763 
<a name="l01764"></a>01764           eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> = 0;
<a name="l01765"></a>01765           eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> = 0;
<a name="l01766"></a>01766           }
<a name="l01767"></a>01767         
<a name="l01768"></a>01768         <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a> = (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) 
<a name="l01769"></a>01769           ((<span class="keywordtype">double</span>)<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a>/((<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>-last_time_display)/1000.0));
<a name="l01770"></a>01770 
<a name="l01771"></a>01771         <span class="comment">/* tcp buffer size evaluation */</span>
<a name="l01772"></a>01772         <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a17033889b9f2e378c3bc26401a399550">optimize</a>)
<a name="l01773"></a>01773           {
<a name="l01774"></a>01774           opt_max = <a class="code" href="Mql_8h.html#afa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(opt_max, (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>)<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a>);
<a name="l01775"></a>01775           <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, opt_index, <span class="stringliteral">&quot;%6d : %5.1lf %5.1lf&quot;</span>, opt_tcp_size, opt_max/1024.0,
<a name="l01776"></a>01776                     max_bytes_per_sec/1024.0);
<a name="l01777"></a>01777           <span class="keywordflow">if</span> (++opt_cnt == 10)
<a name="l01778"></a>01778             {
<a name="l01779"></a>01779             opt_cnt = 0;
<a name="l01780"></a>01780             opt_max = 0;
<a name="l01781"></a>01781             opt_index++;
<a name="l01782"></a>01782             opt_tcp_size = 1&lt;&lt;(opt_index+7);
<a name="l01783"></a>01783             <a class="code" href="group__msystemincludecode.html#ga557392f16da0dcf6fd1886c5a46e70c4">rpc_set_opt_tcp_size</a>(opt_tcp_size);
<a name="l01784"></a>01784             <span class="keywordflow">if</span> (1&lt;&lt;(opt_index+7) &gt; 0x8000)
<a name="l01785"></a>01785               {
<a name="l01786"></a>01786               opt_index = 0;
<a name="l01787"></a>01787               opt_tcp_size = 1&lt;&lt;7;
<a name="l01788"></a>01788               <a class="code" href="group__msystemincludecode.html#ga557392f16da0dcf6fd1886c5a46e70c4">rpc_set_opt_tcp_size</a>(opt_tcp_size);
<a name="l01789"></a>01789               }
<a name="l01790"></a>01790             }
<a name="l01791"></a>01791           }
<a name="l01792"></a>01792 
<a name="l01793"></a>01793       <span class="comment">/* propagate changes in equipment to ODB */</span>
<a name="l01794"></a>01794       <a class="code" href="group__msectionh.html#ga3d863362443e54777f3e4033f1603980">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#gaf80a4b4b5569b25d6e8488a6bafeb347">RPC_FTCP</a>);
<a name="l01795"></a>01795       <a class="code" href="group__msectionh.html#ga90c77b8a4ca06f60b0f595c8f16a39bc">db_send_changed_records</a>();
<a name="l01796"></a>01796       <a class="code" href="group__msectionh.html#ga3d863362443e54777f3e4033f1603980">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#ga9d0de5957c2c776323a0c74e668f544d">RPC_TCP</a>);
<a name="l01797"></a>01797 
<a name="l01798"></a>01798         }
<a name="l01799"></a>01799 
<a name="l01800"></a>01800 
<a name="l01801"></a>01801       <span class="keywordflow">if</span> (display_period)
<a name="l01802"></a>01802         {
<a name="l01803"></a>01803         <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01804"></a>01804 
<a name="l01805"></a>01805         <span class="comment">/* check keyboard */</span>
<a name="l01806"></a>01806         ch = 0;
<a name="l01807"></a>01807         status = 0;
<a name="l01808"></a>01808         <span class="keywordflow">while</span> (<a class="code" href="group__msectionh.html#gae96b0ebe47aa1d54f800e4f2e7f564b9">ss_kbhit</a>())
<a name="l01809"></a>01809           {
<a name="l01810"></a>01810           ch = <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(0);
<a name="l01811"></a>01811           <span class="keywordflow">if</span> (ch == -1)
<a name="l01812"></a>01812             ch = getchar();
<a name="l01813"></a>01813 
<a name="l01814"></a>01814           <span class="keywordflow">if</span> (ch == <span class="charliteral">&apos;!&apos;</span>)
<a name="l01815"></a>01815             status = <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l01816"></a>01816           }
<a name="l01817"></a>01817 
<a name="l01818"></a>01818         <span class="keywordflow">if</span> (ch &gt; 0)
<a name="l01819"></a>01819           <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01820"></a>01820         <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l01821"></a>01821           <span class="keywordflow">break</span>;
<a name="l01822"></a>01822         }
<a name="l01823"></a>01823 
<a name="l01824"></a>01824       last_time_display = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l01825"></a>01825       }
<a name="l01826"></a>01826 
<a name="l01827"></a>01827     <span class="comment">/*---- check to flush cache ------------------------------------*/</span>
<a name="l01828"></a>01828     <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_flush &gt; 1000)
<a name="l01829"></a>01829       {
<a name="l01830"></a>01830       last_time_flush = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l01831"></a>01831       
<a name="l01832"></a>01832       <span class="comment">/* if cache on server is not filled in one second at current</span>
<a name="l01833"></a>01833 <span class="comment">         data rate, flush it now to make events available to consumers */</span>
<a name="l01834"></a>01834       
<a name="l01835"></a>01835       <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a> &lt; <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a022c39e327f494dda3664f8888f860f1">SERVER_CACHE_SIZE</a>)
<a name="l01836"></a>01836         {
<a name="l01837"></a>01837         <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01838"></a>01838 
<a name="l01839"></a>01839 <span class="preprocessor">#ifdef USE_EVENT_CHANNEL</span>
<a name="l01840"></a>01840 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((status = <a class="code" href="group__msystemincludecode.html#ga5f455cbb7d25f4d6e2c4c76f763b5fb3">dm_area_flush</a>()) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01841"></a>01841           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;dm_area_flush: %i&quot;</span>, status);
<a name="l01842"></a>01842 <span class="preprocessor">#endif</span>
<a name="l01843"></a>01843 <span class="preprocessor"></span>
<a name="l01844"></a>01844         <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l01845"></a>01845           {
<a name="l01846"></a>01846           <span class="keywordflow">if</span> (equipment[i].buffer_handle)
<a name="l01847"></a>01847             {
<a name="l01848"></a>01848             <span class="comment">/* check if buffer already flushed */</span>
<a name="l01849"></a>01849             buffer_done = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01850"></a>01850             <span class="keywordflow">for</span> (j=0 ; j&lt;i ; j++)
<a name="l01851"></a>01851               <span class="keywordflow">if</span> (equipment[i].buffer_handle == equipment[j].buffer_handle)
<a name="l01852"></a>01852                 {
<a name="l01853"></a>01853                 buffer_done = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01854"></a>01854                 <span class="keywordflow">break</span>;
<a name="l01855"></a>01855                 }
<a name="l01856"></a>01856 
<a name="l01857"></a>01857             <span class="keywordflow">if</span> (!buffer_done)
<a name="l01858"></a>01858               {
<a name="l01859"></a>01859               <a class="code" href="group__msectionh.html#ga3d863362443e54777f3e4033f1603980">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#gaf80a4b4b5569b25d6e8488a6bafeb347">RPC_FTCP</a>);
<a name="l01860"></a>01860           <a class="code" href="group__msectionh.html#ga0f78b1f2d6558798873b49801c9291e0">rpc_flush_event</a>();
<a name="l01861"></a>01861               err = <a class="code" href="group__msectionh.html#ga0116bb8954b16dfdc5d355f7c01127ad">bm_flush_cache</a>(equipment[i].buffer_handle, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>);
<a name="l01862"></a>01862           <span class="keywordflow">if</span> (err != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l01863"></a>01863         {
<a name="l01864"></a>01864           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>,<span class="stringliteral">&quot;scheduler&quot;</span>,<span class="stringliteral">&quot;bm_flush_cache(ASYNC) error %d&quot;</span>,err);
<a name="l01865"></a>01865           <span class="keywordflow">return</span> err;
<a name="l01866"></a>01866         }
<a name="l01867"></a>01867               <a class="code" href="group__msectionh.html#ga3d863362443e54777f3e4033f1603980">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#ga9d0de5957c2c776323a0c74e668f544d">RPC_TCP</a>);
<a name="l01868"></a>01868               }
<a name="l01869"></a>01869             }
<a name="l01870"></a>01870           }
<a name="l01871"></a>01871         <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01872"></a>01872         }
<a name="l01873"></a>01873       }
<a name="l01874"></a>01874 
<a name="l01875"></a>01875       <span class="comment">/*---- check for auto restart --------------------------------*/</span>
<a name="l01876"></a>01876       <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> &gt; 0 &amp;&amp; <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>() &gt; <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a>)
<a name="l01877"></a>01877         {
<a name="l01878"></a>01878         <span class="comment">/* check if really stopped */</span>
<a name="l01879"></a>01879         size = <span class="keyword">sizeof</span>(state);
<a name="l01880"></a>01880         status = <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;Runinfo/State&quot;</span>, &amp;state, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01881"></a>01881         <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01882"></a>01882           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;cannot get Runinfo/State in database&quot;</span>);
<a name="l01883"></a>01883 
<a name="l01884"></a>01884         <span class="keywordflow">if</span> (state == <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>)
<a name="l01885"></a>01885           {
<a name="l01886"></a>01886           <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = 0;
<a name="l01887"></a>01887           size = <span class="keyword">sizeof</span>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l01888"></a>01888           <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/Run number&quot;</span>, &amp;<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01889"></a>01889 
<a name="l01890"></a>01890           <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;main&quot;</span>, <span class="stringliteral">&quot;starting new run&quot;</span>);
<a name="l01891"></a>01891           status = <a class="code" href="group__msectionh.html#ga98ba67d921647dab7eb4f00e5dea7ba0">cm_transition</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>+1, NULL, 0, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01892"></a>01892           <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01893"></a>01893             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;main&quot;</span>, <span class="stringliteral">&quot;cannot restart run&quot;</span>);
<a name="l01894"></a>01894           }
<a name="l01895"></a>01895         }
<a name="l01896"></a>01896 
<a name="l01897"></a>01897     <span class="comment">/*---- check network messages ----------------------------------*/</span>
<a name="l01898"></a>01898     <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a> &amp;&amp; interrupt_eq == NULL)
<a name="l01899"></a>01899       {
<a name="l01900"></a>01900 <span class="comment">//#ifndef PART_OF_MUCAP</span>
<a name="l01901"></a>01901       <span class="comment">/* only call yield once every 500ms when running */</span>
<a name="l01902"></a>01902       <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_network &gt; 500)
<a name="l01903"></a>01903 <span class="comment">//#else</span>
<a name="l01904"></a>01904 <span class="comment">//      /* only call yield once every 1 ms when running */</span>
<a name="l01905"></a>01905 <span class="comment">//      if (actual_millitime - last_time_network &gt; 0)</span>
<a name="l01906"></a>01906 <span class="comment">//        if(1)</span>
<a name="l01907"></a>01907 <span class="comment">//#endif</span>
<a name="l01908"></a>01908         {
<a name="l01909"></a>01909         status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(0);
<a name="l01910"></a>01910         last_time_network = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l01911"></a>01911         }
<a name="l01912"></a>01912       <span class="keywordflow">else</span>
<a name="l01913"></a>01913         status = <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>;
<a name="l01914"></a>01914       }
<a name="l01915"></a>01915     <span class="keywordflow">else</span>
<a name="l01916"></a>01916       <span class="comment">/* when run is stopped or interrupts used, </span>
<a name="l01917"></a>01917 <span class="comment">         call yield with 100ms timeout */</span>
<a name="l01918"></a>01918       status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(100);
<a name="l01919"></a>01919 
<a name="l01920"></a>01920     <span class="comment">/* exit for VxWorks */</span>
<a name="l01921"></a>01921     <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8432f49f703ed2d20248effc3125b0e1">fe_stop</a>)
<a name="l01922"></a>01922       status = <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l01923"></a>01923 
<a name="l01924"></a>01924     } <span class="keywordflow">while</span> (status != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> &amp;&amp; status != <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>);
<a name="l01925"></a>01925 
<a name="l01926"></a>01926 net_error:
<a name="l01927"></a>01927 
<a name="l01928"></a>01928   <span class="keywordflow">return</span> status;
<a name="l01929"></a>01929 }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01932"></a>01932 
<a name="l01933"></a>01933 <span class="preprocessor">#ifndef PART_OF_MUCAP</span>
<a name="l01934"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2e79e874780c7bf4355f940ac18c7bfa">01934</a> <span class="preprocessor"></span><a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2e79e874780c7bf4355f940ac18c7bfa">cnaf_callback</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <span class="keywordtype">void</span> *prpc_param[])
<a name="l01935"></a>01935 {
<a name="l01936"></a>01936 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, b, <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, a, f, *pdword, *<a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, *x, *q, dtemp;
<a name="l01937"></a>01937 <a class="code" href="unionWORD.html">WORD</a>  *pword, *pdata, <a class="code" href="scs__400_8c.html#aa9011d9cfe9fd83bd4d338d4912c4146">temp</a>;
<a name="l01938"></a>01938 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>   <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>;
<a name="l01939"></a>01939 
<a name="l01940"></a>01940   <span class="comment">/* Decode parameters */</span>
<a name="l01941"></a>01941   cmd    = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(0);
<a name="l01942"></a>01942   b      = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(1);
<a name="l01943"></a>01943   c      = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(2);
<a name="l01944"></a>01944   n      = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(3);
<a name="l01945"></a>01945   a      = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(4);
<a name="l01946"></a>01946   f      = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(5);
<a name="l01947"></a>01947   pdword = <a class="code" href="group__msectionh.html#gafff8900742914b9c11f421e66c8baa3b">CPDWORD</a>(6);
<a name="l01948"></a>01948   pword  = <a class="code" href="group__msectionh.html#ga68a6343add951d2d9ca99197eac42fd2">CPWORD</a>(6);
<a name="l01949"></a>01949   pdata  = <a class="code" href="group__msectionh.html#ga68a6343add951d2d9ca99197eac42fd2">CPWORD</a>(6);
<a name="l01950"></a>01950   size   = <a class="code" href="group__msectionh.html#gafff8900742914b9c11f421e66c8baa3b">CPDWORD</a>(7);
<a name="l01951"></a>01951   x      = <a class="code" href="group__msectionh.html#gafff8900742914b9c11f421e66c8baa3b">CPDWORD</a>(8);
<a name="l01952"></a>01952   q      = <a class="code" href="group__msectionh.html#gafff8900742914b9c11f421e66c8baa3b">CPDWORD</a>(9);
<a name="l01953"></a>01953 
<a name="l01954"></a>01954   <span class="comment">/* determine repeat count */</span>
<a name="l01955"></a>01955   <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#ga04139d1c129e9a87093587d16d8ac5a4">RPC_CNAF16</a>)
<a name="l01956"></a>01956     count = *size / <span class="keyword">sizeof</span>(<a class="code" href="unionWORD.html">WORD</a>);  <span class="comment">/* 16 bit */</span>
<a name="l01957"></a>01957   <span class="keywordflow">else</span>
<a name="l01958"></a>01958     count = *size / <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>); <span class="comment">/* 24 bit */</span>
<a name="l01959"></a>01959 
<a name="l01960"></a>01960   <span class="keywordflow">switch</span> (cmd)
<a name="l01961"></a>01961     {
<a name="l01962"></a>01962     <span class="comment">/*---- special commands ----*/</span>
<a name="l01963"></a>01963     
<a name="l01964"></a>01964     <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#ga5034a4dfe61df0821dd0841bae13033a">CNAF_INHIBIT_SET</a>: 
<a name="l01965"></a>01965       <a class="code" href="group__mcstdfunctionh.html#gaa171934ed8e8ce2af3ec97f4192aa27b">cam_inhibit_set</a>(c);
<a name="l01966"></a>01966       <span class="keywordflow">break</span>;
<a name="l01967"></a>01967     <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#gafe3467b124db26b5b10caf7f1633baed">CNAF_INHIBIT_CLEAR</a>:
<a name="l01968"></a>01968       <a class="code" href="group__mcstdfunctionh.html#gaaf50e8892fd5226754befa7185c9dc3a">cam_inhibit_clear</a>(c);
<a name="l01969"></a>01969       <span class="keywordflow">break</span>;
<a name="l01970"></a>01970     <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#gab5458177175ac7c1d62f96395e4b2f8f">CNAF_CRATE_CLEAR</a>:
<a name="l01971"></a>01971       <a class="code" href="group__mcstdfunctionh.html#ga9fb70c7c5fb16d3807373902b137fe3e">cam_crate_clear</a>(c);
<a name="l01972"></a>01972       <span class="keywordflow">break</span>;
<a name="l01973"></a>01973     <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#ga8ca71a69fac55838bc9bcc020f9edacf">CNAF_CRATE_ZINIT</a>:
<a name="l01974"></a>01974       <a class="code" href="group__mcstdfunctionh.html#ga476ffc902c4674e17aa3b544781023e4">cam_crate_zinit</a>(c);
<a name="l01975"></a>01975       <span class="keywordflow">break</span>;
<a name="l01976"></a>01976 
<a name="l01977"></a>01977     <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#ga6e256f90162b33b043f023b270ddfad9">CNAF_TEST</a>:
<a name="l01978"></a>01978       <span class="keywordflow">break</span>;
<a name="l01979"></a>01979 
<a name="l01980"></a>01980     <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#gaabc611f59210401f11ea4247291c4468">CNAF</a>:
<a name="l01981"></a>01981       <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#ga04139d1c129e9a87093587d16d8ac5a4">RPC_CNAF16</a>)
<a name="l01982"></a>01982         {
<a name="l01983"></a>01983         <span class="keywordflow">for</span> (i=0 ; i&lt;count ; i++)
<a name="l01984"></a>01984           <span class="keywordflow">if</span> (f&lt;16)
<a name="l01985"></a>01985             <a class="code" href="group__mcstdfunctionh.html#ga2a515796e8020af32ea0e5aad490a170">cam16i_q</a>(c, n, a, f, pword++, (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l01986"></a>01986           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f&lt;24)
<a name="l01987"></a>01987             <a class="code" href="group__mcstdfunctionh.html#ga971dc315017a5801f0131c4c2d396d28">cam16o_q</a>(c, n, a, f, pword[i], (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l01988"></a>01988           <span class="keywordflow">else</span>
<a name="l01989"></a>01989             <a class="code" href="group__mcstdfunctionh.html#ga2a515796e8020af32ea0e5aad490a170">cam16i_q</a>(c, n, a, f, &amp;temp, (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l01990"></a>01990         }
<a name="l01991"></a>01991       <span class="keywordflow">else</span>
<a name="l01992"></a>01992         {
<a name="l01993"></a>01993         <span class="keywordflow">for</span> (i=0 ; i&lt;count ; i++)
<a name="l01994"></a>01994           <span class="keywordflow">if</span> (f&lt;16)
<a name="l01995"></a>01995             <a class="code" href="group__mcstdfunctionh.html#ga0f1b4435d6f1fea0e5787a5c2388b41c">cam24i_q</a>(c, n, a, f, pdword++, (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l01996"></a>01996           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f&lt;24)
<a name="l01997"></a>01997             <a class="code" href="group__mcstdfunctionh.html#gaefe50b118a37b83b19a3804a6759d8bd">cam24o_q</a>(c, n, a, f, pdword[i], (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l01998"></a>01998           <span class="keywordflow">else</span>
<a name="l01999"></a>01999             <a class="code" href="group__mcstdfunctionh.html#ga0f1b4435d6f1fea0e5787a5c2388b41c">cam24i_q</a>(c, n, a, f, &amp;dtemp, (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l02000"></a>02000         }
<a name="l02001"></a>02001 
<a name="l02002"></a>02002       <span class="keywordflow">break</span>;
<a name="l02003"></a>02003 
<a name="l02004"></a>02004     <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#gad36f02a80cebab2bdfa9795db23ef333">CNAF_nQ</a>:
<a name="l02005"></a>02005       <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#ga04139d1c129e9a87093587d16d8ac5a4">RPC_CNAF16</a>)
<a name="l02006"></a>02006         {
<a name="l02007"></a>02007         <span class="keywordflow">if</span> (f&lt;16)
<a name="l02008"></a>02008           <a class="code" href="group__mcstdfunctionh.html#ga4a234b702b8b906b0cca1bcbdb01ca27">cam16i_rq</a>(c, n, a, f, (<a class="code" href="unionWORD.html">WORD</a> **) &amp;pdword, count);
<a name="l02009"></a>02009         }
<a name="l02010"></a>02010       <span class="keywordflow">else</span>
<a name="l02011"></a>02011         {
<a name="l02012"></a>02012         <span class="keywordflow">if</span> (f&lt;16)
<a name="l02013"></a>02013           <a class="code" href="group__mcstdfunctionh.html#ga6a2d5a0785b2ccc27fc9e2769f749b10">cam24i_rq</a>(c, n, a, f, &amp;pdword, count);
<a name="l02014"></a>02014         }
<a name="l02015"></a>02015 
<a name="l02016"></a>02016       <span class="comment">/* return reduced return size */</span>
<a name="l02017"></a>02017       *size = (int) pdword - (<span class="keywordtype">int</span>) pdata;
<a name="l02018"></a>02018       <span class="keywordflow">break</span>;
<a name="l02019"></a>02019 
<a name="l02020"></a>02020     <span class="keywordflow">default</span>:
<a name="l02021"></a>02021       printf(<span class="stringliteral">&quot;cnaf: Unknown command 0x%X\n&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)cmd);
<a name="l02022"></a>02022     }
<a name="l02023"></a>02023 
<a name="l02024"></a>02024   <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a>)
<a name="l02025"></a>02025     {
<a name="l02026"></a>02026     <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#ga04139d1c129e9a87093587d16d8ac5a4">RPC_CNAF16</a>)
<a name="l02027"></a>02027       printf(<span class="stringliteral">&quot;cmd=%d r=%d c=%d n=%d a=%d f=%d d=%X x=%d q=%d\n&quot;</span>,
<a name="l02028"></a>02028               (<span class="keywordtype">int</span>)cmd, (<span class="keywordtype">int</span>)count, (<span class="keywordtype">int</span>)c, (<span class="keywordtype">int</span>)n, (<span class="keywordtype">int</span>)a, (<span class="keywordtype">int</span>)f, (<span class="keywordtype">int</span>)pword[0], (<span class="keywordtype">int</span>)*x, (<span class="keywordtype">int</span>)*q);
<a name="l02029"></a>02029     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#gaf48c6e230ebd543627002769684a3240">RPC_CNAF24</a>)
<a name="l02030"></a>02030       printf(<span class="stringliteral">&quot;cmd=%d r=%d c=%d n=%d a=%d f=%d d=%X x=%d q=%d\n&quot;</span>,
<a name="l02031"></a>02031               (<span class="keywordtype">int</span>)cmd, (<span class="keywordtype">int</span>)count, (<span class="keywordtype">int</span>)c, (<span class="keywordtype">int</span>)n, (<span class="keywordtype">int</span>)a, (<span class="keywordtype">int</span>)f, (<span class="keywordtype">int</span>)pdword[0], (<span class="keywordtype">int</span>)*x, (<span class="keywordtype">int</span>)*q);
<a name="l02032"></a>02032     }
<a name="l02033"></a>02033 
<a name="l02034"></a>02034   <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>;
<a name="l02035"></a>02035 }
<a name="l02036"></a>02036 <span class="preprocessor">#endif</span>
<a name="l02037"></a>02037 <span class="preprocessor"></span><span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l02038"></a>02038 
<a name="l02039"></a>02039 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l02040"></a>02040 <span class="preprocessor"></span><span class="keywordtype">int</span> mfe(<span class="keywordtype">char</span> *ahost_name, <span class="keywordtype">char</span> *aexp_name, <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> adebug)
<a name="l02041"></a>02041 <span class="preprocessor">#else</span>
<a name="l02042"></a><a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a0ddf1224851353fc92bfbff6f499fa97">02042</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="mucap__compress_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l02043"></a>02043 <span class="preprocessor">#endif</span>
<a name="l02044"></a>02044 <span class="preprocessor"></span>{
<a name="l02045"></a>02045 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, dm_size;
<a name="l02046"></a>02046 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>  <a class="code" href="mana_8cpp.html#a96203468e98720f55cbede5bb1f8cffe">daemon</a>; 
<a name="l02047"></a>02047 
<a name="l02048"></a>02048   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[0] = 0;
<a name="l02049"></a>02049   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>[0] = 0;
<a name="l02050"></a>02050   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02051"></a>02051   daemon = 0;
<a name="l02052"></a>02052 
<a name="l02053"></a>02053   setbuf(stdout,0);
<a name="l02054"></a>02054   setbuf(stderr,0);
<a name="l02055"></a>02055 
<a name="l02056"></a>02056 <span class="preprocessor">#ifdef SIGPIPE</span>
<a name="l02057"></a>02057 <span class="preprocessor"></span>  signal(SIGPIPE,SIG_IGN);
<a name="l02058"></a>02058 <span class="preprocessor">#endif</span>
<a name="l02059"></a>02059 <span class="preprocessor"></span>
<a name="l02060"></a>02060 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l02061"></a>02061 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (ahost_name)
<a name="l02062"></a>02062     strcpy(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, ahost_name);
<a name="l02063"></a>02063   <span class="keywordflow">if</span> (aexp_name)
<a name="l02064"></a>02064     strcpy(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, aexp_name);
<a name="l02065"></a>02065   <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a> = adebug;
<a name="l02066"></a>02066 <span class="preprocessor">#else</span>
<a name="l02067"></a>02067 <span class="preprocessor"></span>
<a name="l02068"></a>02068   <span class="comment">/* get default from environment */</span>
<a name="l02069"></a>02069   <a class="code" href="patch__mevb_8cpp.html#aa598123f60ccd5496f2421c7bf2fabbf">cm_get_environment</a>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, <span class="keyword">sizeof</span>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>), <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <span class="keyword">sizeof</span>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>));
<a name="l02070"></a>02070   
<a name="l02071"></a>02071   <span class="comment">/* parse command line parameters */</span>
<a name="l02072"></a>02072   <span class="keywordflow">for</span> (i=1 ; i&lt;argc ; i++)
<a name="l02073"></a>02073     {
<a name="l02074"></a>02074     <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; argv[i][1] == <span class="charliteral">&apos;d&apos;</span>)
<a name="l02075"></a>02075       <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02076"></a>02076     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; argv[i][1] == <span class="charliteral">&apos;D&apos;</span>)
<a name="l02077"></a>02077       daemon = 1;
<a name="l02078"></a>02078     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; argv[i][1] == <span class="charliteral">&apos;O&apos;</span>)
<a name="l02079"></a>02079       daemon = 2;
<a name="l02080"></a>02080     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span>)
<a name="l02081"></a>02081       {
<a name="l02082"></a>02082       <span class="keywordflow">if</span> (i+1 &gt;= argc || argv[i+1][0] == <span class="charliteral">&apos;-&apos;</span>)
<a name="l02083"></a>02083         <span class="keywordflow">goto</span> <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>;
<a name="l02084"></a>02084       <span class="keywordflow">if</span> (argv[i][1] == <span class="charliteral">&apos;e&apos;</span>)
<a name="l02085"></a>02085         strcpy(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, argv[++i]);
<a name="l02086"></a>02086       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][1] == <span class="charliteral">&apos;h&apos;</span>)
<a name="l02087"></a>02087         strcpy(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, argv[++i]);
<a name="l02088"></a>02088       <span class="keywordflow">else</span>
<a name="l02089"></a>02089         {
<a name="l02090"></a>02090 <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>:
<a name="l02091"></a>02091         printf(<span class="stringliteral">&quot;usage: frontend [-h Hostname] [-e Experiment] [-d] [-D] [-O]\n&quot;</span>);
<a name="l02092"></a>02092         printf(<span class="stringliteral">&quot;         [-d]     Used to debug the frontend\n&quot;</span>);
<a name="l02093"></a>02093         printf(<span class="stringliteral">&quot;         [-D]     Become a daemon\n&quot;</span>);
<a name="l02094"></a>02094         printf(<span class="stringliteral">&quot;         [-O]     Become a daemon but keep stdout\n&quot;</span>);
<a name="l02095"></a>02095         <span class="keywordflow">return</span> 0;
<a name="l02096"></a>02096         }
<a name="l02097"></a>02097       }
<a name="l02098"></a>02098     }
<a name="l02099"></a>02099 <span class="preprocessor">#endif</span>
<a name="l02100"></a>02100 <span class="preprocessor"></span>
<a name="l02101"></a>02101 <span class="preprocessor">#ifdef PART_OF_MUCAP</span>
<a name="l02102"></a>02102 <span class="preprocessor"></span>  <a class="code" href="crate3_2crate_8cpp.html#aea5c34cabeee99adba19dad1031f8cf5">frontend_early_init</a>();
<a name="l02103"></a>02103 <span class="preprocessor">#endif</span>
<a name="l02104"></a>02104 <span class="preprocessor"></span>
<a name="l02105"></a>02105   <span class="comment">/* check event and buffer sizes */</span>
<a name="l02106"></a>02106   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a> &lt; 2*<a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>)
<a name="l02107"></a>02107     {
<a name="l02108"></a>02108     printf(<span class="stringliteral">&quot;event_buffer_size too small for max. event size\n&quot;</span>);
<a name="l02109"></a>02109     <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(5000);
<a name="l02110"></a>02110     <span class="keywordflow">return</span> 1;
<a name="l02111"></a>02111     }
<a name="l02112"></a>02112 
<a name="l02113"></a>02113   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> &gt; <a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>)
<a name="l02114"></a>02114     {
<a name="l02115"></a>02115     printf(<span class="stringliteral">&quot;Requested max_event_size (%d) exceeds max. system event size (%d)&quot;</span>, 
<a name="l02116"></a>02116             <a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>, <a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>);
<a name="l02117"></a>02117     <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(5000);
<a name="l02118"></a>02118     <span class="keywordflow">return</span> 1;
<a name="l02119"></a>02119     }
<a name="l02120"></a>02120   
<a name="l02121"></a>02121   dm_size = <a class="code" href="crate3_2crate_8cpp.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a>;
<a name="l02122"></a>02122 
<a name="l02123"></a>02123 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l02124"></a>02124 <span class="preprocessor"></span>  <span class="comment">/* override dm_size in case of VxWorks</span>
<a name="l02125"></a>02125 <span class="comment">     take remaining free memory and use 20% of it for dm_ */</span>
<a name="l02126"></a>02126   dm_size = 2*10*(<a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) + <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>));
<a name="l02127"></a>02127   <span class="keywordflow">if</span> (dm_size &gt; memFindMax())
<a name="l02128"></a>02128     {
<a name="l02129"></a>02129     <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>,<span class="stringliteral">&quot;mainFE&quot;</span>,<span class="stringliteral">&quot;Not enough mem space for event size&quot;</span>);
<a name="l02130"></a>02130     <span class="keywordflow">return</span> 0;
<a name="l02131"></a>02131     }
<a name="l02132"></a>02132   <span class="comment">/* takes overall 20% of the available memory resource for dm_() */</span>
<a name="l02133"></a>02133   dm_size = 0.2 * memFindMax(); 
<a name="l02134"></a>02134   
<a name="l02135"></a>02135   <span class="comment">/* there are two buffers */</span>
<a name="l02136"></a>02136   dm_size /= 2;
<a name="l02137"></a>02137 <span class="preprocessor">#endif</span>
<a name="l02138"></a>02138 <span class="preprocessor"></span>
<a name="l02139"></a>02139   <span class="comment">/* reduce memory size for MS-DOS */</span>
<a name="l02140"></a>02140 <span class="preprocessor">#ifdef OS_MSDOS</span>
<a name="l02141"></a>02141 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (dm_size &gt; 0x4000)
<a name="l02142"></a>02142     dm_size = 0x4000; <span class="comment">/* 16k */</span>
<a name="l02143"></a>02143 <span class="preprocessor">#endif</span>
<a name="l02144"></a>02144 <span class="preprocessor"></span>
<a name="l02145"></a>02145   <span class="comment">/* inform user of settings */</span>
<a name="l02146"></a>02146   printf(<span class="stringliteral">&quot;Event buffer size      :     %d\n&quot;</span>, <a class="code" href="crate3_2crate_8cpp.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a>);
<a name="l02147"></a>02147   printf(<span class="stringliteral">&quot;Buffer allocation      : 2 x %d\n&quot;</span>, dm_size);
<a name="l02148"></a>02148   printf(<span class="stringliteral">&quot;System max event size  :     %d\n&quot;</span>, <a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>);
<a name="l02149"></a>02149   printf(<span class="stringliteral">&quot;User max event size    :     %d\n&quot;</span>, <a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>);
<a name="l02150"></a>02150   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a> &gt; 0)
<a name="l02151"></a>02151     printf(<span class="stringliteral">&quot;User max frag. size    :     %d\n&quot;</span>, <a class="code" href="crate3_2crate_8cpp.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>);
<a name="l02152"></a>02152   printf(<span class="stringliteral">&quot;# of events per buffer :     %d\n\n&quot;</span>, dm_size/<a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>);
<a name="l02153"></a>02153 
<a name="l02154"></a>02154   <span class="keywordflow">if</span> (daemon)
<a name="l02155"></a>02155     {
<a name="l02156"></a>02156     printf(<span class="stringliteral">&quot;\nBecoming a daemon...\n&quot;</span>);
<a name="l02157"></a>02157     <a class="code" href="group__msystemincludecode.html#ga957613d29ce8b6e66f075ace4f32c1e1">ss_daemon_init</a>(daemon == 2);
<a name="l02158"></a>02158     }
<a name="l02159"></a>02159 
<a name="l02160"></a>02160   <span class="comment">/* now connect to server */</span>
<a name="l02161"></a>02161   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02162"></a>02162     {
<a name="l02163"></a>02163     <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[0])
<a name="l02164"></a>02164       printf(<span class="stringliteral">&quot;Connect to experiment %s on host %s...&quot;</span>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>);
<a name="l02165"></a>02165     <span class="keywordflow">else</span>
<a name="l02166"></a>02166       printf(<span class="stringliteral">&quot;Connect to experiment %s...&quot;</span>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>);
<a name="l02167"></a>02167     }
<a name="l02168"></a>02168 
<a name="l02169"></a>02169   status = <a class="code" href="group__msectionh.html#gae2c7dedc142d472208e2e67f920b91e2">cm_connect_experiment1</a>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <a class="code" href="crate3_2crate_8cpp.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>, 
<a name="l02170"></a>02170                                   NULL, <a class="code" href="group__midasincludecode.html#gac5b414ae3a2f854b099c08f5e63e8671">DEFAULT_ODB_SIZE</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a093e717ef9582e83efcc2550ef0c28cb">DEFAULT_FE_TIMEOUT</a>);
<a name="l02171"></a>02171   <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02172"></a>02172     {
<a name="l02173"></a>02173     <span class="comment">/* let user read message before window might close */</span>
<a name="l02174"></a>02174     <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(5000);
<a name="l02175"></a>02175     <span class="keywordflow">return</span> 1;
<a name="l02176"></a>02176     }
<a name="l02177"></a>02177 
<a name="l02178"></a>02178   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02179"></a>02179     printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l02180"></a>02180 
<a name="l02181"></a>02181   <span class="comment">/* book buffer space */</span>
<a name="l02182"></a>02182   status = <a class="code" href="group__msystemincludecode.html#ga48f58c3452ea2d1791ffff90fdb900ec">dm_buffer_create</a>(dm_size, <a class="code" href="crate3_2crate_8cpp.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>);
<a name="l02183"></a>02183   <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02184"></a>02184     {
<a name="l02185"></a>02185     printf(<span class="stringliteral">&quot;dm_buffer_create: Not enough memory or event too big\n&quot;</span>);
<a name="l02186"></a>02186     <span class="keywordflow">return</span> 1;
<a name="l02187"></a>02187     }
<a name="l02188"></a>02188 
<a name="l02189"></a>02189   <span class="comment">/* remomve any dead frontend */</span>
<a name="l02190"></a>02190   <a class="code" href="group__msectionh.html#ga2bb78358bf566eb83197810aee9c59b5">cm_cleanup</a>(<a class="code" href="crate3_2crate_8cpp.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l02191"></a>02191 
<a name="l02192"></a>02192   <span class="comment">/* shutdown previous frontend */</span>
<a name="l02193"></a>02193   status = <a class="code" href="group__msectionh.html#ga5c224ebc90480c8df5bc2a7dd81ff27c">cm_shutdown</a>(<a class="code" href="crate3_2crate_8cpp.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l02194"></a>02194   <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga76db0fac26b6f3dcdc29ec8b640c5a5f">CM_SHUTDOWN</a> &amp;&amp; <a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02195"></a>02195     {
<a name="l02196"></a>02196     printf(<span class="stringliteral">&quot;Previous frontend stopped\n&quot;</span>);
<a name="l02197"></a>02197     <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(1000);
<a name="l02198"></a>02198     }
<a name="l02199"></a>02199 
<a name="l02200"></a>02200   <span class="comment">/* register transition callbacks */</span>
<a name="l02201"></a>02201   <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a5ed14877e514f13eeb65a16898b2ba32">tr_start</a>) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l02202"></a>02202       <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(TR_PRESTART, <a class="code" href="patch__mevb_8cpp.html#a6e149fe266abfc4575be750a5ae1d3b0">tr_prestart</a>) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l02203"></a>02203       <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(TR_PRESTOP, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ab295972cdaac0046b6ca092aca0d1165">tr_prestop</a>) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l02204"></a>02204       <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(TR_PREPAUSE, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aaf7c57c78866ef0ad7268908a0d777d3">tr_prepause</a>) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l02205"></a>02205       <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">tr_resume</a>) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02206"></a>02206     {
<a name="l02207"></a>02207     printf(<span class="stringliteral">&quot;Failed to start local RPC server&quot;</span>);
<a name="l02208"></a>02208     <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l02209"></a>02209     <a class="code" href="group__msystemincludecode.html#ga5dfc452236b65b087dc387905dadab1d">dm_buffer_release</a>();
<a name="l02210"></a>02210 
<a name="l02211"></a>02211     <span class="comment">/* let user read message before window might close */</span>
<a name="l02212"></a>02212     <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(5000);
<a name="l02213"></a>02213     <span class="keywordflow">return</span> 1;
<a name="l02214"></a>02214     }
<a name="l02215"></a>02215 
<a name="l02216"></a>02216   <span class="comment">/* register CNAF callback */</span>
<a name="l02217"></a>02217 <span class="preprocessor">#ifndef PART_OF_MUCAP</span>
<a name="l02218"></a>02218 <span class="preprocessor"></span>  <a class="code" href="group__msectionh.html#gad3115b4913387a49fb131e5144509557">cm_register_function</a>(<a class="code" href="group__mrpcdefineh.html#ga04139d1c129e9a87093587d16d8ac5a4">RPC_CNAF16</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2e79e874780c7bf4355f940ac18c7bfa">cnaf_callback</a>); 
<a name="l02219"></a>02219   <a class="code" href="group__msectionh.html#gad3115b4913387a49fb131e5144509557">cm_register_function</a>(<a class="code" href="group__mrpcdefineh.html#gaf48c6e230ebd543627002769684a3240">RPC_CNAF24</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2e79e874780c7bf4355f940ac18c7bfa">cnaf_callback</a>); 
<a name="l02220"></a>02220 <span class="preprocessor">#endif</span>
<a name="l02221"></a>02221 <span class="preprocessor"></span>  <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, &amp;status);
<a name="l02222"></a>02222 
<a name="l02223"></a>02223   <span class="comment">/* set time from server */</span>
<a name="l02224"></a>02224 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l02225"></a>02225 <span class="preprocessor"></span>  <a class="code" href="group__msectionh.html#gac0ff174674256fa279e9701052cfc310">cm_synchronize</a>(NULL);
<a name="l02226"></a>02226 <span class="preprocessor">#endif</span>
<a name="l02227"></a>02227 <span class="preprocessor"></span>
<a name="l02228"></a>02228   <span class="comment">/* turn off watchdog if in debug mode */</span>
<a name="l02229"></a>02229   <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a>)
<a name="l02230"></a>02230     <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, 0);
<a name="l02231"></a>02231 
<a name="l02232"></a>02232   <span class="comment">/* increase RPC timeout to 2min for logger with exabyte or blocked disk */</span>
<a name="l02233"></a>02233   <a class="code" href="group__msectionh.html#ga3d863362443e54777f3e4033f1603980">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga9d274f0e5944be5b429d6c1bacfe1db0">RPC_OTIMEOUT</a>, 120000);
<a name="l02234"></a>02234 
<a name="l02235"></a>02235   <span class="comment">/* set own message print function */</span>
<a name="l02236"></a>02236   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02237"></a>02237     <a class="code" href="group__msectionh.html#gaf4589061aab20d351d901b6d2ccc0cc0">cm_set_msg_print</a>(<a class="code" href="group__mdefineh.html#ga3378bf6f53a24392145df33c8acc9c0c">MT_ALL</a>, <a class="code" href="group__mdefineh.html#ga3378bf6f53a24392145df33c8acc9c0c">MT_ALL</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4186dc25477a1b947c5d6ef64bcc4da0">message_print</a>);
<a name="l02238"></a>02238 
<a name="l02239"></a>02239   <span class="comment">/* call user init function */</span>
<a name="l02240"></a>02240   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02241"></a>02241     printf(<span class="stringliteral">&quot;Init hardware...&quot;</span>);
<a name="l02242"></a>02242   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a34c51ae8c88f4717087b0604975516f4">frontend_init</a>() != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02243"></a>02243     {
<a name="l02244"></a>02244     <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02245"></a>02245       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02246"></a>02246     <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l02247"></a>02247     <a class="code" href="group__msystemincludecode.html#ga5dfc452236b65b087dc387905dadab1d">dm_buffer_release</a>();
<a name="l02248"></a>02248 
<a name="l02249"></a>02249     <span class="comment">/* let user read message before window might close */</span>
<a name="l02250"></a>02250     <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(5000);
<a name="l02251"></a>02251     <span class="keywordflow">return</span> 1;
<a name="l02252"></a>02252     }
<a name="l02253"></a>02253 
<a name="l02254"></a>02254   <span class="comment">/* reqister equipment in ODB */</span>
<a name="l02255"></a>02255   <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ab834073e5b665fccaa4eff2a61bc9372">register_equipment</a>() != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l02256"></a>02256     {
<a name="l02257"></a>02257     <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02258"></a>02258       printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02259"></a>02259     <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l02260"></a>02260     <a class="code" href="group__msystemincludecode.html#ga5dfc452236b65b087dc387905dadab1d">dm_buffer_release</a>();
<a name="l02261"></a>02261 
<a name="l02262"></a>02262     <span class="comment">/* let user read message before window might close */</span>
<a name="l02263"></a>02263     <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(5000);
<a name="l02264"></a>02264     <span class="keywordflow">return</span> 1;
<a name="l02265"></a>02265     }
<a name="l02266"></a>02266 
<a name="l02267"></a>02267   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02268"></a>02268     printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l02269"></a>02269 
<a name="l02270"></a>02270   <span class="comment">/* initialize screen display */</span>
<a name="l02271"></a>02271   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02272"></a>02272     {
<a name="l02273"></a>02273     <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(1000);
<a name="l02274"></a>02274     <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02275"></a>02275     }
<a name="l02276"></a>02276 
<a name="l02277"></a>02277   <span class="comment">/* switch on interrupts if running */</span>
<a name="l02278"></a>02278   <span class="keywordflow">if</span> (interrupt_eq &amp;&amp; <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>)
<a name="l02279"></a>02279     <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02280"></a>02280 
<a name="l02281"></a>02281   <span class="comment">/* initialize ss_getchar */</span>
<a name="l02282"></a>02282   <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(0);
<a name="l02283"></a>02283 
<a name="l02284"></a>02284   <span class="comment">/* call main scheduler loop */</span>
<a name="l02285"></a>02285   status = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a94c9987508c91ae4827cc231f43b577e">scheduler</a>();
<a name="l02286"></a>02286 
<a name="l02287"></a>02287   <span class="comment">/* reset terminal */</span>
<a name="l02288"></a>02288   <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02289"></a>02289 
<a name="l02290"></a>02290   <span class="comment">/* switch off interrupts */</span>
<a name="l02291"></a>02291   <span class="keywordflow">if</span> (interrupt_eq)
<a name="l02292"></a>02292     {
<a name="l02293"></a>02293     <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="group__err26.html#gaa12884ae2e3cbffa489d7c5074a029f7">CMD_INTERRUPT_DISABLE</a>, 0, 0);
<a name="l02294"></a>02294     <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="group__err26.html#gae055008eb0238aaf491eda741abcd26d">CMD_INTERRUPT_DETACH</a>, 0, 0);
<a name="l02295"></a>02295     <span class="keywordflow">if</span> (interrupt_odb_buffer)
<a name="l02296"></a>02296       free(interrupt_odb_buffer);
<a name="l02297"></a>02297     }
<a name="l02298"></a>02298 
<a name="l02299"></a>02299   <span class="comment">/* detach interrupts */</span>
<a name="l02300"></a>02300   <span class="keywordflow">if</span> (interrupt_eq != NULL)
<a name="l02301"></a>02301     <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="group__err26.html#gae055008eb0238aaf491eda741abcd26d">CMD_INTERRUPT_DETACH</a>, interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#ga345e65d8874f6b968bedc00e76d4f431">source</a>, 0);
<a name="l02302"></a>02302 
<a name="l02303"></a>02303   <span class="comment">/* call user exit function */</span>
<a name="l02304"></a>02304   <a class="code" href="crate3_2crate_8cpp.html#a15271255cca6c92978b28afd5a548382">frontend_exit</a>();
<a name="l02305"></a>02305 
<a name="l02306"></a>02306   <span class="comment">/* close slow control drivers */</span>
<a name="l02307"></a>02307   <span class="keywordflow">for</span> (i=0 ; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0] ; i++)
<a name="l02308"></a>02308     <span class="keywordflow">if</span> ((equipment[i].info.eq_type &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) &amp;&amp;
<a name="l02309"></a>02309         equipment[i].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l02310"></a>02310       equipment[i].<a class="code" href="group__midasincludecode.html#gae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#gacfa1d482ab47b3ceebb9717007111649">CMD_EXIT</a>, &amp;equipment[i]);
<a name="l02311"></a>02311 
<a name="l02312"></a>02312   <span class="comment">/* close network connection to server */</span>
<a name="l02313"></a>02313   <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l02314"></a>02314 
<a name="l02315"></a>02315   <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02316"></a>02316     {
<a name="l02317"></a>02317     <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l02318"></a>02318       {
<a name="l02319"></a>02319       <a class="code" href="group__msectionh.html#ga8d56c0c36ceb913e9de1043fe5bc269e">ss_clear_screen</a>();
<a name="l02320"></a>02320       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 0, <span class="stringliteral">&quot;Frontend shut down.&quot;</span>);
<a name="l02321"></a>02321       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 1, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02322"></a>02322       }
<a name="l02323"></a>02323     }
<a name="l02324"></a>02324 
<a name="l02325"></a>02325   <span class="keywordflow">if</span> (status != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l02326"></a>02326     printf(<span class="stringliteral">&quot;Network connection aborted.\n&quot;</span>);
<a name="l02327"></a>02327 
<a name="l02328"></a>02328   <a class="code" href="group__msystemincludecode.html#ga5dfc452236b65b087dc387905dadab1d">dm_buffer_release</a>();
<a name="l02329"></a>02329 
<a name="l02330"></a>02330   <span class="keywordflow">return</span> 0;
<a name="l02331"></a>02331 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
