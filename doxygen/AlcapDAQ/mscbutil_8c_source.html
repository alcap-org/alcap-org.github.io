<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ: midas/mscb/embedded/mscbutil.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>midas/mscb/embedded/mscbutil.c</h1><a href="mscbutil_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Name:         mscbutil.c</span>
<a name="l00004"></a>00004 <span class="comment">  Created by:   Stefan Ritt</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Contents:     Various utility functions for MSCB protocol</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">  $Log: mscbutil.c,v $</span>
<a name="l00009"></a>00009 <span class="comment">  Revision 1.1.1.1  2005/06/20 23:37:17  mucap</span>
<a name="l00010"></a>00010 <span class="comment">  Importing release 1.9.5 of the MIDAS source code as distributed by PSI.</span>
<a name="l00011"></a>00011 <span class="comment">  (Next, I&apos;ll commit our local customizations.)</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment">  Revision 1.40  2004/09/25 01:14:54  midas</span>
<a name="l00014"></a>00014 <span class="comment">  Started implementing slave port on SCS-1000</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">  Revision 1.39  2004/09/10 12:32:50  midas</span>
<a name="l00017"></a>00017 <span class="comment">  *** empty log message ***</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">  Revision 1.38  2004/09/10 12:27:22  midas</span>
<a name="l00020"></a>00020 <span class="comment">  Version 1.7.5</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">  Revision 1.37  2004/07/21 14:18:55  midas</span>
<a name="l00023"></a>00023 <span class="comment">  Restructured timer usage</span>
<a name="l00024"></a>00024 <span class="comment"></span>
<a name="l00025"></a>00025 <span class="comment">  Revision 1.36  2004/07/20 16:04:40  midas</span>
<a name="l00026"></a>00026 <span class="comment">  Implemented scs-1000 code</span>
<a name="l00027"></a>00027 <span class="comment"></span>
<a name="l00028"></a>00028 <span class="comment">  Revision 1.35  2004/07/08 11:15:50  midas</span>
<a name="l00029"></a>00029 <span class="comment">  Implemented flash protection</span>
<a name="l00030"></a>00030 <span class="comment"></span>
<a name="l00031"></a>00031 <span class="comment">  Revision 1.34  2004/05/19 15:11:04  midas</span>
<a name="l00032"></a>00032 <span class="comment">  Avoid flashing directly after watchdog reset</span>
<a name="l00033"></a>00033 <span class="comment"></span>
<a name="l00034"></a>00034 <span class="comment">  Revision 1.33  2004/05/18 14:16:39  midas</span>
<a name="l00035"></a>00035 <span class="comment">  Do watchdog disable first in setup()</span>
<a name="l00036"></a>00036 <span class="comment"></span>
<a name="l00037"></a>00037 <span class="comment">  Revision 1.32  2004/04/30 08:01:41  midas</span>
<a name="l00038"></a>00038 <span class="comment">  led_mode starts now with led0</span>
<a name="l00039"></a>00039 <span class="comment"></span>
<a name="l00040"></a>00040 <span class="comment">  Revision 1.31  2004/04/07 11:06:17  midas</span>
<a name="l00041"></a>00041 <span class="comment">  Version 1.7.1</span>
<a name="l00042"></a>00042 <span class="comment"></span>
<a name="l00043"></a>00043 <span class="comment">  Revision 1.30  2004/03/19 08:15:29  midas</span>
<a name="l00044"></a>00044 <span class="comment">  Moved upgrade &amp; co to yield()</span>
<a name="l00045"></a>00045 <span class="comment"></span>
<a name="l00046"></a>00046 <span class="comment">  Revision 1.29  2004/03/04 14:35:45  midas</span>
<a name="l00047"></a>00047 <span class="comment">  Updated baud rate table</span>
<a name="l00048"></a>00048 <span class="comment"></span>
<a name="l00049"></a>00049 <span class="comment">  Revision 1.28  2004/02/24 13:30:21  midas</span>
<a name="l00050"></a>00050 <span class="comment">  Implemented C8051F310 code</span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">  Revision 1.27  2004/01/07 12:56:15  midas</span>
<a name="l00053"></a>00053 <span class="comment">  Chaned line length</span>
<a name="l00054"></a>00054 <span class="comment"></span>
<a name="l00055"></a>00055 <span class="comment">  Revision 1.26  2004/01/07 12:52:23  midas</span>
<a name="l00056"></a>00056 <span class="comment">  Changed indentation</span>
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 <span class="comment">  Revision 1.25  2003/09/23 09:21:17  midas</span>
<a name="l00059"></a>00059 <span class="comment">  *** empty log message ***</span>
<a name="l00060"></a>00060 <span class="comment"></span>
<a name="l00061"></a>00061 <span class="comment">  Revision 1.24  2003/06/27 13:52:17  midas</span>
<a name="l00062"></a>00062 <span class="comment">  Added led_mode()</span>
<a name="l00063"></a>00063 <span class="comment"></span>
<a name="l00064"></a>00064 <span class="comment">  Revision 1.23  2003/03/24 15:00:31  midas</span>
<a name="l00065"></a>00065 <span class="comment">  Implemented 16-bit magic at end of EEPROM data</span>
<a name="l00066"></a>00066 <span class="comment"></span>
<a name="l00067"></a>00067 <span class="comment">  Revision 1.22  2003/03/23 10:20:43  midas</span>
<a name="l00068"></a>00068 <span class="comment">  Added LCD_SUPPORT flag</span>
<a name="l00069"></a>00069 <span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">  Revision 1.21  2003/03/19 16:35:03  midas</span>
<a name="l00071"></a>00071 <span class="comment">  Eliminated configuration parameters</span>
<a name="l00072"></a>00072 <span class="comment"></span>
<a name="l00073"></a>00073 <span class="comment">  Revision 1.20  2003/03/14 13:47:54  midas</span>
<a name="l00074"></a>00074 <span class="comment">  Added SCS_310 code</span>
<a name="l00075"></a>00075 <span class="comment"></span>
<a name="l00076"></a>00076 <span class="comment">  Revision 1.19  2003/03/06 11:01:13  midas</span>
<a name="l00077"></a>00077 <span class="comment">  Priority inversion for slow ADuC</span>
<a name="l00078"></a>00078 <span class="comment"></span>
<a name="l00079"></a>00079 <span class="comment">  Revision 1.18  2003/02/20 13:11:58  midas</span>
<a name="l00080"></a>00080 <span class="comment">  Re-init clock value on sysclock_init()</span>
<a name="l00081"></a>00081 <span class="comment"></span>
<a name="l00082"></a>00082 <span class="comment">  Revision 1.17  2003/02/19 16:04:56  midas</span>
<a name="l00083"></a>00083 <span class="comment">  Added code for ADuC812</span>
<a name="l00084"></a>00084 <span class="comment"></span>
<a name="l00085"></a>00085 <span class="comment">  Revision 1.16  2003/01/30 08:40:02  midas</span>
<a name="l00086"></a>00086 <span class="comment">  Use USE_WATCHDOG flag</span>
<a name="l00087"></a>00087 <span class="comment"></span>
<a name="l00088"></a>00088 <span class="comment">  Revision 1.15  2002/11/20 12:02:39  midas</span>
<a name="l00089"></a>00089 <span class="comment">  Fixed bug with secondary LED</span>
<a name="l00090"></a>00090 <span class="comment"></span>
<a name="l00091"></a>00091 <span class="comment">  Revision 1.14  2002/11/06 16:45:42  midas</span>
<a name="l00092"></a>00092 <span class="comment">  Revised LED blinking scheme</span>
<a name="l00093"></a>00093 <span class="comment"></span>
<a name="l00094"></a>00094 <span class="comment">  Revision 1.13  2002/10/16 15:28:25  midas</span>
<a name="l00095"></a>00095 <span class="comment">  Fixed typo</span>
<a name="l00096"></a>00096 <span class="comment"></span>
<a name="l00097"></a>00097 <span class="comment">  Revision 1.12  2002/10/09 15:48:13  midas</span>
<a name="l00098"></a>00098 <span class="comment">  Fixed bug with download</span>
<a name="l00099"></a>00099 <span class="comment"></span>
<a name="l00100"></a>00100 <span class="comment">  Revision 1.11  2002/10/09 11:06:46  midas</span>
<a name="l00101"></a>00101 <span class="comment">  Protocol version 1.1</span>
<a name="l00102"></a>00102 <span class="comment"></span>
<a name="l00103"></a>00103 <span class="comment">  Revision 1.10  2002/10/07 15:16:32  midas</span>
<a name="l00104"></a>00104 <span class="comment">  Added upgrade facility</span>
<a name="l00105"></a>00105 <span class="comment"></span>
<a name="l00106"></a>00106 <span class="comment">  Revision 1.9  2002/10/04 09:03:20  midas</span>
<a name="l00107"></a>00107 <span class="comment">  Small mods for scs_300</span>
<a name="l00108"></a>00108 <span class="comment"></span>
<a name="l00109"></a>00109 <span class="comment">  Revision 1.8  2002/10/03 15:31:53  midas</span>
<a name="l00110"></a>00110 <span class="comment">  Various modifications</span>
<a name="l00111"></a>00111 <span class="comment"></span>
<a name="l00112"></a>00112 <span class="comment">  Revision 1.7  2002/08/08 06:46:15  midas</span>
<a name="l00113"></a>00113 <span class="comment">  Added time functions</span>
<a name="l00114"></a>00114 <span class="comment"></span>
<a name="l00115"></a>00115 <span class="comment">  Revision 1.6  2002/07/12 08:38:13  midas</span>
<a name="l00116"></a>00116 <span class="comment">  Fixed LCD recognition</span>
<a name="l00117"></a>00117 <span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">  Revision 1.5  2002/07/10 09:52:55  midas</span>
<a name="l00119"></a>00119 <span class="comment">  Finished EEPROM routines</span>
<a name="l00120"></a>00120 <span class="comment"></span>
<a name="l00121"></a>00121 <span class="comment">  Revision 1.4  2002/07/09 15:31:32  midas</span>
<a name="l00122"></a>00122 <span class="comment">  Initial Revision</span>
<a name="l00123"></a>00123 <span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment">  Revision 1.3  2002/07/08 08:51:05  midas</span>
<a name="l00125"></a>00125 <span class="comment">  Wrote eeprom functions</span>
<a name="l00126"></a>00126 <span class="comment"></span>
<a name="l00127"></a>00127 <span class="comment">  Revision 1.2  2002/07/05 15:27:39  midas</span>
<a name="l00128"></a>00128 <span class="comment">  Initial revision</span>
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="comment">  Revision 1.1  2002/07/05 08:12:46  midas</span>
<a name="l00131"></a>00131 <span class="comment">  Moved files</span>
<a name="l00132"></a>00132 <span class="comment"></span>
<a name="l00133"></a>00133 <span class="comment">\********************************************************************/</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="preprocessor">#include &quot;<a class="code" href="mscb_8h.html">mscb.h</a>&quot;</span>
<a name="l00136"></a>00136 <span class="preprocessor">#include &lt;intrins.h&gt;</span>
<a name="l00137"></a>00137 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="preprocessor">#ifdef EEPROM_SUPPORT</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>
<a name="l00141"></a>00141 <span class="keyword">extern</span> <a class="code" href="structSYS__INFO.html">SYS_INFO</a> <a class="code" href="hvr__200_8c.html#abf06fefcfd184511a38e909e5a4111c0">sys_info</a>;               <span class="comment">// for eeprom functions</span>
<a name="l00142"></a>00142 <span class="keyword">extern</span> <a class="code" href="structMSCB__INFO__VAR.html">MSCB_INFO_VAR</a> code <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[];
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="preprocessor">#endif</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>
<a name="l00146"></a>00146 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> idata <a class="code" href="hvr__200_8c.html#a7aa4e7d188b6702a7e5e361e85731948">_n_sub_addr</a>, <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>, <a class="code" href="mscbmain_8c.html#aab1037491179d86a89ac750947c0b1f1">_flkey</a>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="preprocessor">#pragma NOAREGS                 // all functions can be called from interrupt routine!</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>
<a name="l00150"></a>00150 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="mscbutil_8c.html#abf3e3406ecd519b9c4e49514602ed160">00152</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> code <a class="code" href="mscbutil_8c.html#abf3e3406ecd519b9c4e49514602ed160">crc8_data</a>[] = {
<a name="l00153"></a>00153    0x00, 0x5e, 0xbc, 0xe2, 0x61, 0x3f, 0xdd, 0x83,
<a name="l00154"></a>00154    0xc2, 0x9c, 0x7e, 0x20, 0xa3, 0xfd, 0x1f, 0x41,
<a name="l00155"></a>00155    0x9d, 0xc3, 0x21, 0x7f, 0xfc, 0xa2, 0x40, 0x1e,
<a name="l00156"></a>00156    0x5f, 0x01, 0xe3, 0xbd, 0x3e, 0x60, 0x82, 0xdc,
<a name="l00157"></a>00157    0x23, 0x7d, 0x9f, 0xc1, 0x42, 0x1c, 0xfe, 0xa0,
<a name="l00158"></a>00158    0xe1, 0xbf, 0x5d, 0x03, 0x80, 0xde, 0x3c, 0x62,
<a name="l00159"></a>00159    0xbe, 0xe0, 0x02, 0x5c, 0xdf, 0x81, 0x63, 0x3d,
<a name="l00160"></a>00160    0x7c, 0x22, 0xc0, 0x9e, 0x1d, 0x43, 0xa1, 0xff,
<a name="l00161"></a>00161    0x46, 0x18, 0xfa, 0xa4, 0x27, 0x79, 0x9b, 0xc5,
<a name="l00162"></a>00162    0x84, 0xda, 0x38, 0x66, 0xe5, 0xbb, 0x59, 0x07,
<a name="l00163"></a>00163    0xdb, 0x85, 0x67, 0x39, 0xba, 0xe4, 0x06, 0x58,
<a name="l00164"></a>00164    0x19, 0x47, 0xa5, 0xfb, 0x78, 0x26, 0xc4, 0x9a,
<a name="l00165"></a>00165    0x65, 0x3b, 0xd9, 0x87, 0x04, 0x5a, 0xb8, 0xe6,
<a name="l00166"></a>00166    0xa7, 0xf9, 0x1b, 0x45, 0xc6, 0x98, 0x7a, 0x24,
<a name="l00167"></a>00167    0xf8, 0xa6, 0x44, 0x1a, 0x99, 0xc7, 0x25, 0x7b,
<a name="l00168"></a>00168    0x3a, 0x64, 0x86, 0xd8, 0x5b, 0x05, 0xe7, 0xb9,
<a name="l00169"></a>00169    0x8c, 0xd2, 0x30, 0x6e, 0xed, 0xb3, 0x51, 0x0f,
<a name="l00170"></a>00170    0x4e, 0x10, 0xf2, 0xac, 0x2f, 0x71, 0x93, 0xcd,
<a name="l00171"></a>00171    0x11, 0x4f, 0xad, 0xf3, 0x70, 0x2e, 0xcc, 0x92,
<a name="l00172"></a>00172    0xd3, 0x8d, 0x6f, 0x31, 0xb2, 0xec, 0x0e, 0x50,
<a name="l00173"></a>00173    0xaf, 0xf1, 0x13, 0x4d, 0xce, 0x90, 0x72, 0x2c,
<a name="l00174"></a>00174    0x6d, 0x33, 0xd1, 0x8f, 0x0c, 0x52, 0xb0, 0xee,
<a name="l00175"></a>00175    0x32, 0x6c, 0x8e, 0xd0, 0x53, 0x0d, 0xef, 0xb1,
<a name="l00176"></a>00176    0xf0, 0xae, 0x4c, 0x12, 0x91, 0xcf, 0x2d, 0x73,
<a name="l00177"></a>00177    0xca, 0x94, 0x76, 0x28, 0xab, 0xf5, 0x17, 0x49,
<a name="l00178"></a>00178    0x08, 0x56, 0xb4, 0xea, 0x69, 0x37, 0xd5, 0x8b,
<a name="l00179"></a>00179    0x57, 0x09, 0xeb, 0xb5, 0x36, 0x68, 0x8a, 0xd4,
<a name="l00180"></a>00180    0x95, 0xcb, 0x29, 0x77, 0xf4, 0xaa, 0x48, 0x16,
<a name="l00181"></a>00181    0xe9, 0xb7, 0x55, 0x0b, 0x88, 0xd6, 0x34, 0x6a,
<a name="l00182"></a>00182    0x2b, 0x75, 0x97, 0xc9, 0x4a, 0x14, 0xf6, 0xa8,
<a name="l00183"></a>00183    0x74, 0x2a, 0xc8, 0x96, 0x15, 0x4b, 0xa9, 0xf7,
<a name="l00184"></a>00184    0xb6, 0xe8, 0x0a, 0x54, 0xd7, 0x89, 0x6b, 0x35,
<a name="l00185"></a>00185 };
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="mscbutil_8c.html#a92317b8fbef36cb36421636cd1287520">00187</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>, <span class="keywordtype">int</span> len) reentrant
<a name="l00188"></a>00188 <span class="comment">/********************************************************************\</span>
<a name="l00189"></a>00189 <span class="comment"></span>
<a name="l00190"></a>00190 <span class="comment">  Routine: crc8</span>
<a name="l00191"></a>00191 <span class="comment"></span>
<a name="l00192"></a>00192 <span class="comment">  Purpose: Calculate 8-bit cyclic redundancy checksum for a full</span>
<a name="l00193"></a>00193 <span class="comment">           buffer</span>
<a name="l00194"></a>00194 <span class="comment"></span>
<a name="l00195"></a>00195 <span class="comment">  Input:</span>
<a name="l00196"></a>00196 <span class="comment">    unsigned char *data     data buffer</span>
<a name="l00197"></a>00197 <span class="comment">    int len                 data length in bytes</span>
<a name="l00198"></a>00198 <span class="comment"></span>
<a name="l00199"></a>00199 <span class="comment"></span>
<a name="l00200"></a>00200 <span class="comment">  Function value:</span>
<a name="l00201"></a>00201 <span class="comment">    unsighend char          CRC-8 code</span>
<a name="l00202"></a>00202 <span class="comment"></span>
<a name="l00203"></a>00203 <span class="comment">\********************************************************************/</span>
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00206"></a>00206    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> crc8_code, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208    crc8_code = 0;
<a name="l00209"></a>00209    <span class="keywordflow">for</span> (i = 0; i &lt; len; i++) {
<a name="l00210"></a>00210       index = <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>[i] ^ crc8_code;
<a name="l00211"></a>00211       crc8_code = <a class="code" href="mscbutil_8c.html#abf3e3406ecd519b9c4e49514602ed160">crc8_data</a>[index];
<a name="l00212"></a>00212    }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214    <span class="keywordflow">return</span> crc8_code;
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00217"></a><a class="code" href="mscbutil_8c.html#a06722ba2c1a909418c287f36da918b20">00217</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="embedded_2mscb_8h.html#a06722ba2c1a909418c287f36da918b20">crc8_add</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> crc, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>)
<a name="l00218"></a>00218 <span class="comment">/********************************************************************\</span>
<a name="l00219"></a>00219 <span class="comment"></span>
<a name="l00220"></a>00220 <span class="comment">  Routine: crc8_add</span>
<a name="l00221"></a>00221 <span class="comment"></span>
<a name="l00222"></a>00222 <span class="comment">  Purpose: Single calculation for 8-bit cyclic redundancy checksum</span>
<a name="l00223"></a>00223 <span class="comment"></span>
<a name="l00224"></a>00224 <span class="comment">  Input:</span>
<a name="l00225"></a>00225 <span class="comment">    unsigned char crc       running crc</span>
<a name="l00226"></a>00226 <span class="comment">    unsigned char c         new character</span>
<a name="l00227"></a>00227 <span class="comment"></span>
<a name="l00228"></a>00228 <span class="comment"></span>
<a name="l00229"></a>00229 <span class="comment">  Function value:</span>
<a name="l00230"></a>00230 <span class="comment">    unsighend char          CRC-8 code</span>
<a name="l00231"></a>00231 <span class="comment"></span>
<a name="l00232"></a>00232 <span class="comment">\********************************************************************/</span>
<a name="l00233"></a>00233 {
<a name="l00234"></a>00234    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236    index = c ^ crc;
<a name="l00237"></a>00237    <span class="keywordflow">return</span> <a class="code" href="mscbutil_8c.html#abf3e3406ecd519b9c4e49514602ed160">crc8_data</a>[index];
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="preprocessor">#ifdef SCS_210 // SCS_210 uses UAR0 &amp; UART1</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span>
<a name="l00244"></a>00244 bit ti1_shadow = 1;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="keywordtype">char</span> xdata rbuf[1024];
<a name="l00247"></a>00247 <span class="keywordtype">char</span> xdata sbuf[1024];
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> xdata *<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a> <a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a> = rbuf;
<a name="l00250"></a>00250 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> xdata *<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a> <a class="code" href="subm__300_8c.html#a48ebfdb26b0285a03a433244bb9b9f57">rbuf_wp</a> = rbuf;
<a name="l00251"></a>00251 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> xdata *<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a> sbuf_rp = sbuf;
<a name="l00252"></a>00252 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> xdata *<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a> sbuf_wp = sbuf;
<a name="l00253"></a>00253                          
<a name="l00254"></a>00254 <span class="comment">/*---- UART1 handling ----------------------------------------------*/</span>
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="keywordtype">void</span> serial_int1(<span class="keywordtype">void</span>) interrupt 20 using 2
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258    <span class="keywordflow">if</span> (<a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp; 0x02) {          <span class="comment">// TI1</span>
<a name="l00259"></a>00259       <span class="comment">/* character has been transferred */</span>
<a name="l00260"></a>00260       <a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp;= ~0x02;           <span class="comment">// clear TI flag</span>
<a name="l00261"></a>00261       ti1_shadow = 1;
<a name="l00262"></a>00262    }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264    <span class="keywordflow">if</span> (<a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp; 0x01) {          <span class="comment">// RI1</span>
<a name="l00265"></a>00265       <span class="comment">/* check for buffer overflow */</span>
<a name="l00266"></a>00266       <span class="keywordflow">if</span> (<a class="code" href="subm__300_8c.html#a48ebfdb26b0285a03a433244bb9b9f57">rbuf_wp</a> + 1 == <a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a>) {
<a name="l00267"></a>00267          <a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp;= ~0x01;        <span class="comment">// clear RI flag</span>
<a name="l00268"></a>00268          <span class="keywordflow">return</span>;
<a name="l00269"></a>00269       }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271       <span class="comment">/* character has been received */</span>
<a name="l00272"></a>00272       *<a class="code" href="subm__300_8c.html#a48ebfdb26b0285a03a433244bb9b9f57">rbuf_wp</a>++ = <a class="code" href="c8051F020_8h.html#a1be6fd48fba2f8c347332385fbeed308">SBUF1</a>;
<a name="l00273"></a>00273       <span class="keywordflow">if</span> (<a class="code" href="subm__300_8c.html#a48ebfdb26b0285a03a433244bb9b9f57">rbuf_wp</a> == rbuf + <span class="keyword">sizeof</span>(rbuf))
<a name="l00274"></a>00274          <a class="code" href="subm__300_8c.html#a48ebfdb26b0285a03a433244bb9b9f57">rbuf_wp</a> = rbuf;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276       <a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp;= ~0x01;           <span class="comment">// clear RI flag</span>
<a name="l00277"></a>00277 
<a name="l00278"></a>00278       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(1, 1, 100);
<a name="l00279"></a>00279    }
<a name="l00280"></a>00280 }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a179877b003d63996470f7b628a57eeac">rs232_output</a>(<span class="keywordtype">void</span>)
<a name="l00285"></a>00285 <span class="comment">/* check RS232 output buffer to send data */</span>
<a name="l00286"></a>00286 {
<a name="l00287"></a>00287    <span class="keywordflow">if</span> (sbuf_wp != sbuf_rp &amp;&amp; ti1_shadow == 1) {
<a name="l00288"></a>00288       ti1_shadow = 0;
<a name="l00289"></a>00289       <a class="code" href="c8051F020_8h.html#a1be6fd48fba2f8c347332385fbeed308">SBUF1</a> = *sbuf_rp++;
<a name="l00290"></a>00290       <span class="keywordflow">if</span> (sbuf_rp == sbuf + <span class="keyword">sizeof</span>(sbuf))
<a name="l00291"></a>00291          sbuf_rp = sbuf;
<a name="l00292"></a>00292    }
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 <span class="keywordtype">char</span> getchar(<span class="keywordtype">void</span>)
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299    <span class="keywordtype">char</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301    <span class="keywordflow">do</span> {
<a name="l00302"></a>00302       <span class="keywordflow">if</span> (<a class="code" href="subm__300_8c.html#a48ebfdb26b0285a03a433244bb9b9f57">rbuf_wp</a> != <a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a>) {
<a name="l00303"></a>00303          c = *<a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a>++;
<a name="l00304"></a>00304          <span class="keywordflow">if</span> (<a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a> == rbuf + <span class="keyword">sizeof</span>(rbuf))
<a name="l00305"></a>00305             <a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a> = rbuf;
<a name="l00306"></a>00306 
<a name="l00307"></a>00307          <span class="keywordflow">if</span> (c == <span class="charliteral">&apos;\r&apos;</span>)         <span class="comment">/* make gets() happy */</span>
<a name="l00308"></a>00308             <span class="keywordflow">return</span> <span class="charliteral">&apos;\n&apos;</span>;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310          <span class="keywordflow">return</span> c;
<a name="l00311"></a>00311       }
<a name="l00312"></a>00312       <a class="code" href="embedded_2mscb_8h.html#a7cb51f5c2b5cad3766f19eb69c92793b">yield</a>();
<a name="l00313"></a>00313    } <span class="keywordflow">while</span> (1);
<a name="l00314"></a>00314 }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 <span class="keywordtype">char</span> <a class="code" href="embedded_2mscb_8h.html#a068ffb5f8f5e993bc4a368007e73be38">getchar_nowait</a>(<span class="keywordtype">void</span>)
<a name="l00319"></a>00319 {
<a name="l00320"></a>00320    <span class="keywordtype">char</span> c;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322    <span class="keywordflow">if</span> (<a class="code" href="subm__300_8c.html#a48ebfdb26b0285a03a433244bb9b9f57">rbuf_wp</a> != <a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a>) {
<a name="l00323"></a>00323       c = *<a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a>++;
<a name="l00324"></a>00324       <span class="keywordflow">if</span> (<a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a> == rbuf + <span class="keyword">sizeof</span>(rbuf))
<a name="l00325"></a>00325          <a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a> = rbuf;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327       <span class="keywordflow">return</span> c;
<a name="l00328"></a>00328    }
<a name="l00329"></a>00329    <span class="keywordflow">return</span> -1;
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="embedded_2mscb_8h.html#a7901a7b6894714276aae0dc0433d60de">gets_wait</a>(<span class="keywordtype">char</span> *<a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="getHist_8cpp.html#a654210ae605a61110cf5a8a0c9f2d72c">timeout</a>)
<a name="l00335"></a>00335 {
<a name="l00336"></a>00336    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> start;
<a name="l00337"></a>00337    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00338"></a>00338    <span class="keywordtype">char</span> c;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340    start = <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>();
<a name="l00341"></a>00341    i = 0;
<a name="l00342"></a>00342    <span class="keywordflow">do</span> {
<a name="l00343"></a>00343       c = <a class="code" href="embedded_2mscb_8h.html#a068ffb5f8f5e993bc4a368007e73be38">getchar_nowait</a>();
<a name="l00344"></a>00344       <span class="keywordflow">if</span> (c != -1 &amp;&amp; c != <span class="charliteral">&apos;\n&apos;</span>) {
<a name="l00345"></a>00345          <span class="keywordflow">if</span> (c == <span class="charliteral">&apos;\r&apos;</span>) {
<a name="l00346"></a>00346             str[i] = 0;
<a name="l00347"></a>00347             <span class="keywordflow">return</span> i;
<a name="l00348"></a>00348          }
<a name="l00349"></a>00349          str[i++] = c;
<a name="l00350"></a>00350          <span class="keywordflow">if</span> (i == size)
<a name="l00351"></a>00351             <span class="keywordflow">return</span> i;
<a name="l00352"></a>00352       }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354       <a class="code" href="embedded_2mscb_8h.html#a7cb51f5c2b5cad3766f19eb69c92793b">yield</a>();
<a name="l00355"></a>00355    } <span class="keywordflow">while</span> (<a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>() &lt; start + timeout);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357    <span class="keywordflow">return</span> 0;
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="keywordtype">char</span> <a class="code" href="mscbutil_8c.html#a44a1bacb4c1429ca87f81505dea70451">putchar</a>(<span class="keywordtype">char</span> c)
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364    <span class="comment">/* check if buffer overflow */</span>
<a name="l00365"></a>00365    <span class="keywordflow">if</span> (sbuf_wp + 1 == sbuf_rp)
<a name="l00366"></a>00366       <span class="keywordflow">return</span> c;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368    *sbuf_wp++ = c;
<a name="l00369"></a>00369    <span class="keywordflow">if</span> (sbuf_wp == sbuf + <span class="keyword">sizeof</span>(sbuf))
<a name="l00370"></a>00370       sbuf_wp = sbuf;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372    <span class="keywordflow">return</span> c;
<a name="l00373"></a>00373 }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a0a9e9396972b76c5947592479860020d">flush</a>(<span class="keywordtype">void</span>)
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379    <span class="keywordflow">while</span> (sbuf_wp != sbuf_rp)
<a name="l00380"></a>00380       <a class="code" href="mscbmain_8c.html#a179877b003d63996470f7b628a57eeac">rs232_output</a>();
<a name="l00381"></a>00381 }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 <span class="keywordtype">void</span> uart1_init_buffer()
<a name="l00386"></a>00386 {
<a name="l00387"></a>00387    <a class="code" href="subm__300_8c.html#ab2893d293848ee68eb63cd8269c9f6d6">rbuf_rp</a> = <a class="code" href="subm__300_8c.html#a48ebfdb26b0285a03a433244bb9b9f57">rbuf_wp</a> = rbuf;
<a name="l00388"></a>00388    sbuf_rp = sbuf_wp = sbuf;
<a name="l00389"></a>00389    
<a name="l00390"></a>00390    ti1_shadow = 1;
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="preprocessor">#elif defined(SCS_1000)  // SCS_1000 uses UAR0 &amp; UART1</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>
<a name="l00397"></a>00397 bit ti1_shadow = 1;
<a name="l00398"></a>00398 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> n_recv;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 <span class="keywordtype">char</span> xdata rbuf[64];
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 <span class="comment">/*---- UART1 handling ----------------------------------------------*/</span>
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="keywordtype">void</span> serial_int1(<span class="keywordtype">void</span>) interrupt 20 using 2
<a name="l00405"></a>00405 {
<a name="l00406"></a>00406    <span class="keywordflow">if</span> (<a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp; 0x02) {          <span class="comment">// TI1</span>
<a name="l00407"></a>00407       <span class="comment">/* character has been transferred */</span>
<a name="l00408"></a>00408       <a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp;= ~0x02;           <span class="comment">// clear TI flag</span>
<a name="l00409"></a>00409       ti1_shadow = 1;
<a name="l00410"></a>00410    }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412    <span class="keywordflow">if</span> (<a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp; 0x01) {          <span class="comment">// RI1</span>
<a name="l00413"></a>00413       <span class="comment">/* check for buffer overflow */</span>
<a name="l00414"></a>00414       <span class="keywordflow">if</span> (n_recv + 1 == <span class="keyword">sizeof</span>(rbuf)) {
<a name="l00415"></a>00415          <a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp;= ~0x01;        <span class="comment">// clear RI flag</span>
<a name="l00416"></a>00416          <span class="keywordflow">return</span>;
<a name="l00417"></a>00417       }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419       <span class="comment">/* character has been received */</span>
<a name="l00420"></a>00420       rbuf[n_recv++] = <a class="code" href="c8051F020_8h.html#a1be6fd48fba2f8c347332385fbeed308">SBUF1</a>;
<a name="l00421"></a>00421       <a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> &amp;= ~0x01;           <span class="comment">// clear RI flag</span>
<a name="l00422"></a>00422 
<a name="l00423"></a>00423       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(1, 1, 100);
<a name="l00424"></a>00424    }
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 <span class="preprocessor">#ifdef SCS_1000</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span>
<a name="l00431"></a>00431 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="embedded_2mscb_8h.html#a3d21cc4f902935e980ffe05793d216ad">uart1_send</a>(<span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>, <span class="keywordtype">int</span> size)
<a name="l00432"></a>00432 {
<a name="l00433"></a>00433 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435    <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a060ad197c4fa8f45488806c35ba3bc3b">UART1_PAGE</a>;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437    RS485_SEC_ENABLE = 1;
<a name="l00438"></a>00438    <span class="keywordflow">for</span> (i=0 ; i&lt;size ; i++) {
<a name="l00439"></a>00439 
<a name="l00440"></a>00440       ti1_shadow = 0;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442       <a class="code" href="c8051F020_8h.html#a1be6fd48fba2f8c347332385fbeed308">SBUF1</a> = *buffer++;
<a name="l00443"></a>00443       <span class="keywordflow">while</span> (ti1_shadow == 0);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445       <a class="code" href="embedded_2mscb_8h.html#a4ae5ad65c961268051560516eeff623f">watchdog_refresh</a>();
<a name="l00446"></a>00446    }
<a name="l00447"></a>00447    RS485_SEC_ENABLE = 0;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <span class="keywordflow">return</span> size;
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="embedded_2mscb_8h.html#ad0c8f08f958888a55a21534a7bd539a3">uart1_receive</a>(<span class="keywordtype">char</span> *buffer, <span class="keywordtype">int</span> size)
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> len;
<a name="l00457"></a>00457 <span class="keywordtype">long</span> <a class="code" href="old__mevb_8cpp.html#af4211e1ba0e676018599e88cfae3537a">start_time</a>;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459    start_time = <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>();
<a name="l00460"></a>00460    len = 0;
<a name="l00461"></a>00461    <span class="keywordflow">do</span> {
<a name="l00462"></a>00462 
<a name="l00463"></a>00463       <span class="keywordflow">if</span> (<a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>() - start_time &gt; 10) <span class="comment">// timeout after 100ms</span>
<a name="l00464"></a>00464          <span class="keywordflow">return</span> 0;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466       <span class="keywordflow">if</span> (n_recv &gt; 0) {
<a name="l00467"></a>00467 
<a name="l00468"></a>00468          <span class="keywordflow">if</span> ((rbuf[0] &amp; 0xF8) != <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>)
<a name="l00469"></a>00469             <span class="keywordflow">return</span> 0;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471          len = rbuf[0] &amp; 0x07;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473          <span class="keywordflow">if</span> (n_recv == len+1) {
<a name="l00474"></a>00474             <span class="keywordflow">if</span> (n_recv &gt; size)
<a name="l00475"></a>00475                memcpy(buffer, rbuf, size);
<a name="l00476"></a>00476             <span class="keywordflow">else</span>
<a name="l00477"></a>00477                memcpy(buffer, rbuf, n_recv);
<a name="l00478"></a>00478             <span class="keywordflow">return</span> n_recv;
<a name="l00479"></a>00479          }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481       <a class="code" href="embedded_2mscb_8h.html#a4ae5ad65c961268051560516eeff623f">watchdog_refresh</a>();
<a name="l00482"></a>00482       }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484    } <span class="keywordflow">while</span> (1);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486    <span class="keywordflow">return</span> len;
<a name="l00487"></a>00487 }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489 <span class="preprocessor">#endif</span>
<a name="l00490"></a>00490 <span class="preprocessor"></span>
<a name="l00491"></a>00491 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00492"></a>00492 
<a name="l00493"></a>00493 <span class="keywordtype">void</span> uart1_init_buffer()
<a name="l00494"></a>00494 {
<a name="l00495"></a>00495    n_recv = 0;
<a name="l00496"></a>00496    ti1_shadow = 1;
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00500"></a>00500 
<a name="l00501"></a>00501 <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a179877b003d63996470f7b628a57eeac">rs232_output</a>(<span class="keywordtype">void</span>) <span class="comment">// dummy</span>
<a name="l00502"></a>00502 {
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 <span class="preprocessor">#else // SCS_210 | SCS_1000</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span>
<a name="l00509"></a><a class="code" href="mscbutil_8c.html#a179877b003d63996470f7b628a57eeac">00509</a> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a179877b003d63996470f7b628a57eeac">rs232_output</a>(<span class="keywordtype">void</span>) <span class="comment">// dummy</span>
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 <span class="preprocessor">#endif</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span>
<a name="l00515"></a>00515 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00516"></a>00516 
<a name="l00517"></a><a class="code" href="mscbutil_8c.html#aee20e81ba44db51d21a17d4640f5eae9">00517</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#aee20e81ba44db51d21a17d4640f5eae9">uart_init</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> port, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="scs__210_8c.html#a9bca8730b6d7cf7af1215971054adc00">baud</a>)
<a name="l00518"></a>00518 <span class="comment">/********************************************************************\</span>
<a name="l00519"></a>00519 <span class="comment"></span>
<a name="l00520"></a>00520 <span class="comment">  Routine: uart_init</span>
<a name="l00521"></a>00521 <span class="comment"></span>
<a name="l00522"></a>00522 <span class="comment">  Purpose: Initialize serial interface, user Timer 1 for UART0 and</span>
<a name="l00523"></a>00523 <span class="comment">           (optionally) Timer 2 (4 for F020) for UART1</span>
<a name="l00524"></a>00524 <span class="comment"></span>
<a name="l00525"></a>00525 <span class="comment">  Input:</span>
<a name="l00526"></a>00526 <span class="comment">    unsigned char baud      1:9600,2:19200,3:28800,4:57600,</span>
<a name="l00527"></a>00527 <span class="comment">                            5:115200,6:172800,7:345600 Baud</span>
<a name="l00528"></a>00528 <span class="comment"></span>
<a name="l00529"></a>00529 <span class="comment">\********************************************************************/</span>
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531 <span class="preprocessor">#if defined (CPU_C8051F310)</span>
<a name="l00532"></a>00532 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> code baud_table[] =
<a name="l00533"></a>00533      {0x100 - 0,    <span class="comment">//  N/A</span>
<a name="l00534"></a>00534       0x100 - 0,    <span class="comment">//  N/A</span>
<a name="l00535"></a>00535       0x100 - 192,  <span class="comment">//  28800</span>
<a name="l00536"></a>00536       0x100 - 96,   <span class="comment">//  57600</span>
<a name="l00537"></a>00537       0x100 - 48,   <span class="comment">// 115200</span>
<a name="l00538"></a>00538       0x100 - 32,   <span class="comment">// 172800</span>
<a name="l00539"></a>00539       0x100 - 16 }; <span class="comment">// 345600</span>
<a name="l00540"></a>00540 <span class="preprocessor">#elif defined(CPU_C8051F320)       // 12 MHz</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> code baud_table[] =
<a name="l00542"></a>00542      {0x100 - 0,    <span class="comment">//  N/A</span>
<a name="l00543"></a>00543       0x100 - 0,    <span class="comment">//  N/A</span>
<a name="l00544"></a>00544       0x100 - 208,  <span class="comment">//  28800</span>
<a name="l00545"></a>00545       0x100 - 104,  <span class="comment">//  57600</span>
<a name="l00546"></a>00546       0x100 - 52,   <span class="comment">// 115200</span>
<a name="l00547"></a>00547       0x100 - 35,   <span class="comment">// 172800  2% error</span>
<a name="l00548"></a>00548       0x100 - 17 }; <span class="comment">// 345600  2% error</span>
<a name="l00549"></a>00549 <span class="preprocessor">#elif defined(CPU_C8051F120)       // 98 MHz</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> code baud_table[] =  <span class="comment">// UART0 via timer 2</span>
<a name="l00551"></a>00551      {0x100 - 0,    <span class="comment">//  N/A</span>
<a name="l00552"></a>00552       0x100 - 0,    <span class="comment">//  N/A</span>
<a name="l00553"></a>00553       0x100 - 208,  <span class="comment">//  28800  2% error</span>
<a name="l00554"></a>00554       0x100 - 104,  <span class="comment">//  57600  2% error</span>
<a name="l00555"></a>00555       0x100 - 53,   <span class="comment">// 115200  2% error</span>
<a name="l00556"></a>00556       0x100 - 35,   <span class="comment">// 172800  2% error</span>
<a name="l00557"></a>00557       0x100 - 18 }; <span class="comment">// 345600  2% error</span>
<a name="l00558"></a>00558 <span class="preprocessor">#else                              // 11.0592 MHz</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> code baud_table[] =
<a name="l00560"></a>00560      {0x100 - 36,   <span class="comment">//   9600  </span>
<a name="l00561"></a>00561       0x100 - 18,   <span class="comment">//  14400 </span>
<a name="l00562"></a>00562       0x100 - 12,   <span class="comment">//  28800</span>
<a name="l00563"></a>00563       0x100 - 6,    <span class="comment">//  57600</span>
<a name="l00564"></a>00564       0x100 - 3,    <span class="comment">// 115200</span>
<a name="l00565"></a>00565       0x100 - 2,    <span class="comment">// 172800</span>
<a name="l00566"></a>00566       0x100 - 1 };  <span class="comment">// 345600</span>
<a name="l00567"></a>00567 <span class="preprocessor">#endif</span>
<a name="l00568"></a>00568 <span class="preprocessor"></span>
<a name="l00569"></a>00569    <span class="keywordflow">if</span> (port == 0) { <span class="comment">/*---- UART0 ----*/</span>
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00572"></a>00572 <span class="preprocessor"></span>      <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l00573"></a>00573 <span class="preprocessor">#endif</span>
<a name="l00574"></a>00574 <span class="preprocessor"></span>
<a name="l00575"></a>00575       <a class="code" href="embedded_2mscb_8h.html#aca350bf3b88ddd617fc96ed299745b87">SCON0</a> = 0xD0;                <span class="comment">// Mode 3, 9 bit, receive enable</span>
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00578"></a>00578 <span class="preprocessor"></span>
<a name="l00579"></a>00579       <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l00580"></a>00580       <a class="code" href="c8051F120_8h.html#a03cf82602153c648d521c526fe5436d8">SSTA0</a> = 0x15;                <span class="comment">// User Timer 2 for baud rate, div2 disabled</span>
<a name="l00581"></a>00581       
<a name="l00582"></a>00582       <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a7ca20b4db1ca1788c942cf8ebc506001">TMR2_PAGE</a>;
<a name="l00583"></a>00583       <a class="code" href="c8051F120_8h.html#a6ab321bda3afd00552117140dfa077a1">TMR2CF</a> = 0x08;               <span class="comment">// use system clock for timer 2</span>
<a name="l00584"></a>00584       <a class="code" href="c8051F000_8h.html#ade73ab58f3965f6e113f05634b6db308">RCAP2H</a> = 0xFF;
<a name="l00585"></a>00585       <a class="code" href="c8051F000_8h.html#a87ed4fdfe7e7c0e994f0128eee8564e0">RCAP2L</a> = baud_table[baud - 1];  <span class="comment">// load initial values</span>
<a name="l00586"></a>00586       <a class="code" href="c8051F120_8h.html#a11eff251b123ea9a318a5944faef9870">TMR2CN</a> = 0x04;               <span class="comment">// start timer 2</span>
<a name="l00587"></a>00587       <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 <span class="preprocessor">#else // CPU_C8051F120</span>
<a name="l00590"></a>00590 <span class="preprocessor"></span>
<a name="l00591"></a>00591       <a class="code" href="c8051F000_8h.html#abb8213117f197b1af5887eb0c00bbfac">TMOD</a>  = (<a class="code" href="c8051F000_8h.html#abb8213117f197b1af5887eb0c00bbfac">TMOD</a> &amp; 0x0F)| 0x20; <span class="comment">// Timer 1 8-bit counter with auto reload</span>
<a name="l00592"></a>00592 
<a name="l00593"></a>00593 <span class="preprocessor">#if defined(CPU_C8051F310) || defined(CPU_C8051F320)</span>
<a name="l00594"></a>00594 <span class="preprocessor"></span>      <a class="code" href="c8051F000_8h.html#a22ee5a0902bed7b69b5238e2dd188e50">CKCON</a> |= 0x08;               <span class="comment">// use system clock</span>
<a name="l00595"></a>00595 <span class="preprocessor">#else</span>
<a name="l00596"></a>00596 <span class="preprocessor"></span>      <a class="code" href="c8051F000_8h.html#a48e78519142627f2302db3f59441070e">T2CON</a> &amp;= ~30;                <span class="comment">// User Timer 1 for baud rate</span>
<a name="l00597"></a>00597       <a class="code" href="c8051F000_8h.html#a22ee5a0902bed7b69b5238e2dd188e50">CKCON</a> |= 0x10;               <span class="comment">// use system clock</span>
<a name="l00598"></a>00598 <span class="preprocessor">#endif</span>
<a name="l00599"></a>00599 <span class="preprocessor"></span>
<a name="l00600"></a>00600       <a class="code" href="c8051F000_8h.html#a4ae730549ffdf484b18e051fcddbe8ff">TH1</a> = baud_table[baud - 1];  <span class="comment">// load initial values</span>
<a name="l00601"></a>00601       <a class="code" href="c8051F000_8h.html#a409af03b4cf307d532aa009188eeeece">TR1</a> = 1;                     <span class="comment">// start timer 1</span>
<a name="l00602"></a>00602 
<a name="l00603"></a>00603 <span class="preprocessor">#endif // CPU_C8051F120</span>
<a name="l00604"></a>00604 <span class="preprocessor"></span>
<a name="l00605"></a>00605       <a class="code" href="embedded_2mscb_8h.html#ad147e55136df8cab74bfb301feaa82ad">ES0</a> = 1;                     <span class="comment">// enable serial interrupt</span>
<a name="l00606"></a>00606       <a class="code" href="embedded_2mscb_8h.html#adeef02e4ad30db3c40ab259e6084317c">PS0</a> = 0;                     <span class="comment">// serial interrupt low priority</span>
<a name="l00607"></a>00607    
<a name="l00608"></a>00608 
<a name="l00609"></a>00609    } <span class="keywordflow">else</span> { <span class="comment">/*---- UART1 ----*/</span>
<a name="l00610"></a>00610 
<a name="l00611"></a>00611 <span class="preprocessor">#if defined(CPU_C8051F020)</span>
<a name="l00612"></a>00612 <span class="preprocessor"></span>      <a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> = 0x50;                <span class="comment">// Mode 1, 8 bit, receive enable</span>
<a name="l00613"></a>00613 
<a name="l00614"></a>00614       <a class="code" href="c8051F020_8h.html#a309e03e7273466467388454231e8d6cf">T4CON</a> = 0x34;                <span class="comment">// timer 4 RX+TX mode</span>
<a name="l00615"></a>00615       <a class="code" href="c8051F020_8h.html#a5dc39f09755db2ee0bdce36d8d661184">RCAP4H</a> = 0xFF;
<a name="l00616"></a>00616       <a class="code" href="c8051F020_8h.html#aa91af59fde6f359c473f39ff8a14f164">RCAP4L</a> = baud_table[baud - 1];
<a name="l00617"></a>00617 
<a name="l00618"></a>00618       <a class="code" href="c8051F000_8h.html#a8fdc45702764ff95656d93523e16edbf">EIE2</a> |= 0x40;                <span class="comment">// enable serial interrupt</span>
<a name="l00619"></a>00619       <a class="code" href="c8051F000_8h.html#a3211e6a9c9555571d1bb384d3758506d">EIP2</a> &amp;= ~0x40;               <span class="comment">// serial interrupt low priority      </span>
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 <span class="preprocessor">#ifdef SCS_210</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span>      uart1_init_buffer();
<a name="l00623"></a>00623 <span class="preprocessor">#endif</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span>
<a name="l00625"></a>00625 <span class="preprocessor">#elif defined(CPU_C8051F120)       // 98 MHz</span>
<a name="l00626"></a>00626 <span class="preprocessor"></span>      <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a060ad197c4fa8f45488806c35ba3bc3b">UART1_PAGE</a>;
<a name="l00627"></a>00627       <a class="code" href="c8051F020_8h.html#a423bb65316001a377c38201366cff911">SCON1</a> = 0xD0;                <span class="comment">// Mode 3, 9 bit, receive enable</span>
<a name="l00628"></a>00628 
<a name="l00629"></a>00629       <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a415c58e2ffb94b7d8760bfaea8ffd48a">TIMER01_PAGE</a>;
<a name="l00630"></a>00630       <a class="code" href="c8051F000_8h.html#abb8213117f197b1af5887eb0c00bbfac">TMOD</a>  = (<a class="code" href="c8051F000_8h.html#abb8213117f197b1af5887eb0c00bbfac">TMOD</a> &amp; 0x0F)| 0x20; <span class="comment">// Timer 1 8-bit counter with auto reload</span>
<a name="l00631"></a>00631       <a class="code" href="c8051F000_8h.html#a22ee5a0902bed7b69b5238e2dd188e50">CKCON</a> = 0x02;                <span class="comment">// use SYSCLK/48 (needed by timer 0)</span>
<a name="l00632"></a>00632 
<a name="l00633"></a>00633       <a class="code" href="c8051F000_8h.html#a4ae730549ffdf484b18e051fcddbe8ff">TH1</a> = 0xF7;                  <span class="comment">// gives 113452 baud, neglegt &quot;baud&quot; parameter</span>
<a name="l00634"></a>00634       <a class="code" href="c8051F000_8h.html#a409af03b4cf307d532aa009188eeeece">TR1</a> = 1;                     <span class="comment">// start timer 1</span>
<a name="l00635"></a>00635 
<a name="l00636"></a>00636       <a class="code" href="c8051F000_8h.html#a8fdc45702764ff95656d93523e16edbf">EIE2</a> |= 0x40;                <span class="comment">// enable serial interrupt</span>
<a name="l00637"></a>00637       <a class="code" href="c8051F000_8h.html#a3211e6a9c9555571d1bb384d3758506d">EIP2</a> &amp;= ~0x40;               <span class="comment">// serial interrupt low priority      </span>
<a name="l00638"></a>00638       uart1_init_buffer();
<a name="l00639"></a>00639 <span class="preprocessor">#endif</span>
<a name="l00640"></a>00640 <span class="preprocessor"></span>   }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642    <a class="code" href="c8051F000_8h.html#ae524fa4918208f2da654a7887bd9a7d0">EA</a> = 1;                         <span class="comment">// general interrupt enable</span>
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00646"></a>00646 
<a name="l00647"></a><a class="code" href="mscbutil_8c.html#adae727c6b6e3f32ab30a4283876934ee">00647</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="mscbutil_8c.html#adae727c6b6e3f32ab30a4283876934ee">_systime</a>;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 <span class="comment">/* LED structure */</span>
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="keyword">struct </span>{
<a name="l00652"></a><a class="code" href="mscbutil_8c.html#a74b654271a172a244c844fb86277cd8a">00652</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mscbutil_8c.html#a74b654271a172a244c844fb86277cd8a">mode</a>;
<a name="l00653"></a><a class="code" href="mscbutil_8c.html#a915eedaaa4284d1bac812f5c73940f2c">00653</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mscbutil_8c.html#a915eedaaa4284d1bac812f5c73940f2c">timer</a>;
<a name="l00654"></a><a class="code" href="mscbutil_8c.html#ad856acfe9ce335571b00a73df5e23e6b">00654</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mscbutil_8c.html#ad856acfe9ce335571b00a73df5e23e6b">interval</a>;
<a name="l00655"></a><a class="code" href="mscbutil_8c.html#aa94ff7ddd304b9beb2f209b6174e180e">00655</a>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>;
<a name="l00656"></a>00656 } idata <a class="code" href="mscbutil_8c.html#a90c2645ea4040716a54e39a01a51c183">leds</a>[<a class="code" href="embedded_2mscb_8h.html#a09ce9c9f5e59ac595b1e21730a00dcf9">N_LED</a>];
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 <span class="preprocessor">#ifdef LED_0</span>
<a name="l00659"></a>00659 <span class="preprocessor"></span>sbit <a class="code" href="subm__250_8c.html#ae06893434b09005871d20c1697bfac29">led_0</a> = LED_0;
<a name="l00660"></a>00660 <span class="preprocessor">#endif</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span><span class="preprocessor">#ifdef LED_1</span>
<a name="l00662"></a>00662 <span class="preprocessor"></span>sbit <a class="code" href="subm__250_8c.html#a81f7ebb598ca09b15871759769c669c6">led_1</a> = LED_1;
<a name="l00663"></a>00663 <span class="preprocessor">#endif</span>
<a name="l00664"></a>00664 <span class="preprocessor"></span><span class="preprocessor">#ifdef LED_2</span>
<a name="l00665"></a>00665 <span class="preprocessor"></span>sbit led_2 = LED_2;
<a name="l00666"></a>00666 <span class="preprocessor">#endif</span>
<a name="l00667"></a>00667 <span class="preprocessor"></span><span class="preprocessor">#ifdef LED_3</span>
<a name="l00668"></a>00668 <span class="preprocessor"></span>sbit led_3 = LED_3;
<a name="l00669"></a>00669 <span class="preprocessor">#endif</span>
<a name="l00670"></a>00670 <span class="preprocessor"></span><span class="preprocessor">#ifdef LED_4</span>
<a name="l00671"></a>00671 <span class="preprocessor"></span>sbit led_4 = LED_4;
<a name="l00672"></a>00672 <span class="preprocessor">#endif</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span>
<a name="l00674"></a>00674 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00675"></a>00675 
<a name="l00676"></a><a class="code" href="mscbutil_8c.html#ac3da29ea117a42298b0958a53dd33aab">00676</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#ac3da29ea117a42298b0958a53dd33aab">sysclock_init</a>(<span class="keywordtype">void</span>)
<a name="l00677"></a>00677 <span class="comment">/********************************************************************\</span>
<a name="l00678"></a>00678 <span class="comment"></span>
<a name="l00679"></a>00679 <span class="comment">  Routine: sysclock_init</span>
<a name="l00680"></a>00680 <span class="comment"></span>
<a name="l00681"></a>00681 <span class="comment">  Purpose: Initial sytem clock via timer 0</span>
<a name="l00682"></a>00682 <span class="comment"></span>
<a name="l00683"></a>00683 <span class="comment">*********************************************************************/</span>
<a name="l00684"></a>00684 {
<a name="l00685"></a>00685    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i;
<a name="l00686"></a>00686 
<a name="l00687"></a>00687    <a class="code" href="c8051F000_8h.html#ae524fa4918208f2da654a7887bd9a7d0">EA</a> = 1;                      <span class="comment">// general interrupt enable</span>
<a name="l00688"></a>00688    <a class="code" href="c8051F000_8h.html#a749b757b6727c132cf750b0b8a120435">ET0</a> = 1;                     <span class="comment">// Enable Timer 1 interrupt</span>
<a name="l00689"></a>00689    <a class="code" href="c8051F000_8h.html#a2882414c100b171b38f7cda29a76eaae">PT1</a> = 1;                     <span class="comment">// Interrupt priority high</span>
<a name="l00690"></a>00690 
<a name="l00691"></a>00691 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span>   <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a415c58e2ffb94b7d8760bfaea8ffd48a">TIMER01_PAGE</a>;
<a name="l00693"></a>00693 <span class="preprocessor">#endif</span>
<a name="l00694"></a>00694 <span class="preprocessor"></span>
<a name="l00695"></a>00695    <a class="code" href="c8051F000_8h.html#abb8213117f197b1af5887eb0c00bbfac">TMOD</a> = (<a class="code" href="c8051F000_8h.html#abb8213117f197b1af5887eb0c00bbfac">TMOD</a> &amp; 0x0F) | 0x01; <span class="comment">// 16-bit counter</span>
<a name="l00696"></a>00696 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a22ee5a0902bed7b69b5238e2dd188e50">CKCON</a> = 0x02;                <span class="comment">// use SYSCLK/48</span>
<a name="l00698"></a>00698    <a class="code" href="c8051F000_8h.html#ac948201508da14c3dd841a908e4887c3">TH0</a> = 0xAF;                  <span class="comment">// load initial value</span>
<a name="l00699"></a>00699 <span class="preprocessor">#else</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a22ee5a0902bed7b69b5238e2dd188e50">CKCON</a> = 0x00;                <span class="comment">// use SYSCLK/12</span>
<a name="l00701"></a>00701    <a class="code" href="c8051F000_8h.html#ac948201508da14c3dd841a908e4887c3">TH0</a> = 0xDB;                  <span class="comment">// load initial value</span>
<a name="l00702"></a>00702 <span class="preprocessor">#endif</span>
<a name="l00703"></a>00703 <span class="preprocessor"></span>
<a name="l00704"></a>00704    <a class="code" href="c8051F000_8h.html#a4799f8e8c0ba4de147d572a57599dc16">TL0</a> = 0x00;
<a name="l00705"></a>00705    <a class="code" href="c8051F000_8h.html#a19f7cd580ff8d496f442c7ac2bbf89a3">TR0</a> = 1;                     <span class="comment">// start timer 1</span>
<a name="l00706"></a>00706 
<a name="l00707"></a>00707    _systime = 0;
<a name="l00708"></a>00708 
<a name="l00709"></a>00709    <span class="keywordflow">for</span> (i=0 ; i&lt;<a class="code" href="embedded_2mscb_8h.html#a09ce9c9f5e59ac595b1e21730a00dcf9">N_LED</a> ; i++) {
<a name="l00710"></a>00710      leds[i].mode = 0;
<a name="l00711"></a>00711      leds[i].timer = 0;
<a name="l00712"></a>00712      leds[i].interval = 0;
<a name="l00713"></a>00713      leds[i].n = 0;
<a name="l00714"></a>00714    }
<a name="l00715"></a>00715 }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00718"></a>00718 
<a name="l00719"></a><a class="code" href="mscbutil_8c.html#a2e16d999cb779a17d76f7996edc132a0">00719</a> <span class="keywordtype">void</span> <a class="code" href="mscbutil_8c.html#a2e16d999cb779a17d76f7996edc132a0">led_int</a>() reentrant using 2
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723    <span class="comment">/* manage blinking LEDs */</span>
<a name="l00724"></a>00724    <span class="keywordflow">for</span> (i=0 ; i&lt;<a class="code" href="embedded_2mscb_8h.html#a09ce9c9f5e59ac595b1e21730a00dcf9">N_LED</a> ; i++) {
<a name="l00725"></a>00725       <span class="keywordflow">if</span> (leds[i].<a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> &gt; 0 &amp;&amp; leds[i].<a class="code" href="mscbutil_8c.html#a915eedaaa4284d1bac812f5c73940f2c">timer</a> == 0) {
<a name="l00726"></a>00726          <span class="keywordflow">if</span> ((leds[i].<a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> &amp; 1) &amp;&amp; leds[i].n &gt; 1)
<a name="l00727"></a>00727             <a class="code" href="embedded_2mscb_8h.html#a1a4ec2f42e1277c5273ba002ed50394d">led_set</a>(i, LED_ON);
<a name="l00728"></a>00728          <span class="keywordflow">else</span>
<a name="l00729"></a>00729             <a class="code" href="embedded_2mscb_8h.html#a1a4ec2f42e1277c5273ba002ed50394d">led_set</a>(i, <a class="code" href="embedded_2mscb_8h.html#a80700bb63bd56ebabbb4728aa433fd29">LED_OFF</a>);
<a name="l00730"></a>00730 
<a name="l00731"></a>00731          leds[i].n--;
<a name="l00732"></a>00732          <span class="keywordflow">if</span> (leds[i].n)
<a name="l00733"></a>00733             leds[i].timer = leds[i].interval;
<a name="l00734"></a>00734       }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736       <span class="keywordflow">if</span> (leds[i].<a class="code" href="mscbutil_8c.html#a915eedaaa4284d1bac812f5c73940f2c">timer</a>)
<a name="l00737"></a>00737          leds[i].timer--;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739       <span class="keywordflow">if</span> (leds[i].<a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == 0)
<a name="l00740"></a>00740          <a class="code" href="embedded_2mscb_8h.html#a1a4ec2f42e1277c5273ba002ed50394d">led_set</a>(i, <a class="code" href="embedded_2mscb_8h.html#a80700bb63bd56ebabbb4728aa433fd29">LED_OFF</a>);
<a name="l00741"></a>00741    }
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00745"></a>00745 
<a name="l00746"></a><a class="code" href="mscbutil_8c.html#ac3728bbd985e83ef7d1b479afe2eaeb3">00746</a> <span class="keywordtype">void</span> <a class="code" href="mscbutil_8c.html#ac3728bbd985e83ef7d1b479afe2eaeb3">timer0_int</a>(<span class="keywordtype">void</span>) interrupt 1 using 2
<a name="l00747"></a>00747 <span class="comment">/********************************************************************\</span>
<a name="l00748"></a>00748 <span class="comment"></span>
<a name="l00749"></a>00749 <span class="comment">  Routine: timer0_int</span>
<a name="l00750"></a>00750 <span class="comment"></span>
<a name="l00751"></a>00751 <span class="comment">  Purpose: Timer 0 interrupt routine for 100Hz system clock</span>
<a name="l00752"></a>00752 <span class="comment"></span>
<a name="l00753"></a>00753 <span class="comment">           Reload value = 0x10000 - 0.01 / (11059200/12)</span>
<a name="l00754"></a>00754 <span class="comment"></span>
<a name="l00755"></a>00755 <span class="comment">\********************************************************************/</span>
<a name="l00756"></a>00756 {
<a name="l00757"></a>00757 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#ac948201508da14c3dd841a908e4887c3">TH0</a> = 0xAF;                  <span class="comment">// for 98 MHz clock</span>
<a name="l00759"></a>00759 <span class="preprocessor">#else</span>
<a name="l00760"></a>00760 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#ac948201508da14c3dd841a908e4887c3">TH0</a> = 0xDC;                  <span class="comment">// reload timer values, let LSB freely run</span>
<a name="l00761"></a>00761 <span class="preprocessor">#endif</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span>   _systime++;                  <span class="comment">// increment system time</span>
<a name="l00763"></a>00763 
<a name="l00764"></a>00764    <a class="code" href="mscbutil_8c.html#a2e16d999cb779a17d76f7996edc132a0">led_int</a>();
<a name="l00765"></a>00765 }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00768"></a>00768 
<a name="l00769"></a><a class="code" href="mscbutil_8c.html#af87085aa8c2a51c2ef253721e4a192ca">00769</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#af87085aa8c2a51c2ef253721e4a192ca">led_mode</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> led, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>) reentrant
<a name="l00770"></a>00770 <span class="comment">/********************************************************************\</span>
<a name="l00771"></a>00771 <span class="comment"></span>
<a name="l00772"></a>00772 <span class="comment">  Routine: led_mode</span>
<a name="l00773"></a>00773 <span class="comment"></span>
<a name="l00774"></a>00774 <span class="comment">  Purpose: Set LED mode</span>
<a name="l00775"></a>00775 <span class="comment"></span>
<a name="l00776"></a>00776 <span class="comment">  Input:</span>
<a name="l00777"></a>00777 <span class="comment">    int led               0 for primary, 1 for secondary</span>
<a name="l00778"></a>00778 <span class="comment">    int flag              Noninverted (0) / Inverted (1)</span>
<a name="l00779"></a>00779 <span class="comment"></span>
<a name="l00780"></a>00780 <span class="comment">\********************************************************************/</span>
<a name="l00781"></a>00781 {
<a name="l00782"></a>00782    <span class="keywordflow">if</span> (led &lt; <a class="code" href="embedded_2mscb_8h.html#a09ce9c9f5e59ac595b1e21730a00dcf9">N_LED</a>)
<a name="l00783"></a>00783       leds[led].mode = <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00787"></a>00787 
<a name="l00788"></a><a class="code" href="mscbutil_8c.html#a431cf0a502f2a232e27f81080a890585">00788</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> led, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <span class="keywordtype">int</span> <a class="code" href="mscbutil_8c.html#ad856acfe9ce335571b00a73df5e23e6b">interval</a>) reentrant
<a name="l00789"></a>00789 <span class="comment">/********************************************************************\</span>
<a name="l00790"></a>00790 <span class="comment"></span>
<a name="l00791"></a>00791 <span class="comment">  Routine: blink led</span>
<a name="l00792"></a>00792 <span class="comment"></span>
<a name="l00793"></a>00793 <span class="comment">  Purpose: Blink primary or secondary LED for a couple of times</span>
<a name="l00794"></a>00794 <span class="comment"></span>
<a name="l00795"></a>00795 <span class="comment">  Input:</span>
<a name="l00796"></a>00796 <span class="comment">    int led               0 for primary, 1 for secondary, ...</span>
<a name="l00797"></a>00797 <span class="comment">    int interval          Blink interval in ms</span>
<a name="l00798"></a>00798 <span class="comment">    int n                 Number of blinks</span>
<a name="l00799"></a>00799 <span class="comment"></span>
<a name="l00800"></a>00800 <span class="comment">\********************************************************************/</span>
<a name="l00801"></a>00801 {
<a name="l00802"></a>00802    <span class="keywordflow">if</span> (led &lt; <a class="code" href="embedded_2mscb_8h.html#a09ce9c9f5e59ac595b1e21730a00dcf9">N_LED</a>) {
<a name="l00803"></a>00803       <span class="keywordflow">if</span> (leds[led].<a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == 0 &amp;&amp; leds[led].<a class="code" href="mscbutil_8c.html#a915eedaaa4284d1bac812f5c73940f2c">timer</a> == 0) {
<a name="l00804"></a>00804          leds[led].n = <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>*2+1;
<a name="l00805"></a>00805          leds[led].interval = <a class="code" href="mscbutil_8c.html#ad856acfe9ce335571b00a73df5e23e6b">interval</a> / 10;
<a name="l00806"></a>00806          leds[led].timer = 0;
<a name="l00807"></a>00807       }
<a name="l00808"></a>00808    }
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00812"></a>00812 
<a name="l00813"></a><a class="code" href="mscbutil_8c.html#aaae689725b9077d5e8a019f547e124b5">00813</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a1a4ec2f42e1277c5273ba002ed50394d">led_set</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> led, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>) reentrant <span class="keyword">using</span> 2
<a name="l00814"></a>00814 {
<a name="l00815"></a>00815    <span class="comment">/* invert on/of if mode = 1 */</span>
<a name="l00816"></a>00816    <span class="keywordflow">if</span> (led &lt; <a class="code" href="embedded_2mscb_8h.html#a09ce9c9f5e59ac595b1e21730a00dcf9">N_LED</a> &amp;&amp; leds[led].<a class="code" href="mscbutil_8c.html#a74b654271a172a244c844fb86277cd8a">mode</a>)
<a name="l00817"></a>00817       <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a> = !<a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 <span class="preprocessor">#ifdef LED_0</span>
<a name="l00820"></a>00820 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (led == 0)
<a name="l00821"></a>00821       led_0 = <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l00822"></a>00822 <span class="preprocessor">#endif</span>
<a name="l00823"></a>00823 <span class="preprocessor"></span><span class="preprocessor">#ifdef LED_1</span>
<a name="l00824"></a>00824 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (led == 1)
<a name="l00825"></a>00825       led_1 = <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l00826"></a>00826 <span class="preprocessor">#endif </span>
<a name="l00827"></a>00827 <span class="preprocessor"></span><span class="preprocessor">#ifdef LED_2</span>
<a name="l00828"></a>00828 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (led == 2)
<a name="l00829"></a>00829       led_2 = <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l00830"></a>00830 <span class="preprocessor">#endif </span>
<a name="l00831"></a>00831 <span class="preprocessor"></span><span class="preprocessor">#ifdef LED_3</span>
<a name="l00832"></a>00832 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (led == 3)
<a name="l00833"></a>00833       led_3 = <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l00834"></a>00834 <span class="preprocessor">#endif </span>
<a name="l00835"></a>00835 <span class="preprocessor"></span><span class="preprocessor">#ifdef LED_4</span>
<a name="l00836"></a>00836 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (led == 4)
<a name="l00837"></a>00837       led_4 = <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l00838"></a>00838 <span class="preprocessor">#endif</span>
<a name="l00839"></a>00839 <span class="preprocessor"></span>}
<a name="l00840"></a>00840 
<a name="l00841"></a>00841 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00842"></a>00842 
<a name="l00843"></a><a class="code" href="mscbutil_8c.html#a6a9297d6553b1d1a19e999be7048ce8f">00843</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>(<span class="keywordtype">void</span>)
<a name="l00844"></a>00844 <span class="comment">/********************************************************************\</span>
<a name="l00845"></a>00845 <span class="comment"></span>
<a name="l00846"></a>00846 <span class="comment">  Routine: time</span>
<a name="l00847"></a>00847 <span class="comment"></span>
<a name="l00848"></a>00848 <span class="comment">  Purpose: Return system time in units of 10ms </span>
<a name="l00849"></a>00849 <span class="comment"></span>
<a name="l00850"></a>00850 <span class="comment">\********************************************************************/</span>
<a name="l00851"></a>00851 {
<a name="l00852"></a>00852    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t;
<a name="l00853"></a>00853 
<a name="l00854"></a>00854    <a class="code" href="embedded_2mscb_8h.html#a3b37db44db50722cac572660028ba2b5">DISABLE_INTERRUPTS</a>;
<a name="l00855"></a>00855    t = _systime;
<a name="l00856"></a>00856    <a class="code" href="embedded_2mscb_8h.html#a62b74068f303c78492667e69fe203914">ENABLE_INTERRUPTS</a>;
<a name="l00857"></a>00857    <span class="keywordflow">return</span> t;
<a name="l00858"></a>00858 }
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00861"></a>00861 
<a name="l00862"></a><a class="code" href="subm__300_8c.html#a4ae5ad65c961268051560516eeff623f">00862</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a4ae5ad65c961268051560516eeff623f">watchdog_refresh</a>(<span class="keywordtype">void</span>)
<a name="l00863"></a>00863 <span class="comment">/********************************************************************\</span>
<a name="l00864"></a>00864 <span class="comment"></span>
<a name="l00865"></a>00865 <span class="comment">  Routine: watchdog_refresh</span>
<a name="l00866"></a>00866 <span class="comment"></span>
<a name="l00867"></a>00867 <span class="comment">  Purpose: Refresh watchdog, has to be called regularly, otherwise</span>
<a name="l00868"></a>00868 <span class="comment">           the watchdog issues a reset</span>
<a name="l00869"></a>00869 <span class="comment"></span>
<a name="l00870"></a>00870 <span class="comment">\********************************************************************/</span>
<a name="l00871"></a>00871 {
<a name="l00872"></a>00872 <span class="preprocessor">#ifdef USE_WATCHDOG</span>
<a name="l00873"></a>00873 <span class="preprocessor"></span>
<a name="l00874"></a>00874 <span class="preprocessor">#ifdef CPU_ADUC812</span>
<a name="l00875"></a>00875 <span class="preprocessor"></span>   WDR1 = 1;
<a name="l00876"></a>00876    WDR2 = 1;
<a name="l00877"></a>00877 <span class="preprocessor">#endif</span>
<a name="l00878"></a>00878 <span class="preprocessor"></span>
<a name="l00879"></a>00879 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l00880"></a>00880 <span class="preprocessor"></span>
<a name="l00881"></a>00881 <span class="preprocessor">#if defined(CPU_C8051F310) || defined(CPU_C8051F320)</span>
<a name="l00882"></a>00882 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#af7a9d79f2b6afa076f984a1f0b2b93b9">PCA0CPH4</a> = 0x00;
<a name="l00883"></a>00883 <span class="preprocessor">#else</span>
<a name="l00884"></a>00884 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a2eb7f8e96149deeec0f227384694807b">WDTCN</a> = 0xA5;
<a name="l00885"></a>00885 <span class="preprocessor">#endif</span>
<a name="l00886"></a>00886 <span class="preprocessor"></span>
<a name="l00887"></a>00887 <span class="preprocessor">#endif</span>
<a name="l00888"></a>00888 <span class="preprocessor"></span>
<a name="l00889"></a>00889 <span class="preprocessor">#endif</span>
<a name="l00890"></a>00890 <span class="preprocessor"></span>}
<a name="l00891"></a>00891 
<a name="l00892"></a>00892 <span class="comment">/*------------------------------------------------------------------*\</span>
<a name="l00893"></a>00893 <span class="comment"></span>
<a name="l00894"></a>00894 <span class="comment">/********************************************************************\</span>
<a name="l00895"></a>00895 <span class="comment"></span>
<a name="l00896"></a>00896 <span class="comment">  Routine: delay_ms, delay_us</span>
<a name="l00897"></a>00897 <span class="comment"></span>
<a name="l00898"></a>00898 <span class="comment">  Purpose: Delay functions for 11.0520 MHz quartz</span>
<a name="l00899"></a>00899 <span class="comment"></span>
<a name="l00900"></a>00900 <span class="comment">\********************************************************************/</span>
<a name="l00901"></a>00901 
<a name="l00902"></a><a class="code" href="mscbutil_8c.html#af29c4657f62375d42c6ee104b6bf4491">00902</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#af29c4657f62375d42c6ee104b6bf4491">delay_ms</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ms)
<a name="l00903"></a>00903 {
<a name="l00904"></a>00904    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l00905"></a>00905 
<a name="l00906"></a>00906    <span class="keywordflow">for</span> (i = 0; i &lt; ms; i++) {
<a name="l00907"></a>00907       <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1000);
<a name="l00908"></a>00908       <a class="code" href="embedded_2mscb_8h.html#a7cb51f5c2b5cad3766f19eb69c92793b">yield</a>();
<a name="l00909"></a>00909    }
<a name="l00910"></a>00910 }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 <span class="preprocessor">#ifdef CPU_ADUC812</span>
<a name="l00913"></a>00913 <span class="preprocessor"></span>
<a name="l00914"></a>00914 <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> us)
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i;
<a name="l00917"></a>00917    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> remaining_us;
<a name="l00918"></a>00918 
<a name="l00919"></a>00919    <span class="keywordflow">if</span> (us &lt;= 250) {
<a name="l00920"></a>00920       us /= 12;
<a name="l00921"></a>00921       <span class="keywordflow">for</span> (i = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) us; i &gt; 0; i--);
<a name="l00922"></a>00922    } <span class="keywordflow">else</span> {
<a name="l00923"></a>00923       remaining_us = us;
<a name="l00924"></a>00924       <span class="keywordflow">while</span> (remaining_us &gt; 250) {
<a name="l00925"></a>00925          <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(250);
<a name="l00926"></a>00926          remaining_us -= 250;
<a name="l00927"></a>00927       }
<a name="l00928"></a>00928       <span class="keywordflow">if</span> (us &gt; 0)
<a name="l00929"></a>00929          <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(remaining_us);
<a name="l00930"></a>00930    }
<a name="l00931"></a>00931 }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933 <span class="preprocessor">#endif</span>
<a name="l00934"></a>00934 <span class="preprocessor"></span>
<a name="l00935"></a>00935 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l00936"></a>00936 <span class="preprocessor"></span>
<a name="l00937"></a><a class="code" href="mscbutil_8c.html#a84f652539f41e435c3b08e023d3ba0dd">00937</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> us)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00940"></a>00940 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>;
<a name="l00941"></a>00941 <span class="preprocessor">#endif</span>
<a name="l00942"></a>00942 <span class="preprocessor"></span>
<a name="l00943"></a>00943    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i;
<a name="l00944"></a>00944    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> remaining_us;
<a name="l00945"></a>00945 
<a name="l00946"></a>00946    <span class="keywordflow">if</span> (us &lt;= 250) {
<a name="l00947"></a>00947       <span class="keywordflow">for</span> (i = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) us; i &gt; 0; i--) {
<a name="l00948"></a>00948 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00949"></a>00949 <span class="preprocessor"></span>         <span class="keywordflow">for</span> (j=22 ; j&gt;0 ; j--)
<a name="l00950"></a>00950             _nop_();
<a name="l00951"></a>00951 <span class="preprocessor">#else</span>
<a name="l00952"></a>00952 <span class="preprocessor"></span>         _nop_();
<a name="l00953"></a>00953 <span class="preprocessor">#endif</span>
<a name="l00954"></a>00954 <span class="preprocessor"></span>      }
<a name="l00955"></a>00955    } <span class="keywordflow">else</span> {
<a name="l00956"></a>00956       remaining_us = us;
<a name="l00957"></a>00957       <span class="keywordflow">while</span> (remaining_us &gt; 250) {
<a name="l00958"></a>00958          <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(250);
<a name="l00959"></a>00959          remaining_us -= 250;
<a name="l00960"></a>00960       }
<a name="l00961"></a>00961       <span class="keywordflow">if</span> (us &gt; 0)
<a name="l00962"></a>00962          <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(remaining_us);
<a name="l00963"></a>00963    }
<a name="l00964"></a>00964 }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 <span class="preprocessor">#endif</span>
<a name="l00967"></a>00967 <span class="preprocessor"></span>
<a name="l00968"></a>00968 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00969"></a>00969 
<a name="l00970"></a>00970 <span class="preprocessor">#ifdef EEPROM_SUPPORT</span>
<a name="l00971"></a>00971 <span class="preprocessor"></span>
<a name="l00972"></a><a class="code" href="mscbutil_8c.html#a4f506741016eb2f2aa4820d0f1b07f0a">00972</a> <span class="keywordtype">void</span> <a class="code" href="mscbutil_8c.html#a4f506741016eb2f2aa4820d0f1b07f0a">eeprom_read</a>(<span class="keywordtype">void</span> * dst, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> len, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *<a class="code" href="mgd_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a>)
<a name="l00973"></a>00973 <span class="comment">/********************************************************************\</span>
<a name="l00974"></a>00974 <span class="comment"></span>
<a name="l00975"></a>00975 <span class="comment">  Routine: eeprom_read</span>
<a name="l00976"></a>00976 <span class="comment"></span>
<a name="l00977"></a>00977 <span class="comment">  Purpose: Read from internal EEPROM</span>
<a name="l00978"></a>00978 <span class="comment"></span>
<a name="l00979"></a>00979 <span class="comment">  Input:</span>
<a name="l00980"></a>00980 <span class="comment">    unsigned char idata *dst    Destination in IDATA memory</span>
<a name="l00981"></a>00981 <span class="comment">    unsigned char len           Number of bytes to copy</span>
<a name="l00982"></a>00982 <span class="comment">    unsigend char *offset       Offset in EEPROM in bytes, gets</span>
<a name="l00983"></a>00983 <span class="comment">                                adjusted after read</span>
<a name="l00984"></a>00984 <span class="comment"></span>
<a name="l00985"></a>00985 <span class="comment">\********************************************************************/</span>
<a name="l00986"></a>00986 {
<a name="l00987"></a>00987 <span class="preprocessor">#ifdef CPU_ADUC812</span>
<a name="l00988"></a>00988 <span class="preprocessor"></span>
<a name="l00989"></a>00989    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i, <a class="code" href="scs__400_8c.html#a04fe355a80e85e9f62a55b0a7cec6100">ofs</a>;
<a name="l00990"></a>00990    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992    <a class="code" href="embedded_2mscb_8h.html#a4ae5ad65c961268051560516eeff623f">watchdog_refresh</a>();
<a name="l00993"></a>00993 
<a name="l00994"></a>00994    d = dst;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996    ofs = *offset;
<a name="l00997"></a>00997    EADRL = ofs / 4;
<a name="l00998"></a>00998    ECON = 0x01;                 <span class="comment">// read page</span>
<a name="l00999"></a>00999 
<a name="l01000"></a>01000    <span class="keywordflow">for</span> (i = 0; i &lt; len; i++, d++) {
<a name="l01001"></a>01001       <span class="keywordflow">switch</span> (ofs % 4) {
<a name="l01002"></a>01002       <span class="keywordflow">case</span> 0:
<a name="l01003"></a>01003          *d = EDATA1;
<a name="l01004"></a>01004          <span class="keywordflow">break</span>;
<a name="l01005"></a>01005       <span class="keywordflow">case</span> 1:
<a name="l01006"></a>01006          *d = EDATA2;
<a name="l01007"></a>01007          <span class="keywordflow">break</span>;
<a name="l01008"></a>01008       <span class="keywordflow">case</span> 2:
<a name="l01009"></a>01009          *d = EDATA3;
<a name="l01010"></a>01010          <span class="keywordflow">break</span>;
<a name="l01011"></a>01011       <span class="keywordflow">case</span> 3:
<a name="l01012"></a>01012          *d = EDATA4;
<a name="l01013"></a>01013          <span class="keywordflow">break</span>;
<a name="l01014"></a>01014       }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016       ofs++;
<a name="l01017"></a>01017 
<a name="l01018"></a>01018       <span class="keywordflow">if</span> (ofs % 4 == 0) {
<a name="l01019"></a>01019          EADRL = ofs / 4;
<a name="l01020"></a>01020          ECON = 0x01;           <span class="comment">// read next page</span>
<a name="l01021"></a>01021       }
<a name="l01022"></a>01022    }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024    *offset = ofs;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026 <span class="preprocessor">#endif</span>
<a name="l01027"></a>01027 <span class="preprocessor"></span>
<a name="l01028"></a>01028 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l01029"></a>01029 <span class="preprocessor"></span>
<a name="l01030"></a>01030    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i;
<a name="l01031"></a>01031    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> code *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>;
<a name="l01032"></a>01032    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *d;
<a name="l01033"></a>01033 
<a name="l01034"></a>01034    <a class="code" href="embedded_2mscb_8h.html#a4ae5ad65c961268051560516eeff623f">watchdog_refresh</a>();
<a name="l01035"></a>01035 
<a name="l01036"></a>01036    p = <a class="code" href="embedded_2mscb_8h.html#afe7387252655a7ee07b26cb83c5ed0be">EEPROM_OFFSET</a> + *offset;        <span class="comment">// read from 128-byte EEPROM page</span>
<a name="l01037"></a>01037    d = dst;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039    <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
<a name="l01040"></a>01040       d[i] = p[i];
<a name="l01041"></a>01041 
<a name="l01042"></a>01042    *offset += len;
<a name="l01043"></a>01043 <span class="preprocessor">#endif</span>
<a name="l01044"></a>01044 <span class="preprocessor"></span>}
<a name="l01045"></a>01045 
<a name="l01046"></a>01046 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01047"></a>01047 
<a name="l01048"></a><a class="code" href="mscbutil_8c.html#afb0820d8d59068da0634c982eaeb9f8a">01048</a> <span class="keywordtype">void</span> <a class="code" href="mscbutil_8c.html#afb0820d8d59068da0634c982eaeb9f8a">eeprom_write</a>(<span class="keywordtype">void</span> * src, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> len, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *<a class="code" href="mgd_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a>)
<a name="l01049"></a>01049 <span class="comment">/********************************************************************\</span>
<a name="l01050"></a>01050 <span class="comment"></span>
<a name="l01051"></a>01051 <span class="comment">  Routine: eeprom_write</span>
<a name="l01052"></a>01052 <span class="comment"></span>
<a name="l01053"></a>01053 <span class="comment">  Purpose: Read from internal EEPROM</span>
<a name="l01054"></a>01054 <span class="comment"></span>
<a name="l01055"></a>01055 <span class="comment">  Input:</span>
<a name="l01056"></a>01056 <span class="comment">    unsigned char idata *src    Source in IDATA memory</span>
<a name="l01057"></a>01057 <span class="comment">    unsigned char len           Number of bytes to copy</span>
<a name="l01058"></a>01058 <span class="comment">    unsigend char offset        Offset in EEPROM in bytes, gets</span>
<a name="l01059"></a>01059 <span class="comment">                                adjusted after write</span>
<a name="l01060"></a>01060 <span class="comment"></span>
<a name="l01061"></a>01061 <span class="comment">\********************************************************************/</span>
<a name="l01062"></a>01062 {
<a name="l01063"></a>01063 <span class="preprocessor">#ifdef CPU_ADUC812</span>
<a name="l01064"></a>01064 <span class="preprocessor"></span>
<a name="l01065"></a>01065    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i, <a class="code" href="scs__400_8c.html#a04fe355a80e85e9f62a55b0a7cec6100">ofs</a>;
<a name="l01066"></a>01066    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068    d = src;
<a name="l01069"></a>01069 
<a name="l01070"></a>01070    ofs = *offset;
<a name="l01071"></a>01071    EADRL = ofs / 4;
<a name="l01072"></a>01072    ECON = 0x01;                 <span class="comment">// read page</span>
<a name="l01073"></a>01073 
<a name="l01074"></a>01074    <span class="keywordflow">for</span> (i = 0; i &lt; len; i++, d++) {
<a name="l01075"></a>01075       <span class="keywordflow">switch</span> (ofs % 4) {
<a name="l01076"></a>01076       <span class="keywordflow">case</span> 0:
<a name="l01077"></a>01077          EDATA1 = *d;
<a name="l01078"></a>01078          <span class="keywordflow">break</span>;
<a name="l01079"></a>01079       <span class="keywordflow">case</span> 1:
<a name="l01080"></a>01080          EDATA2 = *d;
<a name="l01081"></a>01081          <span class="keywordflow">break</span>;
<a name="l01082"></a>01082       <span class="keywordflow">case</span> 2:
<a name="l01083"></a>01083          EDATA3 = *d;
<a name="l01084"></a>01084          <span class="keywordflow">break</span>;
<a name="l01085"></a>01085       <span class="keywordflow">case</span> 3:
<a name="l01086"></a>01086          EDATA4 = *d;
<a name="l01087"></a>01087          ECON = 0x02;           <span class="comment">// write page</span>
<a name="l01088"></a>01088          <span class="keywordflow">break</span>;
<a name="l01089"></a>01089       }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091       ofs++;
<a name="l01092"></a>01092 
<a name="l01093"></a>01093       <span class="keywordflow">if</span> (ofs % 4 == 0) {
<a name="l01094"></a>01094          EADRL = ofs / 4;
<a name="l01095"></a>01095          ECON = 0x01;           <span class="comment">// read next page</span>
<a name="l01096"></a>01096       }
<a name="l01097"></a>01097    }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099    <span class="keywordflow">if</span> (ofs % 4 != 0)
<a name="l01100"></a>01100       ECON = 0x02;              <span class="comment">// write last page</span>
<a name="l01101"></a>01101 
<a name="l01102"></a>01102    *offset = ofs;
<a name="l01103"></a>01103 
<a name="l01104"></a>01104 <span class="preprocessor">#endif</span>
<a name="l01105"></a>01105 <span class="preprocessor"></span>
<a name="l01106"></a>01106 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l01107"></a>01107 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> xdata *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>;      <span class="comment">// xdata pointer causes MOVX command</span>
<a name="l01108"></a>01108    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i, b;
<a name="l01109"></a>01109    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *s;
<a name="l01110"></a>01110 
<a name="l01111"></a>01111    <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aab1037491179d86a89ac750947c0b1f1">_flkey</a> != 0xF1)
<a name="l01112"></a>01112       <span class="keywordflow">return</span>;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114    <a class="code" href="embedded_2mscb_8h.html#a3b37db44db50722cac572660028ba2b5">DISABLE_INTERRUPTS</a>;
<a name="l01115"></a>01115 
<a name="l01116"></a>01116 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01117"></a>01117 <span class="preprocessor"></span>   <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a8118771b603f497803d635449ba11021">LEGACY_PAGE</a>;
<a name="l01118"></a>01118 <span class="preprocessor">#endif</span>
<a name="l01119"></a>01119 <span class="preprocessor"></span>
<a name="l01120"></a>01120 <span class="preprocessor">#if defined(CPU_C8051F000)</span>
<a name="l01121"></a>01121 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = (<a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> &amp; 0xF0) | 0x08;  <span class="comment">// set timer for 11.052 MHz clock</span>
<a name="l01122"></a>01122 <span class="preprocessor">#elif defined(CPU_C8051F020) || defined(CPU_C8051F120)</span>
<a name="l01123"></a>01123 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> | 1;           <span class="comment">// enable flash writes</span>
<a name="l01124"></a>01124 <span class="preprocessor">#endif</span>
<a name="l01125"></a>01125 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#ab962028f8eb562297e7b38d7806ba21c">PSCTL</a> = 0x01;                <span class="comment">// allow write</span>
<a name="l01126"></a>01126 
<a name="l01127"></a>01127    p = <a class="code" href="embedded_2mscb_8h.html#afe7387252655a7ee07b26cb83c5ed0be">EEPROM_OFFSET</a> + *offset;
<a name="l01128"></a>01128    s = src;
<a name="l01129"></a>01129 
<a name="l01130"></a>01130    <span class="keywordflow">for</span> (i = 0; i &lt; len; i++) {  <span class="comment">// write data</span>
<a name="l01131"></a>01131       b = *s++;
<a name="l01132"></a>01132 
<a name="l01133"></a>01133 <span class="preprocessor">#if defined(CPU_C8051F310) || defined(CPU_C8051F320)</span>
<a name="l01134"></a>01134 <span class="preprocessor"></span>      <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = 0xA5;             <span class="comment">// write flash key code</span>
<a name="l01135"></a>01135       <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = <a class="code" href="mscbmain_8c.html#aab1037491179d86a89ac750947c0b1f1">_flkey</a>;
<a name="l01136"></a>01136 <span class="preprocessor">#endif</span>
<a name="l01137"></a>01137 <span class="preprocessor"></span>
<a name="l01138"></a>01138       *p++ = b;
<a name="l01139"></a>01139    }
<a name="l01140"></a>01140 
<a name="l01141"></a>01141    <a class="code" href="c8051F000_8h.html#ab962028f8eb562297e7b38d7806ba21c">PSCTL</a> = 0x00;                <span class="comment">// don&apos;t allow write</span>
<a name="l01142"></a>01142    <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> &amp; 0xF0;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144    *offset += len;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146    <a class="code" href="embedded_2mscb_8h.html#a62b74068f303c78492667e69fe203914">ENABLE_INTERRUPTS</a>;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148    <a class="code" href="embedded_2mscb_8h.html#a4ae5ad65c961268051560516eeff623f">watchdog_refresh</a>();
<a name="l01149"></a>01149 <span class="preprocessor">#endif</span>
<a name="l01150"></a>01150 <span class="preprocessor"></span>}
<a name="l01151"></a>01151 
<a name="l01152"></a>01152 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01153"></a>01153 
<a name="l01154"></a><a class="code" href="mscbutil_8c.html#a4958eaf323fa57ef8650477a2571898b">01154</a> <span class="keywordtype">void</span> <a class="code" href="mscbutil_8c.html#a4958eaf323fa57ef8650477a2571898b">eeprom_erase</a>(<span class="keywordtype">void</span>)
<a name="l01155"></a>01155 <span class="comment">/********************************************************************\</span>
<a name="l01156"></a>01156 <span class="comment"></span>
<a name="l01157"></a>01157 <span class="comment">  Routine: eeprom_erase</span>
<a name="l01158"></a>01158 <span class="comment"></span>
<a name="l01159"></a>01159 <span class="comment">  Purpose: Erase parameter EEPROM page</span>
<a name="l01160"></a>01160 <span class="comment"></span>
<a name="l01161"></a>01161 <span class="comment">\********************************************************************/</span>
<a name="l01162"></a>01162 {
<a name="l01163"></a>01163 <span class="preprocessor">#ifdef CPU_ADUC812</span>
<a name="l01164"></a>01164 <span class="preprocessor"></span>   ECON = 0x06;
<a name="l01165"></a>01165 <span class="preprocessor">#endif</span>
<a name="l01166"></a>01166 <span class="preprocessor"></span>
<a name="l01167"></a>01167 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l01168"></a>01168 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> xdata *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>;
<a name="l01169"></a>01169 
<a name="l01170"></a>01170    <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aab1037491179d86a89ac750947c0b1f1">_flkey</a> != 0xF1)
<a name="l01171"></a>01171       <span class="keywordflow">return</span>;
<a name="l01172"></a>01172 
<a name="l01173"></a>01173    <a class="code" href="embedded_2mscb_8h.html#a3b37db44db50722cac572660028ba2b5">DISABLE_INTERRUPTS</a>;
<a name="l01174"></a>01174 
<a name="l01175"></a>01175 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01176"></a>01176 <span class="preprocessor"></span>   <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a8118771b603f497803d635449ba11021">LEGACY_PAGE</a>;
<a name="l01177"></a>01177 <span class="preprocessor">#endif</span>
<a name="l01178"></a>01178 <span class="preprocessor"></span>
<a name="l01179"></a>01179 <span class="preprocessor">#if defined(CPU_C8051F000)</span>
<a name="l01180"></a>01180 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = (<a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> &amp; 0xF0) | 0x08;       <span class="comment">// set timer for 11.052 MHz clock</span>
<a name="l01181"></a>01181 <span class="preprocessor">#elif defined(CPU_C8051F020) || defined(CPU_C8051F120)</span>
<a name="l01182"></a>01182 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> | 1;                   <span class="comment">// enable flash writes</span>
<a name="l01183"></a>01183 <span class="preprocessor">#endif</span>
<a name="l01184"></a>01184 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#ab962028f8eb562297e7b38d7806ba21c">PSCTL</a> = 0x03;                        <span class="comment">// allow write and erase</span>
<a name="l01185"></a>01185 
<a name="l01186"></a>01186 <span class="preprocessor">#if defined(CPU_C8051F310) || defined(CPU_C8051F320)</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span>   p = <a class="code" href="embedded_2mscb_8h.html#afe7387252655a7ee07b26cb83c5ed0be">EEPROM_OFFSET</a>;                   <span class="comment">// erase first page</span>
<a name="l01188"></a>01188    <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = 0xA5;                        <span class="comment">// write flash key code</span>
<a name="l01189"></a>01189    <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = <a class="code" href="mscbmain_8c.html#aab1037491179d86a89ac750947c0b1f1">_flkey</a>;
<a name="l01190"></a>01190    *p = 0;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 <span class="comment">// Following code crashed the uC !</span>
<a name="l01193"></a>01193 
<a name="l01194"></a>01194 <span class="comment">//   p = EEPROM_OFFSET+512;               // erase second page</span>
<a name="l01195"></a>01195 <span class="comment">//   FLKEY = 0xA5;                        // write flash key code</span>
<a name="l01196"></a>01196 <span class="comment">//   FLKEY = 0xF1;</span>
<a name="l01197"></a>01197 <span class="comment">//   *p = 0;</span>
<a name="l01198"></a>01198 <span class="preprocessor">#else</span>
<a name="l01199"></a>01199 <span class="preprocessor"></span>   p = <a class="code" href="embedded_2mscb_8h.html#afe7387252655a7ee07b26cb83c5ed0be">EEPROM_OFFSET</a>;                   <span class="comment">// erase page</span>
<a name="l01200"></a>01200    *p = 0;
<a name="l01201"></a>01201 <span class="preprocessor">#endif</span>
<a name="l01202"></a>01202 <span class="preprocessor"></span>
<a name="l01203"></a>01203    <a class="code" href="c8051F000_8h.html#ab962028f8eb562297e7b38d7806ba21c">PSCTL</a> = 0x00;                        <span class="comment">// don&apos;t allow write</span>
<a name="l01204"></a>01204    <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> &amp; 0xF0;
<a name="l01205"></a>01205 <span class="preprocessor">#endif</span>
<a name="l01206"></a>01206 <span class="preprocessor"></span>
<a name="l01207"></a>01207   <a class="code" href="embedded_2mscb_8h.html#a62b74068f303c78492667e69fe203914">ENABLE_INTERRUPTS</a>;
<a name="l01208"></a>01208 }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01211"></a>01211 
<a name="l01212"></a><a class="code" href="mscbutil_8c.html#a29eb7958d7590c990a4be07ccb7f9199">01212</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a29eb7958d7590c990a4be07ccb7f9199">eeprom_flash</a>(<span class="keywordtype">void</span>)
<a name="l01213"></a>01213 <span class="comment">/********************************************************************\</span>
<a name="l01214"></a>01214 <span class="comment"></span>
<a name="l01215"></a>01215 <span class="comment">  Routine: eeprom_flash</span>
<a name="l01216"></a>01216 <span class="comment"></span>
<a name="l01217"></a>01217 <span class="comment">  Purpose: Write system and user parameters to EEPROM</span>
<a name="l01218"></a>01218 <span class="comment"></span>
<a name="l01219"></a>01219 <span class="comment">\********************************************************************/</span>
<a name="l01220"></a>01220 {
<a name="l01221"></a>01221    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i, adr;
<a name="l01222"></a>01222    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> magic, <a class="code" href="mgd_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a>;
<a name="l01223"></a>01223 
<a name="l01224"></a>01224    <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(3, 3, 50);
<a name="l01225"></a>01225 
<a name="l01226"></a>01226    <a class="code" href="mscbutil_8c.html#a4958eaf323fa57ef8650477a2571898b">eeprom_erase</a>();
<a name="l01227"></a>01227 
<a name="l01228"></a>01228    offset = 0;
<a name="l01229"></a>01229 
<a name="l01230"></a>01230    <span class="comment">// system info (node address etc...)</span>
<a name="l01231"></a>01231    <a class="code" href="mscbutil_8c.html#afb0820d8d59068da0634c982eaeb9f8a">eeprom_write</a>(&amp;sys_info, <span class="keyword">sizeof</span>(<a class="code" href="structSYS__INFO.html">SYS_INFO</a>), &amp;offset);
<a name="l01232"></a>01232 
<a name="l01233"></a>01233    <span class="comment">// user channel variables</span>
<a name="l01234"></a>01234    <span class="keywordflow">for</span> (adr = 0 ; adr &lt; <a class="code" href="hvr__200_8c.html#a7aa4e7d188b6702a7e5e361e85731948">_n_sub_addr</a> ; adr++)
<a name="l01235"></a>01235       <span class="keywordflow">for</span> (i = 0; <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a>; i++)
<a name="l01236"></a>01236          <a class="code" href="mscbutil_8c.html#afb0820d8d59068da0634c982eaeb9f8a">eeprom_write</a>((<span class="keywordtype">char</span> *)<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].ud + <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>*adr, 
<a name="l01237"></a>01237                       <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="mainWindow_8cpp.html#a2474a5474cbff19523a51eb1de01cda4">width</a>, &amp;offset);
<a name="l01238"></a>01238 
<a name="l01239"></a>01239    <span class="comment">// magic</span>
<a name="l01240"></a>01240    magic = 0x1234;
<a name="l01241"></a>01241    <a class="code" href="mscbutil_8c.html#afb0820d8d59068da0634c982eaeb9f8a">eeprom_write</a>(&amp;magic, 2, &amp;offset);
<a name="l01242"></a>01242 
<a name="l01243"></a>01243    <a class="code" href="mscbmain_8c.html#aab1037491179d86a89ac750947c0b1f1">_flkey</a> = 0;
<a name="l01244"></a>01244 }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01247"></a>01247 
<a name="l01248"></a><a class="code" href="mscbutil_8c.html#a1cde349ab9feb3cfbd44e1555cb2304b">01248</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="embedded_2mscb_8h.html#a1cde349ab9feb3cfbd44e1555cb2304b">eeprom_retrieve</a>(<span class="keywordtype">void</span>)
<a name="l01249"></a>01249 <span class="comment">/********************************************************************\</span>
<a name="l01250"></a>01250 <span class="comment"></span>
<a name="l01251"></a>01251 <span class="comment">  Routine: eeprom_retrieve</span>
<a name="l01252"></a>01252 <span class="comment"></span>
<a name="l01253"></a>01253 <span class="comment">  Purpose: Retrieve system and user parameters from EEPROM</span>
<a name="l01254"></a>01254 <span class="comment"></span>
<a name="l01255"></a>01255 <span class="comment">\********************************************************************/</span>
<a name="l01256"></a>01256 {
<a name="l01257"></a>01257    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i, adr;
<a name="l01258"></a>01258    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> magic, <a class="code" href="mgd_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a>;
<a name="l01259"></a>01259 
<a name="l01260"></a>01260    offset = 0;
<a name="l01261"></a>01261 
<a name="l01262"></a>01262    <span class="comment">// system info (node address etc...)</span>
<a name="l01263"></a>01263    <a class="code" href="mscbutil_8c.html#a4f506741016eb2f2aa4820d0f1b07f0a">eeprom_read</a>(&amp;sys_info, <span class="keyword">sizeof</span>(<a class="code" href="structSYS__INFO.html">SYS_INFO</a>), &amp;offset);
<a name="l01264"></a>01264 
<a name="l01265"></a>01265    <span class="comment">// user channel variables</span>
<a name="l01266"></a>01266    <span class="keywordflow">for</span> (adr = 0 ; adr &lt; <a class="code" href="hvr__200_8c.html#a7aa4e7d188b6702a7e5e361e85731948">_n_sub_addr</a> ; adr++)
<a name="l01267"></a>01267       <span class="keywordflow">for</span> (i = 0; <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a>; i++)
<a name="l01268"></a>01268          <a class="code" href="mscbutil_8c.html#a4f506741016eb2f2aa4820d0f1b07f0a">eeprom_read</a>((<span class="keywordtype">char</span> *)<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].ud + <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>*adr, 
<a name="l01269"></a>01269                      <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="mainWindow_8cpp.html#a2474a5474cbff19523a51eb1de01cda4">width</a>, &amp;offset);
<a name="l01270"></a>01270 
<a name="l01271"></a>01271    <span class="comment">// check for magic</span>
<a name="l01272"></a>01272    <a class="code" href="mscbutil_8c.html#a4f506741016eb2f2aa4820d0f1b07f0a">eeprom_read</a>(&amp;magic, 2, &amp;offset);
<a name="l01273"></a>01273 
<a name="l01274"></a>01274    <span class="keywordflow">return</span> (magic == 0x1234);
<a name="l01275"></a>01275 }
<a name="l01276"></a>01276 
<a name="l01277"></a>01277 <span class="preprocessor">#endif </span><span class="comment">/* EEPROM_SUPPORT */</span>
<a name="l01278"></a>01278 
<a name="l01279"></a>01279 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01280"></a>01280 
<a name="l01281"></a>01281 <span class="preprocessor">#ifdef LCD_SUPPORT</span>
<a name="l01282"></a>01282 <span class="preprocessor"></span>
<a name="l01283"></a><a class="code" href="mscbutil_8c.html#ad5b44f63b60e3b566a81dfdc699a4667">01283</a> bit <a class="code" href="mscbmain_8c.html#ad5b44f63b60e3b566a81dfdc699a4667">lcd_present</a>;
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 <span class="comment">/********************************************************************\</span>
<a name="l01286"></a>01286 <span class="comment"></span>
<a name="l01287"></a>01287 <span class="comment">  Routine: lcd_setup, lcd_clear, lcd_goto, lcd_puts, putchar</span>
<a name="l01288"></a>01288 <span class="comment"></span>
<a name="l01289"></a>01289 <span class="comment">  Purpose: LCD functions for HD44780/KS0066 compatible LCD displays</span>
<a name="l01290"></a>01290 <span class="comment"></span>
<a name="l01291"></a>01291 <span class="comment">           Since putchar is used by printf, this function puts its</span>
<a name="l01292"></a>01292 <span class="comment">           output to the LCD as well</span>
<a name="l01293"></a>01293 <span class="comment"></span>
<a name="l01294"></a>01294 <span class="comment">\********************************************************************/</span>
<a name="l01295"></a>01295 
<a name="l01296"></a>01296 <span class="preprocessor">#define LCD P2                  // LCD display connected to port2</span>
<a name="l01297"></a>01297 <span class="preprocessor"></span>
<a name="l01298"></a>01298 <span class="preprocessor">#ifdef SCS_1000</span>
<a name="l01299"></a><a class="code" href="mscbutil_8c.html#a5799edeaf5ede6c962f8eda9922bfd00">01299</a> <span class="preprocessor"></span>sbit <a class="code" href="mscbutil_8c.html#a5799edeaf5ede6c962f8eda9922bfd00">LCD_RS</a>  = LCD ^ 3;
<a name="l01300"></a><a class="code" href="mscbutil_8c.html#a9b8230ce63fa3e2ff3ae49fa4cda3315">01300</a> sbit <a class="code" href="mscbutil_8c.html#a9b8230ce63fa3e2ff3ae49fa4cda3315">LCD_R_W</a> = LCD ^ 2;
<a name="l01301"></a><a class="code" href="mscbutil_8c.html#abb53da0da8a6db186d596b1516a04914">01301</a> sbit <a class="code" href="mscbutil_8c.html#abb53da0da8a6db186d596b1516a04914">LCD_E</a>   = LCD ^ 1;
<a name="l01302"></a>01302 <span class="preprocessor">#else</span>
<a name="l01303"></a>01303 <span class="preprocessor"></span>sbit LCD_RS  = LCD ^ 1;
<a name="l01304"></a>01304 sbit LCD_R_W = LCD ^ 2;
<a name="l01305"></a>01305 sbit LCD_E   = LCD ^ 3;
<a name="l01306"></a>01306 <span class="preprocessor">#endif</span>
<a name="l01307"></a>01307 <span class="preprocessor"></span>
<a name="l01308"></a><a class="code" href="mscbutil_8c.html#a6f7b8910ae79d80979e7fdc7c3447287">01308</a> sbit <a class="code" href="mscbutil_8c.html#a6f7b8910ae79d80979e7fdc7c3447287">LCD_DB4</a> = LCD ^ 4;
<a name="l01309"></a><a class="code" href="mscbutil_8c.html#a774e99ef68469e849e9059e62309dbeb">01309</a> sbit <a class="code" href="mscbutil_8c.html#a774e99ef68469e849e9059e62309dbeb">LCD_DB5</a> = LCD ^ 5;
<a name="l01310"></a><a class="code" href="mscbutil_8c.html#aca1000c839f92de6ac3cd5846e1a195c">01310</a> sbit <a class="code" href="mscbutil_8c.html#aca1000c839f92de6ac3cd5846e1a195c">LCD_DB6</a> = LCD ^ 6;
<a name="l01311"></a><a class="code" href="mscbutil_8c.html#a63d732b925d0134c93fc7e6ac58e9549">01311</a> sbit <a class="code" href="mscbutil_8c.html#a63d732b925d0134c93fc7e6ac58e9549">LCD_DB7</a> = LCD ^ 7;
<a name="l01312"></a>01312 
<a name="l01313"></a><a class="code" href="mscbutil_8c.html#a4bbf31031a6c2ee149fbd20038d8a542">01313</a> sbit <a class="code" href="mscbutil_8c.html#a4bbf31031a6c2ee149fbd20038d8a542">LCD_CLK</a> = LCD ^ 7;         <span class="comment">// pins for 4021 shift register</span>
<a name="l01314"></a><a class="code" href="mscbutil_8c.html#ac30b2cf84feb88b655161a764b11dab3">01314</a> sbit <a class="code" href="mscbutil_8c.html#ac30b2cf84feb88b655161a764b11dab3">LCD_P_W</a> = LCD ^ 6;
<a name="l01315"></a><a class="code" href="mscbutil_8c.html#a7117615912fe1f6414d18e528a4fbb3d">01315</a> sbit <a class="code" href="mscbutil_8c.html#a7117615912fe1f6414d18e528a4fbb3d">LCD_SD</a>  = LCD ^ 0;
<a name="l01316"></a>01316 
<a name="l01317"></a>01317 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01318"></a>01318 
<a name="l01319"></a><a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">01319</a> <a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">lcd_out</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, bit df)
<a name="l01320"></a>01320 {
<a name="l01321"></a>01321    <span class="keywordflow">if</span> (!lcd_present)
<a name="l01322"></a>01322       <span class="keywordflow">return</span>;
<a name="l01323"></a>01323 
<a name="l01324"></a>01324    LCD = LCD | 0xF0;            <span class="comment">// data input</span>
<a name="l01325"></a>01325    <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a14aacb99e01e6ed91f888acd07fcf7a9">CONFIG_PAGE</a>;
<a name="l01326"></a>01326    <a class="code" href="c8051F020_8h.html#a6608f51dd6960523e066aff4616cd407">P2MDOUT</a> = 0x0F;
<a name="l01327"></a>01327    LCD_RS = 0;                  <span class="comment">// select BF        </span>
<a name="l01328"></a>01328    LCD_R_W = 1;
<a name="l01329"></a>01329    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01330"></a>01330    LCD_E = 1;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(10);                <span class="comment">// let signals settle</span>
<a name="l01333"></a>01333    <span class="keywordflow">while</span> (LCD_DB7);             <span class="comment">// loop if busy</span>
<a name="l01334"></a>01334 
<a name="l01335"></a>01335    LCD_E = 0;
<a name="l01336"></a>01336    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01337"></a>01337    LCD_R_W = 0;
<a name="l01338"></a>01338    <a class="code" href="c8051F020_8h.html#a6608f51dd6960523e066aff4616cd407">P2MDOUT</a> = 0xFF;              <span class="comment">// data output</span>
<a name="l01339"></a>01339    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01340"></a>01340 
<a name="l01341"></a>01341    <span class="comment">/* high nibble, preserve P0.0 */</span>
<a name="l01342"></a>01342    LCD = (LCD &amp; 0x01) | (d &amp; 0xF0);
<a name="l01343"></a>01343    LCD_RS = df;
<a name="l01344"></a>01344    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01345"></a>01345 
<a name="l01346"></a>01346    LCD_E = 1;
<a name="l01347"></a>01347    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01348"></a>01348    LCD_E = 0;
<a name="l01349"></a>01349    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01350"></a>01350 
<a name="l01351"></a>01351    <span class="comment">/* now nibble */</span>
<a name="l01352"></a>01352    LCD = (LCD &amp; 0x01) | ((d &lt;&lt; 4) &amp; 0xF0);
<a name="l01353"></a>01353    LCD_RS = df;
<a name="l01354"></a>01354    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01355"></a>01355 
<a name="l01356"></a>01356    LCD_E = 1;
<a name="l01357"></a>01357    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01358"></a>01358    LCD_E = 0;
<a name="l01359"></a>01359    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01360"></a>01360 }
<a name="l01361"></a>01361 
<a name="l01362"></a>01362 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01363"></a>01363 
<a name="l01364"></a><a class="code" href="mscbutil_8c.html#a9468c1be5dc5602e17d2a5dd2a9fed8d">01364</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a9468c1be5dc5602e17d2a5dd2a9fed8d">lcd_setup</a>()
<a name="l01365"></a>01365 {
<a name="l01366"></a>01366    <span class="keywordtype">unsigned</span> i=0;
<a name="l01367"></a>01367 
<a name="l01368"></a>01368    <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a14aacb99e01e6ed91f888acd07fcf7a9">CONFIG_PAGE</a>;
<a name="l01369"></a>01369    <a class="code" href="c8051F020_8h.html#a6608f51dd6960523e066aff4616cd407">P2MDOUT</a> = 0xFF;
<a name="l01370"></a>01370 
<a name="l01371"></a>01371    LCD &amp;= ~(0xFE);
<a name="l01372"></a>01372    <a class="code" href="embedded_2mscb_8h.html#af29c4657f62375d42c6ee104b6bf4491">delay_ms</a>(15);
<a name="l01373"></a>01373    LCD |= 0x30;
<a name="l01374"></a>01374 
<a name="l01375"></a>01375    LCD_E = 1;
<a name="l01376"></a>01376    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01377"></a>01377    LCD_E = 0;
<a name="l01378"></a>01378    <a class="code" href="embedded_2mscb_8h.html#af29c4657f62375d42c6ee104b6bf4491">delay_ms</a>(5);
<a name="l01379"></a>01379 
<a name="l01380"></a>01380    LCD_E = 1;
<a name="l01381"></a>01381    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01382"></a>01382    LCD_E = 0;
<a name="l01383"></a>01383    <a class="code" href="embedded_2mscb_8h.html#af29c4657f62375d42c6ee104b6bf4491">delay_ms</a>(1);
<a name="l01384"></a>01384 
<a name="l01385"></a>01385    LCD_E = 1;
<a name="l01386"></a>01386    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01387"></a>01387    LCD_E = 0;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389    LCD = 0x20;                  <span class="comment">// set 4-bit interface</span>
<a name="l01390"></a>01390    LCD_E = 1;
<a name="l01391"></a>01391    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01392"></a>01392    LCD_E = 0;
<a name="l01393"></a>01393 
<a name="l01394"></a>01394    <span class="comment">/* test if LCD present */</span>
<a name="l01395"></a>01395 
<a name="l01396"></a>01396    LCD = LCD | 0xF0;            <span class="comment">// data input</span>
<a name="l01397"></a>01397    <a class="code" href="c8051F020_8h.html#a6608f51dd6960523e066aff4616cd407">P2MDOUT</a> = 0x0F;              
<a name="l01398"></a>01398    LCD_RS = 0;                  <span class="comment">// select BF        </span>
<a name="l01399"></a>01399    LCD_R_W = 1;
<a name="l01400"></a>01400    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(1);
<a name="l01401"></a>01401    LCD_E = 1;
<a name="l01402"></a>01402    <a class="code" href="embedded_2mscb_8h.html#a84f652539f41e435c3b08e023d3ba0dd">delay_us</a>(100);               <span class="comment">// let signal settle</span>
<a name="l01403"></a>01403    <span class="keywordflow">if</span> (LCD_DB7) {
<a name="l01404"></a>01404       lcd_present = 0;
<a name="l01405"></a>01405       <span class="keywordflow">return</span>;
<a name="l01406"></a>01406    }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408    lcd_present = 1;
<a name="l01409"></a>01409 
<a name="l01410"></a>01410    <a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">lcd_out</a>(0x2C, 0);            <span class="comment">// select 2 lines, big font</span>
<a name="l01411"></a>01411    <a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">lcd_out</a>(0x0C, 0);            <span class="comment">// display on</span>
<a name="l01412"></a>01412    <a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">lcd_out</a>(0x01, 0);            <span class="comment">// clear display</span>
<a name="l01413"></a>01413    <a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">lcd_out</a>(0x06, 0);            <span class="comment">// entry mode</span>
<a name="l01414"></a>01414 }
<a name="l01415"></a>01415 
<a name="l01416"></a>01416 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01417"></a>01417 
<a name="l01418"></a><a class="code" href="mscbutil_8c.html#a35c08b1fa742e650f4873939707b893b">01418</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a35c08b1fa742e650f4873939707b893b">lcd_clear</a>()
<a name="l01419"></a>01419 {
<a name="l01420"></a>01420    <a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">lcd_out</a>(0x01, 0);
<a name="l01421"></a>01421    <a class="code" href="embedded_2mscb_8h.html#adaf2d117fc7b2fb397acd51a28baba7b">lcd_goto</a>(0, 0);
<a name="l01422"></a>01422 }
<a name="l01423"></a>01423 
<a name="l01424"></a>01424 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01425"></a>01425 
<a name="l01426"></a><a class="code" href="mscbutil_8c.html#adaf2d117fc7b2fb397acd51a28baba7b">01426</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#adaf2d117fc7b2fb397acd51a28baba7b">lcd_goto</a>(<span class="keywordtype">char</span> x, <span class="keywordtype">char</span> y)
<a name="l01427"></a>01427 {
<a name="l01428"></a>01428    <span class="comment">/* goto position x(0..19), y(0..1) */</span>
<a name="l01429"></a>01429 
<a name="l01430"></a>01430    <a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">lcd_out</a>((x &amp; 0x0F) | (0x80) | ((y &amp; 0x01) &lt;&lt; 6), 0);
<a name="l01431"></a>01431 }
<a name="l01432"></a>01432 
<a name="l01433"></a>01433 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01434"></a>01434 
<a name="l01435"></a><a class="code" href="mscbutil_8c.html#a44a1bacb4c1429ca87f81505dea70451">01435</a> <span class="keywordtype">char</span> <a class="code" href="mscbutil_8c.html#a44a1bacb4c1429ca87f81505dea70451">putchar</a>(<span class="keywordtype">char</span> c)
<a name="l01436"></a>01436 {
<a name="l01437"></a>01437    <span class="keywordflow">if</span> (c &gt;= <span class="charliteral">&apos; &apos;</span>)
<a name="l01438"></a>01438       <a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">lcd_out</a>(c, 1);
<a name="l01439"></a>01439    <span class="keywordflow">return</span> c;
<a name="l01440"></a>01440 }
<a name="l01441"></a>01441 
<a name="l01442"></a>01442 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01443"></a>01443 
<a name="l01444"></a><a class="code" href="mscbutil_8c.html#a07820d8874b23ab3da0752f15ac626f2">01444</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a07820d8874b23ab3da0752f15ac626f2">lcd_puts</a>(<span class="keywordtype">char</span> *str)
<a name="l01445"></a>01445 {
<a name="l01446"></a>01446    <span class="keywordflow">while</span> (*str)
<a name="l01447"></a>01447       <a class="code" href="mscbutil_8c.html#a8caf2cbed521975107e5c7aa49a99119">lcd_out</a>(*str++, 1);
<a name="l01448"></a>01448 }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450 <span class="comment">/********************************************************************\</span>
<a name="l01451"></a>01451 <span class="comment"></span>
<a name="l01452"></a>01452 <span class="comment">  Routine: scs_lcd1_read</span>
<a name="l01453"></a>01453 <span class="comment"></span>
<a name="l01454"></a>01454 <span class="comment">  Purpose: Returns switch (button) state of SCS-LCD1 module</span>
<a name="l01455"></a>01455 <span class="comment"></span>
<a name="l01456"></a>01456 <span class="comment">\********************************************************************/</span>
<a name="l01457"></a>01457 
<a name="l01458"></a>01458 <span class="comment">/*</span>
<a name="l01459"></a>01459 <span class="comment">char scs_lcd1_read()</span>
<a name="l01460"></a>01460 <span class="comment">{</span>
<a name="l01461"></a>01461 <span class="comment">char i, d;</span>
<a name="l01462"></a>01462 <span class="comment"></span>
<a name="l01463"></a>01463 <span class="comment">  LCD_CLK = 0;  // enable input</span>
<a name="l01464"></a>01464 <span class="comment">  LCD_SD = 1;</span>
<a name="l01465"></a>01465 <span class="comment"></span>
<a name="l01466"></a>01466 <span class="comment">  LCD_P_W = 1;  // latch input</span>
<a name="l01467"></a>01467 <span class="comment">  delay_us(1);</span>
<a name="l01468"></a>01468 <span class="comment">  LCD_P_W = 0;</span>
<a name="l01469"></a>01469 <span class="comment"></span>
<a name="l01470"></a>01470 <span class="comment">  for (i=d=0 ; i&lt;8 ; i++)</span>
<a name="l01471"></a>01471 <span class="comment">    {</span>
<a name="l01472"></a>01472 <span class="comment">    d |= LCD_SD;</span>
<a name="l01473"></a>01473 <span class="comment">    d = (d | LCD_SD) &lt;&lt; 1;</span>
<a name="l01474"></a>01474 <span class="comment"></span>
<a name="l01475"></a>01475 <span class="comment">    LCD_CLK = 1;</span>
<a name="l01476"></a>01476 <span class="comment">    delay_us(1);</span>
<a name="l01477"></a>01477 <span class="comment">    LCD_CLK = 0;</span>
<a name="l01478"></a>01478 <span class="comment">    delay_us(1);</span>
<a name="l01479"></a>01479 <span class="comment">    }</span>
<a name="l01480"></a>01480 <span class="comment"></span>
<a name="l01481"></a>01481 <span class="comment">  return d;</span>
<a name="l01482"></a>01482 <span class="comment">}</span>
<a name="l01483"></a>01483 <span class="comment">*/</span>
<a name="l01484"></a>01484 
<a name="l01485"></a>01485 <span class="preprocessor">#endif</span>
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
