<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ:Rootana: Midas Buffer Manager Functions (bm_xxx)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>Midas Buffer Manager Functions (bm_xxx)<br/>
<small>
[<a class="el" href="group__midasincludecode.html">The midas.h &amp; midas.c</a>]</small>
</h1><table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structEVENT__DEFRAG__BUFFER.html">EVENT_DEFRAG_BUFFER</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga2ea1598024ac2528f65b6ba55526bd85">MAX_DEFRAG_EVENTS</a>&nbsp;&nbsp;&nbsp;10</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga181dcf462745127aa3d011a2e3fee805">bm_match_event</a> (short int <a class="el" href="mzdump_8c.html#ac6d03005c20c7feabe0b6be6902f0a5e">event_id</a>, short int trigger_mask, <a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#gae9636ff3e34ee94e31cb292bd07a679d">bm_open_buffer</a> (char *<a class="el" href="mevb_8c.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> <a class="el" href="mlogger_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> *buffer_handle)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga7b2cbde6caa572dfc978c780d63ab6be">bm_close_buffer</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_handle)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga3a2dae045156606fc157e01a82983a25">bm_close_all_buffers</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga2689ca85c6d0023f1a02e6827a5eff6e">bm_set_cache_size</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_handle, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> read_size, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> write_size)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#gac5e3e469fb6721a502ebd80a35a328f5">bm_compose_event</a> (<a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *event_header, short int <a class="el" href="mzdump_8c.html#ac6d03005c20c7feabe0b6be6902f0a5e">event_id</a>, short int trigger_mask, <a class="el" href="odbhist_8c.html#a798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="el" href="slowcontrol_2vacuum__sensor_2frontend_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>, <a class="el" href="odbhist_8c.html#a798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="el" href="ybos_8c.html#a6a8acf68abbb7dcd70621347ae840581">serial</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#gadca0488d73a8c1e9a420573c656f55f8">bm_add_event_request</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_handle, short int <a class="el" href="mzdump_8c.html#ac6d03005c20c7feabe0b6be6902f0a5e">event_id</a>, short int trigger_mask, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> sampling_type, void(*func)(<a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *, void *), <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> request_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#gabf663d96482aeede1846487a7ada8184">bm_request_event</a> (<a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> buffer_handle, short int <a class="el" href="mzdump_8c.html#ac6d03005c20c7feabe0b6be6902f0a5e">event_id</a>, short int trigger_mask, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> sampling_type, <a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> *request_id, void(*func)(<a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *, void *))</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga7810d29ac3894a4e299737bc7c7a2cf1">bm_remove_event_request</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_handle, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> request_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga33221a55f8c90e411dea5eb34a2ee773">bm_delete_request</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> request_id)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga499b14a246f8ab8d5a3b6ec77bfa9407">bm_send_event</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_handle, void *source, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buf_size, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> async_flag)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga9b74b8aa633c942682e642acba93c51d">bm_flush_cache</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_handle, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> async_flag)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga2fd8bb52ad5282be3ce076e84bc007fa">bm_receive_event</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_handle, void *destination, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> *buf_size, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> async_flag)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga4a12567d843b2e1d20da58d8abfabb04">bm_skip_event</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_handle)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#gabcc6bb732b720fcc3ffe859f732a07e0">bm_push_event</a> (char *<a class="el" href="mevb_8c.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga6f72d4840fd9ca14a9864252fe5d8b3a">bm_check_buffers</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#gad5d9446689e7764c046be255a63662c0">bm_mark_read_waiting</a> (<a class="el" href="odbhist_8c.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> <a class="el" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga1aa8d2711c26626d76e52715c9a568d0">bm_notify_client</a> (char *<a class="el" href="mevb_8c.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>, int socket)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga77879d61a226e3f59497cbb3c9cb8b55">bm_poll_event</a> (<a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> <a class="el" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga516c50d818df89f466ac1fc135120fa6">bm_empty_buffers</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#gad4d33986fbbbd167b35425231120a843">bm_defragment_event</a> (<a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> buffer_handle, <a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> request_id, <a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent, void *pdata, void(*dispatcher)(<a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *, void *))</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="structEVENT__DEFRAG__BUFFER.html">EVENT_DEFRAG_BUFFER</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a> [MAX_DEFRAG_EVENTS]</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>dox dox dox </p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ga2ea1598024ac2528f65b6ba55526bd85"></a><!-- doxytag: member="midas.c::MAX_DEFRAG_EVENTS" ref="ga2ea1598024ac2528f65b6ba55526bd85" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_DEFRAG_EVENTS&nbsp;&nbsp;&nbsp;10</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>dox </p>

<p>Definition at line <a class="el" href="midas_8c_source.html#l07798">7798</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l07810">bm_defragment_event()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="gadca0488d73a8c1e9a420573c656f55f8"></a><!-- doxytag: member="midas.c::bm_add_event_request" ref="gadca0488d73a8c1e9a420573c656f55f8" args="(INT buffer_handle, short int event_id, short int trigger_mask, INT sampling_type, void(*func)(HNDLE, HNDLE, EVENT_HEADER *, void *), INT request_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_add_event_request </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int&nbsp;</td>
          <td class="paramname"> <em>event_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int&nbsp;</td>
          <td class="paramname"> <em>trigger_mask</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>sampling_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void(*)(<a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *, void *)&nbsp;</td>
          <td class="paramname"> <em>func</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>request_id</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>dox </p>

<p>Definition at line <a class="el" href="midas_8c_source.html#l05703">5703</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l01270">BUFFER_CLIENT::all_flag</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8h_source.html#l00993">BM_INVALID_MIXING</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8h_source.html#l00979">BM_NO_MEMORY</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01310">BUFFER::callback</a>, <a class="el" href="mserver_8c_source.html#l00190">callback</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="group__midasincludecode.html#ga9d7a9577d90476ed3f3438c238d9169f">EVENT_REQUEST::dispatch</a>, <a class="el" href="midas_8h_source.html#l01248">EVENT_REQUEST::event_id</a>, <a class="el" href="midas_8h_source.html#l01274">BUFFER_CLIENT::event_request</a>, <a class="el" href="midas_8h_source.html#l00728">GET_ALL</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="midas_8h_source.html#l01246">EVENT_REQUEST::id</a>, <a class="el" href="midas_8h_source.html#l00684">MAX_EVENT_REQUESTS</a>, <a class="el" href="midas_8h_source.html#l01262">BUFFER_CLIENT::max_request_index</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="mrpc_8h_source.html#l00123">RPC_BM_ADD_EVENT_REQUEST</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l01250">EVENT_REQUEST::sampling_type</a>, <a class="el" href="midas_8h_source.html#l01249">EVENT_REQUEST::trigger_mask</a>, <a class="el" href="p30_8h_source.html#l00043">TRUE</a>, and <a class="el" href="midas_8h_source.html#l01247">EVENT_REQUEST::valid</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l05852">bm_request_event()</a>, and <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l05710"></a>05710          :  <a class="code" href="group__msectionh.html#gafde91110de504bfb2b2a485ac1ff67e8">bm_add_event_request</a>
<a name="l05711"></a>05711 
<a name="l05712"></a>05712   Purpose:  Place a <a class="code" href="melog_8c.html#aabbea82fd1c1c5fc2dd51242e1ba43ea">request</a> <span class="keywordflow">for</span> a specific <span class="keyword">event</span> <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a> <a class="code" href="scs__600__p1_8c.html#af8480819a437c1eaeaa5b28b890613fa">in</a> the client
<a name="l05713"></a>05713             structure of the <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> refereced <a class="code" href="patch__mevb_8cpp.html#a944cf20aa75177818af16fe394e984be">by</a> buffer_handle.
<a name="l05714"></a>05714 
<a name="l05715"></a>05715   Input:
<a name="l05716"></a>05716     <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>          buffer_handle  Handle to the <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> where the re-
<a name="l05717"></a>05717                                 quest should be placed <a class="code" href="scs__600__p1_8c.html#af8480819a437c1eaeaa5b28b890613fa">in</a>
<a name="l05718"></a>05718 
<a name="l05719"></a>05719     <span class="keywordtype">short</span> <span class="keywordtype">int</span>    <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>       Event <a class="code" href="jorway73a_8h.html#a4bfe115debc7f472dd7dfe4ef9679ca0">ID</a>      \
<a name="l05720"></a>05720     <span class="keywordtype">short</span> <span class="keywordtype">int</span>    <a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a>   Trigger <a class="code" href="examples_2macro_2midas__macro_8h.html#aa27501f113ff6d3171689e27cebfcf47">mask</a>  / Event specification
<a name="l05721"></a>05721 
<a name="l05722"></a>05722     <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>          sampling_type  One of <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>, <a class="code" href="group__mdefineh.html#ga94a2c8eedfa072ecaf9f339f14c52a08">GET_SOME</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#a339a611d7f9dc3a59c359f0da7beaf3c">or</a> <a class="code" href="group__mdefineh.html#ga42172205845de032a731da642c1e7e0c">GET_FARM</a>
<a name="l05723"></a>05723 
<a name="l05724"></a>05724 
<a name="l05725"></a>05725                  Note: to <a class="code" href="melog_8c.html#aabbea82fd1c1c5fc2dd51242e1ba43ea">request</a> all types of events, use
<a name="l05726"></a>05726                    <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> = 0 (all others should be !=0 !)
<a name="l05727"></a>05727                    <a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a> = <a class="code" href="group__mdefineh.html#ga26aa4bcea89857cb7ca669339695ceac">TRIGGER_ALL</a>
<a name="l05728"></a>05728                    sampling_typ = <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>
<a name="l05729"></a>05729 
<a name="l05730"></a>05730 
<a name="l05731"></a>05731     <span class="keywordtype">void</span>         *func          Callback function
<a name="l05732"></a>05732     <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>          request_id     Request <span class="keywordtype">id</span> (unique number assigned
<a name="l05733"></a>05733                                 <a class="code" href="patch__mevb_8cpp.html#a944cf20aa75177818af16fe394e984be">by</a> <a class="code" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event</a>)
<a name="l05734"></a>05734 
<a name="l05735"></a>05735   Output:
<a name="l05736"></a>05736     none
<a name="l05737"></a>05737 
<a name="l05738"></a>05738   Function <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>:
<a name="l05739"></a>05739     <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>              Successful completion
<a name="l05740"></a>05740     <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>            Too much <a class="code" href="melog_8c.html#aabbea82fd1c1c5fc2dd51242e1ba43ea">request</a>. <a class="code" href="group__midasincludecode.html#gabe76a0bd645baa376f4443c59d16e36a">MAX_EVENT_REQUESTS</a> <a class="code" href="scs__600__p1_8c.html#af8480819a437c1eaeaa5b28b890613fa">in</a>
<a name="l05741"></a>05741                             MIDAS.H should be increased.
<a name="l05742"></a>05742     <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>       Buffer <a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a> is invalid
<a name="l05743"></a>05743     <a class="code" href="group__err25.html#gae7db91aa77eeed4371ba30dfc122ded6">RPC_NET_ERROR</a>           Network error
<a name="l05744"></a>05744 
<a name="l05745"></a>05745 \********************************************************************/
<a name="l05746"></a>05746 {
<a name="l05747"></a>05747    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l05748"></a>05748       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#ga08d9a543a5cb2a44825514fe3d4bcdba">RPC_BM_ADD_EVENT_REQUEST</a>, buffer_handle, <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>,
<a name="l05749"></a>05749                       <a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a>, sampling_type, (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) func, request_id);
<a name="l05750"></a>05750 
<a name="l05751"></a>05751 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l05752"></a>05752 <span class="preprocessor"></span>   {
<a name="l05753"></a>05753       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l05754"></a>05754       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient;
<a name="l05755"></a>05755 
<a name="l05756"></a>05756       <span class="keywordflow">if</span> (buffer_handle &gt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> || buffer_handle &lt;= 0) {
<a name="l05757"></a>05757          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_add_event_request&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>,
<a name="l05758"></a>05758                 buffer_handle);
<a name="l05759"></a>05759          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l05760"></a>05760       }
<a name="l05761"></a>05761 
<a name="l05762"></a>05762       <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].attached) {
<a name="l05763"></a>05763          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_add_event_request&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>,
<a name="l05764"></a>05764                 buffer_handle);
<a name="l05765"></a>05765          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l05766"></a>05766       }
<a name="l05767"></a>05767 
<a name="l05768"></a>05768       <span class="comment">/* avoid callback/non callback requests */</span>
<a name="l05769"></a>05769       <span class="keywordflow">if</span> (func == NULL &amp;&amp; <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="mserver_8c.html#a847e3001e4ea9147cfab3529da5b8c36">callback</a>) {
<a name="l05770"></a>05770          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_add_event_request&quot;</span>,
<a name="l05771"></a>05771                 <span class="stringliteral">&quot;mixing callback/non callback requests not possible&quot;</span>);
<a name="l05772"></a>05772          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga57d1cf336a7a69397d8a6b1d2d40bf27">BM_INVALID_MIXING</a>;
<a name="l05773"></a>05773       }
<a name="l05774"></a>05774 
<a name="l05775"></a>05775       <span class="comment">/* get a pointer to the proper client structure */</span>
<a name="l05776"></a>05776       pclient = &amp;(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>-&gt;
<a name="l05777"></a>05777                   client[<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>]);
<a name="l05778"></a>05778 
<a name="l05779"></a>05779       <span class="comment">/* lock buffer */</span>
<a name="l05780"></a>05780       <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l05781"></a>05781 
<a name="l05782"></a>05782       <span class="comment">/* look for a empty request entry */</span>
<a name="l05783"></a>05783       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__midasincludecode.html#gabe76a0bd645baa376f4443c59d16e36a">MAX_EVENT_REQUESTS</a>; i++)
<a name="l05784"></a>05784          <span class="keywordflow">if</span> (!pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a>)
<a name="l05785"></a>05785             <span class="keywordflow">break</span>;
<a name="l05786"></a>05786 
<a name="l05787"></a>05787       <span class="keywordflow">if</span> (i == MAX_EVENT_REQUESTS) {
<a name="l05788"></a>05788          <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l05789"></a>05789          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l05790"></a>05790       }
<a name="l05791"></a>05791 
<a name="l05792"></a>05792       <span class="comment">/* setup event_request structure */</span>
<a name="l05793"></a>05793       pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="structEVENT__REQUEST.html#ab5275898e99714ff529f7fe125a91d0e">id</a> = request_id;
<a name="l05794"></a>05794       pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05795"></a>05795       pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#ga861d57422d21affdcfe60a67a3f8cb7f">event_id</a> = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l05796"></a>05796       pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#ga8947eb12d18f6202ecc9d603f3bde410">trigger_mask</a> = <a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a>;
<a name="l05797"></a>05797       pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#ga98d63806bfe8b8d66fad6d3d6d9b08e4">sampling_type</a> = sampling_type;
<a name="l05798"></a>05798       pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#ga9d7a9577d90476ed3f3438c238d9169f">dispatch</a> = func;
<a name="l05799"></a>05799 
<a name="l05800"></a>05800       pclient-&gt;<a class="code" href="group__midasincludecode.html#gaaecb6333b24063b91eb403a11aa4ea53">all_flag</a> = pclient-&gt;<a class="code" href="group__midasincludecode.html#gaaecb6333b24063b91eb403a11aa4ea53">all_flag</a> || (sampling_type &amp; <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>);
<a name="l05801"></a>05801 
<a name="l05802"></a>05802       <span class="comment">/* set callback flag in buffer structure */</span>
<a name="l05803"></a>05803       <span class="keywordflow">if</span> (func != NULL)
<a name="l05804"></a>05804          <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga9611e4a4e83bdf10fc85a02c6de72da5">callback</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05805"></a>05805 
<a name="l05806"></a>05806       <span class="comment">/*</span>
<a name="l05807"></a>05807 <span class="comment">         Save the index of the last request in the list so that later only the</span>
<a name="l05808"></a>05808 <span class="comment">         requests 0..max_request_index-1 have to be searched through.</span>
<a name="l05809"></a>05809 <span class="comment">       */</span>
<a name="l05810"></a>05810 
<a name="l05811"></a>05811       <span class="keywordflow">if</span> (i + 1 &gt; pclient-&gt;<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a>)
<a name="l05812"></a>05812          pclient-&gt;<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a> = i + 1;
<a name="l05813"></a>05813 
<a name="l05814"></a>05814       <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l05815"></a>05815    }
<a name="l05816"></a>05816 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l05817"></a>05817 
<a name="l05818"></a>05818    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l05819"></a>05819 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga6f72d4840fd9ca14a9864252fe5d8b3a"></a><!-- doxytag: member="midas.c::bm_check_buffers" ref="ga6f72d4840fd9ca14a9864252fe5d8b3a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_check_buffers </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Check if any requested event is waiting in a buffer </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>TRUE More events are waiting<br/>
 FALSE No more events are waiting </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l07429">7429</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l00992">BM_MORE_EVENTS</a>, <a class="el" href="midas_8c_source.html#l07157">bm_push_event()</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="mana_8cpp_source.html#l00677">index</a>, <a class="el" href="midas_8c_source.html#l09045">rpc_get_server_acception()</a>, <a class="el" href="midas_8c_source.html#l09250">rpc_get_server_option()</a>, <a class="el" href="midas_8h_source.html#l00772">RPC_OSERVER_TYPE</a>, <a class="el" href="system_8c_source.html#l01050">ss_gettid()</a>, <a class="el" href="system_8c_source.html#l02265">ss_millitime()</a>, <a class="el" href="midas_8h_source.html#l01792">ST_MTHREAD</a>, <a class="el" href="midas_8h_source.html#l01791">ST_SINGLE</a>, <a class="el" href="midas_8h_source.html#l01794">ST_SUBPROCESS</a>, <a class="el" href="old__mevb_8cpp_source.html#l00065">start_time</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, and <a class="el" href="p30_8h_source.html#l00043">TRUE</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l04166">cm_yield()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l07430"></a>07430 {
<a name="l07431"></a>07431 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l07432"></a>07432 <span class="preprocessor"></span>   {
<a name="l07433"></a>07433       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a> = 0;
<a name="l07434"></a>07434       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> server_type, server_conn, tid;
<a name="l07435"></a>07435       <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> bMore;
<a name="l07436"></a>07436       <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="old__mevb_8cpp.html#af4211e1ba0e676018599e88cfae3537a">start_time</a>;
<a name="l07437"></a>07437 
<a name="l07438"></a>07438       server_type = <a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>);
<a name="l07439"></a>07439       server_conn = <a class="code" href="group__msystemincludecode.html#ga55167513ac1295a246d69f378fc9d459">rpc_get_server_acception</a>();
<a name="l07440"></a>07440       tid = <a class="code" href="group__msystemincludecode.html#ga47dde62638a1a4e9f49534bff449ebcd">ss_gettid</a>();
<a name="l07441"></a>07441 
<a name="l07442"></a>07442       <span class="comment">/* if running as a server, buffer checking is done by client</span>
<a name="l07443"></a>07443 <span class="comment">         via ASYNC bm_receive_event */</span>
<a name="l07444"></a>07444       <span class="keywordflow">if</span> (server_type == <a class="code" href="group__msectionh.html#gac882709a084d5b60f95fe6fa372d7ea7">ST_SUBPROCESS</a> || server_type == <a class="code" href="group__msectionh.html#ga88fcaca68212b5824a0b0f6c9507ebcb">ST_MTHREAD</a>)
<a name="l07445"></a>07445          <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l07446"></a>07446 
<a name="l07447"></a>07447       bMore = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l07448"></a>07448       start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l07449"></a>07449 
<a name="l07450"></a>07450       <span class="comment">/* go through all buffers */</span>
<a name="l07451"></a>07451       <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>; index++) {
<a name="l07452"></a>07452          <span class="keywordflow">if</span> (server_type == <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp; <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[index].index != server_conn)
<a name="l07453"></a>07453             <span class="keywordflow">continue</span>;
<a name="l07454"></a>07454 
<a name="l07455"></a>07455          <span class="keywordflow">if</span> (server_type != <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp; <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[index].index != tid)
<a name="l07456"></a>07456             <span class="keywordflow">continue</span>;
<a name="l07457"></a>07457 
<a name="l07458"></a>07458          <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[index].attached)
<a name="l07459"></a>07459             <span class="keywordflow">continue</span>;
<a name="l07460"></a>07460 
<a name="l07461"></a>07461          <span class="keywordflow">do</span> {
<a name="l07462"></a>07462 
<a name="l07463"></a>07463             <span class="comment">/* one bm_push_event could cause a run stop and a buffer close, which</span>
<a name="l07464"></a>07464 <span class="comment">               would crash the next call to bm_push_event(). So check for valid</span>
<a name="l07465"></a>07465 <span class="comment">               buffer on each call */</span>
<a name="l07466"></a>07466             <span class="keywordflow">if</span> (index &lt; _buffer_entries &amp;&amp; <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[index].buffer_header-&gt;name != NULL)
<a name="l07467"></a>07467                status = <a class="code" href="group__msystemincludecode.html#gabcc6bb732b720fcc3ffe859f732a07e0">bm_push_event</a>(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[index].buffer_header-&gt;name);
<a name="l07468"></a>07468 
<a name="l07469"></a>07469             <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#ga0ef7db8ae9812d639f07e3d654d76e90">BM_MORE_EVENTS</a>)
<a name="l07470"></a>07470                <span class="keywordflow">break</span>;
<a name="l07471"></a>07471 
<a name="l07472"></a>07472             <span class="comment">/* stop after one second */</span>
<a name="l07473"></a>07473             <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time &gt; 1000) {
<a name="l07474"></a>07474                bMore = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l07475"></a>07475                <span class="keywordflow">break</span>;
<a name="l07476"></a>07476             }
<a name="l07477"></a>07477 
<a name="l07478"></a>07478          } <span class="keywordflow">while</span> (<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l07479"></a>07479       }
<a name="l07480"></a>07480 
<a name="l07481"></a>07481       <span class="keywordflow">return</span> bMore;
<a name="l07482"></a>07482 
<a name="l07483"></a>07483    }
<a name="l07484"></a>07484 <span class="preprocessor">#else                           </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l07485"></a>07485 
<a name="l07486"></a>07486    <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l07487"></a>07487 
<a name="l07488"></a>07488 <span class="preprocessor">#endif</span>
<a name="l07489"></a>07489 <span class="preprocessor"></span>}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga3a2dae045156606fc157e01a82983a25"></a><!-- doxytag: member="midas.c::bm_close_all_buffers" ref="ga3a2dae045156606fc157e01a82983a25" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_close_all_buffers </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Close all open buffers </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l04722">4722</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8c_source.html#l04611">bm_close_buffer()</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="mrpc_8h_source.html#l00118">RPC_BM_CLOSE_ALL_BUFFERS</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, and <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l02768">cm_disconnect_experiment()</a>, <a class="el" href="midas_8c_source.html#l01976">cm_set_client_info()</a>, <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>, and <a class="el" href="midas_8c_source.html#l12223">rpc_server_receive()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04723"></a>04723 {
<a name="l04724"></a>04724    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l04725"></a>04725       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#ga8b215c45660e1188647a692b5bf4f331">RPC_BM_CLOSE_ALL_BUFFERS</a>);
<a name="l04726"></a>04726 
<a name="l04727"></a>04727 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l04728"></a>04728 <span class="preprocessor"></span>   {
<a name="l04729"></a>04729       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l04730"></a>04730 
<a name="l04731"></a>04731       <span class="keywordflow">for</span> (i = <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>; i &gt; 0; i--)
<a name="l04732"></a>04732          <a class="code" href="group__msectionh.html#ga536a8e803f72f8f4a7e211846020a148">bm_close_buffer</a>(i);
<a name="l04733"></a>04733    }
<a name="l04734"></a>04734 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l04735"></a>04735 
<a name="l04736"></a>04736    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l04737"></a>04737 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga7b2cbde6caa572dfc978c780d63ab6be"></a><!-- doxytag: member="midas.c::bm_close_buffer" ref="ga7b2cbde6caa572dfc978c780d63ab6be" args="(INT buffer_handle)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_close_buffer </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Closes an event buffer previously opened with <a class="el" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer()</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_handle</em>&nbsp;</td><td>buffer handle </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l04611">4611</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8c_source.html#l00816">_request_list_entries</a>, <a class="el" href="midas_8h_source.html#l01295">BUFFER::attached</a>, <a class="el" href="midas_8c_source.html#l05993">bm_delete_request()</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01288">BUFFER_HEADER::client</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="mana_8cpp_source.html#l00677">index</a>, <a class="el" href="odbhist_8c_source.html#l00058">j</a>, <a class="el" href="midas_8h_source.html#l01755">M_FREE</a>, <a class="el" href="midas_8h_source.html#l01281">BUFFER_HEADER::max_client_index</a>, <a class="el" href="midas_8h_source.html#l00683">MAX_CLIENTS</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="midas_8h_source.html#l01279">BUFFER_HEADER::name</a>, <a class="el" href="midas_8h_source.html#l01280">BUFFER_HEADER::num_clients</a>, <a class="el" href="midas_8h_source.html#l01257">BUFFER_CLIENT::pid</a>, <a class="el" href="midas_8h_source.html#l01260">BUFFER_CLIENT::port</a>, <a class="el" href="midas_8h_source.html#l01267">BUFFER_CLIENT::read_wait</a>, <a class="el" href="mrpc_8h_source.html#l00117">RPC_BM_CLOSE_BUFFER</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09045">rpc_get_server_acception()</a>, <a class="el" href="midas_8c_source.html#l09250">rpc_get_server_option()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l00772">RPC_OSERVER_TYPE</a>, <a class="el" href="midas_8h_source.html#l01308">BUFFER::shm_handle</a>, <a class="el" href="system_8c_source.html#l01050">ss_gettid()</a>, <a class="el" href="system_8c_source.html#l02177">ss_mutex_delete()</a>, <a class="el" href="system_8c_source.html#l03549">ss_resume()</a>, <a class="el" href="system_8c_source.html#l00609">ss_shm_close()</a>, <a class="el" href="midas_8h_source.html#l01791">ST_SINGLE</a>, and <a class="el" href="midas_8h_source.html#l01268">BUFFER_CLIENT::write_wait</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l04722">bm_close_all_buffers()</a>, <a class="el" href="odbedit_8c_source.html#l01415">command_loop()</a>, <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>, <a class="el" href="mevb_8cpp_source.html#l00826">source_unbooking()</a>, <a class="el" href="fal_8c_source.html#l02355">tr_poststop()</a>, and <a class="el" href="mlogger_8c_source.html#l03482">tr_stop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04612"></a>04612 {
<a name="l04613"></a>04613    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l04614"></a>04614       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#ga6bcbf5868fd271b48e01dfc56037365a">RPC_BM_CLOSE_BUFFER</a>, buffer_handle);
<a name="l04615"></a>04615 
<a name="l04616"></a>04616 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l04617"></a>04617 <span class="preprocessor"></span>   {
<a name="l04618"></a>04618       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient;
<a name="l04619"></a>04619       <a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a> *pheader;
<a name="l04620"></a>04620       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, destroy_flag;
<a name="l04621"></a>04621 
<a name="l04622"></a>04622       <span class="keywordflow">if</span> (buffer_handle &gt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> || buffer_handle &lt;= 0) {
<a name="l04623"></a>04623          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_close_buffer&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l04624"></a>04624          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l04625"></a>04625       }
<a name="l04626"></a>04626 
<a name="l04627"></a>04627       <span class="comment">/*</span>
<a name="l04628"></a>04628 <span class="comment">         Check if buffer was opened by current thread. This is necessary</span>
<a name="l04629"></a>04629 <span class="comment">         in the server process where one thread may not close the buffer</span>
<a name="l04630"></a>04630 <span class="comment">         of other threads.</span>
<a name="l04631"></a>04631 <span class="comment">       */</span>
<a name="l04632"></a>04632 
<a name="l04633"></a>04633       index = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>;
<a name="l04634"></a>04634       pheader = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>;
<a name="l04635"></a>04635 
<a name="l04636"></a>04636       <span class="keywordflow">if</span> (<a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>) == <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp;
<a name="l04637"></a>04637           <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].index != <a class="code" href="group__msystemincludecode.html#ga55167513ac1295a246d69f378fc9d459">rpc_get_server_acception</a>())
<a name="l04638"></a>04638          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l04639"></a>04639 
<a name="l04640"></a>04640       <span class="keywordflow">if</span> (<a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>) != <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp;
<a name="l04641"></a>04641           <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].index != <a class="code" href="group__msystemincludecode.html#ga47dde62638a1a4e9f49534bff449ebcd">ss_gettid</a>())
<a name="l04642"></a>04642          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l04643"></a>04643 
<a name="l04644"></a>04644       <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].attached) {
<a name="l04645"></a>04645          <span class="comment">/* don&apos;t produce error, since bm_close_all_buffers() might want to close an</span>
<a name="l04646"></a>04646 <span class="comment">            already closed buffer */</span>
<a name="l04647"></a>04647          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l04648"></a>04648       }
<a name="l04649"></a>04649 
<a name="l04650"></a>04650       <span class="comment">/* delete all requests for this buffer */</span>
<a name="l04651"></a>04651       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__midasincludecode.html#ga6dc3fd8dcb204a2379ed33a7e4645a2d">_request_list_entries</a>; i++)
<a name="l04652"></a>04652          <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].buffer_handle == buffer_handle)
<a name="l04653"></a>04653             <a class="code" href="group__msectionh.html#ga642e51b416da6cd6e27035fdd43ed71b">bm_delete_request</a>(i);
<a name="l04654"></a>04654 
<a name="l04655"></a>04655       <span class="comment">/* first lock buffer */</span>
<a name="l04656"></a>04656       <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l04657"></a>04657 
<a name="l04658"></a>04658       <span class="comment">/* mark entry in _buffer as empty */</span>
<a name="l04659"></a>04659       <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="structBUFFER.html#a495ba8d2558dac6d40a46564c5067a2c">attached</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04660"></a>04660 
<a name="l04661"></a>04661       <span class="comment">/* clear entry from client structure in buffer header */</span>
<a name="l04662"></a>04662       memset(&amp;(pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>[index]), 0, <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a>));
<a name="l04663"></a>04663 
<a name="l04664"></a>04664       <span class="comment">/* calculate new max_client_index entry */</span>
<a name="l04665"></a>04665       <span class="keywordflow">for</span> (i = <a class="code" href="group__midasincludecode.html#ga0a8f91f93d75a07f0ae45077db45b3eb">MAX_CLIENTS</a> - 1; i &gt;= 0; i--)
<a name="l04666"></a>04666          <span class="keywordflow">if</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>[i].<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> != 0)
<a name="l04667"></a>04667             <span class="keywordflow">break</span>;
<a name="l04668"></a>04668       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a> = i + 1;
<a name="l04669"></a>04669 
<a name="l04670"></a>04670       <span class="comment">/* count new number of clients */</span>
<a name="l04671"></a>04671       <span class="keywordflow">for</span> (i = <a class="code" href="group__midasincludecode.html#ga0a8f91f93d75a07f0ae45077db45b3eb">MAX_CLIENTS</a> - 1, j = 0; i &gt;= 0; i--)
<a name="l04672"></a>04672          <span class="keywordflow">if</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>[i].<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> != 0)
<a name="l04673"></a>04673             j++;
<a name="l04674"></a>04674       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3c6af0363e3034c956a264fe6a25ddfb">num_clients</a> = j;
<a name="l04675"></a>04675 
<a name="l04676"></a>04676       destroy_flag = (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3c6af0363e3034c956a264fe6a25ddfb">num_clients</a> == 0);
<a name="l04677"></a>04677 
<a name="l04678"></a>04678       <span class="comment">/* free cache */</span>
<a name="l04679"></a>04679       <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].read_cache_size &gt; 0)
<a name="l04680"></a>04680          <a class="code" href="group__msectionh.html#ga95c0d83820c28cf52ea13271b034fcb2">M_FREE</a>(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].read_cache);
<a name="l04681"></a>04681       <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].write_cache_size &gt; 0)
<a name="l04682"></a>04682          <a class="code" href="group__msectionh.html#ga95c0d83820c28cf52ea13271b034fcb2">M_FREE</a>(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].write_cache);
<a name="l04683"></a>04683 
<a name="l04684"></a>04684       <span class="comment">/* check if anyone is waiting and wake him up */</span>
<a name="l04685"></a>04685       pclient = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>;
<a name="l04686"></a>04686 
<a name="l04687"></a>04687       <span class="keywordflow">for</span> (i = 0; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pclient++)
<a name="l04688"></a>04688          <span class="keywordflow">if</span> (pclient-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> &amp;&amp; (pclient-&gt;<a class="code" href="group__midasincludecode.html#ga884b0a6395661ef9f711fa3ca7bc19b6">write_wait</a> || pclient-&gt;<a class="code" href="group__midasincludecode.html#ga896acd334d608006626fcca2a872a4a4">read_wait</a>))
<a name="l04689"></a>04689             <a class="code" href="group__msystemincludecode.html#ga2f07c99535bcb2959efc54c5cdbf6747">ss_resume</a>(pclient-&gt;<a class="code" href="group__midasincludecode.html#gad8112ed9dd177230ff2a9acfd84c5429">port</a>, <span class="stringliteral">&quot;B  &quot;</span>);
<a name="l04690"></a>04690 
<a name="l04691"></a>04691       <span class="comment">/* unmap shared memory, delete it if we are the last */</span>
<a name="l04692"></a>04692       <a class="code" href="group__msystemincludecode.html#ga60889b75242e40dc0ee097d7295cc404">ss_shm_close</a>(pheader-&gt;<a class="code" href="structBUFFER__HEADER.html#a40ea1b56ee55965c4d61e6da5ae57022">name</a>, <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>,
<a name="l04693"></a>04693                    <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#gae313313f5d3caa148ea750395c88a54f">shm_handle</a>, destroy_flag);
<a name="l04694"></a>04694 
<a name="l04695"></a>04695       <span class="comment">/* unlock buffer */</span>
<a name="l04696"></a>04696       <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l04697"></a>04697 
<a name="l04698"></a>04698       <span class="comment">/* delete mutex */</span>
<a name="l04699"></a>04699       <a class="code" href="group__msystemincludecode.html#gac373a10e886ccbfd012b7f5d848d8595">ss_mutex_delete</a>(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].mutex, destroy_flag);
<a name="l04700"></a>04700 
<a name="l04701"></a>04701       <span class="comment">/* update _buffer_entries */</span>
<a name="l04702"></a>04702       <span class="keywordflow">if</span> (buffer_handle == <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>)
<a name="l04703"></a>04703          <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>--;
<a name="l04704"></a>04704 
<a name="l04705"></a>04705       <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> &gt; 0)
<a name="l04706"></a>04706          <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a> = (<a class="code" href="structBUFFER.html">BUFFER</a> *) realloc(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>, <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER.html">BUFFER</a>) * (<a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>));
<a name="l04707"></a>04707       <span class="keywordflow">else</span> {
<a name="l04708"></a>04708          <a class="code" href="group__msectionh.html#ga95c0d83820c28cf52ea13271b034fcb2">M_FREE</a>(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>);
<a name="l04709"></a>04709          <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a> = NULL;
<a name="l04710"></a>04710       }
<a name="l04711"></a>04711    }
<a name="l04712"></a>04712 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l04713"></a>04713 
<a name="l04714"></a>04714    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l04715"></a>04715 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="gac5e3e469fb6721a502ebd80a35a328f5"></a><!-- doxytag: member="midas.c::bm_compose_event" ref="gac5e3e469fb6721a502ebd80a35a328f5" args="(EVENT_HEADER *event_header, short int event_id, short int trigger_mask, DWORD size, DWORD serial)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_compose_event </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *&nbsp;</td>
          <td class="paramname"> <em>event_header</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int&nbsp;</td>
          <td class="paramname"> <em>event_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int&nbsp;</td>
          <td class="paramname"> <em>trigger_mask</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a798af1e30bc65f319c1a246cecf59e39">DWORD</a>&nbsp;</td>
          <td class="paramname"> <em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a798af1e30bc65f319c1a246cecf59e39">DWORD</a>&nbsp;</td>
          <td class="paramname"> <em>serial</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Compose a Midas event header. An event header can usually be set-up manually or through this routine. If the data size of the event is not known when the header is composed, it can be set later with event_header-&gt;data-size = &lt;...&gt; Following structure is created at the beginning of an event </p>
<div class="fragment"><pre class="fragment"><span class="keyword">typedef</span> <span class="keyword">struct </span>{
 <span class="keywordtype">short</span> <span class="keywordtype">int</span>     <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
 <span class="keywordtype">short</span> <span class="keywordtype">int</span>     <a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a>;
 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>         <a class="code" href="examples_2macro_2midas__macro_8h.html#a835229ca2b41635b0438a6311cbb56b2">serial_number</a>;
 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>         <a class="code" href="examples_2macro_2midas__macro_8h.html#aea63d251ba3e235703c63097ccba1108">time_stamp</a>;
 <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>         <a class="code" href="v1724__module_8c.html#af9bcc453896ea532710141c5a10fd347">data_size</a>;
} <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>;

<span class="keywordtype">char</span> <span class="keyword">event</span>[1000];
 <a class="code" href="group__msectionh.html#ga2cdd90a4b2def271ad89cc0d308bb970">bm_compose_event</a>((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *)event, 1, 0, 100, 1);
 *(<span class="keyword">event</span>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)) = &lt;...&gt;
</pre></div> <dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>event_header</em>&nbsp;</td><td>pointer to the event header </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>event_id</em>&nbsp;</td><td>event ID of the event </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>trigger_mask</em>&nbsp;</td><td>trigger mask of the event </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>size</em>&nbsp;</td><td>size if the data part of the event in bytes </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>serial</em>&nbsp;</td><td>serial number </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l05686">5686</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8h_source.html#l01195">EVENT_HEADER::data_size</a>, <a class="el" href="midas_8h_source.html#l01191">EVENT_HEADER::event_id</a>, <a class="el" href="midas_8h_source.html#l01193">EVENT_HEADER::serial_number</a>, <a class="el" href="system_8c_source.html#l02332">ss_time()</a>, <a class="el" href="midas_8h_source.html#l01194">EVENT_HEADER::time_stamp</a>, and <a class="el" href="midas_8h_source.html#l01192">EVENT_HEADER::trigger_mask</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l01233">cm_msg()</a>, <a class="el" href="midas_8c_source.html#l01346">cm_msg1()</a>, <a class="el" href="fal_8c_source.html#l00409">log_odb_dump()</a>, <a class="el" href="minife_8c_source.html#l00065">main()</a>, <a class="el" href="crate3_2rpc__slave_8cpp_source.html#l00049">rpc_end_of_cycle()</a>, <a class="el" href="mevb_8cpp_source.html#l00916">source_scan()</a>, <a class="el" href="ybos_8c_source.html#l00856">yb_file_fragment()</a>, and <a class="el" href="ybos_8c_source.html#l01505">ybos_log_dump()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l05688"></a>05688 {
<a name="l05689"></a>05689    event_header-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l05690"></a>05690    event_header-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = <a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a>;
<a name="l05691"></a>05691    event_header-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l05692"></a>05692    event_header-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>();
<a name="l05693"></a>05693    event_header-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> = <a class="code" href="minife_8c.html#a9c566f7d2ca91bd19145b0568c0c66aa">serial</a>;
<a name="l05694"></a>05694 
<a name="l05695"></a>05695    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l05696"></a>05696 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="gad4d33986fbbbd167b35425231120a843"></a><!-- doxytag: member="midas.c::bm_defragment_event" ref="gad4d33986fbbbd167b35425231120a843" args="(HNDLE buffer_handle, HNDLE request_id, EVENT_HEADER *pevent, void *pdata, void(*dispatcher)(HNDLE, HNDLE, EVENT_HEADER *, void *))" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void bm_defragment_event </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>&nbsp;</td>
          <td class="paramname"> <em>request_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *&nbsp;</td>
          <td class="paramname"> <em>pevent</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>pdata</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void(*)(<a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *, void *)&nbsp;</td>
          <td class="paramname"> <em>dispatcher</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="midas_8c_source.html#l07810">7810</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="v1724__module_8c_source.html#l00027">data_size</a>, <a class="el" href="midas_8c_source.html#l07802">EVENT_DEFRAG_BUFFER::data_size</a>, <a class="el" href="midas_8h_source.html#l01195">EVENT_HEADER::data_size</a>, <a class="el" href="midas_8c_source.html#l07801">EVENT_DEFRAG_BUFFER::event_id</a>, <a class="el" href="midas_8h_source.html#l01191">EVENT_HEADER::event_id</a>, <a class="el" href="midas_8h_source.html#l01235">EVENTID_FRAG1</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="midas_8c_source.html#l07798">MAX_DEFRAG_EVENTS</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="midas_8c_source.html#l07804">EVENT_DEFRAG_BUFFER::pevent</a>, and <a class="el" href="midas_8c_source.html#l07803">EVENT_DEFRAG_BUFFER::received</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l07616">bm_poll_event()</a>, and <a class="el" href="midas_8c_source.html#l07157">bm_push_event()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l07815"></a>07815          : <a class="code" href="group__msystemincludecode.html#gab7e29f86ca0340171d22fb086cba0dd8">bm_defragment_event</a>
<a name="l07816"></a>07816 
<a name="l07817"></a>07817   Purpose: Called internally from the <span class="keyword">event</span> receiving routines
<a name="l07818"></a>07818            <a class="code" href="group__msystemincludecode.html#gabcc6bb732b720fcc3ffe859f732a07e0">bm_push_event</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#aa3d7d535cf450b91b9cb6d9cee2edbb9">and</a> <a class="code" href="group__msectionh.html#ga545449f5acb6b13f78b1194cb92b3d63">bm_poll_event</a> to recombine <span class="keyword">event</span>
<a name="l07819"></a>07819            fragments <a class="code" href="examples_2macro_2midas__macro_8h.html#aa3d7d535cf450b91b9cb6d9cee2edbb9">and</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#a01f23030e8f35ef3c830e0bbb53e91bc">call</a> the user <a class="code" href="mserver_8c.html#a847e3001e4ea9147cfab3529da5b8c36">callback</a> routine upon
<a name="l07820"></a>07820            completion.
<a name="l07821"></a>07821 
<a name="l07822"></a>07822   Input:
<a name="l07823"></a>07823     <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> buffer_handle  Handle <span class="keywordflow">for</span> the <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> containing <span class="keyword">event</span>
<a name="l07824"></a>07824     <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> request_id     Handle <span class="keywordflow">for</span> <span class="keyword">event</span> <a class="code" href="melog_8c.html#aabbea82fd1c1c5fc2dd51242e1ba43ea">request</a>
<a name="l07825"></a>07825     <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent Pointer to <span class="keyword">event</span> header
<a name="l07826"></a>07826     <span class="keywordtype">void</span> *pata           Pointer to <span class="keyword">event</span> <a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>
<a name="l07827"></a>07827     dispatcher()         User <a class="code" href="mserver_8c.html#a847e3001e4ea9147cfab3529da5b8c36">callback</a> routine
<a name="l07828"></a>07828 
<a name="l07829"></a>07829   Output:
<a name="l07830"></a>07830     &lt;calls dispatcher() after successfull recombination of event&gt;
<a name="l07831"></a>07831 
<a name="l07832"></a>07832   Function <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>:
<a name="l07833"></a>07833     <span class="keywordtype">void</span>
<a name="l07834"></a>07834 
<a name="l07835"></a>07835 \********************************************************************/
<a name="l07836"></a>07836 {
<a name="l07837"></a>07837    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l07838"></a>07838 
<a name="l07839"></a>07839    <span class="keywordflow">if</span> ((pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xF000) == <a class="code" href="group__mbufferh.html#gaae07538917933e32355933ac1e2e3d60">EVENTID_FRAG1</a>) {
<a name="l07840"></a>07840     <span class="comment">/*---- start new event ----*/</span>
<a name="l07841"></a>07841 
<a name="l07842"></a>07842       <span class="comment">/* check if fragments already stored */</span>
<a name="l07843"></a>07843       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__bmfunctionc.html#ga2ea1598024ac2528f65b6ba55526bd85">MAX_DEFRAG_EVENTS</a>; i++)
<a name="l07844"></a>07844          <span class="keywordflow">if</span> (<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> == (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0x0FFF))
<a name="l07845"></a>07845             <span class="keywordflow">break</span>;
<a name="l07846"></a>07846 
<a name="l07847"></a>07847       <span class="keywordflow">if</span> (i &lt; MAX_DEFRAG_EVENTS) {
<a name="l07848"></a>07848          free(<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].pevent);
<a name="l07849"></a>07849          memset(&amp;<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__DEFRAG__BUFFER.html">EVENT_DEFRAG_BUFFER</a>));
<a name="l07850"></a>07850          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_defragement_event&quot;</span>,
<a name="l07851"></a>07851                 <span class="stringliteral">&quot;Received new event with ID %d while old fragments were not completed&quot;</span>,
<a name="l07852"></a>07852                 (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0x0FFF));
<a name="l07853"></a>07853       }
<a name="l07854"></a>07854 
<a name="l07855"></a>07855       <span class="comment">/* search new slot */</span>
<a name="l07856"></a>07856       <span class="keywordflow">for</span> (i = 0; i &lt; MAX_DEFRAG_EVENTS; i++)
<a name="l07857"></a>07857          <span class="keywordflow">if</span> (<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].event_id == 0)
<a name="l07858"></a>07858             <span class="keywordflow">break</span>;
<a name="l07859"></a>07859 
<a name="l07860"></a>07860       <span class="keywordflow">if</span> (i == MAX_DEFRAG_EVENTS) {
<a name="l07861"></a>07861          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_defragment_evnet&quot;</span>,
<a name="l07862"></a>07862                 <span class="stringliteral">&quot;Not eough defragment buffers, please increase MAX_DEFRAG_EVENTS and recompile&quot;</span>);
<a name="l07863"></a>07863          <span class="keywordflow">return</span>;
<a name="l07864"></a>07864       }
<a name="l07865"></a>07865 
<a name="l07866"></a>07866       <span class="comment">/* check event size */</span>
<a name="l07867"></a>07867       <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> != <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>)) {
<a name="l07868"></a>07868          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_defragment_evnet&quot;</span>,
<a name="l07869"></a>07869                 <span class="stringliteral">&quot;Received first event fragment with %s bytes instead of %d bytes, event ignored&quot;</span>,
<a name="l07870"></a>07870                 pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>, <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>));
<a name="l07871"></a>07871          <span class="keywordflow">return</span>;
<a name="l07872"></a>07872       }
<a name="l07873"></a>07873 
<a name="l07874"></a>07874       <span class="comment">/* setup defragment buffer */</span>
<a name="l07875"></a>07875       <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#a23c2078a2c5099b42d88659be482c811">event_id</a> = (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0x0FFF);
<a name="l07876"></a>07876       <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#a6666a955ee044c5cb083ba9b5bd03273">data_size</a> = *(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pdata;
<a name="l07877"></a>07877       <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#ad8b633c7a00fdcad6feac94be036e69c">received</a> = 0;
<a name="l07878"></a>07878       <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#abfa2dd1effc70c3635117bf719116b1d">pevent</a> =
<a name="l07879"></a>07879           (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) + <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#a6666a955ee044c5cb083ba9b5bd03273">data_size</a>);
<a name="l07880"></a>07880 
<a name="l07881"></a>07881       <span class="keywordflow">if</span> (<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].pevent == NULL) {
<a name="l07882"></a>07882          memset(&amp;<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].event_id, 0, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__DEFRAG__BUFFER.html">EVENT_DEFRAG_BUFFER</a>));
<a name="l07883"></a>07883          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_defragement_event&quot;</span>,
<a name="l07884"></a>07884                 <span class="stringliteral">&quot;Not enough memory to allocate event defragment buffer&quot;</span>);
<a name="l07885"></a>07885          <span class="keywordflow">return</span>;
<a name="l07886"></a>07886       }
<a name="l07887"></a>07887 
<a name="l07888"></a>07888       memcpy(<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].pevent, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l07889"></a>07889       <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#abfa2dd1effc70c3635117bf719116b1d">pevent</a>-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#a23c2078a2c5099b42d88659be482c811">event_id</a>;
<a name="l07890"></a>07890       <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#abfa2dd1effc70c3635117bf719116b1d">pevent</a>-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#a6666a955ee044c5cb083ba9b5bd03273">data_size</a>;
<a name="l07891"></a>07891 
<a name="l07892"></a>07892       <span class="keywordflow">return</span>;
<a name="l07893"></a>07893    }
<a name="l07894"></a>07894 
<a name="l07895"></a>07895    <span class="comment">/* search buffer for that event */</span>
<a name="l07896"></a>07896    <span class="keywordflow">for</span> (i = 0; i &lt; MAX_DEFRAG_EVENTS; i++)
<a name="l07897"></a>07897       <span class="keywordflow">if</span> (<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].event_id == (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xFFF))
<a name="l07898"></a>07898          <span class="keywordflow">break</span>;
<a name="l07899"></a>07899 
<a name="l07900"></a>07900    <span class="keywordflow">if</span> (i == MAX_DEFRAG_EVENTS) {
<a name="l07901"></a>07901       <span class="comment">/* no buffer available -&gt; no first fragment received */</span>
<a name="l07902"></a>07902       free(<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].pevent);
<a name="l07903"></a>07903       memset(&amp;<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].event_id, 0, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__DEFRAG__BUFFER.html">EVENT_DEFRAG_BUFFER</a>));
<a name="l07904"></a>07904       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_defragement_event&quot;</span>,
<a name="l07905"></a>07905              <span class="stringliteral">&quot;Received fragment with no first fragment (ID %d)&quot;</span>,
<a name="l07906"></a>07906              pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0x0FFF);
<a name="l07907"></a>07907       <span class="keywordflow">return</span>;
<a name="l07908"></a>07908    }
<a name="l07909"></a>07909 
<a name="l07910"></a>07910    <span class="comment">/* add fragment to buffer */</span>
<a name="l07911"></a>07911    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#ad8b633c7a00fdcad6feac94be036e69c">received</a> &gt; <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#a6666a955ee044c5cb083ba9b5bd03273">data_size</a>) {
<a name="l07912"></a>07912       free(<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].pevent);
<a name="l07913"></a>07913       memset(&amp;<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].event_id, 0, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__DEFRAG__BUFFER.html">EVENT_DEFRAG_BUFFER</a>));
<a name="l07914"></a>07914       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_defragement_event&quot;</span>,
<a name="l07915"></a>07915              <span class="stringliteral">&quot;Received fragments with more data (%d) than event size (%d)&quot;</span>,
<a name="l07916"></a>07916              pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#ad8b633c7a00fdcad6feac94be036e69c">received</a>, <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#a6666a955ee044c5cb083ba9b5bd03273">data_size</a>);
<a name="l07917"></a>07917       <span class="keywordflow">return</span>;
<a name="l07918"></a>07918    }
<a name="l07919"></a>07919 
<a name="l07920"></a>07920    memcpy(((<span class="keywordtype">char</span> *) <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].pevent) + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) +
<a name="l07921"></a>07921           <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].received, pdata, pevent-&gt;<a class="code" href="structEVENT__DEFRAG__BUFFER.html#a6666a955ee044c5cb083ba9b5bd03273">data_size</a>);
<a name="l07922"></a>07922 
<a name="l07923"></a>07923    <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="structEVENT__DEFRAG__BUFFER.html#ad8b633c7a00fdcad6feac94be036e69c">received</a> += pevent-&gt;data_size;
<a name="l07924"></a>07924 
<a name="l07925"></a>07925    <span class="keywordflow">if</span> (<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].received == <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].<a class="code" href="v1724__module_8c.html#af9bcc453896ea532710141c5a10fd347">data_size</a>) {
<a name="l07926"></a>07926       <span class="comment">/* event complete */</span>
<a name="l07927"></a>07927       dispatcher(buffer_handle, request_id, <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].pevent,
<a name="l07928"></a>07928                  <a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].pevent + 1);
<a name="l07929"></a>07929       free(<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].pevent);
<a name="l07930"></a>07930       memset(&amp;<a class="code" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[i].event_id, 0, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__DEFRAG__BUFFER.html">EVENT_DEFRAG_BUFFER</a>));
<a name="l07931"></a>07931    }
<a name="l07932"></a>07932 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga33221a55f8c90e411dea5eb34a2ee773"></a><!-- doxytag: member="midas.c::bm_delete_request" ref="ga33221a55f8c90e411dea5eb34a2ee773" args="(INT request_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_delete_request </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>request_id</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Deletes an event request previously done with <a class="el" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event()</a>. When an event request gets deleted, events of that requested type are not received any more. When a buffer is closed via <a class="el" href="group__msectionh.html#ga536a8e803f72f8f4a7e211846020a148">bm_close_buffer()</a>, all event requests from that buffer are deleted automatically </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>request_id</em>&nbsp;</td><td>request identifier given by <a class="el" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event()</a> </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l05993">5993</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00816">_request_list_entries</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8c_source.html#l05920">bm_remove_event_request()</a>, and <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l04611">bm_close_buffer()</a>, <a class="el" href="mevb_8cpp_source.html#l00826">source_unbooking()</a>, <a class="el" href="fal_8c_source.html#l02355">tr_poststop()</a>, <a class="el" href="mlogger_8c_source.html#l03482">tr_stop()</a>, and <a class="el" href="mana_8cpp_source.html#l03831">update_request()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l05994"></a>05994 {
<a name="l05995"></a>05995    <span class="keywordflow">if</span> (request_id &lt; 0 || request_id &gt;= <a class="code" href="group__midasincludecode.html#ga6dc3fd8dcb204a2379ed33a7e4645a2d">_request_list_entries</a>)
<a name="l05996"></a>05996       <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l05997"></a>05997 
<a name="l05998"></a>05998    <span class="comment">/* remove request entry from buffer */</span>
<a name="l05999"></a>05999    <a class="code" href="group__msystemincludecode.html#gaa5f9b3d058a8099c257f47885f8904af">bm_remove_event_request</a>(<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[request_id].buffer_handle, request_id);
<a name="l06000"></a>06000 
<a name="l06001"></a>06001    memset(&amp;<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[request_id], 0, <span class="keyword">sizeof</span>(<a class="code" href="structREQUEST__LIST.html">REQUEST_LIST</a>));
<a name="l06002"></a>06002 
<a name="l06003"></a>06003    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l06004"></a>06004 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga516c50d818df89f466ac1fc135120fa6"></a><!-- doxytag: member="midas.c::bm_empty_buffers" ref="ga516c50d818df89f466ac1fc135120fa6" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_empty_buffers </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>dox Clears event buffer and cache. If an event buffer is large and a consumer is slow in analyzing events, events are usually received some time after they are produced. This effect is even more experienced if a read cache is used (via <a class="el" href="group__msectionh.html#ga3d70a1e1e38b6ccf6bde4bc5b436ae5b">bm_set_cache_size()</a>). When changes to the hardware are made in the experience, the consumer will then still analyze old events before any new event which reflects the hardware change. Users can be fooled by looking at histograms which reflect the hardware change many seconds after they have been made.</p>
<p>To overcome this potential problem, the analyzer can call <a class="el" href="group__msectionh.html#ga0030916ebd7a3e32bfebd8da08b61dae">bm_empty_buffers()</a> just after the hardware change has been made which skips all old events contained in event buffers and read caches. Technically this is done by forwarding the read pointer of the client. No events are really deleted, they are still visible to other clients like the logger.</p>
<p>Note that the front-end also contains write buffers which can delay the delivery of events. The standard front-end framework <a class="el" href="show__pulses_8cxx.html#a63b96401309cc0c66ce6c88f1783d7c2">mfe.c</a> reduces this effect by flushing all buffers once every second. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l07751">7751</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="mana_8cpp_source.html#l00677">index</a>, <a class="el" href="midas_8h_source.html#l01301">BUFFER::read_cache_rp</a>, <a class="el" href="midas_8h_source.html#l01302">BUFFER::read_cache_wp</a>, <a class="el" href="midas_8h_source.html#l01261">BUFFER_CLIENT::read_pointer</a>, <a class="el" href="mrpc_8h_source.html#l00129">RPC_BM_EMPTY_BUFFERS</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09045">rpc_get_server_acception()</a>, <a class="el" href="midas_8c_source.html#l09250">rpc_get_server_option()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l00772">RPC_OSERVER_TYPE</a>, <a class="el" href="system_8c_source.html#l01050">ss_gettid()</a>, and <a class="el" href="midas_8h_source.html#l01791">ST_SINGLE</a>.</p>

<p>Referenced by <a class="el" href="mevb_8cpp_source.html#l00724">handFlush()</a>, <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>, <a class="el" href="mevb_8cpp_source.html#l00756">source_booking()</a>, and <a class="el" href="mevb_8cpp_source.html#l00826">source_unbooking()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l07752"></a>07752 {
<a name="l07753"></a>07753    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l07754"></a>07754       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#gabda66a6b961c81625a3185c68b2673f9">RPC_BM_EMPTY_BUFFERS</a>);
<a name="l07755"></a>07755 
<a name="l07756"></a>07756 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l07757"></a>07757 <span class="preprocessor"></span>   {
<a name="l07758"></a>07758       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, server_type, server_conn, tid;
<a name="l07759"></a>07759       <a class="code" href="structBUFFER.html">BUFFER</a> *pbuf;
<a name="l07760"></a>07760       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient;
<a name="l07761"></a>07761 
<a name="l07762"></a>07762       server_type = <a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>);
<a name="l07763"></a>07763       server_conn = <a class="code" href="group__msystemincludecode.html#ga55167513ac1295a246d69f378fc9d459">rpc_get_server_acception</a>();
<a name="l07764"></a>07764       tid = <a class="code" href="group__msystemincludecode.html#ga47dde62638a1a4e9f49534bff449ebcd">ss_gettid</a>();
<a name="l07765"></a>07765 
<a name="l07766"></a>07766       <span class="comment">/* go through all buffers */</span>
<a name="l07767"></a>07767       <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>; index++) {
<a name="l07768"></a>07768          <span class="keywordflow">if</span> (server_type == <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp; <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[index].index != server_conn)
<a name="l07769"></a>07769             <span class="keywordflow">continue</span>;
<a name="l07770"></a>07770 
<a name="l07771"></a>07771          <span class="keywordflow">if</span> (server_type != <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp; <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[index].index != tid)
<a name="l07772"></a>07772             <span class="keywordflow">continue</span>;
<a name="l07773"></a>07773 
<a name="l07774"></a>07774          <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[index].attached)
<a name="l07775"></a>07775             <span class="keywordflow">continue</span>;
<a name="l07776"></a>07776 
<a name="l07777"></a>07777          pbuf = &amp;<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[index];
<a name="l07778"></a>07778 
<a name="l07779"></a>07779          <span class="comment">/* empty cache */</span>
<a name="l07780"></a>07780          pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a> = pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> = 0;
<a name="l07781"></a>07781 
<a name="l07782"></a>07782          <span class="comment">/* set read pointer to write pointer */</span>
<a name="l07783"></a>07783          pclient = (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>)-&gt;client + pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>;
<a name="l07784"></a>07784          <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(index + 1);
<a name="l07785"></a>07785          pclient-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> = (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>)-&gt;write_pointer;
<a name="l07786"></a>07786          <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(index + 1);
<a name="l07787"></a>07787       }
<a name="l07788"></a>07788 
<a name="l07789"></a>07789    }
<a name="l07790"></a>07790 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l07791"></a>07791 
<a name="l07792"></a>07792    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l07793"></a>07793 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga9b74b8aa633c942682e642acba93c51d"></a><!-- doxytag: member="midas.c::bm_flush_cache" ref="ga9b74b8aa633c942682e642acba93c51d" args="(INT buffer_handle, INT async_flag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_flush_cache </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>async_flag</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Empty write cache. This function should be used if events in the write cache should be visible to the consumers immediately. It should be called at the end of each run, otherwise events could be kept in the write buffer and will flow to the data of the next run. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_handle</em>&nbsp;</td><td>Buffer handle obtained via <a class="el" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer()</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>async_flag</em>&nbsp;</td><td>Synchronous/asynchronous flag. If FALSE, the function blocks if the buffer has not enough free space to receive the full cache. If TRUE, the function returns immediately with a value of BM_ASYNC_RETURN without writing the cache. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE<br/>
 BM_ASYNC_RETURN Routine called with async_flag == TRUE and buffer has not enough space to receive cache<br/>
 BM_NO_MEMORY Event is too large for network buffer or event buffer. One has to increase MAX_EVENT_SIZE or EVENT_BUFFER_SIZE in <a class="el" href="generate-MODULES_8h.html#a00d5923485ea4382260221681abdb205">midas.h</a> and recompile. </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l06412">6412</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l00904">ALIGN8</a>, <a class="el" href="midas_8h_source.html#l01295">BUFFER::attached</a>, <a class="el" href="midas_8h_source.html#l00985">BM_ASYNC_RETURN</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8c_source.html#l04327">bm_match_event()</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01288">BUFFER_HEADER::client</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="midas_8h_source.html#l01195">EVENT_HEADER::data_size</a>, <a class="el" href="midas_8h_source.html#l01248">EVENT_REQUEST::event_id</a>, <a class="el" href="midas_8h_source.html#l01274">BUFFER_CLIENT::event_request</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="midas_8h_source.html#l00728">GET_ALL</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="midas_8h_source.html#l01246">EVENT_REQUEST::id</a>, <a class="el" href="generate-MODULES_8h_source.html#l00003">if</a>, <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00290">increment</a>, <a class="el" href="odbhist_8c_source.html#l00058">j</a>, <a class="el" href="midas_8h_source.html#l01281">BUFFER_HEADER::max_client_index</a>, <a class="el" href="midas_8h_source.html#l01262">BUFFER_CLIENT::max_request_index</a>, <a class="el" href="midas_8h_source.html#l00935">MDEBUG</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="msystem_8h_source.html#l00399">MSG_BM</a>, <a class="el" href="midas_8h_source.html#l01279">BUFFER_HEADER::name</a>, <a class="el" href="midas_8h_source.html#l01285">BUFFER_HEADER::num_in_events</a>, <a class="el" href="midas_8h_source.html#l01257">BUFFER_CLIENT::pid</a>, <a class="el" href="midas_8h_source.html#l01260">BUFFER_CLIENT::port</a>, <a class="el" href="midas_8h_source.html#l01261">BUFFER_CLIENT::read_pointer</a>, <a class="el" href="midas_8h_source.html#l01283">BUFFER_HEADER::read_pointer</a>, <a class="el" href="midas_8h_source.html#l01267">BUFFER_CLIENT::read_wait</a>, <a class="el" href="mrpc_8h_source.html#l00126">RPC_BM_FLUSH_CACHE</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l01250">EVENT_REQUEST::sampling_type</a>, <a class="el" href="midas_8h_source.html#l01282">BUFFER_HEADER::size</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="midas_8h_source.html#l01047">SS_ABORT</a>, <a class="el" href="system_8c_source.html#l03549">ss_resume()</a>, <a class="el" href="system_8c_source.html#l03283">ss_suspend()</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, <a class="el" href="midas_8h_source.html#l01249">EVENT_REQUEST::trigger_mask</a>, <a class="el" href="p30_8h_source.html#l00043">TRUE</a>, <a class="el" href="midas_8h_source.html#l01247">EVENT_REQUEST::valid</a>, <a class="el" href="midas_8h_source.html#l01303">BUFFER::write_cache</a>, <a class="el" href="midas_8h_source.html#l01305">BUFFER::write_cache_rp</a>, <a class="el" href="midas_8h_source.html#l01304">BUFFER::write_cache_size</a>, <a class="el" href="midas_8h_source.html#l01306">BUFFER::write_cache_wp</a>, <a class="el" href="midas_8h_source.html#l01284">BUFFER_HEADER::write_pointer</a>, and <a class="el" href="midas_8h_source.html#l01268">BUFFER_CLIENT::write_wait</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l06057">bm_send_event()</a>, <a class="el" href="mevb_8cpp_source.html#l00866">close_buffers()</a>, <a class="el" href="midas_8c_source.html#l17413">dm_buffer_send()</a>, <a class="el" href="old__mevb_8cpp_source.html#l00658">main()</a>, <a class="el" href="crate3_2rpc__slave_8cpp_source.html#l00049">rpc_end_of_cycle()</a>, <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>, <a class="el" href="mevb_8cpp_source.html#l00370">scan_fragment()</a>, <a class="el" href="crate6__CAEN__TDC_2mfe__mucap_8c_source.html#l01446">scheduler()</a>, <a class="el" href="crate6__CAEN__TDC_2mfe__mucap_8c_source.html#l01003">send_event()</a>, <a class="el" href="crate6__CAEN__TDC_2mfe__mucap_8c_source.html#l00442">tr_prestop()</a>, and <a class="el" href="crate9_2mfe__mucap_8c_source.html#l00422">tr_stop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l06413"></a>06413 {
<a name="l06414"></a>06414    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l06415"></a>06415       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#gaea9459a45b400149d4e5910a5da5e52c">RPC_BM_FLUSH_CACHE</a>, buffer_handle, async_flag);
<a name="l06416"></a>06416 
<a name="l06417"></a>06417 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l06418"></a>06418 <span class="preprocessor"></span>   {
<a name="l06419"></a>06419       <a class="code" href="structBUFFER.html">BUFFER</a> *pbuf;
<a name="l06420"></a>06420       <a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a> *pheader;
<a name="l06421"></a>06421       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient, *pc;
<a name="l06422"></a>06422       <a class="code" href="structEVENT__REQUEST.html">EVENT_REQUEST</a> *prequest;
<a name="l06423"></a>06423       <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent, *pevent_test;
<a name="l06424"></a>06424       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, min_wp, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, total_size, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l06425"></a>06425       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#ac017f6d6a9757a5cc0ef17db878555b7">increment</a>;
<a name="l06426"></a>06426       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> my_client_index;
<a name="l06427"></a>06427       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> old_write_pointer;
<a name="l06428"></a>06428       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> old_read_pointer, new_read_pointer;
<a name="l06429"></a>06429       <span class="keywordtype">char</span> *pdata;
<a name="l06430"></a>06430       <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> blocking;
<a name="l06431"></a>06431       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> n_blocking;
<a name="l06432"></a>06432       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> request_id;
<a name="l06433"></a>06433       <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[80];
<a name="l06434"></a>06434 
<a name="l06435"></a>06435       pbuf = &amp;<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1];
<a name="l06436"></a>06436 
<a name="l06437"></a>06437       <span class="keywordflow">if</span> (buffer_handle &gt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> || buffer_handle &lt;= 0) {
<a name="l06438"></a>06438          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_flush_cache&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l06439"></a>06439          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l06440"></a>06440       }
<a name="l06441"></a>06441 
<a name="l06442"></a>06442       <span class="keywordflow">if</span> (!pbuf-&gt;<a class="code" href="structBUFFER.html#a495ba8d2558dac6d40a46564c5067a2c">attached</a>) {
<a name="l06443"></a>06443          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_flush_cache&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l06444"></a>06444          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l06445"></a>06445       }
<a name="l06446"></a>06446 
<a name="l06447"></a>06447       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga88f5da13720c678e5d2facd5a61e15be">write_cache_size</a> == 0)
<a name="l06448"></a>06448          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l06449"></a>06449 
<a name="l06450"></a>06450       <span class="comment">/* check if anything needs to be flushed */</span>
<a name="l06451"></a>06451       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga70b3193c3c9315051f94e478bba3ae58">write_cache_rp</a> == pbuf-&gt;<a class="code" href="group__midasincludecode.html#gac088f845fc97e9ce149b36a94644a9b4">write_cache_wp</a>)
<a name="l06452"></a>06452          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l06453"></a>06453 
<a name="l06454"></a>06454       <span class="comment">/* calculate some shorthands */</span>
<a name="l06455"></a>06455       pheader = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>;
<a name="l06456"></a>06456       pdata = (<span class="keywordtype">char</span> *) (pheader + 1);
<a name="l06457"></a>06457       my_client_index = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>;
<a name="l06458"></a>06458       pclient = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>;
<a name="l06459"></a>06459       pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga99f8e53c723d75ba23267ae71309c6e7">write_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga70b3193c3c9315051f94e478bba3ae58">write_cache_rp</a>);
<a name="l06460"></a>06460 
<a name="l06461"></a>06461       <span class="comment">/* lock the buffer */</span>
<a name="l06462"></a>06462       <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l06463"></a>06463 
<a name="l06464"></a>06464 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06465"></a>06465 <span class="preprocessor"></span>      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_flush_cache initial: rp=%d, wp=%d&quot;</span>, pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l06466"></a>06466              pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06467"></a>06467 <span class="preprocessor">#endif</span>
<a name="l06468"></a>06468 <span class="preprocessor"></span>
<a name="l06469"></a>06469       <span class="comment">/* check if enough space in buffer left */</span>
<a name="l06470"></a>06470       <span class="keywordflow">do</span> {
<a name="l06471"></a>06471          size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06472"></a>06472          <span class="keywordflow">if</span> (size &lt;= 0)
<a name="l06473"></a>06473             size += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06474"></a>06474 
<a name="l06475"></a>06475          <span class="keywordflow">if</span> (size &lt;= pbuf-&gt;write_cache_wp) {
<a name="l06476"></a>06476             <span class="comment">/* if not enough space, find out who&apos;s blocking */</span>
<a name="l06477"></a>06477             n_blocking = 0;
<a name="l06478"></a>06478 
<a name="l06479"></a>06479             <span class="keywordflow">for</span> (i = 0, pc = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pc++)
<a name="l06480"></a>06480                <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a>) {
<a name="l06481"></a>06481                   <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> == pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>) {
<a name="l06482"></a>06482                      <span class="comment">/*</span>
<a name="l06483"></a>06483 <span class="comment">                        First assume that the client with the &quot;minimum&quot; read pointer</span>
<a name="l06484"></a>06484 <span class="comment">                        is not really blocking due to a GET_ALL request.</span>
<a name="l06485"></a>06485 <span class="comment">                      */</span>
<a name="l06486"></a>06486                      blocking = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l06487"></a>06487                      request_id = -1;
<a name="l06488"></a>06488 
<a name="l06489"></a>06489                      <span class="comment">/* check if this request blocks. */</span>
<a name="l06490"></a>06490                      prequest = pc-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>;
<a name="l06491"></a>06491                      pevent_test = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pdata + pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>);
<a name="l06492"></a>06492 
<a name="l06493"></a>06493                      <span class="keywordflow">for</span> (j = 0; j &lt; pc-&gt;<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a>; j++, prequest++)
<a name="l06494"></a>06494                         <span class="keywordflow">if</span> (prequest-&gt;<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a> &amp;&amp;
<a name="l06495"></a>06495                             <a class="code" href="group__bmfunctionc.html#ga181dcf462745127aa3d011a2e3fee805">bm_match_event</a>(prequest-&gt;<a class="code" href="group__midasincludecode.html#ga861d57422d21affdcfe60a67a3f8cb7f">event_id</a>, prequest-&gt;<a class="code" href="group__midasincludecode.html#ga8947eb12d18f6202ecc9d603f3bde410">trigger_mask</a>,
<a name="l06496"></a>06496                                            pevent_test)) {
<a name="l06497"></a>06497                            request_id = prequest-&gt;<a class="code" href="structEVENT__REQUEST.html#ab5275898e99714ff529f7fe125a91d0e">id</a>;
<a name="l06498"></a>06498                            <span class="keywordflow">if</span> (prequest-&gt;<a class="code" href="group__midasincludecode.html#ga98d63806bfe8b8d66fad6d3d6d9b08e4">sampling_type</a> &amp; <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>) {
<a name="l06499"></a>06499                               blocking = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l06500"></a>06500                               <span class="keywordflow">break</span>;
<a name="l06501"></a>06501                            }
<a name="l06502"></a>06502                         }
<a name="l06503"></a>06503 
<a name="l06504"></a>06504                      <span class="keywordflow">if</span> (!blocking) {
<a name="l06505"></a>06505                         <span class="comment">/*</span>
<a name="l06506"></a>06506 <span class="comment">                           The blocking guy has no GET_ALL request for this event</span>
<a name="l06507"></a>06507 <span class="comment">                           -&gt; shift its read pointer.</span>
<a name="l06508"></a>06508 <span class="comment">                         */</span>
<a name="l06509"></a>06509 
<a name="l06510"></a>06510                         old_read_pointer = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l06511"></a>06511 
<a name="l06512"></a>06512                         increment = <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) +
<a name="l06513"></a>06513                             ((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pdata + pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>))-&gt;data_size;
<a name="l06514"></a>06514 
<a name="l06515"></a>06515                         <span class="comment">/* correct increment for DWORD boundary */</span>
<a name="l06516"></a>06516                         increment = <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(increment);
<a name="l06517"></a>06517 
<a name="l06518"></a>06518                         new_read_pointer = (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> + increment) % pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06519"></a>06519 
<a name="l06520"></a>06520                         <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (new_read_pointer &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l06521"></a>06521                            new_read_pointer = 0;
<a name="l06522"></a>06522 
<a name="l06523"></a>06523 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06524"></a>06524 <span class="preprocessor"></span>                        <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_flush_cache: shift client %d rp=%d -&gt; =%d&quot;</span>, i,
<a name="l06525"></a>06525                                pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>, new_read_pointer);
<a name="l06526"></a>06526 <span class="preprocessor">#endif</span>
<a name="l06527"></a>06527 <span class="preprocessor"></span>
<a name="l06528"></a>06528                         pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> = new_read_pointer;
<a name="l06529"></a>06529                      } <span class="keywordflow">else</span> {
<a name="l06530"></a>06530                         n_blocking++;
<a name="l06531"></a>06531                      }
<a name="l06532"></a>06532 
<a name="l06533"></a>06533                      <span class="comment">/* wake that client if it has a request */</span>
<a name="l06534"></a>06534                      <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#ga896acd334d608006626fcca2a872a4a4">read_wait</a> &amp;&amp; request_id != -1) {
<a name="l06535"></a>06535 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06536"></a>06536 <span class="preprocessor"></span>                        <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Send wake: rp=%d, wp=%d&quot;</span>,
<a name="l06537"></a>06537                                pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>, pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06538"></a>06538 <span class="preprocessor">#endif</span>
<a name="l06539"></a>06539 <span class="preprocessor"></span>                        sprintf(str, <span class="stringliteral">&quot;B %s %d&quot;</span>, pheader-&gt;<a class="code" href="structBUFFER__HEADER.html#a40ea1b56ee55965c4d61e6da5ae57022">name</a>, request_id);
<a name="l06540"></a>06540                         <a class="code" href="group__msystemincludecode.html#ga2f07c99535bcb2959efc54c5cdbf6747">ss_resume</a>(pc-&gt;<a class="code" href="group__midasincludecode.html#gad8112ed9dd177230ff2a9acfd84c5429">port</a>, str);
<a name="l06541"></a>06541                      }
<a name="l06542"></a>06542 
<a name="l06543"></a>06543 
<a name="l06544"></a>06544                   }             <span class="comment">/* read_pointer blocks */</span>
<a name="l06545"></a>06545                }
<a name="l06546"></a>06546             <span class="comment">/* client loop */</span>
<a name="l06547"></a>06547             <span class="keywordflow">if</span> (n_blocking &gt; 0) {
<a name="l06548"></a>06548                <span class="comment">/* at least one client is blocking */</span>
<a name="l06549"></a>06549 
<a name="l06550"></a>06550                <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l06551"></a>06551 
<a name="l06552"></a>06552                <span class="comment">/* return now in ASYNC mode */</span>
<a name="l06553"></a>06553                <span class="keywordflow">if</span> (async_flag)
<a name="l06554"></a>06554                   <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga7fb11aaff606b1785cddd205baddbbff">BM_ASYNC_RETURN</a>;
<a name="l06555"></a>06555 
<a name="l06556"></a>06556 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06557"></a>06557 <span class="preprocessor"></span>               <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Send sleep: rp=%d, wp=%d, level=%1.1lf&quot;</span>,
<a name="l06558"></a>06558                       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l06559"></a>06559                       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, 100 - 100.0 * size / pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>);
<a name="l06560"></a>06560 <span class="preprocessor">#endif</span>
<a name="l06561"></a>06561 <span class="preprocessor"></span>
<a name="l06562"></a>06562                <span class="comment">/* has the read pointer moved in between ? */</span>
<a name="l06563"></a>06563                size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06564"></a>06564                <span class="keywordflow">if</span> (size &lt;= 0)
<a name="l06565"></a>06565                   size += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06566"></a>06566 
<a name="l06567"></a>06567                <span class="comment">/* suspend process */</span>
<a name="l06568"></a>06568                <span class="keywordflow">if</span> (size &lt;= pbuf-&gt;write_cache_wp) {
<a name="l06569"></a>06569                   <span class="comment">/* signal other clients wait mode */</span>
<a name="l06570"></a>06570                   pclient[my_client_index].<a class="code" href="group__midasincludecode.html#ga884b0a6395661ef9f711fa3ca7bc19b6">write_wait</a> = pbuf-&gt;<a class="code" href="group__midasincludecode.html#gac088f845fc97e9ce149b36a94644a9b4">write_cache_wp</a>;
<a name="l06571"></a>06571 
<a name="l06572"></a>06572                   status = <a class="code" href="group__msystemincludecode.html#ga057bcc23c79e804679785d98b1223bd1">ss_suspend</a>(1000, <a class="code" href="group__msystemincludecode.html#ga6e9a9a9996cea71191a21fd2009efcd1">MSG_BM</a>);
<a name="l06573"></a>06573 
<a name="l06574"></a>06574                   pclient[my_client_index].<a class="code" href="group__midasincludecode.html#ga884b0a6395661ef9f711fa3ca7bc19b6">write_wait</a> = 0;
<a name="l06575"></a>06575 
<a name="l06576"></a>06576                   <span class="comment">/* return if TCP connection broken */</span>
<a name="l06577"></a>06577                   <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>)
<a name="l06578"></a>06578                      <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>;
<a name="l06579"></a>06579                }
<a name="l06580"></a>06580 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06581"></a>06581 <span class="preprocessor"></span>               <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Send woke up: rp=%d, wp=%d, level=%1.1lf&quot;</span>,
<a name="l06582"></a>06582                       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l06583"></a>06583                       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, 100 - 100.0 * size / pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>);
<a name="l06584"></a>06584 <span class="preprocessor">#endif</span>
<a name="l06585"></a>06585 <span class="preprocessor"></span>
<a name="l06586"></a>06586                <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l06587"></a>06587 
<a name="l06588"></a>06588                <span class="comment">/* has the write pointer moved in between ? */</span>
<a name="l06589"></a>06589                size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06590"></a>06590                <span class="keywordflow">if</span> (size &lt;= 0)
<a name="l06591"></a>06591                   size += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06592"></a>06592             } <span class="keywordflow">else</span> {
<a name="l06593"></a>06593                <span class="comment">/*</span>
<a name="l06594"></a>06594 <span class="comment">                  calculate new global read pointer as &quot;minimum&quot; of</span>
<a name="l06595"></a>06595 <span class="comment">                  client read pointers</span>
<a name="l06596"></a>06596 <span class="comment">                */</span>
<a name="l06597"></a>06597                min_wp = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06598"></a>06598 
<a name="l06599"></a>06599                <span class="keywordflow">for</span> (i = 0, pc = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pc++)
<a name="l06600"></a>06600                   <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a>) {
<a name="l06601"></a>06601                      <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &lt; min_wp)
<a name="l06602"></a>06602                         min_wp = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l06603"></a>06603 
<a name="l06604"></a>06604                      <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> &amp;&amp;
<a name="l06605"></a>06605                          pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> &lt; min_wp)
<a name="l06606"></a>06606                         min_wp = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06607"></a>06607                   }
<a name="l06608"></a>06608 
<a name="l06609"></a>06609                <span class="keywordflow">if</span> (min_wp &lt; 0)
<a name="l06610"></a>06610                   min_wp += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06611"></a>06611 
<a name="l06612"></a>06612                pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> = min_wp;
<a name="l06613"></a>06613             }
<a name="l06614"></a>06614 
<a name="l06615"></a>06615          }
<a name="l06616"></a>06616          <span class="comment">/* if (size &lt;= total_size) */</span>
<a name="l06617"></a>06617       } <span class="keywordflow">while</span> (size &lt;= pbuf-&gt;write_cache_wp);
<a name="l06618"></a>06618 
<a name="l06619"></a>06619 
<a name="l06620"></a>06620       <span class="comment">/* we have space, so let&apos;s copy the event */</span>
<a name="l06621"></a>06621       old_write_pointer = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06622"></a>06622 
<a name="l06623"></a>06623 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06624"></a>06624 <span class="preprocessor"></span>      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_flush_cache: found space rp=%d, wp=%d&quot;</span>, pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l06625"></a>06625              pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06626"></a>06626 <span class="preprocessor">#endif</span>
<a name="l06627"></a>06627 <span class="preprocessor"></span>
<a name="l06628"></a>06628       <span class="keywordflow">while</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga70b3193c3c9315051f94e478bba3ae58">write_cache_rp</a> &lt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gac088f845fc97e9ce149b36a94644a9b4">write_cache_wp</a>) {
<a name="l06629"></a>06629          <span class="comment">/* loop over all events in cache */</span>
<a name="l06630"></a>06630 
<a name="l06631"></a>06631          pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga99f8e53c723d75ba23267ae71309c6e7">write_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga70b3193c3c9315051f94e478bba3ae58">write_cache_rp</a>);
<a name="l06632"></a>06632          total_size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l06633"></a>06633 
<a name="l06634"></a>06634          <span class="comment">/* correct size for DWORD boundary */</span>
<a name="l06635"></a>06635          total_size = <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(total_size);
<a name="l06636"></a>06636 
<a name="l06637"></a>06637          <span class="keywordflow">if</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> + total_size &lt;= pheader-&gt;size) {
<a name="l06638"></a>06638             memcpy(pdata + pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, pevent, total_size);
<a name="l06639"></a>06639             pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> = (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> + total_size) %
<a name="l06640"></a>06640                 pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06641"></a>06641             <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l06642"></a>06642                pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> = 0;
<a name="l06643"></a>06643          } <span class="keywordflow">else</span> {
<a name="l06644"></a>06644             <span class="comment">/* split event */</span>
<a name="l06645"></a>06645             size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06646"></a>06646 
<a name="l06647"></a>06647             memcpy(pdata + pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, pevent, size);
<a name="l06648"></a>06648             memcpy(pdata, (<span class="keywordtype">char</span> *) pevent + size, total_size - size);
<a name="l06649"></a>06649 
<a name="l06650"></a>06650             pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> = total_size - size;
<a name="l06651"></a>06651          }
<a name="l06652"></a>06652 
<a name="l06653"></a>06653          pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga70b3193c3c9315051f94e478bba3ae58">write_cache_rp</a> += total_size;
<a name="l06654"></a>06654       }
<a name="l06655"></a>06655 
<a name="l06656"></a>06656       pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga70b3193c3c9315051f94e478bba3ae58">write_cache_rp</a> = pbuf-&gt;<a class="code" href="group__midasincludecode.html#gac088f845fc97e9ce149b36a94644a9b4">write_cache_wp</a> = 0;
<a name="l06657"></a>06657 
<a name="l06658"></a>06658       <span class="comment">/* check which clients are waiting */</span>
<a name="l06659"></a>06659       <span class="keywordflow">for</span> (i = 0; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++)
<a name="l06660"></a>06660          <span class="keywordflow">if</span> (pclient[i].pid &amp;&amp; pclient[i].read_wait) {
<a name="l06661"></a>06661 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06662"></a>06662 <span class="preprocessor"></span>            <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Send wake: rp=%d, wp=%d&quot;</span>, pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l06663"></a>06663                    pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06664"></a>06664 <span class="preprocessor">#endif</span>
<a name="l06665"></a>06665 <span class="preprocessor"></span>            sprintf(str, <span class="stringliteral">&quot;B %s %d&quot;</span>, pheader-&gt;<a class="code" href="structBUFFER__HEADER.html#a40ea1b56ee55965c4d61e6da5ae57022">name</a>, -1);
<a name="l06666"></a>06666             <a class="code" href="group__msystemincludecode.html#ga2f07c99535bcb2959efc54c5cdbf6747">ss_resume</a>(pclient[i].port, str);
<a name="l06667"></a>06667          }
<a name="l06668"></a>06668 
<a name="l06669"></a>06669       <span class="comment">/* shift read pointer of own client */</span>
<a name="l06670"></a>06670 <span class="comment">/* 16.4.99 SR, outcommented to receive own messages</span>
<a name="l06671"></a>06671 <span class="comment"></span>
<a name="l06672"></a>06672 <span class="comment">  if (pclient[my_client_index].read_pointer == old_write_pointer)</span>
<a name="l06673"></a>06673 <span class="comment">    pclient[my_client_index].read_pointer = pheader-&gt;write_pointer;</span>
<a name="l06674"></a>06674 <span class="comment">*/</span>
<a name="l06675"></a>06675 
<a name="l06676"></a>06676       <span class="comment">/* calculate global read pointer as &quot;minimum&quot; of client read pointers */</span>
<a name="l06677"></a>06677       min_wp = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06678"></a>06678 
<a name="l06679"></a>06679       <span class="keywordflow">for</span> (i = 0, pc = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pc++)
<a name="l06680"></a>06680          <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a>) {
<a name="l06681"></a>06681 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06682"></a>06682 <span class="preprocessor"></span>            <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_flush_cache: client %d rp=%d&quot;</span>, i, pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>);
<a name="l06683"></a>06683 <span class="preprocessor">#endif</span>
<a name="l06684"></a>06684 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &lt; min_wp)
<a name="l06685"></a>06685                min_wp = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l06686"></a>06686 
<a name="l06687"></a>06687             <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> &amp;&amp;
<a name="l06688"></a>06688                 pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> &lt; min_wp)
<a name="l06689"></a>06689                min_wp = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06690"></a>06690          }
<a name="l06691"></a>06691 
<a name="l06692"></a>06692       <span class="keywordflow">if</span> (min_wp &lt; 0)
<a name="l06693"></a>06693          min_wp += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06694"></a>06694 
<a name="l06695"></a>06695 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06696"></a>06696 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (min_wp == pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>)
<a name="l06697"></a>06697          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_flush_cache -&gt; wp=%d&quot;</span>, pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06698"></a>06698       <span class="keywordflow">else</span>
<a name="l06699"></a>06699          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_flush_cache -&gt; wp=%d, rp %d -&gt; %d, size=%d&quot;</span>,
<a name="l06700"></a>06700                 pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>, min_wp, size);
<a name="l06701"></a>06701 <span class="preprocessor">#endif</span>
<a name="l06702"></a>06702 <span class="preprocessor"></span>
<a name="l06703"></a>06703       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> = min_wp;
<a name="l06704"></a>06704 
<a name="l06705"></a>06705       <span class="comment">/* update statistics */</span>
<a name="l06706"></a>06706       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga1cb3b9436d59dba0946de51581e68fbd">num_in_events</a>++;
<a name="l06707"></a>06707 
<a name="l06708"></a>06708       <span class="comment">/* unlock the buffer */</span>
<a name="l06709"></a>06709       <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l06710"></a>06710    }
<a name="l06711"></a>06711 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l06712"></a>06712 
<a name="l06713"></a>06713    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l06714"></a>06714 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="gad5d9446689e7764c046be255a63662c0"></a><!-- doxytag: member="midas.c::bm_mark_read_waiting" ref="gad5d9446689e7764c046be255a63662c0" args="(BOOL flag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_mark_read_waiting </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&nbsp;</td>
          <td class="paramname"> <em>flag</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>dox </p>

<p>Definition at line <a class="el" href="midas_8c_source.html#l07495">7495</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01288">BUFFER_HEADER::client</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="mana_8cpp_source.html#l00677">index</a>, <a class="el" href="midas_8h_source.html#l01267">BUFFER_CLIENT::read_wait</a>, <a class="el" href="mrpc_8h_source.html#l00128">RPC_BM_MARK_READ_WAITING</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09045">rpc_get_server_acception()</a>, <a class="el" href="midas_8c_source.html#l09250">rpc_get_server_option()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l00772">RPC_OSERVER_TYPE</a>, <a class="el" href="system_8c_source.html#l01050">ss_gettid()</a>, and <a class="el" href="midas_8h_source.html#l01791">ST_SINGLE</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l04389">bm_open_buffer()</a>, <a class="el" href="midas_8c_source.html#l07616">bm_poll_event()</a>, <a class="el" href="midas_8c_source.html#l04166">cm_yield()</a>, and <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l07498"></a>07498          : <a class="code" href="group__msystemincludecode.html#ga72da25e2d09e1278ecd4a93b5b7f9114">bm_mark_read_waiting</a>
<a name="l07499"></a>07499 
<a name="l07500"></a>07500   Purpose: Mark all open buffers <a class="code" href="crate3_2rpc__master_8cpp.html#a0373285036a176709fe00acabb111198">ready</a> <span class="keywordflow">for</span> receiving events.
<a name="l07501"></a>07501            Called internally <a class="code" href="patch__mevb_8cpp.html#a944cf20aa75177818af16fe394e984be">by</a> <a class="code" href="group__msystemincludecode.html#ga057bcc23c79e804679785d98b1223bd1">ss_suspend</a>
<a name="l07502"></a>07502 
<a name="l07503"></a>07503 
<a name="l07504"></a>07504   Input:
<a name="l07505"></a>07505     <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>               <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> <span class="keywordflow">for</span> waiting, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> <span class="keywordflow">for</span> not waiting
<a name="l07506"></a>07506 
<a name="l07507"></a>07507   Output:
<a name="l07508"></a>07508     none
<a name="l07509"></a>07509 
<a name="l07510"></a>07510   Function <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>:
<a name="l07511"></a>07511     <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>              Successful completion
<a name="l07512"></a>07512 
<a name="l07513"></a>07513 \********************************************************************/
<a name="l07514"></a>07514 {
<a name="l07515"></a>07515    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l07516"></a>07516       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#ga1990e62135e38d4070c1eb69cbf7a291">RPC_BM_MARK_READ_WAITING</a>, <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>);
<a name="l07517"></a>07517 
<a name="l07518"></a>07518 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l07519"></a>07519 <span class="preprocessor"></span>   {
<a name="l07520"></a>07520       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l07521"></a>07521       <a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a> *pheader;
<a name="l07522"></a>07522       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient;
<a name="l07523"></a>07523 
<a name="l07524"></a>07524       <span class="comment">/* Mark all buffer for read waiting */</span>
<a name="l07525"></a>07525       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>; i++) {
<a name="l07526"></a>07526          <span class="keywordflow">if</span> (<a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>) == <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp;
<a name="l07527"></a>07527              <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a> != <a class="code" href="group__msystemincludecode.html#ga55167513ac1295a246d69f378fc9d459">rpc_get_server_acception</a>())
<a name="l07528"></a>07528             <span class="keywordflow">continue</span>;
<a name="l07529"></a>07529 
<a name="l07530"></a>07530          <span class="keywordflow">if</span> (<a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>) != <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp;
<a name="l07531"></a>07531              <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a> != <a class="code" href="group__msystemincludecode.html#ga47dde62638a1a4e9f49534bff449ebcd">ss_gettid</a>())
<a name="l07532"></a>07532             <span class="keywordflow">continue</span>;
<a name="l07533"></a>07533 
<a name="l07534"></a>07534          <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].attached)
<a name="l07535"></a>07535             <span class="keywordflow">continue</span>;
<a name="l07536"></a>07536 
<a name="l07537"></a>07537          pheader = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>;
<a name="l07538"></a>07538          pclient = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a> + <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>;
<a name="l07539"></a>07539          pclient-&gt;<a class="code" href="group__midasincludecode.html#ga896acd334d608006626fcca2a872a4a4">read_wait</a> = <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l07540"></a>07540       }
<a name="l07541"></a>07541    }
<a name="l07542"></a>07542 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l07543"></a>07543 
<a name="l07544"></a>07544    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l07545"></a>07545 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga181dcf462745127aa3d011a2e3fee805"></a><!-- doxytag: member="midas.c::bm_match_event" ref="ga181dcf462745127aa3d011a2e3fee805" args="(short int event_id, short int trigger_mask, EVENT_HEADER *pevent)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_match_event </td>
          <td>(</td>
          <td class="paramtype">short int&nbsp;</td>
          <td class="paramname"> <em>event_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int&nbsp;</td>
          <td class="paramname"> <em>trigger_mask</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *&nbsp;</td>
          <td class="paramname"> <em>pevent</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Check if an event matches a given event request by the event id and trigger mask </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>event_id</em>&nbsp;</td><td>Event ID of request </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>trigger_mask</em>&nbsp;</td><td>Trigger mask of request </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pevent</em>&nbsp;</td><td>Pointer to event to check </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>TRUE if event matches request </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l04327">4327</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8h_source.html#l01191">EVENT_HEADER::event_id</a>, <a class="el" href="midas_8h_source.html#l00919">EVENTID_ALL</a>, <a class="el" href="midas_8h_source.html#l01236">EVENTID_FRAG</a>, <a class="el" href="midas_8h_source.html#l01235">EVENTID_FRAG1</a>, <a class="el" href="midas_8h_source.html#l00920">TRIGGER_ALL</a>, and <a class="el" href="midas_8h_source.html#l01192">EVENT_HEADER::trigger_mask</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l06412">bm_flush_cache()</a>, <a class="el" href="midas_8c_source.html#l07616">bm_poll_event()</a>, <a class="el" href="midas_8c_source.html#l07157">bm_push_event()</a>, <a class="el" href="midas_8c_source.html#l06777">bm_receive_event()</a>, and <a class="el" href="midas_8c_source.html#l06057">bm_send_event()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04328"></a>04328 {
<a name="l04329"></a>04329    <span class="keywordflow">if</span> ((pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xF000) == <a class="code" href="group__mbufferh.html#gaae07538917933e32355933ac1e2e3d60">EVENTID_FRAG1</a> ||
<a name="l04330"></a>04330        (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xF000) == <a class="code" href="group__mbufferh.html#ga4fb6de5cc7e1f2da82266094a02d0ff7">EVENTID_FRAG</a>)
<a name="l04331"></a>04331       <span class="comment">/* fragmented event */</span>
<a name="l04332"></a>04332       <span class="keywordflow">return</span> ((<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> == <a class="code" href="group__mdefineh.html#gabd88aa902705997125b541db3b94578c">EVENTID_ALL</a> ||
<a name="l04333"></a>04333                <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> == (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0x0FFF)) &amp;&amp;
<a name="l04334"></a>04334               (<a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a> == <a class="code" href="group__mdefineh.html#ga26aa4bcea89857cb7ca669339695ceac">TRIGGER_ALL</a> || (<a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a> &amp; pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>)));
<a name="l04335"></a>04335 
<a name="l04336"></a>04336    <span class="keywordflow">return</span> ((<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> == <a class="code" href="group__mdefineh.html#gabd88aa902705997125b541db3b94578c">EVENTID_ALL</a> ||
<a name="l04337"></a>04337             <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> == pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>) &amp;&amp;
<a name="l04338"></a>04338            (<a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a> == <a class="code" href="group__mdefineh.html#ga26aa4bcea89857cb7ca669339695ceac">TRIGGER_ALL</a> || (<a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a> &amp; pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>)));
<a name="l04339"></a>04339 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga1aa8d2711c26626d76e52715c9a568d0"></a><!-- doxytag: member="midas.c::bm_notify_client" ref="ga1aa8d2711c26626d76e52715c9a568d0" args="(char *buffer_name, int socket)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_notify_client </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buffer_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>socket</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="midas_8c_source.html#l07548">7548</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="fal_8c_source.html#l00201">buffer</a>, <a class="el" href="mserver_8c_source.html#l00190">callback</a>, <a class="el" href="midas_8h_source.html#l01822">CF_ASCII</a>, <a class="el" href="midas_8h_source.html#l01001">DB_SUCCESS</a>, <a class="el" href="msystem_8h_source.html#l00386">NET_COMMAND::header</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="mevb_8cpp_source.html#l00090">last_time</a>, <a class="el" href="msystem_8h_source.html#l00399">MSG_BM</a>, <a class="el" href="msystem_8h_source.html#l00382">NET_COMMAND_HEADER::param_size</a>, <a class="el" href="msystem_8h_source.html#l00381">NET_COMMAND_HEADER::routine_id</a>, <a class="el" href="midas_8h_source.html#l00774">RPC_CONVERT_FLAGS</a>, <a class="el" href="midas_8c_source.html#l08079">rpc_convert_single()</a>, <a class="el" href="midas_8c_source.html#l09250">rpc_get_server_option()</a>, <a class="el" href="midas_8h_source.html#l01786">RPC_OUTGOING</a>, <a class="el" href="system_8c_source.html#l03606">send_tcp()</a>, <a class="el" href="system_8c_source.html#l02265">ss_millitime()</a>, and <a class="el" href="midas_8h_source.html#l00740">TID_DWORD</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l04080">cm_dispatch_ipc()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l07551"></a>07551          : <a class="code" href="group__msystemincludecode.html#ga1aa8d2711c26626d76e52715c9a568d0">bm_notify_client</a>
<a name="l07552"></a>07552 
<a name="l07553"></a>07553   Purpose: Called <a class="code" href="patch__mevb_8cpp.html#a944cf20aa75177818af16fe394e984be">by</a> <a class="code" href="group__msystemincludecode.html#ga6a36db7a5cf4cd8f25b530b074128826">cm_dispatch_ipc</a>. Send an <span class="keyword">event</span> notification to
<a name="l07554"></a>07554            the <a class="code" href="mhttpd_8c.html#abc82b64a25110404c4a845a5e969b348">connected</a> client
<a name="l07555"></a>07555 
<a name="l07556"></a>07556   Input:
<a name="l07557"></a>07557     <span class="keywordtype">char</span>  *<a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>      Name of <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>
<a name="l07558"></a>07558     <span class="keywordtype">int</span>   socket            Network socket to client
<a name="l07559"></a>07559 
<a name="l07560"></a>07560   Output:
<a name="l07561"></a>07561     none
<a name="l07562"></a>07562 
<a name="l07563"></a>07563   Function <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>:
<a name="l07564"></a>07564     <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>              Successful completion
<a name="l07565"></a>07565 
<a name="l07566"></a>07566 \********************************************************************/
<a name="l07567"></a>07567 {
<a name="l07568"></a>07568    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>[32];
<a name="l07569"></a>07569    <a class="code" href="structNET__COMMAND.html">NET_COMMAND</a> *nc;
<a name="l07570"></a>07570    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, convert_flags;
<a name="l07571"></a>07571    <span class="keyword">static</span> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mevb_8cpp.html#a5fecce64b1b883ada4ac0bc410fb3304">last_time</a> = 0;
<a name="l07572"></a>07572 
<a name="l07573"></a>07573    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>; i++)
<a name="l07574"></a>07574       <span class="keywordflow">if</span> (strcmp(<a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>, <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].buffer_header-&gt;name) == 0)
<a name="l07575"></a>07575          <span class="keywordflow">break</span>;
<a name="l07576"></a>07576    <span class="keywordflow">if</span> (i == _buffer_entries)
<a name="l07577"></a>07577       <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l07578"></a>07578 
<a name="l07579"></a>07579    <span class="comment">/* don&apos;t send notification if client has no callback defined</span>
<a name="l07580"></a>07580 <span class="comment">      to receive events -&gt; client calls bm_receive_event manually */</span>
<a name="l07581"></a>07581    <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].<a class="code" href="mserver_8c.html#a847e3001e4ea9147cfab3529da5b8c36">callback</a>)
<a name="l07582"></a>07582       <span class="keywordflow">return</span> <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>;
<a name="l07583"></a>07583 
<a name="l07584"></a>07584    convert_flags = <a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#gaddb075d303a5903df6a7dabdad02defd">RPC_CONVERT_FLAGS</a>);
<a name="l07585"></a>07585 
<a name="l07586"></a>07586    <span class="comment">/* only send notification once each 500ms */</span>
<a name="l07587"></a>07587    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - last_time &lt; 500 &amp;&amp; !(convert_flags &amp; <a class="code" href="group__msectionh.html#ga2db779b9189033ca4e2ffed4654be032">CF_ASCII</a>))
<a name="l07588"></a>07588       <span class="keywordflow">return</span> <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>;
<a name="l07589"></a>07589 
<a name="l07590"></a>07590    last_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l07591"></a>07591 
<a name="l07592"></a>07592    <span class="keywordflow">if</span> (convert_flags &amp; CF_ASCII) {
<a name="l07593"></a>07593       sprintf(buffer, <span class="stringliteral">&quot;MSG_BM&amp;%s&quot;</span>, <a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>);
<a name="l07594"></a>07594       <a class="code" href="group__msystemincludecode.html#gae657f73f38c098645aab383053478d59">send_tcp</a>(socket, buffer, strlen(buffer) + 1, 0);
<a name="l07595"></a>07595    } <span class="keywordflow">else</span> {
<a name="l07596"></a>07596       nc = (<a class="code" href="structNET__COMMAND.html">NET_COMMAND</a> *) buffer;
<a name="l07597"></a>07597 
<a name="l07598"></a>07598       nc-&gt;<a class="code" href="structNET__COMMAND.html#a4427c9f240aabad9b39e98431ecc6ecf">header</a>.<a class="code" href="structNET__COMMAND__HEADER.html#a9805c951be630cb91f6cf5e5fd8a34f4">routine_id</a> = <a class="code" href="group__msystemincludecode.html#ga6e9a9a9996cea71191a21fd2009efcd1">MSG_BM</a>;
<a name="l07599"></a>07599       nc-&gt;<a class="code" href="structNET__COMMAND.html#a4427c9f240aabad9b39e98431ecc6ecf">header</a>.<a class="code" href="structNET__COMMAND__HEADER.html#ae0c91723d3f4843639e659ccde63dc5a">param_size</a> = 0;
<a name="l07600"></a>07600 
<a name="l07601"></a>07601       <span class="keywordflow">if</span> (convert_flags) {
<a name="l07602"></a>07602          <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;nc-&gt;<a class="code" href="structNET__COMMAND.html#a4427c9f240aabad9b39e98431ecc6ecf">header</a>.<a class="code" href="structNET__COMMAND__HEADER.html#a9805c951be630cb91f6cf5e5fd8a34f4">routine_id</a>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>,
<a name="l07603"></a>07603                             <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>, convert_flags);
<a name="l07604"></a>07604          <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;nc-&gt;<a class="code" href="structNET__COMMAND.html#a4427c9f240aabad9b39e98431ecc6ecf">header</a>.<a class="code" href="structNET__COMMAND__HEADER.html#ae0c91723d3f4843639e659ccde63dc5a">param_size</a>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>,
<a name="l07605"></a>07605                             <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>, convert_flags);
<a name="l07606"></a>07606       }
<a name="l07607"></a>07607 
<a name="l07608"></a>07608       <span class="comment">/* send the update notification to the client */</span>
<a name="l07609"></a>07609       <a class="code" href="group__msystemincludecode.html#gae657f73f38c098645aab383053478d59">send_tcp</a>(socket, (<span class="keywordtype">char</span> *) buffer, <span class="keyword">sizeof</span>(<a class="code" href="structNET__COMMAND__HEADER.html">NET_COMMAND_HEADER</a>), 0);
<a name="l07610"></a>07610    }
<a name="l07611"></a>07611 
<a name="l07612"></a>07612    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l07613"></a>07613 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="gae9636ff3e34ee94e31cb292bd07a679d"></a><!-- doxytag: member="midas.c::bm_open_buffer" ref="gae9636ff3e34ee94e31cb292bd07a679d" args="(char *buffer_name, INT buffer_size, INT *buffer_handle)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_open_buffer </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buffer_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> *&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Open an event buffer. Two default buffers are created by the system. The "SYSTEM" buffer is used to exchange events and the "SYSMSG" buffer is used to exchange system messages. The name and size of the event buffers is defined in <a class="el" href="generate-MODULES_8h.html#a00d5923485ea4382260221681abdb205">midas.h</a> as EVENT_BUFFER_NAME and EVENT_BUFFER_SIZE. Following example opens the "SYSTEM" buffer, requests events with ID 1 and enters a main loop. Events are then received in <a class="el" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event()</a> </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<span class="keywordtype">void</span> <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hbuf, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> request_id,
           <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pheader, <span class="keywordtype">void</span> *pevent)
{
  printf(<span class="stringliteral">&quot;Received event #%d\r&quot;</span>,
  pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
}
<a class="code" href="mucap__compress_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>()
{
  <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, request_id;
  <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hbuf;
  status = <a class="code" href="group__msectionh.html#gae12b15703f10f41044e599520e665f5a">cm_connect_experiment</a>(<span class="stringliteral">&quot;pc810&quot;</span>, <span class="stringliteral">&quot;Sample&quot;</span>, <span class="stringliteral">&quot;Simple Analyzer&quot;</span>, NULL);
  <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
  <span class="keywordflow">return</span> 1;
  <a class="code" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer</a>(<a class="code" href="group__midasincludecode.html#gab520c690db83550e545ce6afbb12de3f">EVENT_BUFFER_NAME</a>, <a class="code" href="group__midasincludecode.html#gacc4dda1aaabc9862fe79fd94e0b722bf">EVENT_BUFFER_SIZE</a>, &amp;hbuf);
  <a class="code" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event</a>(hbuf, 1, <a class="code" href="group__mdefineh.html#ga26aa4bcea89857cb7ca669339695ceac">TRIGGER_ALL</a>, <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>, request_id, <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>);

  <span class="keywordflow">do</span>
  {
   status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(1000);
  } <span class="keywordflow">while</span> (status != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> &amp;&amp; status != <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>);
  <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
  <span class="keywordflow">return</span> 0;
}
</pre></div> <dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_name</em>&nbsp;</td><td>Name of buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer_size</em>&nbsp;</td><td>Size of buffer in bytes </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer_handle</em>&nbsp;</td><td>Buffer handle returned by function </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_CREATED <br/>
 BM_NO_SHM Shared memory cannot be created <br/>
 BM_NO_MUTEX Mutex cannot be created <br/>
 BM_NO_MEMORY Not enough memory to create buffer descriptor <br/>
 BM_MEMSIZE_MISMATCH Buffer size conflicts with an existing buffer of different size <br/>
 BM_INVALID_PARAM Invalid parameter </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l04389">4389</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l01295">BUFFER::attached</a>, <a class="el" href="midas_8h_source.html#l00978">BM_CREATED</a>, <a class="el" href="midas_8c_source.html#l05509">bm_init_buffer_counters()</a>, <a class="el" href="midas_8h_source.html#l00980">BM_INVALID_NAME</a>, <a class="el" href="midas_8h_source.html#l00991">BM_INVALID_PARAM</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8c_source.html#l07495">bm_mark_read_waiting()</a>, <a class="el" href="midas_8h_source.html#l00988">BM_MEMSIZE_MISMATCH</a>, <a class="el" href="midas_8h_source.html#l00979">BM_NO_MEMORY</a>, <a class="el" href="midas_8h_source.html#l00983">BM_NO_MUTEX</a>, <a class="el" href="midas_8h_source.html#l00994">BM_NO_SHM</a>, <a class="el" href="midas_8h_source.html#l00982">BM_NO_SLOT</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01298">BUFFER::buffer_data</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01310">BUFFER::callback</a>, <a class="el" href="msystem_8h_source.html#l00649">CH_IPC</a>, <a class="el" href="midas_8h_source.html#l01288">BUFFER_HEADER::client</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="midas_8c_source.html#l04080">cm_dispatch_ipc()</a>, <a class="el" href="midas_8c_source.html#l02153">cm_get_client_info()</a>, <a class="el" href="midas_8c_source.html#l03114">cm_get_watchdog_params()</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="odb_8c_source.html#l01693">equal_ustring()</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="v1724__module_8c_source.html#l00021">handle</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="midas_8h_source.html#l01309">BUFFER::index</a>, <a class="el" href="mana_8cpp_source.html#l00677">index</a>, <a class="el" href="midas_8h_source.html#l01271">BUFFER_CLIENT::last_activity</a>, <a class="el" href="midas_8h_source.html#l01753">M_MALLOC</a>, <a class="el" href="midas_8h_source.html#l01281">BUFFER_HEADER::max_client_index</a>, <a class="el" href="midas_8h_source.html#l00683">MAX_CLIENTS</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="midas_8h_source.html#l01256">BUFFER_CLIENT::name</a>, <a class="el" href="midas_8h_source.html#l01279">BUFFER_HEADER::name</a>, <a class="el" href="midas_8h_source.html#l00681">NAME_LENGTH</a>, <a class="el" href="midas_8h_source.html#l01280">BUFFER_HEADER::num_clients</a>, <a class="el" href="midas_8h_source.html#l01257">BUFFER_CLIENT::pid</a>, <a class="el" href="midas_8h_source.html#l01260">BUFFER_CLIENT::port</a>, <a class="el" href="midas_8h_source.html#l01261">BUFFER_CLIENT::read_pointer</a>, <a class="el" href="mrpc_8h_source.html#l00116">RPC_BM_OPEN_BUFFER</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09045">rpc_get_server_acception()</a>, <a class="el" href="midas_8c_source.html#l09250">rpc_get_server_option()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l00772">RPC_OSERVER_TYPE</a>, <a class="el" href="midas_8h_source.html#l01308">BUFFER::shm_handle</a>, <a class="el" href="midas_8h_source.html#l01282">BUFFER_HEADER::size</a>, <a class="el" href="midas_8h_source.html#l01034">SS_CREATED</a>, <a class="el" href="midas_8h_source.html#l01039">SS_FILE_ERROR</a>, <a class="el" href="system_8c_source.html#l00996">ss_getpid()</a>, <a class="el" href="system_8c_source.html#l00913">ss_getthandle()</a>, <a class="el" href="system_8c_source.html#l01050">ss_gettid()</a>, <a class="el" href="system_8c_source.html#l02265">ss_millitime()</a>, <a class="el" href="system_8c_source.html#l01818">ss_mutex_create()</a>, <a class="el" href="midas_8h_source.html#l01035">SS_NO_MEMORY</a>, <a class="el" href="system_8c_source.html#l00609">ss_shm_close()</a>, <a class="el" href="system_8c_source.html#l00380">ss_shm_open()</a>, <a class="el" href="midas_8h_source.html#l01033">SS_SUCCESS</a>, <a class="el" href="system_8c_source.html#l03245">ss_suspend_get_port()</a>, <a class="el" href="system_8c_source.html#l03182">ss_suspend_set_dispatch()</a>, <a class="el" href="midas_8h_source.html#l01791">ST_SINGLE</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, <a class="el" href="midas_8h_source.html#l01259">BUFFER_CLIENT::thandle</a>, <a class="el" href="midas_8h_source.html#l01258">BUFFER_CLIENT::tid</a>, <a class="el" href="p30_8h_source.html#l00043">TRUE</a>, <a class="el" href="midas_8h_source.html#l01272">BUFFER_CLIENT::watchdog_timeout</a>, and <a class="el" href="midas_8h_source.html#l01284">BUFFER_HEADER::write_pointer</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l01233">cm_msg()</a>, <a class="el" href="midas_8c_source.html#l01346">cm_msg1()</a>, <a class="el" href="midas_8c_source.html#l01477">cm_msg_register()</a>, <a class="el" href="odbedit_8c_source.html#l01415">command_loop()</a>, <a class="el" href="old__mevb_8cpp_source.html#l00658">main()</a>, <a class="el" href="crate6__CAEN__TDC_2mfe__mucap_8c_source.html#l00554">register_equipment()</a>, <a class="el" href="mana_8cpp_source.html#l03861">register_requests()</a>, <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>, <a class="el" href="mevb_8cpp_source.html#l00756">source_booking()</a>, <a class="el" href="mlogger_8c_source.html#l03140">tr_start()</a>, and <a class="el" href="fal_8c_source.html#l02085">tr_start1()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04390"></a>04390 {
<a name="l04391"></a>04391    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l04392"></a>04392 
<a name="l04393"></a>04393    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>()) {
<a name="l04394"></a>04394       status = <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#gabb4377471c0fcc7fc12c20be2a8936a2">RPC_BM_OPEN_BUFFER</a>, <a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>, <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>, buffer_handle);
<a name="l04395"></a>04395       <a class="code" href="group__msystemincludecode.html#ga72da25e2d09e1278ecd4a93b5b7f9114">bm_mark_read_waiting</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04396"></a>04396       <span class="keywordflow">return</span> status;
<a name="l04397"></a>04397    }
<a name="l04398"></a>04398 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l04399"></a>04399 <span class="preprocessor"></span>   {
<a name="l04400"></a>04400       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>;
<a name="l04401"></a>04401       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient;
<a name="l04402"></a>04402       <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> shm_created;
<a name="l04403"></a>04403       <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> shm_handle;
<a name="l04404"></a>04404       <a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a> *pheader;
<a name="l04405"></a>04405 
<a name="l04406"></a>04406       <span class="keywordflow">if</span> (buffer_size &lt;= 0 || buffer_size &gt; 32E6) {
<a name="l04407"></a>04407          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_open_buffer&quot;</span>, <span class="stringliteral">&quot;invalid buffer size&quot;</span>);
<a name="l04408"></a>04408          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga09095b8ac6e057d3094c99e485c1a74d">BM_INVALID_PARAM</a>;
<a name="l04409"></a>04409       }
<a name="l04410"></a>04410 
<a name="l04411"></a>04411       <span class="keywordflow">if</span> (!<a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>[0]) {
<a name="l04412"></a>04412          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_open_buffer&quot;</span>, <span class="stringliteral">&quot;cannot open buffer with zero name&quot;</span>);
<a name="l04413"></a>04413          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga09095b8ac6e057d3094c99e485c1a74d">BM_INVALID_PARAM</a>;
<a name="l04414"></a>04414       }
<a name="l04415"></a>04415 
<a name="l04416"></a>04416       <span class="comment">/* allocate new space for the new buffer descriptor */</span>
<a name="l04417"></a>04417       <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> == 0) {
<a name="l04418"></a>04418          <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a> = (<a class="code" href="structBUFFER.html">BUFFER</a> *) <a class="code" href="group__msectionh.html#ga130728d73c8c9b46e0b9bd2e34557c3d">M_MALLOC</a>(<span class="keyword">sizeof</span>(<a class="code" href="structBUFFER.html">BUFFER</a>));
<a name="l04419"></a>04419          memset(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER.html">BUFFER</a>));
<a name="l04420"></a>04420          <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a> == NULL) {
<a name="l04421"></a>04421             *buffer_handle = 0;
<a name="l04422"></a>04422             <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l04423"></a>04423          }
<a name="l04424"></a>04424 
<a name="l04425"></a>04425          <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> = 1;
<a name="l04426"></a>04426          i = 0;
<a name="l04427"></a>04427       } <span class="keywordflow">else</span> {
<a name="l04428"></a>04428          <span class="comment">/* check if buffer alreay is open */</span>
<a name="l04429"></a>04429          <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>; i++)
<a name="l04430"></a>04430             <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].attached &amp;&amp;
<a name="l04431"></a>04431                 <a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].buffer_header-&gt;name, <a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>)) {
<a name="l04432"></a>04432                <span class="keywordflow">if</span> (<a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>) == <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp;
<a name="l04433"></a>04433                    <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a> != <a class="code" href="group__msystemincludecode.html#ga55167513ac1295a246d69f378fc9d459">rpc_get_server_acception</a>())
<a name="l04434"></a>04434                   <span class="keywordflow">continue</span>;
<a name="l04435"></a>04435 
<a name="l04436"></a>04436                <span class="keywordflow">if</span> (<a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>) != <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a> &amp;&amp;
<a name="l04437"></a>04437                    <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a> != <a class="code" href="group__msystemincludecode.html#ga47dde62638a1a4e9f49534bff449ebcd">ss_gettid</a>())
<a name="l04438"></a>04438                   <span class="keywordflow">continue</span>;
<a name="l04439"></a>04439 
<a name="l04440"></a>04440                *buffer_handle = i + 1;
<a name="l04441"></a>04441                <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l04442"></a>04442             }
<a name="l04443"></a>04443 
<a name="l04444"></a>04444          <span class="comment">/* check for a deleted entry */</span>
<a name="l04445"></a>04445          <span class="keywordflow">for</span> (i = 0; i &lt; _buffer_entries; i++)
<a name="l04446"></a>04446             <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].attached)
<a name="l04447"></a>04447                <span class="keywordflow">break</span>;
<a name="l04448"></a>04448 
<a name="l04449"></a>04449          <span class="comment">/* if not found, create new one */</span>
<a name="l04450"></a>04450          <span class="keywordflow">if</span> (i == _buffer_entries) {
<a name="l04451"></a>04451             <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a> = (<a class="code" href="structBUFFER.html">BUFFER</a> *) realloc(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>, <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER.html">BUFFER</a>) * (_buffer_entries + 1));
<a name="l04452"></a>04452             memset(&amp;<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[_buffer_entries], 0, <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER.html">BUFFER</a>));
<a name="l04453"></a>04453 
<a name="l04454"></a>04454             _buffer_entries++;
<a name="l04455"></a>04455             <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a> == NULL) {
<a name="l04456"></a>04456                _buffer_entries--;
<a name="l04457"></a>04457                *buffer_handle = 0;
<a name="l04458"></a>04458                <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l04459"></a>04459             }
<a name="l04460"></a>04460          }
<a name="l04461"></a>04461 
<a name="l04462"></a>04462       }
<a name="l04463"></a>04463 
<a name="l04464"></a>04464       handle = i;
<a name="l04465"></a>04465 
<a name="l04466"></a>04466       <span class="keywordflow">if</span> (strlen(<a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>) &gt;= <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>)
<a name="l04467"></a>04467          <a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>] = 0;
<a name="l04468"></a>04468 
<a name="l04469"></a>04469       <span class="comment">/* reduce buffer size is larger than maximum */</span>
<a name="l04470"></a>04470 <span class="preprocessor">#ifdef MAX_SHM_SIZE</span>
<a name="l04471"></a>04471 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a>) &gt; MAX_SHM_SIZE)
<a name="l04472"></a>04472          <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a> = MAX_SHM_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a>);
<a name="l04473"></a>04473 <span class="preprocessor">#endif</span>
<a name="l04474"></a>04474 <span class="preprocessor"></span>
<a name="l04475"></a>04475       <span class="comment">/* open shared memory region */</span>
<a name="l04476"></a>04476       status = <a class="code" href="group__msystemincludecode.html#ga93891c1ebbf61c831fb029470a6708ed">ss_shm_open</a>(<a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>, <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a>) + <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>,
<a name="l04477"></a>04477                            (<span class="keywordtype">void</span> **) &amp;(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].buffer_header), &amp;shm_handle);
<a name="l04478"></a>04478 
<a name="l04479"></a>04479       <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a> || status == <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>) {
<a name="l04480"></a>04480          *buffer_handle = 0;
<a name="l04481"></a>04481          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gaf32276ec7c00c33b4c45bd0b382b8ffb">BM_NO_SHM</a>;
<a name="l04482"></a>04482       }
<a name="l04483"></a>04483 
<a name="l04484"></a>04484       pheader = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>;
<a name="l04485"></a>04485 
<a name="l04486"></a>04486       shm_created = (status == <a class="code" href="group__err24.html#ga7440cf35b00082fb16e8584ada5b50e0">SS_CREATED</a>);
<a name="l04487"></a>04487 
<a name="l04488"></a>04488       <span class="keywordflow">if</span> (shm_created) {
<a name="l04489"></a>04489          <span class="comment">/* setup header info if buffer was created */</span>
<a name="l04490"></a>04490          memset(pheader, 0, <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a>));
<a name="l04491"></a>04491 
<a name="l04492"></a>04492          strcpy(pheader-&gt;<a class="code" href="structBUFFER__HEADER.html#a40ea1b56ee55965c4d61e6da5ae57022">name</a>, <a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>);
<a name="l04493"></a>04493          pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> = <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>;
<a name="l04494"></a>04494       } <span class="keywordflow">else</span> {
<a name="l04495"></a>04495          <span class="comment">/* check if buffer size is identical */</span>
<a name="l04496"></a>04496          <span class="keywordflow">if</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> != <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>) {
<a name="l04497"></a>04497             <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a> = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l04498"></a>04498 
<a name="l04499"></a>04499             <span class="comment">/* re-open shared memory with proper size */</span>
<a name="l04500"></a>04500 
<a name="l04501"></a>04501             status = <a class="code" href="group__msystemincludecode.html#ga60889b75242e40dc0ee097d7295cc404">ss_shm_close</a>(<a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>, <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].buffer_header,
<a name="l04502"></a>04502                                   shm_handle, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04503"></a>04503             <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l04504"></a>04504                <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga2d978469667eb3d51ea7cc48a5070a72">BM_MEMSIZE_MISMATCH</a>;
<a name="l04505"></a>04505 
<a name="l04506"></a>04506             status = <a class="code" href="group__msystemincludecode.html#ga93891c1ebbf61c831fb029470a6708ed">ss_shm_open</a>(<a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>, <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a>) + <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>,
<a name="l04507"></a>04507                                  (<span class="keywordtype">void</span> **) &amp;(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].buffer_header), &amp;shm_handle);
<a name="l04508"></a>04508 
<a name="l04509"></a>04509             <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a> || status == <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>) {
<a name="l04510"></a>04510                *buffer_handle = 0;
<a name="l04511"></a>04511                <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga3320beea9944241434c6bf98d2392414">BM_INVALID_NAME</a>;
<a name="l04512"></a>04512             }
<a name="l04513"></a>04513 
<a name="l04514"></a>04514             pheader = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>;
<a name="l04515"></a>04515          }
<a name="l04516"></a>04516       }
<a name="l04517"></a>04517 
<a name="l04518"></a>04518       <span class="comment">/* create mutex for the buffer */</span>
<a name="l04519"></a>04519       status = <a class="code" href="group__msystemincludecode.html#ga518ac9986c25e4f472f7d731a98ca2f3">ss_mutex_create</a>(<a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>, &amp;(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].mutex));
<a name="l04520"></a>04520       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga7440cf35b00082fb16e8584ada5b50e0">SS_CREATED</a> &amp;&amp; status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l04521"></a>04521          *buffer_handle = 0;
<a name="l04522"></a>04522          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga8baf2df80fb18bff86574d58d5966c41">BM_NO_MUTEX</a>;
<a name="l04523"></a>04523       }
<a name="l04524"></a>04524 
<a name="l04525"></a>04525       <span class="comment">/* first lock buffer */</span>
<a name="l04526"></a>04526       <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(handle + 1);
<a name="l04527"></a>04527 
<a name="l04528"></a>04528       <span class="comment">/*</span>
<a name="l04529"></a>04529 <span class="comment">         Now we have a BUFFER_HEADER, so let&apos;s setup a CLIENT</span>
<a name="l04530"></a>04530 <span class="comment">         structure in that buffer. The information there can also</span>
<a name="l04531"></a>04531 <span class="comment">         be seen by other processes.</span>
<a name="l04532"></a>04532 <span class="comment">       */</span>
<a name="l04533"></a>04533 
<a name="l04534"></a>04534       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__midasincludecode.html#ga0a8f91f93d75a07f0ae45077db45b3eb">MAX_CLIENTS</a>; i++)
<a name="l04535"></a>04535          <span class="keywordflow">if</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>[i].<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> == 0)
<a name="l04536"></a>04536             <span class="keywordflow">break</span>;
<a name="l04537"></a>04537 
<a name="l04538"></a>04538       <span class="keywordflow">if</span> (i == MAX_CLIENTS) {
<a name="l04539"></a>04539          <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(handle + 1);
<a name="l04540"></a>04540          *buffer_handle = 0;
<a name="l04541"></a>04541          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_open_buffer&quot;</span>, <span class="stringliteral">&quot;maximum number of clients exceeded&quot;</span>);
<a name="l04542"></a>04542          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5d9eb250e07354dc4d5de87388feff44">BM_NO_SLOT</a>;
<a name="l04543"></a>04543       }
<a name="l04544"></a>04544 
<a name="l04545"></a>04545       <span class="comment">/* store slot index in _buffer structure */</span>
<a name="l04546"></a>04546       <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a> = i;
<a name="l04547"></a>04547 
<a name="l04548"></a>04548       <span class="comment">/*</span>
<a name="l04549"></a>04549 <span class="comment">         Save the index of the last client of that buffer so that later only</span>
<a name="l04550"></a>04550 <span class="comment">         the clients 0..max_client_index-1 have to be searched through.</span>
<a name="l04551"></a>04551 <span class="comment">       */</span>
<a name="l04552"></a>04552       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3c6af0363e3034c956a264fe6a25ddfb">num_clients</a>++;
<a name="l04553"></a>04553       <span class="keywordflow">if</span> (i + 1 &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>)
<a name="l04554"></a>04554          pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a> = i + 1;
<a name="l04555"></a>04555 
<a name="l04556"></a>04556       <span class="comment">/* setup buffer header and client structure */</span>
<a name="l04557"></a>04557       pclient = &amp;pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>[i];
<a name="l04558"></a>04558 
<a name="l04559"></a>04559       memset(pclient, 0, <span class="keyword">sizeof</span>(<a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a>));
<a name="l04560"></a>04560       <span class="comment">/* use client name previously set by bm_set_name */</span>
<a name="l04561"></a>04561       <a class="code" href="group__msectionh.html#gae0813e30f12e01617ecaf3b375a40872">cm_get_client_info</a>(pclient-&gt;<a class="code" href="structBUFFER__CLIENT.html#aa626137fa4097c5a254a31d4f953a47f">name</a>);
<a name="l04562"></a>04562       <span class="keywordflow">if</span> (pclient-&gt;<a class="code" href="structBUFFER__CLIENT.html#aa626137fa4097c5a254a31d4f953a47f">name</a>[0] == 0)
<a name="l04563"></a>04563          strcpy(pclient-&gt;<a class="code" href="structBUFFER__CLIENT.html#aa626137fa4097c5a254a31d4f953a47f">name</a>, <span class="stringliteral">&quot;unknown&quot;</span>);
<a name="l04564"></a>04564       pclient-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> = <a class="code" href="group__msystemincludecode.html#ga6450a1c1781b4b12ddf46f30bb431be5">ss_getpid</a>();
<a name="l04565"></a>04565       pclient-&gt;<a class="code" href="group__midasincludecode.html#gaf3cbabe9dae84f54a2c8b050414f4418">tid</a> = <a class="code" href="group__msystemincludecode.html#ga47dde62638a1a4e9f49534bff449ebcd">ss_gettid</a>();
<a name="l04566"></a>04566       pclient-&gt;<a class="code" href="group__midasincludecode.html#ga2f971806e9584a7132e36e22fa49071d">thandle</a> = <a class="code" href="group__msystemincludecode.html#gacf609db1d9dea84c0499c674cea8c2af">ss_getthandle</a>();
<a name="l04567"></a>04567 
<a name="l04568"></a>04568       <a class="code" href="group__msystemincludecode.html#gaf23b97351b93f71a8b585858d0dde498">ss_suspend_get_port</a>(&amp;pclient-&gt;<a class="code" href="group__midasincludecode.html#gad8112ed9dd177230ff2a9acfd84c5429">port</a>);
<a name="l04569"></a>04569 
<a name="l04570"></a>04570       pclient-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l04571"></a>04571       pclient-&gt;<a class="code" href="group__midasincludecode.html#ga90d5bebe80eaf1d76dd2c97d54796efd">last_activity</a> = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l04572"></a>04572 
<a name="l04573"></a>04573       <a class="code" href="group__msectionh.html#ga324df07c9a3003f1d1ce41e0fa51539e">cm_get_watchdog_params</a>(NULL, &amp;pclient-&gt;<a class="code" href="group__midasincludecode.html#ga7f9617db2284469ad91a33d3f3ae1447">watchdog_timeout</a>);
<a name="l04574"></a>04574 
<a name="l04575"></a>04575       <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(handle + 1);
<a name="l04576"></a>04576 
<a name="l04577"></a>04577       <span class="comment">/* setup _buffer entry */</span>
<a name="l04578"></a>04578       <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="group__midasincludecode.html#ga8a66c13998d446c0a1bad0b5d4a2d248">buffer_data</a> = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a> + 1;
<a name="l04579"></a>04579       <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="structBUFFER.html#a495ba8d2558dac6d40a46564c5067a2c">attached</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04580"></a>04580       <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="group__midasincludecode.html#gae313313f5d3caa148ea750395c88a54f">shm_handle</a> = shm_handle;
<a name="l04581"></a>04581       <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="group__midasincludecode.html#ga9611e4a4e83bdf10fc85a02c6de72da5">callback</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04582"></a>04582 
<a name="l04583"></a>04583       <span class="comment">/* remember to which connection acutal buffer belongs */</span>
<a name="l04584"></a>04584       <span class="keywordflow">if</span> (<a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>) == <a class="code" href="group__msectionh.html#gafd1f60d6275582530d610f3a599cb270">ST_SINGLE</a>)
<a name="l04585"></a>04585          <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="group__midasincludecode.html#ga5e76aa98957c2f9c714ae9825ef4bb94">index</a> = <a class="code" href="group__msystemincludecode.html#ga55167513ac1295a246d69f378fc9d459">rpc_get_server_acception</a>();
<a name="l04586"></a>04586       <span class="keywordflow">else</span>
<a name="l04587"></a>04587          <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[handle].<a class="code" href="group__midasincludecode.html#ga5e76aa98957c2f9c714ae9825ef4bb94">index</a> = <a class="code" href="group__msystemincludecode.html#ga47dde62638a1a4e9f49534bff449ebcd">ss_gettid</a>();
<a name="l04588"></a>04588 
<a name="l04589"></a>04589       *buffer_handle = (handle + 1);
<a name="l04590"></a>04590 
<a name="l04591"></a>04591       <span class="comment">/* initialize buffer counters */</span>
<a name="l04592"></a>04592       <a class="code" href="group__msectionh.html#ga346f06b27be3e04e4ecaaece918bef9d">bm_init_buffer_counters</a>(handle + 1);
<a name="l04593"></a>04593 
<a name="l04594"></a>04594       <span class="comment">/* setup dispatcher for receive events */</span>
<a name="l04595"></a>04595       <a class="code" href="group__msystemincludecode.html#gac1b39a6f689a24e9aaf239ee73a81b15">ss_suspend_set_dispatch</a>(<a class="code" href="group__msystemincludecode.html#gaaf67c5bbdc56bcbec8cae52246776752">CH_IPC</a>, 0, (<span class="keywordtype">int</span> (*)(<span class="keywordtype">void</span>)) <a class="code" href="group__msystemincludecode.html#ga6a36db7a5cf4cd8f25b530b074128826">cm_dispatch_ipc</a>);
<a name="l04596"></a>04596 
<a name="l04597"></a>04597       <span class="keywordflow">if</span> (shm_created)
<a name="l04598"></a>04598          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gaf4d0ec9887b0864c100b8062d21f4c0b">BM_CREATED</a>;
<a name="l04599"></a>04599    }
<a name="l04600"></a>04600 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l04601"></a>04601 
<a name="l04602"></a>04602    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l04603"></a>04603 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga77879d61a226e3f59497cbb3c9cb8b55"></a><!-- doxytag: member="midas.c::bm_poll_event" ref="ga77879d61a226e3f59497cbb3c9cb8b55" args="(INT flag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_poll_event </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>flag</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="midas_8c_source.html#l07616">7616</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00819">_event_buffer_size</a>, <a class="el" href="midas_8c_source.html#l00816">_request_list_entries</a>, <a class="el" href="midas_8h_source.html#l00756">ASYNC</a>, <a class="el" href="midas_8h_source.html#l00985">BM_ASYNC_RETURN</a>, <a class="el" href="midas_8c_source.html#l07810">bm_defragment_event()</a>, <a class="el" href="midas_8c_source.html#l07495">bm_mark_read_waiting()</a>, <a class="el" href="midas_8c_source.html#l04327">bm_match_event()</a>, <a class="el" href="midas_8c_source.html#l06777">bm_receive_event()</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="structREQUEST__LIST.html#ab758c78a1c81c02eab2f378951e04100">REQUEST_LIST::dispatcher</a>, <a class="el" href="midas_8h_source.html#l01191">EVENT_HEADER::event_id</a>, <a class="el" href="midas_8h_source.html#l01236">EVENTID_FRAG</a>, <a class="el" href="midas_8h_source.html#l01235">EVENTID_FRAG1</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="midas_8h_source.html#l01753">M_MALLOC</a>, <a class="el" href="midas_8h_source.html#l00677">MAX_EVENT_SIZE</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="midas_8h_source.html#l01069">RPC_NET_ERROR</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="midas_8h_source.html#l01047">SS_ABORT</a>, <a class="el" href="system_8c_source.html#l02265">ss_millitime()</a>, <a class="el" href="old__mevb_8cpp_source.html#l00065">start_time</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, and <a class="el" href="p30_8h_source.html#l00043">TRUE</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l04166">cm_yield()</a>, <a class="el" href="midas_8c_source.html#l08336">rpc_client_dispatch()</a>, and <a class="el" href="mana_8cpp_source.html#l02462">tr_stop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l07619"></a>07619          : <a class="code" href="group__msectionh.html#ga545449f5acb6b13f78b1194cb92b3d63">bm_poll_event</a>
<a name="l07620"></a>07620 
<a name="l07621"></a>07621   Purpose: Poll an <span class="keyword">event</span> from a remote server. Gets called <a class="code" href="patch__mevb_8cpp.html#a944cf20aa75177818af16fe394e984be">by</a>
<a name="l07622"></a>07622            <a class="code" href="group__rpcfunctionc.html#gaddfad24a27898f83c9d51e41dd208bc6">rpc_client_dispatch</a>
<a name="l07623"></a>07623 
<a name="l07624"></a>07624   Input:
<a name="l07625"></a>07625     <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>         <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> <span class="keywordflow">if</span> called from <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>
<a name="l07626"></a>07626 
<a name="l07627"></a>07627   Output:
<a name="l07628"></a>07628     none
<a name="l07629"></a>07629 
<a name="l07630"></a>07630   Function <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>:
<a name="l07631"></a>07631     <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>             More events are waiting
<a name="l07632"></a>07632     <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>            No more events are waiting
<a name="l07633"></a>07633     <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>         Network connection broken
<a name="l07634"></a>07634 
<a name="l07635"></a>07635 \********************************************************************/
<a name="l07636"></a>07636 {
<a name="l07637"></a>07637    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, request_id;
<a name="l07638"></a>07638    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="old__mevb_8cpp.html#af4211e1ba0e676018599e88cfae3537a">start_time</a>;
<a name="l07639"></a>07639    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> bMore;
<a name="l07640"></a>07640    <span class="keyword">static</span> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> bMoreLast = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l07641"></a>07641 
<a name="l07642"></a>07642    <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga5b954f9390d9925bf6b0943baa151bcb">_event_buffer_size</a> == 0) {
<a name="l07643"></a>07643       <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a> = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="group__msectionh.html#ga130728d73c8c9b46e0b9bd2e34557c3d">M_MALLOC</a>(<a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l07644"></a>07644       <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>) {
<a name="l07645"></a>07645          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_poll_event&quot;</span>, <span class="stringliteral">&quot;not enough memory to allocate event buffer&quot;</span>);
<a name="l07646"></a>07646          <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>;
<a name="l07647"></a>07647       }
<a name="l07648"></a>07648       <a class="code" href="group__midasincludecode.html#ga5b954f9390d9925bf6b0943baa151bcb">_event_buffer_size</a> = <a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l07649"></a>07649    }
<a name="l07650"></a>07650 
<a name="l07651"></a>07651    start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l07652"></a>07652 
<a name="l07653"></a>07653    <span class="comment">/* if we got event notification, turn off read_wait */</span>
<a name="l07654"></a>07654    <span class="keywordflow">if</span> (!<a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>)
<a name="l07655"></a>07655       <a class="code" href="group__msystemincludecode.html#ga72da25e2d09e1278ecd4a93b5b7f9114">bm_mark_read_waiting</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l07656"></a>07656 
<a name="l07657"></a>07657    <span class="comment">/* if called from yield, return if no more events */</span>
<a name="l07658"></a>07658    <span class="keywordflow">if</span> (<a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>) {
<a name="l07659"></a>07659       <span class="keywordflow">if</span> (!bMoreLast)
<a name="l07660"></a>07660          <span class="keywordflow">return</span> <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l07661"></a>07661    }
<a name="l07662"></a>07662 
<a name="l07663"></a>07663    bMore = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l07664"></a>07664 
<a name="l07665"></a>07665    <span class="comment">/* loop over all requests */</span>
<a name="l07666"></a>07666    <span class="keywordflow">for</span> (request_id = 0; request_id &lt; <a class="code" href="group__midasincludecode.html#ga6dc3fd8dcb204a2379ed33a7e4645a2d">_request_list_entries</a>; request_id++) {
<a name="l07667"></a>07667       <span class="comment">/* continue if no dispatcher set (manual bm_receive_event) */</span>
<a name="l07668"></a>07668       <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[request_id].dispatcher == NULL)
<a name="l07669"></a>07669          <span class="keywordflow">continue</span>;
<a name="l07670"></a>07670 
<a name="l07671"></a>07671       <span class="keywordflow">do</span> {
<a name="l07672"></a>07672          <span class="comment">/* receive event */</span>
<a name="l07673"></a>07673          size = <a class="code" href="group__midasincludecode.html#ga5b954f9390d9925bf6b0943baa151bcb">_event_buffer_size</a>;
<a name="l07674"></a>07674          status = <a class="code" href="group__msectionh.html#ga0f5bcc113e8cb6023e1f3a61f6c78c48">bm_receive_event</a>(<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[request_id].buffer_handle,
<a name="l07675"></a>07675                                    <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>);
<a name="l07676"></a>07676 
<a name="l07677"></a>07677          <span class="comment">/* call user function if successful */</span>
<a name="l07678"></a>07678          <span class="keywordflow">if</span> (status == <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l07679"></a>07679             <span class="comment">/* search proper request for this event */</span>
<a name="l07680"></a>07680             <span class="keywordflow">for</span> (i = 0; i &lt; _request_list_entries; i++)
<a name="l07681"></a>07681                <span class="keywordflow">if</span> ((<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].buffer_handle ==
<a name="l07682"></a>07682                     <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[request_id].buffer_handle) &amp;&amp;
<a name="l07683"></a>07683                    <a class="code" href="group__bmfunctionc.html#ga181dcf462745127aa3d011a2e3fee805">bm_match_event</a>(<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>,
<a name="l07684"></a>07684                                   <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a>, <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>)) {
<a name="l07685"></a>07685                   <span class="keywordflow">if</span> ((<a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xF000) == <a class="code" href="group__mbufferh.html#gaae07538917933e32355933ac1e2e3d60">EVENTID_FRAG1</a> ||
<a name="l07686"></a>07686                       (<a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xF000) == <a class="code" href="group__mbufferh.html#ga4fb6de5cc7e1f2da82266094a02d0ff7">EVENTID_FRAG</a>)
<a name="l07687"></a>07687                      <a class="code" href="group__msystemincludecode.html#gab7e29f86ca0340171d22fb086cba0dd8">bm_defragment_event</a>(<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].buffer_handle, i, <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>,
<a name="l07688"></a>07688                                          (<span class="keywordtype">void</span> *) (((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>) + 1),
<a name="l07689"></a>07689                                          <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].dispatcher);
<a name="l07690"></a>07690                   <span class="keywordflow">else</span>
<a name="l07691"></a>07691                      <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].<a class="code" href="structREQUEST__LIST.html#ab758c78a1c81c02eab2f378951e04100">dispatcher</a>(<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].buffer_handle, i,
<a name="l07692"></a>07692                                                  <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>,
<a name="l07693"></a>07693                                                  (<span class="keywordtype">void</span>
<a name="l07694"></a>07694                                                   *) (((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>) +
<a name="l07695"></a>07695                                                       1));
<a name="l07696"></a>07696                }
<a name="l07697"></a>07697 
<a name="l07698"></a>07698          <span class="comment">/* break if no more events */</span>
<a name="l07699"></a>07699          <span class="keywordflow">if</span> (status == <a class="code" href="group__err22.html#ga7fb11aaff606b1785cddd205baddbbff">BM_ASYNC_RETURN</a>)
<a name="l07700"></a>07700             <span class="keywordflow">break</span>;
<a name="l07701"></a>07701 
<a name="l07702"></a>07702          <span class="comment">/* break if server died */</span>
<a name="l07703"></a>07703          <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#gae7db91aa77eeed4371ba30dfc122ded6">RPC_NET_ERROR</a>)
<a name="l07704"></a>07704             <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>;
<a name="l07705"></a>07705 
<a name="l07706"></a>07706          <span class="comment">/* stop after one second */</span>
<a name="l07707"></a>07707          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time &gt; 1000) {
<a name="l07708"></a>07708             bMore = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l07709"></a>07709             <span class="keywordflow">break</span>;
<a name="l07710"></a>07710          }
<a name="l07711"></a>07711 
<a name="l07712"></a>07712       } <span class="keywordflow">while</span> (<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l07713"></a>07713    }
<a name="l07714"></a>07714 
<a name="l07715"></a>07715    <span class="keywordflow">if</span> (!bMore)
<a name="l07716"></a>07716       <a class="code" href="group__msystemincludecode.html#ga72da25e2d09e1278ecd4a93b5b7f9114">bm_mark_read_waiting</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l07717"></a>07717 
<a name="l07718"></a>07718    bMoreLast = bMore;
<a name="l07719"></a>07719 
<a name="l07720"></a>07720    <span class="keywordflow">return</span> bMore;
<a name="l07721"></a>07721 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="gabcc6bb732b720fcc3ffe859f732a07e0"></a><!-- doxytag: member="midas.c::bm_push_event" ref="gabcc6bb732b720fcc3ffe859f732a07e0" args="(char *buffer_name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_push_event </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buffer_name</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Check a buffer if an event is available and call the dispatch function if found. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_name</em>&nbsp;</td><td>Name of buffer </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE, BM_TRUNCATED, BM_ASYNC_RETURN, RPC_NET_ERROR </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l07157">7157</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8c_source.html#l00819">_event_buffer_size</a>, <a class="el" href="midas_8c_source.html#l00816">_request_list_entries</a>, <a class="el" href="midas_8h_source.html#l00904">ALIGN8</a>, <a class="el" href="midas_8h_source.html#l01295">BUFFER::attached</a>, <a class="el" href="midas_8c_source.html#l07810">bm_defragment_event()</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8c_source.html#l04327">bm_match_event()</a>, <a class="el" href="midas_8h_source.html#l00992">BM_MORE_EVENTS</a>, <a class="el" href="midas_8h_source.html#l00979">BM_NO_MEMORY</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01310">BUFFER::callback</a>, <a class="el" href="midas_8h_source.html#l01288">BUFFER_HEADER::client</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="midas_8h_source.html#l01195">EVENT_HEADER::data_size</a>, <a class="el" href="structREQUEST__LIST.html#ab758c78a1c81c02eab2f378951e04100">REQUEST_LIST::dispatcher</a>, <a class="el" href="midas_8h_source.html#l01248">EVENT_REQUEST::event_id</a>, <a class="el" href="midas_8h_source.html#l01191">EVENT_HEADER::event_id</a>, <a class="el" href="midas_8h_source.html#l01274">BUFFER_CLIENT::event_request</a>, <a class="el" href="midas_8h_source.html#l01236">EVENTID_FRAG</a>, <a class="el" href="midas_8h_source.html#l01235">EVENTID_FRAG1</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00075">found</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="generate-MODULES_8h_source.html#l00003">if</a>, <a class="el" href="mcnaf_8c_source.html#l00073">LOOP</a>, <a class="el" href="midas_8h_source.html#l01753">M_MALLOC</a>, <a class="el" href="midas_8h_source.html#l01281">BUFFER_HEADER::max_client_index</a>, <a class="el" href="midas_8h_source.html#l01262">BUFFER_CLIENT::max_request_index</a>, <a class="el" href="midas_8h_source.html#l00935">MDEBUG</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="midas_8h_source.html#l01286">BUFFER_HEADER::num_out_events</a>, <a class="el" href="midas_8h_source.html#l01257">BUFFER_CLIENT::pid</a>, <a class="el" href="midas_8h_source.html#l01260">BUFFER_CLIENT::port</a>, <a class="el" href="midas_8h_source.html#l01299">BUFFER::read_cache</a>, <a class="el" href="midas_8h_source.html#l01301">BUFFER::read_cache_rp</a>, <a class="el" href="midas_8h_source.html#l01300">BUFFER::read_cache_size</a>, <a class="el" href="midas_8h_source.html#l01302">BUFFER::read_cache_wp</a>, <a class="el" href="midas_8h_source.html#l01283">BUFFER_HEADER::read_pointer</a>, <a class="el" href="midas_8h_source.html#l01261">BUFFER_CLIENT::read_pointer</a>, <a class="el" href="midas_8h_source.html#l01282">BUFFER_HEADER::size</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="system_8c_source.html#l00996">ss_getpid()</a>, <a class="el" href="system_8c_source.html#l01050">ss_gettid()</a>, <a class="el" href="system_8c_source.html#l03549">ss_resume()</a>, <a class="el" href="midas_8h_source.html#l01258">BUFFER_CLIENT::tid</a>, <a class="el" href="midas_8h_source.html#l01249">EVENT_REQUEST::trigger_mask</a>, <a class="el" href="p30_8h_source.html#l00043">TRUE</a>, <a class="el" href="midas_8h_source.html#l01247">EVENT_REQUEST::valid</a>, <a class="el" href="midas_8h_source.html#l01284">BUFFER_HEADER::write_pointer</a>, and <a class="el" href="midas_8h_source.html#l01268">BUFFER_CLIENT::write_wait</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l07429">bm_check_buffers()</a>, and <a class="el" href="midas_8c_source.html#l04080">cm_dispatch_ipc()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l07158"></a>07158 {
<a name="l07159"></a>07159 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l07160"></a>07160 <span class="preprocessor"></span>   {
<a name="l07161"></a>07161       <a class="code" href="structBUFFER.html">BUFFER</a> *pbuf;
<a name="l07162"></a>07162       <a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a> *pheader;
<a name="l07163"></a>07163       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient, *pc, *pctmp;
<a name="l07164"></a>07164       <a class="code" href="structEVENT__REQUEST.html">EVENT_REQUEST</a> *prequest;
<a name="l07165"></a>07165       <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l07166"></a>07166       <span class="keywordtype">char</span> *pdata;
<a name="l07167"></a>07167       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, min_wp, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, total_size, buffer_handle;
<a name="l07168"></a>07168       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> my_client_index;
<a name="l07169"></a>07169       <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="patch__mevb_8cpp.html#a408216eef095a35ba3963fc6f4f4d7a8">found</a>;
<a name="l07170"></a>07170       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> old_read_pointer, new_read_pointer;
<a name="l07171"></a>07171 
<a name="l07172"></a>07172       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a>; i++)
<a name="l07173"></a>07173          <span class="keywordflow">if</span> (strcmp(<a class="code" href="mevb_8cpp.html#a93bc09c1f5f9f26a081d11962971f301">buffer_name</a>, <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[i].buffer_header-&gt;name) == 0)
<a name="l07174"></a>07174             <span class="keywordflow">break</span>;
<a name="l07175"></a>07175       <span class="keywordflow">if</span> (i == _buffer_entries)
<a name="l07176"></a>07176          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l07177"></a>07177 
<a name="l07178"></a>07178       buffer_handle = i + 1;
<a name="l07179"></a>07179       pbuf = &amp;<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1];
<a name="l07180"></a>07180 
<a name="l07181"></a>07181       <span class="keywordflow">if</span> (!pbuf-&gt;<a class="code" href="structBUFFER.html#a495ba8d2558dac6d40a46564c5067a2c">attached</a>)
<a name="l07182"></a>07182          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l07183"></a>07183 
<a name="l07184"></a>07184       <span class="comment">/* return immediately if no callback routine is defined */</span>
<a name="l07185"></a>07185       <span class="keywordflow">if</span> (!pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga9611e4a4e83bdf10fc85a02c6de72da5">callback</a>)
<a name="l07186"></a>07186          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l07187"></a>07187 
<a name="l07188"></a>07188       <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga5b954f9390d9925bf6b0943baa151bcb">_event_buffer_size</a> == 0) {
<a name="l07189"></a>07189          <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a> = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="group__msectionh.html#ga130728d73c8c9b46e0b9bd2e34557c3d">M_MALLOC</a>(1000);
<a name="l07190"></a>07190          <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a> == NULL) {
<a name="l07191"></a>07191             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_push_event&quot;</span>, <span class="stringliteral">&quot;not enough memory to allocate cache buffer&quot;</span>);
<a name="l07192"></a>07192             <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l07193"></a>07193          }
<a name="l07194"></a>07194          <a class="code" href="group__midasincludecode.html#ga5b954f9390d9925bf6b0943baa151bcb">_event_buffer_size</a> = 1000;
<a name="l07195"></a>07195       }
<a name="l07196"></a>07196 
<a name="l07197"></a>07197     CACHE_READ:
<a name="l07198"></a>07198 
<a name="l07199"></a>07199       <span class="comment">/* look if there is anything in the cache */</span>
<a name="l07200"></a>07200       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a>) {
<a name="l07201"></a>07201          pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a>);
<a name="l07202"></a>07202          size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l07203"></a>07203 
<a name="l07204"></a>07204          <span class="comment">/* correct size for DWORD boundary */</span>
<a name="l07205"></a>07205          size = <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(size);
<a name="l07206"></a>07206 
<a name="l07207"></a>07207          <span class="comment">/* increment read pointer */</span>
<a name="l07208"></a>07208          pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a> += size;
<a name="l07209"></a>07209          <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a> == pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a>)
<a name="l07210"></a>07210             pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a> = pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> = 0;
<a name="l07211"></a>07211 
<a name="l07212"></a>07212          <span class="comment">/* call dispatcher */</span>
<a name="l07213"></a>07213          <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__midasincludecode.html#ga6dc3fd8dcb204a2379ed33a7e4645a2d">_request_list_entries</a>; i++)
<a name="l07214"></a>07214             <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].buffer_handle == buffer_handle &amp;&amp;
<a name="l07215"></a>07215                 <a class="code" href="group__bmfunctionc.html#ga181dcf462745127aa3d011a2e3fee805">bm_match_event</a>(<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>,
<a name="l07216"></a>07216                                <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a>, pevent)) {
<a name="l07217"></a>07217                <span class="comment">/* if event is fragmented, call defragmenter */</span>
<a name="l07218"></a>07218                <span class="keywordflow">if</span> ((pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xF000) == <a class="code" href="group__mbufferh.html#gaae07538917933e32355933ac1e2e3d60">EVENTID_FRAG1</a> ||
<a name="l07219"></a>07219                    (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xF000) == <a class="code" href="group__mbufferh.html#ga4fb6de5cc7e1f2da82266094a02d0ff7">EVENTID_FRAG</a>)
<a name="l07220"></a>07220                   <a class="code" href="group__msystemincludecode.html#gab7e29f86ca0340171d22fb086cba0dd8">bm_defragment_event</a>(buffer_handle, i, pevent, (<span class="keywordtype">void</span> *) (pevent + 1),
<a name="l07221"></a>07221                                       <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].dispatcher);
<a name="l07222"></a>07222                <span class="keywordflow">else</span>
<a name="l07223"></a>07223                   <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].<a class="code" href="structREQUEST__LIST.html#ab758c78a1c81c02eab2f378951e04100">dispatcher</a>(buffer_handle, i, pevent,
<a name="l07224"></a>07224                                               (<span class="keywordtype">void</span> *) (pevent + 1));
<a name="l07225"></a>07225             }
<a name="l07226"></a>07226 
<a name="l07227"></a>07227          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga0ef7db8ae9812d639f07e3d654d76e90">BM_MORE_EVENTS</a>;
<a name="l07228"></a>07228       }
<a name="l07229"></a>07229 
<a name="l07230"></a>07230       <span class="comment">/* calculate some shorthands */</span>
<a name="l07231"></a>07231       pheader = pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>;
<a name="l07232"></a>07232       pdata = (<span class="keywordtype">char</span> *) (pheader + 1);
<a name="l07233"></a>07233       my_client_index = pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>;
<a name="l07234"></a>07234       pclient = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>;
<a name="l07235"></a>07235       pc = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a> + my_client_index;
<a name="l07236"></a>07236 
<a name="l07237"></a>07237       <span class="comment">/* first do a quick check without locking the buffer */</span>
<a name="l07238"></a>07238       <span class="keywordflow">if</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> == pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>)
<a name="l07239"></a>07239          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l07240"></a>07240 
<a name="l07241"></a>07241       <span class="comment">/* lock the buffer */</span>
<a name="l07242"></a>07242       <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l07243"></a>07243 
<a name="l07244"></a>07244     <a class="code" href="mcnaf_8c.html#a8e8f11caf539de9555d07b4e7ef5b1da">LOOP</a>:
<a name="l07245"></a>07245 
<a name="l07246"></a>07246       <span class="keywordflow">if</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> == pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>) {
<a name="l07247"></a>07247          <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l07248"></a>07248 
<a name="l07249"></a>07249          <span class="comment">/* return if no event available */</span>
<a name="l07250"></a>07250          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l07251"></a>07251       }
<a name="l07252"></a>07252 
<a name="l07253"></a>07253       <span class="comment">/* check if event at current read pointer matches a request */</span>
<a name="l07254"></a>07254       found = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l07255"></a>07255 
<a name="l07256"></a>07256       <span class="keywordflow">do</span> {
<a name="l07257"></a>07257          pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pdata + pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>);
<a name="l07258"></a>07258 
<a name="l07259"></a>07259          total_size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l07260"></a>07260          total_size = <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(total_size);
<a name="l07261"></a>07261 
<a name="l07262"></a>07262          prequest = pc-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>;
<a name="l07263"></a>07263 
<a name="l07264"></a>07264          <span class="keywordflow">for</span> (i = 0; i &lt; pc-&gt;<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a>; i++, prequest++)
<a name="l07265"></a>07265             <span class="keywordflow">if</span> (prequest-&gt;<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a> &amp;&amp;
<a name="l07266"></a>07266                 <a class="code" href="group__bmfunctionc.html#ga181dcf462745127aa3d011a2e3fee805">bm_match_event</a>(prequest-&gt;<a class="code" href="group__midasincludecode.html#ga861d57422d21affdcfe60a67a3f8cb7f">event_id</a>, prequest-&gt;<a class="code" href="group__midasincludecode.html#ga8947eb12d18f6202ecc9d603f3bde410">trigger_mask</a>, pevent)) {
<a name="l07267"></a>07267                <span class="comment">/* we found one, so copy it */</span>
<a name="l07268"></a>07268 
<a name="l07269"></a>07269                <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &gt; 0 &amp;&amp;
<a name="l07270"></a>07270                    !(total_size &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &amp;&amp; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> == 0)) {
<a name="l07271"></a>07271                   <span class="comment">/* copy dispatch function and event to cache */</span>
<a name="l07272"></a>07272 
<a name="l07273"></a>07273                   <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> - pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> &lt;
<a name="l07274"></a>07274                       total_size + (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *) + (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) <span class="keyword">sizeof</span>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>))
<a name="l07275"></a>07275                      <span class="keywordflow">goto</span> CACHE_FULL;
<a name="l07276"></a>07276 
<a name="l07277"></a>07277                   <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> + total_size &lt;= pheader-&gt;size) {
<a name="l07278"></a>07278                      <span class="comment">/* copy event to cache */</span>
<a name="l07279"></a>07279                      memcpy(pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a>, pevent, total_size);
<a name="l07280"></a>07280                   } <span class="keywordflow">else</span> {
<a name="l07281"></a>07281                      <span class="comment">/* event is splitted */</span>
<a name="l07282"></a>07282 
<a name="l07283"></a>07283                      size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l07284"></a>07284                      memcpy(pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a>, pevent, size);
<a name="l07285"></a>07285                      memcpy((<span class="keywordtype">char</span> *) pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> + size,
<a name="l07286"></a>07286                             pdata, total_size - size);
<a name="l07287"></a>07287                   }
<a name="l07288"></a>07288 
<a name="l07289"></a>07289                   pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> += total_size;
<a name="l07290"></a>07290                } <span class="keywordflow">else</span> {
<a name="l07291"></a>07291                   <span class="comment">/* copy event to copy buffer, save dispatcher */</span>
<a name="l07292"></a>07292 
<a name="l07293"></a>07293                   <span class="keywordflow">if</span> (total_size &gt; <a class="code" href="group__midasincludecode.html#ga5b954f9390d9925bf6b0943baa151bcb">_event_buffer_size</a>) {
<a name="l07294"></a>07294                      <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a> = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) realloc(<a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>, total_size);
<a name="l07295"></a>07295                      <a class="code" href="group__midasincludecode.html#ga5b954f9390d9925bf6b0943baa151bcb">_event_buffer_size</a> = total_size;
<a name="l07296"></a>07296                   }
<a name="l07297"></a>07297 
<a name="l07298"></a>07298                   <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> + total_size &lt;= pheader-&gt;size) {
<a name="l07299"></a>07299                      memcpy(<a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>, pevent, total_size);
<a name="l07300"></a>07300                   } <span class="keywordflow">else</span> {
<a name="l07301"></a>07301                      <span class="comment">/* event is splitted */</span>
<a name="l07302"></a>07302                      size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l07303"></a>07303 
<a name="l07304"></a>07304                      memcpy(<a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>, pevent, size);
<a name="l07305"></a>07305                      memcpy((<span class="keywordtype">char</span> *) <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a> + size, pdata, total_size - size);
<a name="l07306"></a>07306                   }
<a name="l07307"></a>07307                }
<a name="l07308"></a>07308 
<a name="l07309"></a>07309                <span class="comment">/* update statistics */</span>
<a name="l07310"></a>07310                found = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l07311"></a>07311                pheader-&gt;<a class="code" href="group__midasincludecode.html#ga945ea5f8272cf66bfe20e68a0b86b599">num_out_events</a>++;
<a name="l07312"></a>07312                <span class="keywordflow">break</span>;
<a name="l07313"></a>07313             }
<a name="l07314"></a>07314 
<a name="l07315"></a>07315          old_read_pointer = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l07316"></a>07316 
<a name="l07317"></a>07317          <span class="comment">/* shift read pointer */</span>
<a name="l07318"></a>07318          new_read_pointer = (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> + total_size) % pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l07319"></a>07319 
<a name="l07320"></a>07320          <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (new_read_pointer &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l07321"></a>07321             new_read_pointer = 0;
<a name="l07322"></a>07322 
<a name="l07323"></a>07323 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l07324"></a>07324 <span class="preprocessor"></span>         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_receive_event -&gt; wp=%d, rp %d -&gt; %d (found=%d,size=%d)&quot;</span>,
<a name="l07325"></a>07325                 pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>, new_read_pointer, found,
<a name="l07326"></a>07326                 total_size);
<a name="l07327"></a>07327 <span class="preprocessor">#endif</span>
<a name="l07328"></a>07328 <span class="preprocessor"></span>
<a name="l07329"></a>07329          pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> = new_read_pointer;
<a name="l07330"></a>07330 
<a name="l07331"></a>07331          <span class="comment">/*</span>
<a name="l07332"></a>07332 <span class="comment">            Repeat until a requested event is found or no more events</span>
<a name="l07333"></a>07333 <span class="comment">            are available or large event received.</span>
<a name="l07334"></a>07334 <span class="comment">          */</span>
<a name="l07335"></a>07335 
<a name="l07336"></a>07336          <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> == 0 &amp;&amp; found)
<a name="l07337"></a>07337             <span class="keywordflow">break</span>;
<a name="l07338"></a>07338 
<a name="l07339"></a>07339          <span class="comment">/* break if event has bypassed read cache */</span>
<a name="l07340"></a>07340          <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &gt; 0 &amp;&amp;
<a name="l07341"></a>07341              total_size &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &amp;&amp; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> == 0)
<a name="l07342"></a>07342             <span class="keywordflow">break</span>;
<a name="l07343"></a>07343 
<a name="l07344"></a>07344       } <span class="keywordflow">while</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> != pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>);
<a name="l07345"></a>07345 
<a name="l07346"></a>07346     CACHE_FULL:
<a name="l07347"></a>07347 
<a name="l07348"></a>07348       <span class="comment">/* calculate global read pointer as &quot;minimum&quot; of client read pointers */</span>
<a name="l07349"></a>07349       min_wp = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l07350"></a>07350 
<a name="l07351"></a>07351       <span class="keywordflow">for</span> (i = 0, pctmp = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pctmp++)
<a name="l07352"></a>07352          <span class="keywordflow">if</span> (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a>) {
<a name="l07353"></a>07353             <span class="keywordflow">if</span> (pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &lt; min_wp)
<a name="l07354"></a>07354                min_wp = pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l07355"></a>07355 
<a name="l07356"></a>07356             <span class="keywordflow">if</span> (pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> &amp;&amp;
<a name="l07357"></a>07357                 pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> &lt; min_wp)
<a name="l07358"></a>07358                min_wp = pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l07359"></a>07359          }
<a name="l07360"></a>07360 
<a name="l07361"></a>07361       <span class="keywordflow">if</span> (min_wp &lt; 0)
<a name="l07362"></a>07362          min_wp += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l07363"></a>07363 
<a name="l07364"></a>07364       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> = min_wp;
<a name="l07365"></a>07365 
<a name="l07366"></a>07366       <span class="comment">/*</span>
<a name="l07367"></a>07367 <span class="comment">         If read pointer has been changed, it may have freed up some space</span>
<a name="l07368"></a>07368 <span class="comment">         for waiting producers. So check if free space is now more than 50%</span>
<a name="l07369"></a>07369 <span class="comment">         of the buffer size and wake waiting producers.</span>
<a name="l07370"></a>07370 <span class="comment">       */</span>
<a name="l07371"></a>07371       size = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l07372"></a>07372       <span class="keywordflow">if</span> (size &lt;= 0)
<a name="l07373"></a>07373          size += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l07374"></a>07374 
<a name="l07375"></a>07375       <span class="keywordflow">if</span> (size &gt;= pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> * 0.5)
<a name="l07376"></a>07376          <span class="keywordflow">for</span> (i = 0, pctmp = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pctmp++)
<a name="l07377"></a>07377             <span class="keywordflow">if</span> (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> &amp;&amp; (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga884b0a6395661ef9f711fa3ca7bc19b6">write_wait</a> &lt; size) &amp;&amp; (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> != <a class="code" href="group__msystemincludecode.html#ga6450a1c1781b4b12ddf46f30bb431be5">ss_getpid</a>() ||       <span class="comment">/* check if not own thread */</span>
<a name="l07378"></a>07378                                                              (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> == <a class="code" href="group__msystemincludecode.html#ga6450a1c1781b4b12ddf46f30bb431be5">ss_getpid</a>()
<a name="l07379"></a>07379                                                               &amp;&amp; pctmp-&gt;<a class="code" href="group__midasincludecode.html#gaf3cbabe9dae84f54a2c8b050414f4418">tid</a> !=
<a name="l07380"></a>07380                                                               <a class="code" href="group__msystemincludecode.html#ga47dde62638a1a4e9f49534bff449ebcd">ss_gettid</a>()))) {
<a name="l07381"></a>07381 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l07382"></a>07382 <span class="preprocessor"></span>               <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Receive wake: rp=%d, wp=%d, level=%1.1lf&quot;</span>,
<a name="l07383"></a>07383                       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l07384"></a>07384                       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, 100 - 100.0 * size / pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>);
<a name="l07385"></a>07385 <span class="preprocessor">#endif</span>
<a name="l07386"></a>07386 <span class="preprocessor"></span>               <a class="code" href="group__msystemincludecode.html#ga2f07c99535bcb2959efc54c5cdbf6747">ss_resume</a>(pctmp-&gt;<a class="code" href="group__midasincludecode.html#gad8112ed9dd177230ff2a9acfd84c5429">port</a>, <span class="stringliteral">&quot;B  &quot;</span>);
<a name="l07387"></a>07387             }
<a name="l07388"></a>07388 
<a name="l07389"></a>07389       <span class="comment">/* if no matching event found, start again */</span>
<a name="l07390"></a>07390       <span class="keywordflow">if</span> (!found)
<a name="l07391"></a>07391          <span class="keywordflow">goto</span> <a class="code" href="mcnaf_8c.html#a8e8f11caf539de9555d07b4e7ef5b1da">LOOP</a>;
<a name="l07392"></a>07392 
<a name="l07393"></a>07393       <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l07394"></a>07394 
<a name="l07395"></a>07395       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &gt; 0 &amp;&amp;
<a name="l07396"></a>07396           !(total_size &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &amp;&amp; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> == 0))
<a name="l07397"></a>07397          <span class="keywordflow">goto</span> CACHE_READ;
<a name="l07398"></a>07398 
<a name="l07399"></a>07399       <span class="comment">/* call dispatcher */</span>
<a name="l07400"></a>07400       <span class="keywordflow">for</span> (i = 0; i &lt; _request_list_entries; i++)
<a name="l07401"></a>07401          <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].buffer_handle == buffer_handle &amp;&amp;
<a name="l07402"></a>07402              <a class="code" href="group__bmfunctionc.html#ga181dcf462745127aa3d011a2e3fee805">bm_match_event</a>(<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].event_id,
<a name="l07403"></a>07403                             <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].trigger_mask, <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>)) {
<a name="l07404"></a>07404             <span class="keywordflow">if</span> ((<a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xF000) == <a class="code" href="group__mbufferh.html#gaae07538917933e32355933ac1e2e3d60">EVENTID_FRAG1</a> ||
<a name="l07405"></a>07405                 (<a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> &amp; 0xF000) == <a class="code" href="group__mbufferh.html#ga4fb6de5cc7e1f2da82266094a02d0ff7">EVENTID_FRAG</a>)
<a name="l07406"></a>07406                <a class="code" href="group__msystemincludecode.html#gab7e29f86ca0340171d22fb086cba0dd8">bm_defragment_event</a>(buffer_handle, i, <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>,
<a name="l07407"></a>07407                                    (<span class="keywordtype">void</span> *) (((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>) + 1),
<a name="l07408"></a>07408                                    <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].dispatcher);
<a name="l07409"></a>07409             <span class="keywordflow">else</span>
<a name="l07410"></a>07410                <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[i].<a class="code" href="structREQUEST__LIST.html#ab758c78a1c81c02eab2f378951e04100">dispatcher</a>(buffer_handle, i, <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>,
<a name="l07411"></a>07411                                            (<span class="keywordtype">void</span> *) (((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="group__midasincludecode.html#ga6dfe6640173c6c6c68d66e92193c1cf5">_event_buffer</a>) +
<a name="l07412"></a>07412                                                      1));
<a name="l07413"></a>07413          }
<a name="l07414"></a>07414 
<a name="l07415"></a>07415       <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga0ef7db8ae9812d639f07e3d654d76e90">BM_MORE_EVENTS</a>;
<a name="l07416"></a>07416    }
<a name="l07417"></a>07417 <span class="preprocessor">#else                           </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l07418"></a>07418 
<a name="l07419"></a>07419    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l07420"></a>07420 <span class="preprocessor">#endif</span>
<a name="l07421"></a>07421 <span class="preprocessor"></span>}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga2fd8bb52ad5282be3ce076e84bc007fa"></a><!-- doxytag: member="midas.c::bm_receive_event" ref="ga2fd8bb52ad5282be3ce076e84bc007fa" args="(INT buffer_handle, void *destination, INT *buf_size, INT async_flag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_receive_event </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>destination</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> *&nbsp;</td>
          <td class="paramname"> <em>buf_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>async_flag</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Receives events directly. This function is an alternative way to receive events without a main loop.</p>
<p>It can be used in analysis systems which actively receive events, rather than using callbacks. A analysis package could for example contain its own command line interface. A command like "receive 1000 events" could make it necessary to call <a class="el" href="group__msectionh.html#ga0f5bcc113e8cb6023e1f3a61f6c78c48">bm_receive_event()</a> 1000 times in a row to receive these events and then return back to the command line prompt. The according <a class="el" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event()</a> call contains NULL as the callback routine to indicate that <a class="el" href="group__msectionh.html#ga0f5bcc113e8cb6023e1f3a61f6c78c48">bm_receive_event()</a> is called to receive events. </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<span class="keywordtype">void</span> <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pheader)
{
 printf(<span class="stringliteral">&quot;Received event #%d\r&quot;</span>,
 pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
}
<a class="code" href="mucap__compress_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>()
{
  <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, request_id;
  <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hbuf;
  <span class="keywordtype">char</span> <a class="code" href="consume_8c.html#a881e3cadecfb2fe6d53b7e33e74ac6d2">event_buffer</a>[1000];
  status = <a class="code" href="group__msectionh.html#gae12b15703f10f41044e599520e665f5a">cm_connect_experiment</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;Sample&quot;</span>,
  <span class="stringliteral">&quot;Simple Analyzer&quot;</span>, NULL);
  <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
   <span class="keywordflow">return</span> 1;
  <a class="code" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer</a>(<a class="code" href="group__midasincludecode.html#gab520c690db83550e545ce6afbb12de3f">EVENT_BUFFER_NAME</a>, <a class="code" href="group__midasincludecode.html#gacc4dda1aaabc9862fe79fd94e0b722bf">EVENT_BUFFER_SIZE</a>, &amp;hbuf);
  <a class="code" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event</a>(hbuf, 1, <a class="code" href="group__mdefineh.html#ga26aa4bcea89857cb7ca669339695ceac">TRIGGER_ALL</a>, <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>, request_id, NULL);

  <span class="keywordflow">do</span>
  {
   size = <span class="keyword">sizeof</span>(event_buffer);
   status = <a class="code" href="group__msectionh.html#ga0f5bcc113e8cb6023e1f3a61f6c78c48">bm_receive_event</a>(hbuf, event_buffer, &amp;size, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>);
  <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
   <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) event_buffer);
   &lt;...do something <span class="keywordflow">else</span>...&gt;
   status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(0);
  } <span class="keywordflow">while</span> (status != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> &amp;&amp;
  status != <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>);
  <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
  <span class="keywordflow">return</span> 0;
}
</pre></div> <dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_handle</em>&nbsp;</td><td>buffer handle </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>destination</em>&nbsp;</td><td>destination address where event is written to </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buf_size</em>&nbsp;</td><td>size of destination buffer on input, size of event plus header on return. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>async_flag</em>&nbsp;</td><td>Synchronous/asynchronous flag. If FALSE, the function blocks if no event is available. If TRUE, the function returns immediately with a value of BM_ASYNC_RETURN without receiving any event. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE <br/>
 BM_TRUNCATED The event is larger than the destination buffer and was therefore truncated <br/>
 BM_ASYNC_RETURN No event available </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l06777">6777</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l00904">ALIGN8</a>, <a class="el" href="midas_8h_source.html#l00756">ASYNC</a>, <a class="el" href="midas_8h_source.html#l01295">BUFFER::attached</a>, <a class="el" href="midas_8h_source.html#l00985">BM_ASYNC_RETURN</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8c_source.html#l04327">bm_match_event()</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8h_source.html#l00986">BM_TRUNCATED</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01288">BUFFER_HEADER::client</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="midas_8h_source.html#l01195">EVENT_HEADER::data_size</a>, <a class="el" href="midas_8h_source.html#l01248">EVENT_REQUEST::event_id</a>, <a class="el" href="midas_8h_source.html#l01191">EVENT_HEADER::event_id</a>, <a class="el" href="midas_8h_source.html#l01274">BUFFER_CLIENT::event_request</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00075">found</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="generate-MODULES_8h_source.html#l00003">if</a>, <a class="el" href="mcnaf_8c_source.html#l00073">LOOP</a>, <a class="el" href="midas_8h_source.html#l01281">BUFFER_HEADER::max_client_index</a>, <a class="el" href="midas_8h_source.html#l01262">BUFFER_CLIENT::max_request_index</a>, <a class="el" href="midas_8h_source.html#l00935">MDEBUG</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="msystem_8h_source.html#l00399">MSG_BM</a>, <a class="el" href="msystem_8h_source.html#l00257">NET_BUFFER_SIZE</a>, <a class="el" href="midas_8h_source.html#l01286">BUFFER_HEADER::num_out_events</a>, <a class="el" href="midas_8h_source.html#l01257">BUFFER_CLIENT::pid</a>, <a class="el" href="midas_8h_source.html#l01260">BUFFER_CLIENT::port</a>, <a class="el" href="midas_8h_source.html#l01299">BUFFER::read_cache</a>, <a class="el" href="midas_8h_source.html#l01301">BUFFER::read_cache_rp</a>, <a class="el" href="midas_8h_source.html#l01300">BUFFER::read_cache_size</a>, <a class="el" href="midas_8h_source.html#l01302">BUFFER::read_cache_wp</a>, <a class="el" href="midas_8h_source.html#l01283">BUFFER_HEADER::read_pointer</a>, <a class="el" href="midas_8h_source.html#l01261">BUFFER_CLIENT::read_pointer</a>, <a class="el" href="midas_8h_source.html#l01267">BUFFER_CLIENT::read_wait</a>, <a class="el" href="mrpc_8h_source.html#l00127">RPC_BM_RECEIVE_EVENT</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8h_source.html#l00774">RPC_CONVERT_FLAGS</a>, <a class="el" href="midas_8c_source.html#l08079">rpc_convert_single()</a>, <a class="el" href="midas_8c_source.html#l09250">rpc_get_server_option()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l01069">RPC_NET_ERROR</a>, <a class="el" href="midas_8h_source.html#l00772">RPC_OSERVER_TYPE</a>, <a class="el" href="midas_8h_source.html#l01786">RPC_OUTGOING</a>, <a class="el" href="midas_8h_source.html#l01193">EVENT_HEADER::serial_number</a>, <a class="el" href="midas_8h_source.html#l01282">BUFFER_HEADER::size</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="midas_8h_source.html#l01047">SS_ABORT</a>, <a class="el" href="system_8c_source.html#l00996">ss_getpid()</a>, <a class="el" href="system_8c_source.html#l01050">ss_gettid()</a>, <a class="el" href="system_8c_source.html#l03549">ss_resume()</a>, <a class="el" href="midas_8h_source.html#l01033">SS_SUCCESS</a>, <a class="el" href="system_8c_source.html#l03283">ss_suspend()</a>, <a class="el" href="midas_8h_source.html#l01795">ST_REMOTE</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, <a class="el" href="midas_8h_source.html#l01258">BUFFER_CLIENT::tid</a>, <a class="el" href="midas_8h_source.html#l00740">TID_DWORD</a>, <a class="el" href="midas_8h_source.html#l00739">TID_SHORT</a>, <a class="el" href="midas_8h_source.html#l01194">EVENT_HEADER::time_stamp</a>, <a class="el" href="midas_8h_source.html#l01249">EVENT_REQUEST::trigger_mask</a>, <a class="el" href="midas_8h_source.html#l01192">EVENT_HEADER::trigger_mask</a>, <a class="el" href="p30_8h_source.html#l00043">TRUE</a>, <a class="el" href="midas_8h_source.html#l01247">EVENT_REQUEST::valid</a>, <a class="el" href="midas_8h_source.html#l01284">BUFFER_HEADER::write_pointer</a>, and <a class="el" href="midas_8h_source.html#l01268">BUFFER_CLIENT::write_wait</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l07616">bm_poll_event()</a>, <a class="el" href="mevb_8cpp_source.html#l00724">handFlush()</a>, <a class="el" href="msgdump_8c_source.html#l00037">main()</a>, <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>, and <a class="el" href="mevb_8cpp_source.html#l00916">source_scan()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l06778"></a>06778 {
<a name="l06779"></a>06779    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>()) {
<a name="l06780"></a>06780       <span class="keywordflow">if</span> (*buf_size &gt; <a class="code" href="group__msystemincludecode.html#ga7554d698d310e57e1c933a8f952a4bf8">NET_BUFFER_SIZE</a>) {
<a name="l06781"></a>06781          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_receive_event&quot;</span>,
<a name="l06782"></a>06782                 <span class="stringliteral">&quot;max. event size larger than NET_BUFFER_SIZE&quot;</span>);
<a name="l06783"></a>06783          <span class="keywordflow">return</span> <a class="code" href="group__err25.html#gae7db91aa77eeed4371ba30dfc122ded6">RPC_NET_ERROR</a>;
<a name="l06784"></a>06784       }
<a name="l06785"></a>06785 
<a name="l06786"></a>06786       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#gad0d0e115e7026f808f8df526ff5c77ee">RPC_BM_RECEIVE_EVENT</a>, buffer_handle,
<a name="l06787"></a>06787                       destination, buf_size, async_flag);
<a name="l06788"></a>06788    }
<a name="l06789"></a>06789 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l06790"></a>06790 <span class="preprocessor"></span>   {
<a name="l06791"></a>06791       <a class="code" href="structBUFFER.html">BUFFER</a> *pbuf;
<a name="l06792"></a>06792       <a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a> *pheader;
<a name="l06793"></a>06793       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient, *pc, *pctmp;
<a name="l06794"></a>06794       <a class="code" href="structEVENT__REQUEST.html">EVENT_REQUEST</a> *prequest;
<a name="l06795"></a>06795       <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l06796"></a>06796       <span class="keywordtype">char</span> *pdata;
<a name="l06797"></a>06797       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> convert_flags;
<a name="l06798"></a>06798       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, min_wp, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, max_size, total_size, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a> = 0;
<a name="l06799"></a>06799       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> my_client_index;
<a name="l06800"></a>06800       <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="patch__mevb_8cpp.html#a408216eef095a35ba3963fc6f4f4d7a8">found</a>;
<a name="l06801"></a>06801       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> old_read_pointer, new_read_pointer;
<a name="l06802"></a>06802 
<a name="l06803"></a>06803       pbuf = &amp;<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1];
<a name="l06804"></a>06804 
<a name="l06805"></a>06805       <span class="keywordflow">if</span> (buffer_handle &gt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> || buffer_handle &lt;= 0) {
<a name="l06806"></a>06806          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_receive_event&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l06807"></a>06807          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l06808"></a>06808       }
<a name="l06809"></a>06809 
<a name="l06810"></a>06810       <span class="keywordflow">if</span> (!pbuf-&gt;<a class="code" href="structBUFFER.html#a495ba8d2558dac6d40a46564c5067a2c">attached</a>) {
<a name="l06811"></a>06811          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_receive_event&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l06812"></a>06812          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l06813"></a>06813       }
<a name="l06814"></a>06814 
<a name="l06815"></a>06815       max_size = *buf_size;
<a name="l06816"></a>06816       *buf_size = 0;
<a name="l06817"></a>06817 
<a name="l06818"></a>06818       <span class="keywordflow">if</span> (<a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#ga7f6354019d48c7beeb8f5bd5c2fac8bb">RPC_OSERVER_TYPE</a>) != <a class="code" href="group__msectionh.html#ga9c6b34250ccc696d64a6a0a572947be5">ST_REMOTE</a>)
<a name="l06819"></a>06819          convert_flags = <a class="code" href="group__msystemincludecode.html#ga500895b6f1fb39626453b56a20ed52df">rpc_get_server_option</a>(<a class="code" href="group__mdefineh.html#gaddb075d303a5903df6a7dabdad02defd">RPC_CONVERT_FLAGS</a>);
<a name="l06820"></a>06820       <span class="keywordflow">else</span>
<a name="l06821"></a>06821          convert_flags = 0;
<a name="l06822"></a>06822 
<a name="l06823"></a>06823     CACHE_READ:
<a name="l06824"></a>06824 
<a name="l06825"></a>06825       <span class="comment">/* look if there is anything in the cache */</span>
<a name="l06826"></a>06826       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a>) {
<a name="l06827"></a>06827          pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a>);
<a name="l06828"></a>06828          size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l06829"></a>06829 
<a name="l06830"></a>06830          <span class="keywordflow">if</span> (size &gt; max_size) {
<a name="l06831"></a>06831             memcpy(destination, pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a>, max_size);
<a name="l06832"></a>06832             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_receive_event&quot;</span>, <span class="stringliteral">&quot;event size larger than buffer size&quot;</span>);
<a name="l06833"></a>06833             *buf_size = max_size;
<a name="l06834"></a>06834             status = <a class="code" href="group__err22.html#ga21752d578978d7ffe3cdd82e28936667">BM_TRUNCATED</a>;
<a name="l06835"></a>06835          } <span class="keywordflow">else</span> {
<a name="l06836"></a>06836             memcpy(destination, pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a>, size);
<a name="l06837"></a>06837             *buf_size = size;
<a name="l06838"></a>06838             status = <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l06839"></a>06839          }
<a name="l06840"></a>06840 
<a name="l06841"></a>06841          <span class="comment">/* now convert event header */</span>
<a name="l06842"></a>06842          <span class="keywordflow">if</span> (convert_flags) {
<a name="l06843"></a>06843             pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) destination;
<a name="l06844"></a>06844             <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, <a class="code" href="group__mdefineh.html#ga4281dafac4285eae3e3c9be0a1d93c5a">TID_SHORT</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>, convert_flags);
<a name="l06845"></a>06845             <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>, <a class="code" href="group__mdefineh.html#ga4281dafac4285eae3e3c9be0a1d93c5a">TID_SHORT</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>,
<a name="l06846"></a>06846                                convert_flags);
<a name="l06847"></a>06847             <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>,
<a name="l06848"></a>06848                                convert_flags);
<a name="l06849"></a>06849             <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>,
<a name="l06850"></a>06850                                convert_flags);
<a name="l06851"></a>06851             <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>,
<a name="l06852"></a>06852                                convert_flags);
<a name="l06853"></a>06853          }
<a name="l06854"></a>06854 
<a name="l06855"></a>06855          <span class="comment">/* correct size for DWORD boundary */</span>
<a name="l06856"></a>06856          size = <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(size);
<a name="l06857"></a>06857 
<a name="l06858"></a>06858          pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a> += size;
<a name="l06859"></a>06859 
<a name="l06860"></a>06860          <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a> == pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a>)
<a name="l06861"></a>06861             pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a> = pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> = 0;
<a name="l06862"></a>06862 
<a name="l06863"></a>06863          <span class="keywordflow">return</span> status;
<a name="l06864"></a>06864       }
<a name="l06865"></a>06865 
<a name="l06866"></a>06866       <span class="comment">/* calculate some shorthands */</span>
<a name="l06867"></a>06867       pheader = pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>;
<a name="l06868"></a>06868       pdata = (<span class="keywordtype">char</span> *) (pheader + 1);
<a name="l06869"></a>06869       my_client_index = pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>;
<a name="l06870"></a>06870       pclient = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>;
<a name="l06871"></a>06871       pc = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a> + my_client_index;
<a name="l06872"></a>06872 
<a name="l06873"></a>06873       <span class="comment">/* first do a quick check without locking the buffer */</span>
<a name="l06874"></a>06874       <span class="keywordflow">if</span> (async_flag == <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a> &amp;&amp; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> == pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>)
<a name="l06875"></a>06875          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga7fb11aaff606b1785cddd205baddbbff">BM_ASYNC_RETURN</a>;
<a name="l06876"></a>06876 
<a name="l06877"></a>06877       <span class="comment">/* lock the buffer */</span>
<a name="l06878"></a>06878       <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l06879"></a>06879 
<a name="l06880"></a>06880     <a class="code" href="mcnaf_8c.html#a8e8f11caf539de9555d07b4e7ef5b1da">LOOP</a>:
<a name="l06881"></a>06881 
<a name="l06882"></a>06882       <span class="keywordflow">while</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> == pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>) {
<a name="l06883"></a>06883          <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l06884"></a>06884 
<a name="l06885"></a>06885          <span class="comment">/* return now in ASYNC mode */</span>
<a name="l06886"></a>06886          <span class="keywordflow">if</span> (async_flag == <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>)
<a name="l06887"></a>06887             <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga7fb11aaff606b1785cddd205baddbbff">BM_ASYNC_RETURN</a>;
<a name="l06888"></a>06888 
<a name="l06889"></a>06889          pc-&gt;<a class="code" href="group__midasincludecode.html#ga896acd334d608006626fcca2a872a4a4">read_wait</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l06890"></a>06890 
<a name="l06891"></a>06891          <span class="comment">/* check again pointers (may have moved in between) */</span>
<a name="l06892"></a>06892          <span class="keywordflow">if</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> == pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>) {
<a name="l06893"></a>06893 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06894"></a>06894 <span class="preprocessor"></span>            <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Receive sleep: grp=%d, rp=%d wp=%d&quot;</span>,
<a name="l06895"></a>06895                    pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>, pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>, pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06896"></a>06896 <span class="preprocessor">#endif</span>
<a name="l06897"></a>06897 <span class="preprocessor"></span>
<a name="l06898"></a>06898             status = <a class="code" href="group__msystemincludecode.html#ga057bcc23c79e804679785d98b1223bd1">ss_suspend</a>(1000, <a class="code" href="group__msystemincludecode.html#ga6e9a9a9996cea71191a21fd2009efcd1">MSG_BM</a>);
<a name="l06899"></a>06899 
<a name="l06900"></a>06900 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06901"></a>06901 <span class="preprocessor"></span>            <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Receive woke up: rp=%d, wp=%d&quot;</span>,
<a name="l06902"></a>06902                    pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>, pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06903"></a>06903 <span class="preprocessor">#endif</span>
<a name="l06904"></a>06904 <span class="preprocessor"></span>
<a name="l06905"></a>06905             <span class="comment">/* return if TCP connection broken */</span>
<a name="l06906"></a>06906             <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>)
<a name="l06907"></a>06907                <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>;
<a name="l06908"></a>06908          }
<a name="l06909"></a>06909 
<a name="l06910"></a>06910          pc-&gt;<a class="code" href="group__midasincludecode.html#ga896acd334d608006626fcca2a872a4a4">read_wait</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l06911"></a>06911 
<a name="l06912"></a>06912          <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l06913"></a>06913       }
<a name="l06914"></a>06914 
<a name="l06915"></a>06915       <span class="comment">/* check if event at current read pointer matches a request */</span>
<a name="l06916"></a>06916       found = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l06917"></a>06917 
<a name="l06918"></a>06918       <span class="keywordflow">do</span> {
<a name="l06919"></a>06919          pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pdata + pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>);
<a name="l06920"></a>06920 
<a name="l06921"></a>06921          total_size = pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l06922"></a>06922          total_size = <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(total_size);
<a name="l06923"></a>06923 
<a name="l06924"></a>06924          prequest = pc-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>;
<a name="l06925"></a>06925 
<a name="l06926"></a>06926          <span class="keywordflow">for</span> (i = 0; i &lt; pc-&gt;<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a>; i++, prequest++)
<a name="l06927"></a>06927             <span class="keywordflow">if</span> (prequest-&gt;<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a> &amp;&amp;
<a name="l06928"></a>06928                 <a class="code" href="group__bmfunctionc.html#ga181dcf462745127aa3d011a2e3fee805">bm_match_event</a>(prequest-&gt;<a class="code" href="group__midasincludecode.html#ga861d57422d21affdcfe60a67a3f8cb7f">event_id</a>, prequest-&gt;<a class="code" href="group__midasincludecode.html#ga8947eb12d18f6202ecc9d603f3bde410">trigger_mask</a>, pevent)) {
<a name="l06929"></a>06929                <span class="comment">/* we found one, so copy it */</span>
<a name="l06930"></a>06930 
<a name="l06931"></a>06931                <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &gt; 0 &amp;&amp;
<a name="l06932"></a>06932                    !(total_size &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &amp;&amp; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> == 0)) {
<a name="l06933"></a>06933                   <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> - pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> &lt; total_size)
<a name="l06934"></a>06934                      <span class="keywordflow">goto</span> CACHE_FULL;
<a name="l06935"></a>06935 
<a name="l06936"></a>06936                   <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> + total_size &lt;= pheader-&gt;size) {
<a name="l06937"></a>06937                      <span class="comment">/* copy event to cache */</span>
<a name="l06938"></a>06938                      memcpy(pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a>, pevent, total_size);
<a name="l06939"></a>06939                   } <span class="keywordflow">else</span> {
<a name="l06940"></a>06940                      <span class="comment">/* event is splitted */</span>
<a name="l06941"></a>06941                      size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l06942"></a>06942                      memcpy(pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a>, pevent, size);
<a name="l06943"></a>06943                      memcpy((<span class="keywordtype">char</span> *) pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> + size,
<a name="l06944"></a>06944                             pdata, total_size - size);
<a name="l06945"></a>06945                   }
<a name="l06946"></a>06946                } <span class="keywordflow">else</span> {
<a name="l06947"></a>06947                   <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> + total_size &lt;= pheader-&gt;size) {
<a name="l06948"></a>06948                      <span class="comment">/* event is not splitted */</span>
<a name="l06949"></a>06949                      <span class="keywordflow">if</span> (total_size &gt; max_size)
<a name="l06950"></a>06950                         memcpy(destination, pevent, max_size);
<a name="l06951"></a>06951                      <span class="keywordflow">else</span>
<a name="l06952"></a>06952                         memcpy(destination, pevent, total_size);
<a name="l06953"></a>06953                   } <span class="keywordflow">else</span> {
<a name="l06954"></a>06954                      <span class="comment">/* event is splitted */</span>
<a name="l06955"></a>06955                      size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l06956"></a>06956 
<a name="l06957"></a>06957                      <span class="keywordflow">if</span> (size &gt; max_size)
<a name="l06958"></a>06958                         memcpy(destination, pevent, max_size);
<a name="l06959"></a>06959                      <span class="keywordflow">else</span>
<a name="l06960"></a>06960                         memcpy(destination, pevent, size);
<a name="l06961"></a>06961 
<a name="l06962"></a>06962                      <span class="keywordflow">if</span> (total_size &gt; max_size) {
<a name="l06963"></a>06963                         <span class="keywordflow">if</span> (size &lt;= max_size)
<a name="l06964"></a>06964                            memcpy((<span class="keywordtype">char</span> *) destination + size, pdata, max_size - size);
<a name="l06965"></a>06965                      } <span class="keywordflow">else</span>
<a name="l06966"></a>06966                         memcpy((<span class="keywordtype">char</span> *) destination + size, pdata, total_size - size);
<a name="l06967"></a>06967                   }
<a name="l06968"></a>06968 
<a name="l06969"></a>06969                   <span class="keywordflow">if</span> (total_size &lt; max_size)
<a name="l06970"></a>06970                      *buf_size = total_size;
<a name="l06971"></a>06971                   <span class="keywordflow">else</span>
<a name="l06972"></a>06972                      *buf_size = max_size;
<a name="l06973"></a>06973 
<a name="l06974"></a>06974                   <span class="comment">/* now convert event header */</span>
<a name="l06975"></a>06975                   <span class="keywordflow">if</span> (convert_flags) {
<a name="l06976"></a>06976                      pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) destination;
<a name="l06977"></a>06977                      <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, <a class="code" href="group__mdefineh.html#ga4281dafac4285eae3e3c9be0a1d93c5a">TID_SHORT</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>,
<a name="l06978"></a>06978                                         convert_flags);
<a name="l06979"></a>06979                      <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>, <a class="code" href="group__mdefineh.html#ga4281dafac4285eae3e3c9be0a1d93c5a">TID_SHORT</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>,
<a name="l06980"></a>06980                                         convert_flags);
<a name="l06981"></a>06981                      <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>,
<a name="l06982"></a>06982                                         convert_flags);
<a name="l06983"></a>06983                      <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>,
<a name="l06984"></a>06984                                         convert_flags);
<a name="l06985"></a>06985                      <a class="code" href="group__msectionh.html#ga60b1a9cab1bd119ceb94ff84159cedd9">rpc_convert_single</a>(&amp;pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="group__msectionh.html#ga5cf5e72e7cdd75567b08ef7b3bd9e182">RPC_OUTGOING</a>,
<a name="l06986"></a>06986                                         convert_flags);
<a name="l06987"></a>06987                   }
<a name="l06988"></a>06988                }
<a name="l06989"></a>06989 
<a name="l06990"></a>06990                <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &gt; 0 &amp;&amp;
<a name="l06991"></a>06991                    !(total_size &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &amp;&amp; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> == 0)) {
<a name="l06992"></a>06992                   pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> += total_size;
<a name="l06993"></a>06993                } <span class="keywordflow">else</span> {
<a name="l06994"></a>06994                   <span class="keywordflow">if</span> (total_size &gt; max_size) {
<a name="l06995"></a>06995                      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_receive_event&quot;</span>,
<a name="l06996"></a>06996                             <span class="stringliteral">&quot;event size larger than buffer size&quot;</span>);
<a name="l06997"></a>06997                      status = <a class="code" href="group__err22.html#ga21752d578978d7ffe3cdd82e28936667">BM_TRUNCATED</a>;
<a name="l06998"></a>06998                   } <span class="keywordflow">else</span>
<a name="l06999"></a>06999                      status = <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l07000"></a>07000                }
<a name="l07001"></a>07001 
<a name="l07002"></a>07002                <span class="comment">/* update statistics */</span>
<a name="l07003"></a>07003                found = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l07004"></a>07004                pheader-&gt;<a class="code" href="group__midasincludecode.html#ga945ea5f8272cf66bfe20e68a0b86b599">num_out_events</a>++;
<a name="l07005"></a>07005                <span class="keywordflow">break</span>;
<a name="l07006"></a>07006             }
<a name="l07007"></a>07007 
<a name="l07008"></a>07008          old_read_pointer = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l07009"></a>07009 
<a name="l07010"></a>07010          <span class="comment">/* shift read pointer */</span>
<a name="l07011"></a>07011          new_read_pointer = (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> + total_size) % pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l07012"></a>07012 
<a name="l07013"></a>07013          <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (new_read_pointer &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l07014"></a>07014             new_read_pointer = 0;
<a name="l07015"></a>07015 
<a name="l07016"></a>07016 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l07017"></a>07017 <span class="preprocessor"></span>         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_receive_event -&gt; wp=%d, rp %d -&gt; %d (found=%d,size=%d)&quot;</span>,
<a name="l07018"></a>07018                 pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>, new_read_pointer, found,
<a name="l07019"></a>07019                 total_size);
<a name="l07020"></a>07020 <span class="preprocessor">#endif</span>
<a name="l07021"></a>07021 <span class="preprocessor"></span>
<a name="l07022"></a>07022          pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> = new_read_pointer;
<a name="l07023"></a>07023 
<a name="l07024"></a>07024          <span class="comment">/*</span>
<a name="l07025"></a>07025 <span class="comment">            Repeat until a requested event is found or no more events</span>
<a name="l07026"></a>07026 <span class="comment">            are available.</span>
<a name="l07027"></a>07027 <span class="comment">          */</span>
<a name="l07028"></a>07028 
<a name="l07029"></a>07029          <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> == 0 &amp;&amp; found)
<a name="l07030"></a>07030             <span class="keywordflow">break</span>;
<a name="l07031"></a>07031 
<a name="l07032"></a>07032          <span class="comment">/* break if event has bypassed read cache */</span>
<a name="l07033"></a>07033          <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &gt; 0 &amp;&amp;
<a name="l07034"></a>07034              total_size &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &amp;&amp; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> == 0)
<a name="l07035"></a>07035             <span class="keywordflow">break</span>;
<a name="l07036"></a>07036 
<a name="l07037"></a>07037       } <span class="keywordflow">while</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> != pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>);
<a name="l07038"></a>07038 
<a name="l07039"></a>07039     CACHE_FULL:
<a name="l07040"></a>07040 
<a name="l07041"></a>07041       <span class="comment">/* calculate global read pointer as &quot;minimum&quot; of client read pointers */</span>
<a name="l07042"></a>07042       min_wp = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l07043"></a>07043 
<a name="l07044"></a>07044       <span class="keywordflow">for</span> (i = 0, pctmp = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pctmp++)
<a name="l07045"></a>07045          <span class="keywordflow">if</span> (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a>) {
<a name="l07046"></a>07046             <span class="keywordflow">if</span> (pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &lt; min_wp)
<a name="l07047"></a>07047                min_wp = pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l07048"></a>07048 
<a name="l07049"></a>07049             <span class="keywordflow">if</span> (pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> &amp;&amp;
<a name="l07050"></a>07050                 pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> &lt; min_wp)
<a name="l07051"></a>07051                min_wp = pctmp-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l07052"></a>07052          }
<a name="l07053"></a>07053 
<a name="l07054"></a>07054       <span class="keywordflow">if</span> (min_wp &lt; 0)
<a name="l07055"></a>07055          min_wp += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l07056"></a>07056 
<a name="l07057"></a>07057       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> = min_wp;
<a name="l07058"></a>07058 
<a name="l07059"></a>07059       <span class="comment">/*</span>
<a name="l07060"></a>07060 <span class="comment">         If read pointer has been changed, it may have freed up some space</span>
<a name="l07061"></a>07061 <span class="comment">         for waiting producers. So check if free space is now more than 50%</span>
<a name="l07062"></a>07062 <span class="comment">         of the buffer size and wake waiting producers.</span>
<a name="l07063"></a>07063 <span class="comment">       */</span>
<a name="l07064"></a>07064       size = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l07065"></a>07065       <span class="keywordflow">if</span> (size &lt;= 0)
<a name="l07066"></a>07066          size += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l07067"></a>07067 
<a name="l07068"></a>07068       <span class="keywordflow">if</span> (size &gt;= pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> * 0.5)
<a name="l07069"></a>07069          <span class="keywordflow">for</span> (i = 0, pctmp = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pctmp++)
<a name="l07070"></a>07070             <span class="keywordflow">if</span> (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> &amp;&amp; (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga884b0a6395661ef9f711fa3ca7bc19b6">write_wait</a> &lt; size) &amp;&amp; (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> != <a class="code" href="group__msystemincludecode.html#ga6450a1c1781b4b12ddf46f30bb431be5">ss_getpid</a>() ||       <span class="comment">/* check if not own thread */</span>
<a name="l07071"></a>07071                                                              (pctmp-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a> == <a class="code" href="group__msystemincludecode.html#ga6450a1c1781b4b12ddf46f30bb431be5">ss_getpid</a>()
<a name="l07072"></a>07072                                                               &amp;&amp; pctmp-&gt;<a class="code" href="group__midasincludecode.html#gaf3cbabe9dae84f54a2c8b050414f4418">tid</a> !=
<a name="l07073"></a>07073                                                               <a class="code" href="group__msystemincludecode.html#ga47dde62638a1a4e9f49534bff449ebcd">ss_gettid</a>()))) {
<a name="l07074"></a>07074 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l07075"></a>07075 <span class="preprocessor"></span>               <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Receive wake: rp=%d, wp=%d, level=%1.1lf&quot;</span>,
<a name="l07076"></a>07076                       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l07077"></a>07077                       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, 100 - 100.0 * size / pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>);
<a name="l07078"></a>07078 <span class="preprocessor">#endif</span>
<a name="l07079"></a>07079 <span class="preprocessor"></span>               <a class="code" href="group__msystemincludecode.html#ga2f07c99535bcb2959efc54c5cdbf6747">ss_resume</a>(pctmp-&gt;<a class="code" href="group__midasincludecode.html#gad8112ed9dd177230ff2a9acfd84c5429">port</a>, <span class="stringliteral">&quot;B  &quot;</span>);
<a name="l07080"></a>07080             }
<a name="l07081"></a>07081 
<a name="l07082"></a>07082       <span class="comment">/* if no matching event found, start again */</span>
<a name="l07083"></a>07083       <span class="keywordflow">if</span> (!found)
<a name="l07084"></a>07084          <span class="keywordflow">goto</span> <a class="code" href="mcnaf_8c.html#a8e8f11caf539de9555d07b4e7ef5b1da">LOOP</a>;
<a name="l07085"></a>07085 
<a name="l07086"></a>07086       <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l07087"></a>07087 
<a name="l07088"></a>07088       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &gt; 0 &amp;&amp;
<a name="l07089"></a>07089           !(total_size &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &amp;&amp; pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> == 0))
<a name="l07090"></a>07090          <span class="keywordflow">goto</span> CACHE_READ;
<a name="l07091"></a>07091 
<a name="l07092"></a>07092       <span class="keywordflow">return</span> status;
<a name="l07093"></a>07093    }
<a name="l07094"></a>07094 <span class="preprocessor">#else                           </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l07095"></a>07095 
<a name="l07096"></a>07096    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l07097"></a>07097 <span class="preprocessor">#endif</span>
<a name="l07098"></a>07098 <span class="preprocessor"></span>}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga7810d29ac3894a4e299737bc7c7a2cf1"></a><!-- doxytag: member="midas.c::bm_remove_event_request" ref="ga7810d29ac3894a4e299737bc7c7a2cf1" args="(INT buffer_handle, INT request_id)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_remove_event_request </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>request_id</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Delete a previously placed request for a specific event type in the client structure of the buffer refereced by buffer_handle. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_handle</em>&nbsp;</td><td>Handle to the buffer where the re- quest should be placed in </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>request_id</em>&nbsp;</td><td>Request id returned by bm_request_event </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE, BM_NOT_FOUND, RPC_NET_ERROR </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l05920">5920</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l01270">BUFFER_CLIENT::all_flag</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8h_source.html#l00984">BM_NOT_FOUND</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="midas_8h_source.html#l01274">BUFFER_CLIENT::event_request</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="midas_8h_source.html#l00728">GET_ALL</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="midas_8h_source.html#l01246">EVENT_REQUEST::id</a>, <a class="el" href="midas_8h_source.html#l00684">MAX_EVENT_REQUESTS</a>, <a class="el" href="midas_8h_source.html#l01262">BUFFER_CLIENT::max_request_index</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="mrpc_8h_source.html#l00124">RPC_BM_REMOVE_EVENT_REQUEST</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l01250">EVENT_REQUEST::sampling_type</a>, <a class="el" href="p30_8h_source.html#l00043">TRUE</a>, and <a class="el" href="midas_8h_source.html#l01247">EVENT_REQUEST::valid</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l05993">bm_delete_request()</a>, and <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l05921"></a>05921 {
<a name="l05922"></a>05922    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l05923"></a>05923       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#ga3955d6212a5b08beaae12ee07aecd088">RPC_BM_REMOVE_EVENT_REQUEST</a>, buffer_handle, request_id);
<a name="l05924"></a>05924 
<a name="l05925"></a>05925 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l05926"></a>05926 <span class="preprocessor"></span>   {
<a name="l05927"></a>05927       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, deleted;
<a name="l05928"></a>05928       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient;
<a name="l05929"></a>05929 
<a name="l05930"></a>05930       <span class="keywordflow">if</span> (buffer_handle &gt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> || buffer_handle &lt;= 0) {
<a name="l05931"></a>05931          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_remove_event_request&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>,
<a name="l05932"></a>05932                 buffer_handle);
<a name="l05933"></a>05933          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l05934"></a>05934       }
<a name="l05935"></a>05935 
<a name="l05936"></a>05936       <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].attached) {
<a name="l05937"></a>05937          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_remove_event_request&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>,
<a name="l05938"></a>05938                 buffer_handle);
<a name="l05939"></a>05939          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l05940"></a>05940       }
<a name="l05941"></a>05941 
<a name="l05942"></a>05942       <span class="comment">/* get a pointer to the proper client structure */</span>
<a name="l05943"></a>05943       pclient = &amp;(<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>-&gt;
<a name="l05944"></a>05944                   client[<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>]);
<a name="l05945"></a>05945 
<a name="l05946"></a>05946       <span class="comment">/* lock buffer */</span>
<a name="l05947"></a>05947       <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l05948"></a>05948 
<a name="l05949"></a>05949       <span class="comment">/* check all requests and set to zero if matching */</span>
<a name="l05950"></a>05950       <span class="keywordflow">for</span> (i = 0, deleted = 0; i &lt; pclient-&gt;<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a>; i++)
<a name="l05951"></a>05951          <span class="keywordflow">if</span> (pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a> &amp;&amp;
<a name="l05952"></a>05952              pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="structEVENT__REQUEST.html#ab5275898e99714ff529f7fe125a91d0e">id</a> == request_id) {
<a name="l05953"></a>05953             memset(&amp;pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i], 0, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__REQUEST.html">EVENT_REQUEST</a>));
<a name="l05954"></a>05954             deleted++;
<a name="l05955"></a>05955          }
<a name="l05956"></a>05956 
<a name="l05957"></a>05957       <span class="comment">/* calculate new max_request_index entry */</span>
<a name="l05958"></a>05958       <span class="keywordflow">for</span> (i = <a class="code" href="group__midasincludecode.html#gabe76a0bd645baa376f4443c59d16e36a">MAX_EVENT_REQUESTS</a> - 1; i &gt;= 0; i--)
<a name="l05959"></a>05959          <span class="keywordflow">if</span> (pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a>)
<a name="l05960"></a>05960             <span class="keywordflow">break</span>;
<a name="l05961"></a>05961 
<a name="l05962"></a>05962       pclient-&gt;<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a> = i + 1;
<a name="l05963"></a>05963 
<a name="l05964"></a>05964       <span class="comment">/* caluclate new all_flag */</span>
<a name="l05965"></a>05965       pclient-&gt;<a class="code" href="group__midasincludecode.html#gaaecb6333b24063b91eb403a11aa4ea53">all_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l05966"></a>05966 
<a name="l05967"></a>05967       <span class="keywordflow">for</span> (i = 0; i &lt; pclient-&gt;<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a>; i++)
<a name="l05968"></a>05968          <span class="keywordflow">if</span> (pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a> &amp;&amp;
<a name="l05969"></a>05969              (pclient-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>[i].<a class="code" href="group__midasincludecode.html#ga98d63806bfe8b8d66fad6d3d6d9b08e4">sampling_type</a> &amp; <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>)) {
<a name="l05970"></a>05970             pclient-&gt;<a class="code" href="group__midasincludecode.html#gaaecb6333b24063b91eb403a11aa4ea53">all_flag</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05971"></a>05971             <span class="keywordflow">break</span>;
<a name="l05972"></a>05972          }
<a name="l05973"></a>05973 
<a name="l05974"></a>05974       <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l05975"></a>05975 
<a name="l05976"></a>05976       <span class="keywordflow">if</span> (!deleted)
<a name="l05977"></a>05977          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga3ec707ba57a9f56c19bf8d8581d8291b">BM_NOT_FOUND</a>;
<a name="l05978"></a>05978    }
<a name="l05979"></a>05979 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l05980"></a>05980 
<a name="l05981"></a>05981    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l05982"></a>05982 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="gabf663d96482aeede1846487a7ada8184"></a><!-- doxytag: member="midas.c::bm_request_event" ref="gabf663d96482aeede1846487a7ada8184" args="(HNDLE buffer_handle, short int event_id, short int trigger_mask, INT sampling_type, HNDLE *request_id, void(*func)(HNDLE, HNDLE, EVENT_HEADER *, void *))" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_request_event </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int&nbsp;</td>
          <td class="paramname"> <em>event_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">short int&nbsp;</td>
          <td class="paramname"> <em>trigger_mask</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>sampling_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> *&nbsp;</td>
          <td class="paramname"> <em>request_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void(*)(<a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a>, <a class="el" href="structEVENT__HEADER.html">EVENT_HEADER</a> *, void *)&nbsp;</td>
          <td class="paramname"> <em>func</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>dox Place an event request based on certain characteristics. Multiple event requests can be placed for each buffer, which are later identified by their request ID. They can contain different callback routines. Example see <a class="el" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer()</a> and <a class="el" href="group__msectionh.html#ga0f5bcc113e8cb6023e1f3a61f6c78c48">bm_receive_event()</a> </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_handle</em>&nbsp;</td><td>buffer handle obtained via <a class="el" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer()</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>event_id</em>&nbsp;</td><td>event ID for requested events. Use EVENTID_ALL to receive events with any ID. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>trigger_mask</em>&nbsp;</td><td>trigger mask for requested events. The requested events must have at least one bit in its trigger mask common with the requested trigger mask. Use TRIGGER_ALL to receive events with any trigger mask. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>sampling_type</em>&nbsp;</td><td>specifies how many events to receive. A value of GET_ALL receives all events which match the specified event ID and trigger mask. If the events are consumed slower than produced, the producer is automatically slowed down. A value of GET_SOME receives as much events as possible without slowing down the producer. GET_ALL is typically used by the logger, while GET_SOME is typically used by analyzers. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>request_id</em>&nbsp;</td><td>request ID returned by the function. This ID is passed to the callback routine and must be used in the <a class="el" href="group__msectionh.html#ga642e51b416da6cd6e27035fdd43ed71b">bm_delete_request()</a> routine. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>func</em>&nbsp;</td><td>allback routine which gets called when an event of the specified type is received. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE <br/>
 BM_NO_MEMORY too many requests. The value MAX_EVENT_REQUESTS in <a class="el" href="generate-MODULES_8h.html#a00d5923485ea4382260221681abdb205">midas.h</a> should be increased. </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l05852">5852</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00816">_request_list_entries</a>, <a class="el" href="midas_8c_source.html#l05703">bm_add_event_request()</a>, <a class="el" href="midas_8h_source.html#l00979">BM_NO_MEMORY</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="msystem_8h_source.html#l00550">REQUEST_LIST::buffer_handle</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="structREQUEST__LIST.html#ab758c78a1c81c02eab2f378951e04100">REQUEST_LIST::dispatcher</a>, <a class="el" href="msystem_8h_source.html#l00551">REQUEST_LIST::event_id</a>, <a class="el" href="mana_8cpp_source.html#l00677">index</a>, <a class="el" href="midas_8h_source.html#l01753">M_MALLOC</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, and <a class="el" href="msystem_8h_source.html#l00552">REQUEST_LIST::trigger_mask</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l05856"></a>05856 {
<a name="l05857"></a>05857    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l05858"></a>05858 
<a name="l05859"></a>05859    <span class="comment">/* allocate new space for the local request list */</span>
<a name="l05860"></a>05860    <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga6dc3fd8dcb204a2379ed33a7e4645a2d">_request_list_entries</a> == 0) {
<a name="l05861"></a>05861       <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a> = (<a class="code" href="structREQUEST__LIST.html">REQUEST_LIST</a> *) <a class="code" href="group__msectionh.html#ga130728d73c8c9b46e0b9bd2e34557c3d">M_MALLOC</a>(<span class="keyword">sizeof</span>(<a class="code" href="structREQUEST__LIST.html">REQUEST_LIST</a>));
<a name="l05862"></a>05862       memset(<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structREQUEST__LIST.html">REQUEST_LIST</a>));
<a name="l05863"></a>05863       <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a> == NULL) {
<a name="l05864"></a>05864          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_request_event&quot;</span>,
<a name="l05865"></a>05865                 <span class="stringliteral">&quot;not enough memory to allocate request list buffer&quot;</span>);
<a name="l05866"></a>05866          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l05867"></a>05867       }
<a name="l05868"></a>05868 
<a name="l05869"></a>05869       <a class="code" href="group__midasincludecode.html#ga6dc3fd8dcb204a2379ed33a7e4645a2d">_request_list_entries</a> = 1;
<a name="l05870"></a>05870       index = 0;
<a name="l05871"></a>05871    } <span class="keywordflow">else</span> {
<a name="l05872"></a>05872       <span class="comment">/* check for a deleted entry */</span>
<a name="l05873"></a>05873       <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="group__midasincludecode.html#ga6dc3fd8dcb204a2379ed33a7e4645a2d">_request_list_entries</a>; index++)
<a name="l05874"></a>05874          <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[index].buffer_handle)
<a name="l05875"></a>05875             <span class="keywordflow">break</span>;
<a name="l05876"></a>05876 
<a name="l05877"></a>05877       <span class="comment">/* if not found, create new one */</span>
<a name="l05878"></a>05878       <span class="keywordflow">if</span> (index == _request_list_entries) {
<a name="l05879"></a>05879          <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a> = (<a class="code" href="structREQUEST__LIST.html">REQUEST_LIST</a> *) realloc(<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>,
<a name="l05880"></a>05880                                                   <span class="keyword">sizeof</span>(<a class="code" href="structREQUEST__LIST.html">REQUEST_LIST</a>) *
<a name="l05881"></a>05881                                                   (_request_list_entries + 1));
<a name="l05882"></a>05882          <span class="keywordflow">if</span> (<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a> == NULL) {
<a name="l05883"></a>05883             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_request_event&quot;</span>,
<a name="l05884"></a>05884                    <span class="stringliteral">&quot;not enough memory to allocate request list buffer&quot;</span>);
<a name="l05885"></a>05885             <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l05886"></a>05886          }
<a name="l05887"></a>05887 
<a name="l05888"></a>05888          memset(&amp;<a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[_request_list_entries], 0, <span class="keyword">sizeof</span>(<a class="code" href="structREQUEST__LIST.html">REQUEST_LIST</a>));
<a name="l05889"></a>05889 
<a name="l05890"></a>05890          _request_list_entries++;
<a name="l05891"></a>05891       }
<a name="l05892"></a>05892    }
<a name="l05893"></a>05893 
<a name="l05894"></a>05894    <span class="comment">/* initialize request list */</span>
<a name="l05895"></a>05895    <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[index].<a class="code" href="structREQUEST__LIST.html#a650734f60b34db862f7a2631bbd45cc2">buffer_handle</a> = buffer_handle;
<a name="l05896"></a>05896    <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[index].<a class="code" href="structREQUEST__LIST.html#a9197e264672da9875f35d70c70cc6306">event_id</a> = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l05897"></a>05897    <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[index].<a class="code" href="structREQUEST__LIST.html#ad97d0cdcd65b8597dc10a5716169f8d5">trigger_mask</a> = <a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a>;
<a name="l05898"></a>05898    <a class="code" href="group__midasincludecode.html#ga35b9ab73ca718dbc2304692d0c1b9c49">_request_list</a>[index].<a class="code" href="structREQUEST__LIST.html#ab758c78a1c81c02eab2f378951e04100">dispatcher</a> = func;
<a name="l05899"></a>05899 
<a name="l05900"></a>05900    *request_id = index;
<a name="l05901"></a>05901 
<a name="l05902"></a>05902    <span class="comment">/* add request in buffer structure */</span>
<a name="l05903"></a>05903    status = <a class="code" href="group__msectionh.html#gafde91110de504bfb2b2a485ac1ff67e8">bm_add_event_request</a>(buffer_handle, <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>, <a class="code" href="examples_2macro_2midas__macro_8h.html#a0bd1d0ed89ce25955750de2382eed83f">trigger_mask</a>,
<a name="l05904"></a>05904                                  sampling_type, func, index);
<a name="l05905"></a>05905    <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l05906"></a>05906       <span class="keywordflow">return</span> status;
<a name="l05907"></a>05907 
<a name="l05908"></a>05908    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l05909"></a>05909 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga499b14a246f8ab8d5a3b6ec77bfa9407"></a><!-- doxytag: member="midas.c::bm_send_event" ref="ga499b14a246f8ab8d5a3b6ec77bfa9407" args="(INT buffer_handle, void *source, INT buf_size, INT async_flag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_send_event </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>source</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buf_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>async_flag</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Sends an event to a buffer. This function check if the buffer has enough space for the event, then copies the event to the buffer in shared memory. If clients have requests for the event, they are notified via an UDP packet. </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">char</span> <span class="keyword">event</span>[1000];
<span class="comment">// create event with ID 1, trigger mask 0, size 100 bytes and serial number 1</span>
<a class="code" href="group__msectionh.html#ga2cdd90a4b2def271ad89cc0d308bb970">bm_compose_event</a>((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) event, 1, 0, 100, 1);

<span class="comment">// set first byte of event</span>
*(<span class="keyword">event</span>+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)) = &lt;...&gt;
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<a class="code" href="mucap__compress_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>()
{
 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> status, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
 <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hbuf;
 <span class="keywordtype">char</span> <span class="keyword">event</span>[1000];
 status = <a class="code" href="group__msectionh.html#gae12b15703f10f41044e599520e665f5a">cm_connect_experiment</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;Sample&quot;</span>, <span class="stringliteral">&quot;Producer&quot;</span>, NULL);
 <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
 <span class="keywordflow">return</span> 1;
 <a class="code" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer</a>(<a class="code" href="group__midasincludecode.html#gab520c690db83550e545ce6afbb12de3f">EVENT_BUFFER_NAME</a>, <a class="code" href="group__midasincludecode.html#gacc4dda1aaabc9862fe79fd94e0b722bf">EVENT_BUFFER_SIZE</a>, &amp;hbuf);

 <span class="comment">// create event with ID 1, trigger mask 0, size 100 bytes and serial number 1</span>
 <a class="code" href="group__msectionh.html#ga2cdd90a4b2def271ad89cc0d308bb970">bm_compose_event</a>((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) event, 1, 0, 100, 1);

 <span class="comment">// set event data</span>
 <span class="keywordflow">for</span> (i=0 ; i&lt;100 ; i++)
 *(event+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)+i) = i;
 <span class="comment">// send event</span>
 <a class="code" href="group__msectionh.html#ga5ebc713e2f1e7f0b6d257f072221321f">bm_send_event</a>(hbuf, event, 100+<span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
 <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
 <span class="keywordflow">return</span> 0;
}
</pre></div> <dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_handle</em>&nbsp;</td><td>Buffer handle obtained via <a class="el" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer()</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>source</em>&nbsp;</td><td>Address of event buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buf_size</em>&nbsp;</td><td>Size of event including event header in bytes </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>async_flag</em>&nbsp;</td><td>Synchronous/asynchronous flag. If FALSE, the function blocks if the buffer has not enough free space to receive the event. If TRUE, the function returns immediately with a value of BM_ASYNC_RETURN without writing the event to the buffer </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE, BM_INVALID_PARAM<br/>
 BM_ASYNC_RETURN Routine called with async_flag == TRUE and buffer has not enough space to receive event<br/>
 BM_NO_MEMORY Event is too large for network buffer or event buffer. One has to increase MAX_EVENT_SIZE or EVENT_BUFFER_SIZE in <a class="el" href="generate-MODULES_8h.html#a00d5923485ea4382260221681abdb205">midas.h</a> and recompile. </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l06057">6057</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l00904">ALIGN8</a>, <a class="el" href="midas_8h_source.html#l01295">BUFFER::attached</a>, <a class="el" href="midas_8h_source.html#l00985">BM_ASYNC_RETURN</a>, <a class="el" href="midas_8c_source.html#l06412">bm_flush_cache()</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8h_source.html#l00991">BM_INVALID_PARAM</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8c_source.html#l04327">bm_match_event()</a>, <a class="el" href="midas_8h_source.html#l00979">BM_NO_MEMORY</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01288">BUFFER_HEADER::client</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="v1724__module_8c_source.html#l00027">data_size</a>, <a class="el" href="midas_8h_source.html#l01248">EVENT_REQUEST::event_id</a>, <a class="el" href="midas_8h_source.html#l01274">BUFFER_CLIENT::event_request</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="midas_8h_source.html#l00728">GET_ALL</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="midas_8h_source.html#l01246">EVENT_REQUEST::id</a>, <a class="el" href="generate-MODULES_8h_source.html#l00003">if</a>, <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00290">increment</a>, <a class="el" href="odbhist_8c_source.html#l00058">j</a>, <a class="el" href="midas_8h_source.html#l01281">BUFFER_HEADER::max_client_index</a>, <a class="el" href="midas_8h_source.html#l00677">MAX_EVENT_SIZE</a>, <a class="el" href="midas_8h_source.html#l01262">BUFFER_CLIENT::max_request_index</a>, <a class="el" href="midas_8h_source.html#l00935">MDEBUG</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="msystem_8h_source.html#l00399">MSG_BM</a>, <a class="el" href="midas_8h_source.html#l01279">BUFFER_HEADER::name</a>, <a class="el" href="midas_8h_source.html#l01285">BUFFER_HEADER::num_in_events</a>, <a class="el" href="midas_8h_source.html#l01265">BUFFER_CLIENT::num_waiting_events</a>, <a class="el" href="midas_8h_source.html#l01257">BUFFER_CLIENT::pid</a>, <a class="el" href="midas_8h_source.html#l01260">BUFFER_CLIENT::port</a>, <a class="el" href="midas_8h_source.html#l01261">BUFFER_CLIENT::read_pointer</a>, <a class="el" href="midas_8h_source.html#l01283">BUFFER_HEADER::read_pointer</a>, <a class="el" href="midas_8h_source.html#l01267">BUFFER_CLIENT::read_wait</a>, <a class="el" href="mrpc_8h_source.html#l00125">RPC_BM_SEND_EVENT</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l01250">EVENT_REQUEST::sampling_type</a>, <a class="el" href="midas_8h_source.html#l01282">BUFFER_HEADER::size</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="midas_8h_source.html#l01047">SS_ABORT</a>, <a class="el" href="system_8c_source.html#l03549">ss_resume()</a>, <a class="el" href="system_8c_source.html#l03283">ss_suspend()</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, <a class="el" href="midas_8h_source.html#l01249">EVENT_REQUEST::trigger_mask</a>, <a class="el" href="p30_8h_source.html#l00043">TRUE</a>, <a class="el" href="midas_8h_source.html#l01247">EVENT_REQUEST::valid</a>, <a class="el" href="midas_8h_source.html#l01303">BUFFER::write_cache</a>, <a class="el" href="midas_8h_source.html#l01304">BUFFER::write_cache_size</a>, <a class="el" href="midas_8h_source.html#l01306">BUFFER::write_cache_wp</a>, <a class="el" href="midas_8h_source.html#l01284">BUFFER_HEADER::write_pointer</a>, and <a class="el" href="midas_8h_source.html#l01268">BUFFER_CLIENT::write_wait</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l01233">cm_msg()</a>, <a class="el" href="midas_8c_source.html#l01346">cm_msg1()</a>, <a class="el" href="midas_8c_source.html#l17375">dm_pointer_increment()</a>, <a class="el" href="midas_8c_source.html#l16845">eb_increment_pointer()</a>, <a class="el" href="crate3_2rpc__slave_8cpp_source.html#l00049">rpc_end_of_cycle()</a>, <a class="el" href="midas_8c_source.html#l10122">rpc_send_event()</a>, <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>, <a class="el" href="midas_8c_source.html#l12223">rpc_server_receive()</a>, <a class="el" href="fal_8c_source.html#l04186">scheduler()</a>, <a class="el" href="crate6__CAEN__TDC_2mfe__mucap_8c_source.html#l01003">send_event()</a>, and <a class="el" href="ybos_8c_source.html#l00856">yb_file_fragment()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l06058"></a>06058 {
<a name="l06059"></a>06059    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l06060"></a>06060 
<a name="l06061"></a>06061    <span class="comment">/* check if event size defined in header matches buf_size */</span>
<a name="l06062"></a>06062    <span class="keywordflow">if</span> (<a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(buf_size) != (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) source)-&gt;<a class="code" href="v1724__module_8c.html#af9bcc453896ea532710141c5a10fd347">data_size</a> +
<a name="l06063"></a>06063                                       <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))) {
<a name="l06064"></a>06064       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_send_event&quot;</span>, <span class="stringliteral">&quot;event size (%d) mismatch in header (%d)&quot;</span>,
<a name="l06065"></a>06065              <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(buf_size), (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) source)-&gt;<a class="code" href="v1724__module_8c.html#af9bcc453896ea532710141c5a10fd347">data_size</a> +
<a name="l06066"></a>06066                                           <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)));
<a name="l06067"></a>06067       <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga09095b8ac6e057d3094c99e485c1a74d">BM_INVALID_PARAM</a>;
<a name="l06068"></a>06068    }
<a name="l06069"></a>06069 
<a name="l06070"></a>06070    <span class="comment">/* check for maximal event size */</span>
<a name="l06071"></a>06071    <span class="keywordflow">if</span> (((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) source)-&gt;<a class="code" href="v1724__module_8c.html#af9bcc453896ea532710141c5a10fd347">data_size</a> &gt; <a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>) {
<a name="l06072"></a>06072       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_send_event&quot;</span>,
<a name="l06073"></a>06073              <span class="stringliteral">&quot;event size (%d) larger than maximum event size (%d)&quot;</span>,
<a name="l06074"></a>06074              ((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) source)-&gt;<a class="code" href="v1724__module_8c.html#af9bcc453896ea532710141c5a10fd347">data_size</a>, <a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>);
<a name="l06075"></a>06075       <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l06076"></a>06076    }
<a name="l06077"></a>06077 
<a name="l06078"></a>06078    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l06079"></a>06079       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#ga1e44640630aa4a9a60e344cde968587b">RPC_BM_SEND_EVENT</a>, buffer_handle, source, buf_size, async_flag);
<a name="l06080"></a>06080 
<a name="l06081"></a>06081 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l06082"></a>06082 <span class="preprocessor"></span>   {
<a name="l06083"></a>06083       <a class="code" href="structBUFFER.html">BUFFER</a> *pbuf;
<a name="l06084"></a>06084       <a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a> *pheader;
<a name="l06085"></a>06085       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient, *pc;
<a name="l06086"></a>06086       <a class="code" href="structEVENT__REQUEST.html">EVENT_REQUEST</a> *prequest;
<a name="l06087"></a>06087       <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent_test;
<a name="l06088"></a>06088       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, min_wp, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, total_size, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l06089"></a>06089       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#ac017f6d6a9757a5cc0ef17db878555b7">increment</a>;
<a name="l06090"></a>06090       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> my_client_index;
<a name="l06091"></a>06091       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> old_write_pointer;
<a name="l06092"></a>06092       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> old_read_pointer, new_read_pointer;
<a name="l06093"></a>06093       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> num_requests_client;
<a name="l06094"></a>06094       <span class="keywordtype">char</span> *pdata;
<a name="l06095"></a>06095       <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> blocking;
<a name="l06096"></a>06096       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> n_blocking;
<a name="l06097"></a>06097       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> request_id;
<a name="l06098"></a>06098       <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[80];
<a name="l06099"></a>06099 
<a name="l06100"></a>06100       pbuf = &amp;<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1];
<a name="l06101"></a>06101 
<a name="l06102"></a>06102       <span class="keywordflow">if</span> (buffer_handle &gt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> || buffer_handle &lt;= 0) {
<a name="l06103"></a>06103          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_send_event&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l06104"></a>06104          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l06105"></a>06105       }
<a name="l06106"></a>06106 
<a name="l06107"></a>06107       <span class="keywordflow">if</span> (!pbuf-&gt;<a class="code" href="structBUFFER.html#a495ba8d2558dac6d40a46564c5067a2c">attached</a>) {
<a name="l06108"></a>06108          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_send_event&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l06109"></a>06109          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l06110"></a>06110       }
<a name="l06111"></a>06111 
<a name="l06112"></a>06112       pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) source;
<a name="l06113"></a>06113       total_size = buf_size;
<a name="l06114"></a>06114 
<a name="l06115"></a>06115       <span class="comment">/* round up total_size to next DWORD boundary */</span>
<a name="l06116"></a>06116       total_size = <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(total_size);
<a name="l06117"></a>06117 
<a name="l06118"></a>06118       <span class="comment">/* look if there is space in the cache */</span>
<a name="l06119"></a>06119       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga88f5da13720c678e5d2facd5a61e15be">write_cache_size</a>) {
<a name="l06120"></a>06120          status = <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l06121"></a>06121 
<a name="l06122"></a>06122          <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga88f5da13720c678e5d2facd5a61e15be">write_cache_size</a> - pbuf-&gt;<a class="code" href="group__midasincludecode.html#gac088f845fc97e9ce149b36a94644a9b4">write_cache_wp</a> &lt; total_size)
<a name="l06123"></a>06123             status = <a class="code" href="group__msectionh.html#ga0116bb8954b16dfdc5d355f7c01127ad">bm_flush_cache</a>(buffer_handle, async_flag);
<a name="l06124"></a>06124 
<a name="l06125"></a>06125          <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>)
<a name="l06126"></a>06126             <span class="keywordflow">return</span> status;
<a name="l06127"></a>06127 
<a name="l06128"></a>06128          <span class="keywordflow">if</span> (total_size &lt; pbuf-&gt;write_cache_size) {
<a name="l06129"></a>06129             memcpy(pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga99f8e53c723d75ba23267ae71309c6e7">write_cache</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#gac088f845fc97e9ce149b36a94644a9b4">write_cache_wp</a>, source, total_size);
<a name="l06130"></a>06130 
<a name="l06131"></a>06131             pbuf-&gt;<a class="code" href="group__midasincludecode.html#gac088f845fc97e9ce149b36a94644a9b4">write_cache_wp</a> += total_size;
<a name="l06132"></a>06132             <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l06133"></a>06133          }
<a name="l06134"></a>06134       }
<a name="l06135"></a>06135 
<a name="l06136"></a>06136       <span class="comment">/* calculate some shorthands */</span>
<a name="l06137"></a>06137       pheader = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>;
<a name="l06138"></a>06138       pdata = (<span class="keywordtype">char</span> *) (pheader + 1);
<a name="l06139"></a>06139       my_client_index = <a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>;
<a name="l06140"></a>06140       pclient = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a>;
<a name="l06141"></a>06141 
<a name="l06142"></a>06142       <span class="comment">/* check if buffer is large enough */</span>
<a name="l06143"></a>06143       <span class="keywordflow">if</span> (total_size &gt;= pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>) {
<a name="l06144"></a>06144          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_send_event&quot;</span>,
<a name="l06145"></a>06145                 <span class="stringliteral">&quot;total event size (%d) larger than buffer size (%d)&quot;</span>, total_size,
<a name="l06146"></a>06146                 pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>);
<a name="l06147"></a>06147          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l06148"></a>06148       }
<a name="l06149"></a>06149 
<a name="l06150"></a>06150       <span class="comment">/* lock the buffer */</span>
<a name="l06151"></a>06151       <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l06152"></a>06152 
<a name="l06153"></a>06153       <span class="comment">/* check if enough space in buffer left */</span>
<a name="l06154"></a>06154       <span class="keywordflow">do</span> {
<a name="l06155"></a>06155          size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06156"></a>06156          <span class="keywordflow">if</span> (size &lt;= 0)
<a name="l06157"></a>06157             size += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06158"></a>06158 
<a name="l06159"></a>06159          <span class="keywordflow">if</span> (size &lt;= total_size) {      <span class="comment">/* note the &apos;&lt;=&apos; to avoid 100% filling */</span>
<a name="l06160"></a>06160             <span class="comment">/* if not enough space, find out who&apos;s blocking */</span>
<a name="l06161"></a>06161             n_blocking = 0;
<a name="l06162"></a>06162 
<a name="l06163"></a>06163             <span class="keywordflow">for</span> (i = 0, pc = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pc++)
<a name="l06164"></a>06164                <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a>) {
<a name="l06165"></a>06165                   <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> == pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>) {
<a name="l06166"></a>06166                      <span class="comment">/*</span>
<a name="l06167"></a>06167 <span class="comment">                        First assume that the client with the &quot;minimum&quot; read pointer</span>
<a name="l06168"></a>06168 <span class="comment">                        is not really blocking due to a GET_ALL request.</span>
<a name="l06169"></a>06169 <span class="comment">                      */</span>
<a name="l06170"></a>06170                      blocking = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l06171"></a>06171                      request_id = -1;
<a name="l06172"></a>06172 
<a name="l06173"></a>06173                      <span class="comment">/* check if this request blocks */</span>
<a name="l06174"></a>06174 
<a name="l06175"></a>06175                      prequest = pc-&gt;<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>;
<a name="l06176"></a>06176                      pevent_test = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pdata + pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>);
<a name="l06177"></a>06177 
<a name="l06178"></a>06178                      <span class="keywordflow">for</span> (j = 0; j &lt; pc-&gt;<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a>; j++, prequest++)
<a name="l06179"></a>06179                         <span class="keywordflow">if</span> (prequest-&gt;<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a> &amp;&amp;
<a name="l06180"></a>06180                             <a class="code" href="group__bmfunctionc.html#ga181dcf462745127aa3d011a2e3fee805">bm_match_event</a>(prequest-&gt;<a class="code" href="group__midasincludecode.html#ga861d57422d21affdcfe60a67a3f8cb7f">event_id</a>, prequest-&gt;<a class="code" href="group__midasincludecode.html#ga8947eb12d18f6202ecc9d603f3bde410">trigger_mask</a>,
<a name="l06181"></a>06181                                            pevent_test)) {
<a name="l06182"></a>06182                            request_id = prequest-&gt;<a class="code" href="structEVENT__REQUEST.html#ab5275898e99714ff529f7fe125a91d0e">id</a>;
<a name="l06183"></a>06183                            <span class="keywordflow">if</span> (prequest-&gt;<a class="code" href="group__midasincludecode.html#ga98d63806bfe8b8d66fad6d3d6d9b08e4">sampling_type</a> &amp; <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>) {
<a name="l06184"></a>06184                               blocking = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l06185"></a>06185                               <span class="keywordflow">break</span>;
<a name="l06186"></a>06186                            }
<a name="l06187"></a>06187                         }
<a name="l06188"></a>06188 
<a name="l06189"></a>06189                      <span class="keywordflow">if</span> (!blocking) {
<a name="l06190"></a>06190                         <span class="comment">/*</span>
<a name="l06191"></a>06191 <span class="comment">                           The blocking guy has no GET_ALL request for this event</span>
<a name="l06192"></a>06192 <span class="comment">                           -&gt; shift its read pointer.</span>
<a name="l06193"></a>06193 <span class="comment">                         */</span>
<a name="l06194"></a>06194 
<a name="l06195"></a>06195                         old_read_pointer = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l06196"></a>06196 
<a name="l06197"></a>06197                         increment = <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) +
<a name="l06198"></a>06198                             ((<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) (pdata + pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>))-&gt;data_size;
<a name="l06199"></a>06199 
<a name="l06200"></a>06200                         <span class="comment">/* correct increment for DWORD boundary */</span>
<a name="l06201"></a>06201                         increment = <a class="code" href="group__mmacroh.html#ga46bf3ace1698ee72389c30bc61d78686">ALIGN8</a>(increment);
<a name="l06202"></a>06202 
<a name="l06203"></a>06203                         new_read_pointer = (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> + increment) % pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06204"></a>06204 
<a name="l06205"></a>06205                         <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (new_read_pointer &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l06206"></a>06206                            new_read_pointer = 0;
<a name="l06207"></a>06207 
<a name="l06208"></a>06208                         pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> = new_read_pointer;
<a name="l06209"></a>06209                      } <span class="keywordflow">else</span> {
<a name="l06210"></a>06210                         n_blocking++;
<a name="l06211"></a>06211                      }
<a name="l06212"></a>06212 
<a name="l06213"></a>06213                      <span class="comment">/* wake that client if it has a request */</span>
<a name="l06214"></a>06214                      <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#ga896acd334d608006626fcca2a872a4a4">read_wait</a> &amp;&amp; request_id != -1) {
<a name="l06215"></a>06215 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06216"></a>06216 <span class="preprocessor"></span>                        <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Send wake: rp=%d, wp=%d&quot;</span>,
<a name="l06217"></a>06217                                pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>, pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06218"></a>06218 <span class="preprocessor">#endif</span>
<a name="l06219"></a>06219 <span class="preprocessor"></span>                        sprintf(str, <span class="stringliteral">&quot;B %s %d&quot;</span>, pheader-&gt;<a class="code" href="structBUFFER__HEADER.html#a40ea1b56ee55965c4d61e6da5ae57022">name</a>, request_id);
<a name="l06220"></a>06220                         <a class="code" href="group__msystemincludecode.html#ga2f07c99535bcb2959efc54c5cdbf6747">ss_resume</a>(pc-&gt;<a class="code" href="group__midasincludecode.html#gad8112ed9dd177230ff2a9acfd84c5429">port</a>, str);
<a name="l06221"></a>06221                      }
<a name="l06222"></a>06222 
<a name="l06223"></a>06223 
<a name="l06224"></a>06224                   }             <span class="comment">/* read_pointer blocks */</span>
<a name="l06225"></a>06225                }
<a name="l06226"></a>06226             <span class="comment">/* client loop */</span>
<a name="l06227"></a>06227             <span class="keywordflow">if</span> (n_blocking &gt; 0) {
<a name="l06228"></a>06228                <span class="comment">/* at least one client is blocking */</span>
<a name="l06229"></a>06229 
<a name="l06230"></a>06230                <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l06231"></a>06231 
<a name="l06232"></a>06232                <span class="comment">/* return now in ASYNC mode */</span>
<a name="l06233"></a>06233                <span class="keywordflow">if</span> (async_flag)
<a name="l06234"></a>06234                   <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga7fb11aaff606b1785cddd205baddbbff">BM_ASYNC_RETURN</a>;
<a name="l06235"></a>06235 
<a name="l06236"></a>06236 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06237"></a>06237 <span class="preprocessor"></span>               <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Send sleep: rp=%d, wp=%d, level=%1.1lf&quot;</span>,
<a name="l06238"></a>06238                       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l06239"></a>06239                       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, 100 - 100.0 * size / pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>);
<a name="l06240"></a>06240 <span class="preprocessor">#endif</span>
<a name="l06241"></a>06241 <span class="preprocessor"></span>
<a name="l06242"></a>06242                <span class="comment">/* has the read pointer moved in between ? */</span>
<a name="l06243"></a>06243                size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06244"></a>06244                <span class="keywordflow">if</span> (size &lt;= 0)
<a name="l06245"></a>06245                   size += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06246"></a>06246 
<a name="l06247"></a>06247                <span class="comment">/* suspend process */</span>
<a name="l06248"></a>06248                <span class="keywordflow">if</span> (size &lt;= total_size) {
<a name="l06249"></a>06249                   <span class="comment">/* signal other clients wait mode */</span>
<a name="l06250"></a>06250                   pclient[my_client_index].<a class="code" href="group__midasincludecode.html#ga884b0a6395661ef9f711fa3ca7bc19b6">write_wait</a> = total_size;
<a name="l06251"></a>06251 
<a name="l06252"></a>06252                   status = <a class="code" href="group__msystemincludecode.html#ga057bcc23c79e804679785d98b1223bd1">ss_suspend</a>(1000, <a class="code" href="group__msystemincludecode.html#ga6e9a9a9996cea71191a21fd2009efcd1">MSG_BM</a>);
<a name="l06253"></a>06253 
<a name="l06254"></a>06254                   pclient[my_client_index].<a class="code" href="group__midasincludecode.html#ga884b0a6395661ef9f711fa3ca7bc19b6">write_wait</a> = 0;
<a name="l06255"></a>06255 
<a name="l06256"></a>06256                   <span class="comment">/* return if TCP connection broken */</span>
<a name="l06257"></a>06257                   <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>)
<a name="l06258"></a>06258                      <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>;
<a name="l06259"></a>06259                }
<a name="l06260"></a>06260 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06261"></a>06261 <span class="preprocessor"></span>               <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Send woke up: rp=%d, wp=%d, level=%1.1lf&quot;</span>,
<a name="l06262"></a>06262                       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l06263"></a>06263                       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, 100 - 100.0 * size / pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>);
<a name="l06264"></a>06264 <span class="preprocessor">#endif</span>
<a name="l06265"></a>06265 <span class="preprocessor"></span>
<a name="l06266"></a>06266                <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l06267"></a>06267 
<a name="l06268"></a>06268                <span class="comment">/* has the write pointer moved in between ? */</span>
<a name="l06269"></a>06269                size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06270"></a>06270                <span class="keywordflow">if</span> (size &lt;= 0)
<a name="l06271"></a>06271                   size += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06272"></a>06272             } <span class="keywordflow">else</span> {
<a name="l06273"></a>06273                <span class="comment">/*</span>
<a name="l06274"></a>06274 <span class="comment">                  calculate new global read pointer as &quot;minimum&quot; of</span>
<a name="l06275"></a>06275 <span class="comment">                  client read pointers</span>
<a name="l06276"></a>06276 <span class="comment">                */</span>
<a name="l06277"></a>06277                min_wp = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06278"></a>06278 
<a name="l06279"></a>06279                <span class="keywordflow">for</span> (i = 0, pc = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pc++)
<a name="l06280"></a>06280                   <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a>) {
<a name="l06281"></a>06281                      <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &lt; min_wp)
<a name="l06282"></a>06282                         min_wp = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l06283"></a>06283 
<a name="l06284"></a>06284                      <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> &amp;&amp;
<a name="l06285"></a>06285                          pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> &lt; min_wp)
<a name="l06286"></a>06286                         min_wp = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06287"></a>06287                   }
<a name="l06288"></a>06288 
<a name="l06289"></a>06289                <span class="keywordflow">if</span> (min_wp &lt; 0)
<a name="l06290"></a>06290                   min_wp += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06291"></a>06291 
<a name="l06292"></a>06292                pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> = min_wp;
<a name="l06293"></a>06293             }
<a name="l06294"></a>06294 
<a name="l06295"></a>06295          }
<a name="l06296"></a>06296          <span class="comment">/* if (size &lt;= total_size) */</span>
<a name="l06297"></a>06297       } <span class="keywordflow">while</span> (size &lt;= total_size);
<a name="l06298"></a>06298 
<a name="l06299"></a>06299       <span class="comment">/* we have space, so let&apos;s copy the event */</span>
<a name="l06300"></a>06300       old_write_pointer = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06301"></a>06301 
<a name="l06302"></a>06302       <span class="keywordflow">if</span> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> + total_size &lt;= pheader-&gt;size) {
<a name="l06303"></a>06303          memcpy(pdata + pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, pevent, total_size);
<a name="l06304"></a>06304          pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> = (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> + total_size) % pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06305"></a>06305          <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l06306"></a>06306             pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> = 0;
<a name="l06307"></a>06307       } <span class="keywordflow">else</span> {
<a name="l06308"></a>06308          <span class="comment">/* split event */</span>
<a name="l06309"></a>06309          size = pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06310"></a>06310 
<a name="l06311"></a>06311          memcpy(pdata + pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, pevent, size);
<a name="l06312"></a>06312          memcpy(pdata, (<span class="keywordtype">char</span> *) pevent + size, total_size - size);
<a name="l06313"></a>06313 
<a name="l06314"></a>06314          pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> = total_size - size;
<a name="l06315"></a>06315       }
<a name="l06316"></a>06316 
<a name="l06317"></a>06317       <span class="comment">/* check which clients have a request for this event */</span>
<a name="l06318"></a>06318       <span class="keywordflow">for</span> (i = 0; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++)
<a name="l06319"></a>06319          <span class="keywordflow">if</span> (pclient[i].pid) {
<a name="l06320"></a>06320             prequest = pclient[i].<a class="code" href="group__midasincludecode.html#gabc037ad8bce6896253754e3cbf8730b0">event_request</a>;
<a name="l06321"></a>06321             num_requests_client = 0;
<a name="l06322"></a>06322             request_id = -1;
<a name="l06323"></a>06323 
<a name="l06324"></a>06324             <span class="keywordflow">for</span> (j = 0; j &lt; pclient[i].<a class="code" href="group__midasincludecode.html#gac7c61ec3f675c1a196751ec73baabb43">max_request_index</a>; j++, prequest++)
<a name="l06325"></a>06325                <span class="keywordflow">if</span> (prequest-&gt;<a class="code" href="group__midasincludecode.html#gaeac92027d8c58b1af391b5d76655f9bf">valid</a> &amp;&amp;
<a name="l06326"></a>06326                    <a class="code" href="group__bmfunctionc.html#ga181dcf462745127aa3d011a2e3fee805">bm_match_event</a>(prequest-&gt;<a class="code" href="group__midasincludecode.html#ga861d57422d21affdcfe60a67a3f8cb7f">event_id</a>, prequest-&gt;<a class="code" href="group__midasincludecode.html#ga8947eb12d18f6202ecc9d603f3bde410">trigger_mask</a>, pevent)) {
<a name="l06327"></a>06327                   <span class="keywordflow">if</span> (prequest-&gt;<a class="code" href="group__midasincludecode.html#ga98d63806bfe8b8d66fad6d3d6d9b08e4">sampling_type</a> &amp; <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>)
<a name="l06328"></a>06328                      pclient[i].<a class="code" href="group__midasincludecode.html#gae4c382bab7844d80089d2e6e0f1a83ce">num_waiting_events</a>++;
<a name="l06329"></a>06329 
<a name="l06330"></a>06330                   num_requests_client++;
<a name="l06331"></a>06331                   request_id = prequest-&gt;<a class="code" href="structEVENT__REQUEST.html#ab5275898e99714ff529f7fe125a91d0e">id</a>;
<a name="l06332"></a>06332                }
<a name="l06333"></a>06333 
<a name="l06334"></a>06334             <span class="comment">/* if that client has a request and is suspended, wake it up */</span>
<a name="l06335"></a>06335             <span class="keywordflow">if</span> (num_requests_client &amp;&amp; pclient[i].read_wait) {
<a name="l06336"></a>06336 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06337"></a>06337 <span class="preprocessor"></span>               <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;Send wake: rp=%d, wp=%d&quot;</span>, pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>,
<a name="l06338"></a>06338                       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06339"></a>06339 <span class="preprocessor">#endif</span>
<a name="l06340"></a>06340 <span class="preprocessor"></span>               sprintf(str, <span class="stringliteral">&quot;B %s %d&quot;</span>, pheader-&gt;<a class="code" href="structBUFFER__HEADER.html#a40ea1b56ee55965c4d61e6da5ae57022">name</a>, request_id);
<a name="l06341"></a>06341                <a class="code" href="group__msystemincludecode.html#ga2f07c99535bcb2959efc54c5cdbf6747">ss_resume</a>(pclient[i].port, str);
<a name="l06342"></a>06342             }
<a name="l06343"></a>06343 
<a name="l06344"></a>06344             <span class="comment">/* if that client has no request, shift its read pointer */</span>
<a name="l06345"></a>06345             <span class="keywordflow">if</span> (num_requests_client == 0 &amp;&amp; pclient[i].read_pointer == old_write_pointer)
<a name="l06346"></a>06346                pclient[i].<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06347"></a>06347          }
<a name="l06348"></a>06348 
<a name="l06349"></a>06349       <span class="comment">/* shift read pointer of own client */</span>
<a name="l06350"></a>06350 <span class="comment">/* 16.4.99 SR, outcommented to receive own messages</span>
<a name="l06351"></a>06351 <span class="comment"></span>
<a name="l06352"></a>06352 <span class="comment">  if (pclient[my_client_index].read_pointer == old_write_pointer)</span>
<a name="l06353"></a>06353 <span class="comment">    pclient[my_client_index].read_pointer = pheader-&gt;write_pointer;</span>
<a name="l06354"></a>06354 <span class="comment">*/</span>
<a name="l06355"></a>06355 
<a name="l06356"></a>06356       <span class="comment">/* calculate global read pointer as &quot;minimum&quot; of client read pointers */</span>
<a name="l06357"></a>06357       min_wp = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l06358"></a>06358 
<a name="l06359"></a>06359       <span class="keywordflow">for</span> (i = 0, pc = pclient; i &lt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga5af9f52955602868b5b9161580fa810d">max_client_index</a>; i++, pc++)
<a name="l06360"></a>06360          <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#ga44911884d209e2a4f90fb02033d8cb94">pid</a>) {
<a name="l06361"></a>06361             <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &lt; min_wp)
<a name="l06362"></a>06362                min_wp = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a>;
<a name="l06363"></a>06363 
<a name="l06364"></a>06364             <span class="keywordflow">if</span> (pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> &gt; pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a> &amp;&amp;
<a name="l06365"></a>06365                 pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a> &lt; min_wp)
<a name="l06366"></a>06366                min_wp = pc-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> - pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06367"></a>06367          }
<a name="l06368"></a>06368 
<a name="l06369"></a>06369       <span class="keywordflow">if</span> (min_wp &lt; 0)
<a name="l06370"></a>06370          min_wp += pheader-&gt;<a class="code" href="group__midasincludecode.html#gadedca43a59b3dd2c5cf10cff01dc46a3">size</a>;
<a name="l06371"></a>06371 
<a name="l06372"></a>06372 <span class="preprocessor">#ifdef DEBUG_MSG</span>
<a name="l06373"></a>06373 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (min_wp == pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>)
<a name="l06374"></a>06374          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_send_event -&gt; wp=%d&quot;</span>, pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>);
<a name="l06375"></a>06375       <span class="keywordflow">else</span>
<a name="l06376"></a>06376          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad769dc7be0dc5189e019d56664a18655">MDEBUG</a>, <span class="stringliteral">&quot;bm_send_event -&gt; wp=%d, rp %d -&gt; %d, size=%d&quot;</span>,
<a name="l06377"></a>06377                 pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>, pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a>, min_wp, size);
<a name="l06378"></a>06378 <span class="preprocessor">#endif</span>
<a name="l06379"></a>06379 <span class="preprocessor"></span>
<a name="l06380"></a>06380       pheader-&gt;<a class="code" href="group__midasincludecode.html#gadd4be4a3e858fc79d67f2625c1771874">read_pointer</a> = min_wp;
<a name="l06381"></a>06381 
<a name="l06382"></a>06382       <span class="comment">/* update statistics */</span>
<a name="l06383"></a>06383       pheader-&gt;<a class="code" href="group__midasincludecode.html#ga1cb3b9436d59dba0946de51581e68fbd">num_in_events</a>++;
<a name="l06384"></a>06384 
<a name="l06385"></a>06385       <span class="comment">/* unlock the buffer */</span>
<a name="l06386"></a>06386       <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l06387"></a>06387    }
<a name="l06388"></a>06388 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l06389"></a>06389 
<a name="l06390"></a>06390    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l06391"></a>06391 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga2689ca85c6d0023f1a02e6827a5eff6e"></a><!-- doxytag: member="midas.c::bm_set_cache_size" ref="ga2689ca85c6d0023f1a02e6827a5eff6e" args="(INT buffer_handle, INT read_size, INT write_size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_set_cache_size </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>read_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>write_size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Modifies buffer cache size. Without a buffer cache, events are copied to/from the shared memory event by event.</p>
<p>To protect processed from accessing the shared memory simultaneously, semaphores are used. Since semaphore operations are CPU consuming (typically 50-100us) this can slow down the data transfer especially for small events. By using a cache the number of semaphore operations is reduced dramatically. Instead writing directly to the shared memory, the events are copied to a local cache buffer. When this buffer is full, it is copied to the shared memory in one operation. The same technique can be used when receiving events.</p>
<p>The drawback of this method is that the events have to be copied twice, once to the cache and once from the cache to the shared memory. Therefore it can happen that the usage of a cache even slows down data throughput on a given environment (computer type, OS type, event size). The cache size has therefore be optimized manually to maximize data throughput. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_handle</em>&nbsp;</td><td>buffer handle obtained via <a class="el" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer()</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>read_size</em>&nbsp;</td><td>cache size for reading events in bytes, zero for no cache </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>write_size</em>&nbsp;</td><td>cache size for writing events in bytes, zero for no cache </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE, BM_NO_MEMORY, BM_INVALID_PARAM </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l05589">5589</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8h_source.html#l00991">BM_INVALID_PARAM</a>, <a class="el" href="midas_8h_source.html#l00979">BM_NO_MEMORY</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="midas_8h_source.html#l01755">M_FREE</a>, <a class="el" href="midas_8h_source.html#l01753">M_MALLOC</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="midas_8h_source.html#l01299">BUFFER::read_cache</a>, <a class="el" href="midas_8h_source.html#l01301">BUFFER::read_cache_rp</a>, <a class="el" href="midas_8h_source.html#l01300">BUFFER::read_cache_size</a>, <a class="el" href="midas_8h_source.html#l01302">BUFFER::read_cache_wp</a>, <a class="el" href="mrpc_8h_source.html#l00122">RPC_BM_SET_CACHE_SIZE</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="midas_8h_source.html#l01303">BUFFER::write_cache</a>, <a class="el" href="midas_8h_source.html#l01305">BUFFER::write_cache_rp</a>, <a class="el" href="midas_8h_source.html#l01304">BUFFER::write_cache_size</a>, and <a class="el" href="midas_8h_source.html#l01306">BUFFER::write_cache_wp</a>.</p>

<p>Referenced by <a class="el" href="old__mevb_8cpp_source.html#l00658">main()</a>, <a class="el" href="crate6__CAEN__TDC_2mfe__mucap_8c_source.html#l00554">register_equipment()</a>, <a class="el" href="mana_8cpp_source.html#l03861">register_requests()</a>, <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>, <a class="el" href="mlogger_8c_source.html#l03140">tr_start()</a>, and <a class="el" href="fal_8c_source.html#l02085">tr_start1()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l05591"></a>05591 {
<a name="l05592"></a>05592    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l05593"></a>05593       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#ga7467f8651a147cf7a9551892496b958e">RPC_BM_SET_CACHE_SIZE</a>, buffer_handle, read_size, write_size);
<a name="l05594"></a>05594 
<a name="l05595"></a>05595 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l05596"></a>05596 <span class="preprocessor"></span>   {
<a name="l05597"></a>05597       <a class="code" href="structBUFFER.html">BUFFER</a> *pbuf;
<a name="l05598"></a>05598 
<a name="l05599"></a>05599       <span class="keywordflow">if</span> (buffer_handle &gt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> || buffer_handle &lt;= 0) {
<a name="l05600"></a>05600          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_set_cache_size&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l05601"></a>05601          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l05602"></a>05602       }
<a name="l05603"></a>05603 
<a name="l05604"></a>05604       <span class="keywordflow">if</span> (!<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1].attached) {
<a name="l05605"></a>05605          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_set_cache_size&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l05606"></a>05606          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l05607"></a>05607       }
<a name="l05608"></a>05608 
<a name="l05609"></a>05609       <span class="keywordflow">if</span> (read_size &lt; 0 || read_size &gt; 1E6) {
<a name="l05610"></a>05610          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_set_cache_size&quot;</span>, <span class="stringliteral">&quot;invalid read chache size&quot;</span>);
<a name="l05611"></a>05611          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga09095b8ac6e057d3094c99e485c1a74d">BM_INVALID_PARAM</a>;
<a name="l05612"></a>05612       }
<a name="l05613"></a>05613 
<a name="l05614"></a>05614       <span class="keywordflow">if</span> (write_size &lt; 0 || write_size &gt; 1E6) {
<a name="l05615"></a>05615          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_set_cache_size&quot;</span>, <span class="stringliteral">&quot;invalid write chache size&quot;</span>);
<a name="l05616"></a>05616          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga09095b8ac6e057d3094c99e485c1a74d">BM_INVALID_PARAM</a>;
<a name="l05617"></a>05617       }
<a name="l05618"></a>05618 
<a name="l05619"></a>05619       <span class="comment">/* manage read cache */</span>
<a name="l05620"></a>05620       pbuf = &amp;<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1];
<a name="l05621"></a>05621 
<a name="l05622"></a>05622       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> &gt; 0)
<a name="l05623"></a>05623          <a class="code" href="group__msectionh.html#ga95c0d83820c28cf52ea13271b034fcb2">M_FREE</a>(pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a>);
<a name="l05624"></a>05624 
<a name="l05625"></a>05625       <span class="keywordflow">if</span> (read_size &gt; 0) {
<a name="l05626"></a>05626          pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> = (<span class="keywordtype">char</span> *) <a class="code" href="group__msectionh.html#ga130728d73c8c9b46e0b9bd2e34557c3d">M_MALLOC</a>(read_size);
<a name="l05627"></a>05627          <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga5d4cfe9131aaa09843127a5b134215c5">read_cache</a> == NULL) {
<a name="l05628"></a>05628             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_set_cache_size&quot;</span>,
<a name="l05629"></a>05629                    <span class="stringliteral">&quot;not enough memory to allocate cache buffer&quot;</span>);
<a name="l05630"></a>05630             <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l05631"></a>05631          }
<a name="l05632"></a>05632       }
<a name="l05633"></a>05633 
<a name="l05634"></a>05634       pbuf-&gt;<a class="code" href="group__midasincludecode.html#gaacd1ded35cffe15d8607b92875036bf5">read_cache_size</a> = read_size;
<a name="l05635"></a>05635       pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a> = pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> = 0;
<a name="l05636"></a>05636 
<a name="l05637"></a>05637       <span class="comment">/* manage write cache */</span>
<a name="l05638"></a>05638       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga88f5da13720c678e5d2facd5a61e15be">write_cache_size</a> &gt; 0)
<a name="l05639"></a>05639          <a class="code" href="group__msectionh.html#ga95c0d83820c28cf52ea13271b034fcb2">M_FREE</a>(pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga99f8e53c723d75ba23267ae71309c6e7">write_cache</a>);
<a name="l05640"></a>05640 
<a name="l05641"></a>05641       <span class="keywordflow">if</span> (write_size &gt; 0) {
<a name="l05642"></a>05642          pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga99f8e53c723d75ba23267ae71309c6e7">write_cache</a> = (<span class="keywordtype">char</span> *) <a class="code" href="group__msectionh.html#ga130728d73c8c9b46e0b9bd2e34557c3d">M_MALLOC</a>(write_size);
<a name="l05643"></a>05643          <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga99f8e53c723d75ba23267ae71309c6e7">write_cache</a> == NULL) {
<a name="l05644"></a>05644             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_set_cache_size&quot;</span>,
<a name="l05645"></a>05645                    <span class="stringliteral">&quot;not enough memory to allocate cache buffer&quot;</span>);
<a name="l05646"></a>05646             <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga5425d2a3621de60926128a3cbaa501cc">BM_NO_MEMORY</a>;
<a name="l05647"></a>05647          }
<a name="l05648"></a>05648       }
<a name="l05649"></a>05649 
<a name="l05650"></a>05650       pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga88f5da13720c678e5d2facd5a61e15be">write_cache_size</a> = write_size;
<a name="l05651"></a>05651       pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga70b3193c3c9315051f94e478bba3ae58">write_cache_rp</a> = pbuf-&gt;<a class="code" href="group__midasincludecode.html#gac088f845fc97e9ce149b36a94644a9b4">write_cache_wp</a> = 0;
<a name="l05652"></a>05652 
<a name="l05653"></a>05653    }
<a name="l05654"></a>05654 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l05655"></a>05655 
<a name="l05656"></a>05656    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l05657"></a>05657 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga4a12567d843b2e1d20da58d8abfabb04"></a><!-- doxytag: member="midas.c::bm_skip_event" ref="ga4a12567d843b2e1d20da58d8abfabb04" args="(INT buffer_handle)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> bm_skip_event </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_handle</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Skip all events in current buffer.</p>
<p>Useful for single event displays to see the newest events </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buffer_handle</em>&nbsp;</td><td>Handle of the buffer. Must be obtained via bm_open_buffer. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>BM_SUCCESS, BM_INVALID_HANDLE, RPC_NET_ERROR </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l07109">7109</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l00810">_buffer_entries</a>, <a class="el" href="midas_8h_source.html#l01295">BUFFER::attached</a>, <a class="el" href="midas_8h_source.html#l00981">BM_INVALID_HANDLE</a>, <a class="el" href="midas_8c_source.html#l05451">bm_lock_buffer()</a>, <a class="el" href="midas_8h_source.html#l00977">BM_SUCCESS</a>, <a class="el" href="midas_8c_source.html#l05479">bm_unlock_buffer()</a>, <a class="el" href="midas_8h_source.html#l01297">BUFFER::buffer_header</a>, <a class="el" href="midas_8h_source.html#l01288">BUFFER_HEADER::client</a>, <a class="el" href="midas_8h_source.html#l01296">BUFFER::client_index</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="midas_8h_source.html#l01301">BUFFER::read_cache_rp</a>, <a class="el" href="midas_8h_source.html#l01302">BUFFER::read_cache_wp</a>, <a class="el" href="midas_8h_source.html#l01261">BUFFER_CLIENT::read_pointer</a>, <a class="el" href="mrpc_8h_source.html#l00130">RPC_BM_SKIP_EVENT</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, and <a class="el" href="midas_8h_source.html#l01284">BUFFER_HEADER::write_pointer</a>.</p>

<p>Referenced by <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l07110"></a>07110 {
<a name="l07111"></a>07111    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l07112"></a>07112       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#gada948fec43038394de1d672926fa354e">RPC_BM_SKIP_EVENT</a>, buffer_handle);
<a name="l07113"></a>07113 
<a name="l07114"></a>07114 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l07115"></a>07115 <span class="preprocessor"></span>   {
<a name="l07116"></a>07116       <a class="code" href="structBUFFER.html">BUFFER</a> *pbuf;
<a name="l07117"></a>07117       <a class="code" href="structBUFFER__HEADER.html">BUFFER_HEADER</a> *pheader;
<a name="l07118"></a>07118       <a class="code" href="structBUFFER__CLIENT.html">BUFFER_CLIENT</a> *pclient;
<a name="l07119"></a>07119 
<a name="l07120"></a>07120       <span class="keywordflow">if</span> (buffer_handle &gt; <a class="code" href="group__midasincludecode.html#ga623cf48efd717f90346398e011f518b3">_buffer_entries</a> || buffer_handle &lt;= 0) {
<a name="l07121"></a>07121          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_skip_event&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l07122"></a>07122          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l07123"></a>07123       }
<a name="l07124"></a>07124 
<a name="l07125"></a>07125       pbuf = &amp;<a class="code" href="group__midasincludecode.html#gad8d83805ced2b5aba402f05de75ec9f8">_buffer</a>[buffer_handle - 1];
<a name="l07126"></a>07126       pheader = pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga9df49f2ae2aae272c18d34e4cc5a5e94">buffer_header</a>;
<a name="l07127"></a>07127 
<a name="l07128"></a>07128       <span class="keywordflow">if</span> (!pbuf-&gt;<a class="code" href="structBUFFER.html#a495ba8d2558dac6d40a46564c5067a2c">attached</a>) {
<a name="l07129"></a>07129          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bm_skip_event&quot;</span>, <span class="stringliteral">&quot;invalid buffer handle %d&quot;</span>, buffer_handle);
<a name="l07130"></a>07130          <span class="keywordflow">return</span> <a class="code" href="group__err22.html#ga992d6577e774ebe1c50b501917c788b8">BM_INVALID_HANDLE</a>;
<a name="l07131"></a>07131       }
<a name="l07132"></a>07132 
<a name="l07133"></a>07133       <span class="comment">/* clear cache */</span>
<a name="l07134"></a>07134       <span class="keywordflow">if</span> (pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> &gt; pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a>)
<a name="l07135"></a>07135          pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga1c3ec0bf54a65a805455b0cb522d8fea">read_cache_rp</a> = pbuf-&gt;<a class="code" href="group__midasincludecode.html#gab83ba3496676cf0cafe65c78bcb9a049">read_cache_wp</a> = 0;
<a name="l07136"></a>07136 
<a name="l07137"></a>07137       <a class="code" href="group__msystemincludecode.html#ga962738954f06bf0cfc8f9c380cfdec6a">bm_lock_buffer</a>(buffer_handle);
<a name="l07138"></a>07138 
<a name="l07139"></a>07139       <span class="comment">/* forward read pointer to global write pointer */</span>
<a name="l07140"></a>07140       pclient = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga7bf4fa88ab9e4791b3357210c0422946">client</a> + pbuf-&gt;<a class="code" href="group__midasincludecode.html#ga4deee805992cb9841283440fb95d8a81">client_index</a>;
<a name="l07141"></a>07141       pclient-&gt;<a class="code" href="group__midasincludecode.html#gae0c5c3a62b9dac568d8f45cf4bc951ab">read_pointer</a> = pheader-&gt;<a class="code" href="group__midasincludecode.html#ga3431c98c823dc22dc046a947bd9675eb">write_pointer</a>;
<a name="l07142"></a>07142 
<a name="l07143"></a>07143       <a class="code" href="group__msystemincludecode.html#ga47a86656470ff0d320ba2e6f1b9ebcf3">bm_unlock_buffer</a>(buffer_handle);
<a name="l07144"></a>07144    }
<a name="l07145"></a>07145 <span class="preprocessor">#endif</span>
<a name="l07146"></a>07146 <span class="preprocessor"></span>
<a name="l07147"></a>07147    <span class="keywordflow">return</span> <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>;
<a name="l07148"></a>07148 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ga90d254b36c635428b106ded0d3e40b26"></a><!-- doxytag: member="midas.c::defrag_buffer" ref="ga90d254b36c635428b106ded0d3e40b26" args="[MAX_DEFRAG_EVENTS]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structEVENT__DEFRAG__BUFFER.html">EVENT_DEFRAG_BUFFER</a> <a class="el" href="group__bmfunctionc.html#ga90d254b36c635428b106ded0d3e40b26">defrag_buffer</a>[MAX_DEFRAG_EVENTS]</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="midas_8c_source.html#l07807">7807</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ:Rootana by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
