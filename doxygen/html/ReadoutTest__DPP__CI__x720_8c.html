<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ:Rootana: CAEN/CAENDigitizer/CAENDigitizer_2.3.2/samples/ReadoutTest_DPP_CI_x720/src/ReadoutTest_DPP_CI_x720.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>CAEN/CAENDigitizer/CAENDigitizer_2.3.2/samples/ReadoutTest_DPP_CI_x720/src/ReadoutTest_DPP_CI_x720.c File Reference</h1><code>#include &lt;<a class="el" href="CAENDigitizer_8h_source.html">CAENDigitizer.h</a>&gt;</code><br/>
<code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="ReadoutTest__DPP__PSD__x720_2include_2Functions_8h_source.html">Functions.h</a>&quot;</code><br/>

<p><a href="ReadoutTest__DPP__CI__x720_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ReadoutTest__DPP__CI__x720_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>&nbsp;&nbsp;&nbsp;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>&nbsp;&nbsp;&nbsp;8</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ReadoutTest__DPP__CI__x720_8c.html#a7022144c375137548041460a9ef83eef">MAXNBITS</a>&nbsp;&nbsp;&nbsp;12</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ReadoutTest__DPP__CI__x720_8c.html#ac4228f122e2acf3adc5803127f8ec103">ProgramDigitizer</a> (int <a class="el" href="ybos_8c.html#a7c83c22c8ffdd143cddcda9b23e26c4a">handle</a>, <a class="el" href="structDigitizerParams__t.html">DigitizerParams_t</a> Params, <a class="el" href="structCAEN__DGTZ__DPP__CI__Params__t.html">CAEN_DGTZ_DPP_CI_Params_t</a> DPPParams)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ReadoutTest__DPP__CI__x720_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a> (int argc, char *argv[])</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a613f91735f2c206ce6bd8aa4d33dde5c"></a><!-- doxytag: member="ReadoutTest_DPP_CI_x720.c::MAXNB" ref="a613f91735f2c206ce6bd8aa4d33dde5c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAXNB&nbsp;&nbsp;&nbsp;1</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl class="note"><dt><b>Note:</b></dt><dd>TERMS OF USE: This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. The user relies on the software, documentation and results solely at his own risk. </dd></dl>

<p>Definition at line <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00024">24</a> of file <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html">ReadoutTest_DPP_CI_x720.c</a>.</p>

</div>
</div>
<a class="anchor" id="a7022144c375137548041460a9ef83eef"></a><!-- doxytag: member="ReadoutTest_DPP_CI_x720.c::MAXNBITS" ref="a7022144c375137548041460a9ef83eef" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAXNBITS&nbsp;&nbsp;&nbsp;12</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00029">29</a> of file <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html">ReadoutTest_DPP_CI_x720.c</a>.</p>

<p>Referenced by <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00162">main()</a>.</p>

</div>
</div>
<a class="anchor" id="a1befa53f10d42ae3c5cff58080f6c253"></a><!-- doxytag: member="ReadoutTest_DPP_CI_x720.c::MaxNChannels" ref="a1befa53f10d42ae3c5cff58080f6c253" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MaxNChannels&nbsp;&nbsp;&nbsp;8</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00027">27</a> of file <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html">ReadoutTest_DPP_CI_x720.c</a>.</p>

<p>Referenced by <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00162">main()</a>, and <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00044">ProgramDigitizer()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a0ddf1224851353fc92bfbff6f499fa97"></a><!-- doxytag: member="ReadoutTest_DPP_CI_x720.c::main" ref="a0ddf1224851353fc92bfbff6f499fa97" args="(int argc, char *argv[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>argv</em>[]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00162">162</a> of file <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html">ReadoutTest_DPP_CI_x720.c</a>.</p>

<p>References <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00046">DigitizerParams_t::AcqMode</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00747">CAEN_DGTZ_BoardInfo_t::AMC_FirmwareRel</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01006">CAEN_DGTZ_DPP_CI_Params_t::blthr</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01007">CAEN_DGTZ_DPP_CI_Params_t::bltmo</a>, <a class="el" href="fal_8c_source.html#l00201">buffer</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00003">c</a>, <a class="el" href="CAENDigitizer_8h.html#a7fae2e27649e39cf87e5410c2c981db4">CAEN_DGTZ_ClearData()</a>, <a class="el" href="CAENDigitizer_8h.html#a745c6e08895e1f1575af80c682973f4e">CAEN_DGTZ_CloseDigitizer()</a>, <a class="el" href="CAENDigitizer_8h.html#a3151c0773642366fe40d936f7a2a5686">CAEN_DGTZ_DecodeDPPWaveforms()</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00426">CAEN_DGTZ_DPP_ACQ_MODE_List</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00427">CAEN_DGTZ_DPP_ACQ_MODE_Mixed</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00907">CAEN_DGTZ_DPP_CI_Waveforms_t</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00939">CAEN_DGTZ_DPP_TriggerConfig_Peak</a>, <a class="el" href="CAENDigitizer_8h.html#a21eba768d657b13624095f8b4b726462">CAEN_DGTZ_FreeDPPEvents()</a>, <a class="el" href="CAENDigitizer_8h.html#aef66a43005317231d5472f9914ae0681">CAEN_DGTZ_FreeDPPWaveforms()</a>, <a class="el" href="CAENDigitizer_8h.html#a8661c8e8ea763a61b3a6245df65e6cfc">CAEN_DGTZ_FreeReadoutBuffer()</a>, <a class="el" href="CAENDigitizer_8h.html#a14bd21a25a1cb3f798fe364c3dde3992">CAEN_DGTZ_GetDPPEvents()</a>, <a class="el" href="CAENDigitizer_8h.html#acf2160247da2992bc2ab58bb85d254cf">CAEN_DGTZ_GetInfo()</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00702">CAEN_DGTZ_IOLevel_TTL</a>, <a class="el" href="CAENDigitizer_8h.html#a161de18f304930413154fc6f69f9f12b">CAEN_DGTZ_MallocDPPEvents()</a>, <a class="el" href="CAENDigitizer_8h.html#a6a4493fb20699c0799f5adf11b830eff">CAEN_DGTZ_MallocDPPWaveforms()</a>, <a class="el" href="CAENDigitizer_8h.html#a1cd5200db46572508acf091ea935e4b7">CAEN_DGTZ_MallocReadoutBuffer()</a>, <a class="el" href="CAENDigitizer_8h.html#a4df566fc25d076154f569c51969d79fa">CAEN_DGTZ_OpenDigitizer()</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00737">CAEN_DGTZ_PulsePolarityNegative</a>, <a class="el" href="CAENDigitizer_8h.html#a87659689821b310020b347fcd749c343">CAEN_DGTZ_ReadData()</a>, <a class="el" href="CAENDigitizer_8h.html#a0518b6c1761a39f42f25368ad4962864">CAEN_DGTZ_SendSWtrigger()</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00415">CAEN_DGTZ_SLAVE_TERMINATED_READOUT_MBLT</a>, <a class="el" href="CAENDigitizer_8h.html#a86aa43ec0293ae6cd697c726ad273ac3">CAEN_DGTZ_SWStartAcquisition()</a>, <a class="el" href="CAENDigitizer_8h.html#a9df497040f4bcadf16669c822c3489f5">CAEN_DGTZ_SWStopAcquisition()</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00234">CAEN_DGTZ_USB</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00043">DigitizerParams_t::ChannelMask</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00840">CAEN_DGTZ_DPP_CI_Event_t::Charge</a>, <a class="el" href="ReadoutTest__Digitizer_2include_2keyb_8h_source.html#l00039">CLEARSCR</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00044">DigitizerParams_t::EventAggr</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01012">CAEN_DGTZ_DPP_CI_Params_t::gate</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2src_2Functions_8c_source.html#l00043">get_time()</a>, <a class="el" href="v1724__module_8c_source.html#l00021">handle</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00047">DigitizerParams_t::IOlev</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00040">DigitizerParams_t::LinkType</a>, <a class="el" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c_source.html#l00009">MAXNB</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00029">MAXNBITS</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00027">MaxNChannels</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00741">CAEN_DGTZ_BoardInfo_t::ModelName</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01015">CAEN_DGTZ_DPP_CI_Params_t::nsbl</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01013">CAEN_DGTZ_DPP_CI_Params_t::pgate</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2src_2Functions_8c_source.html#l00177">PrintInterface()</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00044">ProgramDigitizer()</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00045">DigitizerParams_t::PulsePolarity</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00042">DigitizerParams_t::RecordLength</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00746">CAEN_DGTZ_BoardInfo_t::ROC_FirmwareRel</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2src_2Functions_8c_source.html#l00153">SaveDigitalProbe()</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2src_2Functions_8c_source.html#l00101">SaveHistogram()</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2src_2Functions_8c_source.html#l00129">SaveWaveform()</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01010">CAEN_DGTZ_DPP_CI_Params_t::selft</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01009">CAEN_DGTZ_DPP_CI_Params_t::thr</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00839">CAEN_DGTZ_DPP_CI_Event_t::TimeTag</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01017">CAEN_DGTZ_DPP_CI_Params_t::trgc</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01008">CAEN_DGTZ_DPP_CI_Params_t::trgho</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l01014">CAEN_DGTZ_DPP_CI_Params_t::tvaw</a>, and <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00041">DigitizerParams_t::VMEBaseAddress</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00163"></a>00163 {
<a name="l00164"></a>00164     <span class="comment">/* The following variable is the type returned from most of CAENDigitizer</span>
<a name="l00165"></a>00165 <span class="comment">    library functions and is used to check if there was an error in function</span>
<a name="l00166"></a>00166 <span class="comment">    execution. For example:</span>
<a name="l00167"></a>00167 <span class="comment">    ret = CAEN_DGTZ_some_function(some_args);</span>
<a name="l00168"></a>00168 <span class="comment">    if(ret) printf(&quot;Some error&quot;); */</span>
<a name="l00169"></a>00169     <a class="code" href="CAENDigitizerType_8h.html#a60d1fda74d28887ca23e8af04058e4b2">CAEN_DGTZ_ErrorCode</a> ret;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="comment">/* Buffers to store the data. The memory must be allocated using the appropriate</span>
<a name="l00172"></a>00172 <span class="comment">    CAENDigitizer API functions (see below), so they must not be initialized here</span>
<a name="l00173"></a>00173 <span class="comment">    NB: you must use the right type for different DPP analysis (in this case CI) */</span>
<a name="l00174"></a>00174     <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> = NULL;                                 <span class="comment">// readout buffer</span>
<a name="l00175"></a>00175     <a class="code" href="structCAEN__DGTZ__DPP__CI__Event__t.html" title="Event type for DPP-CI v2 to be used within the new readout API.">CAEN_DGTZ_DPP_CI_Event_t</a>       *Events[<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>];  <span class="comment">// events buffer</span>
<a name="l00176"></a>00176     <a class="code" href="CAENDigitizerType_8h.html#abc5681adc4354047ae7df8619abe2bc3" title="Waveform types for DPP-CI and DPP-PSD are the same, hence this define.">CAEN_DGTZ_DPP_CI_Waveforms_t</a>   *Waveform=NULL;     <span class="comment">// waveforms buffer</span>
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="comment">/* The following variables will store the digitizer configuration parameters */</span>
<a name="l00179"></a>00179     <a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html" title="DPP parameter structure to be initialized and passed to CAEN_DGTZ_SetDPPParameters...">CAEN_DGTZ_DPP_CI_Params_t</a> DPPParams[<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>];
<a name="l00180"></a>00180     <a class="code" href="structDigitizerParams__t.html">DigitizerParams_t</a> Params[<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>];
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     <span class="comment">/* Arrays for data analysis */</span>
<a name="l00183"></a>00183     uint64_t PrevTime[<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>][<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>];
<a name="l00184"></a>00184     uint64_t ExtendedTT[<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>][<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>];
<a name="l00185"></a>00185     uint32_t *EHisto[<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>][<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>]; <span class="comment">// Energy Histograms </span>
<a name="l00186"></a>00186     <span class="keywordtype">int</span> ECnt[<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>][<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>];
<a name="l00187"></a>00187     <span class="keywordtype">int</span> TrgCnt[<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>][<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>];
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     <span class="comment">/* The following variable will be used to get an handler for the digitizer. The</span>
<a name="l00190"></a>00190 <span class="comment">    handler will be used for most of CAENDigitizer functions to identify the board */</span>
<a name="l00191"></a>00191     <span class="keywordtype">int</span> <a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>[<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>];
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="comment">/* Other variables */</span>
<a name="l00194"></a>00194     <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, b, ch, ev;
<a name="l00195"></a>00195     <span class="keywordtype">int</span> Quit=0;
<a name="l00196"></a>00196     <span class="keywordtype">int</span> AcqRun = 0;
<a name="l00197"></a>00197     uint32_t AllocatedSize, BufferSize;
<a name="l00198"></a>00198     <span class="keywordtype">int</span> Nb=0;
<a name="l00199"></a>00199     <span class="keywordtype">int</span> DoSaveWave[<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>][<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>];
<a name="l00200"></a>00200     <span class="keywordtype">int</span> MajorNumber;
<a name="l00201"></a>00201     <span class="keywordtype">int</span> BitMask = 0;
<a name="l00202"></a>00202     uint64_t CurrentTime, PrevRateTime, ElapsedTime;
<a name="l00203"></a>00203     uint32_t NumEvents[<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>];
<a name="l00204"></a>00204     <a class="code" href="structCAEN__DGTZ__BoardInfo__t.html">CAEN_DGTZ_BoardInfo_t</a>           BoardInfo;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     memset(DoSaveWave, 0, <a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>*<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00207"></a>00207     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a7022144c375137548041460a9ef83eef">MAXNBITS</a>; i++)
<a name="l00208"></a>00208         BitMask |= 1&lt;&lt;i; <span class="comment">/* Create a bit mask based on number of bits of the board */</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="comment">/* *************************************************************************************** */</span>
<a name="l00211"></a>00211     <span class="comment">/* Set Parameters                                                                          */</span>
<a name="l00212"></a>00212     <span class="comment">/* *************************************************************************************** */</span>
<a name="l00213"></a>00213     memset(&amp;Params, 0, <a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>*<span class="keyword">sizeof</span>(<a class="code" href="structDigitizerParams__t.html">DigitizerParams_t</a>));
<a name="l00214"></a>00214     memset(&amp;DPPParams, 0, <a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>*<span class="keyword">sizeof</span>(<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html" title="DPP parameter structure to be initialized and passed to CAEN_DGTZ_SetDPPParameters...">CAEN_DGTZ_DPP_CI_Params_t</a>));
<a name="l00215"></a>00215     <span class="keywordflow">for</span>(b=0; b&lt;<a class="code" href="ReadoutTest__Digitizer_2src_2ReadoutTest__Digitizer_8c.html#a613f91735f2c206ce6bd8aa4d33dde5c">MAXNB</a>; b++) {
<a name="l00216"></a>00216         <span class="keywordflow">for</span>(ch=0; ch&lt;<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>; ch++)
<a name="l00217"></a>00217             EHisto[b][ch] = NULL; <span class="comment">//set all histograms pointers to NULL (we will allocate them later)</span>
<a name="l00218"></a>00218 
<a name="l00219"></a>00219         <span class="comment">/****************************\</span>
<a name="l00220"></a>00220 <span class="comment">        * Communication Parameters   *</span>
<a name="l00221"></a>00221 <span class="comment">        \****************************/</span>
<a name="l00222"></a>00222         <span class="comment">// Direct USB connection</span>
<a name="l00223"></a>00223         Params[b].<a class="code" href="structDigitizerParams__t.html#ac89f5423c26fb1869afe8903d2994854">LinkType</a> = <a class="code" href="CAENDigitizerType_8h.html#a4edba2270089295abba985e7b30b6785a0615de009ed869e1ef5129622c4080b4">CAEN_DGTZ_USB</a>;  <span class="comment">// Link Type</span>
<a name="l00224"></a>00224         Params[b].<a class="code" href="structDigitizerParams__t.html#ac6fca8055d3e68777aa88981c9662d47">VMEBaseAddress</a> = 0;  <span class="comment">// For direct USB connection, VMEBaseAddress must be 0</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         <span class="comment">// Direct optical connection</span>
<a name="l00227"></a>00227         <span class="comment">//Params[b].LinkType = CAEN_DGTZ_PCI_OpticalLink;  // Link Type</span>
<a name="l00228"></a>00228         <span class="comment">//Params[b].VMEBaseAddress = 0;  // For direct CONET connection, VMEBaseAddress must be 0</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         <span class="comment">// Optical connection to A2818 (or A3818) and access to the board with VME bus</span>
<a name="l00231"></a>00231         <span class="comment">//Params[b].LinkType = CAEN_DGTZ_PCI_OpticalLink;  // Link Type (CAEN_DGTZ_PCIE_OpticalLink for A3818)</span>
<a name="l00232"></a>00232         <span class="comment">//Params[b].VMEBaseAddress = 0x32100000;  // VME Base Address (only for VME bus access; must be 0 for direct connection (CONET or USB)</span>
<a name="l00233"></a>00233         
<a name="l00234"></a>00234         <span class="comment">// USB connection to V1718 bridge and access to the board with VME bus</span>
<a name="l00235"></a>00235         <span class="comment">//Params[b].LinkType = CAEN_DGTZ_USB;  // Link Type (CAEN_DGTZ_PCIE_OpticalLink for A3818)</span>
<a name="l00236"></a>00236         <span class="comment">//Params[b].VMEBaseAddress = 0x11110000;  // VME Base Address (only for VME bus access; must be 0 for direct connection (CONET or USB)</span>
<a name="l00237"></a>00237         
<a name="l00238"></a>00238         Params[b].<a class="code" href="structDigitizerParams__t.html#a49917d3a72d3c5427996d449a0e9e3fc">IOlev</a> = <a class="code" href="CAENDigitizerType_8h.html#ac448d183ec713366ff2d11219e75c354aaedcb81becce1cc3aef6003ae562a0a2">CAEN_DGTZ_IOLevel_TTL</a>;
<a name="l00239"></a>00239         <span class="comment">/****************************\</span>
<a name="l00240"></a>00240 <span class="comment">        *  Acquisition parameters    *</span>
<a name="l00241"></a>00241 <span class="comment">        \****************************/</span>
<a name="l00242"></a>00242         Params[b].<a class="code" href="structDigitizerParams__t.html#a9b20968af2ac0b32661771fa26cd9606">AcqMode</a> = <a class="code" href="CAENDigitizerType_8h.html#a5699d90cc0fc3012bdc0964d7b9dd688a65370f16b71cd460e300183bba1b4450">CAEN_DGTZ_DPP_ACQ_MODE_Mixed</a>;          <span class="comment">// CAEN_DGTZ_DPP_ACQ_MODE_List or CAEN_DGTZ_DPP_ACQ_MODE_Oscilloscope</span>
<a name="l00243"></a>00243         Params[b].<a class="code" href="structDigitizerParams__t.html#a772ec32255b3dea1a11a914dc64fb7bf">RecordLength</a> = 300;                              <span class="comment">// Num of samples of the waveforms (only for Oscilloscope mode)</span>
<a name="l00244"></a>00244         Params[b].<a class="code" href="structDigitizerParams__t.html#a3b1f98fbe9ce993cd32e37f7550a1a30">ChannelMask</a> = 0xF;                               <span class="comment">// Channel enable mask</span>
<a name="l00245"></a>00245         Params[b].<a class="code" href="structDigitizerParams__t.html#ae2fea9272fe76063c6efc5461d82e1fe">EventAggr</a> = 0;                                   <span class="comment">// number of events in one aggregate (0=automatic)</span>
<a name="l00246"></a>00246         Params[b].<a class="code" href="structDigitizerParams__t.html#a14549ae42935da549713d067a9ca9c31">PulsePolarity</a> = <a class="code" href="CAENDigitizerType_8h.html#a230cadc3d42127c2040c4828a1a9f74aa12b04760a3021b7b6bbeb35884674550">CAEN_DGTZ_PulsePolarityNegative</a>; <span class="comment">// Pulse Polarity (this parameter can be individual)</span>
<a name="l00247"></a>00247 
<a name="l00248"></a>00248         <span class="comment">/****************************\</span>
<a name="l00249"></a>00249 <span class="comment">        *      DPP parameters        *</span>
<a name="l00250"></a>00250 <span class="comment">        \****************************/</span>
<a name="l00251"></a>00251         <span class="keywordflow">for</span>(ch=0; ch&lt;MaxNChannels; ch++) {
<a name="l00252"></a>00252             DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#a89ed75f80897e0e5ced095a7c78327ca">thr</a>[ch] = 100;       <span class="comment">// Trigger Threshold</span>
<a name="l00253"></a>00253             <span class="comment">/* The following parameter is used to specifiy the number of samples for the baseline averaging:</span>
<a name="l00254"></a>00254 <span class="comment">            0 -&gt; 8samp</span>
<a name="l00255"></a>00255 <span class="comment">            1 -&gt; 16samp</span>
<a name="l00256"></a>00256 <span class="comment">            2 -&gt; 32samp</span>
<a name="l00257"></a>00257 <span class="comment">            3 -&gt; 64samp */</span>
<a name="l00258"></a>00258             DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#a7aa08bad6457d84a985ef57472febe59">nsbl</a>[ch] = 2;        
<a name="l00259"></a>00259             DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#a274952c87199b875fde66d4104916fab">gate</a>[ch] = 200;      <span class="comment">// Gate Width (N*4ns)</span>
<a name="l00260"></a>00260             DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#a0a3d70ec58048cdc70895a644603e5c4">pgate</a>[ch] = 25;      <span class="comment">// Pre Gate Width (N*4ns)</span>
<a name="l00261"></a>00261             <span class="comment">/* Self Trigger Mode:</span>
<a name="l00262"></a>00262 <span class="comment">            0 -&gt; Disabled</span>
<a name="l00263"></a>00263 <span class="comment">            1 -&gt; Enabled */</span>
<a name="l00264"></a>00264             DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#aad56d7685cbf7cf5e6d2b515066e6960">selft</a>[ch] = 1;
<a name="l00265"></a>00265             <span class="comment">/* Trigger configuration:</span>
<a name="l00266"></a>00266 <span class="comment">            CAEN_DGTZ_DPP_TriggerConfig_Peak -&gt; trigger on peak</span>
<a name="l00267"></a>00267 <span class="comment">            CAEN_DGTZ_DPP_TriggerConfig_Threshold -&gt; trigger on threshold */</span>
<a name="l00268"></a>00268             DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#a686d611d511fd8ecf3fb61c3451ddb81">trgc</a>[ch] = <a class="code" href="CAENDigitizerType_8h.html#ae44a7eeb11687237b53828b378a4645eae92fde2bfed3ac97b1beabab1bd1c2c1">CAEN_DGTZ_DPP_TriggerConfig_Peak</a>;
<a name="l00269"></a>00269             <span class="comment">/* Trigger Validation Acquisition Window */</span>
<a name="l00270"></a>00270             DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#a1fa87e06ef15f76d7a9a3de9fc822062">tvaw</a>[ch] = 50;
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272         DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#aaa74031731bdd4b09d0f2b295bbc129e">blthr</a> = 3;   <span class="comment">// Baseline Threshold</span>
<a name="l00273"></a>00273         DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#a771d2c5301296a17da256e02e2ee2def">bltmo</a> = 100; <span class="comment">// Baseline Timeout</span>
<a name="l00274"></a>00274         DPPParams[b].<a class="code" href="structCAEN__DGTZ__DPP__CI__Params__t.html#a706c89190cd9baa2f6f54141738336d4">trgho</a> = 0;   <span class="comment">// Trigger Holdoff</span>
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="comment">/* *************************************************************************************** */</span>
<a name="l00278"></a>00278     <span class="comment">/* Open the digitizer and read board information                                           */</span>
<a name="l00279"></a>00279     <span class="comment">/* *************************************************************************************** */</span>
<a name="l00280"></a>00280     <span class="comment">/* The following function is used to open the digitizer with the given connection parameters</span>
<a name="l00281"></a>00281 <span class="comment">    and get the handler to it */</span>
<a name="l00282"></a>00282     <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++) {
<a name="l00283"></a>00283         <span class="comment">/* IMPORTANT: The following function identifies the different boards with a system which may change</span>
<a name="l00284"></a>00284 <span class="comment">        for different connection methods (USB, Conet, ecc). Refer to CAENDigitizer user manual for more info.</span>
<a name="l00285"></a>00285 <span class="comment">        Some examples below */</span>
<a name="l00286"></a>00286         
<a name="l00287"></a>00287         <span class="comment">/* The following is for b boards connected via b USB direct links</span>
<a name="l00288"></a>00288 <span class="comment">        in this case you must set Params[b].LinkType = CAEN_DGTZ_USB and Params[b].VMEBaseAddress = 0 */</span>
<a name="l00289"></a>00289         ret = <a class="code" href="CAENDigitizer_8h.html#a4df566fc25d076154f569c51969d79fa" title="Opens the Digitizer.">CAEN_DGTZ_OpenDigitizer</a>(Params[b].LinkType, b, 0, Params[b].VMEBaseAddress, &amp;handle[b]);
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         <span class="comment">/* The following is for b boards connected via 1 opticalLink in dasy chain</span>
<a name="l00292"></a>00292 <span class="comment">        in this case you must set Params[b].LinkType = CAEN_DGTZ_PCI_OpticalLink and Params[b].VMEBaseAddress = 0 */</span>
<a name="l00293"></a>00293         <span class="comment">//ret = CAEN_DGTZ_OpenDigitizer(Params[b].LinkType, 0, b, Params[b].VMEBaseAddress, &amp;handle[b]);</span>
<a name="l00294"></a>00294 
<a name="l00295"></a>00295         <span class="comment">/* The following is for b boards connected to A2818 (or A3818) via opticalLink (or USB with A1718)</span>
<a name="l00296"></a>00296 <span class="comment">        in this case the boards are accessed throught VME bus, and you must specify the VME address of each board:</span>
<a name="l00297"></a>00297 <span class="comment">        Params[b].LinkType = CAEN_DGTZ_PCI_OpticalLink (CAEN_DGTZ_PCIE_OpticalLink for A3818 or CAEN_DGTZ_USB for A1718)</span>
<a name="l00298"></a>00298 <span class="comment">        Params[0].VMEBaseAddress = &lt;0xXXXXXXXX&gt; (address of first board) </span>
<a name="l00299"></a>00299 <span class="comment">        Params[1].VMEBaseAddress = &lt;0xYYYYYYYY&gt; (address of second board) </span>
<a name="l00300"></a>00300 <span class="comment">        etc */</span>
<a name="l00301"></a>00301         <span class="comment">//ret = CAEN_DGTZ_OpenDigitizer(Params[b].LinkType, 0, 0, Params[b].VMEBaseAddress, &amp;handle[b]);</span>
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         <span class="keywordflow">if</span> (ret) {
<a name="l00304"></a>00304             printf(<span class="stringliteral">&quot;Can&apos;t open digitizer\n&quot;</span>);
<a name="l00305"></a>00305             <span class="keywordflow">goto</span> QuitProgram;    
<a name="l00306"></a>00306         }
<a name="l00307"></a>00307         
<a name="l00308"></a>00308         <span class="comment">/* Once we have the handler to the digitizer, we use it to call the other functions */</span>
<a name="l00309"></a>00309         ret = <a class="code" href="CAENDigitizer_8h.html#acf2160247da2992bc2ab58bb85d254cf" title="Retrieves the board information of the digitizer.">CAEN_DGTZ_GetInfo</a>(handle[b], &amp;BoardInfo);
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (ret) {
<a name="l00311"></a>00311             printf(<span class="stringliteral">&quot;Can&apos;t read board info\n&quot;</span>);
<a name="l00312"></a>00312             <span class="keywordflow">goto</span> QuitProgram;
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314         printf(<span class="stringliteral">&quot;\nConnected to CAEN Digitizer Model %s, recognized as board %d\n&quot;</span>, BoardInfo.<a class="code" href="structCAEN__DGTZ__BoardInfo__t.html#ad4260f7210dd948d66e99d8dc7833dd3">ModelName</a>, b);
<a name="l00315"></a>00315         printf(<span class="stringliteral">&quot;ROC FPGA Release is %s\n&quot;</span>, BoardInfo.<a class="code" href="structCAEN__DGTZ__BoardInfo__t.html#a17cdf24b060171e8e92dce1c2a06f9cc">ROC_FirmwareRel</a>);
<a name="l00316"></a>00316         printf(<span class="stringliteral">&quot;AMC FPGA Release is %s\n&quot;</span>, BoardInfo.<a class="code" href="structCAEN__DGTZ__BoardInfo__t.html#a664bf00d99f714669c1949e5ab437ce5">AMC_FirmwareRel</a>);
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         <span class="comment">/* Check firmware revision (only DPP firmware can be used with this Demo) */</span>
<a name="l00319"></a>00319         sscanf(BoardInfo.<a class="code" href="structCAEN__DGTZ__BoardInfo__t.html#a664bf00d99f714669c1949e5ab437ce5">AMC_FirmwareRel</a>, <span class="stringliteral">&quot;%d&quot;</span>, &amp;MajorNumber);
<a name="l00320"></a>00320         <span class="keywordflow">if</span> (MajorNumber != 130) {
<a name="l00321"></a>00321             printf(<span class="stringliteral">&quot;This digitizer has not a DPP-CI firmware\n&quot;</span>);
<a name="l00322"></a>00322             <span class="keywordflow">goto</span> QuitProgram;
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     <span class="comment">/* *************************************************************************************** */</span>
<a name="l00327"></a>00327     <span class="comment">/* Program the digitizer (see function ProgramDigitizer)                                   */</span>
<a name="l00328"></a>00328     <span class="comment">/* *************************************************************************************** */</span>
<a name="l00329"></a>00329     <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++) {
<a name="l00330"></a>00330         ret = <a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#ac4228f122e2acf3adc5803127f8ec103">ProgramDigitizer</a>(handle[b], Params[b], DPPParams[b]);
<a name="l00331"></a>00331         <span class="keywordflow">if</span> (ret) {
<a name="l00332"></a>00332             printf(<span class="stringliteral">&quot;Failed to program the digitizer\n&quot;</span>);
<a name="l00333"></a>00333             <span class="keywordflow">goto</span> QuitProgram;
<a name="l00334"></a>00334         }
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="comment">/* WARNING: The mallocs MUST be done after the digitizer programming,</span>
<a name="l00338"></a>00338 <span class="comment">    because the following functions needs to know the digitizer configuration</span>
<a name="l00339"></a>00339 <span class="comment">    to allocate the right memory amount */</span>
<a name="l00340"></a>00340     <span class="comment">/* Allocate memory for the readout buffer */</span>
<a name="l00341"></a>00341     ret = <a class="code" href="CAENDigitizer_8h.html#a1cd5200db46572508acf091ea935e4b7" title="Allocates memory buffer to hold data received from digitizer.">CAEN_DGTZ_MallocReadoutBuffer</a>(handle[0], &amp;buffer, &amp;AllocatedSize);
<a name="l00342"></a>00342     <span class="comment">/* Allocate memory for the events */</span>
<a name="l00343"></a>00343     ret |= <a class="code" href="CAENDigitizer_8h.html#a161de18f304930413154fc6f69f9f12b" title="Allocates the event buffer matrix which is handled by CAEN_DGTZ_GetDPPEvents. The...">CAEN_DGTZ_MallocDPPEvents</a>(handle[0], Events, &amp;AllocatedSize); 
<a name="l00344"></a>00344     <span class="comment">/* Allocate memory for the waveforms */</span>
<a name="l00345"></a>00345     ret |= <a class="code" href="CAENDigitizer_8h.html#a6a4493fb20699c0799f5adf11b830eff" title="Allocates the waveform buffer, which is used by CAEN_DGTZ_DecodeDPPWaveforms.">CAEN_DGTZ_MallocDPPWaveforms</a>(handle[0], &amp;Waveform, &amp;AllocatedSize); 
<a name="l00346"></a>00346     <span class="keywordflow">if</span> (ret) {
<a name="l00347"></a>00347         printf(<span class="stringliteral">&quot;Can&apos;t allocate memory buffers\n&quot;</span>);
<a name="l00348"></a>00348         <span class="keywordflow">goto</span> QuitProgram;    
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         
<a name="l00352"></a>00352     <span class="comment">/* *************************************************************************************** */</span>
<a name="l00353"></a>00353     <span class="comment">/* Readout Loop                                                                            */</span>
<a name="l00354"></a>00354     <span class="comment">/* *************************************************************************************** */</span>
<a name="l00355"></a>00355     <span class="comment">// Clear Histograms and counters</span>
<a name="l00356"></a>00356     <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++) {
<a name="l00357"></a>00357         <span class="keywordflow">for</span>(ch=0; ch&lt;MaxNChannels; ch++) {
<a name="l00358"></a>00358             EHisto[b][ch] = (uint32_t *)malloc( (1&lt;&lt;MAXNBITS)*<span class="keyword">sizeof</span>(uint32_t) );
<a name="l00359"></a>00359             memset(EHisto[b][ch], 0, (1&lt;&lt;MAXNBITS)*<span class="keyword">sizeof</span>(uint32_t));
<a name="l00360"></a>00360             TrgCnt[b][ch] = 0;
<a name="l00361"></a>00361             ECnt[b][ch] = 0;
<a name="l00362"></a>00362             PrevTime[b][ch] = 0;
<a name="l00363"></a>00363             ExtendedTT[b][ch] = 0;
<a name="l00364"></a>00364         }
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366     PrevRateTime = <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#ac546f744da862dbe03ddf529838e1144" title="Get time in milliseconds.">get_time</a>();
<a name="l00367"></a>00367     AcqRun = 0;
<a name="l00368"></a>00368     <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#ab034ca3523e13bcfad4419f92931ac61" title="Print the interface to screen.">PrintInterface</a>();
<a name="l00369"></a>00369     printf(<span class="stringliteral">&quot;Type a command: &quot;</span>);
<a name="l00370"></a>00370     <span class="keywordflow">while</span>(!Quit) {
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <span class="comment">// Check keyboard</span>
<a name="l00373"></a>00373         <span class="keywordflow">if</span>(kbhit()) {
<a name="l00374"></a>00374             <span class="keywordtype">char</span> <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>;
<a name="l00375"></a>00375             c = getch();
<a name="l00376"></a>00376             <span class="keywordflow">if</span> (c==<span class="charliteral">&apos;q&apos;</span>)  Quit = 1;
<a name="l00377"></a>00377             <span class="keywordflow">if</span> (c==<span class="charliteral">&apos;t&apos;</span>)
<a name="l00378"></a>00378                 <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++)
<a name="l00379"></a>00379                     <a class="code" href="CAENDigitizer_8h.html#a0518b6c1761a39f42f25368ad4962864" title="Sends a Software trigger to the Digitizer.">CAEN_DGTZ_SendSWtrigger</a>(handle[b]); <span class="comment">/* Send a software trigger to each board */</span>
<a name="l00380"></a>00380             <span class="keywordflow">if</span> (c==<span class="charliteral">&apos;h&apos;</span>)
<a name="l00381"></a>00381                 <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++)
<a name="l00382"></a>00382                     <span class="keywordflow">for</span>(ch=0; ch&lt;MaxNChannels; ch++)
<a name="l00383"></a>00383                         <span class="keywordflow">if</span>( ECnt[b][ch] != 0) 
<a name="l00384"></a>00384                             <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#a3ab198295597655f55bad2a2a19e414f">SaveHistogram</a>(<span class="stringliteral">&quot;Histo&quot;</span>, b, ch, EHisto[b][ch]);  <span class="comment">/* Save Histograms to file for each board */</span>
<a name="l00385"></a>00385             <span class="keywordflow">if</span> (c==<span class="charliteral">&apos;w&apos;</span>)
<a name="l00386"></a>00386                 <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++)
<a name="l00387"></a>00387                     <span class="keywordflow">for</span>(ch=0; ch&lt;MaxNChannels; ch++)
<a name="l00388"></a>00388                         DoSaveWave[b][ch] = 1; <span class="comment">/* save waveforms to file for each channel for each board (at next trigger) */</span>
<a name="l00389"></a>00389             <span class="keywordflow">if</span> (c==<span class="charliteral">&apos;r&apos;</span>)  {
<a name="l00390"></a>00390                 <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++) {
<a name="l00391"></a>00391                     <a class="code" href="CAENDigitizer_8h.html#a9df497040f4bcadf16669c822c3489f5" title="Stops Digitizer acquisition.">CAEN_DGTZ_SWStopAcquisition</a>(handle[b]); 
<a name="l00392"></a>00392                     printf(<span class="stringliteral">&quot;Restarted\n&quot;</span>);
<a name="l00393"></a>00393                     <a class="code" href="CAENDigitizer_8h.html#a7fae2e27649e39cf87e5410c2c981db4" title="Clears the data stored in the buffers of the Digitizer.">CAEN_DGTZ_ClearData</a>(handle[b]);
<a name="l00394"></a>00394                     <a class="code" href="CAENDigitizer_8h.html#a86aa43ec0293ae6cd697c726ad273ac3" title="Starts Digitizers acquisition.">CAEN_DGTZ_SWStartAcquisition</a>(handle[b]);
<a name="l00395"></a>00395                 }
<a name="l00396"></a>00396             }
<a name="l00397"></a>00397             <span class="keywordflow">if</span> (c==<span class="charliteral">&apos;s&apos;</span>)  {
<a name="l00398"></a>00398                 <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++) {
<a name="l00399"></a>00399                     <span class="comment">// Start Acquisition</span>
<a name="l00400"></a>00400                     <span class="comment">// NB: the acquisition for each board starts when the following line is executed</span>
<a name="l00401"></a>00401                     <span class="comment">// so in general the acquisition does NOT starts syncronously for different boards</span>
<a name="l00402"></a>00402                     <a class="code" href="CAENDigitizer_8h.html#a86aa43ec0293ae6cd697c726ad273ac3" title="Starts Digitizers acquisition.">CAEN_DGTZ_SWStartAcquisition</a>(handle[b]);
<a name="l00403"></a>00403                     printf(<span class="stringliteral">&quot;Acquisition Started for Board %d\n&quot;</span>, b);
<a name="l00404"></a>00404                 }
<a name="l00405"></a>00405                 AcqRun = 1;
<a name="l00406"></a>00406             }
<a name="l00407"></a>00407             <span class="keywordflow">if</span> (c==<span class="charliteral">&apos;S&apos;</span>)  {
<a name="l00408"></a>00408                 <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++) {
<a name="l00409"></a>00409                     <span class="comment">// Stop Acquisition</span>
<a name="l00410"></a>00410                     <a class="code" href="CAENDigitizer_8h.html#a9df497040f4bcadf16669c822c3489f5" title="Stops Digitizer acquisition.">CAEN_DGTZ_SWStopAcquisition</a>(handle[b]); 
<a name="l00411"></a>00411                     printf(<span class="stringliteral">&quot;Acquisition Stopped for Board %d\n&quot;</span>, b);
<a name="l00412"></a>00412                 }
<a name="l00413"></a>00413                 AcqRun = 0;
<a name="l00414"></a>00414             }
<a name="l00415"></a>00415         }
<a name="l00416"></a>00416         <span class="keywordflow">if</span> (!AcqRun) {
<a name="l00417"></a>00417             Sleep(10);
<a name="l00418"></a>00418             <span class="keywordflow">continue</span>;
<a name="l00419"></a>00419         }
<a name="l00420"></a>00420     
<a name="l00421"></a>00421         <span class="comment">/* Calculate throughput and trigger rate (every second) */</span>
<a name="l00422"></a>00422         CurrentTime = <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#ac546f744da862dbe03ddf529838e1144" title="Get time in milliseconds.">get_time</a>();
<a name="l00423"></a>00423         ElapsedTime = CurrentTime - PrevRateTime; <span class="comment">/* milliseconds */</span>
<a name="l00424"></a>00424         <span class="keywordflow">if</span> (ElapsedTime &gt; 1000) {
<a name="l00425"></a>00425             system(<a class="code" href="ReadoutTest__Digitizer_2include_2keyb_8h.html#a2b531a7c0a4f854ccab94f3fe1b3584d">CLEARSCR</a>);
<a name="l00426"></a>00426             <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#ab034ca3523e13bcfad4419f92931ac61" title="Print the interface to screen.">PrintInterface</a>();
<a name="l00427"></a>00427             printf(<span class="stringliteral">&quot;Readout Rate=%.2f MB\n&quot;</span>, (<span class="keywordtype">float</span>)Nb/((<span class="keywordtype">float</span>)ElapsedTime*1048.576f));
<a name="l00428"></a>00428             <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++) {
<a name="l00429"></a>00429                 printf(<span class="stringliteral">&quot;\nBoard %d:\n&quot;</span>,b);
<a name="l00430"></a>00430                 <span class="keywordflow">for</span>(i=0; i&lt;MaxNChannels; i++) {
<a name="l00431"></a>00431                     <span class="keywordflow">if</span> (TrgCnt[b][i]&gt;0)
<a name="l00432"></a>00432                         printf(<span class="stringliteral">&quot;\tCh %d:\tTrgRate=%.2f KHz\t\n&quot;</span>, i, (<span class="keywordtype">float</span>)TrgCnt[b][i]/(<span class="keywordtype">float</span>)ElapsedTime);
<a name="l00433"></a>00433                     <span class="keywordflow">else</span>
<a name="l00434"></a>00434                         printf(<span class="stringliteral">&quot;\tCh %d:\tNo Data\n&quot;</span>, i);
<a name="l00435"></a>00435                     TrgCnt[b][i]=0;
<a name="l00436"></a>00436                 }
<a name="l00437"></a>00437             }
<a name="l00438"></a>00438             Nb = 0;
<a name="l00439"></a>00439             PrevRateTime = CurrentTime;
<a name="l00440"></a>00440             printf(<span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442         
<a name="l00443"></a>00443         <span class="comment">/* Read data from the boards */</span>
<a name="l00444"></a>00444         <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++) {
<a name="l00445"></a>00445             <span class="comment">/* Read data from the board */</span>
<a name="l00446"></a>00446             ret = <a class="code" href="CAENDigitizer_8h.html#a87659689821b310020b347fcd749c343" title="Reads data (events) from the digitizer.">CAEN_DGTZ_ReadData</a>(handle[b], <a class="code" href="CAENDigitizerType_8h.html#a280f0e2a85aaecc5a83cdac3af419187a3bdba30aee906d6283858101687fd5ae">CAEN_DGTZ_SLAVE_TERMINATED_READOUT_MBLT</a>, buffer, &amp;BufferSize);
<a name="l00447"></a>00447             <span class="keywordflow">if</span> (ret) {
<a name="l00448"></a>00448                 printf(<span class="stringliteral">&quot;Readout Error\n&quot;</span>);
<a name="l00449"></a>00449                 <span class="keywordflow">goto</span> QuitProgram;    
<a name="l00450"></a>00450             }
<a name="l00451"></a>00451             <span class="keywordflow">if</span> (BufferSize == 0)
<a name="l00452"></a>00452                 <span class="keywordflow">continue</span>;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454             Nb += BufferSize;
<a name="l00455"></a>00455             <span class="comment">//ret = DataConsistencyCheck((uint32_t *)buffer, BufferSize/4);</span>
<a name="l00456"></a>00456             ret |= <a class="code" href="CAENDigitizer_8h.html#a14bd21a25a1cb3f798fe364c3dde3992" title="Decodes and returns all the DPP events stored in the acquisition buffers.">CAEN_DGTZ_GetDPPEvents</a>(handle[b], buffer, BufferSize, Events, NumEvents);
<a name="l00457"></a>00457             <span class="keywordflow">if</span> (ret) {
<a name="l00458"></a>00458                 printf(<span class="stringliteral">&quot;Data Error: %d\n&quot;</span>, ret);
<a name="l00459"></a>00459                 <span class="keywordflow">goto</span> QuitProgram;
<a name="l00460"></a>00460             }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462             <span class="comment">/* Analyze data */</span>
<a name="l00463"></a>00463             <span class="keywordflow">for</span>(ch=0; ch&lt;MaxNChannels; ch++) {
<a name="l00464"></a>00464                 <span class="keywordflow">if</span> (!(Params[b].ChannelMask &amp; (1&lt;&lt;ch)))
<a name="l00465"></a>00465                     <span class="keywordflow">continue</span>;
<a name="l00466"></a>00466                 
<a name="l00467"></a>00467                 <span class="comment">/* Update Histograms */</span>
<a name="l00468"></a>00468                 <span class="keywordflow">for</span>(ev=0; ev&lt;NumEvents[ch]; ev++) {
<a name="l00469"></a>00469                     TrgCnt[b][ch]++;
<a name="l00470"></a>00470                     <span class="comment">/* Time Tag */</span>
<a name="l00471"></a>00471                     <span class="keywordflow">if</span> (Events[ch][ev].TimeTag &lt; PrevTime[b][ch]) 
<a name="l00472"></a>00472                         ExtendedTT[b][ch]++;
<a name="l00473"></a>00473                     PrevTime[b][ch] = Events[ch][ev].<a class="code" href="structCAEN__DGTZ__DPP__CI__Event__t.html#aebbfff16e901be581b099cfc24251cad">TimeTag</a>;
<a name="l00474"></a>00474                     <span class="comment">/* Energy */</span>
<a name="l00475"></a>00475                     <span class="keywordflow">if</span> (Events[ch][ev].Charge &gt; 0) {
<a name="l00476"></a>00476                         <span class="comment">// Fill the histograms</span>
<a name="l00477"></a>00477                         EHisto[b][ch][(Events[ch][ev].<a class="code" href="structCAEN__DGTZ__DPP__CI__Event__t.html#aaf723505c4acc33b362016889548f3f7">Charge</a>) &amp; BitMask]++;
<a name="l00478"></a>00478                         ECnt[b][ch]++;
<a name="l00479"></a>00479                     }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481                     <span class="comment">/* Get Waveforms (only from 1st event in the buffer) */</span>
<a name="l00482"></a>00482                     <span class="keywordflow">if</span> ((Params[b].AcqMode != <a class="code" href="CAENDigitizerType_8h.html#a5699d90cc0fc3012bdc0964d7b9dd688a922daa4dd0f993c345fc6babc0a6c8b5">CAEN_DGTZ_DPP_ACQ_MODE_List</a>) &amp;&amp; DoSaveWave[b][ch] &amp;&amp; (ev == 0)) {
<a name="l00483"></a>00483                         <span class="keywordtype">int</span> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l00484"></a>00484                         int16_t *WaveLine;
<a name="l00485"></a>00485                         uint8_t *DigitalWaveLine;
<a name="l00486"></a>00486                         <a class="code" href="CAENDigitizer_8h.html#a3151c0773642366fe40d936f7a2a5686" title="Decodes the waveforms contained inside an event.">CAEN_DGTZ_DecodeDPPWaveforms</a>(handle[b], &amp;Events[ch][ev], Waveform);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488                         <span class="comment">// Use waveform data here...</span>
<a name="l00489"></a>00489                         size = (int)(Waveform-&gt;Ns); <span class="comment">// Number of samples</span>
<a name="l00490"></a>00490                         WaveLine = Waveform-&gt;Trace1; <span class="comment">// First trace (for DPP-CI it is ALWAYS the Input Signal)</span>
<a name="l00491"></a>00491                         <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#a19fd4dffb35bea38cd908da4f8703352">SaveWaveform</a>(b, ch, 1, size, WaveLine);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493                         WaveLine = Waveform-&gt;Trace2; <span class="comment">// Second Trace (if single trace mode, it is a sequence of zeroes)</span>
<a name="l00494"></a>00494                         <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#a19fd4dffb35bea38cd908da4f8703352">SaveWaveform</a>(b, ch, 2, size, WaveLine);
<a name="l00495"></a>00495                         DoSaveWave[b][ch] = 0;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497                         DigitalWaveLine = Waveform-&gt;DTrace1; <span class="comment">// First Digital Trace (Trigger)</span>
<a name="l00498"></a>00498                         <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#ae0f9fc2ef80b97ba1b36a30c04f536d2" title="Save Digital Waveforms to output file.">SaveDigitalProbe</a>(b, ch, 1, size, DigitalWaveLine);
<a name="l00499"></a>00499                         DoSaveWave[b][ch] = 0;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501                         DigitalWaveLine = Waveform-&gt;DTrace2; <span class="comment">// Second Digital Trace (Gate)</span>
<a name="l00502"></a>00502                         <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#ae0f9fc2ef80b97ba1b36a30c04f536d2" title="Save Digital Waveforms to output file.">SaveDigitalProbe</a>(b, ch, 2, size, DigitalWaveLine);
<a name="l00503"></a>00503                         DoSaveWave[b][ch] = 0;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505                         DigitalWaveLine = Waveform-&gt;DTrace3; <span class="comment">// Third Digital Trace (DIGITALPROBE1 set with CAEN_DGTZ_SetDPP_PSD_VirtualProbe)</span>
<a name="l00506"></a>00506                         <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#ae0f9fc2ef80b97ba1b36a30c04f536d2" title="Save Digital Waveforms to output file.">SaveDigitalProbe</a>(b, ch, 3, size, DigitalWaveLine);
<a name="l00507"></a>00507                         DoSaveWave[b][ch] = 0;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509                         DigitalWaveLine = Waveform-&gt;DTrace4; <span class="comment">// Fourth Digital Trace (DIGITALPROBE2 set with CAEN_DGTZ_SetDPP_PSD_VirtualProbe)</span>
<a name="l00510"></a>00510                         <a class="code" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h.html#ae0f9fc2ef80b97ba1b36a30c04f536d2" title="Save Digital Waveforms to output file.">SaveDigitalProbe</a>(b, ch, 4, size, DigitalWaveLine);
<a name="l00511"></a>00511                         DoSaveWave[b][ch] = 0;
<a name="l00512"></a>00512                         printf(<span class="stringliteral">&quot;Waveforms saved to &apos;Waveform_&lt;board&gt;_&lt;channel&gt;_&lt;trace&gt;.txt&apos;\n&quot;</span>);
<a name="l00513"></a>00513                     } <span class="comment">// loop to save waves        </span>
<a name="l00514"></a>00514                 } <span class="comment">// loop on events</span>
<a name="l00515"></a>00515             } <span class="comment">// loop on channels</span>
<a name="l00516"></a>00516         } <span class="comment">// loop on boards</span>
<a name="l00517"></a>00517     } <span class="comment">// End of readout loop</span>
<a name="l00518"></a>00518 
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 QuitProgram:
<a name="l00521"></a>00521     <span class="comment">/* stop the acquisition, close the device and free the buffers */</span>
<a name="l00522"></a>00522     <span class="keywordflow">for</span>(b=0; b&lt;MAXNB; b++) {
<a name="l00523"></a>00523         <a class="code" href="CAENDigitizer_8h.html#a9df497040f4bcadf16669c822c3489f5" title="Stops Digitizer acquisition.">CAEN_DGTZ_SWStopAcquisition</a>(handle[b]);
<a name="l00524"></a>00524         <a class="code" href="CAENDigitizer_8h.html#a745c6e08895e1f1575af80c682973f4e" title="Closes the Digitizer.">CAEN_DGTZ_CloseDigitizer</a>(handle[b]);
<a name="l00525"></a>00525         <span class="keywordflow">for</span> (ch=0; ch&lt;MaxNChannels; ch++)
<a name="l00526"></a>00526             <span class="keywordflow">if</span> (EHisto[b][ch] != NULL)
<a name="l00527"></a>00527                 free(EHisto[b][ch]);
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529     <a class="code" href="CAENDigitizer_8h.html#a8661c8e8ea763a61b3a6245df65e6cfc" title="Frees memory allocated by the CAEN_DGTZ_MallocReadoutBuffer.">CAEN_DGTZ_FreeReadoutBuffer</a>(&amp;buffer);
<a name="l00530"></a>00530     <a class="code" href="CAENDigitizer_8h.html#a21eba768d657b13624095f8b4b726462" title="Deallocates the event buffer matrix.">CAEN_DGTZ_FreeDPPEvents</a>(handle[0], Events);
<a name="l00531"></a>00531     <a class="code" href="CAENDigitizer_8h.html#aef66a43005317231d5472f9914ae0681" title="Deallocates the waveform buffer.">CAEN_DGTZ_FreeDPPWaveforms</a>(handle[0], Waveform);
<a name="l00532"></a>00532     <span class="keywordflow">return</span> ret;
<a name="l00533"></a>00533 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac4228f122e2acf3adc5803127f8ec103"></a><!-- doxytag: member="ReadoutTest_DPP_CI_x720.c::ProgramDigitizer" ref="ac4228f122e2acf3adc5803127f8ec103" args="(int handle, DigitizerParams_t Params, CAEN_DGTZ_DPP_CI_Params_t DPPParams)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ProgramDigitizer </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structDigitizerParams__t.html">DigitizerParams_t</a>&nbsp;</td>
          <td class="paramname"> <em>Params</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structCAEN__DGTZ__DPP__CI__Params__t.html">CAEN_DGTZ_DPP_CI_Params_t</a>&nbsp;</td>
          <td class="paramname"> <em>DPPParams</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00044">44</a> of file <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html">ReadoutTest_DPP_CI_x720.c</a>.</p>

<p>References <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00046">DigitizerParams_t::AcqMode</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00525">CAEN_DGTZ_DPP_CI_DIGITALPROBE1_BlOutSafeBand</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00563">CAEN_DGTZ_DPP_CI_DIGITALPROBE2_Tvaw</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00507">CAEN_DGTZ_DPP_CI_VIRTUALPROBE_Baseline</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00695">CAEN_DGTZ_DPP_SAVE_PARAM_EnergyAndTime</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00455">CAEN_DGTZ_DPP_VIRTUALPROBE_SINGLE</a>, <a class="el" href="CAENDigitizer_8h.html#ac17e29d6ac81542eb40b0f9a5ca9e698">CAEN_DGTZ_Reset()</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00722">CAEN_DGTZ_RUN_SYNC_Disabled</a>, <a class="el" href="CAENDigitizer_8h.html#a3a5fa52713c2f51bd5435ffbb247f8cd">CAEN_DGTZ_SetAcquisitionMode()</a>, <a class="el" href="CAENDigitizer_8h.html#ac84047fcbc2282cf3e9343c6e6bcb435">CAEN_DGTZ_SetChannelDCOffset()</a>, <a class="el" href="CAENDigitizer_8h.html#acb293bf6a0fbedc8917375c4b1360dd9">CAEN_DGTZ_SetChannelEnableMask()</a>, <a class="el" href="CAENDigitizer_8h.html#ac3bcc0bc91393584642fed49fba13546">CAEN_DGTZ_SetChannelPulsePolarity()</a>, <a class="el" href="CAENDigitizer_8h.html#abedd909adbe9a541bdb28ccaddd2b1bf">CAEN_DGTZ_SetDPP_CI_VirtualProbe()</a>, <a class="el" href="CAENDigitizer_8h.html#aeff76c6721cdb60763b6256cf018163e">CAEN_DGTZ_SetDPPAcquisitionMode()</a>, <a class="el" href="CAENDigitizer_8h.html#a16419805c23258e2adbbee0d883edd02">CAEN_DGTZ_SetDPPEventAggregation()</a>, <a class="el" href="CAENDigitizer_8h.html#a5801d368a410db2773510c5c0ffd391e">CAEN_DGTZ_SetDPPParameters()</a>, <a class="el" href="CAENDigitizer_8h.html#a15cdca8bc05ccadd5db385bfc36bda85">CAEN_DGTZ_SetDPPPreTriggerSize()</a>, <a class="el" href="CAENDigitizer_8h.html#a33fc4c2d71dfa794f6063f9a5814081b">CAEN_DGTZ_SetExtTriggerInputMode()</a>, <a class="el" href="CAENDigitizer_8h.html#a3995054c9c7adfad91421150157035a2">CAEN_DGTZ_SetIOLevel()</a>, <a class="el" href="CAENDigitizer_8h.html#af3e8e7326a285960d10d91bec8e2bd3f">CAEN_DGTZ_SetRecordLength()</a>, <a class="el" href="CAENDigitizer_8h.html#a46528742a6e7c4e6d5cca8c0ec4e29bc">CAEN_DGTZ_SetRunSynchronizationMode()</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00371">CAEN_DGTZ_SW_CONTROLLED</a>, <a class="el" href="CAENDigitizerType_8h_source.html#l00333">CAEN_DGTZ_TRGMODE_ACQ_ONLY</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00043">DigitizerParams_t::ChannelMask</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00044">DigitizerParams_t::EventAggr</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00047">DigitizerParams_t::IOlev</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00027">MaxNChannels</a>, <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00045">DigitizerParams_t::PulsePolarity</a>, and <a class="el" href="ReadoutTest__DPP__CI__x720_2include_2Functions_8h_source.html#l00042">DigitizerParams_t::RecordLength</a>.</p>

<p>Referenced by <a class="el" href="ReadoutTest__DPP__CI__x720_8c_source.html#l00162">main()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00045"></a>00045 {
<a name="l00046"></a>00046     <span class="comment">/* This function uses the CAENDigitizer API functions to perform the digitizer&apos;s initial configuration */</span>
<a name="l00047"></a>00047     <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, ret = 0;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049     <span class="comment">/* Reset the digitizer */</span>
<a name="l00050"></a>00050     ret |= <a class="code" href="CAENDigitizer_8h.html#ac17e29d6ac81542eb40b0f9a5ca9e698" title="Resets the Digitizer. All internal registers and states are restored to defaults...">CAEN_DGTZ_Reset</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>);
<a name="l00051"></a>00051 
<a name="l00052"></a>00052     <span class="keywordflow">if</span> (ret) {
<a name="l00053"></a>00053         printf(<span class="stringliteral">&quot;ERROR: can&apos;t reset the digitizer.\n&quot;</span>);
<a name="l00054"></a>00054         <span class="keywordflow">return</span> -1;
<a name="l00055"></a>00055     }
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     <span class="comment">/* Set the DPP acquisition mode</span>
<a name="l00058"></a>00058 <span class="comment">    This setting affects the modes Mixed and List (see CAEN_DGTZ_DPP_AcqMode_t definition for details)</span>
<a name="l00059"></a>00059 <span class="comment">    CAEN_DGTZ_DPP_SAVE_PARAM_EnergyOnly        Only energy (DPP-PHA) or charge (DPP-PSD/DPP-CI v2) is returned</span>
<a name="l00060"></a>00060 <span class="comment">    CAEN_DGTZ_DPP_SAVE_PARAM_TimeOnly        Only time is returned</span>
<a name="l00061"></a>00061 <span class="comment">    CAEN_DGTZ_DPP_SAVE_PARAM_EnergyAndTime    Both energy/charge and time are returned</span>
<a name="l00062"></a>00062 <span class="comment">    CAEN_DGTZ_DPP_SAVE_PARAM_None            No histogram data is returned */</span>
<a name="l00063"></a>00063     ret |= <a class="code" href="CAENDigitizer_8h.html#aeff76c6721cdb60763b6256cf018163e" title="Set the DPP acquisition mode.">CAEN_DGTZ_SetDPPAcquisitionMode</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, Params.<a class="code" href="structDigitizerParams__t.html#a9b20968af2ac0b32661771fa26cd9606">AcqMode</a>, <a class="code" href="CAENDigitizerType_8h.html#ac96545ce0b793e3614a73e370a99c305a7e2b8c0007f4b083ff916c29cf12ed08">CAEN_DGTZ_DPP_SAVE_PARAM_EnergyAndTime</a>);
<a name="l00064"></a>00064     
<a name="l00065"></a>00065     <span class="comment">// Set the digitizer acquisition mode (CAEN_DGTZ_SW_CONTROLLED or CAEN_DGTZ_S_IN_CONTROLLED)</span>
<a name="l00066"></a>00066     ret |= <a class="code" href="CAENDigitizer_8h.html#a3a5fa52713c2f51bd5435ffbb247f8cd" title="Sets digitizer acquisition mode.">CAEN_DGTZ_SetAcquisitionMode</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, <a class="code" href="CAENDigitizerType_8h.html#abad9d15e9b43e808defcf04a5e511d7fa57b81857d731dd0e42705f5edf2ad324">CAEN_DGTZ_SW_CONTROLLED</a>);
<a name="l00067"></a>00067     
<a name="l00068"></a>00068     <span class="comment">// Set the number of samples for each waveform</span>
<a name="l00069"></a>00069     ret |= <a class="code" href="CAENDigitizer_8h.html#af3e8e7326a285960d10d91bec8e2bd3f" title="Sets acquisition record length.">CAEN_DGTZ_SetRecordLength</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, Params.<a class="code" href="structDigitizerParams__t.html#a772ec32255b3dea1a11a914dc64fb7bf">RecordLength</a>);
<a name="l00070"></a>00070 
<a name="l00071"></a>00071     <span class="comment">// Set the I/O level (CAEN_DGTZ_IOLevel_NIM or CAEN_DGTZ_IOLevel_TTL)</span>
<a name="l00072"></a>00072     ret |= <a class="code" href="CAENDigitizer_8h.html#a3995054c9c7adfad91421150157035a2" title="Sets the IO Level.">CAEN_DGTZ_SetIOLevel</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, Params.<a class="code" href="structDigitizerParams__t.html#a49917d3a72d3c5427996d449a0e9e3fc">IOlev</a>);
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="comment">/* Set the digitizer&apos;s behaviour when an external trigger arrives:</span>
<a name="l00075"></a>00075 <span class="comment"></span>
<a name="l00076"></a>00076 <span class="comment">    CAEN_DGTZ_TRGMODE_DISABLED: do nothing</span>
<a name="l00077"></a>00077 <span class="comment">    CAEN_DGTZ_TRGMODE_EXTOUT_ONLY: generate the Trigger Output signal</span>
<a name="l00078"></a>00078 <span class="comment">    CAEN_DGTZ_TRGMODE_ACQ_ONLY = generate acquisition trigger</span>
<a name="l00079"></a>00079 <span class="comment">    CAEN_DGTZ_TRGMODE_ACQ_AND_EXTOUT = generate both Trigger Output and acquisition trigger</span>
<a name="l00080"></a>00080 <span class="comment"></span>
<a name="l00081"></a>00081 <span class="comment">    see CAENDigitizer user manual, chapter &quot;Trigger configuration&quot; for details */</span>
<a name="l00082"></a>00082     ret |= <a class="code" href="CAENDigitizer_8h.html#a33fc4c2d71dfa794f6063f9a5814081b" title="Sets external trigger input mode.">CAEN_DGTZ_SetExtTriggerInputMode</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, <a class="code" href="CAENDigitizerType_8h.html#a6821276e871691c1f076f2654fd709e7a09e66ffd22d700db85ff0719de5b8508">CAEN_DGTZ_TRGMODE_ACQ_ONLY</a>);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="comment">// Set the enabled channels</span>
<a name="l00085"></a>00085     ret |= <a class="code" href="CAENDigitizer_8h.html#acb293bf6a0fbedc8917375c4b1360dd9" title="Sets channels that will be enabled into events.">CAEN_DGTZ_SetChannelEnableMask</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, Params.<a class="code" href="structDigitizerParams__t.html#a3b1f98fbe9ce993cd32e37f7550a1a30">ChannelMask</a>);
<a name="l00086"></a>00086 
<a name="l00087"></a>00087     <span class="comment">// Set how many events to accumulate in the board memory before being available for readout</span>
<a name="l00088"></a>00088     ret |= <a class="code" href="CAENDigitizer_8h.html#a16419805c23258e2adbbee0d883edd02" title="Set event aggregation parameters.">CAEN_DGTZ_SetDPPEventAggregation</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, Params.<a class="code" href="structDigitizerParams__t.html#ae2fea9272fe76063c6efc5461d82e1fe">EventAggr</a>, 0);
<a name="l00089"></a>00089     
<a name="l00090"></a>00090     <span class="comment">/* Set the mode used to syncronize the acquisition between different boards.</span>
<a name="l00091"></a>00091 <span class="comment">    In this example the sync is disabled */</span>
<a name="l00092"></a>00092     ret |= <a class="code" href="CAENDigitizer_8h.html#a46528742a6e7c4e6d5cca8c0ec4e29bc" title="Sets the run synchronization mode of the digitizer, used to synchronize an acquisition...">CAEN_DGTZ_SetRunSynchronizationMode</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, <a class="code" href="CAENDigitizerType_8h.html#aa41e9ca8fdcdc52f1cbc6176c14848a9a45b453e97b21731e07de2f62836744f7">CAEN_DGTZ_RUN_SYNC_Disabled</a>);
<a name="l00093"></a>00093     
<a name="l00094"></a>00094     <span class="comment">// Set the DPP specific parameters for the channels in the given channelMask</span>
<a name="l00095"></a>00095     ret |= <a class="code" href="CAENDigitizer_8h.html#a5801d368a410db2773510c5c0ffd391e" title="Set DPP configuration parameters for DPP-PHA, DPP-PSD or DPP-CI.">CAEN_DGTZ_SetDPPParameters</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, Params.<a class="code" href="structDigitizerParams__t.html#a3b1f98fbe9ce993cd32e37f7550a1a30">ChannelMask</a>, &amp;DPPParams);
<a name="l00096"></a>00096     
<a name="l00097"></a>00097     <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="ReadoutTest__DPP__CI__x720_8c.html#a1befa53f10d42ae3c5cff58080f6c253">MaxNChannels</a>; i++) {
<a name="l00098"></a>00098         <span class="keywordflow">if</span> (Params.<a class="code" href="structDigitizerParams__t.html#a3b1f98fbe9ce993cd32e37f7550a1a30">ChannelMask</a> &amp; (1&lt;&lt;i)) {
<a name="l00099"></a>00099             <span class="comment">// Set a DC offset to the input signal to adapt it to digitizer&apos;s dynamic range</span>
<a name="l00100"></a>00100             ret |= <a class="code" href="CAENDigitizer_8h.html#ac84047fcbc2282cf3e9343c6e6bcb435" title="Sets the DC offset for a specified channel.">CAEN_DGTZ_SetChannelDCOffset</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, i, 0x8000);
<a name="l00101"></a>00101             
<a name="l00102"></a>00102             <span class="comment">// Set the Pre-Trigger size (in samples)</span>
<a name="l00103"></a>00103             ret |= <a class="code" href="CAENDigitizer_8h.html#a15cdca8bc05ccadd5db385bfc36bda85" title="Sets the pre-trigger size, which is the portion of acquisition window visible before...">CAEN_DGTZ_SetDPPPreTriggerSize</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, i, 80);
<a name="l00104"></a>00104             
<a name="l00105"></a>00105             <span class="comment">// Set the polarity for the given channel (CAEN_DGTZ_PulsePolarityPositive or CAEN_DGTZ_PulsePolarityNegative)</span>
<a name="l00106"></a>00106             ret |= <a class="code" href="CAENDigitizer_8h.html#ac3bcc0bc91393584642fed49fba13546" title="Set the pulse polarity for the specified channel.">CAEN_DGTZ_SetChannelPulsePolarity</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, i, Params.<a class="code" href="structDigitizerParams__t.html#a14549ae42935da549713d067a9ca9c31">PulsePolarity</a>);
<a name="l00107"></a>00107         }
<a name="l00108"></a>00108     }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <span class="comment">/* Set the virtual probes settings</span>
<a name="l00111"></a>00111 <span class="comment">    DPP-CI can save:</span>
<a name="l00112"></a>00112 <span class="comment">    2 analog waveforms:</span>
<a name="l00113"></a>00113 <span class="comment">        Analog Trace 1: it is always the input signal;</span>
<a name="l00114"></a>00114 <span class="comment">        Analog Trace 2: it can be specified with the VIRTUALPROBE parameter</span>
<a name="l00115"></a>00115 <span class="comment">    4 digital waveforms:</span>
<a name="l00116"></a>00116 <span class="comment">        Digital Trace 1:   it is always the trigger</span>
<a name="l00117"></a>00117 <span class="comment">        Digital Trace 2:   it is always the gate</span>
<a name="l00118"></a>00118 <span class="comment">        Digital Trace 2/3: they can be specified with the DIGITALPROBE 1 and 2 parameters</span>
<a name="l00119"></a>00119 <span class="comment"></span>
<a name="l00120"></a>00120 <span class="comment">    CAEN_DGTZ_DPP_VIRTUALPROBE_SINGLE    -&gt; Save only the Input Signal waveform</span>
<a name="l00121"></a>00121 <span class="comment">    CAEN_DGTZ_DPP_VIRTUALPROBE_DUAL      -&gt; Save also the Trace specified in VIRTUALPROBE (interleaved)</span>
<a name="l00122"></a>00122 <span class="comment"></span>
<a name="l00123"></a>00123 <span class="comment">    Probes types for Analog Trace 2:</span>
<a name="l00124"></a>00124 <span class="comment">        CAEN_DGTZ_DPP_CI_VIRTUALPROBE_Baseline</span>
<a name="l00125"></a>00125 <span class="comment">    </span>
<a name="l00126"></a>00126 <span class="comment">    Probes types for Digital Trace 3:</span>
<a name="l00127"></a>00127 <span class="comment">      ### Virtual Probes only for FW &gt;= 130.21 ###</span>
<a name="l00128"></a>00128 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE1_R21_ExtTrg</span>
<a name="l00129"></a>00129 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE1_R21_OverThr</span>
<a name="l00130"></a>00130 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE1_R21_TrigOut</span>
<a name="l00131"></a>00131 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE1_R21_CoincWin</span>
<a name="l00132"></a>00132 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE1_R21_Coincidence</span>
<a name="l00133"></a>00133 <span class="comment">      ### Virtual Probes only for FW &lt;= 130.20 ###</span>
<a name="l00134"></a>00134 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE1_BlOutSafeBand</span>
<a name="l00135"></a>00135 <span class="comment">            CAEN_DGTZ_DPP_CI_DIGITALPROBE1_BlTimeout</span>
<a name="l00136"></a>00136 <span class="comment">            CAEN_DGTZ_DPP_CI_DIGITALPROBE1_CoincidenceMet</span>
<a name="l00137"></a>00137 <span class="comment">            CAEN_DGTZ_DPP_CI_DIGITALPROBE1_Tvaw</span>
<a name="l00138"></a>00138 <span class="comment"></span>
<a name="l00139"></a>00139 <span class="comment">    Probes types for Digital Trace 4:</span>
<a name="l00140"></a>00140 <span class="comment">      ### Virtual Probes only for FW &gt;= 130.21 ###</span>
<a name="l00141"></a>00141 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE2_R22_OverThr</span>
<a name="l00142"></a>00142 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE2_R22_TrgVal</span>
<a name="l00143"></a>00143 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE2_R22_TrgHO</span>
<a name="l00144"></a>00144 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE2_R22_Coincidence</span>
<a name="l00145"></a>00145 <span class="comment">      ### Virtual Probes only for FW &lt;= 130.20 ###</span>
<a name="l00146"></a>00146 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE2_R22_OverThr</span>
<a name="l00147"></a>00147 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE2_R22_TrgVal</span>
<a name="l00148"></a>00148 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE2_R22_TrgHO</span>
<a name="l00149"></a>00149 <span class="comment">        CAEN_DGTZ_DPP_CI_DIGITALPROBE2_R22_Coincidence */</span> 
<a name="l00150"></a>00150     ret |= <a class="code" href="CAENDigitizer_8h.html#abedd909adbe9a541bdb28ccaddd2b1bf" title="Set the information about the output signal of the DPP-CI acquisition mode.">CAEN_DGTZ_SetDPP_CI_VirtualProbe</a>(<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, <a class="code" href="CAENDigitizerType_8h.html#a423214015fb3123849b1676868022328a283e9c0e9e7ec3892856fe7ec14314cd">CAEN_DGTZ_DPP_VIRTUALPROBE_SINGLE</a>, <a class="code" href="CAENDigitizerType_8h.html#aff47ca6c24342a0986640ff93b3e69a9a9a0026d703ee1a08fddc0cf99a154e2e">CAEN_DGTZ_DPP_CI_VIRTUALPROBE_Baseline</a>, <a class="code" href="CAENDigitizerType_8h.html#af9c4fa0027dbe423c087d275ae18d3d8ab97b62f5ade01c3d7e576a46a4a0f245">CAEN_DGTZ_DPP_CI_DIGITALPROBE1_BlOutSafeBand</a>, <a class="code" href="CAENDigitizerType_8h.html#ae017e804bf0497d24de2d4a7813f348aa630aef17a01bc2203dcf2b3b7826770e">CAEN_DGTZ_DPP_CI_DIGITALPROBE2_Tvaw</a>);
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (ret) {
<a name="l00152"></a>00152         printf(<span class="stringliteral">&quot;Warning: errors found during the programming of the digitizer.\nSome settings may not be executed\n&quot;</span>);
<a name="l00153"></a>00153         <span class="keywordflow">return</span> ret;
<a name="l00154"></a>00154     } <span class="keywordflow">else</span> {
<a name="l00155"></a>00155         <span class="keywordflow">return</span> 0;
<a name="l00156"></a>00156     }
<a name="l00157"></a>00157 }
</pre></div></p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ:Rootana by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
