<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ:Rootana: midas/NT/directio/directio.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>midas/NT/directio/directio.cpp</h1><a href="directio_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// Device driver for direct IO access</span>
<a name="l00002"></a>00002 <span class="comment">// under Windows NT 4.0, c&apos;t 1/97 Matthias Witthopf, Andreas Stiller</span>
<a name="l00003"></a>00003 <span class="comment">// Cyrix and PCI stuff removed, driver renamed to directIO, Stefan Ritt</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span>
<a name="l00006"></a>00006 {
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;ntddk.h&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;devioctl.h&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;conio.h&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="directio_8h.html">directio.h</a>&quot;</span>
<a name="l00013"></a>00013 }
<a name="l00014"></a>00014 
<a name="l00015"></a><a class="code" href="directio_8cpp.html#aeee0b04ba7ae605889816180dea6b5e1">00015</a> <span class="preprocessor">#define DIRECTIO_DEVICE_NAME L&quot;\\Device\\DirectIO&quot;</span>
<a name="l00016"></a><a class="code" href="directio_8cpp.html#a5fdfdac1c84d60a295f17a77c86e2aaf">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define DOS_DEVICE_NAME      L&quot;\\DosDevices\\DirectIO&quot;</span>
<a name="l00017"></a><a class="code" href="directio_8cpp.html#a3db0df1165fd78ebd0af2184562f090c">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define IOPM_SIZE 0x2000</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span>
<a name="l00019"></a><a class="code" href="directio_8cpp.html#a991e7b733595d596e6135412fee2fb9e">00019</a> <span class="keyword">typedef</span> <a class="code" href="jorway73a_8h.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> <a class="code" href="directio_8cpp.html#a991e7b733595d596e6135412fee2fb9e">IOPMTYP</a>[<a class="code" href="directio_8cpp.html#a3db0df1165fd78ebd0af2184562f090c">IOPM_SIZE</a>];
<a name="l00020"></a><a class="code" href="structTLocalDevInfo.html">00020</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00021"></a><a class="code" href="structTLocalDevInfo.html#ab2f5a2dabca072b7edc8aab80ad6b654">00021</a>   <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> Dummy;
<a name="l00022"></a><a class="code" href="structTLocalDevInfo.html#a39e77392ad0508dcc591841e47f2542c">00022</a>   <a class="code" href="directio_8cpp.html#a991e7b733595d596e6135412fee2fb9e">IOPMTYP</a> iopm;
<a name="l00023"></a>00023 } <a class="code" href="structTLocalDevInfo.html">TLocalDevInfo</a>,* <a class="code" href="structTLocalDevInfo.html">PLocalDevInfo</a>;
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="comment">// Structure of input parameters</span>
<a name="l00026"></a><a class="code" href="structTDirectIOInfo.html">00026</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00027"></a><a class="code" href="structTDirectIOInfo.html#a5649c5d707185f5f0be5c972ae79d5cb">00027</a>   <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> OpCode;
<a name="l00028"></a><a class="code" href="structTDirectIOInfo.html#aca7a5b63412d7271b53f1dfc682eac82">00028</a>   <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> Par1;
<a name="l00029"></a><a class="code" href="structTDirectIOInfo.html#aeff0991bb10a44b3c3650e12843f9363">00029</a>   <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> Par2;
<a name="l00030"></a><a class="code" href="structTDirectIOInfo.html#adc16bf2df90420647fd8ac5b06d3424c">00030</a>   <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> Par3;
<a name="l00031"></a>00031 } <a class="code" href="structTDirectIOInfo.html">TDirectIOInfo</a>,* <a class="code" href="structTDirectIOInfo.html">PDirectIOInfo</a>;
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> <a class="code" href="directio_8cpp.html#a3a5bebbfbed2de85811efafee942cda0">Ke386SetIoAccessMap</a>     (<span class="keywordtype">int</span>,<a class="code" href="directio_8cpp.html#a991e7b733595d596e6135412fee2fb9e">IOPMTYP</a>);
<a name="l00034"></a>00034 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> <a class="code" href="directio_8cpp.html#af1237e786d64eba11e72e4972cbc9a3e">Ke386QueryIoAccessMap</a>   (<span class="keywordtype">int</span>,<a class="code" href="directio_8cpp.html#a991e7b733595d596e6135412fee2fb9e">IOPMTYP</a>);
<a name="l00035"></a>00035 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> <a class="code" href="directio_8cpp.html#a20b32873ea8719ed16343a7babb67b39">Ke386IoSetAccessProcess</a> (PEPROCESS, <span class="keywordtype">int</span>);
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <a class="code" href="directio_8cpp.html#af2111fd920a760622ff0dddd8dd7e06f">__declspec</a>(dllimport)  <a class="code" href="directio_8cpp.html#aec7e62084419d7857ae740a4c68241cf">BOOLEAN</a> MmIsAddressValid  (IN <a class="code" href="PciTypes_8h.html#a2d95e4cb2ea675bb0e310e44cb81c549">PVOID</a> );
<a name="l00038"></a><a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">00038</a> <a class="code" href="directio_8cpp.html#af2111fd920a760622ff0dddd8dd7e06f">__declspec</a>(dllimport)  PVOID   MmMapIoSpace  (PHYSICAL_ADDRESS,<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>,<a class="code" href="directio_8cpp.html#aec7e62084419d7857ae740a4c68241cf">BOOLEAN</a>);
<a name="l00039"></a>00039 <a class="code" href="directio_8cpp.html#af2111fd920a760622ff0dddd8dd7e06f">__declspec</a>(dllimport)  <a class="code" href="PciTypes_8h.html#a7927e087749615dae3114cc27b91c86d">VOID</a>    MmUnmapIoSpace (PVOID,ULONG);
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="directio_8cpp.html#aff3daf378b9c7c0c98ad3013fe3dd2a6">00041</a> NTSTATUS <a class="code" href="directio_8cpp.html#aff3daf378b9c7c0c98ad3013fe3dd2a6">DirectIO_CreateDevice</a>(IN  PWSTR PrototypeName,
<a name="l00042"></a>00042     IN  DEVICE_TYPE DeviceType, IN  PDRIVER_OBJECT DriverObject,
<a name="l00043"></a>00043     OUT PDEVICE_OBJECT *ppDevObj)
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045   UNICODE_STRING NtDeviceName;
<a name="l00046"></a>00046   UNICODE_STRING Win32DeviceName;
<a name="l00047"></a>00047   RtlInitUnicodeString(&amp;NtDeviceName,PrototypeName);
<a name="l00048"></a>00048   NTSTATUS Status = IoCreateDevice(DriverObject,<span class="keyword">sizeof</span>(<a class="code" href="structTLocalDevInfo.html">TLocalDevInfo</a>),
<a name="l00049"></a>00049                             &amp;NtDeviceName,DeviceType,0,<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,ppDevObj);
<a name="l00050"></a>00050   <span class="keywordflow">if</span> (!NT_SUCCESS(Status)) <span class="keywordflow">return</span> Status;
<a name="l00051"></a>00051   RtlZeroMemory((*ppDevObj)-&gt;DeviceExtension,<span class="keyword">sizeof</span>(<a class="code" href="structTLocalDevInfo.html">TLocalDevInfo</a>));
<a name="l00052"></a>00052   RtlInitUnicodeString(&amp;Win32DeviceName,<a class="code" href="directio_8cpp.html#a5fdfdac1c84d60a295f17a77c86e2aaf">DOS_DEVICE_NAME</a>);
<a name="l00053"></a>00053   Status = IoCreateSymbolicLink(&amp;Win32DeviceName,&amp;NtDeviceName);
<a name="l00054"></a>00054   <span class="keywordflow">if</span> (!NT_SUCCESS(Status))
<a name="l00055"></a>00055     IoDeleteDevice(*ppDevObj);
<a name="l00056"></a>00056   <span class="keywordflow">return</span> Status;
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="directio_8cpp.html#a027b6c3dbe3c7bb4c01d5dff22fc9730">00059</a> <span class="keywordtype">void</span> <a class="code" href="directio_8cpp.html#a027b6c3dbe3c7bb4c01d5dff22fc9730">SetIOPermissionFree</a>(<span class="keywordtype">int</span> OnFlag,<span class="keywordtype">int</span> pstart,<span class="keywordtype">int</span> pend,<a class="code" href="directio_8cpp.html#a991e7b733595d596e6135412fee2fb9e">IOPMTYP</a> iopm)
<a name="l00060"></a>00060 {
<a name="l00061"></a>00061   <a class="code" href="directio_8cpp.html#af1237e786d64eba11e72e4972cbc9a3e">Ke386QueryIoAccessMap</a>(1,iopm);
<a name="l00062"></a>00062   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>=pstart; <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>&lt;=pend; <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>++)
<a name="l00063"></a>00063     iopm[<a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>/8] &amp;= ~(1 &lt;&lt; (<a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>%8));
<a name="l00064"></a>00064   <a class="code" href="directio_8cpp.html#a20b32873ea8719ed16343a7babb67b39">Ke386IoSetAccessProcess</a>(PsGetCurrentProcess(), OnFlag);
<a name="l00065"></a>00065   <a class="code" href="directio_8cpp.html#a3a5bebbfbed2de85811efafee942cda0">Ke386SetIoAccessMap</a> (1,iopm);
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="directio_8cpp.html#a58534199ea4e9902e1fc9f89479aba25">00068</a> <span class="keywordtype">void</span> <a class="code" href="directio_8cpp.html#a58534199ea4e9902e1fc9f89479aba25">SetIOPermissionLock</a>(<span class="keywordtype">int</span> OnFlag,<span class="keywordtype">int</span> pstart,<span class="keywordtype">int</span> pend,<a class="code" href="directio_8cpp.html#a991e7b733595d596e6135412fee2fb9e">IOPMTYP</a> iopm)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070   <a class="code" href="directio_8cpp.html#af1237e786d64eba11e72e4972cbc9a3e">Ke386QueryIoAccessMap</a>(1,iopm);
<a name="l00071"></a>00071   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>=pstart; <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>&lt;=pend; <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>++)
<a name="l00072"></a>00072     iopm[<a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>/8] |= (1 &lt;&lt; (<a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>%8));
<a name="l00073"></a>00073   <a class="code" href="directio_8cpp.html#a20b32873ea8719ed16343a7babb67b39">Ke386IoSetAccessProcess</a>(PsGetCurrentProcess(), OnFlag);
<a name="l00074"></a>00074   <a class="code" href="directio_8cpp.html#a3a5bebbfbed2de85811efafee942cda0">Ke386SetIoAccessMap</a> (1,iopm);
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="keyword">static</span> NTSTATUS
<a name="l00078"></a><a class="code" href="directio_8cpp.html#a5b487bafca9f2254363e80cf430bc59b">00078</a> <a class="code" href="directio_8cpp.html#a5b487bafca9f2254363e80cf430bc59b">ProbePCI</a>(<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> VendorID, <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> DeviceID, <a class="code" href="jorway73a_8h.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> *Irq, <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> *BaseAdr)
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080 PCI_SLOT_NUMBER     slotNumber;
<a name="l00081"></a>00081 PPCI_COMMON_CONFIG  pciData;
<a name="l00082"></a>00082 <a class="code" href="jorway73a_8h.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>               <a class="code" href="new__fadc0_8cpp.html#a1fe855c208bc17a51a4d34fefdb2d5b1">buf</a>[PCI_COMMON_HDR_LENGTH];
<a name="l00083"></a>00083 <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>               <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, f, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, bus;
<a name="l00084"></a>00084 <a class="code" href="directio_8cpp.html#aec7e62084419d7857ae740a4c68241cf">BOOLEAN</a>             <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086   pciData = (PPCI_COMMON_CONFIG) buf;
<a name="l00087"></a>00087   slotNumber.u.bits.Reserved = 0;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   flag = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00090"></a>00090   <span class="keywordflow">for</span> (bus = 0; flag; bus++)
<a name="l00091"></a>00091     {
<a name="l00092"></a>00092     <span class="keywordflow">for</span> (i = 0; i &lt; PCI_MAX_DEVICES  &amp;&amp;  flag; i++)
<a name="l00093"></a>00093       {
<a name="l00094"></a>00094       slotNumber.u.bits.DeviceNumber = i;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096       <span class="keywordflow">for</span> (f = 0; f &lt; PCI_MAX_FUNCTION; f++)
<a name="l00097"></a>00097         {
<a name="l00098"></a>00098         slotNumber.u.bits.FunctionNumber = f;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         j = HalGetBusData(PCIConfiguration, bus, slotNumber.u.AsULONG,
<a name="l00101"></a>00101                           pciData, PCI_COMMON_HDR_LENGTH);
<a name="l00102"></a>00102 
<a name="l00103"></a>00103         <span class="keywordflow">if</span> (j == 0)
<a name="l00104"></a>00104           {
<a name="l00105"></a>00105           <span class="comment">/* out of buses */</span>
<a name="l00106"></a>00106           flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00107"></a>00107           <span class="keywordflow">break</span>;
<a name="l00108"></a>00108           }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <span class="keywordflow">if</span> (pciData-&gt;VendorID == PCI_INVALID_VENDORID)
<a name="l00111"></a>00111           {
<a name="l00112"></a>00112           <span class="comment">/* skip to next slot */</span>
<a name="l00113"></a>00113           <span class="keywordflow">break</span>;
<a name="l00114"></a>00114           }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="comment">/* check for vendor and device id, return base address */</span>
<a name="l00117"></a>00117         <span class="keywordflow">if</span> (pciData-&gt;VendorID == VendorID &amp;&amp; pciData-&gt;DeviceID == DeviceID)
<a name="l00118"></a>00118           {
<a name="l00119"></a>00119           *Irq       = pciData-&gt;u.type0.InterruptLine;
<a name="l00120"></a>00120           BaseAdr[0] = pciData-&gt;u.type0.BaseAddresses[0];
<a name="l00121"></a>00121           BaseAdr[1] = pciData-&gt;u.type0.BaseAddresses[1];
<a name="l00122"></a>00122           BaseAdr[2] = pciData-&gt;u.type0.BaseAddresses[2];
<a name="l00123"></a>00123           BaseAdr[3] = pciData-&gt;u.type0.BaseAddresses[3];
<a name="l00124"></a>00124           BaseAdr[4] = pciData-&gt;u.type0.BaseAddresses[4];
<a name="l00125"></a>00125           BaseAdr[5] = pciData-&gt;u.type0.BaseAddresses[5];
<a name="l00126"></a>00126           <span class="keywordflow">return</span> STATUS_SUCCESS;
<a name="l00127"></a>00127           }
<a name="l00128"></a>00128         }
<a name="l00129"></a>00129       }
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132   <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a><a class="code" href="directio_8cpp.html#a253cf0c19d0efce7cd03e96d6c2790b4">00135</a> NTSTATUS <a class="code" href="directio_8cpp.html#a253cf0c19d0efce7cd03e96d6c2790b4">DirectIO_Control</a>(IN PLocalDevInfo pLDI, IN PIRP pIrp,
<a name="l00136"></a>00136    IN PIO_STACK_LOCATION IrpStack, IN <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> IoctlCode)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138   PDirectIOInfo InBuf=(PDirectIOInfo)pIrp-&gt;AssociatedIrp.SystemBuffer;
<a name="l00139"></a>00139   <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> InBufSize=IrpStack-&gt;Parameters.DeviceIoControl.InputBufferLength;
<a name="l00140"></a>00140   <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> OpCode=InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#a5649c5d707185f5f0be5c972ae79d5cb">OpCode</a>;
<a name="l00141"></a>00141   <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, BaseAdr[6];
<a name="l00142"></a>00142   <a class="code" href="jorway73a_8h.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a> Irq;
<a name="l00143"></a>00143   <span class="keywordtype">void</span> *OutBuf=(<span class="keywordtype">void</span> *)pIrp-&gt;AssociatedIrp.SystemBuffer;
<a name="l00144"></a>00144   <a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a> OutBufSize=IrpStack-&gt;Parameters.DeviceIoControl.OutputBufferLength;
<a name="l00145"></a>00145   <a class="code" href="PciTypes_8h.html#a2d95e4cb2ea675bb0e310e44cb81c549">PVOID</a> Linadr;
<a name="l00146"></a>00146   PHYSICAL_ADDRESS PADDR;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148   <span class="keywordflow">switch</span>(OpCode) {
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   <span class="keywordflow">case</span> <a class="code" href="directio_8h.html#a9d7851c437f4f392064226d6755bdafc">OP_Check</a>:
<a name="l00151"></a>00151     *(PULONG)OutBuf = 0x12345678;
<a name="l00152"></a>00152     pIrp-&gt;IoStatus.Information = <span class="keyword">sizeof</span>(<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>);
<a name="l00153"></a>00153     <span class="keywordflow">return</span> STATUS_SUCCESS;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155   <span class="keywordflow">case</span> <a class="code" href="directio_8h.html#acdad785de1175169763340d6a1b8c6f7">OP_GiveIO</a>:
<a name="l00156"></a>00156     <a class="code" href="directio_8cpp.html#a027b6c3dbe3c7bb4c01d5dff22fc9730">SetIOPermissionFree</a>(1,InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aca7a5b63412d7271b53f1dfc682eac82">Par1</a>,InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aeff0991bb10a44b3c3650e12843f9363">Par2</a>,pLDI-&gt;iopm);
<a name="l00157"></a>00157     pIrp-&gt;IoStatus.Information = 0;
<a name="l00158"></a>00158     <span class="keywordflow">return</span> STATUS_SUCCESS;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160   <span class="keywordflow">case</span> <a class="code" href="directio_8h.html#a200ed8721ca37137176f545d20af475f">OP_LockIO</a>:
<a name="l00161"></a>00161     <a class="code" href="directio_8cpp.html#a58534199ea4e9902e1fc9f89479aba25">SetIOPermissionLock</a>(1,InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aca7a5b63412d7271b53f1dfc682eac82">Par1</a>,InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aeff0991bb10a44b3c3650e12843f9363">Par2</a>,pLDI-&gt;iopm);
<a name="l00162"></a>00162     pIrp-&gt;IoStatus.Information = 0;
<a name="l00163"></a>00163     <span class="keywordflow">return</span> STATUS_SUCCESS;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165   <span class="keywordflow">case</span> <a class="code" href="directio_8h.html#ae9cc0d7e162cb602395d94b4e7909333">OP_ReadPortByte</a>:
<a name="l00166"></a>00166     *(PUCHAR)OutBuf = READ_PORT_UCHAR((PUCHAR)InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aca7a5b63412d7271b53f1dfc682eac82">Par1</a>);
<a name="l00167"></a>00167     pIrp-&gt;IoStatus.Information = <span class="keyword">sizeof</span>(<a class="code" href="jorway73a_8h.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>);
<a name="l00168"></a>00168     <span class="keywordflow">return</span> STATUS_SUCCESS;
<a name="l00169"></a>00169 
<a name="l00170"></a>00170   <span class="keywordflow">case</span> <a class="code" href="directio_8h.html#a9c215b3034f0042d9afe33544f2bdc89">OP_WritePortByte</a>:
<a name="l00171"></a>00171     WRITE_PORT_UCHAR((PUCHAR)InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aca7a5b63412d7271b53f1dfc682eac82">Par1</a>,(<a class="code" href="jorway73a_8h.html#a4f4bb67531a9bf6f0b9c6ad76aeba587">UCHAR</a>)InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aeff0991bb10a44b3c3650e12843f9363">Par2</a>);
<a name="l00172"></a>00172     pIrp-&gt;IoStatus.Information = 0;
<a name="l00173"></a>00173     <span class="keywordflow">return</span> STATUS_SUCCESS;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment">/*  case OP_ReadMemDword:</span>
<a name="l00176"></a>00176 <span class="comment"></span>
<a name="l00177"></a>00177 <span class="comment">  if (MmIsAddressValid)</span>
<a name="l00178"></a>00178 <span class="comment">     {</span>
<a name="l00179"></a>00179 <span class="comment">     *(PULONG)OutBuf = *(ULONG*) (InBuf-&gt;Par1);</span>
<a name="l00180"></a>00180 <span class="comment">     pIrp-&gt;IoStatus.Information = sizeof(ULONG);</span>
<a name="l00181"></a>00181 <span class="comment">     return STATUS_SUCCESS;</span>
<a name="l00182"></a>00182 <span class="comment">   }</span>
<a name="l00183"></a>00183 <span class="comment">  else</span>
<a name="l00184"></a>00184 <span class="comment">   {</span>
<a name="l00185"></a>00185 <span class="comment">   pIrp-&gt;IoStatus.Information = 0;</span>
<a name="l00186"></a>00186 <span class="comment">     return STATUS_ACCESS_VIOLATION;</span>
<a name="l00187"></a>00187 <span class="comment">     }</span>
<a name="l00188"></a>00188 <span class="comment">*/</span>
<a name="l00189"></a>00189   <span class="keywordflow">case</span> <a class="code" href="directio_8h.html#a2fdb728769578c0f15f945c51650f4f0">OP_ReadPhysMemDword</a>:
<a name="l00190"></a>00190     PADDR.LowPart=(<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>) (InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aca7a5b63412d7271b53f1dfc682eac82">Par1</a>);
<a name="l00191"></a>00191     PADDR.HighPart=0;         <span class="comment">// Reserve für &gt; 4GByte</span>
<a name="l00192"></a>00192     Linadr=MmMapIoSpace (PADDR,4,MmNonCached);
<a name="l00193"></a>00193     *(PULONG)OutBuf = *(<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>*) Linadr;
<a name="l00194"></a>00194     MmUnmapIoSpace (Linadr,4);
<a name="l00195"></a>00195     pIrp-&gt;IoStatus.Information = <span class="keyword">sizeof</span>(<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>);
<a name="l00196"></a>00196     <span class="keywordflow">return</span> STATUS_SUCCESS;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198   <span class="keywordflow">case</span> <a class="code" href="directio_8h.html#a04e863bc82c2083259b246547c54e393">OP_WritePhysMemDword</a>:
<a name="l00199"></a>00199     PADDR.LowPart=(<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>) (InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aca7a5b63412d7271b53f1dfc682eac82">Par1</a>);
<a name="l00200"></a>00200     PADDR.HighPart=0;         <span class="comment">// Reserve für &gt; 4GByte</span>
<a name="l00201"></a>00201     Linadr=MmMapIoSpace (PADDR,4,MmNonCached);
<a name="l00202"></a>00202     *(<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>*) Linadr = *(PULONG)InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aeff0991bb10a44b3c3650e12843f9363">Par2</a>;
<a name="l00203"></a>00203     MmUnmapIoSpace (Linadr,4);
<a name="l00204"></a>00204     pIrp-&gt;IoStatus.Information = <span class="keyword">sizeof</span>(<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>);
<a name="l00205"></a>00205     <span class="keywordflow">return</span> STATUS_SUCCESS;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="keywordflow">case</span> <a class="code" href="directio_8h.html#a473606b2a0ac0d1938260da1faf25f7b">OP_PCIInfo</a>:
<a name="l00208"></a>00208     status = <a class="code" href="directio_8cpp.html#a5b487bafca9f2254363e80cf430bc59b">ProbePCI</a>(InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aca7a5b63412d7271b53f1dfc682eac82">Par1</a>, InBuf-&gt;<a class="code" href="structTDirectIOInfo.html#aeff0991bb10a44b3c3650e12843f9363">Par2</a>, &amp;Irq, BaseAdr);
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (status == STATUS_NO_SUCH_DEVICE)
<a name="l00210"></a>00210       pIrp-&gt;IoStatus.Information = 0;
<a name="l00211"></a>00211     <span class="keywordflow">else</span>
<a name="l00212"></a>00212       {
<a name="l00213"></a>00213       DbgPrint(<span class="stringliteral">&quot;DirectIO: BaseAdr0 = %X\n&quot;</span>, BaseAdr[0]);
<a name="l00214"></a>00214       DbgPrint(<span class="stringliteral">&quot;DirectIO: BaseAdr1 = %X\n&quot;</span>, BaseAdr[1]);
<a name="l00215"></a>00215       *(PULONG)OutBuf = (<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>)Irq;
<a name="l00216"></a>00216       *((PULONG)OutBuf+1) = BaseAdr[0];
<a name="l00217"></a>00217       *((PULONG)OutBuf+2) = BaseAdr[1];
<a name="l00218"></a>00218       *((PULONG)OutBuf+3) = BaseAdr[2];
<a name="l00219"></a>00219       *((PULONG)OutBuf+4) = BaseAdr[3];
<a name="l00220"></a>00220       *((PULONG)OutBuf+5) = BaseAdr[4];
<a name="l00221"></a>00221       *((PULONG)OutBuf+6) = BaseAdr[5];
<a name="l00222"></a>00222       pIrp-&gt;IoStatus.Information = 7*<span class="keyword">sizeof</span>(<a class="code" href="directio_8cpp.html#a6b1d94bcd9123a6d01d2d28b8ec5e25e">ULONG</a>);
<a name="l00223"></a>00223       }
<a name="l00224"></a>00224     <span class="keywordflow">return</span> STATUS_SUCCESS;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 
<a name="l00227"></a>00227   }
<a name="l00228"></a>00228   <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 
<a name="l00233"></a><a class="code" href="directio_8cpp.html#a85c8204286603adc8bd1a7f45703ecda">00233</a> NTSTATUS <a class="code" href="directio_8cpp.html#a85c8204286603adc8bd1a7f45703ecda">DirectIO_Dispatch</a>(IN PDEVICE_OBJECT pDO,IN PIRP pIrp)
<a name="l00234"></a>00234 {
<a name="l00235"></a>00235   pIrp-&gt;IoStatus.Information = 0;  <span class="comment">// Anzahl Rückgabe-Bytes</span>
<a name="l00236"></a>00236   PLocalDevInfo      pLDI      = (PLocalDevInfo)pDO-&gt;DeviceExtension;
<a name="l00237"></a>00237   PIO_STACK_LOCATION pIrpStack = IoGetCurrentIrpStackLocation(pIrp);
<a name="l00238"></a>00238   NTSTATUS           Status    = STATUS_NOT_IMPLEMENTED;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240   <span class="keywordflow">switch</span>(pIrpStack-&gt;MajorFunction) {
<a name="l00241"></a>00241   <span class="keywordflow">case</span> IRP_MJ_CREATE:
<a name="l00242"></a>00242   <span class="keywordflow">case</span> IRP_MJ_CLOSE:
<a name="l00243"></a>00243     Status = STATUS_SUCCESS;
<a name="l00244"></a>00244     <span class="keywordflow">break</span>;
<a name="l00245"></a>00245   <span class="keywordflow">case</span> IRP_MJ_DEVICE_CONTROL:
<a name="l00246"></a>00246     <span class="keywordflow">switch</span>(pIrpStack-&gt;Parameters.DeviceIoControl.IoControlCode) {
<a name="l00247"></a>00247       <span class="keywordflow">case</span> <a class="code" href="directio_8h.html#aa2d8015f5c619bdfce5b8fff9b135e2a">IOCTL_DIRECTIO_CONTROL</a>:
<a name="l00248"></a>00248         Status = <a class="code" href="directio_8cpp.html#a253cf0c19d0efce7cd03e96d6c2790b4">DirectIO_Control</a>(pLDI,pIrp,pIrpStack,
<a name="l00249"></a>00249           pIrpStack-&gt;Parameters.DeviceIoControl.IoControlCode);
<a name="l00250"></a>00250         <span class="keywordflow">break</span>;
<a name="l00251"></a>00251       }
<a name="l00252"></a>00252     <span class="keywordflow">break</span>;
<a name="l00253"></a>00253   }
<a name="l00254"></a>00254   pIrp-&gt;IoStatus.Status = Status;
<a name="l00255"></a>00255   IoCompleteRequest(pIrp,IO_NO_INCREMENT);
<a name="l00256"></a>00256   <span class="keywordflow">return</span> Status;
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a><a class="code" href="directio_8cpp.html#a19cc6b8c85320e70003bca4b5827e334">00259</a> <a class="code" href="PciTypes_8h.html#a7927e087749615dae3114cc27b91c86d">VOID</a> <a class="code" href="directio_8cpp.html#a19cc6b8c85320e70003bca4b5827e334">DirectIO_Unload</a>(PDRIVER_OBJECT DriverObject)
<a name="l00260"></a>00260 { <span class="comment">// Symbolischen Link wieder auflösen</span>
<a name="l00261"></a>00261   UNICODE_STRING Win32DeviceName;
<a name="l00262"></a>00262   RtlInitUnicodeString(&amp;Win32DeviceName,<a class="code" href="directio_8cpp.html#a5fdfdac1c84d60a295f17a77c86e2aaf">DOS_DEVICE_NAME</a>);
<a name="l00263"></a>00263   IoDeleteSymbolicLink(&amp;Win32DeviceName);
<a name="l00264"></a>00264   IoDeleteDevice(DriverObject-&gt;DeviceObject);
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="directio_8cpp.html#a6502d781bd20234a06710b92d540baba">00267</a> <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> NTSTATUS <a class="code" href="directio_8cpp.html#a6502d781bd20234a06710b92d540baba">DriverEntry</a>(IN PDRIVER_OBJECT DriverObject,
<a name="l00268"></a>00268                                 IN PUNICODE_STRING RegistryPath)
<a name="l00269"></a>00269 { <span class="comment">// Symbolischen Link erzeugen, so daß Win32 darauf zugreifen kann</span>
<a name="l00270"></a>00270   DriverObject-&gt;MajorFunction[IRP_MJ_CREATE]         = <a class="code" href="directio_8cpp.html#a85c8204286603adc8bd1a7f45703ecda">DirectIO_Dispatch</a>;
<a name="l00271"></a>00271   DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE]          = <a class="code" href="directio_8cpp.html#a85c8204286603adc8bd1a7f45703ecda">DirectIO_Dispatch</a>;
<a name="l00272"></a>00272   DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = <a class="code" href="directio_8cpp.html#a85c8204286603adc8bd1a7f45703ecda">DirectIO_Dispatch</a>;
<a name="l00273"></a>00273   DriverObject-&gt;DriverUnload                         = <a class="code" href="directio_8cpp.html#a19cc6b8c85320e70003bca4b5827e334">DirectIO_Unload</a>;
<a name="l00274"></a>00274   PDEVICE_OBJECT DeviceObject;
<a name="l00275"></a>00275   <span class="keywordflow">return</span> <a class="code" href="directio_8cpp.html#aff3daf378b9c7c0c98ad3013fe3dd2a6">DirectIO_CreateDevice</a>(<a class="code" href="directio_8cpp.html#aeee0b04ba7ae605889816180dea6b5e1">DIRECTIO_DEVICE_NAME</a>, <a class="code" href="directio_8h.html#aa15ecb3ad0a15ee7906597fed4ba25bf">DIRECTIO_TYPE</a>,
<a name="l00276"></a>00276                                DriverObject,&amp;DeviceObject);
<a name="l00277"></a>00277 }
<a name="l00278"></a>00278 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ:Rootana by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
