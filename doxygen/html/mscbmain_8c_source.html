<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ:Rootana: midas/mscb/embedded/mscbmain.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>midas/mscb/embedded/mscbmain.c</h1><a href="mscbmain_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Name:         mscbmain.c</span>
<a name="l00004"></a>00004 <span class="comment">  Created by:   Stefan Ritt</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Contents:     Midas Slow Control Bus protocol main program</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">  $Log: mscbmain.c,v $</span>
<a name="l00009"></a>00009 <span class="comment">  Revision 1.1.1.1  2005/06/20 23:37:17  mucap</span>
<a name="l00010"></a>00010 <span class="comment">  Importing release 1.9.5 of the MIDAS source code as distributed by PSI.</span>
<a name="l00011"></a>00011 <span class="comment">  (Next, I&apos;ll commit our local customizations.)</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment">  Revision 1.54  2004/09/25 01:14:54  midas</span>
<a name="l00014"></a>00014 <span class="comment">  Started implementing slave port on SCS-1000</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">  Revision 1.53  2004/09/10 12:27:22  midas</span>
<a name="l00017"></a>00017 <span class="comment">  Version 1.7.5</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">  Revision 1.52  2004/07/20 16:04:40  midas</span>
<a name="l00020"></a>00020 <span class="comment">  Implemented scs-1000 code</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">  Revision 1.51  2004/07/09 07:47:48  midas</span>
<a name="l00023"></a>00023 <span class="comment">  Implemented xdata checking</span>
<a name="l00024"></a>00024 <span class="comment"></span>
<a name="l00025"></a>00025 <span class="comment">  Revision 1.50  2004/07/08 11:15:46  midas</span>
<a name="l00026"></a>00026 <span class="comment">  Implemented flash protection</span>
<a name="l00027"></a>00027 <span class="comment"></span>
<a name="l00028"></a>00028 <span class="comment">  Revision 1.49  2004/06/09 12:27:12  midas</span>
<a name="l00029"></a>00029 <span class="comment">  Made output buffer smaller</span>
<a name="l00030"></a>00030 <span class="comment"></span>
<a name="l00031"></a>00031 <span class="comment">  Revision 1.48  2004/06/09 11:25:01  midas</span>
<a name="l00032"></a>00032 <span class="comment">  Changed blinking</span>
<a name="l00033"></a>00033 <span class="comment"></span>
<a name="l00034"></a>00034 <span class="comment">  Revision 1.47  2004/06/02 08:18:58  midas</span>
<a name="l00035"></a>00035 <span class="comment">  Fixed bug with F021 CPU</span>
<a name="l00036"></a>00036 <span class="comment"></span>
<a name="l00037"></a>00037 <span class="comment">  Revision 1.46  2004/05/19 15:10:59  midas</span>
<a name="l00038"></a>00038 <span class="comment">  Avoid flashing directly after watchdog reset</span>
<a name="l00039"></a>00039 <span class="comment"></span>
<a name="l00040"></a>00040 <span class="comment">  Revision 1.45  2004/05/18 14:16:39  midas</span>
<a name="l00041"></a>00041 <span class="comment">  Do watchdog disable first in setup()</span>
<a name="l00042"></a>00042 <span class="comment"></span>
<a name="l00043"></a>00043 <span class="comment">  Revision 1.44  2004/04/30 08:00:53  midas</span>
<a name="l00044"></a>00044 <span class="comment">  LED only blinks on writing</span>
<a name="l00045"></a>00045 <span class="comment"></span>
<a name="l00046"></a>00046 <span class="comment">  Revision 1.43  2004/04/07 11:06:17  midas</span>
<a name="l00047"></a>00047 <span class="comment">  Version 1.7.1</span>
<a name="l00048"></a>00048 <span class="comment"></span>
<a name="l00049"></a>00049 <span class="comment">  Revision 1.42  2004/03/19 12:09:06  midas</span>
<a name="l00050"></a>00050 <span class="comment">  Upload with simplified CRC</span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">  Revision 1.41  2004/03/19 08:15:29  midas</span>
<a name="l00053"></a>00053 <span class="comment">  Moved upgrade &amp; co to yield()</span>
<a name="l00054"></a>00054 <span class="comment"></span>
<a name="l00055"></a>00055 <span class="comment">  Revision 1.40  2004/03/09 15:37:09  midas</span>
<a name="l00056"></a>00056 <span class="comment">  Fixed problems with small strings</span>
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 <span class="comment">  Revision 1.39  2004/03/05 12:29:00  midas</span>
<a name="l00059"></a>00059 <span class="comment">  Fixed bugs with F020</span>
<a name="l00060"></a>00060 <span class="comment"></span>
<a name="l00061"></a>00061 <span class="comment">  Revision 1.38  2004/03/04 15:27:52  midas</span>
<a name="l00062"></a>00062 <span class="comment">  Download with ACK after 60 bytes</span>
<a name="l00063"></a>00063 <span class="comment"></span>
<a name="l00064"></a>00064 <span class="comment">  Revision 1.37  2004/02/24 13:30:21  midas</span>
<a name="l00065"></a>00065 <span class="comment">  Implemented C8051F310 code</span>
<a name="l00066"></a>00066 <span class="comment"></span>
<a name="l00067"></a>00067 <span class="comment">  Revision 1.36  2004/01/07 12:56:15  midas</span>
<a name="l00068"></a>00068 <span class="comment">  Chaned line length</span>
<a name="l00069"></a>00069 <span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">  Revision 1.35  2004/01/07 12:52:23  midas</span>
<a name="l00071"></a>00071 <span class="comment">  Changed indentation</span>
<a name="l00072"></a>00072 <span class="comment"></span>
<a name="l00073"></a>00073 <span class="comment">  Revision 1.34  2003/06/27 13:52:07  midas</span>
<a name="l00074"></a>00074 <span class="comment">  Added missing clock reset</span>
<a name="l00075"></a>00075 <span class="comment"></span>
<a name="l00076"></a>00076 <span class="comment">  Revision 1.33  2003/06/05 14:47:25  midas</span>
<a name="l00077"></a>00077 <span class="comment">  Added SCS-520</span>
<a name="l00078"></a>00078 <span class="comment"></span>
<a name="l00079"></a>00079 <span class="comment">  Revision 1.32  2003/03/28 07:43:57  midas</span>
<a name="l00080"></a>00080 <span class="comment">  Removed delay_ms(0)</span>
<a name="l00081"></a>00081 <span class="comment"></span>
<a name="l00082"></a>00082 <span class="comment">  Revision 1.31  2003/03/24 15:00:31  midas</span>
<a name="l00083"></a>00083 <span class="comment">  Implemented 16-bit magic at end of EEPROM data</span>
<a name="l00084"></a>00084 <span class="comment"></span>
<a name="l00085"></a>00085 <span class="comment">  Revision 1.30  2003/03/23 10:20:43  midas</span>
<a name="l00086"></a>00086 <span class="comment">  Added LCD_SUPPORT flag</span>
<a name="l00087"></a>00087 <span class="comment"></span>
<a name="l00088"></a>00088 <span class="comment">  Revision 1.29  2003/03/21 08:28:15  midas</span>
<a name="l00089"></a>00089 <span class="comment">  Fixed bug with LSB bytes</span>
<a name="l00090"></a>00090 <span class="comment"></span>
<a name="l00091"></a>00091 <span class="comment">  Revision 1.28  2003/03/19 16:35:03  midas</span>
<a name="l00092"></a>00092 <span class="comment">  Eliminated configuration parameters</span>
<a name="l00093"></a>00093 <span class="comment"></span>
<a name="l00094"></a>00094 <span class="comment">  Revision 1.27  2003/03/14 13:47:54  midas</span>
<a name="l00095"></a>00095 <span class="comment">  Added SCS_310 code</span>
<a name="l00096"></a>00096 <span class="comment"></span>
<a name="l00097"></a>00097 <span class="comment">  Revision 1.26  2003/03/06 16:08:50  midas</span>
<a name="l00098"></a>00098 <span class="comment">  Protocol version 1.3 (change node name)</span>
<a name="l00099"></a>00099 <span class="comment"></span>
<a name="l00100"></a>00100 <span class="comment">  Revision 1.25  2003/03/06 11:01:13  midas</span>
<a name="l00101"></a>00101 <span class="comment">  Priority inversion for slow ADuC</span>
<a name="l00102"></a>00102 <span class="comment"></span>
<a name="l00103"></a>00103 <span class="comment">  Revision 1.24  2003/02/19 16:21:35  midas</span>
<a name="l00104"></a>00104 <span class="comment">  Fixed bug with conf_param</span>
<a name="l00105"></a>00105 <span class="comment"></span>
<a name="l00106"></a>00106 <span class="comment">  Revision 1.23  2003/02/19 16:04:50  midas</span>
<a name="l00107"></a>00107 <span class="comment">  Added code for ADuC812</span>
<a name="l00108"></a>00108 <span class="comment"></span>
<a name="l00109"></a>00109 <span class="comment">  Revision 1.22  2003/01/16 16:34:07  midas</span>
<a name="l00110"></a>00110 <span class="comment">  Do not use printf() for scs_210/300</span>
<a name="l00111"></a>00111 <span class="comment"></span>
<a name="l00112"></a>00112 <span class="comment">  Revision 1.21  2002/11/29 08:02:52  midas</span>
<a name="l00113"></a>00113 <span class="comment">  Fixed linux warnings</span>
<a name="l00114"></a>00114 <span class="comment"></span>
<a name="l00115"></a>00115 <span class="comment">  Revision 1.20  2002/11/28 14:44:02  midas</span>
<a name="l00116"></a>00116 <span class="comment">  Removed SIZE_XBIT</span>
<a name="l00117"></a>00117 <span class="comment"></span>
<a name="l00118"></a>00118 <span class="comment">  Revision 1.19  2002/11/28 13:03:41  midas</span>
<a name="l00119"></a>00119 <span class="comment">  Protocol version 1.2</span>
<a name="l00120"></a>00120 <span class="comment"></span>
<a name="l00121"></a>00121 <span class="comment">  Revision 1.18  2002/11/22 15:43:03  midas</span>
<a name="l00122"></a>00122 <span class="comment">  Made user_write reentrant</span>
<a name="l00123"></a>00123 <span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment">  Revision 1.17  2002/11/20 12:02:25  midas</span>
<a name="l00125"></a>00125 <span class="comment">  Fixed bug with secondary LED</span>
<a name="l00126"></a>00126 <span class="comment"></span>
<a name="l00127"></a>00127 <span class="comment">  Revision 1.16  2002/11/06 16:45:42  midas</span>
<a name="l00128"></a>00128 <span class="comment">  Revised LED blinking scheme</span>
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="comment">  Revision 1.15  2002/10/16 15:24:12  midas</span>
<a name="l00131"></a>00131 <span class="comment">  Fixed bug for reboot</span>
<a name="l00132"></a>00132 <span class="comment"></span>
<a name="l00133"></a>00133 <span class="comment">  Revision 1.14  2002/10/09 15:48:13  midas</span>
<a name="l00134"></a>00134 <span class="comment">  Fixed bug with download</span>
<a name="l00135"></a>00135 <span class="comment"></span>
<a name="l00136"></a>00136 <span class="comment">  Revision 1.13  2002/10/09 11:06:46  midas</span>
<a name="l00137"></a>00137 <span class="comment">  Protocol version 1.1</span>
<a name="l00138"></a>00138 <span class="comment"></span>
<a name="l00139"></a>00139 <span class="comment">  Revision 1.12  2002/10/07 15:16:32  midas</span>
<a name="l00140"></a>00140 <span class="comment">  Added upgrade facility</span>
<a name="l00141"></a>00141 <span class="comment"></span>
<a name="l00142"></a>00142 <span class="comment">  Revision 1.11  2002/10/04 09:03:20  midas</span>
<a name="l00143"></a>00143 <span class="comment">  Small mods for scs_300</span>
<a name="l00144"></a>00144 <span class="comment"></span>
<a name="l00145"></a>00145 <span class="comment">  Revision 1.10  2002/10/03 15:31:53  midas</span>
<a name="l00146"></a>00146 <span class="comment">  Various modifications</span>
<a name="l00147"></a>00147 <span class="comment"></span>
<a name="l00148"></a>00148 <span class="comment">  Revision 1.9  2002/08/12 12:12:28  midas</span>
<a name="l00149"></a>00149 <span class="comment">  Added zero padding</span>
<a name="l00150"></a>00150 <span class="comment"></span>
<a name="l00151"></a>00151 <span class="comment">  Revision 1.8  2002/08/08 06:46:15  midas</span>
<a name="l00152"></a>00152 <span class="comment">  Added time functions</span>
<a name="l00153"></a>00153 <span class="comment"></span>
<a name="l00154"></a>00154 <span class="comment">  Revision 1.7  2002/07/12 15:19:01  midas</span>
<a name="l00155"></a>00155 <span class="comment">  Call user_init before blinking</span>
<a name="l00156"></a>00156 <span class="comment"></span>
<a name="l00157"></a>00157 <span class="comment">  Revision 1.6  2002/07/12 08:38:13  midas</span>
<a name="l00158"></a>00158 <span class="comment">  Fixed LCD recognition</span>
<a name="l00159"></a>00159 <span class="comment"></span>
<a name="l00160"></a>00160 <span class="comment">  Revision 1.5  2002/07/10 09:52:55  midas</span>
<a name="l00161"></a>00161 <span class="comment">  Finished EEPROM routines</span>
<a name="l00162"></a>00162 <span class="comment"></span>
<a name="l00163"></a>00163 <span class="comment">  Revision 1.4  2002/07/09 15:31:32  midas</span>
<a name="l00164"></a>00164 <span class="comment">  Initial Revision</span>
<a name="l00165"></a>00165 <span class="comment"></span>
<a name="l00166"></a>00166 <span class="comment">  Revision 1.3  2002/07/08 08:51:39  midas</span>
<a name="l00167"></a>00167 <span class="comment">  Test eeprom functions</span>
<a name="l00168"></a>00168 <span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">  Revision 1.2  2002/07/05 15:27:28  midas</span>
<a name="l00170"></a>00170 <span class="comment">  *** empty log message ***</span>
<a name="l00171"></a>00171 <span class="comment"></span>
<a name="l00172"></a>00172 <span class="comment">  Revision 1.1  2002/07/05 08:12:46  midas</span>
<a name="l00173"></a>00173 <span class="comment">  Moved files</span>
<a name="l00174"></a>00174 <span class="comment"></span>
<a name="l00175"></a>00175 <span class="comment">\********************************************************************/</span>
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00178"></a>00178 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00179"></a>00179 <span class="preprocessor">#include &quot;<a class="code" href="mscb_8h.html">mscb.h</a>&quot;</span>
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 <span class="comment">/* GET_INFO attributes */</span>
<a name="l00182"></a><a class="code" href="mscbmain_8c.html#ab6eca6d80493459ef820e5918f9b7f32">00182</a> <span class="preprocessor">#define GET_INFO_GENERAL  0</span>
<a name="l00183"></a><a class="code" href="mscbmain_8c.html#a6de404b0f42a3de05c06b841a6984cb6">00183</a> <span class="preprocessor"></span><span class="preprocessor">#define GET_INFO_VARIABLE 1</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>
<a name="l00185"></a>00185 <span class="comment">/* Variable attributes */</span>
<a name="l00186"></a><a class="code" href="mscbmain_8c.html#ad4f64b59ea90ca19e9543e8e93082be7">00186</a> <span class="preprocessor">#define SIZE_8BIT         1</span>
<a name="l00187"></a><a class="code" href="mscbmain_8c.html#a90ff9d40a5f4d718bf45a060020f5253">00187</a> <span class="preprocessor"></span><span class="preprocessor">#define SIZE_16BIT        2</span>
<a name="l00188"></a><a class="code" href="mscbmain_8c.html#a37a9ce8510a45f7a45c17329ed94df7f">00188</a> <span class="preprocessor"></span><span class="preprocessor">#define SIZE_24BIT        3</span>
<a name="l00189"></a><a class="code" href="mscbmain_8c.html#a8070581098c5eba2b23e0061f90ff6ac">00189</a> <span class="preprocessor"></span><span class="preprocessor">#define SIZE_32BIT        4</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span>
<a name="l00191"></a>00191 <span class="comment">/* Address modes */</span>
<a name="l00192"></a><a class="code" href="mscbmain_8c.html#ac5c08a68afed90bb2c9a8f573c07b17f">00192</a> <span class="preprocessor">#define ADDR_NONE         0</span>
<a name="l00193"></a><a class="code" href="mscbmain_8c.html#a50350e704ee0286112a55b50ac65eb29">00193</a> <span class="preprocessor"></span><span class="preprocessor">#define ADDR_NODE         1</span>
<a name="l00194"></a><a class="code" href="mscbmain_8c.html#aa6482f1b072b3f59e9def8ebca00ac8d">00194</a> <span class="preprocessor"></span><span class="preprocessor">#define ADDR_GROUP        2</span>
<a name="l00195"></a><a class="code" href="mscbmain_8c.html#a83ed7cc9f4f8cd24a00c25acd4a1ccfb">00195</a> <span class="preprocessor"></span><span class="preprocessor">#define ADDR_ALL          3</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span>
<a name="l00197"></a>00197 <span class="comment">/*---- functions and data in user part -----------------------------*/</span>
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="keywordtype">void</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#aa8253cd89ed4b268472ed62f4f2074ae">user_init</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> init);
<a name="l00200"></a>00200 <span class="keywordtype">void</span> <a class="code" href="hvr__200_8c.html#a78086e68bf7be32ce456293885a91f9c">user_write</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>) reentrant;
<a name="l00201"></a>00201 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="hvr__200_8c.html#ac7daae8fd6b3ddc2c0af7b870472088f">user_read</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>);
<a name="l00202"></a>00202 <span class="keywordtype">void</span> <a class="code" href="hvr__200_8c.html#a9c9fec92b60b251c275870d900294a4a">user_loop</a>(<span class="keywordtype">void</span>);
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 <span class="keyword">extern</span> <a class="code" href="structMSCB__INFO__VAR.html">MSCB_INFO_VAR</a> code <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[];
<a name="l00205"></a>00205 <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> idata <a class="code" href="hvr__200_8c.html#a7aa4e7d188b6702a7e5e361e85731948">_n_sub_addr</a>;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="keyword">extern</span> <span class="keywordtype">char</span> code <a class="code" href="hvr__200_8c.html#aae648e1cdd0859a1085a358a3e1138c8">node_name</a>[];
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="comment">/* funtions in mscbutil.c */</span>
<a name="l00212"></a>00212 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a179877b003d63996470f7b628a57eeac">rs232_output</a>(<span class="keywordtype">void</span>);
<a name="l00213"></a>00213 <span class="keyword">extern</span> bit <a class="code" href="mscbmain_8c.html#ad5b44f63b60e3b566a81dfdc699a4667">lcd_present</a>;
<a name="l00214"></a>00214 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a4ae5ad65c961268051560516eeff623f">watchdog_refresh</a>(<span class="keywordtype">void</span>);
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <span class="comment">/* forward declarations */</span>
<a name="l00217"></a>00217 <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a2a9daf8d26e5e7586533cd9a224b5958">flash_upgrade</a>(<span class="keywordtype">void</span>);
<a name="l00218"></a>00218 <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a59bf5abe8b226c54ea7c1104e698733a">send_remote_var</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="comment">/* variables in internal RAM (indirect addressing) */</span>
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 <span class="preprocessor">#ifdef CPU_C8051F020</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> xdata <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[300], <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[300];
<a name="l00226"></a>00226 <span class="preprocessor">#else</span>
<a name="l00227"></a><a class="code" href="scs__310__ql355p_8c.html#a975b8c9a73a2e8df411026ca8e0b2237">00227</a> <span class="preprocessor"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> idata <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[20], <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[8];
<a name="l00228"></a>00228 <span class="preprocessor">#endif</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>
<a name="l00230"></a><a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">00230</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> idata <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a>, <a class="code" href="mscbmain_8c.html#a9dcd24fa9f5eb330a7cc271e18ad509a">last_i_in</a>, <a class="code" href="mscbmain_8c.html#aa41397e8ab3b97a03a75ac350366f5e1">final_i_in</a>, <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a>, <a class="code" href="mscbmain_8c.html#a4bc453c30fd451b092ac92dc290c8713">i_out</a>, <a class="code" href="mscbmain_8c.html#a199b43445abff5fb124a5283dd9ab416">cmd_len</a>;
<a name="l00231"></a><a class="code" href="mscbmain_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">00231</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> idata <a class="code" href="mscbmain_8c.html#a370d1b19f2d4865c52d18526c38ab23a">crc_code</a>, <a class="code" href="mscbmain_8c.html#a65be4e777ffa48ff33ba3a7a56f3a5ff">addr_mode</a>, <a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a>, <a class="code" href="mscbmain_8c.html#aab1037491179d86a89ac750947c0b1f1">_flkey</a>=0;
<a name="l00232"></a>00232 
<a name="l00233"></a><a class="code" href="mscbutil_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">00233</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> idata <a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>, <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 <span class="preprocessor">#ifdef SCS_1000</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> var_to_send = 0xFF;
<a name="l00237"></a>00237 <span class="preprocessor">#endif</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span>
<a name="l00239"></a><a class="code" href="scs__910_8c.html#abf06fefcfd184511a38e909e5a4111c0">00239</a> <a class="code" href="structSYS__INFO.html">SYS_INFO</a> <a class="code" href="hvr__200_8c.html#abf06fefcfd184511a38e909e5a4111c0">sys_info</a>;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="comment">/* bit variables in internal RAM */</span>
<a name="l00244"></a>00244 
<a name="l00245"></a><a class="code" href="mscbmain_8c.html#a2f241a65a45834a3616e7edcd89d65c9">00245</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bdata <a class="code" href="ces8210_8c.html#aa811cfff7ed3e366dac57bec585d73ca">CSR</a>;        <span class="comment">// byte address of CSR consisting of bits below </span>
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="scs__demo_8c.html#af92f109d6b80d9d3cb9406bcedf825ae">00247</a> sbit <a class="code" href="hvr__200_8c.html#af92f109d6b80d9d3cb9406bcedf825ae">DEBUG_MODE</a> = <a class="code" href="ces8210_8c.html#aa811cfff7ed3e366dac57bec585d73ca">CSR</a> ^ 0;      <span class="comment">// debugging mode</span>
<a name="l00248"></a><a class="code" href="mscbmain_8c.html#ab0dab5dd672960abc1ece4881b38ae7c">00248</a> sbit <a class="code" href="mscbmain_8c.html#ab0dab5dd672960abc1ece4881b38ae7c">SYNC_MODE</a> = <a class="code" href="ces8210_8c.html#aa811cfff7ed3e366dac57bec585d73ca">CSR</a> ^ 1;       <span class="comment">// turned on in SYNC mode</span>
<a name="l00249"></a><a class="code" href="scs__demo_8c.html#ad140e1beb2bf61071df327f7434cae2e">00249</a> sbit <a class="code" href="hvr__200_8c.html#ad140e1beb2bf61071df327f7434cae2e">FREEZE_MODE</a> = <a class="code" href="ces8210_8c.html#aa811cfff7ed3e366dac57bec585d73ca">CSR</a> ^ 2;     <span class="comment">// turned on in FREEZE mode</span>
<a name="l00250"></a><a class="code" href="mscbmain_8c.html#ab245f1d1f76c19db5e72b616d0133e59">00250</a> sbit <a class="code" href="mscbmain_8c.html#ab245f1d1f76c19db5e72b616d0133e59">WD_RESET</a> = <a class="code" href="ces8210_8c.html#aa811cfff7ed3e366dac57bec585d73ca">CSR</a> ^ 3;        <span class="comment">// got rebooted by watchdog reset</span>
<a name="l00251"></a>00251 
<a name="l00252"></a><a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">00252</a> bit <a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a>;                  <span class="comment">// true if node addressed</span>
<a name="l00253"></a><a class="code" href="mscbmain_8c.html#a702b00abd141b68803e2f081251e11c2">00253</a> bit <a class="code" href="mscbmain_8c.html#a702b00abd141b68803e2f081251e11c2">new_address</a>, <a class="code" href="mscbmain_8c.html#a05b1f789ec02434b60bc21ce9f6d687e">debug_new_i</a>, <a class="code" href="mscbmain_8c.html#adf418e55afc9a13a362fc2e882d0f394">debug_new_o</a>;      <span class="comment">// used for LCD debug output</span>
<a name="l00254"></a><a class="code" href="mscbmain_8c.html#aabcaff382b5451e00dbbc74030962456">00254</a> bit <a class="code" href="lcd__menu_8c.html#aabcaff382b5451e00dbbc74030962456">flash_param</a>;                <span class="comment">// used for EEPROM flashing</span>
<a name="l00255"></a><a class="code" href="mscbmain_8c.html#a825a905ed203dd98f546e97865f748a0">00255</a> bit <a class="code" href="mscbmain_8c.html#a825a905ed203dd98f546e97865f748a0">flash_program</a>;              <span class="comment">// used for upgrading firmware</span>
<a name="l00256"></a><a class="code" href="mscbmain_8c.html#a5ade110c24cb0b1320f21ba7888efc78">00256</a> bit <a class="code" href="lcd__menu_8c.html#a5ade110c24cb0b1320f21ba7888efc78">reboot</a>;                     <span class="comment">// used for rebooting</span>
<a name="l00257"></a><a class="code" href="mscbmain_8c.html#a151774571a646bf208b696356f42b58c">00257</a> bit <a class="code" href="mscbmain_8c.html#a151774571a646bf208b696356f42b58c">configured</a>;                 <span class="comment">// TRUE if node is configured</span>
<a name="l00258"></a><a class="code" href="mscbmain_8c.html#a2fa4da5a3b0e9901a02d65bdefddd24e">00258</a> bit <a class="code" href="mscbmain_8c.html#a2fa4da5a3b0e9901a02d65bdefddd24e">flash_allowed</a>;              <span class="comment">// TRUE 5 sec after booting node</span>
<a name="l00259"></a><a class="code" href="mscbmain_8c.html#a824bf8df11ab6852c3d9005276a6a8bf">00259</a> bit <a class="code" href="mscbmain_8c.html#a824bf8df11ab6852c3d9005276a6a8bf">wrong_cpu</a>;                  <span class="comment">// TRUE if code uses xdata and CPU does&apos;t have it</span>
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00262"></a>00262 
<a name="l00263"></a><a class="code" href="mscbmain_8c.html#a7dfd9b79bc5a37d7df40207afbc5431f">00263</a> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a7dfd9b79bc5a37d7df40207afbc5431f">setup</a>(<span class="keywordtype">void</span>)
<a name="l00264"></a>00264 {
<a name="l00265"></a>00265    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> adr;
<a name="l00266"></a>00266    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l00267"></a>00267    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269    <a class="code" href="mscbmain_8c.html#aab1037491179d86a89ac750947c0b1f1">_flkey</a> = 0;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271    <span class="comment">/* first disable watchdog */</span>
<a name="l00272"></a>00272 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span><span class="preprocessor">#if defined(CPU_C8051F310)</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a4dda2378d1fb76a3c9430bb0ae1619c9">PCA0MD</a> = 0x00;
<a name="l00275"></a>00275 <span class="preprocessor">#else</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a2eb7f8e96149deeec0f227384694807b">WDTCN</a> = 0xDE;
<a name="l00277"></a>00277    <a class="code" href="c8051F000_8h.html#a2eb7f8e96149deeec0f227384694807b">WDTCN</a> = 0xAD;
<a name="l00278"></a>00278 <span class="preprocessor">#endif</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* CPU_CYGNAL */</span>
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="preprocessor">#endif</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span>
<a name="l00283"></a>00283 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>
<a name="l00285"></a>00285    <span class="comment">/* Port and oscillator configuration */</span>
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="preprocessor">#if defined(CPU_C8051F120)</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span>
<a name="l00289"></a>00289    <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a>   = <a class="code" href="c8051F120_8h.html#a14aacb99e01e6ed91f888acd07fcf7a9">CONFIG_PAGE</a>;
<a name="l00290"></a>00290   
<a name="l00291"></a>00291    <a class="code" href="c8051F020_8h.html#accb05907491efc1db79da3297f412ebf">P0MDOUT</a> = 0xF5;              <span class="comment">// SCS-1000 lines</span>
<a name="l00292"></a>00292    <a class="code" href="c8051F020_8h.html#af84b3723b32d7bec0c5e383450deb42a">P1MDOUT</a> = 0xBF;
<a name="l00293"></a>00293    <a class="code" href="c8051F020_8h.html#a6608f51dd6960523e066aff4616cd407">P2MDOUT</a> = 0x00;
<a name="l00294"></a>00294    <a class="code" href="c8051F020_8h.html#a26d4ad9fbc51d95e0445dc3741ebb21a">P3MDOUT</a> = 0xFF;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <a class="code" href="c8051F000_8h.html#ad03d8219a901c22c5c916b6736dea9aa">XBR0</a> = 0x04;                 <span class="comment">// Enable UART0 &amp; UART1</span>
<a name="l00297"></a>00297    <a class="code" href="c8051F000_8h.html#acd5b13dad19bfcca0b747e7715bbe82b">XBR1</a> = 0x00;
<a name="l00298"></a>00298    <a class="code" href="c8051F000_8h.html#a1495846c85ab78415cd56eb2c0a93400">XBR2</a> = 0x44;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300    <span class="comment">/* Select internal quartz oscillator */</span>
<a name="l00301"></a>00301    <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a>   = <a class="code" href="c8051F120_8h.html#a8118771b603f497803d635449ba11021">LEGACY_PAGE</a>;
<a name="l00302"></a>00302    <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a>     = 0xB0;            <span class="comment">// set flash read time for 100 MHz</span>
<a name="l00303"></a>00303 
<a name="l00304"></a>00304    <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a>   = <a class="code" href="c8051F120_8h.html#a14aacb99e01e6ed91f888acd07fcf7a9">CONFIG_PAGE</a>;
<a name="l00305"></a>00305    <a class="code" href="c8051F120_8h.html#a257a15906f25890eb62ef327da389c5c">PLL0CN</a>    |= 0x01;
<a name="l00306"></a>00306    <a class="code" href="c8051F120_8h.html#ab02812535f8b3d0168754c52d3bdd6f4">PLL0DIV</a>   = 0x01;
<a name="l00307"></a>00307    <a class="code" href="c8051F120_8h.html#adc18f3296a8bc4b5498b80b88a61bf77">PLL0FLT</a>   = 0x01;
<a name="l00308"></a>00308    <a class="code" href="c8051F120_8h.html#a9c283ec068d14d64597c53fa810846cb">PLL0MUL</a>   = 0x04;
<a name="l00309"></a>00309    <span class="keywordflow">for</span> (i = 0; i &lt; 15; i++);   <span class="comment">// Wait 5us for initialization</span>
<a name="l00310"></a>00310    <a class="code" href="c8051F120_8h.html#a257a15906f25890eb62ef327da389c5c">PLL0CN</a>    |= 0x02;
<a name="l00311"></a>00311    <span class="keywordflow">while</span> ((<a class="code" href="c8051F120_8h.html#a257a15906f25890eb62ef327da389c5c">PLL0CN</a> &amp; 0x10) == 0);
<a name="l00312"></a>00312    <a class="code" href="c8051F000_8h.html#a9783f36cd67fdbcbf7c12152343dcd37">OSCICN</a>    = 0x83;
<a name="l00313"></a>00313    <a class="code" href="c8051F120_8h.html#ab578024085573de3fd4b2772ab982066">CLKSEL</a>    = 0x02;            <span class="comment">// select PLL as sysclk src</span>
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <span class="preprocessor">#elif defined(CPU_C8051F020)</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span>
<a name="l00317"></a>00317    <a class="code" href="c8051F000_8h.html#ad03d8219a901c22c5c916b6736dea9aa">XBR0</a> = 0x04;                 <span class="comment">// Enable UART0 &amp; UART1</span>
<a name="l00318"></a>00318    <a class="code" href="c8051F000_8h.html#acd5b13dad19bfcca0b747e7715bbe82b">XBR1</a> = 0x00;
<a name="l00319"></a>00319    <a class="code" href="c8051F000_8h.html#a1495846c85ab78415cd56eb2c0a93400">XBR2</a> = 0x44;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321    <a class="code" href="c8051F020_8h.html#accb05907491efc1db79da3297f412ebf">P0MDOUT</a> = 0x01;              <span class="comment">// P0.0: TX = Push Pull</span>
<a name="l00322"></a>00322    <a class="code" href="c8051F020_8h.html#af84b3723b32d7bec0c5e383450deb42a">P1MDOUT</a> = 0x00;              <span class="comment">// P1: LPT</span>
<a name="l00323"></a>00323    <a class="code" href="c8051F020_8h.html#a6608f51dd6960523e066aff4616cd407">P2MDOUT</a> = 0x00;              <span class="comment">// P2: LPT</span>
<a name="l00324"></a>00324    <a class="code" href="c8051F020_8h.html#a26d4ad9fbc51d95e0445dc3741ebb21a">P3MDOUT</a> = 0xE0;              <span class="comment">// P3.5,6,7: Optocouplers</span>
<a name="l00325"></a>00325 
<a name="l00326"></a>00326    <span class="comment">/* Select external quartz oscillator */</span>
<a name="l00327"></a>00327    <a class="code" href="c8051F000_8h.html#a5e8025e81902590e27b65324534f9dbc">OSCXCN</a> = 0x67;               <span class="comment">// Crystal mode, Power Factor 22E6</span>
<a name="l00328"></a>00328    <a class="code" href="c8051F000_8h.html#a9783f36cd67fdbcbf7c12152343dcd37">OSCICN</a> = 0x08;               <span class="comment">// CLKSL=1 (external)</span>
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="preprocessor">#elif defined(CPU_C8051F310)</span>
<a name="l00331"></a>00331 <span class="preprocessor"></span>
<a name="l00332"></a>00332    <a class="code" href="c8051F000_8h.html#ad03d8219a901c22c5c916b6736dea9aa">XBR0</a> = 0x01;                 <span class="comment">// Enable RX/TX</span>
<a name="l00333"></a>00333    <a class="code" href="c8051F000_8h.html#acd5b13dad19bfcca0b747e7715bbe82b">XBR1</a> = 0x40;                 <span class="comment">// Enable crossbar</span>
<a name="l00334"></a>00334    <a class="code" href="c8051F020_8h.html#accb05907491efc1db79da3297f412ebf">P0MDOUT</a> = 0x90;              <span class="comment">// P0.4: TX, P0.7: RS485 enable Push/Pull</span>
<a name="l00335"></a>00335    <a class="code" href="c8051F310_8h.html#a05d9d2ab53dcabb60233373ef1fd46b3">P0SKIP</a>  = 0x0C;              <span class="comment">// Skip P0.2&amp;3 for Xtal</span>
<a name="l00336"></a>00336    <a class="code" href="c8051F310_8h.html#a7addd8acf39e206f4d5af9473375be4a">P0MDIN</a>  = 0xF3;              <span class="comment">// P0.2&amp;3 as analog input for Xtal</span>
<a name="l00337"></a>00337 
<a name="l00338"></a>00338    <span class="comment">/* Select external quartz oscillator */</span>
<a name="l00339"></a>00339    <a class="code" href="c8051F000_8h.html#a5e8025e81902590e27b65324534f9dbc">OSCXCN</a> = 0x67;
<a name="l00340"></a>00340    <span class="keywordflow">for</span> (i=0 ; i&lt;255 ; i++);
<a name="l00341"></a>00341    <span class="keywordflow">while</span> ((<a class="code" href="c8051F000_8h.html#a5e8025e81902590e27b65324534f9dbc">OSCXCN</a> &amp; 0x80) == 0);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343    <a class="code" href="c8051F120_8h.html#ab578024085573de3fd4b2772ab982066">CLKSEL</a> = 0x01;               <span class="comment">// derive SYSCLK from external source</span>
<a name="l00344"></a>00344    <a class="code" href="c8051F000_8h.html#a9783f36cd67fdbcbf7c12152343dcd37">OSCICN</a> = 0x00;               <span class="comment">// CLKSL=1 (external)</span>
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="preprocessor">#else</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span>
<a name="l00348"></a>00348    <a class="code" href="c8051F000_8h.html#ad03d8219a901c22c5c916b6736dea9aa">XBR0</a> = 0x04;                 <span class="comment">// Enable RX/TX</span>
<a name="l00349"></a>00349    <a class="code" href="c8051F000_8h.html#acd5b13dad19bfcca0b747e7715bbe82b">XBR1</a> = 0x00;
<a name="l00350"></a>00350    <a class="code" href="c8051F000_8h.html#a1495846c85ab78415cd56eb2c0a93400">XBR2</a> = 0x40;                 <span class="comment">// Enable crossbar</span>
<a name="l00351"></a>00351 
<a name="l00352"></a>00352    <a class="code" href="c8051F000_8h.html#af47f90783f1f8fc52c6c6ddb75a619bf">PRT0CF</a> = 0x01;               <span class="comment">// P0.0: TX = Push Pull</span>
<a name="l00353"></a>00353    <a class="code" href="c8051F000_8h.html#ad811a5ba56ce9aa730d22cb286af9454">PRT1CF</a> = 0x00;               <span class="comment">// P1</span>
<a name="l00354"></a>00354    <a class="code" href="c8051F000_8h.html#a6211c0d25ec85009a5bae74ec8dbafc1">PRT2CF</a> = 0x00;               <span class="comment">// P2  Open drain for 5V LCD</span>
<a name="l00355"></a>00355    <a class="code" href="c8051F000_8h.html#a46a0a3691167de0d9b42cbe4adb1bdd4">PRT3CF</a> = 0x20;               <span class="comment">// P3.5: RS485 enable = Push Pull</span>
<a name="l00356"></a>00356 
<a name="l00357"></a>00357    <span class="comment">/* Select external quartz oscillator */</span>
<a name="l00358"></a>00358    <a class="code" href="c8051F000_8h.html#a5e8025e81902590e27b65324534f9dbc">OSCXCN</a> = 0x67;               <span class="comment">// Crystal mode, Power Factor 22E6</span>
<a name="l00359"></a>00359    <a class="code" href="c8051F000_8h.html#a9783f36cd67fdbcbf7c12152343dcd37">OSCICN</a> = 0x08;               <span class="comment">// CLKSL=1 (external)</span>
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 <span class="preprocessor">#endif</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span>
<a name="l00363"></a>00363 <span class="preprocessor">#endif</span>
<a name="l00364"></a>00364 <span class="preprocessor"></span>
<a name="l00365"></a>00365    <span class="comment">/* enable watchdog */</span>
<a name="l00366"></a>00366 <span class="preprocessor">#ifdef CPU_ADUC812</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span><span class="preprocessor">#ifdef USE_WATCHDOG</span>
<a name="l00368"></a>00368 <span class="preprocessor"></span>   WDCON = 0xE0;                <span class="comment">// 2048 msec</span>
<a name="l00369"></a>00369    WDE = 1;
<a name="l00370"></a>00370 <span class="preprocessor">#endif</span>
<a name="l00371"></a>00371 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span>
<a name="l00373"></a>00373 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span>
<a name="l00375"></a>00375 <span class="preprocessor">#if defined(CPU_C8051F310)</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span>
<a name="l00377"></a>00377 <span class="preprocessor">#ifdef USE_WATCHDOG</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a95c7e8da6ba8efd3a28383c4c84fbf59">PCA0CPL4</a> = 255;              <span class="comment">// 71.1 msec</span>
<a name="l00379"></a>00379    <a class="code" href="c8051F000_8h.html#a4dda2378d1fb76a3c9430bb0ae1619c9">PCA0MD</a> = 0x40;               <span class="comment">// enable watchdog</span>
<a name="l00380"></a>00380 <span class="preprocessor">#endif</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>
<a name="l00382"></a>00382    <span class="comment">/* enable reset pin and watchdog reset */</span>
<a name="l00383"></a>00383    <a class="code" href="c8051F000_8h.html#af35967bca631ac4037a98d322d18abfb">RSTSRC</a> = 0x09;
<a name="l00384"></a>00384 <span class="preprocessor">#else </span><span class="comment">/* CPU_C8051F310 */</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="preprocessor">#ifdef USE_WATCHDOG</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a2eb7f8e96149deeec0f227384694807b">WDTCN</a> = 0x07;                <span class="comment">// 95 msec</span>
<a name="l00388"></a>00388    <a class="code" href="c8051F000_8h.html#a2eb7f8e96149deeec0f227384694807b">WDTCN</a> = 0xA5;                <span class="comment">// start watchdog</span>
<a name="l00389"></a>00389 <span class="preprocessor">#else</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a2eb7f8e96149deeec0f227384694807b">WDTCN</a> = 0xDE;                <span class="comment">// disable watchdog</span>
<a name="l00391"></a>00391    <a class="code" href="c8051F000_8h.html#a2eb7f8e96149deeec0f227384694807b">WDTCN</a> = 0xAD;
<a name="l00392"></a>00392 <span class="preprocessor">#endif</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>
<a name="l00394"></a>00394 <span class="preprocessor">#if defined(CPU_C8051F120)</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span>   <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a8118771b603f497803d635449ba11021">LEGACY_PAGE</a>;
<a name="l00396"></a>00396    <a class="code" href="c8051F000_8h.html#af35967bca631ac4037a98d322d18abfb">RSTSRC</a> = 0x04;               <span class="comment">// enable missing clock detector</span>
<a name="l00397"></a>00397 <span class="preprocessor">#else </span><span class="comment">/* F120 */</span>
<a name="l00398"></a>00398    <span class="comment">/* enable missing clock reset */</span>
<a name="l00399"></a>00399    <a class="code" href="c8051F000_8h.html#a9783f36cd67fdbcbf7c12152343dcd37">OSCICN</a> |= 0x80;              <span class="comment">// MSCLKE = 1</span>
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    <span class="comment">/* enable watchdog reset */</span>
<a name="l00402"></a>00402    <a class="code" href="c8051F000_8h.html#af35967bca631ac4037a98d322d18abfb">RSTSRC</a> = 0x08;
<a name="l00403"></a>00403 <span class="preprocessor">#endif </span><span class="comment">/* not F120 */</span>
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 <span class="preprocessor">#endif </span><span class="comment">/* not F310 */</span>
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="preprocessor">#endif </span><span class="comment">/* CPU_CYGNAL */</span>
<a name="l00408"></a>00408 
<a name="l00409"></a>00409    <span class="comment">/* start system clock */</span>
<a name="l00410"></a>00410    <a class="code" href="embedded_2mscb_8h.html#ac3da29ea117a42298b0958a53dd33aab">sysclock_init</a>();
<a name="l00411"></a>00411 
<a name="l00412"></a>00412    <span class="comment">/* default LED mode */</span>
<a name="l00413"></a>00413    <span class="keywordflow">for</span> (i=0 ; i&lt;<a class="code" href="embedded_2mscb_8h.html#a09ce9c9f5e59ac595b1e21730a00dcf9">N_LED</a> ; i++)
<a name="l00414"></a>00414       <a class="code" href="embedded_2mscb_8h.html#af87085aa8c2a51c2ef253721e4a192ca">led_mode</a>(i, 1);
<a name="l00415"></a>00415    
<a name="l00416"></a>00416    <span class="comment">/* initialize all memory */</span>
<a name="l00417"></a>00417    <a class="code" href="ces8210_8c.html#aa811cfff7ed3e366dac57bec585d73ca">CSR</a> = 0;
<a name="l00418"></a>00418    <a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a> = 0;
<a name="l00419"></a>00419    <a class="code" href="lcd__menu_8c.html#aabcaff382b5451e00dbbc74030962456">flash_param</a> = 0;
<a name="l00420"></a>00420    <a class="code" href="mscbmain_8c.html#a825a905ed203dd98f546e97865f748a0">flash_program</a> = 0;
<a name="l00421"></a>00421    <a class="code" href="lcd__menu_8c.html#a5ade110c24cb0b1320f21ba7888efc78">reboot</a> = 0;
<a name="l00422"></a>00422    <a class="code" href="mscbmain_8c.html#a151774571a646bf208b696356f42b58c">configured</a> = 1;
<a name="l00423"></a>00423    <a class="code" href="mscbmain_8c.html#a2fa4da5a3b0e9901a02d65bdefddd24e">flash_allowed</a> = 0;
<a name="l00424"></a>00424    <a class="code" href="mscbmain_8c.html#a824bf8df11ab6852c3d9005276a6a8bf">wrong_cpu</a> = 0;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426    RS485_ENABLE = 0;
<a name="l00427"></a>00427    <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> = <a class="code" href="mscbmain_8c.html#a4bc453c30fd451b092ac92dc290c8713">i_out</a> = <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a> = 0;
<a name="l00428"></a>00428    <a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a> = 0;
<a name="l00429"></a>00429    <span class="keywordflow">for</span> (i=0 ; i&lt;<span class="keyword">sizeof</span>(<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>) ; i++)
<a name="l00430"></a>00430       <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[i] = 0;
<a name="l00431"></a>00431    <span class="keywordflow">for</span> (i=0 ; i&lt;<span class="keyword">sizeof</span>(<a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>) ; i++)
<a name="l00432"></a>00432       <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[i] = 0;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434    <span class="comment">/* initialize UART(s) */</span>
<a name="l00435"></a>00435    <a class="code" href="embedded_2mscb_8h.html#aee20e81ba44db51d21a17d4640f5eae9">uart_init</a>(0, <a class="code" href="embedded_2mscb_8h.html#a28becf037368de8eb96bdf1f073651dd">BD_115200</a>);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 <span class="preprocessor">#ifdef SCS_1000</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>   <a class="code" href="embedded_2mscb_8h.html#aee20e81ba44db51d21a17d4640f5eae9">uart_init</a>(1, <a class="code" href="embedded_2mscb_8h.html#a28becf037368de8eb96bdf1f073651dd">BD_115200</a>);
<a name="l00439"></a>00439 <span class="preprocessor">#endif</span>
<a name="l00440"></a>00440 <span class="preprocessor"></span>
<a name="l00441"></a>00441 <span class="preprocessor">#ifdef LCD_SUPPORT</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span>   <a class="code" href="embedded_2mscb_8h.html#a9468c1be5dc5602e17d2a5dd2a9fed8d">lcd_setup</a>();
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 <span class="preprocessor">#ifdef LCD_DEBUG</span>
<a name="l00445"></a>00445 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#ad5b44f63b60e3b566a81dfdc699a4667">lcd_present</a>) {
<a name="l00446"></a>00446       printf(<span class="stringliteral">&quot;AD:%04X GA:%04X WD:%d&quot;</span>, sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a>,
<a name="l00447"></a>00447              sys_info.<a class="code" href="structSYS__INFO.html#a25a18bff28b36c17e51eb57e9b696d82">group_addr</a>, sys_info.<a class="code" href="structSYS__INFO.html#ae9d2e8538fd1189499620aa56997503b">wd_counter</a>);
<a name="l00448"></a>00448    }
<a name="l00449"></a>00449 <span class="preprocessor">#endif</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span>
<a name="l00451"></a>00451 <span class="preprocessor">#endif</span>
<a name="l00452"></a>00452 <span class="preprocessor"></span>
<a name="l00453"></a>00453    <span class="comment">/* count variables */</span>
<a name="l00454"></a>00454    <span class="keywordflow">for</span> (<a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a> = <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a> = 0;; <a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a>++) {
<a name="l00455"></a>00455       <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a> += <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[<a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a>].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a>;
<a name="l00456"></a>00456       <span class="keywordflow">if</span> (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[<a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a>].<a class="code" href="mainWindow_8cpp.html#a2474a5474cbff19523a51eb1de01cda4">width</a> == 0)
<a name="l00457"></a>00457          <span class="keywordflow">break</span>;
<a name="l00458"></a>00458    }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460    <span class="comment">/* check if variables are in xdata and xdata is present */</span>
<a name="l00461"></a>00461    <span class="keywordflow">if</span> (<a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a> &gt; 0) {
<a name="l00462"></a>00462       p = <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[0].<a class="code" href="structMSCB__INFO__VAR.html#a180d5200b9de3b508dd7555eeaa25f0a">ud</a>;
<a name="l00463"></a>00463       *p = 0x55;
<a name="l00464"></a>00464       <span class="keywordflow">if</span> (*p != 0x55)
<a name="l00465"></a>00465          <a class="code" href="mscbmain_8c.html#a824bf8df11ab6852c3d9005276a6a8bf">wrong_cpu</a> = 1;
<a name="l00466"></a>00466       *p = 0xAA;
<a name="l00467"></a>00467       <span class="keywordflow">if</span> (*p != 0xAA)
<a name="l00468"></a>00468          <a class="code" href="mscbmain_8c.html#a824bf8df11ab6852c3d9005276a6a8bf">wrong_cpu</a> = 1;
<a name="l00469"></a>00469    }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <span class="comment">/* retrieve EEPROM data */</span>
<a name="l00472"></a>00472    <span class="keywordflow">if</span> (!<a class="code" href="embedded_2mscb_8h.html#a1cde349ab9feb3cfbd44e1555cb2304b">eeprom_retrieve</a>()) {
<a name="l00473"></a>00473       <a class="code" href="mscbmain_8c.html#a151774571a646bf208b696356f42b58c">configured</a> = 0;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475       <span class="comment">/* correct initial value */</span>
<a name="l00476"></a>00476       sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a> = 0xFFFF;
<a name="l00477"></a>00477       sys_info.<a class="code" href="structSYS__INFO.html#a25a18bff28b36c17e51eb57e9b696d82">group_addr</a> = 0xFFFF;
<a name="l00478"></a>00478       sys_info.<a class="code" href="structSYS__INFO.html#ae9d2e8538fd1189499620aa56997503b">wd_counter</a> = 0;
<a name="l00479"></a>00479       memset(sys_info.<a class="code" href="structSYS__INFO.html#ae4e697a3de412f515d9f5dc3567cd71a">node_name</a>, 0, <span class="keyword">sizeof</span>(sys_info.<a class="code" href="structSYS__INFO.html#ae4e697a3de412f515d9f5dc3567cd71a">node_name</a>));
<a name="l00480"></a>00480       strncpy(sys_info.<a class="code" href="structSYS__INFO.html#ae4e697a3de412f515d9f5dc3567cd71a">node_name</a>, <a class="code" href="hvr__200_8c.html#aae648e1cdd0859a1085a358a3e1138c8">node_name</a>, <span class="keyword">sizeof</span>(sys_info.<a class="code" href="structSYS__INFO.html#ae4e697a3de412f515d9f5dc3567cd71a">node_name</a>));
<a name="l00481"></a>00481 
<a name="l00482"></a>00482       <span class="comment">/* init variables */</span>
<a name="l00483"></a>00483       <span class="keywordflow">for</span> (i = 0; <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a>; i++)
<a name="l00484"></a>00484          <span class="keywordflow">if</span> (!(<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].flags &amp; <a class="code" href="embedded_2mscb_8h.html#a5102753876bd1b0a280e121264638696">MSCBF_DATALESS</a>)) {
<a name="l00485"></a>00485             <span class="comment">/* do it for each sub-address */</span>
<a name="l00486"></a>00486             <span class="keywordflow">for</span> (adr = 0 ; adr &lt; <a class="code" href="hvr__200_8c.html#a7aa4e7d188b6702a7e5e361e85731948">_n_sub_addr</a> ; adr++) {
<a name="l00487"></a>00487                memset((<span class="keywordtype">char</span>*)<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].ud + <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>*adr, 0, <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="mainWindow_8cpp.html#a2474a5474cbff19523a51eb1de01cda4">width</a>);
<a name="l00488"></a>00488                <a class="code" href="embedded_2mscb_8h.html#a4ae5ad65c961268051560516eeff623f">watchdog_refresh</a>();
<a name="l00489"></a>00489             }
<a name="l00490"></a>00490 <span class="preprocessor">#ifdef SCS_1000</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].flags &amp; <a class="code" href="embedded_2mscb_8h.html#a30cae5229ebcd68015a6c5aa41883e2c">MSCBF_REMOUT</a>)
<a name="l00492"></a>00492                <a class="code" href="embedded_2mscb_8h.html#a59bf5abe8b226c54ea7c1104e698733a">send_remote_var</a>(i);
<a name="l00493"></a>00493 <span class="preprocessor">#endif</span>
<a name="l00494"></a>00494 <span class="preprocessor"></span>         }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496       <span class="comment">/* call user initialization routine with initialization */</span>
<a name="l00497"></a>00497       <a class="code" href="examples_2macro_2midas__macro_8h.html#aa8253cd89ed4b268472ed62f4f2074ae">user_init</a>(1);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499            <span class="comment">/* do flash programming later (&gt;3sec after reboot) */</span>
<a name="l00500"></a>00500       <span class="comment">//flash_param = 1;</span>
<a name="l00501"></a>00501 
<a name="l00502"></a>00502    } <span class="keywordflow">else</span> {
<a name="l00503"></a>00503       <span class="comment">/* remember configured flag */</span>
<a name="l00504"></a>00504       <a class="code" href="mscbmain_8c.html#a151774571a646bf208b696356f42b58c">configured</a> = 1;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506       <span class="comment">/* call user initialization routine without initialization */</span>
<a name="l00507"></a>00507       <a class="code" href="examples_2macro_2midas__macro_8h.html#aa8253cd89ed4b268472ed62f4f2074ae">user_init</a>(0);
<a name="l00508"></a>00508 
<a name="l00509"></a>00509    <span class="comment">/* check if reset by watchdog */</span>
<a name="l00510"></a>00510 <span class="preprocessor">#ifdef CPU_ADUC812</span>
<a name="l00511"></a>00511 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (WDS)
<a name="l00512"></a>00512 <span class="preprocessor">#endif</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span><span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span>       <span class="keywordflow">if</span> (<a class="code" href="c8051F000_8h.html#af35967bca631ac4037a98d322d18abfb">RSTSRC</a> &amp; 0x08)
<a name="l00515"></a>00515 <span class="preprocessor">#endif</span>
<a name="l00516"></a>00516 <span class="preprocessor"></span>         {
<a name="l00517"></a>00517          <a class="code" href="mscbmain_8c.html#ab245f1d1f76c19db5e72b616d0133e59">WD_RESET</a> = 1;
<a name="l00518"></a>00518          sys_info.<a class="code" href="structSYS__INFO.html#ae9d2e8538fd1189499620aa56997503b">wd_counter</a>++;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520            <span class="comment">/* do flash programming later (&gt;3sec after reboot) */</span>
<a name="l00521"></a>00521          <span class="comment">//flash_param = 1;</span>
<a name="l00522"></a>00522       }
<a name="l00523"></a>00523    }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525    <span class="comment">/* Blink LEDs */</span>
<a name="l00526"></a>00526    <span class="keywordflow">for</span> (i=0 ; i&lt;N_LED ; i++)
<a name="l00527"></a>00527       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(i, 3, 150);
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00531"></a>00531 
<a name="l00532"></a><a class="code" href="mscbmain_8c.html#aa69b4fc5909ce60224f9bae08fabea70">00532</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="embedded_2mscb_8h.html#a9a0fd3ca014fb75f74e54b1e89de68e4">cur_sub_addr</a>()
<a name="l00533"></a>00533 {
<a name="l00534"></a>00534    <span class="keywordflow">return</span> <a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>;
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00537"></a>00537 
<a name="l00538"></a><a class="code" href="mscbmain_8c.html#a7306300d086cb79f19b2da6743cf4572">00538</a> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a7306300d086cb79f19b2da6743cf4572">debug_output</a>()
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540    <span class="keywordflow">if</span> (!<a class="code" href="hvr__200_8c.html#af92f109d6b80d9d3cb9406bcedf825ae">DEBUG_MODE</a>)
<a name="l00541"></a>00541       <span class="keywordflow">return</span>;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 <span class="preprocessor">#if !defined(CPU_ADUC812) &amp;&amp; !defined(SCS_300) &amp;&amp; !defined(SCS_210)     // SCS210/300 redefine printf()</span>
<a name="l00544"></a>00544 <span class="preprocessor"></span><span class="preprocessor">#ifdef LCD_DEBUG</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span>   {
<a name="l00546"></a>00546       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#a05b1f789ec02434b60bc21ce9f6d687e">debug_new_i</a>) {
<a name="l00549"></a>00549          <a class="code" href="mscbmain_8c.html#a05b1f789ec02434b60bc21ce9f6d687e">debug_new_i</a> = 0;
<a name="l00550"></a>00550          <a class="code" href="embedded_2mscb_8h.html#a35c08b1fa742e650f4873939707b893b">lcd_clear</a>();
<a name="l00551"></a>00551 
<a name="l00552"></a>00552          n = <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> ? <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> : <a class="code" href="mscbmain_8c.html#a199b43445abff5fb124a5283dd9ab416">cmd_len</a>;
<a name="l00553"></a>00553          <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l00554"></a>00554             printf(<span class="stringliteral">&quot;%02bX &quot;</span>, <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[i]);
<a name="l00555"></a>00555       }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#adf418e55afc9a13a362fc2e882d0f394">debug_new_o</a>) {
<a name="l00558"></a>00558          <a class="code" href="mscbmain_8c.html#adf418e55afc9a13a362fc2e882d0f394">debug_new_o</a> = 0;
<a name="l00559"></a>00559          <a class="code" href="embedded_2mscb_8h.html#adaf2d117fc7b2fb397acd51a28baba7b">lcd_goto</a>(0, 1);
<a name="l00560"></a>00560          <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a>; i++)
<a name="l00561"></a>00561             printf(<span class="stringliteral">&quot;%02bX &quot;</span>, <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[i]);
<a name="l00562"></a>00562       }
<a name="l00563"></a>00563    }
<a name="l00564"></a>00564 <span class="preprocessor">#endif</span>
<a name="l00565"></a>00565 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span>
<a name="l00567"></a>00567 }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 <span class="comment">/*------------------------------------------------------------------*\</span>
<a name="l00570"></a>00570 <span class="comment"></span>
<a name="l00571"></a>00571 <span class="comment">  Serial interrupt</span>
<a name="l00572"></a>00572 <span class="comment"></span>
<a name="l00573"></a>00573 <span class="comment">\*------------------------------------------------------------------*/</span>
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a2331a26017e5f759388bb66d56bf065b">interprete</a>(<span class="keywordtype">void</span>);
<a name="l00576"></a>00576 
<a name="l00577"></a><a class="code" href="mscbmain_8c.html#a6eb4ef98b98e79010079f1c0097741b3">00577</a> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a6eb4ef98b98e79010079f1c0097741b3">serial_int</a>(<span class="keywordtype">void</span>) interrupt 4 using 1
<a name="l00578"></a>00578 {
<a name="l00579"></a>00579    <span class="keywordflow">if</span> (<a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a>) {
<a name="l00580"></a>00580       <span class="comment">/* character has been transferred */</span>
<a name="l00581"></a>00581 
<a name="l00582"></a>00582       <a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> = 0;                  <span class="comment">// clear TI flag</span>
<a name="l00583"></a>00583 
<a name="l00584"></a>00584       <a class="code" href="mscbmain_8c.html#a4bc453c30fd451b092ac92dc290c8713">i_out</a>++;                  <span class="comment">// increment output counter</span>
<a name="l00585"></a>00585       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#a4bc453c30fd451b092ac92dc290c8713">i_out</a> == <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a>) {
<a name="l00586"></a>00586          <a class="code" href="mscbmain_8c.html#a4bc453c30fd451b092ac92dc290c8713">i_out</a> = 0;             <span class="comment">// send buffer empty, clear pointer</span>
<a name="l00587"></a>00587          RS485_ENABLE = 0;      <span class="comment">// disable RS485 driver</span>
<a name="l00588"></a>00588          <a class="code" href="mscbmain_8c.html#adf418e55afc9a13a362fc2e882d0f394">debug_new_o</a> = 1;       <span class="comment">// indicate new debug output</span>
<a name="l00589"></a>00589       } <span class="keywordflow">else</span> {
<a name="l00590"></a>00590          <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[<a class="code" href="mscbmain_8c.html#a4bc453c30fd451b092ac92dc290c8713">i_out</a>];        <span class="comment">// send character</span>
<a name="l00591"></a>00591       }
<a name="l00592"></a>00592    }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594    <span class="keywordflow">if</span> (<a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a>) {
<a name="l00595"></a>00595       <span class="comment">/* character has been received */</span>
<a name="l00596"></a>00596 
<a name="l00597"></a>00597       <span class="keywordflow">if</span> (!<a class="code" href="embedded_2mscb_8h.html#aea7b79e183a9839ff17ff313736e3f07">RB80</a> &amp;&amp; !<a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a>) {
<a name="l00598"></a>00598          <a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a> = 0;
<a name="l00599"></a>00599          <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> = 0;
<a name="l00600"></a>00600          <span class="keywordflow">return</span>;                <span class="comment">// discard data if not bit9 and not addressed</span>
<a name="l00601"></a>00601       }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603       <a class="code" href="embedded_2mscb_8h.html#aea7b79e183a9839ff17ff313736e3f07">RB80</a> = 0;
<a name="l00604"></a>00604       <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a>++] = <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a>;
<a name="l00605"></a>00605       <a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a> = 0;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> == 1) {
<a name="l00608"></a>00608          <span class="comment">/* check for padding character */</span>
<a name="l00609"></a>00609          <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[0] == 0) {
<a name="l00610"></a>00610             <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> = 0;
<a name="l00611"></a>00611             <span class="keywordflow">return</span>;
<a name="l00612"></a>00612          }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614          <span class="comment">/* initialize command length if first byte */</span>
<a name="l00615"></a>00615          <a class="code" href="mscbmain_8c.html#a199b43445abff5fb124a5283dd9ab416">cmd_len</a> = (<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[0] &amp; 0x07) + 2;      <span class="comment">// + cmd + crc</span>
<a name="l00616"></a>00616       }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> == 2 &amp;&amp; <a class="code" href="mscbmain_8c.html#a199b43445abff5fb124a5283dd9ab416">cmd_len</a> == 9) {
<a name="l00619"></a>00619          <span class="comment">/* variable length command */</span>
<a name="l00620"></a>00620          <a class="code" href="mscbmain_8c.html#a199b43445abff5fb124a5283dd9ab416">cmd_len</a> = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1] + 3;       <span class="comment">// + cmd + N + crc</span>
<a name="l00621"></a>00621       }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623       <a class="code" href="mscbmain_8c.html#a05b1f789ec02434b60bc21ce9f6d687e">debug_new_i</a> = 1;          <span class="comment">// indicate new data in input buffer</span>
<a name="l00624"></a>00624 
<a name="l00625"></a>00625       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> == <span class="keyword">sizeof</span>(<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>))       <span class="comment">// check for buffer overflow</span>
<a name="l00626"></a>00626       {
<a name="l00627"></a>00627          <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> = 0;
<a name="l00628"></a>00628          <span class="keywordflow">return</span>;                <span class="comment">// don&apos;t interprete command</span>
<a name="l00629"></a>00629       }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> &lt; <a class="code" href="mscbmain_8c.html#a199b43445abff5fb124a5283dd9ab416">cmd_len</a>)       <span class="comment">// return if command not yet complete</span>
<a name="l00632"></a>00632          <span class="keywordflow">return</span>;
<a name="l00633"></a>00633 
<a name="l00634"></a>00634       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> - 1] != <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>, <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> - 1)) {
<a name="l00635"></a>00635          <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> = 0;
<a name="l00636"></a>00636          <span class="keywordflow">return</span>;                <span class="comment">// return if CRC code does not match</span>
<a name="l00637"></a>00637       }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639       <a class="code" href="mscbmain_8c.html#a2331a26017e5f759388bb66d56bf065b">interprete</a>();             <span class="comment">// interprete command</span>
<a name="l00640"></a>00640       <a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> = 0;
<a name="l00641"></a>00641    }
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 <span class="comment">/*------------------------------------------------------------------*\</span>
<a name="l00645"></a>00645 <span class="comment"></span>
<a name="l00646"></a>00646 <span class="comment">  Interprete MSCB command</span>
<a name="l00647"></a>00647 <span class="comment"></span>
<a name="l00648"></a>00648 <span class="comment">\*------------------------------------------------------------------*/</span>
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 <span class="preprocessor">#pragma NOAREGS</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span>
<a name="l00652"></a><a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">00652</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="system_8c.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a> * crc)
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span>   <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l00656"></a>00656 <span class="preprocessor">#endif</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span>
<a name="l00658"></a>00658    <span class="keywordflow">if</span> (crc)
<a name="l00659"></a>00659       *crc = <a class="code" href="embedded_2mscb_8h.html#a06722ba2c1a909418c287f36da918b20">crc8_add</a>(*crc, d);
<a name="l00660"></a>00660    <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = d;
<a name="l00661"></a>00661    <span class="keywordflow">while</span> (!<a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a>);
<a name="l00662"></a>00662    <a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> = 0;
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00665"></a><a class="code" href="mscbmain_8c.html#aae8a01135e2aa28736cc54e0d4bfb275">00665</a> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#aae8a01135e2aa28736cc54e0d4bfb275">addr_node8</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mscbutil_8c.html#a74b654271a172a244c844fb86277cd8a">mode</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> adr, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> node_addr)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667    <span class="keywordflow">if</span> (adr &gt;= node_addr &amp;&amp;
<a name="l00668"></a>00668        adr &lt;  node_addr + <a class="code" href="hvr__200_8c.html#a7aa4e7d188b6702a7e5e361e85731948">_n_sub_addr</a>) {
<a name="l00669"></a>00669 
<a name="l00670"></a>00670       <a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a> = 1;
<a name="l00671"></a>00671       <a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a> = adr - node_addr;
<a name="l00672"></a>00672       <a class="code" href="mscbmain_8c.html#a65be4e777ffa48ff33ba3a7a56f3a5ff">addr_mode</a> = mode;
<a name="l00673"></a>00673    } <span class="keywordflow">else</span> {
<a name="l00674"></a>00674       <a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a> = 0;
<a name="l00675"></a>00675       <a class="code" href="mscbmain_8c.html#a65be4e777ffa48ff33ba3a7a56f3a5ff">addr_mode</a> = <a class="code" href="mscbmain_8c.html#ac5c08a68afed90bb2c9a8f573c07b17f">ADDR_NONE</a>;
<a name="l00676"></a>00676    }
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00679"></a><a class="code" href="mscbmain_8c.html#acb4e8a4ba5c8b45f127488ee76d069c3">00679</a> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#acb4e8a4ba5c8b45f127488ee76d069c3">addr_node16</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mscbutil_8c.html#a74b654271a172a244c844fb86277cd8a">mode</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> adr, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> node_addr)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681    <span class="keywordflow">if</span> (node_addr == 0xFFFF) {
<a name="l00682"></a>00682       <span class="keywordflow">if</span> (adr == node_addr) {
<a name="l00683"></a>00683          <a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a> = 1;
<a name="l00684"></a>00684          <a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a> = 0;
<a name="l00685"></a>00685          <a class="code" href="mscbmain_8c.html#a65be4e777ffa48ff33ba3a7a56f3a5ff">addr_mode</a> = mode;
<a name="l00686"></a>00686       } <span class="keywordflow">else</span> {
<a name="l00687"></a>00687          <a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a> = 0;
<a name="l00688"></a>00688          <a class="code" href="mscbmain_8c.html#a65be4e777ffa48ff33ba3a7a56f3a5ff">addr_mode</a> = <a class="code" href="mscbmain_8c.html#ac5c08a68afed90bb2c9a8f573c07b17f">ADDR_NONE</a>;
<a name="l00689"></a>00689       }
<a name="l00690"></a>00690    } <span class="keywordflow">else</span> {
<a name="l00691"></a>00691       <span class="keywordflow">if</span> (adr &gt;= node_addr &amp;&amp;
<a name="l00692"></a>00692           adr &lt;  node_addr + <a class="code" href="hvr__200_8c.html#a7aa4e7d188b6702a7e5e361e85731948">_n_sub_addr</a>) {
<a name="l00693"></a>00693 
<a name="l00694"></a>00694          <a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a> = 1;
<a name="l00695"></a>00695          <a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a> = adr - node_addr;
<a name="l00696"></a>00696          <a class="code" href="mscbmain_8c.html#a65be4e777ffa48ff33ba3a7a56f3a5ff">addr_mode</a> = mode;
<a name="l00697"></a>00697       } <span class="keywordflow">else</span> {
<a name="l00698"></a>00698          <a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a> = 0;
<a name="l00699"></a>00699          <a class="code" href="mscbmain_8c.html#a65be4e777ffa48ff33ba3a7a56f3a5ff">addr_mode</a> = <a class="code" href="mscbmain_8c.html#ac5c08a68afed90bb2c9a8f573c07b17f">ADDR_NONE</a>;
<a name="l00700"></a>00700       }
<a name="l00701"></a>00701    }
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a><a class="code" href="mscbmain_8c.html#a2331a26017e5f759388bb66d56bf065b">00704</a> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#a2331a26017e5f759388bb66d56bf065b">interprete</a>(<span class="keywordtype">void</span>)
<a name="l00705"></a>00705 {
<a name="l00706"></a>00706    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> crc, <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, ch;
<a name="l00707"></a>00707    <a class="code" href="structMSCB__INFO__VAR.html">MSCB_INFO_VAR</a> code *pvar;
<a name="l00708"></a>00708 
<a name="l00709"></a>00709    cmd = (<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[0] &amp; 0xF8);    <span class="comment">// strip length field</span>
<a name="l00710"></a>00710 
<a name="l00711"></a>00711 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00712"></a>00712 <span class="preprocessor"></span>   <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;        <span class="comment">// needed for SBUF0</span>
<a name="l00713"></a>00713 <span class="preprocessor">#endif</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span>
<a name="l00715"></a>00715    <span class="keywordflow">switch</span> (<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[0]) {
<a name="l00716"></a>00716    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#afd3ffe32bed346a1b83a8f7006e67b81">CMD_ADDR_NODE8</a>:
<a name="l00717"></a>00717       <a class="code" href="mscbmain_8c.html#aae8a01135e2aa28736cc54e0d4bfb275">addr_node8</a>(<a class="code" href="mscbmain_8c.html#a50350e704ee0286112a55b50ac65eb29">ADDR_NODE</a>, <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1], sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a> &amp; 0xFF);
<a name="l00718"></a>00718       <span class="keywordflow">break</span>;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a874333c022591217260cfae847df88c8">CMD_ADDR_NODE16</a>:
<a name="l00721"></a>00721       <a class="code" href="mscbmain_8c.html#acb4e8a4ba5c8b45f127488ee76d069c3">addr_node16</a>(<a class="code" href="mscbmain_8c.html#a50350e704ee0286112a55b50ac65eb29">ADDR_NODE</a>, *(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) &amp;<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1], sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a>);
<a name="l00722"></a>00722       <span class="keywordflow">break</span>;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#aa2ae7afe1899062b5bbf03dd9558a28e">CMD_ADDR_BC</a>:
<a name="l00725"></a>00725       <a class="code" href="mscbmain_8c.html#aae8a01135e2aa28736cc54e0d4bfb275">addr_node8</a>(<a class="code" href="mscbmain_8c.html#a83ed7cc9f4f8cd24a00c25acd4a1ccfb">ADDR_ALL</a>, 0, 0);
<a name="l00726"></a>00726       <span class="keywordflow">break</span>;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a2b88929b3fbb2260bd17d0e6c94fa7fa">CMD_ADDR_GRP8</a>:
<a name="l00729"></a>00729       <a class="code" href="mscbmain_8c.html#aae8a01135e2aa28736cc54e0d4bfb275">addr_node8</a>(<a class="code" href="mscbmain_8c.html#aa6482f1b072b3f59e9def8ebca00ac8d">ADDR_GROUP</a>, in_buf[1], sys_info.<a class="code" href="structSYS__INFO.html#a25a18bff28b36c17e51eb57e9b696d82">group_addr</a> &amp; 0xFF);
<a name="l00730"></a>00730       <span class="keywordflow">break</span>;
<a name="l00731"></a>00731 
<a name="l00732"></a>00732    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#ab8c05ebd354abca94a0c847778e01a11">CMD_ADDR_GRP16</a>:
<a name="l00733"></a>00733       <a class="code" href="mscbmain_8c.html#acb4e8a4ba5c8b45f127488ee76d069c3">addr_node16</a>(<a class="code" href="mscbmain_8c.html#aa6482f1b072b3f59e9def8ebca00ac8d">ADDR_GROUP</a>, *(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) &amp;in_buf[1], sys_info.<a class="code" href="structSYS__INFO.html#a25a18bff28b36c17e51eb57e9b696d82">group_addr</a>);
<a name="l00734"></a>00734       <span class="keywordflow">break</span>;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#ad4da6f3431fe3b24aa73bf2d59801d57">CMD_PING8</a>:
<a name="l00737"></a>00737       <a class="code" href="mscbmain_8c.html#aae8a01135e2aa28736cc54e0d4bfb275">addr_node8</a>(<a class="code" href="mscbmain_8c.html#a50350e704ee0286112a55b50ac65eb29">ADDR_NODE</a>, in_buf[1], sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a> &amp; 0xFF);
<a name="l00738"></a>00738       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a>) {
<a name="l00739"></a>00739          <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0] = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l00740"></a>00740          <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a> = 1;
<a name="l00741"></a>00741          RS485_ENABLE = 1;
<a name="l00742"></a>00742          <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l00743"></a>00743       }
<a name="l00744"></a>00744       <span class="keywordflow">break</span>;
<a name="l00745"></a>00745 
<a name="l00746"></a>00746    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a2b03bc5e886d7da5fd7a59583a143fd1">CMD_PING16</a>:
<a name="l00747"></a>00747       <a class="code" href="mscbmain_8c.html#acb4e8a4ba5c8b45f127488ee76d069c3">addr_node16</a>(<a class="code" href="mscbmain_8c.html#a50350e704ee0286112a55b50ac65eb29">ADDR_NODE</a>, *(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) &amp;in_buf[1], sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a>);
<a name="l00748"></a>00748       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aa87b18d4ac7eab8750270a88a011cb29">addressed</a>) {
<a name="l00749"></a>00749          <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0] = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l00750"></a>00750          <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a> = 1;
<a name="l00751"></a>00751          RS485_ENABLE = 1;
<a name="l00752"></a>00752          <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l00753"></a>00753       }
<a name="l00754"></a>00754       <span class="keywordflow">break</span>;
<a name="l00755"></a>00755 
<a name="l00756"></a>00756    <span class="keywordflow">case</span> <a class="code" href="group__err26.html#ga2677fc43f8393bcf3bafc8bbface003f">CMD_INIT</a>:
<a name="l00757"></a>00757       <a class="code" href="lcd__menu_8c.html#a5ade110c24cb0b1320f21ba7888efc78">reboot</a> = 1;               <span class="comment">// reboot in next main loop</span>
<a name="l00758"></a>00758       <span class="keywordflow">break</span>;
<a name="l00759"></a>00759 
<a name="l00760"></a>00760    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a1881e44bea9e7bfd3ab1b1e5a1961d08">CMD_GET_INFO</a>:
<a name="l00761"></a>00761       <span class="comment">/* general info */</span>
<a name="l00762"></a>00762 
<a name="l00763"></a>00763       <a class="code" href="embedded_2mscb_8h.html#ad147e55136df8cab74bfb301feaa82ad">ES0</a> = 0;                  <span class="comment">// temporarily disable serial interrupt</span>
<a name="l00764"></a>00764       crc = 0;
<a name="l00765"></a>00765       RS485_ENABLE = 1;
<a name="l00766"></a>00766 
<a name="l00767"></a>00767       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(<a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a> + 7, &amp;crc);     <span class="comment">// send acknowledge, variable data length</span>
<a name="l00768"></a>00768       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(24, &amp;crc);      <span class="comment">// send data length</span>
<a name="l00769"></a>00769       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(<a class="code" href="CAENBridgeUpgrade_2config_8h.html#a1c6d5de492ac61ad29aec7aa9a436bbf">VERSION</a>, &amp;crc); <span class="comment">// send protocol version</span>
<a name="l00770"></a>00770 
<a name="l00771"></a>00771       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(<a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a>, &amp;crc);     <span class="comment">// send number of variables</span>
<a name="l00772"></a>00772 
<a name="l00773"></a>00773       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(*(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp;sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a>) + 0), &amp;crc);  <span class="comment">// send node address</span>
<a name="l00774"></a>00774       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(*(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp;sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a>) + 1), &amp;crc);
<a name="l00775"></a>00775 
<a name="l00776"></a>00776       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(*(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp;sys_info.<a class="code" href="structSYS__INFO.html#a25a18bff28b36c17e51eb57e9b696d82">group_addr</a>) + 0), &amp;crc); <span class="comment">// send group address</span>
<a name="l00777"></a>00777       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(*(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp;sys_info.<a class="code" href="structSYS__INFO.html#a25a18bff28b36c17e51eb57e9b696d82">group_addr</a>) + 1), &amp;crc);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(*(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp;sys_info.<a class="code" href="structSYS__INFO.html#ae9d2e8538fd1189499620aa56997503b">wd_counter</a>) + 0), &amp;crc); <span class="comment">// send watchdog resets</span>
<a name="l00780"></a>00780       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(*(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp;sys_info.<a class="code" href="structSYS__INFO.html#ae9d2e8538fd1189499620aa56997503b">wd_counter</a>) + 1), &amp;crc);
<a name="l00781"></a>00781 
<a name="l00782"></a>00782       <span class="keywordflow">for</span> (i = 0; i &lt; 16; i++)  <span class="comment">// send node name</span>
<a name="l00783"></a>00783          <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(sys_info.<a class="code" href="structSYS__INFO.html#ae4e697a3de412f515d9f5dc3567cd71a">node_name</a>[i], &amp;crc);
<a name="l00784"></a>00784 
<a name="l00785"></a>00785       <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(crc, NULL);     <span class="comment">// send CRC code</span>
<a name="l00786"></a>00786 
<a name="l00787"></a>00787       RS485_ENABLE = 0;
<a name="l00788"></a>00788       <a class="code" href="embedded_2mscb_8h.html#ad147e55136df8cab74bfb301feaa82ad">ES0</a> = 1;                  <span class="comment">// re-enable serial interrupts</span>
<a name="l00789"></a>00789       <span class="keywordflow">break</span>;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a1881e44bea9e7bfd3ab1b1e5a1961d08">CMD_GET_INFO</a> + 1:
<a name="l00792"></a>00792       <span class="comment">/* send variable info */</span>
<a name="l00793"></a>00793 
<a name="l00794"></a>00794       <span class="keywordflow">if</span> (in_buf[1] &lt; <a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a>) {
<a name="l00795"></a>00795          pvar = <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a> + in_buf[1];
<a name="l00796"></a>00796 
<a name="l00797"></a>00797          <a class="code" href="embedded_2mscb_8h.html#ad147e55136df8cab74bfb301feaa82ad">ES0</a> = 0;               <span class="comment">// temporarily disable serial interrupt</span>
<a name="l00798"></a>00798          crc = 0;
<a name="l00799"></a>00799          RS485_ENABLE = 1;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801          <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(<a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a> + 7, &amp;crc);  <span class="comment">// send acknowledge, variable data length</span>
<a name="l00802"></a>00802          <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(13, &amp;crc);   <span class="comment">// send data length</span>
<a name="l00803"></a>00803          <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(pvar-&gt;width, &amp;crc);
<a name="l00804"></a>00804          <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(pvar-&gt;unit, &amp;crc);
<a name="l00805"></a>00805          <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(pvar-&gt;prefix, &amp;crc);
<a name="l00806"></a>00806          <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(pvar-&gt;status, &amp;crc);
<a name="l00807"></a>00807          <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(pvar-&gt;flags, &amp;crc);
<a name="l00808"></a>00808 
<a name="l00809"></a>00809          <span class="keywordflow">for</span> (i = 0; i &lt; 8; i++)        <span class="comment">// send variable name</span>
<a name="l00810"></a>00810             <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(pvar-&gt;name[i], &amp;crc);
<a name="l00811"></a>00811 
<a name="l00812"></a>00812          <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(crc, NULL);  <span class="comment">// send CRC code</span>
<a name="l00813"></a>00813 
<a name="l00814"></a>00814          RS485_ENABLE = 0;
<a name="l00815"></a>00815          <a class="code" href="embedded_2mscb_8h.html#ad147e55136df8cab74bfb301feaa82ad">ES0</a> = 1;               <span class="comment">// re-enable serial interrupts</span>
<a name="l00816"></a>00816       }
<a name="l00817"></a>00817       <span class="keywordflow">break</span>;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a476471f02bd7f90ee2855990f76efada">CMD_SET_ADDR</a>:
<a name="l00820"></a>00820       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>, 1, 50);
<a name="l00821"></a>00821 
<a name="l00822"></a>00822       <span class="comment">/* set address in RAM */</span>
<a name="l00823"></a>00823       sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a> = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) (in_buf + 1));
<a name="l00824"></a>00824       sys_info.<a class="code" href="structSYS__INFO.html#a25a18bff28b36c17e51eb57e9b696d82">group_addr</a> = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) (in_buf + 3));
<a name="l00825"></a>00825 
<a name="l00826"></a>00826       <span class="comment">/* copy address to EEPROM */</span>
<a name="l00827"></a>00827       <a class="code" href="lcd__menu_8c.html#aabcaff382b5451e00dbbc74030962456">flash_param</a> = 1;
<a name="l00828"></a>00828 
<a name="l00829"></a>00829       <span class="comment">/* output new address */</span>
<a name="l00830"></a>00830       <a class="code" href="mscbmain_8c.html#a702b00abd141b68803e2f081251e11c2">new_address</a> = 1;
<a name="l00831"></a>00831       <span class="keywordflow">break</span>;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833    <span class="keywordflow">case</span> (<a class="code" href="embedded_2mscb_8h.html#a476471f02bd7f90ee2855990f76efada">CMD_SET_ADDR</a> | 0x07):
<a name="l00834"></a>00834       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>, 1, 50);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836       <span class="comment">/* set node name in RAM */</span>
<a name="l00837"></a>00837       <span class="keywordflow">for</span> (i = 0; i &lt; 16 &amp;&amp; i &lt; in_buf[1]; i++)
<a name="l00838"></a>00838          sys_info.<a class="code" href="structSYS__INFO.html#ae4e697a3de412f515d9f5dc3567cd71a">node_name</a>[i] = in_buf[2 + i];
<a name="l00839"></a>00839 
<a name="l00840"></a>00840       <span class="comment">/* copy address to EEPROM */</span>
<a name="l00841"></a>00841       <a class="code" href="lcd__menu_8c.html#aabcaff382b5451e00dbbc74030962456">flash_param</a> = 1;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843       <span class="comment">/* output new address */</span>
<a name="l00844"></a>00844       <a class="code" href="mscbmain_8c.html#a702b00abd141b68803e2f081251e11c2">new_address</a> = 1;
<a name="l00845"></a>00845       <span class="keywordflow">break</span>;
<a name="l00846"></a>00846 
<a name="l00847"></a>00847    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#ad5a7000009faea6bb4db59364db73a82">CMD_SET_BAUD</a>:
<a name="l00848"></a>00848       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>, 1, 50);
<a name="l00849"></a>00849       <span class="comment">//uart_init(0, in_buf[1]);</span>
<a name="l00850"></a>00850       <span class="keywordflow">break</span>;
<a name="l00851"></a>00851 
<a name="l00852"></a>00852    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a2b75b2a46fb9fb750e56f7f236f9435a">CMD_FREEZE</a>:
<a name="l00853"></a>00853       <a class="code" href="hvr__200_8c.html#ad140e1beb2bf61071df327f7434cae2e">FREEZE_MODE</a> = in_buf[1];
<a name="l00854"></a>00854       <span class="keywordflow">break</span>;
<a name="l00855"></a>00855 
<a name="l00856"></a>00856    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a1290d240b9bbc790c87c2a057c7ae188">CMD_SYNC</a>:
<a name="l00857"></a>00857       <a class="code" href="mscbmain_8c.html#ab0dab5dd672960abc1ece4881b38ae7c">SYNC_MODE</a> = in_buf[1];
<a name="l00858"></a>00858       <span class="keywordflow">break</span>;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a4fe5fe775dbb31c3e46c2a29c46b49c1">CMD_UPGRADE</a>:
<a name="l00861"></a>00861       <a class="code" href="mscbmain_8c.html#a825a905ed203dd98f546e97865f748a0">flash_program</a> = 1;
<a name="l00862"></a>00862       <span class="comment">/* acknowledge gets sent from upgrade() routine */</span>
<a name="l00863"></a>00863       <span class="keywordflow">break</span>;
<a name="l00864"></a>00864 
<a name="l00865"></a>00865    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#a3a49db5dd1b8ca7f6216db4308e85af7">CMD_FLASH</a>:
<a name="l00866"></a>00866       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>, 1, 50);
<a name="l00867"></a>00867 
<a name="l00868"></a>00868       <a class="code" href="lcd__menu_8c.html#aabcaff382b5451e00dbbc74030962456">flash_param</a> = 1;
<a name="l00869"></a>00869 
<a name="l00870"></a>00870       <span class="comment">/* send acknowledge */</span>
<a name="l00871"></a>00871       <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0] = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l00872"></a>00872       <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[1] = in_buf[<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> - 1];
<a name="l00873"></a>00873       <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a> = 2;
<a name="l00874"></a>00874       RS485_ENABLE = 1;
<a name="l00875"></a>00875       <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0];
<a name="l00876"></a>00876       <span class="keywordflow">break</span>;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878    <span class="keywordflow">case</span> <a class="code" href="embedded_2mscb_8h.html#aab2defcae52a43223ec9391230fad10a">CMD_ECHO</a>:
<a name="l00879"></a>00879       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(0, 1, 50);
<a name="l00880"></a>00880       <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0] = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a> + 1;
<a name="l00881"></a>00881       <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[1] = in_buf[1];
<a name="l00882"></a>00882       <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[2] = <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(<a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>, 2);
<a name="l00883"></a>00883       <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a> = 3;
<a name="l00884"></a>00884       RS485_ENABLE = 1;
<a name="l00885"></a>00885       <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0];
<a name="l00886"></a>00886       <span class="keywordflow">break</span>;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888    }
<a name="l00889"></a>00889 
<a name="l00890"></a>00890    <span class="keywordflow">if</span> (cmd == <a class="code" href="group__err26.html#ga9c953a6c538020e644127ee080608021">CMD_READ</a>) {
<a name="l00891"></a>00891       <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[0] == <a class="code" href="group__err26.html#ga9c953a6c538020e644127ee080608021">CMD_READ</a> + 1) {  <span class="comment">// single variable</span>
<a name="l00892"></a>00892          <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1] &lt; <a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a>) {
<a name="l00893"></a>00893             n = <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1]].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a>;     <span class="comment">// number of bytes to return</span>
<a name="l00894"></a>00894 
<a name="l00895"></a>00895             <span class="keywordflow">if</span> (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1]].flags &amp; <a class="code" href="embedded_2mscb_8h.html#a5102753876bd1b0a280e121264638696">MSCBF_DATALESS</a>) {
<a name="l00896"></a>00896                n = <a class="code" href="hvr__200_8c.html#ac7daae8fd6b3ddc2c0af7b870472088f">user_read</a>(<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1]);        <span class="comment">// for dataless variables, user routine returns bytes</span>
<a name="l00897"></a>00897                <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0] = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a> + n;        <span class="comment">// and places data directly in out_buf</span>
<a name="l00898"></a>00898 
<a name="l00899"></a>00899                <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[1 + n] = <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(<a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>, 1 + n);      <span class="comment">// generate CRC code</span>
<a name="l00900"></a>00900    
<a name="l00901"></a>00901                <span class="comment">/* send result */</span>
<a name="l00902"></a>00902 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00903"></a>00903 <span class="preprocessor"></span>               <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l00904"></a>00904 <span class="preprocessor">#endif</span>
<a name="l00905"></a>00905 <span class="preprocessor"></span>               <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a> = 2 + n;
<a name="l00906"></a>00906                RS485_ENABLE = 1;
<a name="l00907"></a>00907                <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0];
<a name="l00908"></a>00908 
<a name="l00909"></a>00909             } <span class="keywordflow">else</span> {
<a name="l00910"></a>00910 
<a name="l00911"></a>00911                <a class="code" href="hvr__200_8c.html#ac7daae8fd6b3ddc2c0af7b870472088f">user_read</a>(<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1]);
<a name="l00912"></a>00912 
<a name="l00913"></a>00913                <a class="code" href="embedded_2mscb_8h.html#ad147e55136df8cab74bfb301feaa82ad">ES0</a> = 0;            <span class="comment">// temporarily disable serial interrupt</span>
<a name="l00914"></a>00914                crc = 0;
<a name="l00915"></a>00915                RS485_ENABLE = 1;
<a name="l00916"></a>00916    
<a name="l00917"></a>00917                <span class="keywordflow">if</span> (n &gt; 6) {
<a name="l00918"></a>00918                   <span class="comment">/* variable length buffer */</span>
<a name="l00919"></a>00919                   <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(<a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a> + 7, &amp;crc);       <span class="comment">// send acknowledge, variable data length</span>
<a name="l00920"></a>00920                   <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(n, &amp;crc); <span class="comment">// send data length</span>
<a name="l00921"></a>00921 
<a name="l00922"></a>00922                   <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)           <span class="comment">// copy user data</span>
<a name="l00923"></a>00923                      <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(((<span class="keywordtype">char</span> *) <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1]].ud)[i+<a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>*<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>], &amp;crc);
<a name="l00924"></a>00924                   n++;
<a name="l00925"></a>00925                } <span class="keywordflow">else</span> {
<a name="l00926"></a>00926 
<a name="l00927"></a>00927                   <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(<a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a> + n, &amp;crc);       <span class="comment">// send acknowledge</span>
<a name="l00928"></a>00928                
<a name="l00929"></a>00929                   <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)           <span class="comment">// copy user data</span>
<a name="l00930"></a>00930                      <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(((<span class="keywordtype">char</span> *) <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1]].ud)[i+<a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>*<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>], &amp;crc);      
<a name="l00931"></a>00931                }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933                <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(crc, NULL);       <span class="comment">// send CRC code</span>
<a name="l00934"></a>00934    
<a name="l00935"></a>00935                RS485_ENABLE = 0;
<a name="l00936"></a>00936                <a class="code" href="embedded_2mscb_8h.html#ad147e55136df8cab74bfb301feaa82ad">ES0</a> = 1;            <span class="comment">// re-enable serial interrupts</span>
<a name="l00937"></a>00937             }
<a name="l00938"></a>00938          }
<a name="l00939"></a>00939       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[0] == <a class="code" href="group__err26.html#ga9c953a6c538020e644127ee080608021">CMD_READ</a> + 2) {   <span class="comment">// variable range</span>
<a name="l00940"></a>00940 
<a name="l00941"></a>00941         <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1] &lt; <a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a> &amp;&amp; <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[2] &lt; <a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a> &amp;&amp; <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1] &lt; <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[2]) {
<a name="l00942"></a>00942             <span class="comment">/* calculate number of bytes to return */</span>
<a name="l00943"></a>00943             <span class="keywordflow">for</span> (i = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1], n = 0; i &lt;= <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[2]; i++) {
<a name="l00944"></a>00944                <a class="code" href="hvr__200_8c.html#ac7daae8fd6b3ddc2c0af7b870472088f">user_read</a>(i);
<a name="l00945"></a>00945                n += <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a>;
<a name="l00946"></a>00946             }
<a name="l00947"></a>00947 
<a name="l00948"></a>00948             <a class="code" href="embedded_2mscb_8h.html#ad147e55136df8cab74bfb301feaa82ad">ES0</a> = 0;            <span class="comment">// temporarily disable serial interrupt</span>
<a name="l00949"></a>00949             crc = 0;
<a name="l00950"></a>00950             RS485_ENABLE = 1;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952             <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(<a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a> + 7, &amp;crc);       <span class="comment">// send acknowledge, variable data length</span>
<a name="l00953"></a>00953             <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(n, &amp;crc); <span class="comment">// send data length</span>
<a name="l00954"></a>00954 
<a name="l00955"></a>00955             <span class="comment">/* loop over all variables */</span>
<a name="l00956"></a>00956             <span class="keywordflow">for</span> (i = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1]; i &lt;= <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[2]; i++) {
<a name="l00957"></a>00957                <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a>; j++)    <span class="comment">// send user data</span>
<a name="l00958"></a>00958                   <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(((<span class="keywordtype">char</span> *) <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].ud)[j+<a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>*<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>], &amp;crc); 
<a name="l00959"></a>00959             }
<a name="l00960"></a>00960 
<a name="l00961"></a>00961             <a class="code" href="mscbmain_8c.html#a0105f7240e06e772815dfb5ec040782f">send_byte</a>(crc, NULL);       <span class="comment">// send CRC code</span>
<a name="l00962"></a>00962 
<a name="l00963"></a>00963             RS485_ENABLE = 0;
<a name="l00964"></a>00964             <a class="code" href="embedded_2mscb_8h.html#ad147e55136df8cab74bfb301feaa82ad">ES0</a> = 1;            <span class="comment">// re-enable serial interrupts</span>
<a name="l00965"></a>00965          }
<a name="l00966"></a>00966       }
<a name="l00967"></a>00967    }
<a name="l00968"></a>00968 
<a name="l00969"></a>00969    <span class="keywordflow">if</span> (cmd == <a class="code" href="embedded_2mscb_8h.html#ade442e4a8a0422396e7315f53f6099ed">CMD_USER</a>) {
<a name="l00970"></a>00970       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>, 1, 50);
<a name="l00971"></a>00971       n = <a class="code" href="hvr__200_8c.html#abc36d6fb31981dbb1b5effcc762dd9f8">user_func</a>(<a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a> + 1, <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a> + 1);
<a name="l00972"></a>00972       <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0] = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a> + n;
<a name="l00973"></a>00973       <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[n + 1] = <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(<a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>, n + 1);
<a name="l00974"></a>00974       <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a> = n + 2;
<a name="l00975"></a>00975 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l00976"></a>00976 <span class="preprocessor"></span>      <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l00977"></a>00977 <span class="preprocessor">#endif</span>
<a name="l00978"></a>00978 <span class="preprocessor"></span>      RS485_ENABLE = 1;
<a name="l00979"></a>00979       <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0];
<a name="l00980"></a>00980    }
<a name="l00981"></a>00981 
<a name="l00982"></a>00982    <span class="keywordflow">if</span> (cmd == <a class="code" href="embedded_2mscb_8h.html#a7b324516e7b17f8f46452d46a93cf0de">CMD_WRITE_NA</a> || cmd == <a class="code" href="embedded_2mscb_8h.html#a2dfc4e0f4778ba8f2d7ec78a937569c6">CMD_WRITE_ACK</a>) {
<a name="l00983"></a>00983 
<a name="l00984"></a>00984       <span class="comment">/* blink LED once when writing data */</span>
<a name="l00985"></a>00985       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>, 1, 50);
<a name="l00986"></a>00986 
<a name="l00987"></a>00987       n = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[0] &amp; 0x07;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989       <span class="keywordflow">if</span> (n == 0x07) {  <span class="comment">// variable length</span>
<a name="l00990"></a>00990          j = 1;
<a name="l00991"></a>00991          n = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1];
<a name="l00992"></a>00992          ch = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[2];
<a name="l00993"></a>00993       } <span class="keywordflow">else</span> {
<a name="l00994"></a>00994          j = 0;
<a name="l00995"></a>00995          ch = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[1];
<a name="l00996"></a>00996       }
<a name="l00997"></a>00997 
<a name="l00998"></a>00998       n--; <span class="comment">// data size (minus channel)</span>
<a name="l00999"></a>00999 
<a name="l01000"></a>01000       <span class="keywordflow">if</span> (ch &lt; <a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a>) {
<a name="l01001"></a>01001    
<a name="l01002"></a>01002          <span class="comment">/* don&apos;t exceed variable width */</span>
<a name="l01003"></a>01003          <span class="keywordflow">if</span> (n &gt; <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[ch].<a class="code" href="mainWindow_8cpp.html#a2474a5474cbff19523a51eb1de01cda4">width</a>)
<a name="l01004"></a>01004             n = <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[ch].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a>;
<a name="l01005"></a>01005 
<a name="l01006"></a>01006          <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l01007"></a>01007             <span class="keywordflow">if</span> (!(<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[ch].flags &amp; <a class="code" href="embedded_2mscb_8h.html#a5102753876bd1b0a280e121264638696">MSCBF_DATALESS</a>)) {
<a name="l01008"></a>01008                <span class="keywordflow">if</span> (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[ch].unit == <a class="code" href="embedded_2mscb_8h.html#a4a655ca16ba373d2ea05cdc8a9068251">UNIT_STRING</a>) {
<a name="l01009"></a>01009                   <span class="keywordflow">if</span> (n &gt; 4)
<a name="l01010"></a>01010                      <span class="comment">/* copy bytes in normal order */</span>
<a name="l01011"></a>01011                      ((<span class="keywordtype">char</span> *) <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[ch].ud)[i + <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>*<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>] = 
<a name="l01012"></a>01012                         <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[2 + j + i];
<a name="l01013"></a>01013                   <span class="keywordflow">else</span>
<a name="l01014"></a>01014                      <span class="comment">/* copy bytes in reverse order (got swapped on host) */</span>
<a name="l01015"></a>01015                      ((<span class="keywordtype">char</span> *) <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[ch].ud)[i + <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>*<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>] = 
<a name="l01016"></a>01016                         <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> - 2 - i];
<a name="l01017"></a>01017                } <span class="keywordflow">else</span>
<a name="l01018"></a>01018                   <span class="comment">/* copy LSB bytes, needed for BYTE if DWORD is sent */</span>
<a name="l01019"></a>01019                   ((<span class="keywordtype">char</span> *) <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[ch].ud)[i + <a class="code" href="mscbmain_8c.html#a892b7eef2de4caa27c45e96ffa30f4de">_var_size</a>*<a class="code" href="mscbmain_8c.html#acfda2fb899752a796542b599d0bc21d0">_cur_sub_addr</a>] = 
<a name="l01020"></a>01020                         <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> - 1 - <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[ch].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a> + i + j];
<a name="l01021"></a>01021             }
<a name="l01022"></a>01022 
<a name="l01023"></a>01023          <a class="code" href="hvr__200_8c.html#a78086e68bf7be32ce456293885a91f9c">user_write</a>(ch);
<a name="l01024"></a>01024 
<a name="l01025"></a>01025 <span class="preprocessor">#ifdef SCS_1000</span>
<a name="l01026"></a>01026 <span class="preprocessor"></span>         <span class="comment">/* mark variable to be send in main loop */</span>
<a name="l01027"></a>01027          var_to_send = ch;
<a name="l01028"></a>01028 <span class="preprocessor">#endif</span>
<a name="l01029"></a>01029 <span class="preprocessor"></span>
<a name="l01030"></a>01030          <span class="keywordflow">if</span> (cmd == <a class="code" href="embedded_2mscb_8h.html#a2dfc4e0f4778ba8f2d7ec78a937569c6">CMD_WRITE_ACK</a>) {
<a name="l01031"></a>01031             <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0] = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l01032"></a>01032             <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[1] = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> - 1];
<a name="l01033"></a>01033             <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a> = 2;
<a name="l01034"></a>01034 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span>            <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l01036"></a>01036 <span class="preprocessor">#endif</span>
<a name="l01037"></a>01037 <span class="preprocessor"></span>            RS485_ENABLE = 1;
<a name="l01038"></a>01038             <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0];
<a name="l01039"></a>01039          }
<a name="l01040"></a>01040       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch == 0xFF) {
<a name="l01041"></a>01041          <a class="code" href="ces8210_8c.html#aa811cfff7ed3e366dac57bec585d73ca">CSR</a> = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[2];
<a name="l01042"></a>01042 
<a name="l01043"></a>01043          <span class="keywordflow">if</span> (cmd == <a class="code" href="embedded_2mscb_8h.html#a2dfc4e0f4778ba8f2d7ec78a937569c6">CMD_WRITE_ACK</a>) {
<a name="l01044"></a>01044             <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0] = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l01045"></a>01045             <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[1] = <a class="code" href="mscbmain_8c.html#aa4dd6b80d0544f69ad03156c5a82dd3c">in_buf</a>[<a class="code" href="mscbmain_8c.html#aeedafb62760c75b91cda00c44b489fa5">i_in</a> - 1];
<a name="l01046"></a>01046             <a class="code" href="mscbmain_8c.html#a445642e13ae6ce3c9c72ef1e18f35c4d">n_out</a> = 2;
<a name="l01047"></a>01047 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01048"></a>01048 <span class="preprocessor"></span>            <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l01049"></a>01049 <span class="preprocessor">#endif</span>
<a name="l01050"></a>01050 <span class="preprocessor"></span>            RS485_ENABLE = 1;
<a name="l01051"></a>01051             <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="mscbmain_8c.html#ad577de96e9add92b9fced77357cffe1f">out_buf</a>[0];
<a name="l01052"></a>01052          }
<a name="l01053"></a>01053       }
<a name="l01054"></a>01054    }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056 
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01059"></a>01059 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01060"></a>01060 
<a name="l01061"></a>01061 <span class="preprocessor">#ifdef SCS_1000</span>
<a name="l01062"></a>01062 <span class="preprocessor"></span>
<a name="l01063"></a>01063 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> last_addr = -1;
<a name="l01064"></a>01064 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> xdata uart1_buf[10];
<a name="l01065"></a>01065 
<a name="l01066"></a>01066 <span class="keywordtype">void</span> poll_remote_vars()
<a name="l01067"></a>01067 {
<a name="l01068"></a>01068 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>;
<a name="l01069"></a>01069 
<a name="l01070"></a>01070    <span class="keywordflow">for</span> (i=0 ; i&lt;<a class="code" href="lcd__menu_8c.html#a0de9f3f7c389cbccf3f52ee056dff0c0">n_variables</a> ; i++)
<a name="l01071"></a>01071       <span class="keywordflow">if</span> (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].flags &amp; <a class="code" href="embedded_2mscb_8h.html#aae94fc98d500b5c6a3169bd3b1832ffa">MSCBF_REMIN</a>) {
<a name="l01072"></a>01072          
<a name="l01073"></a>01073          <span class="comment">/* address remote node */</span>
<a name="l01074"></a>01074          <span class="keywordflow">if</span> (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].node_address != last_addr) {
<a name="l01075"></a>01075             uart1_buf[0] = <a class="code" href="embedded_2mscb_8h.html#a874333c022591217260cfae847df88c8">CMD_ADDR_NODE16</a>;
<a name="l01076"></a>01076             uart1_buf[1] = (<span class="keywordtype">unsigned</span> char) (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].node_address &gt;&gt; 8);
<a name="l01077"></a>01077             uart1_buf[2] = (<span class="keywordtype">unsigned</span> char) (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].node_address &amp; 0xFF);
<a name="l01078"></a>01078             uart1_buf[3] = <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(uart1_buf, 3);
<a name="l01079"></a>01079             <a class="code" href="embedded_2mscb_8h.html#a3d21cc4f902935e980ffe05793d216ad">uart1_send</a>(uart1_buf, 4);
<a name="l01080"></a>01080             last_addr = <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].node_address;
<a name="l01081"></a>01081          }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083          <span class="comment">/* read variable */</span>
<a name="l01084"></a>01084          uart1_buf[0] = <a class="code" href="group__err26.html#ga9c953a6c538020e644127ee080608021">CMD_READ</a> + 1;
<a name="l01085"></a>01085          uart1_buf[1] = <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].channel;
<a name="l01086"></a>01086          uart1_buf[2] = <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(uart1_buf, 2);
<a name="l01087"></a>01087          <a class="code" href="embedded_2mscb_8h.html#a3d21cc4f902935e980ffe05793d216ad">uart1_send</a>(uart1_buf, 4);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089          n = <a class="code" href="embedded_2mscb_8h.html#ad0c8f08f958888a55a21534a7bd539a3">uart1_receive</a>(uart1_buf, 10);
<a name="l01090"></a>01090          <span class="keywordflow">if</span> (n&lt;2)
<a name="l01091"></a>01091             <span class="keywordflow">continue</span>; <span class="comment">// no bytes receive</span>
<a name="l01092"></a>01092 
<a name="l01093"></a>01093          <span class="keywordflow">if</span> (uart1_buf[0] != <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a> + n - 2)
<a name="l01094"></a>01094             <span class="keywordflow">continue</span>; <span class="comment">// invalid command received</span>
<a name="l01095"></a>01095 
<a name="l01096"></a>01096          <span class="keywordflow">if</span> (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="mainWindow_8cpp.html#a2474a5474cbff19523a51eb1de01cda4">width</a> != n - 2)
<a name="l01097"></a>01097             <span class="keywordflow">continue</span>; <span class="comment">// variables has wrong length</span>
<a name="l01098"></a>01098 
<a name="l01099"></a>01099          <span class="keywordflow">if</span> (uart1_buf[n-1] != <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(uart1_buf, n-1))
<a name="l01100"></a>01100             <span class="keywordflow">continue</span>; <span class="comment">// invalid CRC</span>
<a name="l01101"></a>01101 
<a name="l01102"></a>01102          <span class="comment">/* all ok, so copy variable */</span>
<a name="l01103"></a>01103          memcpy(<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].ud, uart1_buf+1, <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="mainWindow_8cpp.html#a2474a5474cbff19523a51eb1de01cda4">width</a>);
<a name="l01104"></a>01104            }
<a name="l01105"></a>01105 }
<a name="l01106"></a>01106 
<a name="l01107"></a>01107 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01108"></a>01108 
<a name="l01109"></a>01109 <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a59bf5abe8b226c54ea7c1104e698733a">send_remote_var</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i)
<a name="l01110"></a>01110 {
<a name="l01111"></a>01111 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l01112"></a>01112 
<a name="l01113"></a>01113    <span class="comment">/* address remote node */</span>
<a name="l01114"></a>01114    <span class="keywordflow">if</span> (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].node_address != last_addr) {
<a name="l01115"></a>01115       uart1_buf[0] = <a class="code" href="embedded_2mscb_8h.html#a874333c022591217260cfae847df88c8">CMD_ADDR_NODE16</a>;
<a name="l01116"></a>01116       uart1_buf[1] = (<span class="keywordtype">unsigned</span> char) (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].node_address &gt;&gt; 8);
<a name="l01117"></a>01117       uart1_buf[2] = (<span class="keywordtype">unsigned</span> char) (<a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].node_address &amp; 0xFF);
<a name="l01118"></a>01118       uart1_buf[3] = <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(uart1_buf, 3);
<a name="l01119"></a>01119       <a class="code" href="embedded_2mscb_8h.html#a3d21cc4f902935e980ffe05793d216ad">uart1_send</a>(uart1_buf, 4);
<a name="l01120"></a>01120       last_addr = <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].node_address;
<a name="l01121"></a>01121    }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123    <span class="comment">/* send variable */</span>
<a name="l01124"></a>01124    size = <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].<a class="code" href="structMSCB__INFO__VAR.html#ac30ec9a942c12fb886c2bd550d053c28">width</a>;
<a name="l01125"></a>01125    uart1_buf[0] = <a class="code" href="embedded_2mscb_8h.html#a7b324516e7b17f8f46452d46a93cf0de">CMD_WRITE_NA</a> + size + 1;
<a name="l01126"></a>01126    uart1_buf[1] = i;
<a name="l01127"></a>01127    memcpy(uart1_buf+2, <a class="code" href="hvr__200_8c.html#a900ff3a8ccab65692c28b012e3824819">variables</a>[i].ud, size);
<a name="l01128"></a>01128    uart1_buf[2+size] = <a class="code" href="embedded_2mscb_8h.html#a92317b8fbef36cb36421636cd1287520">crc8</a>(uart1_buf, 2+size);
<a name="l01129"></a>01129    <a class="code" href="embedded_2mscb_8h.html#a3d21cc4f902935e980ffe05793d216ad">uart1_send</a>(uart1_buf, 3+size);
<a name="l01130"></a>01130 }
<a name="l01131"></a>01131 
<a name="l01132"></a>01132 <span class="preprocessor">#endif</span>
<a name="l01133"></a>01133 <span class="preprocessor"></span>
<a name="l01134"></a>01134 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01135"></a>01135 
<a name="l01136"></a>01136 <span class="preprocessor">#ifdef LED_0</span>
<a name="l01137"></a>01137 <span class="preprocessor"></span>sbit <a class="code" href="subm__250_8c.html#ae06893434b09005871d20c1697bfac29">led_0</a> = LED_0;
<a name="l01138"></a>01138 <span class="preprocessor">#endif</span>
<a name="l01139"></a>01139 <span class="preprocessor"></span>
<a name="l01140"></a><a class="code" href="mscbmain_8c.html#aa2195489dc92187d19fccce7a232b12a">01140</a> <span class="keywordtype">void</span> <a class="code" href="mscbmain_8c.html#aa2195489dc92187d19fccce7a232b12a">upgrade</a>()
<a name="l01141"></a>01141 {
<a name="l01142"></a>01142 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l01143"></a>01143 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, page, crc, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="odbhist_8c.html#a43fa990200c3ddd47c35f151bd4d66bf">k</a>;
<a name="l01144"></a>01144    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> i;
<a name="l01145"></a>01145    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> xdata *pw;
<a name="l01146"></a>01146    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> code *pr;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148    <span class="comment">/* disable all interrupts */</span>
<a name="l01149"></a>01149    <a class="code" href="c8051F000_8h.html#ae524fa4918208f2da654a7887bd9a7d0">EA</a> = 0;
<a name="l01150"></a>01150 
<a name="l01151"></a>01151    <span class="comment">/* disable watchdog */</span>
<a name="l01152"></a>01152 <span class="preprocessor">#if defined(CPU_C8051F310)</span>
<a name="l01153"></a>01153 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a4dda2378d1fb76a3c9430bb0ae1619c9">PCA0MD</a> = 0x00;
<a name="l01154"></a>01154 <span class="preprocessor">#else</span>
<a name="l01155"></a>01155 <span class="preprocessor"></span>   <a class="code" href="c8051F000_8h.html#a2eb7f8e96149deeec0f227384694807b">WDTCN</a> = 0xDE;
<a name="l01156"></a>01156    <a class="code" href="c8051F000_8h.html#a2eb7f8e96149deeec0f227384694807b">WDTCN</a> = 0xAD;
<a name="l01157"></a>01157 <span class="preprocessor">#endif</span>
<a name="l01158"></a>01158 <span class="preprocessor"></span>
<a name="l01159"></a>01159    cmd = page = 0;
<a name="l01160"></a>01160 
<a name="l01161"></a>01161    <span class="comment">/* send acknowledge */</span>
<a name="l01162"></a>01162 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01163"></a>01163 <span class="preprocessor"></span>   <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l01164"></a>01164 <span class="preprocessor">#endif</span>
<a name="l01165"></a>01165 <span class="preprocessor"></span>
<a name="l01166"></a>01166    RS485_ENABLE = 1;
<a name="l01167"></a>01167    <a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> = 0;
<a name="l01168"></a>01168    <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l01169"></a>01169    <span class="keywordflow">while</span> (<a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> == 0);
<a name="l01170"></a>01170    <a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> = 0;
<a name="l01171"></a>01171    <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = 0; <span class="comment">// dummy CRC</span>
<a name="l01172"></a>01172    <span class="keywordflow">while</span> (<a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> == 0);
<a name="l01173"></a>01173    RS485_ENABLE = 0;
<a name="l01174"></a>01174 
<a name="l01175"></a>01175    <span class="keywordflow">do</span> {
<a name="l01176"></a>01176       <span class="comment">/* receive command */</span>
<a name="l01177"></a>01177       <span class="keywordflow">while</span> (!<a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a>);
<a name="l01178"></a>01178 
<a name="l01179"></a>01179       cmd = <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a>;
<a name="l01180"></a>01180       <a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a> = 0;
<a name="l01181"></a>01181       crc = 0;
<a name="l01182"></a>01182 
<a name="l01183"></a>01183       <span class="keywordflow">switch</span> (cmd) {
<a name="l01184"></a>01184       <span class="keywordflow">case</span> 1:                      <span class="comment">// return acknowledge</span>
<a name="l01185"></a>01185          <span class="keywordflow">break</span>;
<a name="l01186"></a>01186 
<a name="l01187"></a>01187       <span class="keywordflow">case</span> 2:                      <span class="comment">// erase page</span>
<a name="l01188"></a>01188          <span class="comment">/* receive page */</span>
<a name="l01189"></a>01189          <span class="keywordflow">while</span> (!<a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a>);
<a name="l01190"></a>01190          page = <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a>;
<a name="l01191"></a>01191          <a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a> = 0;
<a name="l01192"></a>01192 
<a name="l01193"></a>01193          <span class="comment">/* erase page if not page of upgrade() function */</span>
<a name="l01194"></a>01194          <span class="keywordflow">if</span> (page * 512 &lt; (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="mscbmain_8c.html#aa2195489dc92187d19fccce7a232b12a">upgrade</a>) {
<a name="l01195"></a>01195 
<a name="l01196"></a>01196 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01197"></a>01197 <span class="preprocessor"></span>            <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a8118771b603f497803d635449ba11021">LEGACY_PAGE</a>;
<a name="l01198"></a>01198 <span class="preprocessor">#endif</span>
<a name="l01199"></a>01199 <span class="preprocessor"></span>
<a name="l01200"></a>01200 <span class="preprocessor">#if defined(CPU_C8051F000)</span>
<a name="l01201"></a>01201 <span class="preprocessor"></span>            <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = (<a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> &amp; 0xF0) | 0x08; <span class="comment">// set timer for 11.052 MHz clock</span>
<a name="l01202"></a>01202 <span class="preprocessor">#elif defined (CPU_C8051F020) || defined(CPU_C8051F120)</span>
<a name="l01203"></a>01203 <span class="preprocessor"></span>            <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> | 1;     <span class="comment">// enable flash writes</span>
<a name="l01204"></a>01204 <span class="preprocessor">#endif</span>
<a name="l01205"></a>01205 <span class="preprocessor"></span>            <a class="code" href="c8051F000_8h.html#ab962028f8eb562297e7b38d7806ba21c">PSCTL</a> = 0x03;          <span class="comment">// allow write and erase</span>
<a name="l01206"></a>01206    
<a name="l01207"></a>01207             pw = (<span class="keywordtype">char</span> xdata *) (512 * page);
<a name="l01208"></a>01208    
<a name="l01209"></a>01209 <span class="preprocessor">#if defined(CPU_C8051F310)</span>
<a name="l01210"></a>01210 <span class="preprocessor"></span>            <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = 0xA5;          <span class="comment">// write flash key code</span>
<a name="l01211"></a>01211             <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = 0xF1;
<a name="l01212"></a>01212 <span class="preprocessor">#endif</span>
<a name="l01213"></a>01213 <span class="preprocessor"></span>            
<a name="l01214"></a>01214             *pw = 0;
<a name="l01215"></a>01215    
<a name="l01216"></a>01216             <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = (<a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> &amp; 0xF0);
<a name="l01217"></a>01217             <a class="code" href="c8051F000_8h.html#ab962028f8eb562297e7b38d7806ba21c">PSCTL</a> = 0x00;
<a name="l01218"></a>01218          } <span class="keywordflow">else</span> {
<a name="l01219"></a>01219             crc = 0xFF;            <span class="comment">// return &apos;protected&apos; flag</span>
<a name="l01220"></a>01220          }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222          <span class="keywordflow">break</span>;
<a name="l01223"></a>01223 
<a name="l01224"></a>01224       <span class="keywordflow">case</span> 3:                      <span class="comment">// program page</span>
<a name="l01225"></a>01225 <span class="preprocessor">#ifdef LED_0</span>
<a name="l01226"></a>01226 <span class="preprocessor"></span>         led_0 = <a class="code" href="embedded_2mscb_8h.html#a80700bb63bd56ebabbb4728aa433fd29">LED_OFF</a>;
<a name="l01227"></a>01227 <span class="preprocessor">#endif</span>
<a name="l01228"></a>01228 <span class="preprocessor"></span>
<a name="l01229"></a>01229          <span class="comment">/* receive page */</span>
<a name="l01230"></a>01230          <span class="keywordflow">while</span> (!<a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a>);
<a name="l01231"></a>01231          page = <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a>;
<a name="l01232"></a>01232          <a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a> = 0;
<a name="l01233"></a>01233 
<a name="l01234"></a>01234 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01235"></a>01235 <span class="preprocessor"></span>         <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a8118771b603f497803d635449ba11021">LEGACY_PAGE</a>;
<a name="l01236"></a>01236 <span class="preprocessor">#endif</span>
<a name="l01237"></a>01237 <span class="preprocessor"></span>
<a name="l01238"></a>01238          <span class="comment">/* allow write */</span>
<a name="l01239"></a>01239 <span class="preprocessor">#if defined(CPU_C8051F000)</span>
<a name="l01240"></a>01240 <span class="preprocessor"></span>         <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = (<a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> &amp; 0xF0) | 0x08; <span class="comment">// set timer for 11.052 MHz clock</span>
<a name="l01241"></a>01241 <span class="preprocessor">#elif defined (CPU_C8051F020) || defined(CPU_C8051F120)</span>
<a name="l01242"></a>01242 <span class="preprocessor"></span>         <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> | 1;        <span class="comment">// enable flash writes</span>
<a name="l01243"></a>01243 <span class="preprocessor">#endif</span>
<a name="l01244"></a>01244 <span class="preprocessor"></span>         <a class="code" href="c8051F000_8h.html#ab962028f8eb562297e7b38d7806ba21c">PSCTL</a> = 0x01;             <span class="comment">// allow write access</span>
<a name="l01245"></a>01245 
<a name="l01246"></a>01246          pw = (<span class="keywordtype">char</span> xdata *) (512 * page);
<a name="l01247"></a>01247 
<a name="l01248"></a>01248 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01249"></a>01249 <span class="preprocessor"></span>         <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l01250"></a>01250 <span class="preprocessor">#endif</span>
<a name="l01251"></a>01251 <span class="preprocessor"></span>
<a name="l01252"></a>01252          <span class="keywordflow">for</span> (j=0 ; j&lt;8 ; j++) {
<a name="l01253"></a>01253    
<a name="l01254"></a>01254             <span class="comment">/* receive 60 bytes */</span>
<a name="l01255"></a>01255             <span class="keywordflow">for</span> (k = 0; k &lt; 60; k++) {
<a name="l01256"></a>01256                <span class="comment">/* receive byte */</span>
<a name="l01257"></a>01257                <span class="keywordflow">while</span> (!<a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a>);
<a name="l01258"></a>01258    
<a name="l01259"></a>01259 <span class="preprocessor">#if defined(CPU_C8051F310)</span>
<a name="l01260"></a>01260 <span class="preprocessor"></span>               <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = 0xA5;          <span class="comment">// write flash key code</span>
<a name="l01261"></a>01261                <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = 0xF1;
<a name="l01262"></a>01262 <span class="preprocessor">#endif</span>
<a name="l01263"></a>01263 <span class="preprocessor"></span>               <span class="comment">/* flash byte */</span>
<a name="l01264"></a>01264                *pw++ = <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a>;
<a name="l01265"></a>01265                <a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a> = 0;
<a name="l01266"></a>01266             }
<a name="l01267"></a>01267    
<a name="l01268"></a>01268             <span class="comment">/* send ACK after each 60 bytes */</span>
<a name="l01269"></a>01269             RS485_ENABLE = 1;
<a name="l01270"></a>01270             <a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> = 0;
<a name="l01271"></a>01271             <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l01272"></a>01272             <span class="keywordflow">while</span> (<a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> == 0);
<a name="l01273"></a>01273             <a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> = 0;
<a name="l01274"></a>01274             <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = 0;
<a name="l01275"></a>01275             <span class="keywordflow">while</span> (<a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> == 0);
<a name="l01276"></a>01276             RS485_ENABLE = 0;
<a name="l01277"></a>01277          }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279          <span class="comment">/* receive remaining 32 bytes */</span>
<a name="l01280"></a>01280          <span class="keywordflow">for</span> (k = 0; k &lt; 32; k++) {
<a name="l01281"></a>01281             <span class="comment">/* receive byte */</span>
<a name="l01282"></a>01282             <span class="keywordflow">while</span> (!<a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a>);
<a name="l01283"></a>01283 
<a name="l01284"></a>01284 <span class="preprocessor">#if defined(CPU_C8051F310)</span>
<a name="l01285"></a>01285 <span class="preprocessor"></span>            <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = 0xA5;          <span class="comment">// write flash key code</span>
<a name="l01286"></a>01286             <a class="code" href="c8051F310_8h.html#ae49102c0fd5a01b7edd91e8679a66cf1">FLKEY</a> = 0xF1;
<a name="l01287"></a>01287 <span class="preprocessor">#endif</span>
<a name="l01288"></a>01288 <span class="preprocessor"></span>            <span class="comment">/* flash byte */</span>
<a name="l01289"></a>01289             *pw++ = <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a>;
<a name="l01290"></a>01290             <a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a> = 0;
<a name="l01291"></a>01291          }
<a name="l01292"></a>01292 
<a name="l01293"></a>01293 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01294"></a>01294 <span class="preprocessor"></span>         <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a8118771b603f497803d635449ba11021">LEGACY_PAGE</a>;
<a name="l01295"></a>01295 <span class="preprocessor">#endif</span>
<a name="l01296"></a>01296 <span class="preprocessor"></span>
<a name="l01297"></a>01297          <span class="comment">/* disable write */</span>
<a name="l01298"></a>01298          <a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> = (<a class="code" href="c8051F000_8h.html#a7a5173a3492e05b54a933fcaec8faaea">FLSCL</a> &amp; 0xF0);
<a name="l01299"></a>01299          <a class="code" href="c8051F000_8h.html#ab962028f8eb562297e7b38d7806ba21c">PSCTL</a> = 0x00;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301          <span class="keywordflow">break</span>;
<a name="l01302"></a>01302 
<a name="l01303"></a>01303       <span class="keywordflow">case</span> 4:                      <span class="comment">// verify page</span>
<a name="l01304"></a>01304 <span class="preprocessor">#ifdef LED_0</span>
<a name="l01305"></a>01305 <span class="preprocessor"></span>         led_0 = LED_ON;
<a name="l01306"></a>01306 <span class="preprocessor">#endif</span>
<a name="l01307"></a>01307 <span class="preprocessor"></span>
<a name="l01308"></a>01308          <span class="comment">/* receive page */</span>
<a name="l01309"></a>01309          <span class="keywordflow">while</span> (!<a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a>);
<a name="l01310"></a>01310          page = <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a>;
<a name="l01311"></a>01311          <a class="code" href="embedded_2mscb_8h.html#a71cd7e9e2cf7b78014d3ec96ce3f9b4b">RI0</a> = 0;
<a name="l01312"></a>01312 
<a name="l01313"></a>01313          pr = 512 * page;
<a name="l01314"></a>01314 
<a name="l01315"></a>01315          <span class="comment">/* return simplified CRC */</span>
<a name="l01316"></a>01316          <span class="keywordflow">for</span> (i = crc = 0; i &lt; 512; i++)
<a name="l01317"></a>01317             crc += *pr++;
<a name="l01318"></a>01318 
<a name="l01319"></a>01319          <span class="keywordflow">break</span>;
<a name="l01320"></a>01320 
<a name="l01321"></a>01321       <span class="keywordflow">case</span> 5:                      <span class="comment">// reboot</span>
<a name="l01322"></a>01322 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01323"></a>01323 <span class="preprocessor"></span>         <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a8118771b603f497803d635449ba11021">LEGACY_PAGE</a>;
<a name="l01324"></a>01324 <span class="preprocessor">#endif</span>
<a name="l01325"></a>01325 <span class="preprocessor"></span>         <a class="code" href="c8051F000_8h.html#af35967bca631ac4037a98d322d18abfb">RSTSRC</a> = 0x10;
<a name="l01326"></a>01326          <span class="keywordflow">break</span>;
<a name="l01327"></a>01327 
<a name="l01328"></a>01328       <span class="keywordflow">case</span> 6:                      <span class="comment">// return</span>
<a name="l01329"></a>01329          <span class="keywordflow">break</span>;
<a name="l01330"></a>01330       }
<a name="l01331"></a>01331 
<a name="l01332"></a>01332 <span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01333"></a>01333 <span class="preprocessor"></span>      <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a68f53cbb5336685c7582b242042e77b9">UART0_PAGE</a>;
<a name="l01334"></a>01334 <span class="preprocessor">#endif</span>
<a name="l01335"></a>01335 <span class="preprocessor"></span>
<a name="l01336"></a>01336       <span class="comment">/* return acknowledge */</span>
<a name="l01337"></a>01337       RS485_ENABLE = 1;
<a name="l01338"></a>01338       <a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> = 0;
<a name="l01339"></a>01339       <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = <a class="code" href="embedded_2mscb_8h.html#a7739ed085bf0c7d6317e86bcaa1c4952">CMD_ACK</a>;
<a name="l01340"></a>01340       <span class="keywordflow">while</span> (<a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> == 0);
<a name="l01341"></a>01341       <a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> = 0;
<a name="l01342"></a>01342       <a class="code" href="embedded_2mscb_8h.html#a194a6d4c7e8cb3cf91b24b51708fc4fe">SBUF0</a> = crc;
<a name="l01343"></a>01343       <span class="keywordflow">while</span> (<a class="code" href="embedded_2mscb_8h.html#a7344b3875ef40c3cd59eafcfd541418b">TI0</a> == 0);
<a name="l01344"></a>01344       RS485_ENABLE = 0;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346    } <span class="keywordflow">while</span> (cmd != 6);
<a name="l01347"></a>01347 
<a name="l01348"></a>01348 
<a name="l01349"></a>01349    <a class="code" href="c8051F000_8h.html#ae524fa4918208f2da654a7887bd9a7d0">EA</a> = 1;                      <span class="comment">// re-enable interrupts</span>
<a name="l01350"></a>01350 
<a name="l01351"></a>01351 <span class="preprocessor">#endif                          // CPU_CYGNAL</span>
<a name="l01352"></a>01352 <span class="preprocessor"></span>}
<a name="l01353"></a>01353 
<a name="l01354"></a>01354 <span class="comment">/*------------------------------------------------------------------*\</span>
<a name="l01355"></a>01355 <span class="comment"></span>
<a name="l01356"></a>01356 <span class="comment">  Yield should be called periodically by applications with long loops</span>
<a name="l01357"></a>01357 <span class="comment">  to insure proper watchdog refresh and other functions</span>
<a name="l01358"></a>01358 <span class="comment"></span>
<a name="l01359"></a>01359 <span class="comment">\*------------------------------------------------------------------*/</span>
<a name="l01360"></a>01360 
<a name="l01361"></a><a class="code" href="mscbmain_8c.html#a7cb51f5c2b5cad3766f19eb69c92793b">01361</a> <span class="keywordtype">void</span> <a class="code" href="embedded_2mscb_8h.html#a7cb51f5c2b5cad3766f19eb69c92793b">yield</a>(<span class="keywordtype">void</span>)
<a name="l01362"></a>01362 {
<a name="l01363"></a>01363    <a class="code" href="embedded_2mscb_8h.html#a4ae5ad65c961268051560516eeff623f">watchdog_refresh</a>();
<a name="l01364"></a>01364 
<a name="l01365"></a>01365    <span class="comment">/* output debug info to LCD if asked by interrupt routine */</span>
<a name="l01366"></a>01366    <a class="code" href="mscbmain_8c.html#a7306300d086cb79f19b2da6743cf4572">debug_output</a>();
<a name="l01367"></a>01367 
<a name="l01368"></a>01368    <span class="comment">/* output RS232 data if present */</span>
<a name="l01369"></a>01369    <a class="code" href="mscbmain_8c.html#a179877b003d63996470f7b628a57eeac">rs232_output</a>();
<a name="l01370"></a>01370 
<a name="l01371"></a>01371    <span class="comment">/* manage remote variables on SCS-1000 */</span>
<a name="l01372"></a>01372 <span class="preprocessor">#ifdef SCS_1000</span>
<a name="l01373"></a>01373 <span class="preprocessor"></span>   poll_remote_vars();
<a name="l01374"></a>01374 
<a name="l01375"></a>01375    <span class="keywordflow">if</span> (var_to_send != 0xFF) {
<a name="l01376"></a>01376       <a class="code" href="embedded_2mscb_8h.html#a59bf5abe8b226c54ea7c1104e698733a">send_remote_var</a>(var_to_send);
<a name="l01377"></a>01377       var_to_send = 0xFF;
<a name="l01378"></a>01378    }
<a name="l01379"></a>01379 <span class="preprocessor">#endif</span>
<a name="l01380"></a>01380 <span class="preprocessor"></span>
<a name="l01381"></a>01381    <span class="comment">/* output new address to LCD if available */</span>
<a name="l01382"></a>01382 <span class="preprocessor">#if !defined(CPU_ADUC812) &amp;&amp; !defined(SCS_300) &amp;&amp; !defined(SCS_210)     // SCS210/300 redefine printf()</span>
<a name="l01383"></a>01383 <span class="preprocessor"></span><span class="preprocessor">#ifdef LCD_DEBUG</span>
<a name="l01384"></a>01384 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#a702b00abd141b68803e2f081251e11c2">new_address</a>) {
<a name="l01385"></a>01385       <a class="code" href="mscbmain_8c.html#a702b00abd141b68803e2f081251e11c2">new_address</a> = 0;
<a name="l01386"></a>01386       <a class="code" href="embedded_2mscb_8h.html#a35c08b1fa742e650f4873939707b893b">lcd_clear</a>();
<a name="l01387"></a>01387       printf(<span class="stringliteral">&quot;AD:%04X GA:%04X WD:%d&quot;</span>, sys_info.<a class="code" href="structSYS__INFO.html#ae65c965a20b1111e06f271aaf731e55c">node_addr</a>,
<a name="l01388"></a>01388              sys_info.<a class="code" href="structSYS__INFO.html#a25a18bff28b36c17e51eb57e9b696d82">group_addr</a>, sys_info.<a class="code" href="structSYS__INFO.html#ae9d2e8538fd1189499620aa56997503b">wd_counter</a>);
<a name="l01389"></a>01389    }
<a name="l01390"></a>01390 <span class="preprocessor">#endif</span>
<a name="l01391"></a>01391 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01392"></a>01392 <span class="preprocessor"></span>
<a name="l01393"></a>01393    <span class="comment">/* blink LED if not configured */</span>
<a name="l01394"></a>01394    <span class="keywordflow">if</span> (!<a class="code" href="mscbmain_8c.html#a151774571a646bf208b696356f42b58c">configured</a>)
<a name="l01395"></a>01395       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(0, 1, 50);
<a name="l01396"></a>01396 
<a name="l01397"></a>01397    <span class="comment">/* blink LED if wrong CPU */</span>
<a name="l01398"></a>01398    <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#a824bf8df11ab6852c3d9005276a6a8bf">wrong_cpu</a>)
<a name="l01399"></a>01399       <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(0, 1, 30);
<a name="l01400"></a>01400 
<a name="l01401"></a>01401    <span class="comment">/* flash EEPROM if asked by interrupt routine, wait 5 sec</span>
<a name="l01402"></a>01402 <span class="comment">      after reboot (power might not be stable) */</span>
<a name="l01403"></a>01403    <span class="keywordflow">if</span> (<a class="code" href="lcd__menu_8c.html#aabcaff382b5451e00dbbc74030962456">flash_param</a> &amp;&amp; <a class="code" href="mscbmain_8c.html#a2fa4da5a3b0e9901a02d65bdefddd24e">flash_allowed</a>) {
<a name="l01404"></a>01404       <a class="code" href="lcd__menu_8c.html#aabcaff382b5451e00dbbc74030962456">flash_param</a> = 0;
<a name="l01405"></a>01405 
<a name="l01406"></a>01406       <span class="comment">/* reset watchdog counts */</span>
<a name="l01407"></a>01407       sys_info.<a class="code" href="structSYS__INFO.html#ae9d2e8538fd1189499620aa56997503b">wd_counter</a> = 0;
<a name="l01408"></a>01408 
<a name="l01409"></a>01409       <a class="code" href="mscbmain_8c.html#aab1037491179d86a89ac750947c0b1f1">_flkey</a> = 0xF1;
<a name="l01410"></a>01410       <a class="code" href="embedded_2mscb_8h.html#a29eb7958d7590c990a4be07ccb7f9199">eeprom_flash</a>();
<a name="l01411"></a>01411            <a class="code" href="mscbmain_8c.html#a151774571a646bf208b696356f42b58c">configured</a> = 1;
<a name="l01412"></a>01412    }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414    <span class="keywordflow">if</span> (<a class="code" href="mscbmain_8c.html#a825a905ed203dd98f546e97865f748a0">flash_program</a> &amp;&amp; <a class="code" href="mscbmain_8c.html#a2fa4da5a3b0e9901a02d65bdefddd24e">flash_allowed</a>) {
<a name="l01415"></a>01415       <a class="code" href="mscbmain_8c.html#a825a905ed203dd98f546e97865f748a0">flash_program</a> = 0;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417       <span class="comment">/* go to &quot;bootloader&quot; program */</span>
<a name="l01418"></a>01418       <a class="code" href="mscbmain_8c.html#aa2195489dc92187d19fccce7a232b12a">upgrade</a>();
<a name="l01419"></a>01419    }
<a name="l01420"></a>01420 
<a name="l01421"></a>01421    <span class="comment">/* allow flash 5 sec after reboot */</span>
<a name="l01422"></a>01422    <span class="keywordflow">if</span> (<a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>() &gt; 500)
<a name="l01423"></a>01423       <a class="code" href="mscbmain_8c.html#a2fa4da5a3b0e9901a02d65bdefddd24e">flash_allowed</a> = 1;
<a name="l01424"></a>01424 
<a name="l01425"></a>01425    <span class="keywordflow">if</span> (<a class="code" href="lcd__menu_8c.html#a5ade110c24cb0b1320f21ba7888efc78">reboot</a>) {
<a name="l01426"></a>01426 <span class="preprocessor">#ifdef CPU_CYGNAL</span>
<a name="l01427"></a>01427 <span class="preprocessor"></span><span class="preprocessor">#ifdef CPU_C8051F120</span>
<a name="l01428"></a>01428 <span class="preprocessor"></span>      <a class="code" href="c8051F120_8h.html#adf48f71a31bb3012446e2fed7219a3d4">SFRPAGE</a> = <a class="code" href="c8051F120_8h.html#a8118771b603f497803d635449ba11021">LEGACY_PAGE</a>;
<a name="l01429"></a>01429 <span class="preprocessor">#endif</span>
<a name="l01430"></a>01430 <span class="preprocessor"></span>
<a name="l01431"></a>01431       <a class="code" href="c8051F000_8h.html#af35967bca631ac4037a98d322d18abfb">RSTSRC</a> = 0x10;         <span class="comment">// force software reset</span>
<a name="l01432"></a>01432 <span class="preprocessor">#else</span>
<a name="l01433"></a>01433 <span class="preprocessor"></span>      WDCON = 0x00;          <span class="comment">// 16 msec</span>
<a name="l01434"></a>01434       WDE = 1;
<a name="l01435"></a>01435       <span class="keywordflow">while</span> (1);             <span class="comment">// should be hardware reset later...</span>
<a name="l01436"></a>01436 <span class="preprocessor">#endif</span>
<a name="l01437"></a>01437 <span class="preprocessor"></span>   }
<a name="l01438"></a>01438 
<a name="l01439"></a>01439 }
<a name="l01440"></a>01440 
<a name="l01441"></a>01441 <span class="comment">/*------------------------------------------------------------------*\</span>
<a name="l01442"></a>01442 <span class="comment"></span>
<a name="l01443"></a>01443 <span class="comment">  Main loop</span>
<a name="l01444"></a>01444 <span class="comment"></span>
<a name="l01445"></a>01445 <span class="comment">\*------------------------------------------------------------------*/</span>
<a name="l01446"></a>01446 
<a name="l01447"></a><a class="code" href="mscbmain_8c.html#a6288eba0f8e8ad3ab1544ad731eb7667">01447</a> <span class="keywordtype">void</span> <a class="code" href="mucap__compress_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">void</span>)
<a name="l01448"></a>01448 {
<a name="l01449"></a>01449    <a class="code" href="mscbmain_8c.html#a7dfd9b79bc5a37d7df40207afbc5431f">setup</a>();
<a name="l01450"></a>01450 
<a name="l01451"></a>01451    <span class="keywordflow">do</span> {
<a name="l01452"></a>01452       <a class="code" href="embedded_2mscb_8h.html#a7cb51f5c2b5cad3766f19eb69c92793b">yield</a>();
<a name="l01453"></a>01453       <a class="code" href="hvr__200_8c.html#a9c9fec92b60b251c275870d900294a4a">user_loop</a>();
<a name="l01454"></a>01454    } <span class="keywordflow">while</span> (1);
<a name="l01455"></a>01455 
<a name="l01456"></a>01456 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ:Rootana by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
