<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ:Rootana: midas/mscb/embedded/usb.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>midas/mscb/embedded/usb.c</h1><a href="usb_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Name:         usb.c</span>
<a name="l00004"></a>00004 <span class="comment">  Created by:   Stefan Ritt</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Contents:     USB routines for Cygnal USB sub-master</span>
<a name="l00007"></a>00007 <span class="comment">                SUBM250 running on Cygnal C8051F320</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">  $Log: usb.c,v $</span>
<a name="l00010"></a>00010 <span class="comment">  Revision 1.1.1.1  2005/06/20 23:37:20  mucap</span>
<a name="l00011"></a>00011 <span class="comment">  Importing release 1.9.5 of the MIDAS source code as distributed by PSI.</span>
<a name="l00012"></a>00012 <span class="comment">  (Next, I&apos;ll commit our local customizations.)</span>
<a name="l00013"></a>00013 <span class="comment"></span>
<a name="l00014"></a>00014 <span class="comment">  Revision 1.1  2004/03/04 14:38:23  midas</span>
<a name="l00015"></a>00015 <span class="comment">  Initial revision</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment">\********************************************************************/</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="mscb_8h.html">mscb.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="usb_8h.html">usb.h</a>&quot;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="comment">/*---- Globals -----------------------------------------------------*/</span>
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">00025</a> <a class="code" href="structDEVICE__STATUS.html">DEVICE_STATUS</a> idata <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>;
<a name="l00026"></a><a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">00026</a> <a class="code" href="structEP0__COMMAND.html">EP0_COMMAND</a>   idata <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>;
<a name="l00027"></a><a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">00027</a> <a class="code" href="structEP__STATUS.html">EP_STATUS</a>     idata <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>;
<a name="l00028"></a><a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">00028</a> <a class="code" href="structEP__STATUS.html">EP_STATUS</a>     idata <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>;
<a name="l00029"></a><a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">00029</a> <a class="code" href="structEP__STATUS.html">EP_STATUS</a>     idata <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>;
<a name="l00030"></a><a class="code" href="usb_8c.html#aed6d1ffc564f97992cd2f1bdd33246ac">00030</a> <a class="code" href="structIF__STATUS.html">PIF_STATUS</a>    idata <a class="code" href="usb_8c.html#aed6d1ffc564f97992cd2f1bdd33246ac">pIfStatus</a>;
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="usb_8c.html#aeded1e22bdf225f1bd2b1251c6b152e4">00032</a> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *<a class="code" href="usb_8c.html#aeded1e22bdf225f1bd2b1251c6b152e4">prx_buf</a>;
<a name="l00033"></a><a class="code" href="usb_8c.html#a12948fff4da793612d072ca8447ae9d4">00033</a> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *<a class="code" href="usb_8c.html#a12948fff4da793612d072ca8447ae9d4">pn_rx</a>;
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">//---------------------------</span>
<a name="l00038"></a>00038 <span class="comment">// Descriptor Declarations</span>
<a name="l00039"></a>00039 <span class="comment">//---------------------------</span>
<a name="l00040"></a>00040 <span class="comment">// All descriptors are contained in the global structure &lt;gDescriptorMap&gt;.</span>
<a name="l00041"></a>00041 <span class="comment">// This structure contains BYTE arrays for the standard device descriptor</span>
<a name="l00042"></a>00042 <span class="comment">// and all configurations. The lengths of the configuration arrays are</span>
<a name="l00043"></a>00043 <span class="comment">// defined by the number of interface and endpoint descriptors required</span>
<a name="l00044"></a>00044 <span class="comment">// for the particular configuration (these constants are named</span>
<a name="l00045"></a>00045 <span class="comment">// CFG1_IF_DSC and CFG1_EP_DSC for configuration1).</span>
<a name="l00046"></a>00046 <span class="comment">//</span>
<a name="l00047"></a>00047 <span class="comment">// The entire gDescriptorMap structure is initialized below in</span>
<a name="l00048"></a>00048 <span class="comment">// codespace.</span>
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">00050</a> <a class="code" href="structDESCRIPTORS.html">DESCRIPTORS</a> code <a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">gDescriptorMap</a> = {
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="comment">//---------------------------</span>
<a name="l00053"></a>00053 <span class="comment">// Begin Standard Device Descriptor (structure element stddevdsc)</span>
<a name="l00054"></a>00054 <span class="comment">//---------------------------</span>
<a name="l00055"></a>00055    18,                        <span class="comment">// bLength</span>
<a name="l00056"></a>00056    0x01,                      <span class="comment">// bDescriptorType</span>
<a name="l00057"></a>00057    0x00, 0x02,                <span class="comment">// bcdUSB (lsb first)</span>
<a name="l00058"></a>00058    0x00,                      <span class="comment">// bDeviceClass</span>
<a name="l00059"></a>00059    0x00,                      <span class="comment">// bDeviceSubClass</span>
<a name="l00060"></a>00060    0x00,                      <span class="comment">// bDeviceProtocol</span>
<a name="l00061"></a>00061    <a class="code" href="usb_8h.html#a101f2c605970cda441bc2f9f8f9b2f88">EP0_PACKET_SIZE</a>,           <span class="comment">// bMaxPacketSize0</span>
<a name="l00062"></a>00062    0xC4, 0x10,                <span class="comment">// idVendor (lsb first)</span>
<a name="l00063"></a>00063    0x75, 0x11,                <span class="comment">// idProduct (lsb first)</span>
<a name="l00064"></a>00064    0x00, 0x00,                <span class="comment">// bcdDevice (lsb first)</span>
<a name="l00065"></a>00065    0x01,                      <span class="comment">// iManufacturer</span>
<a name="l00066"></a>00066    0x02,                      <span class="comment">// iProduct</span>
<a name="l00067"></a>00067    0x00,                      <span class="comment">// iSerialNumber</span>
<a name="l00068"></a>00068    0x01,                      <span class="comment">// bNumConfigurations</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">//---------------------------</span>
<a name="l00071"></a>00071 <span class="comment">// Begin Configuration 1 (structure element cfg1)</span>
<a name="l00072"></a>00072 <span class="comment">//---------------------------</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074    <span class="comment">// Begin Descriptor: Configuration 1</span>
<a name="l00075"></a>00075    0x09,                      <span class="comment">// Length</span>
<a name="l00076"></a>00076    0x02,                      <span class="comment">// Type</span>
<a name="l00077"></a>00077    0x20, 0x00,                <span class="comment">// TotalLength (lsb first)</span>
<a name="l00078"></a>00078    0x01,                      <span class="comment">// NumInterfaces</span>
<a name="l00079"></a>00079    0x01,                      <span class="comment">// bConfigurationValue</span>
<a name="l00080"></a>00080    0x00,                      <span class="comment">// iConfiguration</span>
<a name="l00081"></a>00081    0x80,                      <span class="comment">// bmAttributes (no remote wakeup)</span>
<a name="l00082"></a>00082    0x0F,                      <span class="comment">// MaxPower (*2mA)</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084    <span class="comment">// Begin Descriptor: Interface0, Alternate0</span>
<a name="l00085"></a>00085    0x09,                      <span class="comment">// bLength</span>
<a name="l00086"></a>00086    0x04,                      <span class="comment">// bDescriptorType</span>
<a name="l00087"></a>00087    0x00,                      <span class="comment">// bInterfaceNumber</span>
<a name="l00088"></a>00088    0x00,                      <span class="comment">// bAlternateSetting</span>
<a name="l00089"></a>00089    0x02,                      <span class="comment">// bNumEndpoints</span>
<a name="l00090"></a>00090    0x00,                      <span class="comment">// bInterfaceClass</span>
<a name="l00091"></a>00091    0x00,                      <span class="comment">// bInterfaceSubClass</span>
<a name="l00092"></a>00092    0x00,                      <span class="comment">// bInterfaceProcotol</span>
<a name="l00093"></a>00093    0x00,                      <span class="comment">// iInterface</span>
<a name="l00094"></a>00094 
<a name="l00095"></a>00095    <span class="comment">// Begin Descriptor: Endpoint1, Interface0, Alternate0</span>
<a name="l00096"></a>00096    0x07,                      <span class="comment">// bLength</span>
<a name="l00097"></a>00097    0x05,                      <span class="comment">// bDescriptorType</span>
<a name="l00098"></a>00098    0x81,                      <span class="comment">// bEndpointAddress (ep1, IN)</span>
<a name="l00099"></a>00099    0x02,                      <span class="comment">// bmAttributes (Bulk)</span>
<a name="l00100"></a>00100    <a class="code" href="usb_8h.html#a4909b1f555165f2d2ee3874484d4cba7">EP1_PACKET_SIZE</a>, 0x00,     <span class="comment">// wMaxPacketSize (lsb first)</span>
<a name="l00101"></a>00101    0x20,                      <span class="comment">// bInterval</span>
<a name="l00102"></a>00102 
<a name="l00103"></a>00103    <span class="comment">// Begin Descriptor: Endpoint2, Interface0, Alternate0</span>
<a name="l00104"></a>00104    0x07,                      <span class="comment">// bLength</span>
<a name="l00105"></a>00105    0x05,                      <span class="comment">// bDescriptorType</span>
<a name="l00106"></a>00106    0x02,                      <span class="comment">// bEndpointAddress (ep2, OUT)</span>
<a name="l00107"></a>00107    0x02,                      <span class="comment">// bmAttributes (Bulk)</span>
<a name="l00108"></a>00108    <a class="code" href="usb_8h.html#ad58553c0d8a6a3b40c0d66ba5a740c56">EP2_PACKET_SIZE</a>, 0x00,     <span class="comment">// wMaxPacketSize (lsb first)</span>
<a name="l00109"></a>00109    0x01,                      <span class="comment">// bInterval</span>
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">//---------------------------</span>
<a name="l00112"></a>00112 <span class="comment">// End Configuration 1</span>
<a name="l00113"></a>00113 <span class="comment">//---------------------------</span>
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 };
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="comment">//---------------------------</span>
<a name="l00118"></a>00118 <span class="comment">// String Descriptors</span>
<a name="l00119"></a>00119 <span class="comment">//---------------------------</span>
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="usb_8c.html#a52004e05c09b9268a3f8237429fda2b3">00121</a> code <span class="keyword">const</span> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#a52004e05c09b9268a3f8237429fda2b3">String0Desc</a>[4] =
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123    0x04, 0x03, 0x09, 0x04
<a name="l00124"></a>00124 };
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="usb_8c.html#a5a47e1c13123660e14d789c6acab975c">00126</a> <span class="preprocessor">#define STR1LEN sizeof(&quot;PSI S. Ritt&quot;)*2</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span>
<a name="l00128"></a><a class="code" href="usb_8c.html#a97bff82df9e68d305bcde5e64d7ebd54">00128</a> code <span class="keyword">const</span> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#a97bff82df9e68d305bcde5e64d7ebd54">String1Desc</a>[<a class="code" href="usb_8c.html#a5a47e1c13123660e14d789c6acab975c">STR1LEN</a>] =
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130    <a class="code" href="usb_8c.html#a5a47e1c13123660e14d789c6acab975c">STR1LEN</a>, 0x03,
<a name="l00131"></a>00131    <span class="charliteral">&apos;P&apos;</span>, 0,
<a name="l00132"></a>00132    <span class="charliteral">&apos;S&apos;</span>, 0,
<a name="l00133"></a>00133    <span class="charliteral">&apos;I&apos;</span>, 0,
<a name="l00134"></a>00134    <span class="charliteral">&apos; &apos;</span>, 0,
<a name="l00135"></a>00135    <span class="charliteral">&apos;S&apos;</span>, 0,
<a name="l00136"></a>00136    <span class="charliteral">&apos;.&apos;</span>, 0,
<a name="l00137"></a>00137    <span class="charliteral">&apos; &apos;</span>, 0,
<a name="l00138"></a>00138    <span class="charliteral">&apos;R&apos;</span>, 0,
<a name="l00139"></a>00139    <span class="charliteral">&apos;i&apos;</span>, 0,
<a name="l00140"></a>00140    <span class="charliteral">&apos;t&apos;</span>, 0,
<a name="l00141"></a>00141    <span class="charliteral">&apos;t&apos;</span>, 0,
<a name="l00142"></a>00142 };
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="usb_8c.html#a5921f7198c435b1fe7c25348d4015d96">00144</a> <span class="preprocessor">#define STR2LEN sizeof(&quot;MSCB Submaster SCS-250&quot;)*2</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>
<a name="l00146"></a><a class="code" href="usb_8c.html#a81254262ca9be4b27a1325fc4f0d0c75">00146</a> code <span class="keyword">const</span> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#a81254262ca9be4b27a1325fc4f0d0c75">String2Desc</a>[<a class="code" href="usb_8c.html#a5921f7198c435b1fe7c25348d4015d96">STR2LEN</a>] =
<a name="l00147"></a>00147 {
<a name="l00148"></a>00148    <a class="code" href="usb_8c.html#a5921f7198c435b1fe7c25348d4015d96">STR2LEN</a>, 0x03,
<a name="l00149"></a>00149    <span class="charliteral">&apos;M&apos;</span>, 0,
<a name="l00150"></a>00150    <span class="charliteral">&apos;S&apos;</span>, 0,
<a name="l00151"></a>00151    <span class="charliteral">&apos;C&apos;</span>, 0,
<a name="l00152"></a>00152    <span class="charliteral">&apos;B&apos;</span>, 0,
<a name="l00153"></a>00153    <span class="charliteral">&apos; &apos;</span>, 0,
<a name="l00154"></a>00154    <span class="charliteral">&apos;S&apos;</span>, 0,
<a name="l00155"></a>00155    <span class="charliteral">&apos;u&apos;</span>, 0,
<a name="l00156"></a>00156    <span class="charliteral">&apos;b&apos;</span>, 0,
<a name="l00157"></a>00157    <span class="charliteral">&apos;m&apos;</span>, 0,
<a name="l00158"></a>00158    <span class="charliteral">&apos;a&apos;</span>, 0,
<a name="l00159"></a>00159    <span class="charliteral">&apos;s&apos;</span>, 0,
<a name="l00160"></a>00160    <span class="charliteral">&apos;t&apos;</span>, 0,
<a name="l00161"></a>00161    <span class="charliteral">&apos;e&apos;</span>, 0,
<a name="l00162"></a>00162    <span class="charliteral">&apos;r&apos;</span>, 0,
<a name="l00163"></a>00163    <span class="charliteral">&apos; &apos;</span>, 0,
<a name="l00164"></a>00164    <span class="charliteral">&apos;S&apos;</span>, 0,
<a name="l00165"></a>00165    <span class="charliteral">&apos;C&apos;</span>, 0,
<a name="l00166"></a>00166    <span class="charliteral">&apos;S&apos;</span>, 0,
<a name="l00167"></a>00167    <span class="charliteral">&apos;-&apos;</span>, 0,
<a name="l00168"></a>00168    <span class="charliteral">&apos;2&apos;</span>, 0,
<a name="l00169"></a>00169    <span class="charliteral">&apos;5&apos;</span>, 0,
<a name="l00170"></a>00170    <span class="charliteral">&apos;0&apos;</span>, 0,
<a name="l00171"></a>00171 };
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="usb_8c.html#a5ae87f476974354384058a23233a9925">00173</a> code <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* <span class="keyword">const</span> <a class="code" href="usb_8c.html#a5ae87f476974354384058a23233a9925">StringDescTable</a>[] =
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175    <a class="code" href="usb_8c.html#a52004e05c09b9268a3f8237429fda2b3">String0Desc</a>,
<a name="l00176"></a>00176    <a class="code" href="usb_8c.html#a97bff82df9e68d305bcde5e64d7ebd54">String1Desc</a>,
<a name="l00177"></a>00177    <a class="code" href="usb_8c.html#a81254262ca9be4b27a1325fc4f0d0c75">String2Desc</a>
<a name="l00178"></a>00178 };
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="comment">/*---- Prototypes --------------------------------------------------*/</span>
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a75636723d8b087440b2873174fd0aedb">USBReset</a>(<span class="keywordtype">void</span>);
<a name="l00183"></a>00183 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a33791883b9a0c28b82959ea2954b56f6">Endpoint0</a>(<span class="keywordtype">void</span>);
<a name="l00184"></a>00184 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a59cb6a9fff1ed438f36eba1fb66c842a">BulkOrInterruptIn</a>(<a class="code" href="structEP__STATUS.html">PEP_STATUS</a> pEpInStatus);
<a name="l00185"></a>00185 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a570cc546c11d585b243f1e00b2c4e9c0">BulkOrInterruptOut</a>(<a class="code" href="structEP__STATUS.html">PEP_STATUS</a> pEpOutStatus);
<a name="l00186"></a>00186 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#aab679f5b6ff0614db1431cb56ef71fca">FIFORead</a>(<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bEp, <a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uNumBytes, <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> * pData);
<a name="l00187"></a>00187 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a2d4f061ac27d76ccd599e1337e039d89">FIFOWrite</a>(<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bEp, <a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uNumBytes, <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> * pData) reentrant;
<a name="l00188"></a>00188 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a0f42cc9b0621eba2d7f483065ce302ef">SetAddressRequest</a>(<span class="keywordtype">void</span>);
<a name="l00189"></a>00189 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#adafc9321f8acf3e27a71faf002d93995">SetFeatureRequest</a>(<span class="keywordtype">void</span>);
<a name="l00190"></a>00190 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a065878e15ac7ca6b1a9156aa4f342a1f">ClearFeatureRequest</a>(<span class="keywordtype">void</span>);
<a name="l00191"></a>00191 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a2ba849962e854da9f8b5ac4a178b3f84">SetConfigurationRequest</a>(<span class="keywordtype">void</span>);
<a name="l00192"></a>00192 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#abe82847f44da9cca42c53b6b9bc888ad">SetInterfaceRequest</a>(<span class="keywordtype">void</span>);
<a name="l00193"></a>00193 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#aa5229cd51d75c80b10b0e4b2683e2d94">GetStatusRequest</a>(<span class="keywordtype">void</span>);
<a name="l00194"></a>00194 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a0ee105af6482034a560053988bc279b7">GetDescriptorRequest</a>(<span class="keywordtype">void</span>);
<a name="l00195"></a>00195 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#aec12f6772ebdc27963199b4b11afe14a">GetConfigurationRequest</a>(<span class="keywordtype">void</span>);
<a name="l00196"></a>00196 <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a31c1232cf15896e6d64d58874008cbf8">GetInterfaceRequest</a>(<span class="keywordtype">void</span>);
<a name="l00197"></a>00197 <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#a7df5bc9644bf3d259eff3127978cc3b4">HaltEndpoint</a>(<a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uEp);
<a name="l00198"></a>00198 <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#ab44ba6e2102bc4505542ae106acb7bb4">EnableEndpoint</a>(<a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uEp);
<a name="l00199"></a>00199 <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#a43df3881423a125ec9e9d0701e4894a0">GetEpStatus</a>(<a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uEp);
<a name="l00200"></a>00200 <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#a767cd07960573244c70de3bf13db363e">SetConfiguration</a>(<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> SelectConfig);
<a name="l00201"></a>00201 <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#abb552a75c16c2848d7058252b7fb2132">SetInterface</a>(<a class="code" href="structIF__STATUS.html">PIF_STATUS</a> <a class="code" href="usb_8c.html#aed6d1ffc564f97992cd2f1bdd33246ac">pIfStatus</a>);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="comment">/*</span>
<a name="l00206"></a>00206 <span class="comment">  USB Initialization</span>
<a name="l00207"></a>00207 <span class="comment">    - Initialize USB0</span>
<a name="l00208"></a>00208 <span class="comment">    - Enable USB0 interrupts</span>
<a name="l00209"></a>00209 <span class="comment">    - Enable USB0 transceiver</span>
<a name="l00210"></a>00210 <span class="comment">    - Enable USB0</span>
<a name="l00211"></a>00211 <span class="comment">*/</span>
<a name="l00212"></a><a class="code" href="usb_8h.html#a52187e25b191a98789e7219c44d39efe">00212</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a0ed080aa3642f199d352fc0902d4d644">usb_init</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *psize)
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a0d5e23bac60070676b465522a140f5c7">POWER</a>, 0x08);              <span class="comment">// Asynch. reset</span>
<a name="l00215"></a>00215 
<a name="l00216"></a>00216    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a419c642b37ee26859d9641e73e4f7503">IN1IE</a>, 0x0F);              <span class="comment">// Enable Endpoint0 Interrupt</span>
<a name="l00217"></a>00217    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#afbe6b649354cb91874f78e5dca4350e5">OUT1IE</a>, 0x0F);
<a name="l00218"></a>00218    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#aea47238e22369d1b66a729149736316c">CMIE</a>, 0x04);               <span class="comment">// Enable Reset interrupt</span>
<a name="l00219"></a>00219 
<a name="l00220"></a>00220    <a class="code" href="c8051F320_8h.html#a17e2e74207795713813a81a8262878ee">USB0XCN</a> = 0xC0;                        <span class="comment">// Enable transceiver</span>
<a name="l00221"></a>00221    <a class="code" href="c8051F320_8h.html#a17e2e74207795713813a81a8262878ee">USB0XCN</a> |= <a class="code" href="usb_8h.html#a309b853d290b30f66e8eb75543c7095f">FULL_SPEED</a>;                 <span class="comment">// Select device speed</span>
<a name="l00222"></a>00222 
<a name="l00223"></a>00223    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a3fd1a80941b29d8c2f84862505dba962">CLKREC</a>, 0x80);             <span class="comment">// Enable clock recovery,</span>
<a name="l00224"></a>00224                                           <span class="comment">// single-step mode disabled</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226    <a class="code" href="c8051F000_8h.html#a9a06ef25d58b4023227af6cec6d1dabf">EIE1</a> |= 0x02;                          <span class="comment">// Enable USB0 Interrupts</span>
<a name="l00227"></a>00227 
<a name="l00228"></a>00228    <a class="code" href="c8051F000_8h.html#ae524fa4918208f2da654a7887bd9a7d0">EA</a> = 1;                                <span class="comment">// Enable global interrupts</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a0d5e23bac60070676b465522a140f5c7">POWER</a>, 0x00);              <span class="comment">// Enable USB0 by clearing the</span>
<a name="l00231"></a>00231                                           <span class="comment">// USB Inhibit bit</span>
<a name="l00232"></a>00232                                           <span class="comment">// Suspend mode disabled</span>
<a name="l00233"></a>00233 
<a name="l00234"></a>00234    <span class="comment">/* save pointers */</span>
<a name="l00235"></a>00235    <a class="code" href="usb_8c.html#aeded1e22bdf225f1bd2b1251c6b152e4">prx_buf</a> = buffer;
<a name="l00236"></a>00236    <a class="code" href="usb_8c.html#a12948fff4da793612d072ca8447ae9d4">pn_rx</a> = psize;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="comment">/*</span>
<a name="l00242"></a>00242 <span class="comment">   This is the top level USB ISR. All endpoint interrupt/request</span>
<a name="l00243"></a>00243 <span class="comment">   handlers are called from this function.</span>
<a name="l00244"></a>00244 <span class="comment"></span>
<a name="l00245"></a>00245 <span class="comment">   Handler routines for any configured interrupts should be</span>
<a name="l00246"></a>00246 <span class="comment">   added in the appropriate endpoint handler call slots.</span>
<a name="l00247"></a>00247 <span class="comment">*/</span>
<a name="l00248"></a><a class="code" href="usb_8c.html#a420bc2c0015264c859d705dd98d08ffc">00248</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a420bc2c0015264c859d705dd98d08ffc">USB_ISR</a>() interrupt 8
<a name="l00249"></a>00249 {
<a name="l00250"></a>00250    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bCommonInt, bInInt, bOutInt;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252    <span class="comment">// Read interrupt registers</span>
<a name="l00253"></a>00253    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#afeea9ed6d847292f64e97b0fcd740c32">CMINT</a>, bCommonInt);
<a name="l00254"></a>00254    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#a63a66d27af419ae7ec76a75c87d54442">IN1INT</a>, bInInt);
<a name="l00255"></a>00255    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#abb5412bcd8e16b8d552eee1062ca9268">OUT1INT</a>, bOutInt);
<a name="l00256"></a>00256 
<a name="l00257"></a>00257    <span class="comment">// Check for reset interrupt</span>
<a name="l00258"></a>00258    <span class="keywordflow">if</span> (bCommonInt &amp; <a class="code" href="usb_8h.html#af05b2cf46df66a5b619b019df744d151">rbRSTINT</a>)
<a name="l00259"></a>00259       <a class="code" href="usb_8c.html#a75636723d8b087440b2873174fd0aedb">USBReset</a>();
<a name="l00260"></a>00260 
<a name="l00261"></a>00261    <span class="comment">// Check for Endpoint0 interrupt</span>
<a name="l00262"></a>00262    <span class="keywordflow">if</span> (bInInt &amp; <a class="code" href="usb_8h.html#a1c6eb215f1b6077aca9d528425e12120">rbEP0</a>)
<a name="l00263"></a>00263       <a class="code" href="usb_8c.html#a33791883b9a0c28b82959ea2954b56f6">Endpoint0</a>();
<a name="l00264"></a>00264 
<a name="l00265"></a>00265    <span class="comment">// Endpoint1 IN</span>
<a name="l00266"></a>00266 <span class="comment">//   if (bInInt &amp; rbIN1)</span>
<a name="l00267"></a>00267 <span class="comment">//##      BulkOrInterruptIn(&amp;gEp1InStatus);</span>
<a name="l00268"></a>00268 
<a name="l00269"></a>00269    <span class="comment">// Endpoint2 OUT</span>
<a name="l00270"></a>00270    <span class="keywordflow">if</span> (bOutInt &amp; <a class="code" href="usb_8h.html#acc6ec3991450fdf7576bffbfa84447ac">rbOUT2</a>)
<a name="l00271"></a>00271       <a class="code" href="usb_8c.html#a570cc546c11d585b243f1e00b2c4e9c0">BulkOrInterruptOut</a>(&amp;<a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>);
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="comment">/*</span>
<a name="l00277"></a>00277 <span class="comment">   - Initialize the global Device Status structure (all zeros)</span>
<a name="l00278"></a>00278 <span class="comment">   - Resets all endpoints</span>
<a name="l00279"></a>00279 <span class="comment">*/</span>
<a name="l00280"></a><a class="code" href="usb_8c.html#a75636723d8b087440b2873174fd0aedb">00280</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a75636723d8b087440b2873174fd0aedb">USBReset</a>()
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, bPower = 0;
<a name="l00283"></a>00283    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> * pDevStatus;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285    <span class="comment">// Reset device status structure to all zeros (undefined)</span>
<a name="l00286"></a>00286    pDevStatus = (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)&amp;<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>;
<a name="l00287"></a>00287    <span class="keywordflow">for</span> (i=0;i&lt;<span class="keyword">sizeof</span>(<a class="code" href="structDEVICE__STATUS.html">DEVICE_STATUS</a>);i++)
<a name="l00288"></a>00288       *pDevStatus++ = 0x00;
<a name="l00289"></a>00289 
<a name="l00290"></a>00290    <span class="comment">// Set device state to default</span>
<a name="l00291"></a>00291    <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> = <a class="code" href="usb_8h.html#a1b028fb9f7c2c1796c6ed9edac5655dd">DEV_DEFAULT</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293    <span class="comment">// REMOTE_WAKEUP_SUPPORT and SELF_POWERED_SUPPORT</span>
<a name="l00294"></a>00294    <span class="comment">// defined in file &quot;usb_desc.h&quot;</span>
<a name="l00295"></a>00295    <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#a319db3460c98870eddb907b70ed06b89">bRemoteWakeupSupport</a> = <a class="code" href="usb_8h.html#a91adba06b50c98a270b38958a64df225">REMOTE_WAKEUP_SUPPORT</a>;
<a name="l00296"></a>00296    <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#ad2ee2bf926f2f3a426161792ce874167">bSelfPoweredStatus</a> = <a class="code" href="usb_8h.html#a2f1c2d70c711d145aa81410769809525">SELF_POWERED_SUPPORT</a>;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298    <span class="comment">// Reset all endpoints</span>
<a name="l00299"></a>00299 
<a name="l00300"></a>00300    <span class="comment">// Reset Endpoint0</span>
<a name="l00301"></a>00301    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;         <span class="comment">// Reset Endpoint0 state</span>
<a name="l00302"></a>00302    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a> = 0;                    <span class="comment">// Set endpoint number</span>
<a name="l00303"></a>00303    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#abd9085f4a3ee2f6280a80d2b6480c311">uMaxP</a> = <a class="code" href="usb_8h.html#a101f2c605970cda441bc2f9f8f9b2f88">EP0_PACKET_SIZE</a>;    <span class="comment">// Set maximum packet size</span>
<a name="l00304"></a>00304 
<a name="l00305"></a>00305    <span class="comment">// Reset Endpoint1 IN</span>
<a name="l00306"></a>00306    <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#ae4e97746febb23c308d711d56fb7a245">EP_HALTED</a>;     <span class="comment">// Reset state</span>
<a name="l00307"></a>00307    <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = 0;            <span class="comment">// Reset byte counter</span>
<a name="l00308"></a>00308 
<a name="l00309"></a>00309    <span class="comment">// Reset Endpoint2 OUT</span>
<a name="l00310"></a>00310    <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#ae4e97746febb23c308d711d56fb7a245">EP_HALTED</a>;    <span class="comment">// Reset state</span>
<a name="l00311"></a>00311    <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = 0;           <span class="comment">// Reset byte counter</span>
<a name="l00312"></a>00312 
<a name="l00313"></a>00313    <span class="comment">// Get Suspend enable/disable status. If enabled, prepare temporary</span>
<a name="l00314"></a>00314    <span class="comment">// variable bPower.</span>
<a name="l00315"></a>00315    <span class="keywordflow">if</span> (<a class="code" href="usb_8h.html#ab505e02759744ec4ad1619e04710853c">SUSPEND_ENABLE</a>)
<a name="l00316"></a>00316    {
<a name="l00317"></a>00317       bPower = 0x01;                      <span class="comment">// Set bit0 (Suspend Enable)</span>
<a name="l00318"></a>00318    }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320    <span class="comment">// Get ISO Update enable/disable status. If enabled, prepare temporary</span>
<a name="l00321"></a>00321    <span class="comment">// variable bPower.</span>
<a name="l00322"></a>00322    <span class="keywordflow">if</span> (<a class="code" href="usb_8h.html#a4475f15bd36ce5e778f7e210af94230d">ISO_UPDATE_ENABLE</a>)
<a name="l00323"></a>00323    {
<a name="l00324"></a>00324       bPower |= 0x80;                     <span class="comment">// Set bit7 (ISO Update Enable)</span>
<a name="l00325"></a>00325    }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a0d5e23bac60070676b465522a140f5c7">POWER</a>, bPower);
<a name="l00328"></a>00328 }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="usb_8c.html#a33791883b9a0c28b82959ea2954b56f6">00332</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a33791883b9a0c28b82959ea2954b56f6">Endpoint0</a>()
<a name="l00333"></a>00333 {
<a name="l00334"></a>00334    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bTemp = 0;
<a name="l00335"></a>00335    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bCsr1, uTxBytes;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, 0);                 <span class="comment">// Target ep0</span>
<a name="l00338"></a>00338    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#a76d4c41c8d432d7d47cfee692845acdd">E0CSR</a>, bCsr1);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340    <span class="comment">// Handle Setup End</span>
<a name="l00341"></a>00341    <span class="keywordflow">if</span> (bCsr1 &amp; <a class="code" href="usb_8h.html#a53b9a37ff973e28e26d2f70172df58e3">rbSUEND</a>)                   <span class="comment">// Check for setup end</span>
<a name="l00342"></a>00342    {                                      <span class="comment">// Indicate setup end serviced</span>
<a name="l00343"></a>00343       <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a76d4c41c8d432d7d47cfee692845acdd">E0CSR</a>, <a class="code" href="usb_8h.html#a9ebddee104763576ab11023f0740e9e8">rbSSUEND</a>);
<a name="l00344"></a>00344       <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;      <span class="comment">// ep0 state to idle</span>
<a name="l00345"></a>00345    }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347    <span class="comment">// Handle sent stall</span>
<a name="l00348"></a>00348    <span class="keywordflow">if</span> (bCsr1 &amp; <a class="code" href="usb_8h.html#a77b1e49aa700dc47e026289eb3e89264">rbSTSTL</a>)                   <span class="comment">// If last state requested a stall</span>
<a name="l00349"></a>00349    {                                      <span class="comment">// Clear Sent Stall bit (STSTL)</span>
<a name="l00350"></a>00350       <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a76d4c41c8d432d7d47cfee692845acdd">E0CSR</a>, 0);
<a name="l00351"></a>00351       <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;      <span class="comment">// ep0 state to idle</span>
<a name="l00352"></a>00352    }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354    <span class="comment">// Handle incoming packet</span>
<a name="l00355"></a>00355    <span class="keywordflow">if</span> (bCsr1 &amp; <a class="code" href="usb_8h.html#a4768a45684641c3247a40fd64177b486">rbOPRDY</a>)
<a name="l00356"></a>00356    {
<a name="l00357"></a>00357       <span class="comment">// Read the 8-byte command from Endpoint0 FIFO</span>
<a name="l00358"></a>00358       <a class="code" href="usb_8c.html#aab679f5b6ff0614db1431cb56ef71fca">FIFORead</a>(0, 8, (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>);
<a name="l00359"></a>00359 
<a name="l00360"></a>00360       <span class="comment">// Byte-swap the wIndex field</span>
<a name="l00361"></a>00361       bTemp = gEp0Command.wIndex.c[1];
<a name="l00362"></a>00362       gEp0Command.wIndex.c[1] = gEp0Command.wIndex.c[0];
<a name="l00363"></a>00363       gEp0Command.wIndex.c[0] = bTemp;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365       <span class="comment">// Byte-swap the wValue field</span>
<a name="l00366"></a>00366       bTemp = gEp0Command.wValue.c[1];
<a name="l00367"></a>00367       gEp0Command.wValue.c[1] = gEp0Command.wValue.c[0];
<a name="l00368"></a>00368       gEp0Command.wValue.c[0] = bTemp;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370       <span class="comment">// Byte-swap the wLength field</span>
<a name="l00371"></a>00371       bTemp = gEp0Command.wLength.c[1];
<a name="l00372"></a>00372       gEp0Command.wLength.c[1] = gEp0Command.wLength.c[0];
<a name="l00373"></a>00373       gEp0Command.wLength.c[0] = bTemp;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375       <span class="comment">// Decode received command</span>
<a name="l00376"></a>00376       <span class="keywordflow">switch</span> (gEp0Command.bmRequestType &amp; <a class="code" href="usb_8h.html#a618c235ae4a7eb171f05252bf105f291">CMD_MASK_COMMON</a>)
<a name="l00377"></a>00377       {
<a name="l00378"></a>00378          <span class="keywordflow">case</span>  <a class="code" href="usb_8h.html#ad21e66777fe433bdff543c20f923baff">CMD_STD_DEV_OUT</a>:           <span class="comment">// Standard device requests</span>
<a name="l00379"></a>00379             <span class="comment">// Decode standard OUT request</span>
<a name="l00380"></a>00380             <span class="keywordflow">switch</span> (gEp0Command.bRequest)
<a name="l00381"></a>00381             {
<a name="l00382"></a>00382                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#ad3c9f5426c07d7d4da8cf1752a111576">SET_ADDRESS</a>:
<a name="l00383"></a>00383                   <a class="code" href="usb_8c.html#a0f42cc9b0621eba2d7f483065ce302ef">SetAddressRequest</a>();
<a name="l00384"></a>00384                   <span class="keywordflow">break</span>;
<a name="l00385"></a>00385                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#af8b97e67097fbf7d56c3dcac52fe679e">SET_FEATURE</a>:
<a name="l00386"></a>00386                   <a class="code" href="usb_8c.html#adafc9321f8acf3e27a71faf002d93995">SetFeatureRequest</a>();
<a name="l00387"></a>00387                   <span class="keywordflow">break</span>;
<a name="l00388"></a>00388                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a1908d37748e7d545ee5f190715624150">CLEAR_FEATURE</a>:
<a name="l00389"></a>00389                   <a class="code" href="usb_8c.html#a065878e15ac7ca6b1a9156aa4f342a1f">ClearFeatureRequest</a>();
<a name="l00390"></a>00390                   <span class="keywordflow">break</span>;
<a name="l00391"></a>00391                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a5cdfe3de183eb4e190b2ccaa299045bf">SET_CONFIGURATION</a>:
<a name="l00392"></a>00392                   <a class="code" href="usb_8c.html#a2ba849962e854da9f8b5ac4a178b3f84">SetConfigurationRequest</a>();
<a name="l00393"></a>00393                   <span class="keywordflow">break</span>;
<a name="l00394"></a>00394                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a90c9c23759bdbb3ba106f88cb5ffc261">SET_INTERFACE</a>:
<a name="l00395"></a>00395                   <a class="code" href="usb_8c.html#abe82847f44da9cca42c53b6b9bc888ad">SetInterfaceRequest</a>();
<a name="l00396"></a>00396                   <span class="keywordflow">break</span>;
<a name="l00397"></a>00397                <span class="comment">// All other OUT requests not supported</span>
<a name="l00398"></a>00398                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a264a9bda1309d7cc0311d57274194ca3">SET_DESCRIPTOR</a>:
<a name="l00399"></a>00399                <span class="keywordflow">default</span>:
<a name="l00400"></a>00400                   <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00401"></a>00401                   <span class="keywordflow">break</span>;
<a name="l00402"></a>00402             }
<a name="l00403"></a>00403             <span class="keywordflow">break</span>;
<a name="l00404"></a>00404 
<a name="l00405"></a>00405          <span class="comment">// Decode standard IN request</span>
<a name="l00406"></a>00406          <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a08cd2ec42a821e863a3d3f43fc7ca079">CMD_STD_DEV_IN</a>:
<a name="l00407"></a>00407             <span class="keywordflow">switch</span> (gEp0Command.bRequest)
<a name="l00408"></a>00408             {
<a name="l00409"></a>00409                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#aeba76c92af8f1a94982ec4cb767452f0">GET_STATUS</a>:
<a name="l00410"></a>00410                   <a class="code" href="usb_8c.html#aa5229cd51d75c80b10b0e4b2683e2d94">GetStatusRequest</a>();
<a name="l00411"></a>00411                   <span class="keywordflow">break</span>;
<a name="l00412"></a>00412                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a115a1d866ed9498300d59c90549ead0d">GET_DESCRIPTOR</a>:
<a name="l00413"></a>00413                   <a class="code" href="usb_8c.html#a0ee105af6482034a560053988bc279b7">GetDescriptorRequest</a>();
<a name="l00414"></a>00414                   <span class="keywordflow">break</span>;
<a name="l00415"></a>00415                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#ac6bffdcb940a0338051c4baa72498beb">GET_CONFIGURATION</a>:
<a name="l00416"></a>00416                   <a class="code" href="usb_8c.html#aec12f6772ebdc27963199b4b11afe14a">GetConfigurationRequest</a>();
<a name="l00417"></a>00417                   <span class="keywordflow">break</span>;
<a name="l00418"></a>00418                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a1846f3a13493771ceced447397221de1">GET_INTERFACE</a>:
<a name="l00419"></a>00419                   <a class="code" href="usb_8c.html#a31c1232cf15896e6d64d58874008cbf8">GetInterfaceRequest</a>();
<a name="l00420"></a>00420                   <span class="keywordflow">break</span>;
<a name="l00421"></a>00421                <span class="comment">// All other IN requests not supported</span>
<a name="l00422"></a>00422                <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a43c627a14ff41632fa9c234a3df41b2b">SYNCH_FRAME</a>:
<a name="l00423"></a>00423                <span class="keywordflow">default</span>:
<a name="l00424"></a>00424                   <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00425"></a>00425                   <span class="keywordflow">break</span>;
<a name="l00426"></a>00426             }
<a name="l00427"></a>00427             <span class="keywordflow">break</span>;
<a name="l00428"></a>00428          <span class="comment">// All other requests not supported</span>
<a name="l00429"></a>00429          <span class="keywordflow">default</span>:
<a name="l00430"></a>00430             <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00431"></a>00431       }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433       <span class="comment">// Write E0CSR according to the result of the serviced out packet</span>
<a name="l00434"></a>00434       bTemp = <a class="code" href="usb_8h.html#acbf6ce41c59c729958cda130aa36394f">rbSOPRDY</a>;
<a name="l00435"></a>00435       <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> == <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>)
<a name="l00436"></a>00436       {
<a name="l00437"></a>00437          bTemp |= <a class="code" href="usb_8h.html#a45adb029b2e8f4c132571eab3836180c">rbSDSTL</a>;                <span class="comment">// Error condition handled</span>
<a name="l00438"></a>00438                                           <span class="comment">// with STALL</span>
<a name="l00439"></a>00439          <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;   <span class="comment">// Reset state to idle</span>
<a name="l00440"></a>00440       }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442       <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a76d4c41c8d432d7d47cfee692845acdd">E0CSR</a>, bTemp);
<a name="l00443"></a>00443    }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445    bTemp = 0;                             <span class="comment">// Reset temporary variable</span>
<a name="l00446"></a>00446 
<a name="l00447"></a>00447    <span class="comment">// If state is transmit, call transmit routine</span>
<a name="l00448"></a>00448    <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> == <a class="code" href="usb_8h.html#ad7b979706744814588bc245a14873912">EP_TX</a>)
<a name="l00449"></a>00449    {
<a name="l00450"></a>00450       <span class="comment">// Check the number of bytes ready for transmit</span>
<a name="l00451"></a>00451       <span class="comment">// If less than the maximum packet size, packet will</span>
<a name="l00452"></a>00452       <span class="comment">// not be of the maximum size</span>
<a name="l00453"></a>00453       <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> &lt;= <a class="code" href="usb_8h.html#a101f2c605970cda441bc2f9f8f9b2f88">EP0_PACKET_SIZE</a>)
<a name="l00454"></a>00454       {
<a name="l00455"></a>00455          uTxBytes = <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a>;
<a name="l00456"></a>00456          <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = 0;        <span class="comment">// update byte counter</span>
<a name="l00457"></a>00457          bTemp |= <a class="code" href="usb_8h.html#a6f96004a2a3e384d47133e2ca6f2de18">rbDATAEND</a>;              <span class="comment">// This will be the last</span>
<a name="l00458"></a>00458                                           <span class="comment">// packet for this transfer</span>
<a name="l00459"></a>00459          <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;   <span class="comment">// Reset endpoint state</span>
<a name="l00460"></a>00460       }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462       <span class="comment">// Otherwise, transmit maximum-length packet</span>
<a name="l00463"></a>00463       <span class="keywordflow">else</span>
<a name="l00464"></a>00464       {
<a name="l00465"></a>00465          uTxBytes = <a class="code" href="usb_8h.html#a101f2c605970cda441bc2f9f8f9b2f88">EP0_PACKET_SIZE</a>;
<a name="l00466"></a>00466          <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> -= <a class="code" href="usb_8h.html#a101f2c605970cda441bc2f9f8f9b2f88">EP0_PACKET_SIZE</a>;<span class="comment">// update byte counter</span>
<a name="l00467"></a>00467       }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469       <span class="comment">// Load FIFO</span>
<a name="l00470"></a>00470       <a class="code" href="usb_8c.html#a2d4f061ac27d76ccd599e1337e039d89">FIFOWrite</a>(0, uTxBytes, (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a>);
<a name="l00471"></a>00471 
<a name="l00472"></a>00472       <span class="comment">// Update data pointer</span>
<a name="l00473"></a>00473       <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> + uTxBytes;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475       <span class="comment">// Update Endpoint0 Control/Status register</span>
<a name="l00476"></a>00476       bTemp |= <a class="code" href="usb_8h.html#a97484288ff732be8d1da4325840b1871">rbINPRDY</a>;                  <span class="comment">// Always transmit a packet</span>
<a name="l00477"></a>00477                                           <span class="comment">// when this routine is called</span>
<a name="l00478"></a>00478                                           <span class="comment">// (may be zero-length)</span>
<a name="l00479"></a>00479 
<a name="l00480"></a>00480       <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a76d4c41c8d432d7d47cfee692845acdd">E0CSR</a>, bTemp);          <span class="comment">// Write to Endpoint0 Control/Status</span>
<a name="l00481"></a>00481    }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 <span class="comment">//--------------------------------------------------------------------</span>
<a name="l00488"></a>00488 <span class="comment">//  Standard Request Routines</span>
<a name="l00489"></a>00489 <span class="comment">//--------------------------------------------------------------------</span>
<a name="l00490"></a>00490 <span class="comment">//</span>
<a name="l00491"></a>00491 <span class="comment">// These functions should be called when an endpoint0 command has</span>
<a name="l00492"></a>00492 <span class="comment">// been received with a corresponding &quot;bRequest&quot; field.</span>
<a name="l00493"></a>00493 <span class="comment">//</span>
<a name="l00494"></a>00494 <span class="comment">// - Each routine performs all command field checking, and</span>
<a name="l00495"></a>00495 <span class="comment">//   modifies fields of the Ep0Status structure accordingly</span>
<a name="l00496"></a>00496 <span class="comment">//</span>
<a name="l00497"></a>00497 <span class="comment">// After a call to a standard request routine, the calling routine</span>
<a name="l00498"></a>00498 <span class="comment">// should check Ep0Status.bEpState to determine the required action</span>
<a name="l00499"></a>00499 <span class="comment">// (i.e., send a STALL for EP_ERROR, load the FIFO for EP_TX).</span>
<a name="l00500"></a>00500 <span class="comment">// For transmit status, the data pointer (Ep0Status.pData),</span>
<a name="l00501"></a>00501 <span class="comment">// and data length (Ep0Status.uNumBytes) are prepared before the</span>
<a name="l00502"></a>00502 <span class="comment">// standard request routine returns. The calling routine must write</span>
<a name="l00503"></a>00503 <span class="comment">// the data to the FIFO and handle all data transfer</span>
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 
<a name="l00506"></a><a class="code" href="usb_8c.html#a0f42cc9b0621eba2d7f483065ce302ef">00506</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a0f42cc9b0621eba2d7f483065ce302ef">SetAddressRequest</a>()
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>          bEpState;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510    <span class="comment">// Index and Length fields must be zero</span>
<a name="l00511"></a>00511    <span class="comment">// Device state must be default or addressed</span>
<a name="l00512"></a>00512    <span class="keywordflow">if</span> ((<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>) || (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>) ||
<a name="l00513"></a>00513    (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#a48a2fc14f74e3e449211ed1e47161d29">DEV_CONFIG</a>))
<a name="l00514"></a>00514    {
<a name="l00515"></a>00515       bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00516"></a>00516    }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518    <span class="keywordflow">else</span>
<a name="l00519"></a>00519    {
<a name="l00520"></a>00520       <span class="comment">// Assign new function address</span>
<a name="l00521"></a>00521       <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a79e9213b3c1bfe4b7fb519f18240629e">FADDR</a>, <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1]);
<a name="l00522"></a>00522       <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#a1b028fb9f7c2c1796c6ed9edac5655dd">DEV_DEFAULT</a> &amp;&amp;
<a name="l00523"></a>00523       <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1] != 0)
<a name="l00524"></a>00524       {
<a name="l00525"></a>00525          <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> = <a class="code" href="usb_8h.html#ac72da9845e02d812f88c208986ac5f4e">DEV_ADDRESS</a>;
<a name="l00526"></a>00526       }
<a name="l00527"></a>00527       <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#ac72da9845e02d812f88c208986ac5f4e">DEV_ADDRESS</a> &amp;&amp;
<a name="l00528"></a>00528       <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1] == 0)
<a name="l00529"></a>00529       {
<a name="l00530"></a>00530          <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> = <a class="code" href="usb_8h.html#ac72da9845e02d812f88c208986ac5f4e">DEV_ADDRESS</a>;
<a name="l00531"></a>00531       }
<a name="l00532"></a>00532       bEpState = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;
<a name="l00533"></a>00533    }
<a name="l00534"></a>00534    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = bEpState;
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00538"></a>00538 
<a name="l00539"></a><a class="code" href="usb_8c.html#adafc9321f8acf3e27a71faf002d93995">00539</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#adafc9321f8acf3e27a71faf002d93995">SetFeatureRequest</a>()
<a name="l00540"></a>00540 {
<a name="l00541"></a>00541    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>          bEpState;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543    <span class="comment">// Length field must be zero</span>
<a name="l00544"></a>00544    <span class="comment">// Device state must be configured, or addressed with Command Index</span>
<a name="l00545"></a>00545    <span class="comment">// field == 0</span>
<a name="l00546"></a>00546    <span class="keywordflow">if</span> ((<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 0) ||
<a name="l00547"></a>00547    (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#a1b028fb9f7c2c1796c6ed9edac5655dd">DEV_DEFAULT</a>) ||
<a name="l00548"></a>00548    (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#ac72da9845e02d812f88c208986ac5f4e">DEV_ADDRESS</a> &amp;&amp; <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 0))
<a name="l00549"></a>00549    {
<a name="l00550"></a>00550       bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00551"></a>00551    }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553    <span class="comment">// Handle based on recipient</span>
<a name="l00554"></a>00554    <span class="keywordflow">switch</span>(<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a9dce7fd6ba04e97137fa2e917bea4a68">bmRequestType</a> &amp; <a class="code" href="usb_8h.html#a8c28bcb66410f71d517108e9eb8dc5f5">CMD_MASK_RECIP</a>)
<a name="l00555"></a>00555    {
<a name="l00556"></a>00556       <span class="comment">// Device Request - Return error as remote wakeup is not supported</span>
<a name="l00557"></a>00557       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a3897c04ae881d3c601e271417e610793">CMD_RECIP_DEV</a>:
<a name="l00558"></a>00558          bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00559"></a>00559          <span class="keywordflow">break</span>;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561       <span class="comment">// Endpoint Request</span>
<a name="l00562"></a>00562       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a0c41e7b58281e580eeceb10930c6ba8b">CMD_RECIP_EP</a>:
<a name="l00563"></a>00563          <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> == <a class="code" href="usb_8h.html#a4d7a6aea8f3ed0b277c3b40fb5df77fc">ENDPOINT_HALT</a>)
<a name="l00564"></a>00564          {
<a name="l00565"></a>00565             bEpState = <a class="code" href="usb_8c.html#a7df5bc9644bf3d259eff3127978cc3b4">HaltEndpoint</a>(<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>);
<a name="l00566"></a>00566             <span class="keywordflow">break</span>;
<a name="l00567"></a>00567          }
<a name="l00568"></a>00568          <span class="keywordflow">else</span>
<a name="l00569"></a>00569          {
<a name="l00570"></a>00570             bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00571"></a>00571             <span class="keywordflow">break</span>;
<a name="l00572"></a>00572          }
<a name="l00573"></a>00573       <span class="keywordflow">default</span>:
<a name="l00574"></a>00574          bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00575"></a>00575          <span class="keywordflow">break</span>;
<a name="l00576"></a>00576    }
<a name="l00577"></a>00577    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = bEpState;
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00581"></a>00581 
<a name="l00582"></a><a class="code" href="usb_8c.html#a065878e15ac7ca6b1a9156aa4f342a1f">00582</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a065878e15ac7ca6b1a9156aa4f342a1f">ClearFeatureRequest</a>()
<a name="l00583"></a>00583 {
<a name="l00584"></a>00584    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>          bEpState;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586    <span class="comment">// Length field must be zero</span>
<a name="l00587"></a>00587    <span class="comment">// Device state must be configured, or addressed with Command Index</span>
<a name="l00588"></a>00588    <span class="comment">// field == 0</span>
<a name="l00589"></a>00589    <span class="keywordflow">if</span> ((<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 0) || (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#a1b028fb9f7c2c1796c6ed9edac5655dd">DEV_DEFAULT</a>) ||
<a name="l00590"></a>00590    (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#ac72da9845e02d812f88c208986ac5f4e">DEV_ADDRESS</a> &amp;&amp; <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 0))
<a name="l00591"></a>00591    {
<a name="l00592"></a>00592       bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00593"></a>00593    }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595    <span class="comment">// Handle based on recipient</span>
<a name="l00596"></a>00596    <span class="keywordflow">switch</span>(<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a9dce7fd6ba04e97137fa2e917bea4a68">bmRequestType</a> &amp; <a class="code" href="usb_8h.html#a8c28bcb66410f71d517108e9eb8dc5f5">CMD_MASK_RECIP</a>)
<a name="l00597"></a>00597    {
<a name="l00598"></a>00598       <span class="comment">// Device Request</span>
<a name="l00599"></a>00599       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a3897c04ae881d3c601e271417e610793">CMD_RECIP_DEV</a>:
<a name="l00600"></a>00600          <span class="comment">// Remote wakeup not supported</span>
<a name="l00601"></a>00601          bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00602"></a>00602          <span class="keywordflow">break</span>;
<a name="l00603"></a>00603 
<a name="l00604"></a>00604       <span class="comment">// Endpoint Request</span>
<a name="l00605"></a>00605       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a0c41e7b58281e580eeceb10930c6ba8b">CMD_RECIP_EP</a>:
<a name="l00606"></a>00606          <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> == <a class="code" href="usb_8h.html#a4d7a6aea8f3ed0b277c3b40fb5df77fc">ENDPOINT_HALT</a>)
<a name="l00607"></a>00607          {
<a name="l00608"></a>00608             <span class="comment">// Enable the selected endpoint.</span>
<a name="l00609"></a>00609             bEpState = <a class="code" href="usb_8c.html#ab44ba6e2102bc4505542ae106acb7bb4">EnableEndpoint</a>(<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>);
<a name="l00610"></a>00610             <span class="keywordflow">break</span>;
<a name="l00611"></a>00611          }
<a name="l00612"></a>00612          <span class="keywordflow">else</span>
<a name="l00613"></a>00613          {
<a name="l00614"></a>00614            bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00615"></a>00615            <span class="keywordflow">break</span>;
<a name="l00616"></a>00616          }
<a name="l00617"></a>00617       <span class="keywordflow">default</span>:
<a name="l00618"></a>00618          bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00619"></a>00619          <span class="keywordflow">break</span>;
<a name="l00620"></a>00620    }
<a name="l00621"></a>00621    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = bEpState;
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00625"></a>00625 
<a name="l00626"></a><a class="code" href="usb_8c.html#a2ba849962e854da9f8b5ac4a178b3f84">00626</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a2ba849962e854da9f8b5ac4a178b3f84">SetConfigurationRequest</a>()
<a name="l00627"></a>00627 {
<a name="l00628"></a>00628    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>          bEpState;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630    <span class="comment">// Index and Length fields must be zero</span>
<a name="l00631"></a>00631    <span class="comment">// Device state must be addressed or configured</span>
<a name="l00632"></a>00632    <span class="keywordflow">if</span> ((<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>) || (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>) ||
<a name="l00633"></a>00633    (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#a1b028fb9f7c2c1796c6ed9edac5655dd">DEV_DEFAULT</a>))
<a name="l00634"></a>00634    {
<a name="l00635"></a>00635       bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00636"></a>00636    }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638    <span class="keywordflow">else</span>
<a name="l00639"></a>00639    {
<a name="l00640"></a>00640       <span class="comment">// Make sure assigned configuration exists</span>
<a name="l00641"></a>00641       <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1] &gt;
<a name="l00642"></a>00642       <a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">gDescriptorMap</a>.<a class="code" href="structDESCRIPTORS.html#a73921f049cf146d10e0cda61780c485b">bStdDevDsc</a>[<a class="code" href="usb_8h.html#a6262d088caf4ca963f4e895756e246a2">std_bNumConfigurations</a>])
<a name="l00643"></a>00643       {
<a name="l00644"></a>00644          bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00645"></a>00645       }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647       <span class="comment">// Handle zero configuration assignment</span>
<a name="l00648"></a>00648       <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1] == 0)
<a name="l00649"></a>00649          <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> = <a class="code" href="usb_8h.html#ac72da9845e02d812f88c208986ac5f4e">DEV_ADDRESS</a>;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651       <span class="comment">// Select the assigned configuration</span>
<a name="l00652"></a>00652       <span class="keywordflow">else</span>
<a name="l00653"></a>00653          bEpState = <a class="code" href="usb_8c.html#a767cd07960573244c70de3bf13db363e">SetConfiguration</a>(<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1]);
<a name="l00654"></a>00654    }
<a name="l00655"></a>00655    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = bEpState;
<a name="l00656"></a>00656 }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00660"></a>00660 
<a name="l00661"></a><a class="code" href="usb_8c.html#abe82847f44da9cca42c53b6b9bc888ad">00661</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#abe82847f44da9cca42c53b6b9bc888ad">SetInterfaceRequest</a>()
<a name="l00662"></a>00662 {
<a name="l00663"></a>00663    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>          bEpState;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665    <span class="comment">// Length field must be zero</span>
<a name="l00666"></a>00666    <span class="keywordflow">if</span> ((<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>) || (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> != <a class="code" href="usb_8h.html#a48a2fc14f74e3e449211ed1e47161d29">DEV_CONFIG</a>))
<a name="l00667"></a>00667       bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00668"></a>00668 
<a name="l00669"></a>00669    <span class="keywordflow">else</span>
<a name="l00670"></a>00670    {
<a name="l00671"></a>00671       <span class="comment">// Check that target interface exists for this configuration</span>
<a name="l00672"></a>00672       <span class="keywordflow">if</span>(<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> &gt; <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#a42d4a0e12f22861a45759d2cbb14bb65">bNumInterf</a> - 1)
<a name="l00673"></a>00673          bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675       <span class="keywordflow">else</span>
<a name="l00676"></a>00676       {
<a name="l00677"></a>00677          <span class="comment">// Get pointer to interface status structure</span>
<a name="l00678"></a>00678          <a class="code" href="usb_8c.html#aed6d1ffc564f97992cd2f1bdd33246ac">pIfStatus</a> = (<a class="code" href="structIF__STATUS.html">PIF_STATUS</a>)&amp;<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#a7323845204c4d16b50f74efcbd80b2db">IfStatus</a>;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680          <span class="comment">// Check that alternate setting exists for the interface</span>
<a name="l00681"></a>00681          <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> &gt; <a class="code" href="usb_8c.html#aed6d1ffc564f97992cd2f1bdd33246ac">pIfStatus</a>-&gt;<a class="code" href="structIF__STATUS.html#ae7f76b0eaca9cf6264e96319465ed39a">bNumAlts</a>)
<a name="l00682"></a>00682             bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684          <span class="comment">// Assign alternate setting</span>
<a name="l00685"></a>00685          <span class="keywordflow">else</span>
<a name="l00686"></a>00686          {
<a name="l00687"></a>00687             <a class="code" href="usb_8c.html#aed6d1ffc564f97992cd2f1bdd33246ac">pIfStatus</a>-&gt;<a class="code" href="structIF__STATUS.html#a29eb17aa9f4fdc58848e54cdb79768ec">bCurrentAlt</a> = <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>;
<a name="l00688"></a>00688             bEpState = <a class="code" href="usb_8c.html#abb552a75c16c2848d7058252b7fb2132">SetInterface</a>(<a class="code" href="usb_8c.html#aed6d1ffc564f97992cd2f1bdd33246ac">pIfStatus</a>);
<a name="l00689"></a>00689          }
<a name="l00690"></a>00690       }
<a name="l00691"></a>00691    }
<a name="l00692"></a>00692    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = bEpState;
<a name="l00693"></a>00693 }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00696"></a>00696 
<a name="l00697"></a><a class="code" href="usb_8c.html#aa5229cd51d75c80b10b0e4b2683e2d94">00697</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#aa5229cd51d75c80b10b0e4b2683e2d94">GetStatusRequest</a>()
<a name="l00698"></a>00698 {
<a name="l00699"></a>00699    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>          bEpState;
<a name="l00700"></a>00700 
<a name="l00701"></a>00701    <span class="comment">// Value field must be zero; Length field must be 2</span>
<a name="l00702"></a>00702    <span class="keywordflow">if</span> ((<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 0) || (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 0x02) ||
<a name="l00703"></a>00703    (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#a1b028fb9f7c2c1796c6ed9edac5655dd">DEV_DEFAULT</a>) ||
<a name="l00704"></a>00704    (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#ac72da9845e02d812f88c208986ac5f4e">DEV_ADDRESS</a> &amp;&amp; <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 0))
<a name="l00705"></a>00705    {
<a name="l00706"></a>00706       bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00707"></a>00707    }
<a name="l00708"></a>00708 
<a name="l00709"></a>00709    <span class="keywordflow">else</span>
<a name="l00710"></a>00710    {
<a name="l00711"></a>00711       <span class="comment">// Check for desired status (device, interface, endpoint)</span>
<a name="l00712"></a>00712       <span class="keywordflow">switch</span> (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a9dce7fd6ba04e97137fa2e917bea4a68">bmRequestType</a> &amp; <a class="code" href="usb_8h.html#a8c28bcb66410f71d517108e9eb8dc5f5">CMD_MASK_RECIP</a>)
<a name="l00713"></a>00713       {
<a name="l00714"></a>00714          <span class="comment">// Device</span>
<a name="l00715"></a>00715          <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a3897c04ae881d3c601e271417e610793">CMD_RECIP_DEV</a>:
<a name="l00716"></a>00716             <span class="comment">// Index must be zero for a Device status request</span>
<a name="l00717"></a>00717             <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 0)
<a name="l00718"></a>00718                bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00719"></a>00719             <span class="keywordflow">else</span>
<a name="l00720"></a>00720             {
<a name="l00721"></a>00721                <span class="comment">// Prepare data_out for transmission</span>
<a name="l00722"></a>00722                <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a6438d0d387a26e2bb987d0f91113f146">wData</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1] = 0;
<a name="l00723"></a>00723                <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a6438d0d387a26e2bb987d0f91113f146">wData</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[0] = <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#a7bec92c27fcbbcbbee0d67721b52d2fd">bRemoteWakeupStatus</a>;
<a name="l00724"></a>00724                <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a6438d0d387a26e2bb987d0f91113f146">wData</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[0] |= <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#ad2ee2bf926f2f3a426161792ce874167">bSelfPoweredStatus</a>;
<a name="l00725"></a>00725             }
<a name="l00726"></a>00726             <span class="keywordflow">break</span>;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728          <span class="comment">// Interface</span>
<a name="l00729"></a>00729          <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#ac24f79924850314112089eaae3437dda">CMD_RECIP_IF</a>:
<a name="l00730"></a>00730             <span class="comment">// Prepare data_out for transmission</span>
<a name="l00731"></a>00731             <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a6438d0d387a26e2bb987d0f91113f146">wData</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> = 0;
<a name="l00732"></a>00732             <span class="keywordflow">break</span>;
<a name="l00733"></a>00733 
<a name="l00734"></a>00734          <span class="comment">// Endpoint</span>
<a name="l00735"></a>00735          <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a0c41e7b58281e580eeceb10930c6ba8b">CMD_RECIP_EP</a>:
<a name="l00736"></a>00736             <span class="comment">// Prepare data_out for transmission</span>
<a name="l00737"></a>00737             <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a6438d0d387a26e2bb987d0f91113f146">wData</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> = 0;
<a name="l00738"></a>00738             <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#a43df3881423a125ec9e9d0701e4894a0">GetEpStatus</a>(<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>) == <a class="code" href="usb_8h.html#ae4e97746febb23c308d711d56fb7a245">EP_HALTED</a>)
<a name="l00739"></a>00739                <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a6438d0d387a26e2bb987d0f91113f146">wData</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[0] |= 0x01;
<a name="l00740"></a>00740             <span class="keywordflow">break</span>;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742          <span class="comment">// Other cases unsupported</span>
<a name="l00743"></a>00743          <span class="keywordflow">default</span>:
<a name="l00744"></a>00744             bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00745"></a>00745             <span class="keywordflow">break</span>;
<a name="l00746"></a>00746       }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748       <span class="comment">// Endpoint0 state assignment</span>
<a name="l00749"></a>00749       bEpState = <a class="code" href="usb_8h.html#ad7b979706744814588bc245a14873912">EP_TX</a>;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751       <span class="comment">// Point ep0 data pointer to transmit data_out</span>
<a name="l00752"></a>00752       <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)&amp;<a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a6438d0d387a26e2bb987d0f91113f146">wData</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>;
<a name="l00753"></a>00753       <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = 2;
<a name="l00754"></a>00754    }
<a name="l00755"></a>00755    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = bEpState;
<a name="l00756"></a>00756 }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00759"></a>00759 
<a name="l00760"></a><a class="code" href="usb_8c.html#a0ee105af6482034a560053988bc279b7">00760</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a0ee105af6482034a560053988bc279b7">GetDescriptorRequest</a>()
<a name="l00761"></a>00761 {
<a name="l00762"></a>00762    <a class="code" href="unionWORD.html">WORD</a> wTempInt;
<a name="l00763"></a>00763    <a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uNumBytes;
<a name="l00764"></a>00764    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bEpState;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766    <span class="comment">// This request is valid in all device states</span>
<a name="l00767"></a>00767    <span class="comment">// Switch on requested descriptor (Value field)</span>
<a name="l00768"></a>00768    <span class="keywordflow">switch</span> (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[0])
<a name="l00769"></a>00769    {
<a name="l00770"></a>00770       <span class="comment">// Device Descriptor Request</span>
<a name="l00771"></a>00771       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#a4ffbe43819f62b5a471d7e287c4d6250">DSC_DEVICE</a>:
<a name="l00772"></a>00772          <span class="comment">// Get size of the requested descriptor</span>
<a name="l00773"></a>00773          uNumBytes = <a class="code" href="usb_8h.html#ae30ae8cadfd1c356a1e8e082e30f9507">STD_DSC_SIZE</a>;
<a name="l00774"></a>00774          <span class="comment">// Prep to send the requested length</span>
<a name="l00775"></a>00775          <span class="keywordflow">if</span> (uNumBytes &gt; <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>)
<a name="l00776"></a>00776          {
<a name="l00777"></a>00777             uNumBytes = <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>;
<a name="l00778"></a>00778          }
<a name="l00779"></a>00779          <span class="comment">// Point data pointer to the requested descriptor</span>
<a name="l00780"></a>00780          <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = (<span class="keywordtype">void</span>*)&amp;<a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">gDescriptorMap</a>.<a class="code" href="structDESCRIPTORS.html#a73921f049cf146d10e0cda61780c485b">bStdDevDsc</a>;
<a name="l00781"></a>00781          bEpState = <a class="code" href="usb_8h.html#ad7b979706744814588bc245a14873912">EP_TX</a>;
<a name="l00782"></a>00782          <span class="keywordflow">break</span>;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784       <span class="comment">// Configuration Descriptor Request</span>
<a name="l00785"></a>00785       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#ac1937f92b0f7d2d6fef49e3e1c2d4efe">DSC_CONFIG</a>:
<a name="l00786"></a>00786          <span class="comment">// Make sure requested descriptor exists</span>
<a name="l00787"></a>00787          <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1] &gt;
<a name="l00788"></a>00788          <a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">gDescriptorMap</a>.<a class="code" href="structDESCRIPTORS.html#a73921f049cf146d10e0cda61780c485b">bStdDevDsc</a>[<a class="code" href="usb_8h.html#a6262d088caf4ca963f4e895756e246a2">std_bNumConfigurations</a>])
<a name="l00789"></a>00789          {
<a name="l00790"></a>00790             bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00791"></a>00791          }
<a name="l00792"></a>00792          <span class="keywordflow">else</span>
<a name="l00793"></a>00793          {
<a name="l00794"></a>00794             <span class="comment">// Get total length of this configuration descriptor</span>
<a name="l00795"></a>00795             <span class="comment">// (includes all associated interface and endpoints)</span>
<a name="l00796"></a>00796             wTempInt.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1] = <a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">gDescriptorMap</a>.<a class="code" href="structDESCRIPTORS.html#a4b8fff78a88a42f63f97ba283d168f6e">bCfg1</a>[<a class="code" href="usb_8h.html#ae98fe3b33ad2f101fa446aabb53e02c6">cfg_wTotalLength_lsb</a>];
<a name="l00797"></a>00797             wTempInt.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[0] = <a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">gDescriptorMap</a>.<a class="code" href="structDESCRIPTORS.html#a4b8fff78a88a42f63f97ba283d168f6e">bCfg1</a>[<a class="code" href="usb_8h.html#a3a540b59fbde4d6996bcbe57d8bd0efb">cfg_wTotalLength_msb</a>];
<a name="l00798"></a>00798             uNumBytes = wTempInt.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800             <span class="comment">// Prep to transmit the requested length</span>
<a name="l00801"></a>00801             <span class="keywordflow">if</span> (uNumBytes &gt; <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>)
<a name="l00802"></a>00802             {
<a name="l00803"></a>00803                uNumBytes = <a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>;
<a name="l00804"></a>00804             }
<a name="l00805"></a>00805             <span class="comment">// Point data pointer to requested descriptor</span>
<a name="l00806"></a>00806             <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = &amp;<a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">gDescriptorMap</a>.<a class="code" href="structDESCRIPTORS.html#a4b8fff78a88a42f63f97ba283d168f6e">bCfg1</a>;
<a name="l00807"></a>00807             bEpState = <a class="code" href="usb_8h.html#ad7b979706744814588bc245a14873912">EP_TX</a>;
<a name="l00808"></a>00808          }
<a name="l00809"></a>00809          <span class="keywordflow">break</span>;
<a name="l00810"></a>00810 
<a name="l00811"></a>00811       <span class="comment">// String Descriptor Request</span>
<a name="l00812"></a>00812       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#ae7493f4ad434cacc5cab43b263f8623a">DSC_STRING</a>:
<a name="l00813"></a>00813          <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = (<span class="keywordtype">void</span>*)<a class="code" href="usb_8c.html#a5ae87f476974354384058a23233a9925">StringDescTable</a>[<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ae3d9bdbbfa4148c27f4df4e999a6e3ab">c</a>[1]];
<a name="l00814"></a>00814          uNumBytes = *((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)<a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a>);
<a name="l00815"></a>00815          bEpState = <a class="code" href="usb_8h.html#ad7b979706744814588bc245a14873912">EP_TX</a>;
<a name="l00816"></a>00816          <span class="keywordflow">break</span>;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818    }
<a name="l00819"></a>00819    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = uNumBytes;
<a name="l00820"></a>00820    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = bEpState;
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00824"></a>00824 
<a name="l00825"></a><a class="code" href="usb_8c.html#aec12f6772ebdc27963199b4b11afe14a">00825</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#aec12f6772ebdc27963199b4b11afe14a">GetConfigurationRequest</a>()
<a name="l00826"></a>00826 {
<a name="l00827"></a>00827    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>          bEpState;
<a name="l00828"></a>00828 
<a name="l00829"></a>00829    <span class="comment">// Length field must be 1; Index field must be 0;</span>
<a name="l00830"></a>00830    <span class="comment">// Value field must be 0</span>
<a name="l00831"></a>00831    <span class="keywordflow">if</span> ((<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 1) || (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>) ||
<a name="l00832"></a>00832    (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>) || (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#a1b028fb9f7c2c1796c6ed9edac5655dd">DEV_DEFAULT</a>))
<a name="l00833"></a>00833    {
<a name="l00834"></a>00834       bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00835"></a>00835    }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> == <a class="code" href="usb_8h.html#ac72da9845e02d812f88c208986ac5f4e">DEV_ADDRESS</a>)
<a name="l00838"></a>00838    {
<a name="l00839"></a>00839       <span class="comment">// Prepare data_out for transmission</span>
<a name="l00840"></a>00840       <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a6438d0d387a26e2bb987d0f91113f146">wData</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> = 0;
<a name="l00841"></a>00841       <span class="comment">// Point ep0 data pointer to transmit data_out</span>
<a name="l00842"></a>00842       <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)&amp;<a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a6438d0d387a26e2bb987d0f91113f146">wData</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>;
<a name="l00843"></a>00843       <span class="comment">// ep0 state assignment</span>
<a name="l00844"></a>00844       bEpState = <a class="code" href="usb_8h.html#ad7b979706744814588bc245a14873912">EP_TX</a>;
<a name="l00845"></a>00845    }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847    <span class="keywordflow">else</span>
<a name="l00848"></a>00848    {
<a name="l00849"></a>00849       <span class="comment">// Index to desired field</span>
<a name="l00850"></a>00850       <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = (<span class="keywordtype">void</span> *)&amp;<a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">gDescriptorMap</a>.<a class="code" href="structDESCRIPTORS.html#a4b8fff78a88a42f63f97ba283d168f6e">bCfg1</a>[<a class="code" href="usb_8h.html#ae61ca93cab981d564edc0410ee56c602">cfg_bConfigurationValue</a>];
<a name="l00851"></a>00851 
<a name="l00852"></a>00852       <span class="comment">// ep0 state assignment</span>
<a name="l00853"></a>00853       bEpState = <a class="code" href="usb_8h.html#ad7b979706744814588bc245a14873912">EP_TX</a>;
<a name="l00854"></a>00854    }
<a name="l00855"></a>00855    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = 1;
<a name="l00856"></a>00856    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = bEpState;
<a name="l00857"></a>00857 }
<a name="l00858"></a>00858 
<a name="l00859"></a>00859 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00860"></a>00860 
<a name="l00861"></a><a class="code" href="usb_8c.html#a31c1232cf15896e6d64d58874008cbf8">00861</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a31c1232cf15896e6d64d58874008cbf8">GetInterfaceRequest</a>()
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>          bEpState;
<a name="l00864"></a>00864 
<a name="l00865"></a>00865    <span class="comment">// Value field must be 0; Length field must be 1</span>
<a name="l00866"></a>00866    <span class="keywordflow">if</span> ((<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a8f5e0f45a153285c1921cd8d70080927">wValue</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a>) || (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a6a7b26a4b8ecb311c27727266bcd8224">wLength</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> != 1) ||
<a name="l00867"></a>00867    (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> != <a class="code" href="usb_8h.html#a48a2fc14f74e3e449211ed1e47161d29">DEV_CONFIG</a>))
<a name="l00868"></a>00868    {
<a name="l00869"></a>00869       bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00870"></a>00870    }
<a name="l00871"></a>00871 
<a name="l00872"></a>00872    <span class="keywordflow">else</span>
<a name="l00873"></a>00873    {
<a name="l00874"></a>00874       <span class="comment">// Make sure requested interface exists</span>
<a name="l00875"></a>00875       <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#aaf4bfbc6435f65a3256613c581100b0b">gEp0Command</a>.<a class="code" href="structEP0__COMMAND.html#a0c7b92d8d76aaeaa07b1fc3e924df7c8">wIndex</a>.<a class="code" href="unionWORD.html#ade77b4d42a4330d12a11c2ed7ab20e31">i</a> &gt; <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#a42d4a0e12f22861a45759d2cbb14bb65">bNumInterf</a> - 1)
<a name="l00876"></a>00876          bEpState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00877"></a>00877       <span class="keywordflow">else</span>
<a name="l00878"></a>00878       {
<a name="l00879"></a>00879          <span class="comment">// Get current interface setting</span>
<a name="l00880"></a>00880          <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = (<span class="keywordtype">void</span> *)&amp;<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#a7323845204c4d16b50f74efcbd80b2db">IfStatus</a>-&gt;<a class="code" href="structIF__STATUS.html#a29eb17aa9f4fdc58848e54cdb79768ec">bCurrentAlt</a>;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882          <span class="comment">// Length must be 1</span>
<a name="l00883"></a>00883          <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = 1;
<a name="l00884"></a>00884          bEpState = <a class="code" href="usb_8h.html#ad7b979706744814588bc245a14873912">EP_TX</a>;
<a name="l00885"></a>00885       }
<a name="l00886"></a>00886    }
<a name="l00887"></a>00887    <a class="code" href="usb_8c.html#aefd51448ec8c0a92d312048d830c9fb4">gEp0Status</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = bEpState;
<a name="l00888"></a>00888 }
<a name="l00889"></a>00889 
<a name="l00890"></a>00890 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00891"></a>00891 
<a name="l00892"></a><a class="code" href="usb_8c.html#a7df5bc9644bf3d259eff3127978cc3b4">00892</a> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#a7df5bc9644bf3d259eff3127978cc3b4">HaltEndpoint</a>(<a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uEp)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bReturnState, bIndex;
<a name="l00895"></a>00895 
<a name="l00896"></a>00896    <span class="comment">// Save current INDEX value and target selected endpoint</span>
<a name="l00897"></a>00897    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a> (<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, bIndex);
<a name="l00898"></a>00898    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a> (<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>)uEp &amp; 0x00EF);
<a name="l00899"></a>00899 
<a name="l00900"></a>00900    <span class="comment">// Halt selected endpoint and update its status flag</span>
<a name="l00901"></a>00901    <span class="keywordflow">switch</span> (uEp)
<a name="l00902"></a>00902    {
<a name="l00903"></a>00903       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#af228ee02d625b4a52d0ac8678fa5d8ad">EP1_IN</a>:
<a name="l00904"></a>00904          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a> (<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, <a class="code" href="usb_8h.html#a6da9f8173f172439ccc9282cc6c27e15">rbInSDSTL</a>);
<a name="l00905"></a>00905          <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#ae4e97746febb23c308d711d56fb7a245">EP_HALTED</a>;
<a name="l00906"></a>00906          bReturnState = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;          <span class="comment">// Return success flag</span>
<a name="l00907"></a>00907          <span class="keywordflow">break</span>;
<a name="l00908"></a>00908       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#acd8fa600f13d727d619a38f49ec95f73">EP2_OUT</a>:
<a name="l00909"></a>00909          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a> (<a class="code" href="usb_8h.html#a039a0d8447ba87a70fc60966eeda8891">EOUTCSRL</a>, <a class="code" href="usb_8h.html#a9696407febcb4dce1b8453bc1084d325">rbOutSDSTL</a>);
<a name="l00910"></a>00910          <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#ae4e97746febb23c308d711d56fb7a245">EP_HALTED</a>;
<a name="l00911"></a>00911          bReturnState = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;          <span class="comment">// Return success flag</span>
<a name="l00912"></a>00912          <span class="keywordflow">break</span>;
<a name="l00913"></a>00913       <span class="keywordflow">default</span>:
<a name="l00914"></a>00914          bReturnState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;         <span class="comment">// Return error flag</span>
<a name="l00915"></a>00915                                           <span class="comment">// if endpoint not found</span>
<a name="l00916"></a>00916          <span class="keywordflow">break</span>;
<a name="l00917"></a>00917    }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a> (<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, bIndex);           <span class="comment">// Restore saved INDEX</span>
<a name="l00920"></a>00920    <span class="keywordflow">return</span> bReturnState;
<a name="l00921"></a>00921 }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00924"></a>00924 
<a name="l00925"></a><a class="code" href="usb_8c.html#ab44ba6e2102bc4505542ae106acb7bb4">00925</a> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#ab44ba6e2102bc4505542ae106acb7bb4">EnableEndpoint</a>(<a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uEp)
<a name="l00926"></a>00926 {
<a name="l00927"></a>00927    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bReturnState, bIndex;
<a name="l00928"></a>00928 
<a name="l00929"></a>00929    <span class="comment">// Save current INDEX value and target selected endpoint</span>
<a name="l00930"></a>00930    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a> (<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, bIndex);
<a name="l00931"></a>00931    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a> (<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>)uEp &amp; 0x00EF);
<a name="l00932"></a>00932 
<a name="l00933"></a>00933    <span class="comment">// Flag selected endpoint has HALTED</span>
<a name="l00934"></a>00934    <span class="keywordflow">switch</span> (uEp)
<a name="l00935"></a>00935    {
<a name="l00936"></a>00936       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#af228ee02d625b4a52d0ac8678fa5d8ad">EP1_IN</a>:
<a name="l00937"></a>00937          <span class="comment">// Disable STALL condition and clear the data toggle</span>
<a name="l00938"></a>00938          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a> (<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, <a class="code" href="usb_8h.html#a55de0e2220bb0b878335e37e462d778b">rbInCLRDT</a>);
<a name="l00939"></a>00939          <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>; <span class="comment">// Return success</span>
<a name="l00940"></a>00940          bReturnState = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;
<a name="l00941"></a>00941          <span class="keywordflow">break</span>;
<a name="l00942"></a>00942       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#acd8fa600f13d727d619a38f49ec95f73">EP2_OUT</a>:
<a name="l00943"></a>00943          <span class="comment">// Disable STALL condition and clear the data toggle</span>
<a name="l00944"></a>00944          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a> (<a class="code" href="usb_8h.html#a039a0d8447ba87a70fc60966eeda8891">EOUTCSRL</a>, <a class="code" href="usb_8h.html#a951aa8e9e449468575251893b3d90682">rbOutCLRDT</a>);
<a name="l00945"></a>00945          <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;<span class="comment">// Return success</span>
<a name="l00946"></a>00946          bReturnState = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;
<a name="l00947"></a>00947          <span class="keywordflow">break</span>;
<a name="l00948"></a>00948       <span class="keywordflow">default</span>:
<a name="l00949"></a>00949          bReturnState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;         <span class="comment">// Return error</span>
<a name="l00950"></a>00950                                           <span class="comment">// if no endpoint found</span>
<a name="l00951"></a>00951          <span class="keywordflow">break</span>;
<a name="l00952"></a>00952    }
<a name="l00953"></a>00953 
<a name="l00954"></a>00954    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a> (<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, bIndex);           <span class="comment">// Restore INDEX</span>
<a name="l00955"></a>00955 
<a name="l00956"></a>00956    <span class="keywordflow">return</span> bReturnState;
<a name="l00957"></a>00957 }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00960"></a>00960 
<a name="l00961"></a><a class="code" href="usb_8c.html#a43df3881423a125ec9e9d0701e4894a0">00961</a> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#a43df3881423a125ec9e9d0701e4894a0">GetEpStatus</a>(<a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uEp)
<a name="l00962"></a>00962 {
<a name="l00963"></a>00963    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bReturnState;
<a name="l00964"></a>00964 
<a name="l00965"></a>00965    <span class="comment">// Get selected endpoint status</span>
<a name="l00966"></a>00966    <span class="keywordflow">switch</span> (uEp)
<a name="l00967"></a>00967    {
<a name="l00968"></a>00968       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#af228ee02d625b4a52d0ac8678fa5d8ad">EP1_IN</a>:
<a name="l00969"></a>00969          bReturnState = <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a>;
<a name="l00970"></a>00970          <span class="keywordflow">break</span>;
<a name="l00971"></a>00971       <span class="keywordflow">case</span> <a class="code" href="usb_8h.html#acd8fa600f13d727d619a38f49ec95f73">EP2_OUT</a>:
<a name="l00972"></a>00972          bReturnState = <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a>;
<a name="l00973"></a>00973          <span class="keywordflow">break</span>;
<a name="l00974"></a>00974       <span class="keywordflow">default</span>:
<a name="l00975"></a>00975          bReturnState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00976"></a>00976          <span class="keywordflow">break</span>;
<a name="l00977"></a>00977    }
<a name="l00978"></a>00978 
<a name="l00979"></a>00979    <span class="keywordflow">return</span> bReturnState;
<a name="l00980"></a>00980 }
<a name="l00981"></a>00981 
<a name="l00982"></a>00982 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00983"></a>00983 
<a name="l00984"></a><a class="code" href="usb_8c.html#a767cd07960573244c70de3bf13db363e">00984</a> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#a767cd07960573244c70de3bf13db363e">SetConfiguration</a>(<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> SelectConfig)
<a name="l00985"></a>00985 {
<a name="l00986"></a>00986    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bReturnState = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;           <span class="comment">// Endpoint state return value</span>
<a name="l00987"></a>00987 
<a name="l00988"></a>00988    <a class="code" href="structIF__STATUS.html">PIF_STATUS</a> <a class="code" href="usb_8c.html#aed6d1ffc564f97992cd2f1bdd33246ac">pIfStatus</a>;                  <span class="comment">// Pointer to interface status</span>
<a name="l00989"></a>00989                                           <span class="comment">// structure</span>
<a name="l00990"></a>00990 
<a name="l00991"></a>00991    <span class="comment">// Store address of selected config desc</span>
<a name="l00992"></a>00992    <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#aadef6d603815d3aa8ba25d9c61439435">pConfig</a> = &amp;<a class="code" href="usb_8c.html#a863352e56c53f0c826fc12c343e9e3ca">gDescriptorMap</a>.<a class="code" href="structDESCRIPTORS.html#a4b8fff78a88a42f63f97ba283d168f6e">bCfg1</a>;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994    <span class="comment">// Confirm that this configuration descriptor matches the requested</span>
<a name="l00995"></a>00995    <span class="comment">// configuration value</span>
<a name="l00996"></a>00996    <span class="keywordflow">if</span> (<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#aadef6d603815d3aa8ba25d9c61439435">pConfig</a>[<a class="code" href="usb_8h.html#ae61ca93cab981d564edc0410ee56c602">cfg_bConfigurationValue</a>] != SelectConfig)
<a name="l00997"></a>00997    {
<a name="l00998"></a>00998       bReturnState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l00999"></a>00999    }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001    <span class="keywordflow">else</span>
<a name="l01002"></a>01002    {
<a name="l01003"></a>01003       <span class="comment">// Store number of interfaces for this configuration</span>
<a name="l01004"></a>01004       <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#a42d4a0e12f22861a45759d2cbb14bb65">bNumInterf</a> = <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#aadef6d603815d3aa8ba25d9c61439435">pConfig</a>[<a class="code" href="usb_8h.html#a5f00f387d18d3a82cccd3880b1425f69">cfg_bNumInterfaces</a>];
<a name="l01005"></a>01005 
<a name="l01006"></a>01006       <span class="comment">// Store total number of interface descriptors for this configuration</span>
<a name="l01007"></a>01007       <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#ab8ccf0c5e5b0c6a395efeee86e4db5bc">bTotalInterfDsc</a> = <a class="code" href="usb_8h.html#a43d281165a299ae05da3324187789834">MAX_IF</a>;
<a name="l01008"></a>01008 
<a name="l01009"></a>01009       <span class="comment">// Get pointer to the interface status structure</span>
<a name="l01010"></a>01010       pIfStatus = (<a class="code" href="structIF__STATUS.html">PIF_STATUS</a>)&amp;<a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#a7323845204c4d16b50f74efcbd80b2db">IfStatus</a>[0];
<a name="l01011"></a>01011 
<a name="l01012"></a>01012       <span class="comment">// Build Interface status structure for Interface0</span>
<a name="l01013"></a>01013       pIfStatus-&gt;<a class="code" href="structIF__STATUS.html#afdf2f0a0c1bca57e9c1e5d13d50c1403">bIfNumber</a> = 0;           <span class="comment">// Set interface number</span>
<a name="l01014"></a>01014       pIfStatus-&gt;<a class="code" href="structIF__STATUS.html#a29eb17aa9f4fdc58848e54cdb79768ec">bCurrentAlt</a> = 0;         <span class="comment">// Select alternate number zero</span>
<a name="l01015"></a>01015       pIfStatus-&gt;<a class="code" href="structIF__STATUS.html#ae7f76b0eaca9cf6264e96319465ed39a">bNumAlts</a> = 0;            <span class="comment">// No other alternates</span>
<a name="l01016"></a>01016 
<a name="l01017"></a>01017       <a class="code" href="usb_8c.html#abb552a75c16c2848d7058252b7fb2132">SetInterface</a>(pIfStatus);            <span class="comment">// Configure Interface0, Alternate0</span>
<a name="l01018"></a>01018 
<a name="l01019"></a>01019       <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#afa0013e5dd0db4ee2383ee88bd7b3052">bDevState</a> = <a class="code" href="usb_8h.html#a48a2fc14f74e3e449211ed1e47161d29">DEV_CONFIG</a>;<span class="comment">// Set device state to configured</span>
<a name="l01020"></a>01020       <a class="code" href="usb_8c.html#a2c726330531b8c4f3f28e6a109ffdf0f">gDeviceStatus</a>.<a class="code" href="structDEVICE__STATUS.html#a76b1934ef5b3a3a39ef3f74ec42222f7">bCurrentConfig</a> = SelectConfig;<span class="comment">// Store current config</span>
<a name="l01021"></a>01021    }
<a name="l01022"></a>01022 
<a name="l01023"></a>01023    <span class="keywordflow">return</span> bReturnState;
<a name="l01024"></a>01024 }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01027"></a>01027 
<a name="l01028"></a><a class="code" href="usb_8c.html#abb552a75c16c2848d7058252b7fb2132">01028</a> <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="usb_8c.html#abb552a75c16c2848d7058252b7fb2132">SetInterface</a>(<a class="code" href="structIF__STATUS.html">PIF_STATUS</a> <a class="code" href="usb_8c.html#aed6d1ffc564f97992cd2f1bdd33246ac">pIfStatus</a>)
<a name="l01029"></a>01029 {
<a name="l01030"></a>01030    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bReturnState = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;
<a name="l01031"></a>01031    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bIndex;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033    <span class="comment">// Save current INDEX value</span>
<a name="l01034"></a>01034    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a> (<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, bIndex);
<a name="l01035"></a>01035 
<a name="l01036"></a>01036    <span class="comment">// Add actions for each possible interface alternate selections</span>
<a name="l01037"></a>01037    <span class="keywordflow">switch</span>(pIfStatus-&gt;<a class="code" href="structIF__STATUS.html#afdf2f0a0c1bca57e9c1e5d13d50c1403">bIfNumber</a>)
<a name="l01038"></a>01038    {
<a name="l01039"></a>01039       <span class="comment">// Configure endpoints for interface0</span>
<a name="l01040"></a>01040       <span class="keywordflow">case</span> 0:
<a name="l01041"></a>01041          <span class="comment">// Configure Endpoint1 IN</span>
<a name="l01042"></a>01042          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, 1);           <span class="comment">// Index to Endpoint1 registers</span>
<a name="l01043"></a>01043          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ad674a2ea88f8b79b032377fca20be3f9">EINCSRH</a>, 0x20);      <span class="comment">// FIFO split disabled,</span>
<a name="l01044"></a>01044                                           <span class="comment">// direction = IN</span>
<a name="l01045"></a>01045          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#adf9c5cfd773ea59dfdefe7cdbc5ec06c">EOUTCSRH</a>, 0);        <span class="comment">// Double-buffering disabled</span>
<a name="l01046"></a>01046          <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = 0;      <span class="comment">// Reset byte counter</span>
<a name="l01047"></a>01047          <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>.<a class="code" href="structEP__STATUS.html#abd9085f4a3ee2f6280a80d2b6480c311">uMaxP</a> = <a class="code" href="usb_8h.html#a4909b1f555165f2d2ee3874484d4cba7">EP1_PACKET_SIZE</a>;<span class="comment">// Set maximum packet size</span>
<a name="l01048"></a>01048          <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>.<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a> = <a class="code" href="usb_8h.html#af228ee02d625b4a52d0ac8678fa5d8ad">EP1_IN</a>;       <span class="comment">// Set endpoint address</span>
<a name="l01049"></a>01049          <a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>; <span class="comment">// Set endpoint state</span>
<a name="l01050"></a>01050 
<a name="l01051"></a>01051          <span class="comment">// Endpoint2 OUT</span>
<a name="l01052"></a>01052          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, 2);           <span class="comment">// Index to Endpoint2 registers</span>
<a name="l01053"></a>01053          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ad674a2ea88f8b79b032377fca20be3f9">EINCSRH</a>, 0x00);      <span class="comment">// FIFO split disabled,</span>
<a name="l01054"></a>01054                                           <span class="comment">// direction = OUT</span>
<a name="l01055"></a>01055          <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>.<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = 0;     <span class="comment">// Reset byte counter</span>
<a name="l01056"></a>01056          <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>.<a class="code" href="structEP__STATUS.html#abd9085f4a3ee2f6280a80d2b6480c311">uMaxP</a> = <a class="code" href="usb_8h.html#ad58553c0d8a6a3b40c0d66ba5a740c56">EP2_PACKET_SIZE</a>;<span class="comment">// Set maximum packet size</span>
<a name="l01057"></a>01057          <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>.<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a> = <a class="code" href="usb_8h.html#acd8fa600f13d727d619a38f49ec95f73">EP2_OUT</a>;     <span class="comment">// Set endpoint number</span>
<a name="l01058"></a>01058          <a class="code" href="usb_8c.html#abd71bf9ec29dac0a66685d194542817d">gEp2OutStatus</a>.<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> = <a class="code" href="usb_8h.html#a6e18be5b554a81fdecd55f378d2b945b">EP_IDLE</a>;<span class="comment">// Set endpoint state</span>
<a name="l01059"></a>01059 
<a name="l01060"></a>01060          <span class="comment">// Load first outgoing (IN) packet into FIFO</span>
<a name="l01061"></a>01061 <span class="comment">//##!!!         BulkOrInterruptIn(&amp;gEp1InStatus);</span>
<a name="l01062"></a>01062 
<a name="l01063"></a>01063          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, 0);           <span class="comment">// Return to index 0</span>
<a name="l01064"></a>01064 
<a name="l01065"></a>01065          <span class="keywordflow">break</span>;
<a name="l01066"></a>01066 
<a name="l01067"></a>01067       <span class="comment">// Configure endpoints for interface1</span>
<a name="l01068"></a>01068       <span class="keywordflow">case</span> 1:
<a name="l01069"></a>01069 
<a name="l01070"></a>01070       <span class="comment">// Configure endpoints for interface2</span>
<a name="l01071"></a>01071       <span class="keywordflow">case</span> 2:
<a name="l01072"></a>01072 
<a name="l01073"></a>01073       <span class="comment">// Default (error)</span>
<a name="l01074"></a>01074       <span class="keywordflow">default</span>:
<a name="l01075"></a>01075          bReturnState = <a class="code" href="usb_8h.html#ad09d42f517f9af7cc2d6453210595546">EP_ERROR</a>;
<a name="l01076"></a>01076    }
<a name="l01077"></a>01077    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a> (<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, bIndex);           <span class="comment">// Restore INDEX</span>
<a name="l01078"></a>01078 
<a name="l01079"></a>01079    <span class="keywordflow">return</span> bReturnState;
<a name="l01080"></a>01080 }
<a name="l01081"></a>01081 
<a name="l01082"></a>01082 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01083"></a>01083 
<a name="l01084"></a><a class="code" href="usb_8c.html#a570cc546c11d585b243f1e00b2c4e9c0">01084</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a570cc546c11d585b243f1e00b2c4e9c0">BulkOrInterruptOut</a>(<a class="code" href="structEP__STATUS.html">PEP_STATUS</a> pEpOutStatus)
<a name="l01085"></a>01085 {
<a name="l01086"></a>01086    <a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uBytes;
<a name="l01087"></a>01087    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bTemp = 0;
<a name="l01088"></a>01088    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bCsrL, bCsrH;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, pEpOutStatus-&gt;<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a>); <span class="comment">// Index to current endpoint</span>
<a name="l01091"></a>01091    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#a039a0d8447ba87a70fc60966eeda8891">EOUTCSRL</a>, bCsrL);
<a name="l01092"></a>01092    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#adf9c5cfd773ea59dfdefe7cdbc5ec06c">EOUTCSRH</a>, bCsrH);
<a name="l01093"></a>01093 
<a name="l01094"></a>01094    <span class="comment">// Make sure this endpoint is not halted</span>
<a name="l01095"></a>01095    <span class="keywordflow">if</span> (pEpOutStatus-&gt;<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> != <a class="code" href="usb_8h.html#ae4e97746febb23c308d711d56fb7a245">EP_HALTED</a>)
<a name="l01096"></a>01096    {
<a name="l01097"></a>01097       <span class="comment">// Handle STALL condition sent</span>
<a name="l01098"></a>01098       <span class="keywordflow">if</span> (bCsrL &amp; <a class="code" href="usb_8h.html#a83bbf1d91d39e84f86e499bc68040788">rbOutSTSTL</a>)
<a name="l01099"></a>01099       {
<a name="l01100"></a>01100          <span class="comment">// Clear Send Stall, Sent Stall, and data toggle</span>
<a name="l01101"></a>01101          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a039a0d8447ba87a70fc60966eeda8891">EOUTCSRL</a>, <a class="code" href="usb_8h.html#a951aa8e9e449468575251893b3d90682">rbOutCLRDT</a>);
<a name="l01102"></a>01102       }
<a name="l01103"></a>01103 
<a name="l01104"></a>01104       <span class="comment">// Read received packet(s)</span>
<a name="l01105"></a>01105       <span class="comment">// If double-buffering is enabled, multiple packets may be ready</span>
<a name="l01106"></a>01106       <span class="keywordflow">while</span>(bCsrL &amp; <a class="code" href="usb_8h.html#afbb098434a9cabfb627abd77a83777e6">rbOutOPRDY</a>)
<a name="l01107"></a>01107       {
<a name="l01108"></a>01108          <span class="comment">// Get packet length</span>
<a name="l01109"></a>01109          <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#a9959773fd443be9acba8674c87808c6b">EOUTCNTL</a>, bTemp);     <span class="comment">// Low byte</span>
<a name="l01110"></a>01110          uBytes = (<a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a>)bTemp &amp; 0x00FF;
<a name="l01111"></a>01111 
<a name="l01112"></a>01112          <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#ae50f1c83576013581f3040ae47928f23">EOUTCNTH</a>, bTemp);     <span class="comment">// High byte</span>
<a name="l01113"></a>01113          uBytes |= (<a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a>)bTemp &lt;&lt; 8;
<a name="l01114"></a>01114 
<a name="l01115"></a>01115          <span class="keywordflow">if</span> (uBytes &lt;= <a class="code" href="usb_8h.html#ad58553c0d8a6a3b40c0d66ba5a740c56">EP2_PACKET_SIZE</a>)
<a name="l01116"></a>01116          {
<a name="l01117"></a>01117             <span class="comment">// Read FIFO</span>
<a name="l01118"></a>01118             <a class="code" href="usb_8c.html#aab679f5b6ff0614db1431cb56ef71fca">FIFORead</a>(pEpOutStatus-&gt;<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a>, uBytes, (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb_8c.html#aeded1e22bdf225f1bd2b1251c6b152e4">prx_buf</a>);
<a name="l01119"></a>01119             pEpOutStatus-&gt;<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = uBytes;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121             <span class="comment">// Signal new data</span>
<a name="l01122"></a>01122             *<a class="code" href="usb_8c.html#a12948fff4da793612d072ca8447ae9d4">pn_rx</a> = uBytes;
<a name="l01123"></a>01123          }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125          <span class="comment">// If a data packet of anything but 8 bytes is received, ignore</span>
<a name="l01126"></a>01126          <span class="comment">// and flush the FIFO</span>
<a name="l01127"></a>01127          <span class="keywordflow">else</span>
<a name="l01128"></a>01128          {
<a name="l01129"></a>01129             <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a039a0d8447ba87a70fc60966eeda8891">EOUTCSRL</a>, <a class="code" href="usb_8h.html#a42a2606fe2c58ab557ee238ef4acc062">rbOutFLUSH</a>);
<a name="l01130"></a>01130          }
<a name="l01131"></a>01131 
<a name="l01132"></a>01132          <span class="comment">// Clear out-packet-ready</span>
<a name="l01133"></a>01133          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, pEpOutStatus-&gt;<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a>);
<a name="l01134"></a>01134          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a039a0d8447ba87a70fc60966eeda8891">EOUTCSRL</a>, 0);
<a name="l01135"></a>01135 
<a name="l01136"></a>01136          <span class="comment">// Read updated status register</span>
<a name="l01137"></a>01137          <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#a039a0d8447ba87a70fc60966eeda8891">EOUTCSRL</a>, bCsrL);
<a name="l01138"></a>01138       }
<a name="l01139"></a>01139    }
<a name="l01140"></a>01140 }
<a name="l01141"></a>01141 
<a name="l01142"></a>01142 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01143"></a>01143 
<a name="l01144"></a><a class="code" href="usb_8c.html#a59cb6a9fff1ed438f36eba1fb66c842a">01144</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a59cb6a9fff1ed438f36eba1fb66c842a">BulkOrInterruptIn</a>(<a class="code" href="structEP__STATUS.html">PEP_STATUS</a> pEpInStatus)
<a name="l01145"></a>01145 {
<a name="l01146"></a>01146    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bCsrL, bCsrH;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a>);  <span class="comment">// Index to current endpoint</span>
<a name="l01149"></a>01149    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, bCsrL);
<a name="l01150"></a>01150    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#ad674a2ea88f8b79b032377fca20be3f9">EINCSRH</a>, bCsrH);
<a name="l01151"></a>01151 
<a name="l01152"></a>01152    <span class="comment">// Make sure this endpoint is not halted</span>
<a name="l01153"></a>01153    <span class="keywordflow">if</span> (pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> != <a class="code" href="usb_8h.html#ae4e97746febb23c308d711d56fb7a245">EP_HALTED</a>)
<a name="l01154"></a>01154    {
<a name="l01155"></a>01155       <span class="comment">// Handle STALL condition sent</span>
<a name="l01156"></a>01156       <span class="keywordflow">if</span> (bCsrL &amp; <a class="code" href="usb_8h.html#ad63d9b13f6be6cc15f82734063a104c1">rbInSTSTL</a>)
<a name="l01157"></a>01157       {
<a name="l01158"></a>01158          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, <a class="code" href="usb_8h.html#a55de0e2220bb0b878335e37e462d778b">rbInCLRDT</a>); <span class="comment">// Clear Send Stall and Sent Stall,</span>
<a name="l01159"></a>01159                                           <span class="comment">// and clear data toggle</span>
<a name="l01160"></a>01160       }
<a name="l01161"></a>01161 
<a name="l01162"></a>01162       <span class="comment">// If a FIFO slot is open, write a new packet to the IN FIFO</span>
<a name="l01163"></a>01163       <span class="keywordflow">if</span> (!(bCsrL &amp; <a class="code" href="usb_8h.html#abe17d748b8cf2bec2aa6e7c3b4fc9945">rbInINPRDY</a>))
<a name="l01164"></a>01164       {
<a name="l01165"></a>01165          <a class="code" href="embedded_2mscb_8h.html#a431cf0a502f2a232e27f81080a890585">led_blink</a>(0, 1, 300);
<a name="l01166"></a>01166 
<a name="l01167"></a>01167          pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = 8;
<a name="l01168"></a>01168          pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb_8c.html#aeded1e22bdf225f1bd2b1251c6b152e4">prx_buf</a>;
<a name="l01169"></a>01169 
<a name="l01170"></a>01170          <span class="comment">// Write &lt;uNumBytes&gt; bytes to the &lt;bEp&gt; FIFO</span>
<a name="l01171"></a>01171          <a class="code" href="usb_8c.html#a2d4f061ac27d76ccd599e1337e039d89">FIFOWrite</a>(pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a>, pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a>,
<a name="l01172"></a>01172             (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a>);
<a name="l01173"></a>01173 
<a name="l01174"></a>01174          <span class="comment">// Set Packet Ready bit (INPRDY)</span>
<a name="l01175"></a>01175          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, rbInINPRDY);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177          <span class="comment">// Check updated endopint status</span>
<a name="l01178"></a>01178          <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, bCsrL);
<a name="l01179"></a>01179       }
<a name="l01180"></a>01180    }
<a name="l01181"></a>01181 }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01184"></a>01184 
<a name="l01185"></a><a class="code" href="usb_8h.html#a3c1a79728caa60dd82d896b5e1abf8db">01185</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a3c1a79728caa60dd82d896b5e1abf8db">usb_send</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>)
<a name="l01186"></a>01186 {
<a name="l01187"></a>01187    <a class="code" href="structEP__STATUS.html">PEP_STATUS</a> pEpInStatus;
<a name="l01188"></a>01188    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bCsrL, bCsrH;
<a name="l01189"></a>01189 
<a name="l01190"></a>01190    pEpInStatus = &amp;<a class="code" href="usb_8c.html#ac9099f51269d48ea08cb79e517678671">gEp1InStatus</a>;
<a name="l01191"></a>01191    <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#ac6885dbfb371c33e523c7fb046118b36">INDEX</a>, pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a>);  <span class="comment">// Index to current endpoint</span>
<a name="l01192"></a>01192    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, bCsrL);
<a name="l01193"></a>01193    <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#ad674a2ea88f8b79b032377fca20be3f9">EINCSRH</a>, bCsrH);
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    <span class="comment">// Make sure this endpoint is not halted</span>
<a name="l01196"></a>01196    <span class="keywordflow">if</span> (pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#a985690cb103c9a61d272804081516286">bEpState</a> != <a class="code" href="usb_8h.html#ae4e97746febb23c308d711d56fb7a245">EP_HALTED</a>)
<a name="l01197"></a>01197    {
<a name="l01198"></a>01198       <span class="comment">// Handle STALL condition sent</span>
<a name="l01199"></a>01199       <span class="keywordflow">if</span> (bCsrL &amp; <a class="code" href="usb_8h.html#ad63d9b13f6be6cc15f82734063a104c1">rbInSTSTL</a>)
<a name="l01200"></a>01200       {
<a name="l01201"></a>01201          <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, <a class="code" href="usb_8h.html#a55de0e2220bb0b878335e37e462d778b">rbInCLRDT</a>); <span class="comment">// Clear Send Stall and Sent Stall,</span>
<a name="l01202"></a>01202                                           <span class="comment">// and clear data toggle</span>
<a name="l01203"></a>01203       }
<a name="l01204"></a>01204 
<a name="l01205"></a>01205       <span class="comment">// If a FIFO slot is open, write a new packet to the IN FIFO</span>
<a name="l01206"></a>01206       <span class="keywordflow">if</span> (!(bCsrL &amp; <a class="code" href="usb_8h.html#abe17d748b8cf2bec2aa6e7c3b4fc9945">rbInINPRDY</a>))
<a name="l01207"></a>01207       {
<a name="l01208"></a>01208          <span class="comment">// If data available, copy it to IN FIFO</span>
<a name="l01209"></a>01209          <span class="keywordflow">if</span> (size &gt; 0) {
<a name="l01210"></a>01210             pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a> = size;
<a name="l01211"></a>01211             pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a> = (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)buffer;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213             <span class="comment">// Write &lt;uNumBytes&gt; bytes to the &lt;bEp&gt; FIFO</span>
<a name="l01214"></a>01214             <a class="code" href="usb_8c.html#a2d4f061ac27d76ccd599e1337e039d89">FIFOWrite</a>(pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#af82d317f15d71f6a081663d4e85f7e6d">bEp</a>, pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#af88968b6cf2da2555ded2a09f80074f5">uNumBytes</a>,
<a name="l01215"></a>01215                (<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)pEpInStatus-&gt;<a class="code" href="structEP__STATUS.html#a7d386f030aeb8f98b1de896f395e15e8">pData</a>);
<a name="l01216"></a>01216 
<a name="l01217"></a>01217             <span class="comment">// Set Packet Ready bit (INPRDY)</span>
<a name="l01218"></a>01218             <a class="code" href="usb_8h.html#abfb8649e625bee911ef3619c3f53a227">UWRITE_BYTE</a>(<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, rbInINPRDY);
<a name="l01219"></a>01219 
<a name="l01220"></a>01220             <span class="comment">// Check updated endopint status</span>
<a name="l01221"></a>01221             <a class="code" href="usb_8h.html#a0b908568730a49bb53f06924d933c4c5">UREAD_BYTE</a>(<a class="code" href="usb_8h.html#a310e25c5872848d94f3184b522a6f750">EINCSRL</a>, bCsrL);
<a name="l01222"></a>01222          }
<a name="l01223"></a>01223       }
<a name="l01224"></a>01224    }
<a name="l01225"></a>01225 }
<a name="l01226"></a>01226 
<a name="l01227"></a>01227 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01228"></a>01228 
<a name="l01229"></a>01229 <span class="comment">/*</span>
<a name="l01230"></a>01230 <span class="comment">   Read from the selected endpoint FIFO</span>
<a name="l01231"></a>01231 <span class="comment"></span>
<a name="l01232"></a>01232 <span class="comment">   Inputs:</span>
<a name="l01233"></a>01233 <span class="comment">     bEp: target endpoint</span>
<a name="l01234"></a>01234 <span class="comment">     uNumBytes: number of bytes to unload</span>
<a name="l01235"></a>01235 <span class="comment">     pData: read data destination</span>
<a name="l01236"></a>01236 <span class="comment">*/</span>
<a name="l01237"></a><a class="code" href="usb_8c.html#aab679f5b6ff0614db1431cb56ef71fca">01237</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#aab679f5b6ff0614db1431cb56ef71fca">FIFORead</a>(<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bEp, <a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uNumBytes, <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> * pData)
<a name="l01238"></a>01238 {
<a name="l01239"></a>01239    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> TargetReg;
<a name="l01240"></a>01240    <a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l01241"></a>01241 
<a name="l01242"></a>01242    <span class="comment">// If &gt;0 bytes requested,</span>
<a name="l01243"></a>01243    <span class="keywordflow">if</span> (uNumBytes)
<a name="l01244"></a>01244    {
<a name="l01245"></a>01245       TargetReg = <a class="code" href="usb_8h.html#aa3de86bb63a86f4d130d3c783eaf4296">FIFO_EP0</a> + bEp;         <span class="comment">// Find address for target</span>
<a name="l01246"></a>01246                                           <span class="comment">// endpoint FIFO</span>
<a name="l01247"></a>01247 
<a name="l01248"></a>01248       <a class="code" href="c8051F320_8h.html#a8aed186592a64d113e35bc72e2a7237b">USB0ADR</a> = (TargetReg &amp; 0x3F);       <span class="comment">// Set address (mask out bits7-6)</span>
<a name="l01249"></a>01249       <a class="code" href="c8051F320_8h.html#a8aed186592a64d113e35bc72e2a7237b">USB0ADR</a> |= 0xC0;                    <span class="comment">// Set auto-read and initiate</span>
<a name="l01250"></a>01250                                           <span class="comment">// first read</span>
<a name="l01251"></a>01251 
<a name="l01252"></a>01252       <span class="comment">// Unload &lt;NumBytes - 1&gt; from the selected FIFO</span>
<a name="l01253"></a>01253       <span class="keywordflow">for</span>(i=0; i&lt;(uNumBytes-1); i++)
<a name="l01254"></a>01254       {
<a name="l01255"></a>01255          <span class="keywordflow">while</span>(<a class="code" href="c8051F320_8h.html#a8aed186592a64d113e35bc72e2a7237b">USB0ADR</a> &amp; 0x80);           <span class="comment">// Wait for BUSY-&gt;&apos;0&apos; (data ready)</span>
<a name="l01256"></a>01256          pData[i] = <a class="code" href="c8051F320_8h.html#a10b781a0f4841399e4c9b2aad345d9ae">USB0DAT</a>;              <span class="comment">// Copy data byte</span>
<a name="l01257"></a>01257       }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259       <span class="comment">// Disable auto read and copy last byte</span>
<a name="l01260"></a>01260       <a class="code" href="c8051F320_8h.html#a8aed186592a64d113e35bc72e2a7237b">USB0ADR</a> = (TargetReg &amp; 0x3F);       <span class="comment">// Set address (mask out bits7-6)</span>
<a name="l01261"></a>01261       <span class="keywordflow">while</span>(<a class="code" href="c8051F320_8h.html#a8aed186592a64d113e35bc72e2a7237b">USB0ADR</a> &amp; 0x80);              <span class="comment">// Wait for BUSY-&gt;&apos;0&apos; (data ready)</span>
<a name="l01262"></a>01262       pData[i] = <a class="code" href="c8051F320_8h.html#a10b781a0f4841399e4c9b2aad345d9ae">USB0DAT</a>;                 <span class="comment">// Copy final data byte</span>
<a name="l01263"></a>01263 
<a name="l01264"></a>01264   }
<a name="l01265"></a>01265 }
<a name="l01266"></a>01266 
<a name="l01267"></a>01267 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01268"></a>01268 
<a name="l01269"></a>01269 <span class="comment">/*</span>
<a name="l01270"></a>01270 <span class="comment">   Write to the selected endpoint FIFO</span>
<a name="l01271"></a>01271 <span class="comment"></span>
<a name="l01272"></a>01272 <span class="comment">   Inputs:</span>
<a name="l01273"></a>01273 <span class="comment">     bEp: target endpoint</span>
<a name="l01274"></a>01274 <span class="comment">     uNumBytes: number of bytes to write</span>
<a name="l01275"></a>01275 <span class="comment">     pData: location of source data</span>
<a name="l01276"></a>01276 <span class="comment">*/</span>
<a name="l01277"></a><a class="code" href="usb_8c.html#a2d4f061ac27d76ccd599e1337e039d89">01277</a> <span class="keywordtype">void</span> <a class="code" href="usb_8c.html#a2d4f061ac27d76ccd599e1337e039d89">FIFOWrite</a>(<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bEp, <a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> uNumBytes, <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> * pData) reentrant
<a name="l01278"></a>01278 {
<a name="l01279"></a>01279    <a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> TargetReg;
<a name="l01280"></a>01280    <a class="code" href="usb_8h.html#a36cb3b01d81ffd844bbbfb54003e06ec">UINT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l01281"></a>01281 
<a name="l01282"></a>01282    <span class="comment">// If &gt;0 bytes requested,</span>
<a name="l01283"></a>01283    <span class="keywordflow">if</span> (uNumBytes)
<a name="l01284"></a>01284    {
<a name="l01285"></a>01285       TargetReg = <a class="code" href="usb_8h.html#aa3de86bb63a86f4d130d3c783eaf4296">FIFO_EP0</a> + bEp;         <span class="comment">// Find address for target</span>
<a name="l01286"></a>01286                                           <span class="comment">// endpoint FIFO</span>
<a name="l01287"></a>01287 
<a name="l01288"></a>01288       <span class="keywordflow">while</span>(<a class="code" href="c8051F320_8h.html#a8aed186592a64d113e35bc72e2a7237b">USB0ADR</a> &amp; 0x80);              <span class="comment">// Wait for BUSY-&gt;&apos;0&apos;</span>
<a name="l01289"></a>01289                                           <span class="comment">// (register available)</span>
<a name="l01290"></a>01290       <a class="code" href="c8051F320_8h.html#a8aed186592a64d113e35bc72e2a7237b">USB0ADR</a> = (TargetReg &amp; 0x3F);       <span class="comment">// Set address (mask out bits7-6)</span>
<a name="l01291"></a>01291 
<a name="l01292"></a>01292       <span class="comment">// Write &lt;NumBytes&gt; to the selected FIFO</span>
<a name="l01293"></a>01293       <span class="keywordflow">for</span>(i=0;i&lt;uNumBytes;i++)
<a name="l01294"></a>01294       {
<a name="l01295"></a>01295          <a class="code" href="c8051F320_8h.html#a10b781a0f4841399e4c9b2aad345d9ae">USB0DAT</a> = pData[i];
<a name="l01296"></a>01296          <span class="keywordflow">while</span>(<a class="code" href="c8051F320_8h.html#a8aed186592a64d113e35bc72e2a7237b">USB0ADR</a> &amp; 0x80);           <span class="comment">// Wait for BUSY-&gt;&apos;0&apos; (data ready)</span>
<a name="l01297"></a>01297       }
<a name="l01298"></a>01298    }
<a name="l01299"></a>01299 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ:Rootana by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
