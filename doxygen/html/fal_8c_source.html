<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ:Rootana: midas/src/fal.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>midas/src/fal.c</h1><a href="fal_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Name:         fal.c</span>
<a name="l00004"></a>00004 <span class="comment">  Created by:   Stefan Ritt</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Contents:     Combined Frontend/Analyzer/Logger for Windows NT.</span>
<a name="l00007"></a>00007 <span class="comment">                Most routines are from mfe.c mana.c and mlogger.c.</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">  $Log: fal.c,v $</span>
<a name="l00010"></a>00010 <span class="comment">  Revision 1.2  2005/06/21 00:17:57  mucap</span>
<a name="l00011"></a>00011 <span class="comment">  (Fred)</span>
<a name="l00012"></a>00012 <span class="comment">  Update to compile with gcc 4.0, replacing</span>
<a name="l00013"></a>00013 <span class="comment">                     (char *) pdata += key.item_size * key.num_values;</span>
<a name="l00014"></a>00014 <span class="comment">  with</span>
<a name="l00015"></a>00015 <span class="comment">                     pdata = (char *) pdata + key.item_size * key.num_values;</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">  Revision 1.43  2004/10/01 23:35:53  midas</span>
<a name="l00018"></a>00018 <span class="comment">  Removed PRE/POST transitions and implemented sequence order of transitions</span>
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">  Revision 1.42  2004/05/07 19:40:11  midas</span>
<a name="l00021"></a>00021 <span class="comment">  Replaced min/max by MIN/MAX macros</span>
<a name="l00022"></a>00022 <span class="comment"></span>
<a name="l00023"></a>00023 <span class="comment">  Revision 1.41  2004/01/18 10:10:58  olchansk</span>
<a name="l00024"></a>00024 <span class="comment">  define &quot;f2cFortran&quot; the same way as in mana.c</span>
<a name="l00025"></a>00025 <span class="comment"></span>
<a name="l00026"></a>00026 <span class="comment">  Revision 1.40  2004/01/08 08:40:09  midas</span>
<a name="l00027"></a>00027 <span class="comment">  Implemented standard indentation</span>
<a name="l00028"></a>00028 <span class="comment"></span>
<a name="l00029"></a>00029 <span class="comment">  Revision 1.39  2003/12/12 12:32:13  midas</span>
<a name="l00030"></a>00030 <span class="comment">  Fixed HBOOK compiler warnings</span>
<a name="l00031"></a>00031 <span class="comment"></span>
<a name="l00032"></a>00032 <span class="comment">  Revision 1.38  2003/12/01 07:51:04  midas</span>
<a name="l00033"></a>00033 <span class="comment">  Added extra parameter to cm_cleanup()</span>
<a name="l00034"></a>00034 <span class="comment"></span>
<a name="l00035"></a>00035 <span class="comment">  Revision 1.37  2003/11/14 13:39:08  midas</span>
<a name="l00036"></a>00036 <span class="comment">  Added auto restart to FAL</span>
<a name="l00037"></a>00037 <span class="comment"></span>
<a name="l00038"></a>00038 <span class="comment">  Revision 1.36  2003/05/09 07:40:04  midas</span>
<a name="l00039"></a>00039 <span class="comment">  Added extra parameter to cm_get_environment</span>
<a name="l00040"></a>00040 <span class="comment"></span>
<a name="l00041"></a>00041 <span class="comment">  Revision 1.35  2003/04/25 14:37:43  midas</span>
<a name="l00042"></a>00042 <span class="comment">  Fixed compiler warnings</span>
<a name="l00043"></a>00043 <span class="comment"></span>
<a name="l00044"></a>00044 <span class="comment">  Revision 1.34  2003/04/14 13:32:02  midas</span>
<a name="l00045"></a>00045 <span class="comment">  Updated register_equipment from mfe.c</span>
<a name="l00046"></a>00046 <span class="comment"></span>
<a name="l00047"></a>00047 <span class="comment">  Revision 1.33  2003/02/20 13:46:12  midas</span>
<a name="l00048"></a>00048 <span class="comment">  Fixed bug with RO_ODB</span>
<a name="l00049"></a>00049 <span class="comment"></span>
<a name="l00050"></a>00050 <span class="comment">  Revision 1.32  2003/02/20 13:10:45  midas</span>
<a name="l00051"></a>00051 <span class="comment">  Fixed wrong channel records</span>
<a name="l00052"></a>00052 <span class="comment"></span>
<a name="l00053"></a>00053 <span class="comment">  Revision 1.31  2002/09/17 22:12:25  pierre</span>
<a name="l00054"></a>00054 <span class="comment">  add arg to cm_cleanup</span>
<a name="l00055"></a>00055 <span class="comment"></span>
<a name="l00056"></a>00056 <span class="comment">  Revision 1.30  2002/05/10 05:55:06  pierre</span>
<a name="l00057"></a>00057 <span class="comment">  Added optional debug output to cm_transition</span>
<a name="l00058"></a>00058 <span class="comment"></span>
<a name="l00059"></a>00059 <span class="comment">  Revision 1.29  2002/05/10 05:22:05  pierre</span>
<a name="l00060"></a>00060 <span class="comment">  add MANA_LITE #ifdef</span>
<a name="l00061"></a>00061 <span class="comment"></span>
<a name="l00062"></a>00062 <span class="comment">  Revision 1.28  2002/05/08 19:54:40  midas</span>
<a name="l00063"></a>00063 <span class="comment">  Added extra parameter to function db_get_value()</span>
<a name="l00064"></a>00064 <span class="comment"></span>
<a name="l00065"></a>00065 <span class="comment">  Revision 1.27  2002/02/05 09:46:29  midas</span>
<a name="l00066"></a>00066 <span class="comment">  Set /runinfo/online mode flag</span>
<a name="l00067"></a>00067 <span class="comment"></span>
<a name="l00068"></a>00068 <span class="comment">  Revision 1.26  2002/02/05 01:26:51  midas</span>
<a name="l00069"></a>00069 <span class="comment">  Re-merged common code of logger and fal</span>
<a name="l00070"></a>00070 <span class="comment"></span>
<a name="l00071"></a>00071 <span class="comment">  Revision 1.25  2002/01/16 15:21:38  midas</span>
<a name="l00072"></a>00072 <span class="comment">  Use odb_size from analyzer</span>
<a name="l00073"></a>00073 <span class="comment"></span>
<a name="l00074"></a>00074 <span class="comment">  Revision 1.24  2001/04/10 04:30:38  midas</span>
<a name="l00075"></a>00075 <span class="comment">  Fixed crash when FAL was stopping run in logger part and scaler event had</span>
<a name="l00076"></a>00076 <span class="comment">  zero size.</span>
<a name="l00077"></a>00077 <span class="comment"></span>
<a name="l00078"></a>00078 <span class="comment">  Revision 1.23  2001/01/31 08:00:48  midas</span>
<a name="l00079"></a>00079 <span class="comment">  Copied some modifications from mfe.c</span>
<a name="l00080"></a>00080 <span class="comment"></span>
<a name="l00081"></a>00081 <span class="comment">  Revision 1.22  2001/01/30 09:13:04  midas</span>
<a name="l00082"></a>00082 <span class="comment">  Correct for increased event size</span>
<a name="l00083"></a>00083 <span class="comment"></span>
<a name="l00084"></a>00084 <span class="comment">  Revision 1.21  2000/10/30 10:07:23  midas</span>
<a name="l00085"></a>00085 <span class="comment">  Fixed bug that &quot;always true&quot; test was cleared at the BOR</span>
<a name="l00086"></a>00086 <span class="comment"></span>
<a name="l00087"></a>00087 <span class="comment">  Revision 1.20  2000/10/29 09:35:11  midas</span>
<a name="l00088"></a>00088 <span class="comment">  Added test system from mana.c</span>
<a name="l00089"></a>00089 <span class="comment"></span>
<a name="l00090"></a>00090 <span class="comment">  Revision 1.19  2000/10/23 14:19:06  midas</span>
<a name="l00091"></a>00091 <span class="comment">  Added idle period for slow control equipment</span>
<a name="l00092"></a>00092 <span class="comment"></span>
<a name="l00093"></a>00093 <span class="comment">  Revision 1.18  2000/09/28 13:16:01  midas</span>
<a name="l00094"></a>00094 <span class="comment">  Fixed bug that MANUAL_TRIG only events are not read out during transitions</span>
<a name="l00095"></a>00095 <span class="comment"></span>
<a name="l00096"></a>00096 <span class="comment">  Revision 1.17  2000/09/28 13:02:02  midas</span>
<a name="l00097"></a>00097 <span class="comment">  Added manual triggered events</span>
<a name="l00098"></a>00098 <span class="comment"></span>
<a name="l00099"></a>00099 <span class="comment">  Revision 1.16  2000/08/10 11:37:27  midas</span>
<a name="l00100"></a>00100 <span class="comment">  Made PAW global memory name variable under /analyzer/output/global memeory name</span>
<a name="l00101"></a>00101 <span class="comment">  to run more than one online analyzer instance on one machine</span>
<a name="l00102"></a>00102 <span class="comment"></span>
<a name="l00103"></a>00103 <span class="comment">  Revision 1.15  1999/10/18 14:46:04  midas</span>
<a name="l00104"></a>00104 <span class="comment">  fixed compiler warning</span>
<a name="l00105"></a>00105 <span class="comment"></span>
<a name="l00106"></a>00106 <span class="comment">  Revision 1.14  1999/10/18 14:41:50  midas</span>
<a name="l00107"></a>00107 <span class="comment">  Use /programs/&lt;name&gt;/Watchdog timeout in all programs as timeout value. The</span>
<a name="l00108"></a>00108 <span class="comment">  default value can be submitted by calling cm_connect_experiment1(..., timeout)</span>
<a name="l00109"></a>00109 <span class="comment"></span>
<a name="l00110"></a>00110 <span class="comment">  Revision 1.13  1999/09/23 12:45:48  midas</span>
<a name="l00111"></a>00111 <span class="comment">  Added 32 bit banks</span>
<a name="l00112"></a>00112 <span class="comment"></span>
<a name="l00113"></a>00113 <span class="comment">  Revision 1.12  1999/06/23 09:31:18  midas</span>
<a name="l00114"></a>00114 <span class="comment">  Modified error message</span>
<a name="l00115"></a>00115 <span class="comment"></span>
<a name="l00116"></a>00116 <span class="comment">  Revision 1.11  1999/02/22 11:55:20  midas</span>
<a name="l00117"></a>00117 <span class="comment">  Fixed bug with rebooking of N-tuples</span>
<a name="l00118"></a>00118 <span class="comment"></span>
<a name="l00119"></a>00119 <span class="comment">  Revision 1.10  1999/02/22 11:04:00  midas</span>
<a name="l00120"></a>00120 <span class="comment">  Fixed second bug with ss_getchar()</span>
<a name="l00121"></a>00121 <span class="comment"></span>
<a name="l00122"></a>00122 <span class="comment">  Revision 1.9  1999/02/22 11:01:39  midas</span>
<a name="l00123"></a>00123 <span class="comment">  Fixed bug with ss_getchar()</span>
<a name="l00124"></a>00124 <span class="comment"></span>
<a name="l00125"></a>00125 <span class="comment">  Revision 1.8  1999/02/22 08:00:03  midas</span>
<a name="l00126"></a>00126 <span class="comment">  Made FAL stop with &quot;!&quot; work under Linux</span>
<a name="l00127"></a>00127 <span class="comment"></span>
<a name="l00128"></a>00128 <span class="comment">  Revision 1.7  1999/02/12 11:50:44  midas</span>
<a name="l00129"></a>00129 <span class="comment">  Fixed bug that analyzer statistics didn&apos;t get cleared at the beginning</span>
<a name="l00130"></a>00130 <span class="comment">  of a new run.</span>
<a name="l00131"></a>00131 <span class="comment"></span>
<a name="l00132"></a>00132 <span class="comment">  Revision 1.6  1999/01/19 12:42:57  midas</span>
<a name="l00133"></a>00133 <span class="comment">  - equipment is registered before analyzer modules are initialized</span>
<a name="l00134"></a>00134 <span class="comment">  - N-tuples are not booked if buffer size is zero in analyzer_request</span>
<a name="l00135"></a>00135 <span class="comment"></span>
<a name="l00136"></a>00136 <span class="comment">  Revision 1.5  1999/01/15 12:55:03  midas</span>
<a name="l00137"></a>00137 <span class="comment">  Set /Analyzer/Bank switches/... to FALSE by default to avoid N-tuple</span>
<a name="l00138"></a>00138 <span class="comment">  overflow when an fal is started the first time</span>
<a name="l00139"></a>00139 <span class="comment"></span>
<a name="l00140"></a>00140 <span class="comment">  Revision 1.4  1998/11/09 09:15:12  midas</span>
<a name="l00141"></a>00141 <span class="comment">  Merged new code from mana.c, mlogger.c and mfe.c</span>
<a name="l00142"></a>00142 <span class="comment"></span>
<a name="l00143"></a>00143 <span class="comment">  Revision 1.3  1998/10/12 12:19:01  midas</span>
<a name="l00144"></a>00144 <span class="comment">  Added Log tag in header</span>
<a name="l00145"></a>00145 <span class="comment"></span>
<a name="l00146"></a>00146 <span class="comment"></span>
<a name="l00147"></a>00147 <span class="comment">\********************************************************************/</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<a name="l00150"></a>00150 <span class="preprocessor">#include &quot;<a class="code" href="msystem_8h.html">msystem.h</a>&quot;</span>
<a name="l00151"></a>00151 <span class="preprocessor">#include &quot;<a class="code" href="hardware_8h.html">hardware.h</a>&quot;</span>
<a name="l00152"></a>00152 <span class="preprocessor">#include &quot;<a class="code" href="ftplib_8h.html">ftplib.h</a>&quot;</span>
<a name="l00153"></a>00153 <span class="preprocessor">#include &quot;<a class="code" href="mcstd_8h.html">mcstd.h</a>&quot;</span>
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="fal_8c.html#a1282350055c93cd30b4bbc8752a2a2f7">00155</a> <span class="preprocessor">#define INCLUDE_LOGGING</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="ybos_8h.html">ybos.h</a>&quot;</span>
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="comment">/* cernlib includes */</span>
<a name="l00159"></a>00159 <span class="preprocessor">#ifdef OS_WINNT</span>
<a name="l00160"></a>00160 <span class="preprocessor"></span><span class="preprocessor">#define VISUAL_CPLUSPLUS</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span>
<a name="l00163"></a>00163 <span class="preprocessor">#ifdef OS_LINUX</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span><span class="preprocessor">#define f2cFortran</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="preprocessor">#ifndef MANA_LITE</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="cfortran_8h.html">cfortran.h</a>&gt;</span>
<a name="l00170"></a>00170 <span class="preprocessor">#include &lt;<a class="code" href="hbook_8h.html">hbook.h</a>&gt;</span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 <span class="comment">/* missing in hbook.h */</span>
<a name="l00173"></a>00173 <span class="preprocessor">#ifndef HFNOV</span>
<a name="l00174"></a><a class="code" href="fal_8c.html#a9284066018f8d23f887b0f407b9a1442">00174</a> <span class="preprocessor"></span><span class="preprocessor">#define HFNOV(A1,A2)  CCALLSFSUB2(HFNOV,hfnov,INT,FLOATV,A1,A2)</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span><span class="preprocessor">#endif                          // MANA_LITE</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="comment">/*---- globals -----------------------------------------------------*/</span>
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="fal_8c.html#abd5a2dd502f54be76482800708127217">00179</a> <span class="preprocessor">#define FAL_MAIN</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>
<a name="l00181"></a><a class="code" href="fal_8c.html#a0340d599df75b94d3f5bccc27ce8719d">00181</a> <span class="preprocessor">#define LOGGER_TIMEOUT      60000</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>
<a name="l00183"></a><a class="code" href="fal_8c.html#a022c39e327f494dda3664f8888f860f1">00183</a> <span class="preprocessor">#define SERVER_CACHE_SIZE  100000       </span><span class="comment">/* event cache before buffer */</span>
<a name="l00184"></a>00184 
<a name="l00185"></a><a class="code" href="fal_8c.html#a380a50d445745c2da54a29a1f2e5099e">00185</a> <span class="preprocessor">#define ODB_UPDATE_TIME      1000       </span><span class="comment">/* 1 seconds for ODB update */</span>
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="fal_8c.html#ac69ee46f4a51ed14f0d68628c2dec71d">00187</a> <span class="preprocessor">#define MAX_CHANNELS 10</span>
<a name="l00188"></a><a class="code" href="fal_8c.html#ae42954bb8545d24e3e9dcde5920c9a0b">00188</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_EVENTS   10</span>
<a name="l00189"></a><a class="code" href="fal_8c.html#abf8d8994f09509f9e061f5bf82daf4cd">00189</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_HISTORY  20</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span>
<a name="l00191"></a><a class="code" href="fal_8c.html#a9909e4be3ffcc1cc3f2076aaaa7629b0">00191</a> <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a9909e4be3ffcc1cc3f2076aaaa7629b0">fal_name</a> = <span class="stringliteral">&quot;FAL&quot;</span>;
<a name="l00192"></a>00192 
<a name="l00193"></a><a class="code" href="fal_8c.html#a9176ec250a555fff7c2a03cb3d2391c6">00193</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#a9176ec250a555fff7c2a03cb3d2391c6">in_stop_transition</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00194"></a><a class="code" href="fal_8c.html#aa20498ce5452912047a5b0a50453c8fb">00194</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00195"></a><a class="code" href="fal_8c.html#a93ff70131906aede2a2802753ec682ef">00195</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#a93ff70131906aede2a2802753ec682ef">tape_message</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00196"></a>00196 
<a name="l00197"></a><a class="code" href="fal_8c.html#a8ea83d33fedda2dd07beb422f245354b">00197</a> <a class="code" href="structLOG__CHN.html">LOG_CHN</a> <a class="code" href="fal_8c.html#a8ea83d33fedda2dd07beb422f245354b">log_chn</a>[<a class="code" href="evb_2mevb_8h.html#ac69ee46f4a51ed14f0d68628c2dec71d">MAX_CHANNELS</a>];
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="keyword">struct </span>{
<a name="l00200"></a><a class="code" href="fal_8c.html#aff774cc3164dec02768f4104c5466c61">00200</a>    <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l00201"></a><a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">00201</a>    <span class="keywordtype">void</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>;
<a name="l00202"></a><a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">00202</a>    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>;
<a name="l00203"></a><a class="code" href="fal_8c.html#a93d13d4a80b9fb8ab8d7e9cbec8f99e9">00203</a>    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="fal_8c.html#a93d13d4a80b9fb8ab8d7e9cbec8f99e9">hKeyVar</a>;
<a name="l00204"></a><a class="code" href="fal_8c.html#aa774945e642ada0ff3e539dc76863dff">00204</a>    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="fal_8c.html#aa774945e642ada0ff3e539dc76863dff">period</a>;
<a name="l00205"></a><a class="code" href="fal_8c.html#add96ecae43fa55c909fd3dcad0b0a8b1">00205</a>    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="fal_8c.html#add96ecae43fa55c909fd3dcad0b0a8b1">last_log</a>;
<a name="l00206"></a>00206 } <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[<a class="code" href="cmdedit_8c.html#abf8d8994f09509f9e061f5bf82daf4cd">MAX_HISTORY</a>];
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="fal_8c.html#a81f01ccafac403262a2e430c118516a3">00208</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>;                  <span class="comment">/* STATE_RUNNING, STATE_STOPPED, STATE_PAUSED */</span>
<a name="l00209"></a><a class="code" href="fal_8c.html#a7515080fe161c8c4d6029c889f02564a">00209</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>;
<a name="l00210"></a><a class="code" href="fal_8c.html#a6431147bd66aebfe3ca728d244da1253">00210</a> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;              <span class="comment">/* current time in seconds since 1970 */</span>
<a name="l00211"></a><a class="code" href="fal_8c.html#a74876f64e556e153bb8cce6dfddce810">00211</a> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;         <span class="comment">/* current time in milliseconds */</span>
<a name="l00212"></a><a class="code" href="fal_8c.html#a261367aeac0e93b82cc0483c546d1fec">00212</a> <span class="keywordtype">char</span> <a class="code" href="consume_8c.html#a881e3cadecfb2fe6d53b7e33e74ac6d2">event_buffer</a>[<a class="code" href="group__msystemincludecode.html#ga7554d698d310e57e1c933a8f952a4bf8">NET_BUFFER_SIZE</a>];
<a name="l00213"></a><a class="code" href="fal_8c.html#af65cc3664520b7cd0817adc7106f9624">00213</a> <span class="keywordtype">char</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[<a class="code" href="group__midasincludecode.html#ga2010c9ed4ef21c3171de778157b9c494">HOST_NAME_LENGTH</a>];
<a name="l00214"></a><a class="code" href="fal_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">00214</a> <span class="keywordtype">char</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>];
<a name="l00215"></a><a class="code" href="fal_8c.html#ab1f60c53f74e806a3b9f687af38d7421">00215</a> <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="comment">/* output file information, maps to /&lt;analyzer&gt;/Output */</span>
<a name="l00218"></a>00218 <span class="keyword">struct </span>{
<a name="l00219"></a><a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">00219</a>    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>[256];
<a name="l00220"></a><a class="code" href="fal_8c.html#ae9487d607449dedf95bca2636c33b5d3">00220</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#ae9487d607449dedf95bca2636c33b5d3">rwnt</a>;
<a name="l00221"></a><a class="code" href="fal_8c.html#a6cddf80902f55138cf944ed06cbcbd61">00221</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#a6cddf80902f55138cf944ed06cbcbd61">histo_dump</a>;
<a name="l00222"></a><a class="code" href="fal_8c.html#a81e1be5cc336f24597a82cfa087c1ac3">00222</a>    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a81e1be5cc336f24597a82cfa087c1ac3">histo_dump_filename</a>[256];
<a name="l00223"></a><a class="code" href="fal_8c.html#a4439d57afe08d556f78e4b0ba490c79a">00223</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#a4439d57afe08d556f78e4b0ba490c79a">clear_histos</a>;
<a name="l00224"></a><a class="code" href="fal_8c.html#aa43b224cec5b9bf4a8feb7fd364b9a7f">00224</a>    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#aa43b224cec5b9bf4a8feb7fd364b9a7f">last_histo_filename</a>[256];
<a name="l00225"></a><a class="code" href="fal_8c.html#af68e872de565f722d84950f339b26cb9">00225</a>    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="fal_8c.html#af68e872de565f722d84950f339b26cb9">events_to_odb</a>;
<a name="l00226"></a><a class="code" href="fal_8c.html#a52bbe25f799ffa103a99650e3abd4e5e">00226</a>    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a52bbe25f799ffa103a99650e3abd4e5e">global_memory_name</a>[8];
<a name="l00227"></a>00227 } <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 <span class="comment">/* paw common memory */</span>
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 <span class="preprocessor">#ifdef extname</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span><span class="keywordtype">int</span> *pawc_;
<a name="l00233"></a>00233 <span class="keywordtype">int</span> quest_[100];
<a name="l00234"></a>00234 <span class="preprocessor">#else</span>
<a name="l00235"></a><a class="code" href="fal_8c.html#a073154bff951cdb430165ea981672695">00235</a> <span class="preprocessor"></span><span class="keywordtype">int</span> *<a class="code" href="fal_8c.html#a073154bff951cdb430165ea981672695">PAWC</a>;
<a name="l00236"></a>00236 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="fal_8c.html#a54e2499cfb7a66c138ef6c0e1b4714f4">QUEST</a>[100];
<a name="l00237"></a>00237 <span class="preprocessor">#endif</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span>
<a name="l00239"></a><a class="code" href="fal_8c.html#a7fce5fc9af5702ff4cbc3f25bde32347">00239</a> <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a7fce5fc9af5702ff4cbc3f25bde32347">bstr</a> = <span class="stringliteral">&quot; &quot;</span>;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="comment">/*---- ODB records -------------------------------------------------*/</span>
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <a class="code" href="group__msystemincludecode.html#ga97f1d135b2ff1e6deab00c4a8b2945fa">CHN_SETTINGS_STR</a>(chn_settings_str);
<a name="l00244"></a>00244 
<a name="l00245"></a><a class="code" href="fal_8c.html#ac92b30327caaa939b1b6630775c78ecd">00245</a> <span class="preprocessor">#define EQUIPMENT_COMMON_STR &quot;\</span>
<a name="l00246"></a>00246 <span class="preprocessor">Event ID = WORD : 0\n\</span>
<a name="l00247"></a>00247 <span class="preprocessor">Trigger mask = WORD : 0\n\</span>
<a name="l00248"></a>00248 <span class="preprocessor">Buffer = STRING : [32] SYSTEM\n\</span>
<a name="l00249"></a>00249 <span class="preprocessor">Type = INT : 0\n\</span>
<a name="l00250"></a>00250 <span class="preprocessor">Source = INT : 0\n\</span>
<a name="l00251"></a>00251 <span class="preprocessor">Format = STRING : [8] FIXED\n\</span>
<a name="l00252"></a>00252 <span class="preprocessor">Enabled = BOOL : 0\n\</span>
<a name="l00253"></a>00253 <span class="preprocessor">Read on = INT : 0\n\</span>
<a name="l00254"></a>00254 <span class="preprocessor">Period = INT : 0\n\</span>
<a name="l00255"></a>00255 <span class="preprocessor">Event limit = DOUBLE : 0\n\</span>
<a name="l00256"></a>00256 <span class="preprocessor">Num subevents = DWORD : 0\n\</span>
<a name="l00257"></a>00257 <span class="preprocessor">Log history = INT : 0\n\</span>
<a name="l00258"></a>00258 <span class="preprocessor">Frontend host = STRING : [32] \n\</span>
<a name="l00259"></a>00259 <span class="preprocessor">Frontend name = STRING : [32] \n\</span>
<a name="l00260"></a>00260 <span class="preprocessor">Frontend file name = STRING : [256] \n\</span>
<a name="l00261"></a>00261 <span class="preprocessor">&quot;</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span>
<a name="l00263"></a><a class="code" href="fal_8c.html#a6064db0cc46885d207cedb497e3c355e">00263</a> <span class="preprocessor">#define EQUIPMENT_STATISTICS_STR &quot;\</span>
<a name="l00264"></a>00264 <span class="preprocessor">Events sent = DOUBLE : 0\n\</span>
<a name="l00265"></a>00265 <span class="preprocessor">Events per sec. = DOUBLE : 0\n\</span>
<a name="l00266"></a>00266 <span class="preprocessor">kBytes per sec. = DOUBLE : 0\n\</span>
<a name="l00267"></a>00267 <span class="preprocessor">&quot;</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>
<a name="l00269"></a><a class="code" href="fal_8c.html#a9b830b651a8c873d619d16eb495097af">00269</a> <span class="preprocessor">#define ANALYZER_REQUEST_STR &quot;\</span>
<a name="l00270"></a>00270 <span class="preprocessor">Event ID = INT : 0\n\</span>
<a name="l00271"></a>00271 <span class="preprocessor">Trigger mask = INT : -1\n\</span>
<a name="l00272"></a>00272 <span class="preprocessor">Sampling type = INT : 1\n\</span>
<a name="l00273"></a>00273 <span class="preprocessor">Buffer = STRING : [32] SYSTEM\n\</span>
<a name="l00274"></a>00274 <span class="preprocessor">Enabled = BOOL : 1\n\</span>
<a name="l00275"></a>00275 <span class="preprocessor">Client name = STRING : [32] \n\</span>
<a name="l00276"></a>00276 <span class="preprocessor">Host = STRING : [32] \n\</span>
<a name="l00277"></a>00277 <span class="preprocessor">&quot;</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span>
<a name="l00279"></a><a class="code" href="fal_8c.html#a407acb59ee878974632978f7682e8d23">00279</a> <span class="preprocessor">#define ANALYZER_STATS_STR &quot;\</span>
<a name="l00280"></a>00280 <span class="preprocessor">Events received = DOUBLE : 0\n\</span>
<a name="l00281"></a>00281 <span class="preprocessor">Events per sec. = DOUBLE : 0\n\</span>
<a name="l00282"></a>00282 <span class="preprocessor">Events written = DOUBLE : 0\n\</span>
<a name="l00283"></a>00283 <span class="preprocessor">&quot;</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>
<a name="l00285"></a><a class="code" href="fal_8c.html#a7c5689a91d273a5acdde5b6d6fd2a0b0">00285</a> <span class="preprocessor">#define OUT_INFO_STR &quot;\</span>
<a name="l00286"></a>00286 <span class="preprocessor">Filename = STRING : [256] run%05d.asc\n\</span>
<a name="l00287"></a>00287 <span class="preprocessor">RWNT = BOOL : 0\n\</span>
<a name="l00288"></a>00288 <span class="preprocessor">Histo Dump = BOOL : 0\n\</span>
<a name="l00289"></a>00289 <span class="preprocessor">Histo Dump Filename = STRING : [256] his%05d.rz\n\</span>
<a name="l00290"></a>00290 <span class="preprocessor">Clear histos = BOOL : 1\n\</span>
<a name="l00291"></a>00291 <span class="preprocessor">Last Histo Filename = STRING : [256] last.rz\n\</span>
<a name="l00292"></a>00292 <span class="preprocessor">Events to ODB = BOOL : 0\n\</span>
<a name="l00293"></a>00293 <span class="preprocessor">Global Memory Name = STRING : [8] ONLN\n\</span>
<a name="l00294"></a>00294 <span class="preprocessor">&quot;</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span>
<a name="l00296"></a>00296 <span class="comment">/*---- data structures for MIDAS format ----------------------------*/</span>
<a name="l00297"></a>00297 
<a name="l00298"></a><a class="code" href="structMIDAS__INFO.html">00298</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00299"></a><a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">00299</a>    <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>;
<a name="l00300"></a><a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">00300</a>    <span class="keywordtype">char</span> *write_pointer;
<a name="l00301"></a>00301 } <a class="code" href="structMIDAS__INFO.html">MIDAS_INFO</a>;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 <span class="comment">/*---- declarations ------------------------------------------------*/</span>
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 <span class="comment">/* forward declarations */</span>
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">send_event</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>);
<a name="l00308"></a>00308 <span class="keywordtype">void</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> binit);
<a name="l00309"></a>00309 <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#aed2a9a6c57de716dc564331cca8f0a85">transition</a>);
<a name="l00310"></a>00310 <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a54200266ef010a58dcf76468aadace0b">receive_event</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="minife_8c.html#ae7ddc6297773b75bea52d05c7a3ff5e5">hBuf</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> request_id, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent);
<a name="l00311"></a>00311 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#ab757112cc906644f8c9d86fc41627951">log_write</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent);
<a name="l00312"></a>00312 <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a5c2e39bc0d4c7f4d2a6dfdcf70fd2f03">log_system_history</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="keywordtype">void</span> *info);
<a name="l00313"></a>00313 <span class="keywordtype">int</span> <a class="code" href="fal_8c.html#a48fa208044b7e1373af57d1b24393693">print_message</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *msg);
<a name="l00314"></a>00314 <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l00315"></a>00315 <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">interrupt_routine</a>(<span class="keywordtype">void</span>);
<a name="l00316"></a>00316 <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>);
<a name="l00317"></a>00317 <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a18ebb4a9430249867c5ec3f4aca0ea40">tr_start2</a>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, error);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="comment">/* items defined in frontend.c */</span>
<a name="l00320"></a>00320 
<a name="l00321"></a>00321 <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="crate3_2crate_8cpp.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>;
<a name="l00322"></a>00322 <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="crate3_2crate_8cpp.html#aa045f89d0b0691cb1d05174b13369750">frontend_file_name</a>;
<a name="l00323"></a>00323 <span class="keyword">extern</span> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate3_2crate_8cpp.html#a0215c0a842a0e97fe65c7ef5fb7633a5">frontend_call_loop</a>;
<a name="l00324"></a><a class="code" href="fal_8c.html#ac7fc683b5a25d9607abc270a54db6d97">00324</a> <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="crate3_2crate_8cpp.html#aa045f89d0b0691cb1d05174b13369750">frontend_file_name</a>;
<a name="l00325"></a>00325 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>;
<a name="l00326"></a>00326 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#a34c51ae8c88f4717087b0604975516f4">frontend_init</a>(<span class="keywordtype">void</span>);
<a name="l00327"></a>00327 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#a15271255cca6c92978b28afd5a548382">frontend_exit</a>(<span class="keywordtype">void</span>);
<a name="l00328"></a>00328 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#ada66837c3c3d263974ad717921145e0a">frontend_loop</a>(<span class="keywordtype">void</span>);
<a name="l00329"></a>00329 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#ad8bfe703c49342b9f0275aba77dc7758">begin_of_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00330"></a>00330 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#ae6d798649008b7523c77222bae2d4187">end_of_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00331"></a>00331 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#ac13d5e945d03bd84233e479cad2d892a">pause_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00332"></a>00332 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#a392520a13432f29f450f40456e26960f">resume_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00333"></a>00333 <span class="keyword">extern</span> <a class="code" href="structeqpmnt.html">EQUIPMENT</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#ae8b8f6d8b9bae4600c7eac6eee4e57b4">equipment</a>[];
<a name="l00334"></a>00334 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> source, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>, <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="sis3803_8c.html#a8fa8e4c8bef10b038f6a033f736d5bce">test</a>);
<a name="l00335"></a>00335 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> source, <a class="code" href="group__midasincludecode.html#ga790216a8e71233fed28657b16a052e36">PTYPE</a> adr);
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 <span class="comment">/* items defined in analyzer.c */</span>
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a145953d65e4f33a2308075f26c13bfbe">pawc_size</a>;
<a name="l00340"></a>00340 <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>;
<a name="l00341"></a>00341 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a8fd380b49c2d273b54ec6a6fb077d760">analyzer_loop_period</a>;
<a name="l00342"></a>00342 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#afeea792d4dbe0001bd025397e494ab5b">analyzer_init</a>(<span class="keywordtype">void</span>);
<a name="l00343"></a>00343 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a7738840c25fb678186362479850b4df6">analyzer_exit</a>(<span class="keywordtype">void</span>);
<a name="l00344"></a>00344 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a7173b35a859f0740c437df5f68ccf80b">analyzer_loop</a>(<span class="keywordtype">void</span>);
<a name="l00345"></a>00345 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a22c6bd312e4f7ffd79162e64835cfd42">ana_begin_of_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00346"></a>00346 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a8e03cbe2637bd6f4488a659c9f23d29e">ana_end_of_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00347"></a>00347 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a86f2bc78d542107ce023a1d54f79b13e">ana_pause_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00348"></a>00348 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a35f57e1efbd308b1ca049035dcdc13f6">ana_resume_run</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00349"></a>00349 <span class="keyword">extern</span> <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> <a class="code" href="analyzer_8cpp.html#ab1be3d7f64edcbf386bfd220bc7bda9b">analyze_request</a>[];
<a name="l00350"></a>00350 <span class="keyword">extern</span> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="analyzer_8cpp.html#a7503268889a084b74a968787ffc025b7">odb_size</a>;
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="fal_8c.html#ae08e1d173902a2cb83c58d268c6e4d3e">00352</a> <a class="code" href="structeqpmnt.html">EQUIPMENT</a> *<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ae08e1d173902a2cb83c58d268c6e4d3e">interrupt_eq</a> = NULL;
<a name="l00353"></a><a class="code" href="fal_8c.html#a60722870df369344fb7ad351892998ab">00353</a> <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a60722870df369344fb7ad351892998ab">interrupt_odb_buffer</a>;
<a name="l00354"></a><a class="code" href="fal_8c.html#aadf15a6e815e15b52fe5680277483e63">00354</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aadf15a6e815e15b52fe5680277483e63">interrupt_odb_buffer_valid</a>;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="comment">/*---- Logging routines --------------------------------------------*/</span>
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="comment">/*== common code FAL/MLOGGER start =================================*/</span>
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="comment">/*---- Logging initialization --------------------------------------*/</span>
<a name="l00361"></a>00361 
<a name="l00362"></a><a class="code" href="fal_8c.html#acca02da5a5a8b842893ecc30ea12fda7">00362</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#acca02da5a5a8b842893ecc30ea12fda7">logger_init</a>()
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00365"></a>00365    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l00366"></a>00366    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l00367"></a>00367    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   <span class="comment">/*---- create /logger entries -----*/</span>
<a name="l00370"></a>00370 
<a name="l00371"></a>00371    <a class="code" href="group__msystemincludecode.html#gaff1f5191745f690b43b30394ee9b206e">cm_get_path</a>(str);
<a name="l00372"></a>00372    size = <span class="keyword">sizeof</span>(str);
<a name="l00373"></a>00373    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Data dir&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375    strcpy(str, <span class="stringliteral">&quot;midas.log&quot;</span>);
<a name="l00376"></a>00376    size = <span class="keyword">sizeof</span>(str);
<a name="l00377"></a>00377    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Message file&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00378"></a>00378 
<a name="l00379"></a>00379    size = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l00380"></a>00380    flag = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00381"></a>00381    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Write data&quot;</span>, &amp;flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383    flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00384"></a>00384    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/ODB Dump&quot;</span>, &amp;flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386    strcpy(str, <span class="stringliteral">&quot;run%05d.odb&quot;</span>);
<a name="l00387"></a>00387    size = <span class="keyword">sizeof</span>(str);
<a name="l00388"></a>00388    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/ODB Dump File&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390    flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00391"></a>00391    size = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l00392"></a>00392    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Auto restart&quot;</span>, &amp;flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394    flag = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00395"></a>00395    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Tape message&quot;</span>, &amp;flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397    <span class="comment">/* create at least one logging channel */</span>
<a name="l00398"></a>00398    status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Channels/0&quot;</span>, &amp;hKey);
<a name="l00399"></a>00399    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00400"></a>00400       <span class="comment">/* if no channels are defined, define at least one */</span>
<a name="l00401"></a>00401       status = <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Channels/0&quot;</span>, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(chn_settings_str));
<a name="l00402"></a>00402       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00403"></a>00403          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;logger_init&quot;</span>, <span class="stringliteral">&quot;Cannot create channel entry in database&quot;</span>);
<a name="l00404"></a>00404    }
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="comment">/*---- ODB dump routine --------------------------------------------*/</span>
<a name="l00408"></a>00408 
<a name="l00409"></a><a class="code" href="fal_8c.html#a3b7aaa44f801314545e68f1b09c5a0c4">00409</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a3b7aaa44f801314545e68f1b09c5a0c4">log_odb_dump</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l00412"></a>00412    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414    <span class="comment">/* write ODB dump */</span>
<a name="l00415"></a>00415    buffer_size = 10000;
<a name="l00416"></a>00416    <span class="keywordflow">do</span> {
<a name="l00417"></a>00417       pevent = malloc(buffer_size);
<a name="l00418"></a>00418       <span class="keywordflow">if</span> (pevent == NULL) {
<a name="l00419"></a>00419          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;log_odb_dump&quot;</span>, <span class="stringliteral">&quot;Cannot allocate ODB dump buffer&quot;</span>);
<a name="l00420"></a>00420          <span class="keywordflow">break</span>;
<a name="l00421"></a>00421       }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423       size = buffer_size - <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l00424"></a>00424       status = <a class="code" href="group__msectionh.html#ga1f263dc34a043b1a1189ff3c72dc6e5c">db_copy</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, (<span class="keywordtype">char</span> *) (pevent + 1), &amp;size, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00425"></a>00425       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#gaf7d81a3217ef14ed73f3089f51584bd9">DB_TRUNCATED</a>) {
<a name="l00426"></a>00426          <a class="code" href="group__msectionh.html#ga2cdd90a4b2def271ad89cc0d308bb970">bm_compose_event</a>(pevent, event_id, <a class="code" href="group__mbufferh.html#ga028a14f85456b68bf2babd1bdcaa1abb">MIDAS_MAGIC</a>,
<a name="l00427"></a>00427                           buffer_size - <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) - size + 1, run_number);
<a name="l00428"></a>00428          <a class="code" href="fal_8c.html#ab757112cc906644f8c9d86fc41627951">log_write</a>(log_chn, pevent);
<a name="l00429"></a>00429          free(pevent);
<a name="l00430"></a>00430          <span class="keywordflow">break</span>;
<a name="l00431"></a>00431       }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433       <span class="comment">/* increase buffer size if truncated */</span>
<a name="l00434"></a>00434       free(pevent);
<a name="l00435"></a>00435       buffer_size *= 2;
<a name="l00436"></a>00436    } <span class="keywordflow">while</span> (1);
<a name="l00437"></a>00437 }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 <span class="comment">/*---- ODB save routine --------------------------------------------*/</span>
<a name="l00440"></a>00440 
<a name="l00441"></a><a class="code" href="fal_8c.html#acf9c7de88cba31c73350482f73f50253">00441</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#acf9c7de88cba31c73350482f73f50253">odb_save</a>(<span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>)
<a name="l00442"></a>00442 {
<a name="l00443"></a>00443    <span class="keywordtype">int</span> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l00444"></a>00444    <span class="keywordtype">char</span> dir[256];
<a name="l00445"></a>00445    <span class="keywordtype">char</span> path[256];
<a name="l00446"></a>00446 
<a name="l00447"></a>00447    <span class="keywordflow">if</span> (strchr(filename, <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>) == NULL) {
<a name="l00448"></a>00448       size = <span class="keyword">sizeof</span>(dir);
<a name="l00449"></a>00449       dir[0] = 0;
<a name="l00450"></a>00450       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Data Dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00451"></a>00451       <span class="keywordflow">if</span> (dir[0] != 0)
<a name="l00452"></a>00452          <span class="keywordflow">if</span> (dir[strlen(dir) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l00453"></a>00453             strcat(dir, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l00454"></a>00454       strcpy(path, dir);
<a name="l00455"></a>00455       strcat(path, filename);
<a name="l00456"></a>00456    } <span class="keywordflow">else</span>
<a name="l00457"></a>00457       strcpy(path, filename);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459    <a class="code" href="group__msectionh.html#gae875429ee4761ff043d26882cd48d251">db_save</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, path, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="comment">/*---- open tape and check for data --------------------------------*/</span>
<a name="l00463"></a>00463 
<a name="l00464"></a><a class="code" href="fal_8c.html#af3cabceb8b0fa7c888cebccd87848ad5">00464</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#af3cabceb8b0fa7c888cebccd87848ad5">tape_open</a>(<span class="keywordtype">char</span> *<a class="code" href="vmedrv_8c.html#a8910285a0352a5c710e65ec9ecbe32a1">dev</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> * <a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>)
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>;
<a name="l00467"></a>00467    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>[16];
<a name="l00468"></a>00468 
<a name="l00469"></a>00469    status = <a class="code" href="group__msectionh.html#gad5ba805f539d5dd8d3248cf52ec6b510">ss_tape_open</a>(dev, O_RDWR | O_CREAT | O_TRUNC, handle);
<a name="l00470"></a>00470    <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>)
<a name="l00471"></a>00471       <span class="keywordflow">return</span> status;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473    <span class="comment">/* check if tape contains data */</span>
<a name="l00474"></a>00474    count = <span class="keyword">sizeof</span>(buffer);
<a name="l00475"></a>00475    status = <a class="code" href="group__msectionh.html#ga942616863f637536946e78d48a1437c2">ss_tape_read</a>(*handle, buffer, &amp;count);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477    <span class="keywordflow">if</span> (count == <span class="keyword">sizeof</span>(buffer)) {
<a name="l00478"></a>00478       <span class="comment">/* tape contains data -&gt; don&apos;t start */</span>
<a name="l00479"></a>00479       <a class="code" href="group__msectionh.html#ga2755c65a3d2db59505b11be63ea12afe">ss_tape_rskip</a>(*handle, -1);
<a name="l00480"></a>00480       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;tape_open&quot;</span>,
<a name="l00481"></a>00481              <span class="stringliteral">&quot;Tape contains data, please spool tape with &apos;mtape seod&apos;&quot;</span>);
<a name="l00482"></a>00482       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;tape_open&quot;</span>,
<a name="l00483"></a>00483              <span class="stringliteral">&quot;or erase it with &apos;mtape weof&apos;, &apos;mtape rewind&apos;, then try again.&quot;</span>);
<a name="l00484"></a>00484       <a class="code" href="group__msectionh.html#ga4a9420e0e9ef8bd23b41f7594bad7395">ss_tape_close</a>(*handle);
<a name="l00485"></a>00485       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga1271b2092f57a1f2eab374deb5aa20e0">SS_TAPE_ERROR</a>;
<a name="l00486"></a>00486    }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="comment">/*---- open FTP channel --------------------------------------------*/</span>
<a name="l00492"></a>00492 
<a name="l00493"></a><a class="code" href="fal_8c.html#aad549393783e1d5d91203fb4143bb1e4">00493</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#aad549393783e1d5d91203fb4143bb1e4">ftp_error</a>(<span class="keywordtype">char</span> *<a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>)
<a name="l00494"></a>00494 {
<a name="l00495"></a>00495    <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;ftp_error&quot;</span>, message);
<a name="l00496"></a>00496    <span class="keywordflow">return</span> 1;
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 
<a name="l00499"></a><a class="code" href="fal_8c.html#a63504313b744b5dcd8b3fdc5058696b4">00499</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a63504313b744b5dcd8b3fdc5058696b4">ftp_open</a>(<span class="keywordtype">char</span> *destination, <a class="code" href="structFTP__CON.html">FTP_CON</a> ** con)
<a name="l00500"></a>00500 {
<a name="l00501"></a>00501    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00502"></a>00502    <span class="keywordtype">short</span> port = 0;
<a name="l00503"></a>00503    <span class="keywordtype">char</span> *token, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[<a class="code" href="group__midasincludecode.html#ga2010c9ed4ef21c3171de778157b9c494">HOST_NAME_LENGTH</a>],
<a name="l00504"></a>00504        user[32], pass[32], directory[256], <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256];
<a name="l00505"></a>00505 
<a name="l00506"></a>00506    <span class="comment">/*</span>
<a name="l00507"></a>00507 <span class="comment">      destination should have the form:</span>
<a name="l00508"></a>00508 <span class="comment">      host, port, user, password, directory, run%05d.mid</span>
<a name="l00509"></a>00509 <span class="comment">    */</span>
<a name="l00510"></a>00510 
<a name="l00511"></a>00511    <span class="comment">/* break destination in components */</span>
<a name="l00512"></a>00512    token = strtok(destination, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l00513"></a>00513    <span class="keywordflow">if</span> (token)
<a name="l00514"></a>00514       strcpy(host_name, token);
<a name="l00515"></a>00515 
<a name="l00516"></a>00516    token = strtok(NULL, <span class="stringliteral">&quot;, &quot;</span>);
<a name="l00517"></a>00517    <span class="keywordflow">if</span> (token)
<a name="l00518"></a>00518       port = atoi(token);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520    token = strtok(NULL, <span class="stringliteral">&quot;, &quot;</span>);
<a name="l00521"></a>00521    <span class="keywordflow">if</span> (token)
<a name="l00522"></a>00522       strcpy(user, token);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524    token = strtok(NULL, <span class="stringliteral">&quot;, &quot;</span>);
<a name="l00525"></a>00525    <span class="keywordflow">if</span> (token)
<a name="l00526"></a>00526       strcpy(pass, token);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528    token = strtok(NULL, <span class="stringliteral">&quot;, &quot;</span>);
<a name="l00529"></a>00529    <span class="keywordflow">if</span> (token)
<a name="l00530"></a>00530       strcpy(directory, token);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    token = strtok(NULL, <span class="stringliteral">&quot;, &quot;</span>);
<a name="l00533"></a>00533    <span class="keywordflow">if</span> (token)
<a name="l00534"></a>00534       strcpy(file_name, token);
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 <span class="preprocessor">#ifdef FAL_MAIN</span>
<a name="l00537"></a>00537 <span class="preprocessor"></span>   <a class="code" href="ftplib_8h.html#a3aa68985471e9018f1877ba0a3271753">ftp_debug</a>(NULL, <a class="code" href="fal_8c.html#aad549393783e1d5d91203fb4143bb1e4">ftp_error</a>);
<a name="l00538"></a>00538 <span class="preprocessor">#else</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span>   <a class="code" href="ftplib_8h.html#a3aa68985471e9018f1877ba0a3271753">ftp_debug</a>((<span class="keywordtype">int</span> (*)(<span class="keywordtype">char</span> *)) puts, <a class="code" href="fal_8c.html#aad549393783e1d5d91203fb4143bb1e4">ftp_error</a>);
<a name="l00540"></a>00540 <span class="preprocessor">#endif</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span>
<a name="l00542"></a>00542    status = <a class="code" href="ftplib_8h.html#a63805a37b0ce4d471c9c1e4c3028ba28">ftp_login</a>(con, host_name, port, user, pass, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00543"></a>00543    <span class="keywordflow">if</span> (status &gt;= 0)
<a name="l00544"></a>00544       <span class="keywordflow">return</span> status;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546    status = <a class="code" href="ftplib_8h.html#a97df352ef398403f634cfbc47cfb53b0">ftp_chdir</a>(*con, directory);
<a name="l00547"></a>00547    <span class="keywordflow">if</span> (status &gt;= 0)
<a name="l00548"></a>00548       <span class="keywordflow">return</span> status;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550    status = <a class="code" href="ftplib_8h.html#a9e4209e2bfce840c4e82a2ff8601a94e">ftp_binary</a>(*con);
<a name="l00551"></a>00551    <span class="keywordflow">if</span> (status &gt;= 0)
<a name="l00552"></a>00552       <span class="keywordflow">return</span> status;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554    <span class="keywordflow">if</span> (<a class="code" href="ftplib_8h.html#abf63a2ee7d62ade081a6b6503d42eedc">ftp_open_write</a>(*con, file_name) &gt;= 0)
<a name="l00555"></a>00555       <span class="keywordflow">return</span> (*con)-&gt;err_no;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l00558"></a>00558 }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 <span class="comment">/*---- MIDAS format routines ---------------------------------------*/</span>
<a name="l00561"></a>00561 
<a name="l00562"></a><a class="code" href="fal_8c.html#a755e7b4f48fda8bb4f225233b88fb165">00562</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a755e7b4f48fda8bb4f225233b88fb165">midas_flush_buffer</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn)
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, written;
<a name="l00565"></a>00565    <a class="code" href="structMIDAS__INFO.html">MIDAS_INFO</a> *info;
<a name="l00566"></a>00566 
<a name="l00567"></a>00567    info = (<a class="code" href="structMIDAS__INFO.html">MIDAS_INFO</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#aabb8de21dd2b166aaf2d7e9446768a4e">format_info</a>;
<a name="l00568"></a>00568    size = (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a> - (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570    <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (size == 0)
<a name="l00571"></a>00571       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l00572"></a>00572 
<a name="l00573"></a>00573    <span class="comment">/* write record to device */</span>
<a name="l00574"></a>00574    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>)
<a name="l00575"></a>00575       status = <a class="code" href="group__msectionh.html#ga2805362dd3e83391691437be277295b7">ss_tape_write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>, size);
<a name="l00576"></a>00576    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>)
<a name="l00577"></a>00577       status =
<a name="l00578"></a>00578           <a class="code" href="ftplib_8h.html#a9ae256b14c27d8f52918f0fcbb92bd1c">ftp_send</a>(((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>)-&gt;data, info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>,
<a name="l00579"></a>00579                    size) == size ? <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l00580"></a>00580    <span class="keywordflow">else</span> {
<a name="l00581"></a>00581 <span class="preprocessor">#ifdef OS_WINNT</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>      WriteFile((HANDLE) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>, size, &amp;written, NULL);
<a name="l00583"></a>00583 <span class="preprocessor">#else</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span>      written = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>, size);
<a name="l00585"></a>00585 <span class="preprocessor">#endif</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span>      status = written == size ? <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l00587"></a>00587    }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589    info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a> = info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591    <span class="keywordflow">return</span> status;
<a name="l00592"></a>00592 }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00596"></a>00596 
<a name="l00597"></a><a class="code" href="fal_8c.html#a92d60624c2797cbac096ccbac854d1f1">00597</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a92d60624c2797cbac096ccbac854d1f1">midas_write</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> evt_size)
<a name="l00598"></a>00598 {
<a name="l00599"></a>00599    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, size_left;
<a name="l00600"></a>00600    <a class="code" href="structMIDAS__INFO.html">MIDAS_INFO</a> *info;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602    info = (<a class="code" href="structMIDAS__INFO.html">MIDAS_INFO</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#aabb8de21dd2b166aaf2d7e9446768a4e">format_info</a>;
<a name="l00603"></a>00603 
<a name="l00604"></a>00604    <span class="comment">/* check if event fits into buffer */</span>
<a name="l00605"></a>00605    size_left = <a class="code" href="group__midasincludecode.html#gab17ef1a258d0569666f69f72ccd50253">TAPE_BUFFER_SIZE</a> - ((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a> - (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>);
<a name="l00606"></a>00606 
<a name="l00607"></a>00607    <span class="keywordflow">if</span> (size_left &lt; evt_size) {
<a name="l00608"></a>00608       <span class="comment">/* copy first part of event */</span>
<a name="l00609"></a>00609       memcpy(info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a>, pevent, size_left);
<a name="l00610"></a>00610       info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a> += size_left;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612       <span class="comment">/* flush buffer */</span>
<a name="l00613"></a>00613       status = <a class="code" href="fal_8c.html#a755e7b4f48fda8bb4f225233b88fb165">midas_flush_buffer</a>(log_chn);
<a name="l00614"></a>00614       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>)
<a name="l00615"></a>00615          <span class="keywordflow">return</span> status;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617       <span class="comment">/* several writes for large events */</span>
<a name="l00618"></a>00618       <span class="keywordflow">while</span> (evt_size - size_left &gt;= <a class="code" href="group__midasincludecode.html#gab17ef1a258d0569666f69f72ccd50253">TAPE_BUFFER_SIZE</a>) {
<a name="l00619"></a>00619          memcpy(info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>, (<span class="keywordtype">char</span> *) pevent + size_left, <a class="code" href="group__midasincludecode.html#gab17ef1a258d0569666f69f72ccd50253">TAPE_BUFFER_SIZE</a>);
<a name="l00620"></a>00620          info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a> += <a class="code" href="group__midasincludecode.html#gab17ef1a258d0569666f69f72ccd50253">TAPE_BUFFER_SIZE</a>;
<a name="l00621"></a>00621          size_left += <a class="code" href="group__midasincludecode.html#gab17ef1a258d0569666f69f72ccd50253">TAPE_BUFFER_SIZE</a>;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623          status = <a class="code" href="fal_8c.html#a755e7b4f48fda8bb4f225233b88fb165">midas_flush_buffer</a>(log_chn);
<a name="l00624"></a>00624          <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>)
<a name="l00625"></a>00625             <span class="keywordflow">return</span> status;
<a name="l00626"></a>00626       }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628       <span class="comment">/* copy remaining part of event */</span>
<a name="l00629"></a>00629       memcpy(info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>, (<span class="keywordtype">char</span> *) pevent + size_left, evt_size - size_left);
<a name="l00630"></a>00630       info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a> = info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a> + (evt_size - size_left);
<a name="l00631"></a>00631    } <span class="keywordflow">else</span> {
<a name="l00632"></a>00632       <span class="comment">/* copy event to buffer */</span>
<a name="l00633"></a>00633       memcpy(info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a>, pevent, evt_size);
<a name="l00634"></a>00634       info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a> += evt_size;
<a name="l00635"></a>00635    }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637    <span class="comment">/* update statistics */</span>
<a name="l00638"></a>00638    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#aa314b315e3b535e7442803526c7c515d">events_written</a>++;
<a name="l00639"></a>00639    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a7f50d67aca6cc223a2049e75b67e62f0">bytes_written</a> += pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l00640"></a>00640    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a4781a92eaf28c8718c72f092d2cbfcd1">bytes_written_total</a> += pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l00641"></a>00641 
<a name="l00642"></a>00642    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00646"></a>00646 
<a name="l00647"></a><a class="code" href="fal_8c.html#af75770c7cb96c72546d92ae41d7fcbf6">00647</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#af75770c7cb96c72546d92ae41d7fcbf6">midas_log_open</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l00648"></a>00648 {
<a name="l00649"></a>00649    <a class="code" href="structMIDAS__INFO.html">MIDAS_INFO</a> *info;
<a name="l00650"></a>00650    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652    <span class="comment">/* allocate MIDAS buffer info */</span>
<a name="l00653"></a>00653    log_chn-&gt;<a class="code" href="structLOG__CHN.html#aabb8de21dd2b166aaf2d7e9446768a4e">format_info</a> = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structMIDAS__INFO.html">MIDAS_INFO</a>));
<a name="l00654"></a>00654 
<a name="l00655"></a>00655    info = (<a class="code" href="structMIDAS__INFO.html">MIDAS_INFO</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#aabb8de21dd2b166aaf2d7e9446768a4e">format_info</a>;
<a name="l00656"></a>00656    <a class="code" href="generate-MODULES_8h.html#aaac43492f2954cc70dd9a286b2b3ab02">if</a> (info == NULL) {
<a name="l00657"></a>00657       log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l00658"></a>00658       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l00659"></a>00659    }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661    <span class="comment">/* allocate full ring buffer for that channel */</span>
<a name="l00662"></a>00662    <span class="keywordflow">if</span> ((info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a> = (<span class="keywordtype">char</span> *) malloc(<a class="code" href="group__midasincludecode.html#gab17ef1a258d0569666f69f72ccd50253">TAPE_BUFFER_SIZE</a>)) == NULL) {
<a name="l00663"></a>00663       free(info);
<a name="l00664"></a>00664       log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l00665"></a>00665       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l00666"></a>00666    }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668    info-&gt;<a class="code" href="structMIDAS__INFO.html#ab44610feb3bfb628551f18a93b3890bf">write_pointer</a> = info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670    <span class="comment">/* Create device channel */</span>
<a name="l00671"></a>00671    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>) {
<a name="l00672"></a>00672       status = <a class="code" href="fal_8c.html#af3cabceb8b0fa7c888cebccd87848ad5">tape_open</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, &amp;log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l00673"></a>00673       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l00674"></a>00674          free(info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>);
<a name="l00675"></a>00675          free(info);
<a name="l00676"></a>00676          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l00677"></a>00677          <span class="keywordflow">return</span> status;
<a name="l00678"></a>00678       }
<a name="l00679"></a>00679    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>) {
<a name="l00680"></a>00680       status = <a class="code" href="fal_8c.html#a63504313b744b5dcd8b3fdc5058696b4">ftp_open</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, (<a class="code" href="structFTP__CON.html">FTP_CON</a> **) (&amp;log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>));
<a name="l00681"></a>00681       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l00682"></a>00682          free(info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>);
<a name="l00683"></a>00683          free(info);
<a name="l00684"></a>00684          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l00685"></a>00685          <span class="keywordflow">return</span> status;
<a name="l00686"></a>00686       } <span class="keywordflow">else</span>
<a name="l00687"></a>00687          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 1;
<a name="l00688"></a>00688    } <span class="keywordflow">else</span> {
<a name="l00689"></a>00689       <span class="comment">/* check if file exists */</span>
<a name="l00690"></a>00690       <span class="keywordflow">if</span> (strstr(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, <span class="stringliteral">&quot;null&quot;</span>) == NULL) {
<a name="l00691"></a>00691          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = open(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, O_RDONLY);
<a name="l00692"></a>00692          <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> &gt; 0) {
<a name="l00693"></a>00693             <span class="comment">/* check if file length is nonzero */</span>
<a name="l00694"></a>00694             <span class="keywordflow">if</span> (lseek(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, 0, SEEK_END) &gt; 0) {
<a name="l00695"></a>00695                close(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l00696"></a>00696                free(info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>);
<a name="l00697"></a>00697                free(info);
<a name="l00698"></a>00698                log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l00699"></a>00699                <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga252be9bba4cc9d08025559dc495aca6b">SS_FILE_EXISTS</a>;
<a name="l00700"></a>00700             }
<a name="l00701"></a>00701          }
<a name="l00702"></a>00702       }
<a name="l00703"></a>00703 <span class="preprocessor">#ifdef OS_WINNT</span>
<a name="l00704"></a>00704 <span class="preprocessor"></span>      log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> =
<a name="l00705"></a>00705           (int) CreateFile(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, GENERIC_WRITE, FILE_SHARE_READ, NULL,
<a name="l00706"></a>00706                            CREATE_ALWAYS,
<a name="l00707"></a>00707                            FILE_ATTRIBUTE_NORMAL | FILE_FLAG_WRITE_THROUGH |
<a name="l00708"></a>00708                            FILE_FLAG_SEQUENTIAL_SCAN, 0);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710 <span class="preprocessor">#else</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span>      log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> =
<a name="l00712"></a>00712           open(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, O_WRONLY | O_CREAT | O_TRUNC | <a class="code" href="group__msystemincludecode.html#ga36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>, 0644);
<a name="l00713"></a>00713 <span class="preprocessor">#endif</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span>
<a name="l00715"></a>00715       <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> &lt; 0) {
<a name="l00716"></a>00716          free(info-&gt;<a class="code" href="structMIDAS__INFO.html#af9b9f0a570617735c6793a8fb1a0fca9">buffer</a>);
<a name="l00717"></a>00717          free(info);
<a name="l00718"></a>00718          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l00719"></a>00719          <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l00720"></a>00720       }
<a name="l00721"></a>00721    }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723    <span class="comment">/* write ODB dump */</span>
<a name="l00724"></a>00724    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a1d09a907562f29589880b5382a1c7e7a">odb_dump</a>)
<a name="l00725"></a>00725       <a class="code" href="fal_8c.html#a3b7aaa44f801314545e68f1b09c5a0c4">log_odb_dump</a>(log_chn, <a class="code" href="group__mbufferh.html#gaea58a47233f988dd2f9a0320d99734dc">EVENTID_BOR</a>, run_number);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00731"></a>00731 
<a name="l00732"></a><a class="code" href="fal_8c.html#aa66a2f87f89ceda400aa7c8df883356f">00732</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#aa66a2f87f89ceda400aa7c8df883356f">midas_log_close</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l00733"></a>00733 {
<a name="l00734"></a>00734    <span class="comment">/* write ODB dump */</span>
<a name="l00735"></a>00735    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a1d09a907562f29589880b5382a1c7e7a">odb_dump</a>)
<a name="l00736"></a>00736       <a class="code" href="fal_8c.html#a3b7aaa44f801314545e68f1b09c5a0c4">log_odb_dump</a>(log_chn, <a class="code" href="group__mbufferh.html#ga8f46d90b4c90a2387685d422625c654f">EVENTID_EOR</a>, run_number);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738    <a class="code" href="fal_8c.html#a755e7b4f48fda8bb4f225233b88fb165">midas_flush_buffer</a>(log_chn);
<a name="l00739"></a>00739 
<a name="l00740"></a>00740    <span class="comment">/* Write EOF if Tape */</span>
<a name="l00741"></a>00741    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>) {
<a name="l00742"></a>00742       <span class="comment">/* writing EOF mark on tape Fonly */</span>
<a name="l00743"></a>00743       <a class="code" href="group__msectionh.html#gabb63b38780721d675d806d6081ad2f89">ss_tape_write_eof</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l00744"></a>00744       <a class="code" href="group__msectionh.html#ga4a9420e0e9ef8bd23b41f7594bad7395">ss_tape_close</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l00745"></a>00745    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>) {
<a name="l00746"></a>00746       <a class="code" href="ftplib_8h.html#aa29061617ea49f3d5d5412e6a6b9ddea">ftp_close</a>((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>);
<a name="l00747"></a>00747       <a class="code" href="ftplib_8h.html#a7b1c89c618ec6cd6363b7b85644efc97">ftp_bye</a>((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>);
<a name="l00748"></a>00748    } <span class="keywordflow">else</span>
<a name="l00749"></a>00749 <span class="preprocessor">#ifdef OS_WINNT</span>
<a name="l00750"></a>00750 <span class="preprocessor"></span>      CloseHandle((HANDLE) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l00751"></a>00751 <span class="preprocessor">#else</span>
<a name="l00752"></a>00752 <span class="preprocessor"></span>      close(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l00753"></a>00753 <span class="preprocessor">#endif</span>
<a name="l00754"></a>00754 <span class="preprocessor"></span>
<a name="l00755"></a>00755    free(((<a class="code" href="structMIDAS__INFO.html">MIDAS_INFO</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#aabb8de21dd2b166aaf2d7e9446768a4e">format_info</a>)-&gt;buffer);
<a name="l00756"></a>00756    free(log_chn-&gt;<a class="code" href="structLOG__CHN.html#aabb8de21dd2b166aaf2d7e9446768a4e">format_info</a>);
<a name="l00757"></a>00757 
<a name="l00758"></a>00758    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l00759"></a>00759 }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 <span class="comment">/*-- db_get_event_definition ---------------------------------------*/</span>
<a name="l00762"></a>00762 
<a name="l00763"></a><a class="code" href="structEVENT__DEF.html">00763</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00764"></a><a class="code" href="structEVENT__DEF.html#a450b12516bc22bbd288f8172099ef85f">00764</a>    <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l00765"></a><a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">00765</a>    <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="webpaw_8c.html#a6113855b8e5965f1e91ee407b4026ab7">format</a>;
<a name="l00766"></a><a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">00766</a>    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hDefKey;
<a name="l00767"></a>00767 } <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a>;
<a name="l00768"></a>00768 
<a name="l00769"></a><a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">00769</a> <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *<a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(<span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>)
<a name="l00770"></a>00770 {
<a name="l00771"></a>00771    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l00772"></a>00772    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[80];
<a name="l00773"></a>00773    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, hKeyRoot;
<a name="l00774"></a>00774    <a class="code" href="unionWORD.html">WORD</a> id;
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 <span class="preprocessor">#define EVENT_DEF_CACHE_SIZE 30</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span>   <span class="keyword">static</span> <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def = NULL;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779    <span class="comment">/* allocate memory for cache */</span>
<a name="l00780"></a>00780    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l00781"></a>00781       event_def = calloc(<a class="code" href="fal_8c.html#a696fa60df0f6ed300eb2f4d17ea46054">EVENT_DEF_CACHE_SIZE</a>, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__DEF.html">EVENT_DEF</a>));
<a name="l00782"></a>00782 
<a name="l00783"></a>00783    <span class="comment">/* lookup if event definition in cache */</span>
<a name="l00784"></a>00784    <span class="keywordflow">for</span> (i = 0; event_def[i].<a class="code" href="structEVENT__DEF.html#a450b12516bc22bbd288f8172099ef85f">event_id</a>; i++)
<a name="l00785"></a>00785       <span class="keywordflow">if</span> (event_def[i].event_id == event_id)
<a name="l00786"></a>00786          <span class="keywordflow">return</span> &amp;event_def[i];
<a name="l00787"></a>00787 
<a name="l00788"></a>00788    <span class="comment">/* search free cache entry */</span>
<a name="l00789"></a>00789    <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="fal_8c.html#a696fa60df0f6ed300eb2f4d17ea46054">EVENT_DEF_CACHE_SIZE</a>; index++)
<a name="l00790"></a>00790       <span class="keywordflow">if</span> (event_def[index].event_id == 0)
<a name="l00791"></a>00791          <span class="keywordflow">break</span>;
<a name="l00792"></a>00792 
<a name="l00793"></a>00793    <span class="keywordflow">if</span> (index == EVENT_DEF_CACHE_SIZE) {
<a name="l00794"></a>00794       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;db_get_event_definition&quot;</span>, <span class="stringliteral">&quot;too many event definitions&quot;</span>);
<a name="l00795"></a>00795       <span class="keywordflow">return</span> NULL;
<a name="l00796"></a>00796    }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798    <span class="comment">/* check for system events */</span>
<a name="l00799"></a>00799    <span class="keywordflow">if</span> (event_id &lt; 0) {
<a name="l00800"></a>00800       event_def[index].<a class="code" href="structEVENT__DEF.html#a450b12516bc22bbd288f8172099ef85f">event_id</a> = event_id;
<a name="l00801"></a>00801       event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>;
<a name="l00802"></a>00802       event_def[index].<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a> = 0;
<a name="l00803"></a>00803       <span class="keywordflow">return</span> &amp;event_def[index];
<a name="l00804"></a>00804    }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806    status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/equipment&quot;</span>, &amp;hKeyRoot);
<a name="l00807"></a>00807    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00808"></a>00808       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;db_get_event_definition&quot;</span>, <span class="stringliteral">&quot;cannot find /equipment entry in ODB&quot;</span>);
<a name="l00809"></a>00809       <span class="keywordflow">return</span> NULL;
<a name="l00810"></a>00810    }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812    <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l00813"></a>00813       <span class="comment">/* search for client with specific name */</span>
<a name="l00814"></a>00814       status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, i, &amp;hKey);
<a name="l00815"></a>00815       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>) {
<a name="l00816"></a>00816          sprintf(str, <span class="stringliteral">&quot;Cannot find event id %d under /equipment&quot;</span>, event_id);
<a name="l00817"></a>00817          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;db_get_event_definition&quot;</span>, str);
<a name="l00818"></a>00818          <span class="keywordflow">return</span> NULL;
<a name="l00819"></a>00819       }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821       size = <span class="keyword">sizeof</span>(id);
<a name="l00822"></a>00822       status = <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Common/Event ID&quot;</span>, &amp;<span class="keywordtype">id</span>, &amp;size, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00823"></a>00823       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00824"></a>00824          <span class="keywordflow">continue</span>;
<a name="l00825"></a>00825 
<a name="l00826"></a>00826       <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == event_id) {
<a name="l00827"></a>00827          <span class="comment">/* set cache entry */</span>
<a name="l00828"></a>00828          event_def[index].<a class="code" href="structEVENT__DEF.html#a450b12516bc22bbd288f8172099ef85f">event_id</a> = id;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830          size = <span class="keyword">sizeof</span>(str);
<a name="l00831"></a>00831          str[0] = 0;
<a name="l00832"></a>00832          <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Common/Format&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;Fixed&quot;</span>))
<a name="l00835"></a>00835             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>;
<a name="l00836"></a>00836          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;ASCII&quot;</span>))
<a name="l00837"></a>00837             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>;
<a name="l00838"></a>00838          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;MIDAS&quot;</span>))
<a name="l00839"></a>00839             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>;
<a name="l00840"></a>00840          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;YBOS&quot;</span>))
<a name="l00841"></a>00841             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>;
<a name="l00842"></a>00842          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;DUMP&quot;</span>))
<a name="l00843"></a>00843             event_def[index].<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> = <a class="code" href="group__mdefineh.html#gaffaf04a985dfa6ff43ab39a8c6e3f0a7">FORMAT_DUMP</a>;
<a name="l00844"></a>00844          <span class="keywordflow">else</span> {
<a name="l00845"></a>00845             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;db_get_event_definition&quot;</span>, <span class="stringliteral">&quot;unknown data format&quot;</span>);
<a name="l00846"></a>00846             event_def[index].<a class="code" href="structEVENT__DEF.html#a450b12516bc22bbd288f8172099ef85f">event_id</a> = 0;
<a name="l00847"></a>00847             <span class="keywordflow">return</span> NULL;
<a name="l00848"></a>00848          }
<a name="l00849"></a>00849 
<a name="l00850"></a>00850          <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Variables&quot;</span>, &amp;event_def[index].hDefKey);
<a name="l00851"></a>00851          <span class="keywordflow">return</span> &amp;event_def[index];
<a name="l00852"></a>00852       }
<a name="l00853"></a>00853    }
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00856"></a>00856 <span class="comment">/*---- DUMP format routines ----------------------------------------*/</span>
<a name="l00857"></a>00857 
<a name="l00858"></a><a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">00858</a> <span class="preprocessor">#define STR_INC(p,base) { p+=strlen(p); \</span>
<a name="l00859"></a>00859 <span class="preprocessor">                          if (p &gt; base+sizeof(base)) \</span>
<a name="l00860"></a>00860 <span class="preprocessor">                            cm_msg(MERROR, &quot;STR_INC&quot;, &quot;ASCII buffer too small&quot;); }</span>
<a name="l00861"></a>00861 <span class="preprocessor"></span>
<a name="l00862"></a>00862 
<a name="l00863"></a><a class="code" href="fal_8c.html#a17062c806a84e18c0ff5e8add89f67f0">00863</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a17062c806a84e18c0ff5e8add89f67f0">dump_write</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> evt_size)
<a name="l00864"></a>00864 {
<a name="l00865"></a>00865    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>;
<a name="l00866"></a>00866    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l00867"></a>00867    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l00868"></a>00868    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l00869"></a>00869    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l00870"></a>00870    <span class="keywordtype">void</span> *pdata;
<a name="l00871"></a>00871    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>[100000], *pbuf, <a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>[5], <a class="code" href="msgdump_8c.html#ae8c4f86d88b7b85ae0f2bd5ceecfe425">type_name</a>[10];
<a name="l00872"></a>00872    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l00873"></a>00873    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l00874"></a>00874    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bkname;
<a name="l00875"></a>00875    <a class="code" href="unionWORD.html">WORD</a> bktype;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877    event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l00878"></a>00878    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l00879"></a>00879       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l00880"></a>00880 
<a name="l00881"></a>00881    <span class="comment">/* write event header */</span>
<a name="l00882"></a>00882    pbuf = buffer;
<a name="l00883"></a>00883    name[4] = 0;
<a name="l00884"></a>00884 
<a name="l00885"></a>00885    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> == <a class="code" href="group__mbufferh.html#gaea58a47233f988dd2f9a0320d99734dc">EVENTID_BOR</a>)
<a name="l00886"></a>00886       sprintf(pbuf, <span class="stringliteral">&quot;%%ID BOR NR %ld\n&quot;</span>, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
<a name="l00887"></a>00887    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> == <a class="code" href="group__mbufferh.html#ga8f46d90b4c90a2387685d422625c654f">EVENTID_EOR</a>)
<a name="l00888"></a>00888       sprintf(pbuf, <span class="stringliteral">&quot;%%ID EOR NR %ld\n&quot;</span>, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
<a name="l00889"></a>00889    <span class="keywordflow">else</span>
<a name="l00890"></a>00890       sprintf(pbuf, <span class="stringliteral">&quot;%%ID %d TR %d NR %ld\n&quot;</span>, pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a>,
<a name="l00891"></a>00891               pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
<a name="l00892"></a>00892    <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l00893"></a>00893 
<a name="l00894"></a>00894   <span class="comment">/*---- MIDAS format ----------------------------------------------*/</span>
<a name="l00895"></a>00895    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l00896"></a>00896       <a class="code" href="structLRS1882__DATA.html">LRS1882_DATA</a> *lrs1882;
<a name="l00897"></a>00897       <a class="code" href="structLRS1877__DATA.html">LRS1877_DATA</a> *lrs1877;
<a name="l00898"></a>00898       <a class="code" href="structLRS1877__HEADER.html">LRS1877_HEADER</a> *lrs1877_header;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900       pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l00901"></a>00901       <a class="code" href="group__msectionh.html#gacc5a45e8cd3b781a7622c4e00bdc348a">bk_swap</a>(pbh, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903       pbk = NULL;
<a name="l00904"></a>00904       pbk32 = NULL;
<a name="l00905"></a>00905       <span class="keywordflow">do</span> {
<a name="l00906"></a>00906          <span class="comment">/* scan all banks */</span>
<a name="l00907"></a>00907          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh)) {
<a name="l00908"></a>00908             size = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l00909"></a>00909             <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l00910"></a>00910                <span class="keywordflow">break</span>;
<a name="l00911"></a>00911             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l00912"></a>00912             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l00913"></a>00913          } <span class="keywordflow">else</span> {
<a name="l00914"></a>00914             size = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l00915"></a>00915             <span class="keywordflow">if</span> (pbk == NULL)
<a name="l00916"></a>00916                <span class="keywordflow">break</span>;
<a name="l00917"></a>00917             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l00918"></a>00918             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l00919"></a>00919          }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF))
<a name="l00922"></a>00922             size /= <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF);
<a name="l00923"></a>00923 
<a name="l00924"></a>00924          lrs1882 = (<a class="code" href="structLRS1882__DATA.html">LRS1882_DATA</a> *) pdata;
<a name="l00925"></a>00925          lrs1877 = (<a class="code" href="structLRS1877__DATA.html">LRS1877_DATA</a> *) pdata;
<a name="l00926"></a>00926          lrs1877_header = (<a class="code" href="structLRS1877__HEADER.html">LRS1877_HEADER</a> *) pdata;
<a name="l00927"></a>00927 
<a name="l00928"></a>00928          <span class="comment">/* write bank header */</span>
<a name="l00929"></a>00929          *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) name) = bkname;
<a name="l00930"></a>00930 
<a name="l00931"></a>00931          <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == 0)
<a name="l00932"></a>00932             strcpy(type_name, <a class="code" href="group__msectionh.html#ga94fb45fa1cdd442e964ebe32c7668976">rpc_tid_name</a>(bktype &amp; 0xFF));
<a name="l00933"></a>00933          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ae970f1c88e76ada2bcb23a140e27e37c">TID_LRS1882</a>)
<a name="l00934"></a>00934             strcpy(type_name, <span class="stringliteral">&quot;LRS1882&quot;</span>);
<a name="l00935"></a>00935          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ab4bb71b415e8b5ba35490697817c0415">TID_LRS1877</a>)
<a name="l00936"></a>00936             strcpy(type_name, <span class="stringliteral">&quot;LRS1877&quot;</span>);
<a name="l00937"></a>00937          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#a9446e243f13a3078e1237e48543021fd">TID_PCOS3</a>)
<a name="l00938"></a>00938             strcpy(type_name, <span class="stringliteral">&quot;PCOS3&quot;</span>);
<a name="l00939"></a>00939          <span class="keywordflow">else</span>
<a name="l00940"></a>00940             strcpy(type_name, <span class="stringliteral">&quot;unknown&quot;</span>);
<a name="l00941"></a>00941 
<a name="l00942"></a>00942          sprintf(pbuf, <span class="stringliteral">&quot;BK %s TP %s SZ %d\n&quot;</span>, name, type_name, size);
<a name="l00943"></a>00943          <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l00944"></a>00944 
<a name="l00945"></a>00945          <span class="comment">/* write data */</span>
<a name="l00946"></a>00946          <span class="keywordflow">for</span> (i = 0; i &lt; size; i++) {
<a name="l00947"></a>00947             <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == 0)
<a name="l00948"></a>00948                <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pbuf, pdata, size, i, bktype &amp; 0xFF);
<a name="l00949"></a>00949 
<a name="l00950"></a>00950             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ae970f1c88e76ada2bcb23a140e27e37c">TID_LRS1882</a>)
<a name="l00951"></a>00951                sprintf(pbuf, <span class="stringliteral">&quot;GA %d CH %02d DA %d&quot;</span>,
<a name="l00952"></a>00952                        lrs1882[i].geo_addr, lrs1882[i].<a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>, lrs1882[i].<a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>);
<a name="l00953"></a>00953 
<a name="l00954"></a>00954             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ab4bb71b415e8b5ba35490697817c0415">TID_LRS1877</a>) {
<a name="l00955"></a>00955                <span class="keywordflow">if</span> (i == 0)      <span class="comment">/* header */</span>
<a name="l00956"></a>00956                   sprintf(pbuf, <span class="stringliteral">&quot;GA %d BF %d CN %d&quot;</span>,
<a name="l00957"></a>00957                           lrs1877_header[i].geo_addr, lrs1877_header[i].buffer,
<a name="l00958"></a>00958                           lrs1877_header[i].<a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>);
<a name="l00959"></a>00959                <span class="keywordflow">else</span>             <span class="comment">/* data */</span>
<a name="l00960"></a>00960                   sprintf(pbuf, <span class="stringliteral">&quot;GA %d CH %02d ED %d DA %1.1lf&quot;</span>,
<a name="l00961"></a>00961                           lrs1877[i].geo_addr, lrs1877[i].channel, lrs1877[i].edge,
<a name="l00962"></a>00962                           lrs1877[i].data * 0.5);
<a name="l00963"></a>00963             }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#a9446e243f13a3078e1237e48543021fd">TID_PCOS3</a>)
<a name="l00966"></a>00966                sprintf(pbuf, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00967"></a>00967             <span class="keywordflow">else</span>
<a name="l00968"></a>00968                <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pbuf, pdata, size, i, bktype &amp; 0xFF);
<a name="l00969"></a>00969 
<a name="l00970"></a>00970             strcat(pbuf, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00971"></a>00971             <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l00972"></a>00972          }
<a name="l00973"></a>00973 
<a name="l00974"></a>00974       } <span class="keywordflow">while</span> (1);
<a name="l00975"></a>00975    }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977   <span class="comment">/*---- FIXED format ----------------------------------------------*/</span>
<a name="l00978"></a>00978    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
<a name="l00979"></a>00979       <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a> == 0)
<a name="l00980"></a>00980          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;dump_write&quot;</span>, <span class="stringliteral">&quot;cannot find event definition&quot;</span>);
<a name="l00981"></a>00981       <span class="keywordflow">else</span> {
<a name="l00982"></a>00982          pdata = (<span class="keywordtype">char</span> *) (pevent + 1);
<a name="l00983"></a>00983          <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l00984"></a>00984             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, i, &amp;hKey);
<a name="l00985"></a>00985             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l00986"></a>00986                <span class="keywordflow">break</span>;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;key);
<a name="l00989"></a>00989             sprintf(pbuf, <span class="stringliteral">&quot;%s\n&quot;</span>, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l00990"></a>00990             <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l00991"></a>00991 
<a name="l00992"></a>00992             <span class="comment">/* adjust for alignment */</span>
<a name="l00993"></a>00993             pdata = (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l00994"></a>00994 
<a name="l00995"></a>00995             <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l00996"></a>00996                <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pbuf, pdata, key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>, j, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l00997"></a>00997                strcat(pbuf, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00998"></a>00998                <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pbuf, buffer);
<a name="l00999"></a>00999             }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001             <span class="comment">/* shift data pointer to next item */</span>
<a name="l01002"></a>01002             pdata = (<span class="keywordtype">char</span> *) pdata + key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l01003"></a>01003          }
<a name="l01004"></a>01004       }
<a name="l01005"></a>01005    }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007   <span class="comment">/*---- ASCII format ----------------------------------------------*/</span>
<a name="l01008"></a>01008    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>) {
<a name="l01009"></a>01009       <span class="comment">/* write event header to device */</span>
<a name="l01010"></a>01010       size = strlen(buffer);
<a name="l01011"></a>01011       <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>)
<a name="l01012"></a>01012          status = <a class="code" href="group__msectionh.html#ga2805362dd3e83391691437be277295b7">ss_tape_write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, buffer, size);
<a name="l01013"></a>01013       <span class="keywordflow">else</span>
<a name="l01014"></a>01014          status = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, buffer, size) ==
<a name="l01015"></a>01015              size ? <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017       <span class="comment">/* write event directly to device */</span>
<a name="l01018"></a>01018       size = strlen((<span class="keywordtype">char</span> *) (pevent + 1));
<a name="l01019"></a>01019       <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>)
<a name="l01020"></a>01020          status = <a class="code" href="group__msectionh.html#ga2805362dd3e83391691437be277295b7">ss_tape_write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, (<span class="keywordtype">char</span> *) (pevent + 1), size);
<a name="l01021"></a>01021       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>)
<a name="l01022"></a>01022          status = <a class="code" href="ftplib_8h.html#a9ae256b14c27d8f52918f0fcbb92bd1c">ftp_send</a>(((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>)-&gt;data, buffer, size) == size ?
<a name="l01023"></a>01023              <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l01024"></a>01024       <span class="keywordflow">else</span>
<a name="l01025"></a>01025          status = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, (<span class="keywordtype">char</span> *) (pevent + 1), size) ==
<a name="l01026"></a>01026              size ? <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l01027"></a>01027    } <span class="keywordflow">else</span> {
<a name="l01028"></a>01028       <span class="comment">/* non-ascii format: only write buffer */</span>
<a name="l01029"></a>01029 
<a name="l01030"></a>01030       <span class="comment">/* insert empty line after each event */</span>
<a name="l01031"></a>01031       strcat(pbuf, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01032"></a>01032       size = strlen(buffer);
<a name="l01033"></a>01033 
<a name="l01034"></a>01034       <span class="comment">/* write record to device */</span>
<a name="l01035"></a>01035       <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>)
<a name="l01036"></a>01036          status = <a class="code" href="group__msectionh.html#ga2805362dd3e83391691437be277295b7">ss_tape_write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, buffer, size);
<a name="l01037"></a>01037       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>)
<a name="l01038"></a>01038          status = <a class="code" href="ftplib_8h.html#a9ae256b14c27d8f52918f0fcbb92bd1c">ftp_send</a>(((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>)-&gt;data, buffer, size) == size ?
<a name="l01039"></a>01039              <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l01040"></a>01040       <span class="keywordflow">else</span>
<a name="l01041"></a>01041          status = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, buffer, size) ==
<a name="l01042"></a>01042              size ? <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l01043"></a>01043    }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045    <span class="comment">/* update statistics */</span>
<a name="l01046"></a>01046    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#aa314b315e3b535e7442803526c7c515d">events_written</a>++;
<a name="l01047"></a>01047    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a7f50d67aca6cc223a2049e75b67e62f0">bytes_written</a> += size;
<a name="l01048"></a>01048    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a4781a92eaf28c8718c72f092d2cbfcd1">bytes_written_total</a> += size;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050    <span class="keywordflow">return</span> status;
<a name="l01051"></a>01051 }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01054"></a>01054 
<a name="l01055"></a><a class="code" href="fal_8c.html#ada9b3e2a17f72cd8e3a27c1598794851">01055</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#ada9b3e2a17f72cd8e3a27c1598794851">dump_log_open</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l01056"></a>01056 {
<a name="l01057"></a>01057    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01058"></a>01058 
<a name="l01059"></a>01059    <span class="comment">/* Create device channel */</span>
<a name="l01060"></a>01060    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>) {
<a name="l01061"></a>01061       status = <a class="code" href="fal_8c.html#af3cabceb8b0fa7c888cebccd87848ad5">tape_open</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, &amp;log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l01062"></a>01062       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l01063"></a>01063          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l01064"></a>01064          <span class="keywordflow">return</span> status;
<a name="l01065"></a>01065       }
<a name="l01066"></a>01066    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>) {
<a name="l01067"></a>01067       status = <a class="code" href="fal_8c.html#a63504313b744b5dcd8b3fdc5058696b4">ftp_open</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, (<a class="code" href="structFTP__CON.html">FTP_CON</a> **) (&amp;log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>));
<a name="l01068"></a>01068       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l01069"></a>01069          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l01070"></a>01070          <span class="keywordflow">return</span> status;
<a name="l01071"></a>01071       } <span class="keywordflow">else</span>
<a name="l01072"></a>01072          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 1;
<a name="l01073"></a>01073    } <span class="keywordflow">else</span> {
<a name="l01074"></a>01074       log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = open(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, O_WRONLY | O_CREAT | O_TRUNC, 0644);
<a name="l01075"></a>01075 
<a name="l01076"></a>01076       <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> &lt; 0) {
<a name="l01077"></a>01077          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l01078"></a>01078          <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l01079"></a>01079       }
<a name="l01080"></a>01080    }
<a name="l01081"></a>01081 
<a name="l01082"></a>01082    <span class="comment">/* write ODB dump */</span>
<a name="l01083"></a>01083    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a1d09a907562f29589880b5382a1c7e7a">odb_dump</a>)
<a name="l01084"></a>01084       <a class="code" href="fal_8c.html#a3b7aaa44f801314545e68f1b09c5a0c4">log_odb_dump</a>(log_chn, <a class="code" href="group__mbufferh.html#gaea58a47233f988dd2f9a0320d99734dc">EVENTID_BOR</a>, run_number);
<a name="l01085"></a>01085 
<a name="l01086"></a>01086    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l01087"></a>01087 }
<a name="l01088"></a>01088 
<a name="l01089"></a>01089 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01090"></a>01090 
<a name="l01091"></a><a class="code" href="fal_8c.html#aee31f72db31c10a2e8e014d0cdfafd44">01091</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#aee31f72db31c10a2e8e014d0cdfafd44">dump_log_close</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l01092"></a>01092 {
<a name="l01093"></a>01093    <span class="comment">/* write ODB dump */</span>
<a name="l01094"></a>01094    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a1d09a907562f29589880b5382a1c7e7a">odb_dump</a>)
<a name="l01095"></a>01095       <a class="code" href="fal_8c.html#a3b7aaa44f801314545e68f1b09c5a0c4">log_odb_dump</a>(log_chn, <a class="code" href="group__mbufferh.html#ga8f46d90b4c90a2387685d422625c654f">EVENTID_EOR</a>, run_number);
<a name="l01096"></a>01096 
<a name="l01097"></a>01097    <span class="comment">/* Write EOF if Tape */</span>
<a name="l01098"></a>01098    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>) {
<a name="l01099"></a>01099       <span class="comment">/* writing EOF mark on tape only */</span>
<a name="l01100"></a>01100       <a class="code" href="group__msectionh.html#gabb63b38780721d675d806d6081ad2f89">ss_tape_write_eof</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l01101"></a>01101       <a class="code" href="group__msectionh.html#ga4a9420e0e9ef8bd23b41f7594bad7395">ss_tape_close</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l01102"></a>01102    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>) {
<a name="l01103"></a>01103       <a class="code" href="ftplib_8h.html#aa29061617ea49f3d5d5412e6a6b9ddea">ftp_close</a>((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>);
<a name="l01104"></a>01104       <a class="code" href="ftplib_8h.html#a7b1c89c618ec6cd6363b7b85644efc97">ftp_bye</a>((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>);
<a name="l01105"></a>01105    } <span class="keywordflow">else</span>
<a name="l01106"></a>01106       close(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l01107"></a>01107 
<a name="l01108"></a>01108    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l01109"></a>01109 }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111 <span class="comment">/*---- ASCII format routines ---------------------------------------*/</span>
<a name="l01112"></a>01112 
<a name="l01113"></a><a class="code" href="fal_8c.html#a98f3aa146ac98ba330bc03ff6532d7ae">01113</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a98f3aa146ac98ba330bc03ff6532d7ae">ascii_write</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> evt_size)
<a name="l01114"></a>01114 {
<a name="l01115"></a>01115    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>;
<a name="l01116"></a>01116    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l01117"></a>01117    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l01118"></a>01118    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l01119"></a>01119    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l01120"></a>01120    <span class="keywordtype">void</span> *pdata;
<a name="l01121"></a>01121    <span class="keywordtype">char</span> <a class="code" href="lrs1821_8c.html#a7c3d85e54927f04c38e110e849168bb9">data</a>[1000];
<a name="l01122"></a>01122    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>[10000], <a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>[5], <a class="code" href="msgdump_8c.html#ae8c4f86d88b7b85ae0f2bd5ceecfe425">type_name</a>[10];
<a name="l01123"></a>01123    <span class="keywordtype">char</span> *ph, header_line[10000];
<a name="l01124"></a>01124    <span class="keywordtype">char</span> *pd, data_line[10000];
<a name="l01125"></a>01125    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, hKeyRoot;
<a name="l01126"></a>01126    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l01127"></a>01127    <span class="keyword">static</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> last_event_id = -1;
<a name="l01128"></a>01128    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bkname;
<a name="l01129"></a>01129    <a class="code" href="unionWORD.html">WORD</a> bktype;
<a name="l01130"></a>01130 
<a name="l01131"></a>01131    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> == 1)
<a name="l01132"></a>01132       last_event_id = -1;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134    event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l01135"></a>01135    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l01136"></a>01136       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138    name[4] = 0;
<a name="l01139"></a>01139    header_line[0] = 0;
<a name="l01140"></a>01140    data_line[0] = 0;
<a name="l01141"></a>01141    ph = header_line;
<a name="l01142"></a>01142    pd = data_line;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144    <span class="comment">/* write run parameter at begin of run */</span>
<a name="l01145"></a>01145    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> == <a class="code" href="group__mbufferh.html#gaea58a47233f988dd2f9a0320d99734dc">EVENTID_BOR</a>) {
<a name="l01146"></a>01146       sprintf(header_line, <span class="stringliteral">&quot;%%Run\t&quot;</span>);
<a name="l01147"></a>01147       sprintf(data_line, <span class="stringliteral">&quot;%ld\t&quot;</span>, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>);
<a name="l01148"></a>01148       <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(ph, header_line);
<a name="l01149"></a>01149       <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pd, data_line);
<a name="l01150"></a>01150 
<a name="l01151"></a>01151       status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Experiment/Run parameters&quot;</span>, &amp;hKeyRoot);
<a name="l01152"></a>01152       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01153"></a>01153          <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01154"></a>01154             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, i, &amp;hKey);
<a name="l01155"></a>01155             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01156"></a>01156                <span class="keywordflow">break</span>;
<a name="l01157"></a>01157 
<a name="l01158"></a>01158             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;key);
<a name="l01159"></a>01159             size = <span class="keyword">sizeof</span>(data);
<a name="l01160"></a>01160             <a class="code" href="group__msectionh.html#gad6e53374f24813cdba8713781683c556">db_get_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, data, &amp;size, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162             <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l01163"></a>01163                <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> == 1)
<a name="l01164"></a>01164                   sprintf(ph, <span class="stringliteral">&quot;%s\t&quot;</span>, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01165"></a>01165                <span class="keywordflow">else</span>
<a name="l01166"></a>01166                   sprintf(ph, <span class="stringliteral">&quot;%s%d\t&quot;</span>, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>, j);
<a name="l01167"></a>01167 
<a name="l01168"></a>01168                <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(ph, header_line);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170                <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pd, data, key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>, j, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l01171"></a>01171                strcat(pd, <span class="stringliteral">&quot;\t&quot;</span>);
<a name="l01172"></a>01172                <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pd, data_line);
<a name="l01173"></a>01173             }
<a name="l01174"></a>01174          }
<a name="l01175"></a>01175       }
<a name="l01176"></a>01176    } <span class="keywordflow">else</span> {
<a name="l01177"></a>01177       sprintf(ph, <span class="stringliteral">&quot;%d&quot;</span>, pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l01178"></a>01178       <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(ph, header_line);
<a name="l01179"></a>01179    }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181   <span class="comment">/*---- MIDAS format ----------------------------------------------*/</span>
<a name="l01182"></a>01182    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l01183"></a>01183       <a class="code" href="structLRS1882__DATA.html">LRS1882_DATA</a> *lrs1882;
<a name="l01184"></a>01184       <a class="code" href="structLRS1877__DATA.html">LRS1877_DATA</a> *lrs1877;
<a name="l01185"></a>01185       <a class="code" href="structLRS1877__HEADER.html">LRS1877_HEADER</a> *lrs1877_header;
<a name="l01186"></a>01186 
<a name="l01187"></a>01187       pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l01188"></a>01188       <a class="code" href="group__msectionh.html#gacc5a45e8cd3b781a7622c4e00bdc348a">bk_swap</a>(pbh, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01189"></a>01189 
<a name="l01190"></a>01190       pbk = NULL;
<a name="l01191"></a>01191       pbk32 = NULL;
<a name="l01192"></a>01192       <span class="keywordflow">do</span> {
<a name="l01193"></a>01193          <span class="comment">/* scan all banks */</span>
<a name="l01194"></a>01194          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh)) {
<a name="l01195"></a>01195             size = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l01196"></a>01196             <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l01197"></a>01197                <span class="keywordflow">break</span>;
<a name="l01198"></a>01198             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l01199"></a>01199             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l01200"></a>01200          } <span class="keywordflow">else</span> {
<a name="l01201"></a>01201             size = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l01202"></a>01202             <span class="keywordflow">if</span> (pbk == NULL)
<a name="l01203"></a>01203                <span class="keywordflow">break</span>;
<a name="l01204"></a>01204             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l01205"></a>01205             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l01206"></a>01206          }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF))
<a name="l01209"></a>01209             size /= <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF);
<a name="l01210"></a>01210 
<a name="l01211"></a>01211          lrs1882 = (<a class="code" href="structLRS1882__DATA.html">LRS1882_DATA</a> *) pdata;
<a name="l01212"></a>01212          lrs1877 = (<a class="code" href="structLRS1877__DATA.html">LRS1877_DATA</a> *) pdata;
<a name="l01213"></a>01213          lrs1877_header = (<a class="code" href="structLRS1877__HEADER.html">LRS1877_HEADER</a> *) pdata;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215          <span class="comment">/* write bank header */</span>
<a name="l01216"></a>01216          *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) name) = bkname;
<a name="l01217"></a>01217 
<a name="l01218"></a>01218          <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == 0)
<a name="l01219"></a>01219             strcpy(type_name, <a class="code" href="group__msectionh.html#ga94fb45fa1cdd442e964ebe32c7668976">rpc_tid_name</a>(bktype &amp; 0xFF));
<a name="l01220"></a>01220          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ae970f1c88e76ada2bcb23a140e27e37c">TID_LRS1882</a>)
<a name="l01221"></a>01221             strcpy(type_name, <span class="stringliteral">&quot;LRS1882&quot;</span>);
<a name="l01222"></a>01222          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#ab4bb71b415e8b5ba35490697817c0415">TID_LRS1877</a>)
<a name="l01223"></a>01223             strcpy(type_name, <span class="stringliteral">&quot;LRS1877&quot;</span>);
<a name="l01224"></a>01224          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((bktype &amp; 0xFF00) == <a class="code" href="hardware_8h.html#a9446e243f13a3078e1237e48543021fd">TID_PCOS3</a>)
<a name="l01225"></a>01225             strcpy(type_name, <span class="stringliteral">&quot;PCOS3&quot;</span>);
<a name="l01226"></a>01226          <span class="keywordflow">else</span>
<a name="l01227"></a>01227             strcpy(type_name, <span class="stringliteral">&quot;unknown&quot;</span>);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229          sprintf(ph, <span class="stringliteral">&quot;%s[%d]\t&quot;</span>, name, size);
<a name="l01230"></a>01230          <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(ph, header_line);
<a name="l01231"></a>01231 
<a name="l01232"></a>01232          <span class="comment">/* write data */</span>
<a name="l01233"></a>01233          <span class="keywordflow">for</span> (i = 0; i &lt; size; i++) {
<a name="l01234"></a>01234             <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pd, pdata, size, i, bktype &amp; 0xFF);
<a name="l01235"></a>01235             strcat(pd, <span class="stringliteral">&quot;\t&quot;</span>);
<a name="l01236"></a>01236             <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pd, data_line);
<a name="l01237"></a>01237          }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239       } <span class="keywordflow">while</span> (1);
<a name="l01240"></a>01240    }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242   <span class="comment">/*---- FIXED format ----------------------------------------------*/</span>
<a name="l01243"></a>01243    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
<a name="l01244"></a>01244       <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a> == 0)
<a name="l01245"></a>01245          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;ascii_write&quot;</span>, <span class="stringliteral">&quot;cannot find event definition&quot;</span>);
<a name="l01246"></a>01246       <span class="keywordflow">else</span> {
<a name="l01247"></a>01247          pdata = (<span class="keywordtype">char</span> *) (pevent + 1);
<a name="l01248"></a>01248          <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01249"></a>01249             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, i, &amp;hKey);
<a name="l01250"></a>01250             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01251"></a>01251                <span class="keywordflow">break</span>;
<a name="l01252"></a>01252 
<a name="l01253"></a>01253             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;key);
<a name="l01254"></a>01254 
<a name="l01255"></a>01255             <span class="comment">/* adjust for alignment */</span>
<a name="l01256"></a>01256             pdata = (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l01257"></a>01257 
<a name="l01258"></a>01258             <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l01259"></a>01259                <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> != last_event_id) {
<a name="l01260"></a>01260                   <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> == 1)
<a name="l01261"></a>01261                      sprintf(ph, <span class="stringliteral">&quot;%s\t&quot;</span>, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01262"></a>01262                   <span class="keywordflow">else</span>
<a name="l01263"></a>01263                      sprintf(ph, <span class="stringliteral">&quot;%s%d\t&quot;</span>, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>, j);
<a name="l01264"></a>01264 
<a name="l01265"></a>01265                   <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(ph, header_line);
<a name="l01266"></a>01266                }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268                <a class="code" href="group__msectionh.html#ga14e4b0190141d168b49e36178705552e">db_sprintf</a>(pd, pdata, key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>, j, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l01269"></a>01269                strcat(pd, <span class="stringliteral">&quot;\t&quot;</span>);
<a name="l01270"></a>01270                <a class="code" href="fal_8c.html#af3dac432eb411d20fb144182a22c1f4e">STR_INC</a>(pd, data_line);
<a name="l01271"></a>01271             }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273             <span class="comment">/* shift data pointer to next item */</span>
<a name="l01274"></a>01274             pdata = (<span class="keywordtype">char</span> *) pdata + key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l01275"></a>01275          }
<a name="l01276"></a>01276       }
<a name="l01277"></a>01277    }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279    <span class="keywordflow">if</span> (*(pd - 1) == <span class="charliteral">&apos;\t&apos;</span>)
<a name="l01280"></a>01280       *(pd - 1) = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l01281"></a>01281 
<a name="l01282"></a>01282    <span class="keywordflow">if</span> (last_event_id != pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>) {
<a name="l01283"></a>01283       <span class="keywordflow">if</span> (*(ph - 1) == <span class="charliteral">&apos;\t&apos;</span>)
<a name="l01284"></a>01284          *(ph - 1) = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l01285"></a>01285       last_event_id = pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>;
<a name="l01286"></a>01286       strcpy(buffer, header_line);
<a name="l01287"></a>01287       strcat(buffer, data_line);
<a name="l01288"></a>01288    } <span class="keywordflow">else</span>
<a name="l01289"></a>01289       strcpy(buffer, data_line);
<a name="l01290"></a>01290 
<a name="l01291"></a>01291    <span class="comment">/* write buffer to device */</span>
<a name="l01292"></a>01292    size = strlen(buffer);
<a name="l01293"></a>01293 
<a name="l01294"></a>01294    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>)
<a name="l01295"></a>01295       status = <a class="code" href="group__msectionh.html#ga2805362dd3e83391691437be277295b7">ss_tape_write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, buffer, size);
<a name="l01296"></a>01296    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>)
<a name="l01297"></a>01297       status = <a class="code" href="ftplib_8h.html#a9ae256b14c27d8f52918f0fcbb92bd1c">ftp_send</a>(((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>)-&gt;data, buffer, size) == size ?
<a name="l01298"></a>01298           <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l01299"></a>01299    <span class="keywordflow">else</span>
<a name="l01300"></a>01300       status = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>, buffer, size) == size ? <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> : <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l01301"></a>01301 
<a name="l01302"></a>01302    <span class="comment">/* update statistics */</span>
<a name="l01303"></a>01303    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#aa314b315e3b535e7442803526c7c515d">events_written</a>++;
<a name="l01304"></a>01304    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a7f50d67aca6cc223a2049e75b67e62f0">bytes_written</a> += size;
<a name="l01305"></a>01305    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a4781a92eaf28c8718c72f092d2cbfcd1">bytes_written_total</a> += size;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307    <span class="keywordflow">return</span> status;
<a name="l01308"></a>01308 }
<a name="l01309"></a>01309 
<a name="l01310"></a>01310 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01311"></a>01311 
<a name="l01312"></a><a class="code" href="fal_8c.html#aadc83f2d85ddfdd626983d8712120f42">01312</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#aadc83f2d85ddfdd626983d8712120f42">ascii_log_open</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l01313"></a>01313 {
<a name="l01314"></a>01314    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01315"></a>01315    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> event;
<a name="l01316"></a>01316 
<a name="l01317"></a>01317    <span class="comment">/* Create device channel */</span>
<a name="l01318"></a>01318    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>) {
<a name="l01319"></a>01319       status = <a class="code" href="fal_8c.html#af3cabceb8b0fa7c888cebccd87848ad5">tape_open</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, &amp;log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l01320"></a>01320       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l01321"></a>01321          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l01322"></a>01322          <span class="keywordflow">return</span> status;
<a name="l01323"></a>01323       }
<a name="l01324"></a>01324    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>) {
<a name="l01325"></a>01325       status = <a class="code" href="fal_8c.html#a63504313b744b5dcd8b3fdc5058696b4">ftp_open</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, (<a class="code" href="structFTP__CON.html">FTP_CON</a> **) (&amp;log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>));
<a name="l01326"></a>01326       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l01327"></a>01327          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l01328"></a>01328          <span class="keywordflow">return</span> status;
<a name="l01329"></a>01329       } <span class="keywordflow">else</span>
<a name="l01330"></a>01330          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 1;
<a name="l01331"></a>01331    } <span class="keywordflow">else</span> {
<a name="l01332"></a>01332       log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = open(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>, O_WRONLY | O_CREAT | O_TRUNC, 0644);
<a name="l01333"></a>01333 
<a name="l01334"></a>01334       <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> &lt; 0) {
<a name="l01335"></a>01335          log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l01336"></a>01336          <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>;
<a name="l01337"></a>01337       }
<a name="l01338"></a>01338    }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340    <span class="comment">/* write ODB dump */</span>
<a name="l01341"></a>01341    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a1d09a907562f29589880b5382a1c7e7a">odb_dump</a>) {
<a name="l01342"></a>01342       <span class="keyword">event</span>.event_id = <a class="code" href="group__mbufferh.html#gaea58a47233f988dd2f9a0320d99734dc">EVENTID_BOR</a>;
<a name="l01343"></a>01343       <span class="keyword">event</span>.data_size = 0;
<a name="l01344"></a>01344       <span class="keyword">event</span>.serial_number = run_number;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346       <a class="code" href="fal_8c.html#a98f3aa146ac98ba330bc03ff6532d7ae">ascii_write</a>(log_chn, &amp;event, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01347"></a>01347    }
<a name="l01348"></a>01348 
<a name="l01349"></a>01349    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l01350"></a>01350 }
<a name="l01351"></a>01351 
<a name="l01352"></a>01352 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01353"></a>01353 
<a name="l01354"></a><a class="code" href="fal_8c.html#ae6a3bef1616f7cd2b120ea84c74fb23a">01354</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#ae6a3bef1616f7cd2b120ea84c74fb23a">ascii_log_close</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l01355"></a>01355 {
<a name="l01356"></a>01356    <span class="comment">/* Write EOF if Tape */</span>
<a name="l01357"></a>01357    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>) {
<a name="l01358"></a>01358       <span class="comment">/* writing EOF mark on tape only */</span>
<a name="l01359"></a>01359       <a class="code" href="group__msectionh.html#gabb63b38780721d675d806d6081ad2f89">ss_tape_write_eof</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l01360"></a>01360       <a class="code" href="group__msectionh.html#ga4a9420e0e9ef8bd23b41f7594bad7395">ss_tape_close</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l01361"></a>01361    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>) {
<a name="l01362"></a>01362       <a class="code" href="ftplib_8h.html#aa29061617ea49f3d5d5412e6a6b9ddea">ftp_close</a>((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>);
<a name="l01363"></a>01363       <a class="code" href="ftplib_8h.html#a7b1c89c618ec6cd6363b7b85644efc97">ftp_bye</a>((<a class="code" href="structFTP__CON.html">FTP_CON</a> *) log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a>);
<a name="l01364"></a>01364    } <span class="keywordflow">else</span>
<a name="l01365"></a>01365       close(log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a>);
<a name="l01366"></a>01366 
<a name="l01367"></a>01367    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l01368"></a>01368 }
<a name="l01369"></a>01369 
<a name="l01370"></a>01370 <span class="comment">/*---- log_open ----------------------------------------------------*/</span>
<a name="l01371"></a>01371 
<a name="l01372"></a><a class="code" href="fal_8c.html#a61eacdcb09d04a7a1145ac7d0238d3ac">01372</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a61eacdcb09d04a7a1145ac7d0238d3ac">log_open</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l01373"></a>01373 {
<a name="l01374"></a>01374    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a0317d1a8cc55f646f9f8bc1d7903e0bc">format</a>, <span class="stringliteral">&quot;YBOS&quot;</span>)) {
<a name="l01377"></a>01377       log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> = <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>;
<a name="l01378"></a>01378       status = <a class="code" href="group__ybosbankc.html#ga177a8b241935710bd285f775e882cfc5">ybos_log_open</a>(log_chn, run_number);
<a name="l01379"></a>01379    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a0317d1a8cc55f646f9f8bc1d7903e0bc">format</a>, <span class="stringliteral">&quot;ASCII&quot;</span>)) {
<a name="l01380"></a>01380       log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> = <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>;
<a name="l01381"></a>01381       status = <a class="code" href="fal_8c.html#aadc83f2d85ddfdd626983d8712120f42">ascii_log_open</a>(log_chn, run_number);
<a name="l01382"></a>01382    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a0317d1a8cc55f646f9f8bc1d7903e0bc">format</a>, <span class="stringliteral">&quot;DUMP&quot;</span>)) {
<a name="l01383"></a>01383       log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> = <a class="code" href="group__mdefineh.html#gaffaf04a985dfa6ff43ab39a8c6e3f0a7">FORMAT_DUMP</a>;
<a name="l01384"></a>01384       status = <a class="code" href="fal_8c.html#ada9b3e2a17f72cd8e3a27c1598794851">dump_log_open</a>(log_chn, run_number);
<a name="l01385"></a>01385    } <span class="keywordflow">else</span> {                     <span class="comment">/* default format is MIDAS */</span>
<a name="l01386"></a>01386 
<a name="l01387"></a>01387       log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> = <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>;
<a name="l01388"></a>01388       status = <a class="code" href="fal_8c.html#af75770c7cb96c72546d92ae41d7fcbf6">midas_log_open</a>(log_chn, run_number);
<a name="l01389"></a>01389    }
<a name="l01390"></a>01390 
<a name="l01391"></a>01391    <span class="keywordflow">return</span> status;
<a name="l01392"></a>01392 }
<a name="l01393"></a>01393 
<a name="l01394"></a>01394 <span class="comment">/*---- log_close ---------------------------------------------------*/</span>
<a name="l01395"></a>01395 
<a name="l01396"></a><a class="code" href="fal_8c.html#a74aaaa49f804300530812095713383b7">01396</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a74aaaa49f804300530812095713383b7">log_close</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>)
<a name="l01397"></a>01397 {
<a name="l01398"></a>01398    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> == <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>)
<a name="l01399"></a>01399       <a class="code" href="group__ybosbankc.html#ga85358224cad220bf19c74ef84e9cad5f">ybos_log_close</a>(log_chn, run_number);
<a name="l01400"></a>01400 
<a name="l01401"></a>01401    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> == <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>)
<a name="l01402"></a>01402       <a class="code" href="fal_8c.html#ae6a3bef1616f7cd2b120ea84c74fb23a">ascii_log_close</a>(log_chn, run_number);
<a name="l01403"></a>01403 
<a name="l01404"></a>01404    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> == <a class="code" href="group__mdefineh.html#gaffaf04a985dfa6ff43ab39a8c6e3f0a7">FORMAT_DUMP</a>)
<a name="l01405"></a>01405       <a class="code" href="fal_8c.html#aee31f72db31c10a2e8e014d0cdfafd44">dump_log_close</a>(log_chn, run_number);
<a name="l01406"></a>01406 
<a name="l01407"></a>01407    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>)
<a name="l01408"></a>01408       <a class="code" href="fal_8c.html#aa66a2f87f89ceda400aa7c8df883356f">midas_log_close</a>(log_chn, run_number);
<a name="l01409"></a>01409 
<a name="l01410"></a>01410    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#ae15702f7b0da23771207d650211ecd9c">files_written</a>++;
<a name="l01411"></a>01411    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a26bc5155f900ea807685871cb360202d">handle</a> = 0;
<a name="l01412"></a>01412    log_chn-&gt;<a class="code" href="structLOG__CHN.html#a6acdb64fa6e2640a8fba22ec631cda7f">ftp_con</a> = NULL;
<a name="l01413"></a>01413 
<a name="l01414"></a>01414    <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l01415"></a>01415 }
<a name="l01416"></a>01416 
<a name="l01417"></a>01417 <span class="comment">/*---- log_write ---------------------------------------------------*/</span>
<a name="l01418"></a>01418 
<a name="l01419"></a><a class="code" href="fal_8c.html#ab757112cc906644f8c9d86fc41627951">01419</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#ab757112cc906644f8c9d86fc41627951">log_write</a>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a> * log_chn, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent)
<a name="l01420"></a>01420 {
<a name="l01421"></a>01421    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a> = 0, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, izero;
<a name="l01422"></a>01422    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>, <a class="code" href="old__mevb_8cpp.html#af4211e1ba0e676018599e88cfae3537a">start_time</a>, watchdog_timeout;
<a name="l01423"></a>01423    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> watchdog_flag, <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l01424"></a>01424    <span class="keyword">static</span> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mevb_8cpp.html#aacd845a847a6b6025d7b3601b5c0f24b">stop_requested</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01425"></a>01425    <span class="keyword">static</span> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> last_checked = 0;
<a name="l01426"></a>01426    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> htape, stats_hkey;
<a name="l01427"></a>01427    <span class="keywordtype">char</span> tape_name[256];
<a name="l01428"></a>01428    <span class="keywordtype">double</span> dzero;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430    start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01431"></a>01431 
<a name="l01432"></a>01432    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> == <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>)
<a name="l01433"></a>01433       status = <a class="code" href="group__ybosbankc.html#ga637115c193856dcf75ee958e690239e8">ybos_write</a>(log_chn, pevent, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01434"></a>01434 
<a name="l01435"></a>01435    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> == <a class="code" href="group__mdefineh.html#gaf900017aedf1bdc7e50fcbf949464e6d">FORMAT_ASCII</a>)
<a name="l01436"></a>01436       status = <a class="code" href="fal_8c.html#a98f3aa146ac98ba330bc03ff6532d7ae">ascii_write</a>(log_chn, pevent, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01437"></a>01437 
<a name="l01438"></a>01438    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> == <a class="code" href="group__mdefineh.html#gaffaf04a985dfa6ff43ab39a8c6e3f0a7">FORMAT_DUMP</a>)
<a name="l01439"></a>01439       status = <a class="code" href="fal_8c.html#a17062c806a84e18c0ff5e8add89f67f0">dump_write</a>(log_chn, pevent, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01440"></a>01440 
<a name="l01441"></a>01441    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#afc899b8a67c7c46d6e8172741a4824ab">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>)
<a name="l01442"></a>01442       status = <a class="code" href="fal_8c.html#a92d60624c2797cbac096ccbac854d1f1">midas_write</a>(log_chn, pevent, pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01443"></a>01443 
<a name="l01444"></a>01444    actual_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01445"></a>01445    <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) actual_time - (<span class="keywordtype">int</span>) start_time &gt; 3000)
<a name="l01446"></a>01446       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;Write operation took %d ms&quot;</span>, actual_time - start_time);
<a name="l01447"></a>01447 
<a name="l01448"></a>01448    <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> &amp;&amp; !stop_requested) {
<a name="l01449"></a>01449       <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#gaba97d9c5175be9b9573f28e2bec7ec9c">SS_IO_ERROR</a>)
<a name="l01450"></a>01450          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;Physical IO error on %s, stopping run&quot;</span>,
<a name="l01451"></a>01451                 log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>);
<a name="l01452"></a>01452       <span class="keywordflow">else</span>
<a name="l01453"></a>01453          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;Error writing to %s, stopping run&quot;</span>, log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>);
<a name="l01454"></a>01454 
<a name="l01455"></a>01455       stop_requested = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01456"></a>01456       <a class="code" href="group__msectionh.html#ga98ba67d921647dab7eb4f00e5dea7ba0">cm_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, 0, NULL, 0, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01457"></a>01457       stop_requested = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01458"></a>01458 
<a name="l01459"></a>01459       <span class="keywordflow">return</span> status;
<a name="l01460"></a>01460    }
<a name="l01461"></a>01461 
<a name="l01462"></a>01462    <span class="comment">/* check if event limit is reached */</span>
<a name="l01463"></a>01463    <span class="keywordflow">if</span> (!stop_requested &amp;&amp; !<a class="code" href="fal_8c.html#a9176ec250a555fff7c2a03cb3d2391c6">in_stop_transition</a> &amp;&amp;
<a name="l01464"></a>01464        log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a580dd52bebb73a31f3b6cf1fd300090a">event_limit</a> &gt; 0 &amp;&amp;
<a name="l01465"></a>01465        log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#aa314b315e3b535e7442803526c7c515d">events_written</a> &gt;= log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a580dd52bebb73a31f3b6cf1fd300090a">event_limit</a>) {
<a name="l01466"></a>01466       stop_requested = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01467"></a>01467 
<a name="l01468"></a>01468       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;stopping run after having received %d events&quot;</span>,
<a name="l01469"></a>01469              log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a580dd52bebb73a31f3b6cf1fd300090a">event_limit</a>);
<a name="l01470"></a>01470 
<a name="l01471"></a>01471       status = <a class="code" href="group__msectionh.html#ga98ba67d921647dab7eb4f00e5dea7ba0">cm_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, 0, NULL, 0, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01472"></a>01472       <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01473"></a>01473          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;cannot stop run after reaching event limit&quot;</span>);
<a name="l01474"></a>01474       stop_requested = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01475"></a>01475 
<a name="l01476"></a>01476       <span class="comment">/* check if autorestart, main loop will take care of it */</span>
<a name="l01477"></a>01477       <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a> = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l01478"></a>01478       flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01479"></a>01479       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Auto restart&quot;</span>, &amp;flag, &amp;<a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01480"></a>01480 
<a name="l01481"></a>01481       <span class="keywordflow">if</span> (flag)
<a name="l01482"></a>01482          <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>() + 20; <span class="comment">/* start in 20 sec. */</span>
<a name="l01483"></a>01483 
<a name="l01484"></a>01484       <span class="keywordflow">return</span> status;
<a name="l01485"></a>01485    }
<a name="l01486"></a>01486 
<a name="l01487"></a>01487    <span class="comment">/* check if byte limit is reached */</span>
<a name="l01488"></a>01488    <span class="keywordflow">if</span> (!stop_requested &amp;&amp; !<a class="code" href="fal_8c.html#a9176ec250a555fff7c2a03cb3d2391c6">in_stop_transition</a> &amp;&amp;
<a name="l01489"></a>01489        log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a64ce514033f6879689348775ebd93049">byte_limit</a> &gt; 0 &amp;&amp;
<a name="l01490"></a>01490        log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a7f50d67aca6cc223a2049e75b67e62f0">bytes_written</a> &gt;= log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#a64ce514033f6879689348775ebd93049">byte_limit</a>) {
<a name="l01491"></a>01491       stop_requested = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01492"></a>01492 
<a name="l01493"></a>01493       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;stopping run after having received %1.0lf mega bytes&quot;</span>,
<a name="l01494"></a>01494              log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a7f50d67aca6cc223a2049e75b67e62f0">bytes_written</a> / 1E6);
<a name="l01495"></a>01495 
<a name="l01496"></a>01496       status = <a class="code" href="group__msectionh.html#ga98ba67d921647dab7eb4f00e5dea7ba0">cm_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, 0, NULL, 0, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01497"></a>01497       <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01498"></a>01498          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;cannot stop run after reaching bytes limit&quot;</span>);
<a name="l01499"></a>01499       stop_requested = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01500"></a>01500 
<a name="l01501"></a>01501       <span class="comment">/* check if autorestart, main loop will take care of it */</span>
<a name="l01502"></a>01502       <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a> = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l01503"></a>01503       flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01504"></a>01504       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Auto restart&quot;</span>, &amp;flag, &amp;<a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01505"></a>01505 
<a name="l01506"></a>01506       <span class="keywordflow">if</span> (flag)
<a name="l01507"></a>01507          <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>() + 20; <span class="comment">/* start in 20 sec. */</span>
<a name="l01508"></a>01508 
<a name="l01509"></a>01509       <span class="keywordflow">return</span> status;
<a name="l01510"></a>01510    }
<a name="l01511"></a>01511 
<a name="l01512"></a>01512    <span class="comment">/* check if capacity is reached for tapes */</span>
<a name="l01513"></a>01513    <span class="keywordflow">if</span> (!stop_requested &amp;&amp; !<a class="code" href="fal_8c.html#a9176ec250a555fff7c2a03cb3d2391c6">in_stop_transition</a> &amp;&amp;
<a name="l01514"></a>01514        log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a> &amp;&amp;
<a name="l01515"></a>01515        log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#aea3ef09116f58b9b432e04c1b4ba3672">tape_capacity</a> &gt; 0 &amp;&amp;
<a name="l01516"></a>01516        log_chn-&gt;<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a4781a92eaf28c8718c72f092d2cbfcd1">bytes_written_total</a> &gt;= log_chn-&gt;<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>.<a class="code" href="structCHN__SETTINGS.html#aea3ef09116f58b9b432e04c1b4ba3672">tape_capacity</a>) {
<a name="l01517"></a>01517       stop_requested = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01518"></a>01518       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;tape capacity reached, stopping run&quot;</span>);
<a name="l01519"></a>01519 
<a name="l01520"></a>01520       <span class="comment">/* remember tape name */</span>
<a name="l01521"></a>01521       strcpy(tape_name, log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>);
<a name="l01522"></a>01522       stats_hkey = log_chn-&gt;<a class="code" href="structLOG__CHN.html#aa20ff984fa9388e584863f10281c26f6">stats_hkey</a>;
<a name="l01523"></a>01523 
<a name="l01524"></a>01524       status = <a class="code" href="group__msectionh.html#ga98ba67d921647dab7eb4f00e5dea7ba0">cm_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, 0, NULL, 0, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01525"></a>01525       <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01526"></a>01526          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;cannot stop run after reaching tape capacity&quot;</span>);
<a name="l01527"></a>01527       stop_requested = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01528"></a>01528 
<a name="l01529"></a>01529       <span class="comment">/* rewind tape */</span>
<a name="l01530"></a>01530       <a class="code" href="group__msectionh.html#gad5ba805f539d5dd8d3248cf52ec6b510">ss_tape_open</a>(tape_name, O_RDONLY, &amp;htape);
<a name="l01531"></a>01531       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;rewinding tape %s, please wait&quot;</span>, log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>);
<a name="l01532"></a>01532 
<a name="l01533"></a>01533       <a class="code" href="group__msectionh.html#ga324df07c9a3003f1d1ce41e0fa51539e">cm_get_watchdog_params</a>(&amp;watchdog_flag, &amp;watchdog_timeout);
<a name="l01534"></a>01534       <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(watchdog_flag, 300000);    <span class="comment">/* 5 min for tape rewind */</span>
<a name="l01535"></a>01535       <a class="code" href="group__msectionh.html#gab152ff20030ae5bd6d553709e10a1b1c">ss_tape_unmount</a>(htape);
<a name="l01536"></a>01536       <a class="code" href="group__msectionh.html#ga4a9420e0e9ef8bd23b41f7594bad7395">ss_tape_close</a>(htape);
<a name="l01537"></a>01537       <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(watchdog_flag, watchdog_timeout);
<a name="l01538"></a>01538 
<a name="l01539"></a>01539       <span class="comment">/* zero statistics */</span>
<a name="l01540"></a>01540       dzero = izero = 0;
<a name="l01541"></a>01541       <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, stats_hkey, <span class="stringliteral">&quot;Bytes written total&quot;</span>, &amp;dzero,
<a name="l01542"></a>01542                    <span class="keyword">sizeof</span>(dzero), 1, <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>);
<a name="l01543"></a>01543       <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, stats_hkey, <span class="stringliteral">&quot;Files written&quot;</span>, &amp;izero, <span class="keyword">sizeof</span>(izero), 1, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;Please insert new tape and start new run.&quot;</span>);
<a name="l01546"></a>01546 
<a name="l01547"></a>01547       <span class="keywordflow">return</span> status;
<a name="l01548"></a>01548    }
<a name="l01549"></a>01549 
<a name="l01550"></a>01550    <span class="comment">/* stop run if less than 10MB free disk space */</span>
<a name="l01551"></a>01551    actual_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l01552"></a>01552    <span class="keywordflow">if</span> (log_chn-&gt;<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> == <a class="code" href="group__msystemincludecode.html#ga20f4ff7cce85df2eb7ead9718d5961ba">LOG_TYPE_DISK</a> &amp;&amp; actual_time - last_checked &gt; 1000) {
<a name="l01553"></a>01553       last_checked = actual_time;
<a name="l01554"></a>01554 
<a name="l01555"></a>01555       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga20c42d723b154e7b7915151178b2cef7">ss_disk_free</a>(log_chn-&gt;<a class="code" href="structLOG__CHN.html#ae426f54fc6146abc9fcd49a9767e9c84">path</a>) &lt; 1E7 &amp;&amp; !stop_requested &amp;&amp; !<a class="code" href="fal_8c.html#a9176ec250a555fff7c2a03cb3d2391c6">in_stop_transition</a>) {
<a name="l01556"></a>01556          stop_requested = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01557"></a>01557          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;disk nearly full, stopping run&quot;</span>);
<a name="l01558"></a>01558 
<a name="l01559"></a>01559          status = <a class="code" href="group__msectionh.html#ga98ba67d921647dab7eb4f00e5dea7ba0">cm_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, 0, NULL, 0, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01560"></a>01560          <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l01561"></a>01561             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;log_write&quot;</span>, <span class="stringliteral">&quot;cannot stop run after reaching byte limit&quot;</span>);
<a name="l01562"></a>01562          stop_requested = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01563"></a>01563       }
<a name="l01564"></a>01564    }
<a name="l01565"></a>01565 
<a name="l01566"></a>01566    <span class="keywordflow">return</span> status;
<a name="l01567"></a>01567 }
<a name="l01568"></a>01568 
<a name="l01569"></a>01569 <span class="comment">/*---- open_history ------------------------------------------------*/</span>
<a name="l01570"></a>01570 
<a name="l01571"></a>01571 <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a05b0c6345a0f2c6d73b1edf8bd91f3ca">log_history</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="keywordtype">void</span> *info);
<a name="l01572"></a>01572 
<a name="l01573"></a><a class="code" href="fal_8c.html#a8727d1a82d030403d6074654a6996814">01573</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a8727d1a82d030403d6074654a6996814">open_history</a>()
<a name="l01574"></a>01574 {
<a name="l01575"></a>01575    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, i_tag, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, li, max_event_id;
<a name="l01576"></a>01576    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> n_var, n_tags, n_names = 0;
<a name="l01577"></a>01577    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hKeyRoot, <a class="code" href="fal_8c.html#a93d13d4a80b9fb8ab8d7e9cbec8f99e9">hKeyVar</a>, hKeyNames, hLinkKey, hVarKey, hKeyEq, hHistKey, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l01578"></a>01578    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="cmdedit_8c.html#a27cb7dcef6f2c86f4853a452f5cd2bf8">history</a>;
<a name="l01579"></a>01579    <a class="code" href="structTAG.html">TAG</a> *<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>;
<a name="l01580"></a>01580    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>, varkey, linkkey, histkey;
<a name="l01581"></a>01581    <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l01582"></a>01582    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256], eq_name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>], hist_name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>];
<a name="l01583"></a>01583    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> single_names;
<a name="l01584"></a>01584 
<a name="l01585"></a>01585    <span class="comment">/* set direcotry for history files */</span>
<a name="l01586"></a>01586    size = <span class="keyword">sizeof</span>(str);
<a name="l01587"></a>01587    str[0] = 0;
<a name="l01588"></a>01588    status = <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/History Dir&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01589"></a>01589    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01590"></a>01590       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Data Dir&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01591"></a>01591 
<a name="l01592"></a>01592    <span class="keywordflow">if</span> (str[0] != 0)
<a name="l01593"></a>01593       <a class="code" href="group__msectionh.html#gac14a8c94ad64cfa991efae443a21c17d">hs_set_path</a>(str);
<a name="l01594"></a>01594 
<a name="l01595"></a>01595    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/History/Links&quot;</span>, &amp;hKeyRoot) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01596"></a>01596       <span class="comment">/* create default history keys */</span>
<a name="l01597"></a>01597       <a class="code" href="group__msectionh.html#ga1441e5b7ca1923cf8611f920cf2c31b4">db_create_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/History/Links&quot;</span>, <a class="code" href="group__mdefineh.html#ga15ae151ae0b7588b3327bd8451d9bcb8">TID_KEY</a>);
<a name="l01598"></a>01598 
<a name="l01599"></a>01599       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Equipment/Trigger/Statistics/Events per sec.&quot;</span>, &amp;hKeyEq) ==
<a name="l01600"></a>01600           <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01601"></a>01601          <a class="code" href="group__msectionh.html#gac6e142751750225721f5d11753ef931b">db_create_link</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/History/Links/System/Trigger per sec.&quot;</span>,
<a name="l01602"></a>01602                         <span class="stringliteral">&quot;/Equipment/Trigger/Statistics/Events per sec.&quot;</span>);
<a name="l01603"></a>01603 
<a name="l01604"></a>01604       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Equipment/Trigger/Statistics/kBytes per sec.&quot;</span>, &amp;hKeyEq) ==
<a name="l01605"></a>01605           <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01606"></a>01606          <a class="code" href="group__msectionh.html#gac6e142751750225721f5d11753ef931b">db_create_link</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/History/Links/System/Trigger kB per sec.&quot;</span>,
<a name="l01607"></a>01607                         <span class="stringliteral">&quot;/Equipment/Trigger/Statistics/kBytes per sec.&quot;</span>);
<a name="l01608"></a>01608    }
<a name="l01609"></a>01609 
<a name="l01610"></a>01610 
<a name="l01611"></a>01611   <span class="comment">/*---- define equipment events as history ------------------------*/</span>
<a name="l01612"></a>01612 
<a name="l01613"></a>01613    max_event_id = 0;
<a name="l01614"></a>01614 
<a name="l01615"></a>01615    status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Equipment&quot;</span>, &amp;hKeyRoot);
<a name="l01616"></a>01616    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01617"></a>01617       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>, <span class="stringliteral">&quot;Cannot find Equipment entry in database&quot;</span>);
<a name="l01618"></a>01618       <span class="keywordflow">return</span> 0;
<a name="l01619"></a>01619    }
<a name="l01620"></a>01620 
<a name="l01621"></a>01621    <span class="comment">/* loop over equipment */</span>
<a name="l01622"></a>01622    <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="cmdedit_8c.html#abf8d8994f09509f9e061f5bf82daf4cd">MAX_HISTORY</a>; index++) {
<a name="l01623"></a>01623       status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, index, &amp;hKeyEq);
<a name="l01624"></a>01624       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01625"></a>01625          <span class="keywordflow">break</span>;
<a name="l01626"></a>01626 
<a name="l01627"></a>01627       <span class="comment">/* check history flag */</span>
<a name="l01628"></a>01628       size = <span class="keyword">sizeof</span>(history);
<a name="l01629"></a>01629       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyEq, <span class="stringliteral">&quot;Common/Log history&quot;</span>, &amp;history, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01630"></a>01630 
<a name="l01631"></a>01631       <span class="comment">/* define history tags only if log history flag is on */</span>
<a name="l01632"></a>01632       <span class="keywordflow">if</span> (history &gt; 0) {
<a name="l01633"></a>01633          <span class="comment">/* get equipment name */</span>
<a name="l01634"></a>01634          <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyEq, &amp;key);
<a name="l01635"></a>01635          strcpy(eq_name, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01636"></a>01636 
<a name="l01637"></a>01637          status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyEq, <span class="stringliteral">&quot;Variables&quot;</span>, &amp;hKeyVar);
<a name="l01638"></a>01638          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01639"></a>01639             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>,
<a name="l01640"></a>01640                    <span class="stringliteral">&quot;Cannot find /Equipment/%s/Variables entry in database&quot;</span>, eq_name);
<a name="l01641"></a>01641             <span class="keywordflow">return</span> 0;
<a name="l01642"></a>01642          }
<a name="l01643"></a>01643 
<a name="l01644"></a>01644          size = <span class="keyword">sizeof</span>(event_id);
<a name="l01645"></a>01645          <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyEq, <span class="stringliteral">&quot;Common/Event ID&quot;</span>, &amp;event_id, &amp;size, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01646"></a>01646 
<a name="l01647"></a>01647          <span class="comment">/* count keys in variables tree */</span>
<a name="l01648"></a>01648          <span class="keywordflow">for</span> (n_var = 0, n_tags = 0;; n_var++) {
<a name="l01649"></a>01649             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyVar, n_var, &amp;hKey);
<a name="l01650"></a>01650             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01651"></a>01651                <span class="keywordflow">break</span>;
<a name="l01652"></a>01652             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;key);
<a name="l01653"></a>01653             n_tags += key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l01654"></a>01654          }
<a name="l01655"></a>01655 
<a name="l01656"></a>01656          <span class="keywordflow">if</span> (n_var == 0)
<a name="l01657"></a>01657             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>, <span class="stringliteral">&quot;defined event %d with no variables in ODB&quot;</span>,
<a name="l01658"></a>01658                    event_id);
<a name="l01659"></a>01659 
<a name="l01660"></a>01660          <span class="comment">/* create tag array */</span>
<a name="l01661"></a>01661          tag = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>) * n_tags);
<a name="l01662"></a>01662 
<a name="l01663"></a>01663          <span class="keywordflow">for</span> (i = 0, i_tag = 0;; i++) {
<a name="l01664"></a>01664             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyVar, i, &amp;hKey);
<a name="l01665"></a>01665             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01666"></a>01666                <span class="keywordflow">break</span>;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668             <span class="comment">/* get variable key */</span>
<a name="l01669"></a>01669             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;varkey);
<a name="l01670"></a>01670 
<a name="l01671"></a>01671             <span class="comment">/* look for names */</span>
<a name="l01672"></a>01672             <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyEq, <span class="stringliteral">&quot;Settings/Names&quot;</span>, &amp;hKeyNames);
<a name="l01673"></a>01673             single_names = (hKeyNames &gt; 0);
<a name="l01674"></a>01674             <span class="keywordflow">if</span> (hKeyNames) {
<a name="l01675"></a>01675                <span class="comment">/* define tags from names list */</span>
<a name="l01676"></a>01676                <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyNames, &amp;key);
<a name="l01677"></a>01677                n_names = key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l01678"></a>01678             } <span class="keywordflow">else</span> {
<a name="l01679"></a>01679                sprintf(str, <span class="stringliteral">&quot;Settings/Names %s&quot;</span>, varkey.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01680"></a>01680                <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyEq, str, &amp;hKeyNames);
<a name="l01681"></a>01681                <span class="keywordflow">if</span> (hKeyNames) {
<a name="l01682"></a>01682                   <span class="comment">/* define tags from names list */</span>
<a name="l01683"></a>01683                   <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyNames, &amp;key);
<a name="l01684"></a>01684                   n_names = key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l01685"></a>01685                }
<a name="l01686"></a>01686             }
<a name="l01687"></a>01687 
<a name="l01688"></a>01688             <span class="keywordflow">if</span> (hKeyNames &amp;&amp; varkey.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> &gt; n_names)
<a name="l01689"></a>01689                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>,
<a name="l01690"></a>01690                       <span class="stringliteral">&quot;/Equipment/%s/Settings/%s contains only %d entries&quot;</span>, eq_name,
<a name="l01691"></a>01691                       key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>, n_names);
<a name="l01692"></a>01692 
<a name="l01693"></a>01693             <span class="keywordflow">if</span> (hKeyNames) {
<a name="l01694"></a>01694                <span class="comment">/* loop over array elements */</span>
<a name="l01695"></a>01695                <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l01696"></a>01696                   <span class="comment">/* get name #j */</span>
<a name="l01697"></a>01697                   size = <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>;
<a name="l01698"></a>01698                   <a class="code" href="group__msectionh.html#gae5fdb22d30254c06d074236a1f93b0d6">db_get_data_index</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyNames, tag[i_tag].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, &amp;size, j,
<a name="l01699"></a>01699                                     <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>);
<a name="l01700"></a>01700 
<a name="l01701"></a>01701                   <span class="comment">/* append variable key name for single name array */</span>
<a name="l01702"></a>01702                   <span class="keywordflow">if</span> (single_names) {
<a name="l01703"></a>01703                      <span class="keywordflow">if</span> (strlen(tag[i_tag].name) + 1 + strlen(varkey.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>) &gt;= <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>) {
<a name="l01704"></a>01704                         <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>,
<a name="l01705"></a>01705                                <span class="stringliteral">&quot;Name for history entry \&quot;%s %s\&quot; too long&quot;</span>,
<a name="l01706"></a>01706                                tag[i_tag].name, varkey.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01707"></a>01707                         free(tag);
<a name="l01708"></a>01708                         <span class="keywordflow">return</span> 0;
<a name="l01709"></a>01709                      }
<a name="l01710"></a>01710                      strcat(tag[i_tag].name, <span class="stringliteral">&quot; &quot;</span>);
<a name="l01711"></a>01711                      strcat(tag[i_tag].name, varkey.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01712"></a>01712                   }
<a name="l01713"></a>01713 
<a name="l01714"></a>01714                   tag[i_tag].<a class="code" href="group__midasincludecode.html#ga3fdedadca645679ef114cc651a978d17">type</a> = varkey.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>;
<a name="l01715"></a>01715                   tag[i_tag].<a class="code" href="group__midasincludecode.html#gaec010a11e0792b46f71ba64fae6f44e8">n_data</a> = 1;
<a name="l01716"></a>01716                   i_tag++;
<a name="l01717"></a>01717                }
<a name="l01718"></a>01718             } <span class="keywordflow">else</span> {
<a name="l01719"></a>01719                strcpy(tag[i_tag].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, varkey.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01720"></a>01720                tag[i_tag].<a class="code" href="group__midasincludecode.html#ga3fdedadca645679ef114cc651a978d17">type</a> = varkey.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>;
<a name="l01721"></a>01721                tag[i_tag].<a class="code" href="group__midasincludecode.html#gaec010a11e0792b46f71ba64fae6f44e8">n_data</a> = varkey.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l01722"></a>01722                i_tag++;
<a name="l01723"></a>01723             }
<a name="l01724"></a>01724          }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726          <a class="code" href="group__msectionh.html#ga45f115952fa24a5a71345f2b57821aec">hs_define_event</a>(event_id, eq_name, tag, <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>) * i_tag);
<a name="l01727"></a>01727          free(tag);
<a name="l01728"></a>01728 
<a name="l01729"></a>01729          <span class="comment">/* setup hist_log structure for this event */</span>
<a name="l01730"></a>01730          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].event_id = event_id;
<a name="l01731"></a>01731          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].hKeyVar = hKeyVar;
<a name="l01732"></a>01732          <a class="code" href="group__msectionh.html#ga1880903c0ebb0d58809f48f6b2d59704">db_get_record_size</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyVar, 0, &amp;size);
<a name="l01733"></a>01733          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].buffer_size = size;
<a name="l01734"></a>01734          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].buffer = malloc(size);
<a name="l01735"></a>01735          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].period = history;
<a name="l01736"></a>01736          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].last_log = 0;
<a name="l01737"></a>01737          <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> == NULL) {
<a name="l01738"></a>01738             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>, <span class="stringliteral">&quot;cannot allocate history buffer&quot;</span>);
<a name="l01739"></a>01739             <span class="keywordflow">return</span> 0;
<a name="l01740"></a>01740          }
<a name="l01741"></a>01741 
<a name="l01742"></a>01742          <span class="comment">/* open hot link to variables */</span>
<a name="l01743"></a>01743          status = <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyVar, <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>,
<a name="l01744"></a>01744                                  size, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="fal_8c.html#a05b0c6345a0f2c6d73b1edf8bd91f3ca">log_history</a>, NULL);
<a name="l01745"></a>01745          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01746"></a>01746             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>,
<a name="l01747"></a>01747                    <span class="stringliteral">&quot;cannot open variable record for history logging&quot;</span>);
<a name="l01748"></a>01748 
<a name="l01749"></a>01749          <span class="comment">/* remember maximum event id for later use with system events */</span>
<a name="l01750"></a>01750          <span class="keywordflow">if</span> (event_id &gt; max_event_id)
<a name="l01751"></a>01751             max_event_id = event_id;
<a name="l01752"></a>01752       } <span class="keywordflow">else</span> {
<a name="l01753"></a>01753          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].event_id = 0;
<a name="l01754"></a>01754          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].hKeyVar = 0;
<a name="l01755"></a>01755          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].buffer = NULL;
<a name="l01756"></a>01756          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].buffer_size = 0;
<a name="l01757"></a>01757          <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].period = 0;
<a name="l01758"></a>01758       }
<a name="l01759"></a>01759    }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761    <span class="keywordflow">if</span> (index == MAX_HISTORY) {
<a name="l01762"></a>01762       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>, <span class="stringliteral">&quot;too many equipments for history&quot;</span>);
<a name="l01763"></a>01763       <span class="keywordflow">return</span> 0;
<a name="l01764"></a>01764    }
<a name="l01765"></a>01765 
<a name="l01766"></a>01766   <span class="comment">/*---- define linked trees ---------------------------------------*/</span>
<a name="l01767"></a>01767 
<a name="l01768"></a>01768    <span class="comment">/* round up event id */</span>
<a name="l01769"></a>01769    max_event_id = ((int) ((max_event_id + 1) / 10) + 1) * 10;
<a name="l01770"></a>01770 
<a name="l01771"></a>01771    status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/History/Links&quot;</span>, &amp;hKeyRoot);
<a name="l01772"></a>01772    <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01773"></a>01773       <span class="keywordflow">for</span> (li = 0;; li++) {
<a name="l01774"></a>01774          status = <a class="code" href="group__msectionh.html#gae10d6bf5633a77eb2c837ee27e3eca98">db_enum_link</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, li, &amp;hHistKey);
<a name="l01775"></a>01775          <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01776"></a>01776             <span class="keywordflow">break</span>;
<a name="l01777"></a>01777 
<a name="l01778"></a>01778          <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hHistKey, &amp;histkey);
<a name="l01779"></a>01779          strcpy(hist_name, histkey.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01780"></a>01780          <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, li, &amp;hHistKey);
<a name="l01781"></a>01781 
<a name="l01782"></a>01782          <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hHistKey, &amp;key);
<a name="l01783"></a>01783          <span class="keywordflow">if</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> != <a class="code" href="group__mdefineh.html#ga15ae151ae0b7588b3327bd8451d9bcb8">TID_KEY</a>) {
<a name="l01784"></a>01784             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>, <span class="stringliteral">&quot;Only subkeys allows in /history/links&quot;</span>);
<a name="l01785"></a>01785             <span class="keywordflow">continue</span>;
<a name="l01786"></a>01786          }
<a name="l01787"></a>01787 
<a name="l01788"></a>01788          <span class="comment">/* count subkeys in link */</span>
<a name="l01789"></a>01789          <span class="keywordflow">for</span> (i = n_var = 0;; i++) {
<a name="l01790"></a>01790             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hHistKey, i, &amp;hKey);
<a name="l01791"></a>01791             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01792"></a>01792                <span class="keywordflow">break</span>;
<a name="l01793"></a>01793             <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;key) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01794"></a>01794                <span class="keywordflow">if</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> != <a class="code" href="group__mdefineh.html#ga15ae151ae0b7588b3327bd8451d9bcb8">TID_KEY</a>)
<a name="l01795"></a>01795                   n_var++;
<a name="l01796"></a>01796             } <span class="keywordflow">else</span> {
<a name="l01797"></a>01797                <a class="code" href="group__msectionh.html#gae10d6bf5633a77eb2c837ee27e3eca98">db_enum_link</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hHistKey, i, &amp;hKey);
<a name="l01798"></a>01798                <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;key);
<a name="l01799"></a>01799                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>,
<a name="l01800"></a>01800                       <span class="stringliteral">&quot;History link /History/Links/%s/%s is invalid&quot;</span>, hist_name,
<a name="l01801"></a>01801                       key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01802"></a>01802             }
<a name="l01803"></a>01803          }
<a name="l01804"></a>01804 
<a name="l01805"></a>01805          <span class="keywordflow">if</span> (n_var == 0)
<a name="l01806"></a>01806             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>, <span class="stringliteral">&quot;History event %s has no variables in ODB&quot;</span>,
<a name="l01807"></a>01807                    hist_name);
<a name="l01808"></a>01808          <span class="keywordflow">else</span> {
<a name="l01809"></a>01809             <span class="comment">/* create tag array */</span>
<a name="l01810"></a>01810             tag = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>) * n_var);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812             <span class="keywordflow">for</span> (i = 0, size = 0, n_var = 0;; i++) {
<a name="l01813"></a>01813                status = <a class="code" href="group__msectionh.html#gae10d6bf5633a77eb2c837ee27e3eca98">db_enum_link</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hHistKey, i, &amp;hLinkKey);
<a name="l01814"></a>01814                <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01815"></a>01815                   <span class="keywordflow">break</span>;
<a name="l01816"></a>01816 
<a name="l01817"></a>01817                <span class="comment">/* get link key */</span>
<a name="l01818"></a>01818                <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hLinkKey, &amp;linkkey);
<a name="l01819"></a>01819 
<a name="l01820"></a>01820                <span class="keywordflow">if</span> (linkkey.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> == <a class="code" href="group__mdefineh.html#ga15ae151ae0b7588b3327bd8451d9bcb8">TID_KEY</a>)
<a name="l01821"></a>01821                   <span class="keywordflow">continue</span>;
<a name="l01822"></a>01822 
<a name="l01823"></a>01823                <span class="comment">/* get link target */</span>
<a name="l01824"></a>01824                <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hHistKey, i, &amp;hVarKey);
<a name="l01825"></a>01825                <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hVarKey, &amp;varkey) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01826"></a>01826                   <span class="comment">/* hot-link individual values */</span>
<a name="l01827"></a>01827                   <span class="keywordflow">if</span> (histkey.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> == <a class="code" href="group__mdefineh.html#ga15ae151ae0b7588b3327bd8451d9bcb8">TID_KEY</a>)
<a name="l01828"></a>01828                      <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hVarKey, NULL, varkey.<a class="code" href="group__midasincludecode.html#ga553ba6fe87ca0b1dd08bcdc8fa15e6fa">total_size</a>, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>,
<a name="l01829"></a>01829                                     <a class="code" href="fal_8c.html#a5c2e39bc0d4c7f4d2a6dfdcf70fd2f03">log_system_history</a>, (<span class="keywordtype">void</span> *) index);
<a name="l01830"></a>01830 
<a name="l01831"></a>01831                   strcpy(tag[n_var].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, linkkey.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l01832"></a>01832                   tag[n_var].<a class="code" href="group__midasincludecode.html#ga3fdedadca645679ef114cc651a978d17">type</a> = varkey.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>;
<a name="l01833"></a>01833                   tag[n_var].<a class="code" href="group__midasincludecode.html#gaec010a11e0792b46f71ba64fae6f44e8">n_data</a> = varkey.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l01834"></a>01834                   size += varkey.<a class="code" href="group__midasincludecode.html#ga553ba6fe87ca0b1dd08bcdc8fa15e6fa">total_size</a>;
<a name="l01835"></a>01835                   n_var++;
<a name="l01836"></a>01836                }
<a name="l01837"></a>01837             }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839             <span class="comment">/* hot-link whole subtree */</span>
<a name="l01840"></a>01840             <span class="keywordflow">if</span> (histkey.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> == <a class="code" href="group__mdefineh.html#gaa63f41f547c7f46f828aaf35073807ea">TID_LINK</a>)
<a name="l01841"></a>01841                <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hHistKey, NULL, size, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="fal_8c.html#a5c2e39bc0d4c7f4d2a6dfdcf70fd2f03">log_system_history</a>,
<a name="l01842"></a>01842                               (<span class="keywordtype">void</span> *) index);
<a name="l01843"></a>01843 
<a name="l01844"></a>01844             <a class="code" href="group__msectionh.html#ga45f115952fa24a5a71345f2b57821aec">hs_define_event</a>(max_event_id, hist_name, tag, <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>) * n_var);
<a name="l01845"></a>01845             free(tag);
<a name="l01846"></a>01846 
<a name="l01847"></a>01847             <span class="comment">/* define system history */</span>
<a name="l01848"></a>01848 
<a name="l01849"></a>01849             <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].event_id = max_event_id;
<a name="l01850"></a>01850             <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].hKeyVar = hHistKey;
<a name="l01851"></a>01851             <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].buffer_size = size;
<a name="l01852"></a>01852             <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].buffer = malloc(size);
<a name="l01853"></a>01853             <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].period = 10;        <span class="comment">/* 10 sec default period */</span>
<a name="l01854"></a>01854             <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].last_log = 0;
<a name="l01855"></a>01855             <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> == NULL) {
<a name="l01856"></a>01856                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>, <span class="stringliteral">&quot;cannot allocate history buffer&quot;</span>);
<a name="l01857"></a>01857                <span class="keywordflow">return</span> 0;
<a name="l01858"></a>01858             }
<a name="l01859"></a>01859 
<a name="l01860"></a>01860             index++;
<a name="l01861"></a>01861             max_event_id++;
<a name="l01862"></a>01862 
<a name="l01863"></a>01863             <span class="keywordflow">if</span> (index == MAX_HISTORY) {
<a name="l01864"></a>01864                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;open_history&quot;</span>, <span class="stringliteral">&quot;too many equipments for history&quot;</span>);
<a name="l01865"></a>01865                <span class="keywordflow">return</span> 0;
<a name="l01866"></a>01866             }
<a name="l01867"></a>01867          }
<a name="l01868"></a>01868       }
<a name="l01869"></a>01869    }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871   <span class="comment">/*---- define run start/stop event -------------------------------*/</span>
<a name="l01872"></a>01872 
<a name="l01873"></a>01873    tag = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>) * 2);
<a name="l01874"></a>01874 
<a name="l01875"></a>01875    strcpy(tag[0].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, <span class="stringliteral">&quot;State&quot;</span>);
<a name="l01876"></a>01876    tag[0].<a class="code" href="group__midasincludecode.html#ga3fdedadca645679ef114cc651a978d17">type</a> = <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>;
<a name="l01877"></a>01877    tag[0].<a class="code" href="group__midasincludecode.html#gaec010a11e0792b46f71ba64fae6f44e8">n_data</a> = 1;
<a name="l01878"></a>01878 
<a name="l01879"></a>01879    strcpy(tag[1].name, <span class="stringliteral">&quot;Run number&quot;</span>);
<a name="l01880"></a>01880    tag[1].<a class="code" href="group__midasincludecode.html#ga3fdedadca645679ef114cc651a978d17">type</a> = <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>;
<a name="l01881"></a>01881    tag[1].<a class="code" href="group__midasincludecode.html#gaec010a11e0792b46f71ba64fae6f44e8">n_data</a> = 1;
<a name="l01882"></a>01882 
<a name="l01883"></a>01883    <a class="code" href="group__msectionh.html#ga45f115952fa24a5a71345f2b57821aec">hs_define_event</a>(0, <span class="stringliteral">&quot;Run transitions&quot;</span>, tag, <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>) * 2);
<a name="l01884"></a>01884    free(tag);
<a name="l01885"></a>01885 
<a name="l01886"></a>01886    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l01887"></a>01887 }
<a name="l01888"></a>01888 
<a name="l01889"></a>01889 <span class="comment">/*---- close_history -----------------------------------------------*/</span>
<a name="l01890"></a>01890 
<a name="l01891"></a><a class="code" href="fal_8c.html#a47956ca76e86a1e107f5c4f1b7c8399a">01891</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a47956ca76e86a1e107f5c4f1b7c8399a">close_history</a>()
<a name="l01892"></a>01892 {
<a name="l01893"></a>01893    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l01894"></a>01894    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hKeyRoot, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l01895"></a>01895 
<a name="l01896"></a>01896    <span class="comment">/* close system history */</span>
<a name="l01897"></a>01897    status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/History/Links&quot;</span>, &amp;hKeyRoot);
<a name="l01898"></a>01898    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01899"></a>01899       <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01900"></a>01900          status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, i, &amp;hKey);
<a name="l01901"></a>01901          <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01902"></a>01902             <span class="keywordflow">break</span>;
<a name="l01903"></a>01903          <a class="code" href="group__msectionh.html#gae60eb33ad37ee9a9ce1cbc872db2fb19">db_close_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey);
<a name="l01904"></a>01904       }
<a name="l01905"></a>01905    }
<a name="l01906"></a>01906 
<a name="l01907"></a>01907    <span class="comment">/* close event history */</span>
<a name="l01908"></a>01908    <span class="keywordflow">for</span> (i = 1; i &lt; <a class="code" href="cmdedit_8c.html#abf8d8994f09509f9e061f5bf82daf4cd">MAX_HISTORY</a>; i++)
<a name="l01909"></a>01909       <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].<a class="code" href="fal_8c.html#a93d13d4a80b9fb8ab8d7e9cbec8f99e9">hKeyVar</a>) {
<a name="l01910"></a>01910          <a class="code" href="group__msectionh.html#gae60eb33ad37ee9a9ce1cbc872db2fb19">db_close_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].hKeyVar);
<a name="l01911"></a>01911          free(<a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>);
<a name="l01912"></a>01912       }
<a name="l01913"></a>01913 }
<a name="l01914"></a>01914 
<a name="l01915"></a>01915 <span class="comment">/*---- log_history -------------------------------------------------*/</span>
<a name="l01916"></a>01916 
<a name="l01917"></a><a class="code" href="fal_8c.html#a05b0c6345a0f2c6d73b1edf8bd91f3ca">01917</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a05b0c6345a0f2c6d73b1edf8bd91f3ca">log_history</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="keywordtype">void</span> *info)
<a name="l01918"></a>01918 {
<a name="l01919"></a>01919    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l01920"></a>01920 
<a name="l01921"></a>01921    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="cmdedit_8c.html#abf8d8994f09509f9e061f5bf82daf4cd">MAX_HISTORY</a>; i++)
<a name="l01922"></a>01922       <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].<a class="code" href="fal_8c.html#a93d13d4a80b9fb8ab8d7e9cbec8f99e9">hKeyVar</a> == hKey)
<a name="l01923"></a>01923          <span class="keywordflow">break</span>;
<a name="l01924"></a>01924 
<a name="l01925"></a>01925    <span class="keywordflow">if</span> (i == MAX_HISTORY)
<a name="l01926"></a>01926       <span class="keywordflow">return</span>;
<a name="l01927"></a>01927 
<a name="l01928"></a>01928    <span class="comment">/* check if over period */</span>
<a name="l01929"></a>01929    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>() - <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].<a class="code" href="fal_8c.html#add96ecae43fa55c909fd3dcad0b0a8b1">last_log</a> &lt; <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].<a class="code" href="fal_8c.html#aa774945e642ada0ff3e539dc76863dff">period</a>)
<a name="l01930"></a>01930       <span class="keywordflow">return</span>;
<a name="l01931"></a>01931 
<a name="l01932"></a>01932    <span class="comment">/* check if event size has changed */</span>
<a name="l01933"></a>01933    <a class="code" href="group__msectionh.html#ga1880903c0ebb0d58809f48f6b2d59704">db_get_record_size</a>(hDB, hKey, 0, &amp;size);
<a name="l01934"></a>01934    <span class="keywordflow">if</span> (size != <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].<a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>) {
<a name="l01935"></a>01935       <a class="code" href="fal_8c.html#a47956ca76e86a1e107f5c4f1b7c8399a">close_history</a>();
<a name="l01936"></a>01936       <a class="code" href="fal_8c.html#a8727d1a82d030403d6074654a6996814">open_history</a>();
<a name="l01937"></a>01937    }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939    <a class="code" href="group__msectionh.html#ga607ef6f6ef2f547c09f05a5a7fe4c3d6">hs_write_event</a>(<a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>, <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>, <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].buffer_size);
<a name="l01940"></a>01940    <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[i].last_log = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>();
<a name="l01941"></a>01941 }
<a name="l01942"></a>01942 
<a name="l01943"></a>01943 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01944"></a>01944 
<a name="l01945"></a><a class="code" href="fal_8c.html#a5c2e39bc0d4c7f4d2a6dfdcf70fd2f03">01945</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a5c2e39bc0d4c7f4d2a6dfdcf70fd2f03">log_system_history</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="keywordtype">void</span> *info)
<a name="l01946"></a>01946 {
<a name="l01947"></a>01947    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, total_size, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>;
<a name="l01948"></a>01948    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l01949"></a>01949 
<a name="l01950"></a>01950    index = (int) info;
<a name="l01951"></a>01951 
<a name="l01952"></a>01952    <span class="comment">/* check if over period */</span>
<a name="l01953"></a>01953    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>() - <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].last_log &lt; <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].period)
<a name="l01954"></a>01954       <span class="keywordflow">return</span>;
<a name="l01955"></a>01955 
<a name="l01956"></a>01956    <span class="keywordflow">for</span> (i = 0, total_size = 0;; i++) {
<a name="l01957"></a>01957       status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(hDB, <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].<a class="code" href="fal_8c.html#a93d13d4a80b9fb8ab8d7e9cbec8f99e9">hKeyVar</a>, i, &amp;hKey);
<a name="l01958"></a>01958       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01959"></a>01959          <span class="keywordflow">break</span>;
<a name="l01960"></a>01960 
<a name="l01961"></a>01961       <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(hDB, hKey, &amp;key);
<a name="l01962"></a>01962       size = key.<a class="code" href="group__midasincludecode.html#ga553ba6fe87ca0b1dd08bcdc8fa15e6fa">total_size</a>;
<a name="l01963"></a>01963       <a class="code" href="group__msectionh.html#gad6e53374f24813cdba8713781683c556">db_get_data</a>(hDB, hKey, (<span class="keywordtype">char</span> *) <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> + total_size, &amp;size,
<a name="l01964"></a>01964                   key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l01965"></a>01965       total_size += size;
<a name="l01966"></a>01966    }
<a name="l01967"></a>01967 
<a name="l01968"></a>01968    <span class="keywordflow">if</span> (total_size != <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].<a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a>) {
<a name="l01969"></a>01969       <a class="code" href="fal_8c.html#a47956ca76e86a1e107f5c4f1b7c8399a">close_history</a>();
<a name="l01970"></a>01970       <a class="code" href="fal_8c.html#a8727d1a82d030403d6074654a6996814">open_history</a>();
<a name="l01971"></a>01971    } <span class="keywordflow">else</span>
<a name="l01972"></a>01972       <a class="code" href="group__msectionh.html#ga607ef6f6ef2f547c09f05a5a7fe4c3d6">hs_write_event</a>(<a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>, <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>,
<a name="l01973"></a>01973                      <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].buffer_size);
<a name="l01974"></a>01974 
<a name="l01975"></a>01975    <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].last_log = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>();
<a name="l01976"></a>01976 
<a name="l01977"></a>01977    <span class="comment">/* simulate odb key update for hot links connected to system history */</span>
<a name="l01978"></a>01978    <a class="code" href="group__msystemincludecode.html#ga36d6ddcac8565e1bdf03339e326ddfae">db_lock_database</a>(hDB);
<a name="l01979"></a>01979    <a class="code" href="group__msystemincludecode.html#ga0c3d7756b3aef21bf263467cdcb317f0">db_notify_clients</a>(hDB, <a class="code" href="fal_8c.html#a426b3e146893fc61110c3f1494bbbacd">hist_log</a>[index].<a class="code" href="fal_8c.html#a93d13d4a80b9fb8ab8d7e9cbec8f99e9">hKeyVar</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01980"></a>01980    <a class="code" href="group__msystemincludecode.html#ga8a0b7defad9995ffae2bb915b068239b">db_unlock_database</a>(hDB);
<a name="l01981"></a>01981 
<a name="l01982"></a>01982 }
<a name="l01983"></a>01983 
<a name="l01984"></a>01984 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01985"></a>01985 
<a name="l01986"></a><a class="code" href="fal_8c.html#afc00b48c6ecb0997ffbaff2d5913b376">01986</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#afc00b48c6ecb0997ffbaff2d5913b376">log_callback</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <span class="keywordtype">void</span> *prpc_param[])
<a name="l01987"></a>01987 {
<a name="l01988"></a>01988    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hKeyRoot, hKeyChannel;
<a name="l01989"></a>01989    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="ADCS_8h.html#adf7dff2c57c0da9a4a2b70e3e815be31">channel</a>, izero, htape, online_mode;
<a name="l01990"></a>01990    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> watchdog_timeout;
<a name="l01991"></a>01991    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> watchdog_flag;
<a name="l01992"></a>01992    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l01993"></a>01993    <span class="keywordtype">double</span> dzero;
<a name="l01994"></a>01994 
<a name="l01995"></a>01995    <span class="comment">/* rewind tapes */</span>
<a name="l01996"></a>01996    <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#gaaeb6f7b0868c6c7cf033e4da7c3ebf2d">RPC_LOG_REWIND</a>) {
<a name="l01997"></a>01997       channel = *((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) prpc_param[0]);
<a name="l01998"></a>01998 
<a name="l01999"></a>01999       <span class="comment">/* loop over all channels */</span>
<a name="l02000"></a>02000       status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Channels&quot;</span>, &amp;hKeyRoot);
<a name="l02001"></a>02001       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02002"></a>02002          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;log_callback&quot;</span>, <span class="stringliteral">&quot;cannot find Logger/Channels entry in database&quot;</span>);
<a name="l02003"></a>02003          <span class="keywordflow">return</span> 0;
<a name="l02004"></a>02004       }
<a name="l02005"></a>02005 
<a name="l02006"></a>02006       <span class="comment">/* check online mode */</span>
<a name="l02007"></a>02007       online_mode = 0;
<a name="l02008"></a>02008       size = <span class="keyword">sizeof</span>(online_mode);
<a name="l02009"></a>02009       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/online mode&quot;</span>, &amp;online_mode, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02010"></a>02010 
<a name="l02011"></a>02011       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="evb_2mevb_8h.html#ac69ee46f4a51ed14f0d68628c2dec71d">MAX_CHANNELS</a>; i++) {
<a name="l02012"></a>02012          status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, i, &amp;hKeyChannel);
<a name="l02013"></a>02013          <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l02014"></a>02014             <span class="keywordflow">break</span>;
<a name="l02015"></a>02015 
<a name="l02016"></a>02016          <span class="comment">/* skip if wrong channel, -1 means rewind all channels */</span>
<a name="l02017"></a>02017          <span class="keywordflow">if</span> (channel != i &amp;&amp; channel != -1)
<a name="l02018"></a>02018             <span class="keywordflow">continue</span>;
<a name="l02019"></a>02019 
<a name="l02020"></a>02020          <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02021"></a>02021             size = <span class="keyword">sizeof</span>(str);
<a name="l02022"></a>02022             status =
<a name="l02023"></a>02023                 <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyChannel, <span class="stringliteral">&quot;Settings/Type&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>,
<a name="l02024"></a>02024                              <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02025"></a>02025             <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l02026"></a>02026                <span class="keywordflow">continue</span>;
<a name="l02027"></a>02027 
<a name="l02028"></a>02028             <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, <span class="stringliteral">&quot;Tape&quot;</span>)) {
<a name="l02029"></a>02029                size = <span class="keyword">sizeof</span>(str);
<a name="l02030"></a>02030                status =
<a name="l02031"></a>02031                    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyChannel, <span class="stringliteral">&quot;Settings/Filename&quot;</span>, str, &amp;size,
<a name="l02032"></a>02032                                 <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02033"></a>02033                <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l02034"></a>02034                   <span class="keywordflow">continue</span>;
<a name="l02035"></a>02035 
<a name="l02036"></a>02036                <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gad5ba805f539d5dd8d3248cf52ec6b510">ss_tape_open</a>(str, O_RDONLY, &amp;htape) == <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l02037"></a>02037                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_callback&quot;</span>, <span class="stringliteral">&quot;rewinding tape #%d, please wait&quot;</span>, i);
<a name="l02038"></a>02038 
<a name="l02039"></a>02039                   <a class="code" href="group__msectionh.html#ga324df07c9a3003f1d1ce41e0fa51539e">cm_get_watchdog_params</a>(&amp;watchdog_flag, &amp;watchdog_timeout);
<a name="l02040"></a>02040                   <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(watchdog_flag, 300000);        <span class="comment">/* 5 min for tape rewind */</span>
<a name="l02041"></a>02041                   <a class="code" href="group__msectionh.html#ga493f9641265c59b47706b5d6ca98f52f">ss_tape_rewind</a>(htape);
<a name="l02042"></a>02042                   <span class="keywordflow">if</span> (online_mode)
<a name="l02043"></a>02043                      <a class="code" href="group__msectionh.html#gab152ff20030ae5bd6d553709e10a1b1c">ss_tape_unmount</a>(htape);
<a name="l02044"></a>02044                   <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(watchdog_flag, watchdog_timeout);
<a name="l02045"></a>02045 
<a name="l02046"></a>02046                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;log_callback&quot;</span>, <span class="stringliteral">&quot;Tape %s rewound sucessfully&quot;</span>, str);
<a name="l02047"></a>02047                } <span class="keywordflow">else</span>
<a name="l02048"></a>02048                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;log_callback&quot;</span>, <span class="stringliteral">&quot;Cannot rewind tape %s&quot;</span>, str);
<a name="l02049"></a>02049 
<a name="l02050"></a>02050                <a class="code" href="group__msectionh.html#ga4a9420e0e9ef8bd23b41f7594bad7395">ss_tape_close</a>(htape);
<a name="l02051"></a>02051 
<a name="l02052"></a>02052                <span class="comment">/* clear statistics */</span>
<a name="l02053"></a>02053                dzero = izero = 0;
<a name="l02054"></a>02054                log_chn[i].<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a4781a92eaf28c8718c72f092d2cbfcd1">bytes_written_total</a> = 0;
<a name="l02055"></a>02055                log_chn[i].<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#ae15702f7b0da23771207d650211ecd9c">files_written</a> = 0;
<a name="l02056"></a>02056                <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyChannel, <span class="stringliteral">&quot;Statistics/Bytes written total&quot;</span>, &amp;dzero,
<a name="l02057"></a>02057                             <span class="keyword">sizeof</span>(dzero), 1, <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>);
<a name="l02058"></a>02058                <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyChannel, <span class="stringliteral">&quot;Statistics/Files written&quot;</span>, &amp;izero,
<a name="l02059"></a>02059                             <span class="keyword">sizeof</span>(izero), 1, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l02060"></a>02060             }
<a name="l02061"></a>02061          }
<a name="l02062"></a>02062       }
<a name="l02063"></a>02063 
<a name="l02064"></a>02064       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;log_callback&quot;</span>, <span class="stringliteral">&quot;tape rewind finished&quot;</span>);
<a name="l02065"></a>02065    }
<a name="l02066"></a>02066 
<a name="l02067"></a>02067    <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>;
<a name="l02068"></a>02068 }
<a name="l02069"></a>02069 
<a name="l02070"></a>02070 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l02071"></a>02071 
<a name="l02072"></a>02072 <span class="comment">/********************************************************************\</span>
<a name="l02073"></a>02073 <span class="comment"></span>
<a name="l02074"></a>02074 <span class="comment">                         transition callbacks</span>
<a name="l02075"></a>02075 <span class="comment"></span>
<a name="l02076"></a>02076 <span class="comment">\********************************************************************/</span>
<a name="l02077"></a>02077 
<a name="l02078"></a>02078 <span class="keyword">struct </span>{
<a name="l02079"></a><a class="code" href="fal_8c.html#aed2a9a6c57de716dc564331cca8f0a85">02079</a>    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="fal_8c.html#aed2a9a6c57de716dc564331cca8f0a85">transition</a>;
<a name="l02080"></a>02080    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>;
<a name="l02081"></a>02081 } <a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>;
<a name="l02082"></a>02082 
<a name="l02083"></a>02083 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l02084"></a>02084 
<a name="l02085"></a><a class="code" href="fal_8c.html#a57d8732229dddafb0b75bab10325c12b">02085</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a57d8732229dddafb0b75bab10325c12b">tr_start1</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error)
<a name="l02086"></a>02086 <span class="comment">/********************************************************************\</span>
<a name="l02087"></a>02087 <span class="comment"></span>
<a name="l02088"></a>02088 <span class="comment">   Prestart:</span>
<a name="l02089"></a>02089 <span class="comment"></span>
<a name="l02090"></a>02090 <span class="comment">     Loop through channels defined in /logger/channels.</span>
<a name="l02091"></a>02091 <span class="comment">     Neglect channels with are not active.</span>
<a name="l02092"></a>02092 <span class="comment">     If &quot;filename&quot; contains a &quot;%&quot;, substitute it by the</span>
<a name="l02093"></a>02093 <span class="comment">     current run number. Open logging channel and</span>
<a name="l02094"></a>02094 <span class="comment">     corresponding buffer. Place a event request</span>
<a name="l02095"></a>02095 <span class="comment">     into the buffer.</span>
<a name="l02096"></a>02096 <span class="comment"></span>
<a name="l02097"></a>02097 <span class="comment">\********************************************************************/</span>
<a name="l02098"></a>02098 {
<a name="l02099"></a>02099    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l02100"></a>02100    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hKeyRoot, hKeyChannel;
<a name="l02101"></a>02101    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256], path[256], dir[256];
<a name="l02102"></a>02102    <a class="code" href="structCHN__SETTINGS.html">CHN_SETTINGS</a> *chn_settings;
<a name="l02103"></a>02103    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l02104"></a>02104    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> write_data, tape_flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02105"></a>02105 
<a name="l02106"></a>02106    <span class="comment">/* save current ODB */</span>
<a name="l02107"></a>02107    <a class="code" href="fal_8c.html#acf9c7de88cba31c73350482f73f50253">odb_save</a>(<span class="stringliteral">&quot;last.odb&quot;</span>);
<a name="l02108"></a>02108 
<a name="l02109"></a>02109    <span class="comment">/* read global logging flag */</span>
<a name="l02110"></a>02110    size = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l02111"></a>02111    write_data = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02112"></a>02112    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Write data&quot;</span>, &amp;write_data, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02113"></a>02113 
<a name="l02114"></a>02114    <span class="comment">/* read tape message flag */</span>
<a name="l02115"></a>02115    size = <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a93ff70131906aede2a2802753ec682ef">tape_message</a>);
<a name="l02116"></a>02116    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Tape message&quot;</span>, &amp;<a class="code" href="fal_8c.html#a93ff70131906aede2a2802753ec682ef">tape_message</a>, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02117"></a>02117 
<a name="l02118"></a>02118    <span class="comment">/* loop over all channels */</span>
<a name="l02119"></a>02119    status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Channels&quot;</span>, &amp;hKeyRoot);
<a name="l02120"></a>02120    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02121"></a>02121       <span class="comment">/* if no channels are defined, define at least one */</span>
<a name="l02122"></a>02122       status = <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Channels/0/&quot;</span>, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(chn_settings_str));
<a name="l02123"></a>02123       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02124"></a>02124          strcpy(error, <span class="stringliteral">&quot;Cannot create channel entry in database&quot;</span>);
<a name="l02125"></a>02125          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02126"></a>02126          <span class="keywordflow">return</span> 0;
<a name="l02127"></a>02127       }
<a name="l02128"></a>02128 
<a name="l02129"></a>02129       status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Channels&quot;</span>, &amp;hKeyRoot);
<a name="l02130"></a>02130       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02131"></a>02131          strcpy(error, <span class="stringliteral">&quot;Cannot create channel entry in database&quot;</span>);
<a name="l02132"></a>02132          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02133"></a>02133          <span class="keywordflow">return</span> 0;
<a name="l02134"></a>02134       }
<a name="l02135"></a>02135    }
<a name="l02136"></a>02136 
<a name="l02137"></a>02137    <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="evb_2mevb_8h.html#ac69ee46f4a51ed14f0d68628c2dec71d">MAX_CHANNELS</a>; index++) {
<a name="l02138"></a>02138       status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, index, &amp;hKeyChannel);
<a name="l02139"></a>02139       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l02140"></a>02140          <span class="keywordflow">break</span>;
<a name="l02141"></a>02141 
<a name="l02142"></a>02142       <span class="comment">/* correct channel record */</span>
<a name="l02143"></a>02143       <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyChannel, &amp;key);
<a name="l02144"></a>02144       status = <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(chn_settings_str));
<a name="l02145"></a>02145       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a> &amp;&amp; status != <a class="code" href="group__err23.html#gacfc6bca00bde3af90d259cb4ae98deb0">DB_OPEN_RECORD</a>) {
<a name="l02146"></a>02146          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, <span class="stringliteral">&quot;Cannot create channel record&quot;</span>);
<a name="l02147"></a>02147          <span class="keywordflow">break</span>;
<a name="l02148"></a>02148       }
<a name="l02149"></a>02149 
<a name="l02150"></a>02150       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a> || status == <a class="code" href="group__err23.html#gacfc6bca00bde3af90d259cb4ae98deb0">DB_OPEN_RECORD</a>) {
<a name="l02151"></a>02151          <span class="comment">/* check if channel is already open */</span>
<a name="l02152"></a>02152          <span class="keywordflow">if</span> (log_chn[index].<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a> || log_chn[index].ftp_con)
<a name="l02153"></a>02153             <span class="keywordflow">continue</span>;
<a name="l02154"></a>02154 
<a name="l02155"></a>02155          <span class="comment">/* save settings key */</span>
<a name="l02156"></a>02156          status =
<a name="l02157"></a>02157              <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyChannel, <span class="stringliteral">&quot;Settings&quot;</span>, &amp;log_chn[index].settings_hkey);
<a name="l02158"></a>02158          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02159"></a>02159             strcpy(error, <span class="stringliteral">&quot;Cannot find channel settings info&quot;</span>);
<a name="l02160"></a>02160             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02161"></a>02161             <span class="keywordflow">return</span> 0;
<a name="l02162"></a>02162          }
<a name="l02163"></a>02163 
<a name="l02164"></a>02164          <span class="comment">/* save statistics key */</span>
<a name="l02165"></a>02165          status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyChannel, <span class="stringliteral">&quot;Statistics&quot;</span>, &amp;log_chn[index].stats_hkey);
<a name="l02166"></a>02166          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02167"></a>02167             strcpy(error, <span class="stringliteral">&quot;Cannot find channel statistics info&quot;</span>);
<a name="l02168"></a>02168             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02169"></a>02169             <span class="keywordflow">return</span> 0;
<a name="l02170"></a>02170          }
<a name="l02171"></a>02171 
<a name="l02172"></a>02172          <span class="comment">/* clear statistics */</span>
<a name="l02173"></a>02173          size = <span class="keyword">sizeof</span>(<a class="code" href="structCHN__STATISTICS.html">CHN_STATISTICS</a>);
<a name="l02174"></a>02174          <a class="code" href="group__msectionh.html#gaae4cf88eaadf5d2dd9eefa3e1b6389e6">db_get_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, log_chn[index].stats_hkey, &amp;log_chn[index].statistics, &amp;size,
<a name="l02175"></a>02175                        0);
<a name="l02176"></a>02176 
<a name="l02177"></a>02177          log_chn[index].<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#aa314b315e3b535e7442803526c7c515d">events_written</a> = 0;
<a name="l02178"></a>02178          log_chn[index].<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a7f50d67aca6cc223a2049e75b67e62f0">bytes_written</a> = 0;
<a name="l02179"></a>02179 
<a name="l02180"></a>02180          <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, log_chn[index].stats_hkey, &amp;log_chn[index].statistics, size,
<a name="l02181"></a>02181                        0);
<a name="l02182"></a>02182 
<a name="l02183"></a>02183          <span class="comment">/* get channel info structure */</span>
<a name="l02184"></a>02184          chn_settings = &amp;log_chn[index].<a class="code" href="structLOG__CHN.html#af8e431056b3e56f6f5ce7bba5c879501">settings</a>;
<a name="l02185"></a>02185          size = <span class="keyword">sizeof</span>(<a class="code" href="structCHN__SETTINGS.html">CHN_SETTINGS</a>);
<a name="l02186"></a>02186          status =
<a name="l02187"></a>02187              <a class="code" href="group__msectionh.html#gaae4cf88eaadf5d2dd9eefa3e1b6389e6">db_get_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, log_chn[index].settings_hkey, chn_settings, &amp;size, 0);
<a name="l02188"></a>02188          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02189"></a>02189             strcpy(error, <span class="stringliteral">&quot;Cannot read channel info&quot;</span>);
<a name="l02190"></a>02190             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02191"></a>02191             <span class="keywordflow">return</span> 0;
<a name="l02192"></a>02192          }
<a name="l02193"></a>02193 
<a name="l02194"></a>02194          <span class="comment">/* don&apos;t start run if tape is full */</span>
<a name="l02195"></a>02195          <span class="keywordflow">if</span> (log_chn[index].<a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a> &amp;&amp;
<a name="l02196"></a>02196              chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#aea3ef09116f58b9b432e04c1b4ba3672">tape_capacity</a> &gt; 0 &amp;&amp;
<a name="l02197"></a>02197              log_chn[index].<a class="code" href="structLOG__CHN.html#a74c443424ba397c8fc17bcd8244bd9e7">statistics</a>.<a class="code" href="structCHN__STATISTICS.html#a4781a92eaf28c8718c72f092d2cbfcd1">bytes_written_total</a> &gt;= chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#aea3ef09116f58b9b432e04c1b4ba3672">tape_capacity</a>)
<a name="l02198"></a>02198          {
<a name="l02199"></a>02199             strcpy(error, <span class="stringliteral">&quot;Tape capacity reached. Please load new tape&quot;</span>);
<a name="l02200"></a>02200             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02201"></a>02201             <span class="keywordflow">return</span> 0;
<a name="l02202"></a>02202          }
<a name="l02203"></a>02203 
<a name="l02204"></a>02204          <span class="comment">/* check if active */</span>
<a name="l02205"></a>02205          <span class="keywordflow">if</span> (!chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#a31fa5da7e6a57c007052a5088d9068b0">active</a> || !write_data)
<a name="l02206"></a>02206             <span class="keywordflow">continue</span>;
<a name="l02207"></a>02207 
<a name="l02208"></a>02208          <span class="comment">/* check for type */</span>
<a name="l02209"></a>02209          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#a31d67c6b375c371bfbd627ef53cb5f26">type</a>, <span class="stringliteral">&quot;Tape&quot;</span>))
<a name="l02210"></a>02210             log_chn[index].<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> = <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a>;
<a name="l02211"></a>02211          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#a31d67c6b375c371bfbd627ef53cb5f26">type</a>, <span class="stringliteral">&quot;FTP&quot;</span>))
<a name="l02212"></a>02212             log_chn[index].<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> = <a class="code" href="group__msystemincludecode.html#gaa18802ee020f5a7982b073821978e9eb">LOG_TYPE_FTP</a>;
<a name="l02213"></a>02213          <span class="keywordflow">else</span>
<a name="l02214"></a>02214             log_chn[index].<a class="code" href="structLOG__CHN.html#abd99304e1de6ca4edf76ac8a9e4134a9">type</a> = <a class="code" href="group__msystemincludecode.html#ga20f4ff7cce85df2eb7ead9718d5961ba">LOG_TYPE_DISK</a>;
<a name="l02215"></a>02215 
<a name="l02216"></a>02216          <span class="comment">/* if disk, precede filename with directory if not already there */</span>
<a name="l02217"></a>02217          <span class="keywordflow">if</span> (log_chn[index].<a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a> == <a class="code" href="group__msystemincludecode.html#ga20f4ff7cce85df2eb7ead9718d5961ba">LOG_TYPE_DISK</a> &amp;&amp;
<a name="l02218"></a>02218              strchr(chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#a510b652d0be1c98579f2d208f8ad5add">filename</a>, <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>) == NULL) {
<a name="l02219"></a>02219             size = <span class="keyword">sizeof</span>(dir);
<a name="l02220"></a>02220             dir[0] = 0;
<a name="l02221"></a>02221             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Data Dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02222"></a>02222             <span class="keywordflow">if</span> (dir[0] != 0)
<a name="l02223"></a>02223                <span class="keywordflow">if</span> (dir[strlen(dir) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l02224"></a>02224                   strcat(dir, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l02225"></a>02225             strcpy(str, dir);
<a name="l02226"></a>02226          } <span class="keywordflow">else</span>
<a name="l02227"></a>02227             str[0] = 0;
<a name="l02228"></a>02228          strcat(str, chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#a510b652d0be1c98579f2d208f8ad5add">filename</a>);
<a name="l02229"></a>02229 
<a name="l02230"></a>02230          <span class="comment">/* substitue &quot;%d&quot; by current run number */</span>
<a name="l02231"></a>02231          <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>))
<a name="l02232"></a>02232             sprintf(path, str, run_number);
<a name="l02233"></a>02233          <span class="keywordflow">else</span>
<a name="l02234"></a>02234             strcpy(path, str);
<a name="l02235"></a>02235 
<a name="l02236"></a>02236          strcpy(log_chn[index].path, path);
<a name="l02237"></a>02237 
<a name="l02238"></a>02238          <span class="keywordflow">if</span> (log_chn[index].<a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a> &amp;&amp;
<a name="l02239"></a>02239              log_chn[index].statistics.bytes_written_total == 0 &amp;&amp; <a class="code" href="fal_8c.html#a93ff70131906aede2a2802753ec682ef">tape_message</a>) {
<a name="l02240"></a>02240             tape_flag = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02241"></a>02241             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, <span class="stringliteral">&quot;mounting tape #%d, please wait&quot;</span>, index);
<a name="l02242"></a>02242          }
<a name="l02243"></a>02243 
<a name="l02244"></a>02244          <span class="comment">/* open logging channel */</span>
<a name="l02245"></a>02245          status = <a class="code" href="fal_8c.html#a61eacdcb09d04a7a1145ac7d0238d3ac">log_open</a>(&amp;log_chn[index], run_number);
<a name="l02246"></a>02246 
<a name="l02247"></a>02247          <span class="comment">/* return if logging channel couldn&apos;t be opened */</span>
<a name="l02248"></a>02248          <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l02249"></a>02249             <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga25ab2ae4b1702824549b8e40a6e86718">SS_FILE_ERROR</a>)
<a name="l02250"></a>02250                sprintf(error, <span class="stringliteral">&quot;cannot open file %s (Disk full?)&quot;</span>, path);
<a name="l02251"></a>02251             <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga252be9bba4cc9d08025559dc495aca6b">SS_FILE_EXISTS</a>)
<a name="l02252"></a>02252                sprintf(error, <span class="stringliteral">&quot;file %s exists already, run start aborted&quot;</span>, path);
<a name="l02253"></a>02253             <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga9ac796b5448c9009c8135524ab4ede4e">SS_NO_TAPE</a>)
<a name="l02254"></a>02254                sprintf(error, <span class="stringliteral">&quot;no tape in device %s&quot;</span>, path);
<a name="l02255"></a>02255             <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#ga1271b2092f57a1f2eab374deb5aa20e0">SS_TAPE_ERROR</a>)
<a name="l02256"></a>02256                sprintf(error, <span class="stringliteral">&quot;tape error, cannot start run&quot;</span>);
<a name="l02257"></a>02257             <span class="keywordflow">if</span> (status == <a class="code" href="group__err24.html#gab33c355e9ba39a4bc024efc9c3bfdbbe">SS_DEV_BUSY</a>)
<a name="l02258"></a>02258                sprintf(error, <span class="stringliteral">&quot;device %s used by someone else&quot;</span>, path);
<a name="l02259"></a>02259             <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#gaad8d88aaaaaa3706732a8a5aa00a6723">FTP_NET_ERROR</a> || status == <a class="code" href="group__err26.html#ga7f2618f2babfbc3f2fbd27523c218a1e">FTP_RESPONSE_ERROR</a>)
<a name="l02260"></a>02260                sprintf(error, <span class="stringliteral">&quot;cannot open FTP channel to [%s]&quot;</span>, path);
<a name="l02261"></a>02261 
<a name="l02262"></a>02262             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02263"></a>02263             <span class="keywordflow">return</span> 0;
<a name="l02264"></a>02264          }
<a name="l02265"></a>02265 
<a name="l02266"></a>02266          <span class="comment">/* open hot link to statistics tree */</span>
<a name="l02267"></a>02267          status =
<a name="l02268"></a>02268              <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, log_chn[index].stats_hkey, &amp;log_chn[index].statistics,
<a name="l02269"></a>02269                             <span class="keyword">sizeof</span>(<a class="code" href="structCHN__STATISTICS.html">CHN_STATISTICS</a>), <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a>, NULL, NULL);
<a name="l02270"></a>02270          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l02271"></a>02271             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>,
<a name="l02272"></a>02272                    <span class="stringliteral">&quot;cannot open statistics record, probably other logger is using it&quot;</span>);
<a name="l02273"></a>02273 
<a name="l02274"></a>02274          <span class="comment">/* open hot link to settings tree */</span>
<a name="l02275"></a>02275          status =
<a name="l02276"></a>02276              <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, log_chn[index].settings_hkey, &amp;log_chn[index].settings,
<a name="l02277"></a>02277                             <span class="keyword">sizeof</span>(<a class="code" href="structCHN__SETTINGS.html">CHN_SETTINGS</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL);
<a name="l02278"></a>02278          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l02279"></a>02279             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>,
<a name="l02280"></a>02280                    <span class="stringliteral">&quot;cannot open channel settings record, probably other logger is using it&quot;</span>);
<a name="l02281"></a>02281 
<a name="l02282"></a>02282 <span class="preprocessor">#ifndef FAL_MAIN</span>
<a name="l02283"></a>02283 <span class="preprocessor"></span>         <span class="comment">/* open buffer */</span>
<a name="l02284"></a>02284          status =
<a name="l02285"></a>02285              <a class="code" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer</a>(chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#af30fae8a95f831b1e39da76b1e57648d">buffer</a>, <a class="code" href="group__midasincludecode.html#gacc4dda1aaabc9862fe79fd94e0b722bf">EVENT_BUFFER_SIZE</a>,
<a name="l02286"></a>02286                             &amp;log_chn[index].<a class="code" href="structLOG__CHN.html#ac992c82de9d6b07926e39fb1352b8e04">buffer_handle</a>);
<a name="l02287"></a>02287          <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a> &amp;&amp; status != <a class="code" href="group__err22.html#gaf4d0ec9887b0864c100b8062d21f4c0b">BM_CREATED</a>) {
<a name="l02288"></a>02288             sprintf(error, <span class="stringliteral">&quot;Cannot open buffer %s&quot;</span>, str);
<a name="l02289"></a>02289             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02290"></a>02290             <span class="keywordflow">return</span> 0;
<a name="l02291"></a>02291          }
<a name="l02292"></a>02292          <a class="code" href="group__msectionh.html#ga3d70a1e1e38b6ccf6bde4bc5b436ae5b">bm_set_cache_size</a>(log_chn[index].buffer_handle, 100000, 0);
<a name="l02293"></a>02293 
<a name="l02294"></a>02294          <span class="comment">/* place event request */</span>
<a name="l02295"></a>02295          status = <a class="code" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event</a>(log_chn[index].buffer_handle,
<a name="l02296"></a>02296                                    (<span class="keywordtype">short</span>) chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#a26be66de6cf35eb487c828e78a7503dc">event_id</a>,
<a name="l02297"></a>02297                                    (<span class="keywordtype">short</span>) chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#a083392b4aa77d4fcb1206abffd35d24e">trigger_mask</a>,
<a name="l02298"></a>02298                                    <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>, &amp;log_chn[index].<a class="code" href="structLOG__CHN.html#a7d491a45095196a152b8a3c7d01c394d">request_id</a>, <a class="code" href="fal_8c.html#a54200266ef010a58dcf76468aadace0b">receive_event</a>);
<a name="l02299"></a>02299 
<a name="l02300"></a>02300          <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>) {
<a name="l02301"></a>02301             sprintf(error, <span class="stringliteral">&quot;Cannot place event request&quot;</span>);
<a name="l02302"></a>02302             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02303"></a>02303             <span class="keywordflow">return</span> 0;
<a name="l02304"></a>02304          }
<a name="l02305"></a>02305 
<a name="l02306"></a>02306          <span class="comment">/* open message buffer if requested */</span>
<a name="l02307"></a>02307          <span class="keywordflow">if</span> (chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#aa8548111d879396c231ed8dea63558ef">log_messages</a>) {
<a name="l02308"></a>02308             status =
<a name="l02309"></a>02309                 <a class="code" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer</a>(<a class="code" href="group__msystemincludecode.html#ga3e96ef463ffa93f97bbbd2a7d652668e">MESSAGE_BUFFER_NAME</a>, <a class="code" href="group__msystemincludecode.html#ga69e73620bd8f14313137ac04cf571477">MESSAGE_BUFFER_SIZE</a>,
<a name="l02310"></a>02310                                &amp;log_chn[index].msg_buffer_handle);
<a name="l02311"></a>02311             <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a> &amp;&amp; status != <a class="code" href="group__err22.html#gaf4d0ec9887b0864c100b8062d21f4c0b">BM_CREATED</a>) {
<a name="l02312"></a>02312                sprintf(error, <span class="stringliteral">&quot;Cannot open buffer %s&quot;</span>, <a class="code" href="group__msystemincludecode.html#ga3e96ef463ffa93f97bbbd2a7d652668e">MESSAGE_BUFFER_NAME</a>);
<a name="l02313"></a>02313                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02314"></a>02314                <span class="keywordflow">return</span> 0;
<a name="l02315"></a>02315             }
<a name="l02316"></a>02316 
<a name="l02317"></a>02317             <span class="comment">/* place event request */</span>
<a name="l02318"></a>02318             status = <a class="code" href="group__msectionh.html#ga10c1d7f3486ab4ab4ee58a95bb98e820">bm_request_event</a>(log_chn[index].msg_buffer_handle,
<a name="l02319"></a>02319                                       (<span class="keywordtype">short</span>) <a class="code" href="group__mbufferh.html#ga7fefe6ad78331e8cfb3d2b31dbfdd2d0">EVENTID_MESSAGE</a>,
<a name="l02320"></a>02320                                       (<span class="keywordtype">short</span>) chn_settings-&gt;<a class="code" href="structCHN__SETTINGS.html#aa8548111d879396c231ed8dea63558ef">log_messages</a>,
<a name="l02321"></a>02321                                       <a class="code" href="group__mdefineh.html#ga16218704fdf35f7624064c9d1d4bc78f">GET_ALL</a>, &amp;log_chn[index].<a class="code" href="structLOG__CHN.html#a507f677739d642069a92349947e5ce6a">msg_request_id</a>,
<a name="l02322"></a>02322                                       <a class="code" href="fal_8c.html#a54200266ef010a58dcf76468aadace0b">receive_event</a>);
<a name="l02323"></a>02323 
<a name="l02324"></a>02324             <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>) {
<a name="l02325"></a>02325                sprintf(error, <span class="stringliteral">&quot;Cannot place event request&quot;</span>);
<a name="l02326"></a>02326                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, error);
<a name="l02327"></a>02327                <span class="keywordflow">return</span> 0;
<a name="l02328"></a>02328             }
<a name="l02329"></a>02329          }
<a name="l02330"></a>02330 <span class="preprocessor">#endif</span>
<a name="l02331"></a>02331 <span class="preprocessor"></span>      }
<a name="l02332"></a>02332    }
<a name="l02333"></a>02333 
<a name="l02334"></a>02334    <span class="keywordflow">if</span> (tape_flag &amp;&amp; <a class="code" href="fal_8c.html#a93ff70131906aede2a2802753ec682ef">tape_message</a>)
<a name="l02335"></a>02335       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;tr_prestart&quot;</span>, <span class="stringliteral">&quot;tape mounting finished&quot;</span>);
<a name="l02336"></a>02336 
<a name="l02337"></a>02337    <span class="comment">/* reopen history channels if event definition has changed */</span>
<a name="l02338"></a>02338    <a class="code" href="fal_8c.html#a47956ca76e86a1e107f5c4f1b7c8399a">close_history</a>();
<a name="l02339"></a>02339    <a class="code" href="fal_8c.html#a8727d1a82d030403d6074654a6996814">open_history</a>();
<a name="l02340"></a>02340 
<a name="l02341"></a>02341    <span class="comment">/* write transition event into history */</span>
<a name="l02342"></a>02342    <a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>.transition = <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>;
<a name="l02343"></a>02343    <a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>.run_number = run_number;
<a name="l02344"></a>02344    <a class="code" href="group__msectionh.html#ga607ef6f6ef2f547c09f05a5a7fe4c3d6">hs_write_event</a>(0, &amp;<a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>, <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>));
<a name="l02345"></a>02345 
<a name="l02346"></a>02346 <span class="preprocessor">#ifdef FAL_MAIN</span>
<a name="l02347"></a>02347 <span class="preprocessor"></span>   <span class="keywordflow">return</span> <a class="code" href="fal_8c.html#a18ebb4a9430249867c5ec3f4aca0ea40">tr_start2</a>(run_number, error);
<a name="l02348"></a>02348 <span class="preprocessor">#endif</span>
<a name="l02349"></a>02349 <span class="preprocessor"></span>
<a name="l02350"></a>02350    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l02351"></a>02351 }
<a name="l02352"></a>02352 
<a name="l02353"></a>02353 <span class="comment">/*-- poststop ------------------------------------------------------*/</span>
<a name="l02354"></a>02354 
<a name="l02355"></a><a class="code" href="fal_8c.html#a484c8c03aeba475a784f0a51567081b9">02355</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a484c8c03aeba475a784f0a51567081b9">tr_poststop</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error)
<a name="l02356"></a>02356 <span class="comment">/********************************************************************\</span>
<a name="l02357"></a>02357 <span class="comment"></span>
<a name="l02358"></a>02358 <span class="comment">   Poststop:</span>
<a name="l02359"></a>02359 <span class="comment"></span>
<a name="l02360"></a>02360 <span class="comment">     Wait until buffers are empty, then close logging channels</span>
<a name="l02361"></a>02361 <span class="comment"></span>
<a name="l02362"></a>02362 <span class="comment">\********************************************************************/</span>
<a name="l02363"></a>02363 {
<a name="l02364"></a>02364    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l02365"></a>02365    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>, tape_flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02366"></a>02366    <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a258adbf16b88a7db88c7d8bce9708c50">filename</a>[256];
<a name="l02367"></a>02367    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l02368"></a>02368 
<a name="l02369"></a>02369    <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a9176ec250a555fff7c2a03cb3d2391c6">in_stop_transition</a>)
<a name="l02370"></a>02370       <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l02371"></a>02371 
<a name="l02372"></a>02372    <a class="code" href="fal_8c.html#a9176ec250a555fff7c2a03cb3d2391c6">in_stop_transition</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02373"></a>02373    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="evb_2mevb_8h.html#ac69ee46f4a51ed14f0d68628c2dec71d">MAX_CHANNELS</a>; i++) {
<a name="l02374"></a>02374       <span class="keywordflow">if</span> (log_chn[i].<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a> || log_chn[i].ftp_con) {
<a name="l02375"></a>02375          <span class="comment">/* generate MTALK message */</span>
<a name="l02376"></a>02376          <span class="keywordflow">if</span> (log_chn[i].<a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a> == <a class="code" href="group__msystemincludecode.html#ga3e8788a1f492a4f3ba005184662fe0c7">LOG_TYPE_TAPE</a> &amp;&amp; <a class="code" href="fal_8c.html#a93ff70131906aede2a2802753ec682ef">tape_message</a>) {
<a name="l02377"></a>02377             tape_flag = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02378"></a>02378             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;tr_poststop&quot;</span>, <span class="stringliteral">&quot;closing tape channel #%d, please wait&quot;</span>, i);
<a name="l02379"></a>02379          }
<a name="l02380"></a>02380 <span class="preprocessor">#ifndef FAL_MAIN</span>
<a name="l02381"></a>02381 <span class="preprocessor"></span>         <span class="comment">/* wait until buffer is empty */</span>
<a name="l02382"></a>02382          <span class="keywordflow">if</span> (log_chn[i].buffer_handle) {
<a name="l02383"></a>02383 <span class="preprocessor">#ifdef DELAYED_STOP</span>
<a name="l02384"></a>02384 <span class="preprocessor"></span>            <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="old__mevb_8cpp.html#af4211e1ba0e676018599e88cfae3537a">start_time</a>;
<a name="l02385"></a>02385 
<a name="l02386"></a>02386             start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l02387"></a>02387             <span class="keywordflow">do</span> {
<a name="l02388"></a>02388                <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(100);
<a name="l02389"></a>02389             } <span class="keywordflow">while</span> (<a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time &lt; DELAYED_STOP);
<a name="l02390"></a>02390 <span class="preprocessor">#else</span>
<a name="l02391"></a>02391 <span class="preprocessor"></span>            <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> n_bytes;
<a name="l02392"></a>02392             <span class="keywordflow">do</span> {
<a name="l02393"></a>02393                <a class="code" href="group__msectionh.html#ga16a2c902dc41dd323e6552c940b37af9">bm_get_buffer_level</a>(log_chn[i].buffer_handle, &amp;n_bytes);
<a name="l02394"></a>02394                <span class="keywordflow">if</span> (n_bytes &gt; 0)
<a name="l02395"></a>02395                   <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(100);
<a name="l02396"></a>02396             } <span class="keywordflow">while</span> (n_bytes &gt; 0);
<a name="l02397"></a>02397 <span class="preprocessor">#endif</span>
<a name="l02398"></a>02398 <span class="preprocessor"></span>         }
<a name="l02399"></a>02399 <span class="preprocessor">#endif                          </span><span class="comment">/* FAL_MAIN */</span>
<a name="l02400"></a>02400 
<a name="l02401"></a>02401          <span class="comment">/* close logging channel */</span>
<a name="l02402"></a>02402          <a class="code" href="fal_8c.html#a74aaaa49f804300530812095713383b7">log_close</a>(&amp;log_chn[i], run_number);
<a name="l02403"></a>02403 
<a name="l02404"></a>02404          <span class="comment">/* close statistics record */</span>
<a name="l02405"></a>02405          <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, log_chn[i].stats_hkey, &amp;log_chn[i].statistics,
<a name="l02406"></a>02406                        <span class="keyword">sizeof</span>(<a class="code" href="structCHN__STATISTICS.html">CHN_STATISTICS</a>), 0);
<a name="l02407"></a>02407          <a class="code" href="group__msectionh.html#gae60eb33ad37ee9a9ce1cbc872db2fb19">db_close_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, log_chn[i].stats_hkey);
<a name="l02408"></a>02408          <a class="code" href="group__msectionh.html#gae60eb33ad37ee9a9ce1cbc872db2fb19">db_close_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, log_chn[i].settings_hkey);
<a name="l02409"></a>02409       }
<a name="l02410"></a>02410    }
<a name="l02411"></a>02411 
<a name="l02412"></a>02412    <span class="comment">/* close buffers */</span>
<a name="l02413"></a>02413    <span class="keywordflow">for</span> (i = 0; i &lt; MAX_CHANNELS; i++) {
<a name="l02414"></a>02414 <span class="preprocessor">#ifndef FAL_MAIN</span>
<a name="l02415"></a>02415 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (log_chn[i].buffer_handle) {
<a name="l02416"></a>02416          <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>;
<a name="l02417"></a>02417 
<a name="l02418"></a>02418          <a class="code" href="group__msectionh.html#ga536a8e803f72f8f4a7e211846020a148">bm_close_buffer</a>(log_chn[i].buffer_handle);
<a name="l02419"></a>02419          <span class="keywordflow">for</span> (j = i + 1; j &lt; MAX_CHANNELS; j++)
<a name="l02420"></a>02420             <span class="keywordflow">if</span> (log_chn[j].buffer_handle == log_chn[i].buffer_handle)
<a name="l02421"></a>02421                log_chn[j].<a class="code" href="structLOG__CHN.html#ac992c82de9d6b07926e39fb1352b8e04">buffer_handle</a> = 0;
<a name="l02422"></a>02422       }
<a name="l02423"></a>02423 
<a name="l02424"></a>02424       <span class="keywordflow">if</span> (log_chn[i].msg_request_id)
<a name="l02425"></a>02425          <a class="code" href="group__msectionh.html#ga642e51b416da6cd6e27035fdd43ed71b">bm_delete_request</a>(log_chn[i].msg_request_id);
<a name="l02426"></a>02426 <span class="preprocessor">#endif</span>
<a name="l02427"></a>02427 <span class="preprocessor"></span>
<a name="l02428"></a>02428       <span class="comment">/* clear channel info */</span>
<a name="l02429"></a>02429       memset(&amp;log_chn[i].<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structLOG__CHN.html">LOG_CHN</a>));
<a name="l02430"></a>02430    }
<a name="l02431"></a>02431 
<a name="l02432"></a>02432    <span class="comment">/* ODB dump if requested */</span>
<a name="l02433"></a>02433    size = <span class="keyword">sizeof</span>(flag);
<a name="l02434"></a>02434    flag = 0;
<a name="l02435"></a>02435    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/ODB Dump&quot;</span>, &amp;flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02436"></a>02436    <span class="keywordflow">if</span> (flag) {
<a name="l02437"></a>02437       strcpy(str, <span class="stringliteral">&quot;run%d.odb&quot;</span>);
<a name="l02438"></a>02438       size = <span class="keyword">sizeof</span>(str);
<a name="l02439"></a>02439       str[0] = 0;
<a name="l02440"></a>02440       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/ODB Dump File&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02441"></a>02441       <span class="keywordflow">if</span> (str[0] == 0)
<a name="l02442"></a>02442          strcpy(str, <span class="stringliteral">&quot;run%d.odb&quot;</span>);
<a name="l02443"></a>02443 
<a name="l02444"></a>02444       <span class="comment">/* substitue &quot;%d&quot; by current run number */</span>
<a name="l02445"></a>02445       <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>))
<a name="l02446"></a>02446          sprintf(filename, str, run_number);
<a name="l02447"></a>02447       <span class="keywordflow">else</span>
<a name="l02448"></a>02448          strcpy(filename, str);
<a name="l02449"></a>02449 
<a name="l02450"></a>02450       <a class="code" href="fal_8c.html#acf9c7de88cba31c73350482f73f50253">odb_save</a>(filename);
<a name="l02451"></a>02451    }
<a name="l02452"></a>02452 
<a name="l02453"></a>02453    <a class="code" href="fal_8c.html#a9176ec250a555fff7c2a03cb3d2391c6">in_stop_transition</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02454"></a>02454 
<a name="l02455"></a>02455    <span class="keywordflow">if</span> (tape_flag &amp; <a class="code" href="fal_8c.html#a93ff70131906aede2a2802753ec682ef">tape_message</a>)
<a name="l02456"></a>02456       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;tr_poststop&quot;</span>, <span class="stringliteral">&quot;all tape channels closed&quot;</span>);
<a name="l02457"></a>02457 
<a name="l02458"></a>02458    <span class="comment">/* write transition event into history */</span>
<a name="l02459"></a>02459    <a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>.transition = <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>;
<a name="l02460"></a>02460    <a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>.run_number = run_number;
<a name="l02461"></a>02461    <a class="code" href="group__msectionh.html#ga607ef6f6ef2f547c09f05a5a7fe4c3d6">hs_write_event</a>(0, &amp;<a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>, <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>));
<a name="l02462"></a>02462 
<a name="l02463"></a>02463    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l02464"></a>02464 }
<a name="l02465"></a>02465 
<a name="l02466"></a>02466 <span class="comment">/*== common code FAL/MLOGGER end ===================================*/</span>
<a name="l02467"></a>02467 
<a name="l02468"></a>02468 <span class="comment">/*-- add &lt;/logger/data dir&gt; before filename ------------------------*/</span>
<a name="l02469"></a>02469 
<a name="l02470"></a><a class="code" href="group__msectionh.html#ga42926f9062f24eb432ffb6414cde67e8">02470</a> <span class="keywordtype">void</span> <a class="code" href="group__msectionh.html#ga42926f9062f24eb432ffb6414cde67e8">add_data_dir</a>(<span class="keywordtype">char</span> *result, <span class="keywordtype">char</span> *file)
<a name="l02471"></a>02471 {
<a name="l02472"></a>02472    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hkey;
<a name="l02473"></a>02473    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l02474"></a>02474    <span class="keywordtype">int</span> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l02475"></a>02475 
<a name="l02476"></a>02476    <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;hDB, NULL);
<a name="l02477"></a>02477    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Data dir&quot;</span>, &amp;hkey);
<a name="l02478"></a>02478 
<a name="l02479"></a>02479    <span class="keywordflow">if</span> (hkey) {
<a name="l02480"></a>02480       size = <span class="keyword">sizeof</span>(str);
<a name="l02481"></a>02481       <a class="code" href="group__msectionh.html#gad6e53374f24813cdba8713781683c556">db_get_data</a>(hDB, hkey, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>);
<a name="l02482"></a>02482       <span class="keywordflow">if</span> (str[strlen(str) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l02483"></a>02483          strcat(str, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l02484"></a>02484       strcat(str, file);
<a name="l02485"></a>02485       strcpy(result, str);
<a name="l02486"></a>02486    } <span class="keywordflow">else</span>
<a name="l02487"></a>02487       strcpy(result, file);
<a name="l02488"></a>02488 }
<a name="l02489"></a>02489 
<a name="l02490"></a>02490 <span class="comment">/*-- functions for internal tests ----------------------------------*/</span>
<a name="l02491"></a>02491 
<a name="l02492"></a><a class="code" href="fal_8c.html#a8d48fae6c3a349ad62641f44252fb21e">02492</a> <a class="code" href="structANA__TEST.html">ANA_TEST</a> **<a class="code" href="fal_8c.html#a8d48fae6c3a349ad62641f44252fb21e">tl</a>;
<a name="l02493"></a><a class="code" href="fal_8c.html#afc7da5af4f263536aae9ad609dea1a26">02493</a> <span class="keywordtype">int</span> <a class="code" href="fal_8c.html#afc7da5af4f263536aae9ad609dea1a26">n_test</a> = 0;
<a name="l02494"></a>02494 
<a name="l02495"></a><a class="code" href="group__msectionh.html#gafe14ae429e3bc130043ebe683c41943e">02495</a> <span class="keywordtype">void</span> <a class="code" href="group__msectionh.html#gafe14ae429e3bc130043ebe683c41943e">test_register</a>(<a class="code" href="structANA__TEST.html">ANA_TEST</a> * t)
<a name="l02496"></a>02496 {
<a name="l02497"></a>02497    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l02498"></a>02498 
<a name="l02499"></a>02499    <span class="comment">/* check if test already registered */</span>
<a name="l02500"></a>02500    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="fal_8c.html#afc7da5af4f263536aae9ad609dea1a26">n_test</a>; i++)
<a name="l02501"></a>02501       <span class="keywordflow">if</span> (tl[i] == t)
<a name="l02502"></a>02502          <span class="keywordflow">break</span>;
<a name="l02503"></a>02503    <span class="keywordflow">if</span> (i &lt; n_test) {
<a name="l02504"></a>02504       t-&gt;<a class="code" href="group__midasincludecode.html#ga7b6db64e56a7eca12d6efb6cb64748fa">registered</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02505"></a>02505       <span class="keywordflow">return</span>;
<a name="l02506"></a>02506    }
<a name="l02507"></a>02507 
<a name="l02508"></a>02508    <span class="comment">/* allocate space for pointer to test */</span>
<a name="l02509"></a>02509    <span class="keywordflow">if</span> (n_test == 0) {
<a name="l02510"></a>02510       tl = malloc(2 * <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *));
<a name="l02511"></a>02511 
<a name="l02512"></a>02512       <span class="comment">/* define &quot;always true&quot; test */</span>
<a name="l02513"></a>02513       tl[0] = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structANA__TEST.html">ANA_TEST</a>));
<a name="l02514"></a>02514       strcpy(tl[0]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>, <span class="stringliteral">&quot;Always true&quot;</span>);
<a name="l02515"></a>02515       tl[0]-&gt;<a class="code" href="group__midasincludecode.html#ga76f53e0e2afd1fcfc50195a05d715227">count</a> = 0;
<a name="l02516"></a>02516       tl[0]-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02517"></a>02517       tl[0]-&gt;<a class="code" href="group__midasincludecode.html#ga7b6db64e56a7eca12d6efb6cb64748fa">registered</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02518"></a>02518       n_test++;
<a name="l02519"></a>02519    } <span class="keywordflow">else</span>
<a name="l02520"></a>02520       tl = realloc(tl, (n_test + 1) * <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *));
<a name="l02521"></a>02521 
<a name="l02522"></a>02522    tl[n_test] = t;
<a name="l02523"></a>02523    t-&gt;<a class="code" href="group__midasincludecode.html#ga76f53e0e2afd1fcfc50195a05d715227">count</a> = 0;
<a name="l02524"></a>02524    t-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02525"></a>02525    t-&gt;<a class="code" href="group__midasincludecode.html#ga7b6db64e56a7eca12d6efb6cb64748fa">registered</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02526"></a>02526 
<a name="l02527"></a>02527    n_test++;
<a name="l02528"></a>02528 }
<a name="l02529"></a>02529 
<a name="l02530"></a><a class="code" href="fal_8c.html#a443aaa38b1796a39d965acb610d31cc8">02530</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a443aaa38b1796a39d965acb610d31cc8">test_clear</a>()
<a name="l02531"></a>02531 {
<a name="l02532"></a>02532    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l02533"></a>02533 
<a name="l02534"></a>02534    <span class="comment">/* clear all tests in interal list */</span>
<a name="l02535"></a>02535    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="fal_8c.html#afc7da5af4f263536aae9ad609dea1a26">n_test</a>; i++) {
<a name="l02536"></a>02536       tl[i]-&gt;<a class="code" href="group__midasincludecode.html#ga76f53e0e2afd1fcfc50195a05d715227">count</a> = 0;
<a name="l02537"></a>02537       tl[i]-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02538"></a>02538    }
<a name="l02539"></a>02539 
<a name="l02540"></a>02540    <span class="comment">/* set &quot;always true&quot; test */</span>
<a name="l02541"></a>02541    <span class="keywordflow">if</span> (n_test &gt; 0)
<a name="l02542"></a>02542       tl[0]-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02543"></a>02543 }
<a name="l02544"></a>02544 
<a name="l02545"></a><a class="code" href="fal_8c.html#a5d0c60b46806a49cf44b5db6053b1e0f">02545</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a5d0c60b46806a49cf44b5db6053b1e0f">test_increment</a>()
<a name="l02546"></a>02546 {
<a name="l02547"></a>02547    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l02548"></a>02548 
<a name="l02549"></a>02549    <span class="comment">/* increment test counters based on their value and reset them */</span>
<a name="l02550"></a>02550    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="fal_8c.html#afc7da5af4f263536aae9ad609dea1a26">n_test</a>; i++) {
<a name="l02551"></a>02551       <span class="keywordflow">if</span> (tl[i]-&gt;<a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>)
<a name="l02552"></a>02552          tl[i]-&gt;<a class="code" href="group__midasincludecode.html#ga76f53e0e2afd1fcfc50195a05d715227">count</a>++;
<a name="l02553"></a>02553       <span class="keywordflow">if</span> (i &gt; 0)
<a name="l02554"></a>02554          tl[i]-&gt;<a class="code" href="group__midasincludecode.html#gaf1cbe49e3d68b42b77c02eb7c5e175fb">value</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02555"></a>02555    }
<a name="l02556"></a>02556 }
<a name="l02557"></a>02557 
<a name="l02558"></a><a class="code" href="fal_8c.html#a29da9175b91a9b8fbadf2499e84c11e3">02558</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a29da9175b91a9b8fbadf2499e84c11e3">test_write</a>()
<a name="l02559"></a>02559 {
<a name="l02560"></a>02560    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l02561"></a>02561    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l02562"></a>02562 
<a name="l02563"></a>02563    <span class="comment">/* write all test counts to /analyzer/tests/&lt;name&gt; */</span>
<a name="l02564"></a>02564    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="fal_8c.html#afc7da5af4f263536aae9ad609dea1a26">n_test</a>; i++) {
<a name="l02565"></a>02565       sprintf(str, <span class="stringliteral">&quot;/%s/Tests/%s&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>, tl[i]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l02566"></a>02566       <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;tl[i]-&gt;<a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>, <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>), 1, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>);
<a name="l02567"></a>02567    }
<a name="l02568"></a>02568 }
<a name="l02569"></a>02569 
<a name="l02570"></a>02570 <span class="comment">/*-- start ---------------------------------------------------------*/</span>
<a name="l02571"></a>02571 
<a name="l02572"></a><a class="code" href="fal_8c.html#a7ccc1297eea10dec858d53710b9f1b26">02572</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a18ebb4a9430249867c5ec3f4aca0ea40">tr_start2</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l02573"></a>02573 <span class="comment">/********************************************************************\</span>
<a name="l02574"></a>02574 <span class="comment"></span>
<a name="l02575"></a>02575 <span class="comment">     Initialize serial numbers, update display</span>
<a name="l02576"></a>02576 <span class="comment"></span>
<a name="l02577"></a>02577 <span class="comment">\********************************************************************/</span>
<a name="l02578"></a>02578 {
<a name="l02579"></a>02579    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l02580"></a>02580    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l02581"></a>02581    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l02582"></a>02582    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l02583"></a>02583 
<a name="l02584"></a>02584    <span class="comment">/* reset serial numbers */</span>
<a name="l02585"></a>02585    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l02586"></a>02586       equipment[i].<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a> = 1;
<a name="l02587"></a>02587       equipment[i].<a class="code" href="group__midasincludecode.html#gab487ff66b0ceb7677a3e664717158c51">odb_in</a> = equipment[i].<a class="code" href="group__midasincludecode.html#ga2ba622da82fc7a02605e5f630464b13f">odb_out</a> = 0;
<a name="l02588"></a>02588    }
<a name="l02589"></a>02589 
<a name="l02590"></a>02590    <span class="comment">/* reset counters */</span>
<a name="l02591"></a>02591    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02592"></a>02592       analyze_request[i].<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a> = 0;
<a name="l02593"></a>02593       analyze_request[i].<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>.<a class="code" href="structAR__STATS.html#ae75a481fd926f515b17a3e2b63ee283a">events_received</a> = 0;
<a name="l02594"></a>02594    }
<a name="l02595"></a>02595 
<a name="l02596"></a>02596    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02597"></a>02597       <span class="comment">/* copy output flag from ODB to bank_list */</span>
<a name="l02598"></a>02598       bank_list = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l02599"></a>02599 
<a name="l02600"></a>02600       <span class="keywordflow">if</span> (bank_list != NULL)
<a name="l02601"></a>02601          <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l02602"></a>02602             sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches/%s&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l02603"></a>02603             bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02604"></a>02604             size = <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>);
<a name="l02605"></a>02605             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a>, &amp;size, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02606"></a>02606          }
<a name="l02607"></a>02607 
<a name="l02608"></a>02608       <span class="comment">/* copy module enabled flag to ana_module */</span>
<a name="l02609"></a>02609       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l02610"></a>02610       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++) {
<a name="l02611"></a>02611          sprintf(str, <span class="stringliteral">&quot;/%s/Module switches/%s&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>, module[j]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l02612"></a>02612          module[j]-&gt;<a class="code" href="group__midasincludecode.html#ga0d86abcfd4f421658176e51c24f7eb29">enabled</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02613"></a>02613          size = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l02614"></a>02614          <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02615"></a>02615       }
<a name="l02616"></a>02616    }
<a name="l02617"></a>02617 <span class="preprocessor">#ifndef MANA_LITE</span>
<a name="l02618"></a>02618 <span class="preprocessor"></span>   <span class="comment">/* clear histos and N-tuples */</span>
<a name="l02619"></a>02619    <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.clear_histos) {
<a name="l02620"></a>02620       <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++)
<a name="l02621"></a>02621          <span class="keywordflow">if</span> (analyze_request[i].bank_list != NULL)
<a name="l02622"></a>02622             <span class="keywordflow">if</span> (<a class="code" href="hbook_8h.html#a3efc0c35b6588eb50787985bb6440719">HEXIST</a>(analyze_request[i].ar_info.event_id))
<a name="l02623"></a>02623                <a class="code" href="hbook_8h.html#aabf9d6f4996c66f08569c299f1f48f8c">HRESET</a>(analyze_request[i].ar_info.event_id, <a class="code" href="fal_8c.html#a7fce5fc9af5702ff4cbc3f25bde32347">bstr</a>);
<a name="l02624"></a>02624       <a class="code" href="hbook_8h.html#aabf9d6f4996c66f08569c299f1f48f8c">HRESET</a>(0, <a class="code" href="fal_8c.html#a7fce5fc9af5702ff4cbc3f25bde32347">bstr</a>);
<a name="l02625"></a>02625 
<a name="l02626"></a>02626       <a class="code" href="fal_8c.html#a443aaa38b1796a39d965acb610d31cc8">test_clear</a>();
<a name="l02627"></a>02627    }
<a name="l02628"></a>02628 <span class="preprocessor">#endif</span>
<a name="l02629"></a>02629 <span class="preprocessor"></span>   <span class="comment">/* call bor for modules */</span>
<a name="l02630"></a>02630    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02631"></a>02631       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l02632"></a>02632       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++)
<a name="l02633"></a>02633          <span class="keywordflow">if</span> (module[j]-&gt;<a class="code" href="mana_8cpp.html#aad9e8ec0221ce200e2bd2fd32f77833b">bor</a> != NULL &amp;&amp; module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>)
<a name="l02634"></a>02634             module[j]-&gt;<a class="code" href="group__midasincludecode.html#ga288a69852e0bcf07f90f4f344c42801b">bor</a>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l02635"></a>02635    }
<a name="l02636"></a>02636 
<a name="l02637"></a>02637 
<a name="l02638"></a>02638    <span class="comment">/* call frontend BOR routine */</span>
<a name="l02639"></a>02639    status = <a class="code" href="crate3_2crate_8cpp.html#ad8bfe703c49342b9f0275aba77dc7758">begin_of_run</a>(rn, error);
<a name="l02640"></a>02640    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02641"></a>02641       <span class="keywordflow">return</span> status;
<a name="l02642"></a>02642 
<a name="l02643"></a>02643    <span class="comment">/* call main analyzer BOR routine */</span>
<a name="l02644"></a>02644    status = <a class="code" href="analyzer_8cpp.html#a22c6bd312e4f7ffd79162e64835cfd42">ana_begin_of_run</a>(rn, error);
<a name="l02645"></a>02645    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02646"></a>02646       <span class="keywordflow">return</span> status;
<a name="l02647"></a>02647 
<a name="l02648"></a>02648    <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>;
<a name="l02649"></a>02649    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l02650"></a>02650 
<a name="l02651"></a>02651    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>);
<a name="l02652"></a>02652 
<a name="l02653"></a>02653    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, 2, <span class="stringliteral">&quot;Running&quot;</span>);
<a name="l02654"></a>02654    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(36, 2, <span class="stringliteral">&quot;%d&quot;</span>, rn);
<a name="l02655"></a>02655 
<a name="l02656"></a>02656    <span class="keywordflow">return</span> status;
<a name="l02657"></a>02657 }
<a name="l02658"></a>02658 
<a name="l02659"></a>02659 <span class="comment">/*-- stop ----------------------------------------------------------*/</span>
<a name="l02660"></a>02660 
<a name="l02661"></a><a class="code" href="fal_8c.html#a5c030a1926f2439e78b7bd0d00221937">02661</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a29971c513f4451dd5c79373edd928ca0">tr_stop</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l02662"></a>02662 <span class="comment">/********************************************************************\</span>
<a name="l02663"></a>02663 <span class="comment"></span>
<a name="l02664"></a>02664 <span class="comment">     Send all periodic events, update display</span>
<a name="l02665"></a>02665 <span class="comment"></span>
<a name="l02666"></a>02666 <span class="comment">\********************************************************************/</span>
<a name="l02667"></a>02667 {
<a name="l02668"></a>02668    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l02669"></a>02669    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l02670"></a>02670    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256], <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256];
<a name="l02671"></a>02671 
<a name="l02672"></a>02672    <span class="comment">/* call frontend EOR routine */</span>
<a name="l02673"></a>02673    status = <a class="code" href="crate3_2crate_8cpp.html#ae6d798649008b7523c77222bae2d4187">end_of_run</a>(rn, error);
<a name="l02674"></a>02674    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02675"></a>02675       <span class="keywordflow">return</span> status;
<a name="l02676"></a>02676 
<a name="l02677"></a>02677    <span class="comment">/* don&apos;t send events if already stopped */</span>
<a name="l02678"></a>02678    <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> != <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>)
<a name="l02679"></a>02679       <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>);
<a name="l02680"></a>02680 
<a name="l02681"></a>02681    <span class="comment">/* call EOR routines modules */</span>
<a name="l02682"></a>02682    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02683"></a>02683       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l02684"></a>02684       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++)
<a name="l02685"></a>02685          <span class="keywordflow">if</span> (module[j]-&gt;<a class="code" href="mana_8cpp.html#accdfb5cb6649097a857202444fbc3aa6">eor</a> != NULL &amp;&amp; module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>)
<a name="l02686"></a>02686             module[j]-&gt;<a class="code" href="group__midasincludecode.html#gab6b3f976d916f185922ed4ccfe6453c6">eor</a>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l02687"></a>02687    }
<a name="l02688"></a>02688 
<a name="l02689"></a>02689    <span class="comment">/* call main analyzer BOR routine */</span>
<a name="l02690"></a>02690    status = <a class="code" href="analyzer_8cpp.html#a8e03cbe2637bd6f4488a659c9f23d29e">ana_end_of_run</a>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, error);
<a name="l02691"></a>02691 
<a name="l02692"></a>02692    <span class="comment">/* write tests to ODB */</span>
<a name="l02693"></a>02693    <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l02694"></a>02694 
<a name="l02695"></a>02695 <span class="preprocessor">#ifndef MANA_LITE</span>
<a name="l02696"></a>02696 <span class="preprocessor"></span>   <span class="comment">/* save histos if requested */</span>
<a name="l02697"></a>02697    <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.histo_dump) {
<a name="l02698"></a>02698       size = <span class="keyword">sizeof</span>(str);
<a name="l02699"></a>02699       str[0] = 0;
<a name="l02700"></a>02700       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Data Dir&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02701"></a>02701       <span class="keywordflow">if</span> (str[0] != 0)
<a name="l02702"></a>02702          <span class="keywordflow">if</span> (str[strlen(str) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l02703"></a>02703             strcat(str, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l02704"></a>02704 
<a name="l02705"></a>02705       strcat(str, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.histo_dump_filename);
<a name="l02706"></a>02706       <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;%&apos;</span>) != NULL)
<a name="l02707"></a>02707          sprintf(file_name, str, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l02708"></a>02708       <span class="keywordflow">else</span>
<a name="l02709"></a>02709          strcpy(file_name, str);
<a name="l02710"></a>02710 
<a name="l02711"></a>02711       strcpy(str, <span class="stringliteral">&quot;NT&quot;</span>);
<a name="l02712"></a>02712       <a class="code" href="hbook_8h.html#afebb35542c02eb885020475cb221afaf">HRPUT</a>(0, file_name, str);
<a name="l02713"></a>02713    }
<a name="l02714"></a>02714 <span class="preprocessor">#endif</span>
<a name="l02715"></a>02715 <span class="preprocessor"></span>   <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>;
<a name="l02716"></a>02716    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l02717"></a>02717 
<a name="l02718"></a>02718    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, 2, <span class="stringliteral">&quot;Stopped&quot;</span>);
<a name="l02719"></a>02719 
<a name="l02720"></a>02720    <span class="keywordflow">return</span> status;
<a name="l02721"></a>02721 }
<a name="l02722"></a>02722 
<a name="l02723"></a>02723 <span class="comment">/*-- pause ---------------------------------------------------------*/</span>
<a name="l02724"></a>02724 
<a name="l02725"></a><a class="code" href="fal_8c.html#a7b3b6a2f570d0b31b1ad13c34536db5a">02725</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate9_2mfe__mucap_8c.html#a7b3b6a2f570d0b31b1ad13c34536db5a">tr_pause</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l02726"></a>02726 {
<a name="l02727"></a>02727    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l02728"></a>02728 
<a name="l02729"></a>02729    status = <a class="code" href="examples_2macro_2midas__macro_8h.html#ac13d5e945d03bd84233e479cad2d892a">pause_run</a>(rn, error);
<a name="l02730"></a>02730    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02731"></a>02731       <span class="keywordflow">return</span> status;
<a name="l02732"></a>02732 
<a name="l02733"></a>02733    status = <a class="code" href="analyzer_8cpp.html#a86f2bc78d542107ce023a1d54f79b13e">ana_pause_run</a>(rn, error);
<a name="l02734"></a>02734    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02735"></a>02735       <span class="keywordflow">return</span> status;
<a name="l02736"></a>02736 
<a name="l02737"></a>02737    <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#gab08c47284371c683ba80d6b3244400f1">STATE_PAUSED</a>;
<a name="l02738"></a>02738    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l02739"></a>02739 
<a name="l02740"></a>02740    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#ga11713399cfb35e58b8fae045836c0d88">TR_PAUSE</a>);
<a name="l02741"></a>02741 
<a name="l02742"></a>02742    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, 2, <span class="stringliteral">&quot;Paused&quot;</span>);
<a name="l02743"></a>02743 
<a name="l02744"></a>02744    <span class="comment">/* write transition event into history */</span>
<a name="l02745"></a>02745    <a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>.transition = <a class="code" href="group__mdefineh.html#gab08c47284371c683ba80d6b3244400f1">STATE_PAUSED</a>;
<a name="l02746"></a>02746    <a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>.run_number = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>;
<a name="l02747"></a>02747    <a class="code" href="group__msectionh.html#ga607ef6f6ef2f547c09f05a5a7fe4c3d6">hs_write_event</a>(0, &amp;<a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>, <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>));
<a name="l02748"></a>02748 
<a name="l02749"></a>02749    <span class="keywordflow">return</span> status;
<a name="l02750"></a>02750 }
<a name="l02751"></a>02751 
<a name="l02752"></a>02752 <span class="comment">/*-- resume --------------------------------------------------------*/</span>
<a name="l02753"></a>02753 
<a name="l02754"></a><a class="code" href="fal_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">02754</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">tr_resume</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mstat_8c.html#a2c1c963021a4d8af2cce969c892c10f1">rn</a>, <span class="keywordtype">char</span> *error)
<a name="l02755"></a>02755 {
<a name="l02756"></a>02756    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l02757"></a>02757 
<a name="l02758"></a>02758    status = <a class="code" href="examples_2macro_2midas__macro_8h.html#a392520a13432f29f450f40456e26960f">resume_run</a>(rn, error);
<a name="l02759"></a>02759    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02760"></a>02760       <span class="keywordflow">return</span> status;
<a name="l02761"></a>02761 
<a name="l02762"></a>02762    status = <a class="code" href="analyzer_8cpp.html#a35f57e1efbd308b1ca049035dcdc13f6">ana_resume_run</a>(rn, error);
<a name="l02763"></a>02763    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02764"></a>02764       <span class="keywordflow">return</span> status;
<a name="l02765"></a>02765 
<a name="l02766"></a>02766    <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>;
<a name="l02767"></a>02767    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l02768"></a>02768 
<a name="l02769"></a>02769    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a>);
<a name="l02770"></a>02770 
<a name="l02771"></a>02771    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, 2, <span class="stringliteral">&quot;Running&quot;</span>);
<a name="l02772"></a>02772 
<a name="l02773"></a>02773    <span class="comment">/* write transition event into history */</span>
<a name="l02774"></a>02774    <a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>.transition = <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>;
<a name="l02775"></a>02775    <a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>.run_number = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>;
<a name="l02776"></a>02776    <a class="code" href="group__msectionh.html#ga607ef6f6ef2f547c09f05a5a7fe4c3d6">hs_write_event</a>(0, &amp;<a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>, <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a9868bb8de5c4ac560cc6ef075c45e7aa">eb</a>));
<a name="l02777"></a>02777 
<a name="l02778"></a>02778    <span class="keywordflow">return</span> status;
<a name="l02779"></a>02779 }
<a name="l02780"></a>02780 
<a name="l02781"></a>02781 <span class="comment">/********************************************************************/</span>
<a name="l02782"></a>02782 
<a name="l02783"></a>02783 <span class="comment">/*---- ODB output --------------------------------------------------*/</span>
<a name="l02784"></a>02784 
<a name="l02785"></a><a class="code" href="fal_8c.html#ab55e3bbd032e2ede908194386fdd0dc3">02785</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#ab55e3bbd032e2ede908194386fdd0dc3">write_event_odb</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> * par)
<a name="l02786"></a>02786 {
<a name="l02787"></a>02787    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, n_data, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l02788"></a>02788    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l02789"></a>02789    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l02790"></a>02790    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l02791"></a>02791    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l02792"></a>02792    <span class="keywordtype">void</span> *pdata;
<a name="l02793"></a>02793    <span class="keywordtype">char</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>[5];
<a name="l02794"></a>02794    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hKeyRoot, <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l02795"></a>02795    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l02796"></a>02796    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bkname;
<a name="l02797"></a>02797    <a class="code" href="unionWORD.html">WORD</a> bktype;
<a name="l02798"></a>02798 
<a name="l02799"></a>02799    event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l02800"></a>02800    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l02801"></a>02801       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l02802"></a>02802 
<a name="l02803"></a>02803   <span class="comment">/*---- MIDAS format ----------------------------------------------*/</span>
<a name="l02804"></a>02804    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l02805"></a>02805       pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l02806"></a>02806       pbk = NULL;
<a name="l02807"></a>02807       pbk32 = NULL;
<a name="l02808"></a>02808       <span class="keywordflow">do</span> {
<a name="l02809"></a>02809          <span class="comment">/* scan all banks */</span>
<a name="l02810"></a>02810          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh)) {
<a name="l02811"></a>02811             size = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l02812"></a>02812             <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l02813"></a>02813                <span class="keywordflow">break</span>;
<a name="l02814"></a>02814             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l02815"></a>02815             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l02816"></a>02816          } <span class="keywordflow">else</span> {
<a name="l02817"></a>02817             size = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l02818"></a>02818             <span class="keywordflow">if</span> (pbk == NULL)
<a name="l02819"></a>02819                <span class="keywordflow">break</span>;
<a name="l02820"></a>02820             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l02821"></a>02821             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l02822"></a>02822          }
<a name="l02823"></a>02823 
<a name="l02824"></a>02824          n_data = size;
<a name="l02825"></a>02825          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a> &amp; 0xFF))
<a name="l02826"></a>02826             n_data /= <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a> &amp; 0xFF);
<a name="l02827"></a>02827 
<a name="l02828"></a>02828          <span class="comment">/* get bank key */</span>
<a name="l02829"></a>02829          *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) name) = bkname;
<a name="l02830"></a>02830          name[4] = 0;
<a name="l02831"></a>02831 
<a name="l02832"></a>02832          status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, name, &amp;hKeyRoot);
<a name="l02833"></a>02833          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02834"></a>02834             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_odb&quot;</span>, <span class="stringliteral">&quot;received unknown bank %s&quot;</span>, name);
<a name="l02835"></a>02835             <span class="keywordflow">continue</span>;
<a name="l02836"></a>02836          }
<a name="l02837"></a>02837 
<a name="l02838"></a>02838          <span class="keywordflow">if</span> (bktype == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l02839"></a>02839             <span class="comment">/* write structured bank */</span>
<a name="l02840"></a>02840             <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l02841"></a>02841                status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, i, &amp;hKey);
<a name="l02842"></a>02842                <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l02843"></a>02843                   <span class="keywordflow">break</span>;
<a name="l02844"></a>02844 
<a name="l02845"></a>02845                <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, &amp;key);
<a name="l02846"></a>02846 
<a name="l02847"></a>02847                <span class="comment">/* adjust for alignment */</span>
<a name="l02848"></a>02848                pdata = (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l02849"></a>02849 
<a name="l02850"></a>02850                status = <a class="code" href="group__msectionh.html#ga6b98aa5ac9036c49023c0cc9353922d4">db_set_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, pdata, key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>,
<a name="l02851"></a>02851                                     key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l02852"></a>02852                <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02853"></a>02853                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_odb&quot;</span>, <span class="stringliteral">&quot;cannot write %s to ODB&quot;</span>, name);
<a name="l02854"></a>02854                   <span class="keywordflow">continue</span>;
<a name="l02855"></a>02855                }
<a name="l02856"></a>02856 
<a name="l02857"></a>02857                <span class="comment">/* shift data pointer to next item */</span>
<a name="l02858"></a>02858                pdata = (<span class="keywordtype">char</span> *) pdata + key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l02859"></a>02859             }
<a name="l02860"></a>02860          } <span class="keywordflow">else</span> {
<a name="l02861"></a>02861             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, &amp;key);
<a name="l02862"></a>02862 
<a name="l02863"></a>02863             <span class="comment">/* write variable length bank  */</span>
<a name="l02864"></a>02864             <span class="keywordflow">if</span> (n_data &gt; 0) {
<a name="l02865"></a>02865                status = <a class="code" href="group__msectionh.html#ga6b98aa5ac9036c49023c0cc9353922d4">db_set_data</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, pdata, size, n_data, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l02866"></a>02866                <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l02867"></a>02867                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_odb&quot;</span>, <span class="stringliteral">&quot;cannot write %s to ODB&quot;</span>, name);
<a name="l02868"></a>02868                   <span class="keywordflow">continue</span>;
<a name="l02869"></a>02869                }
<a name="l02870"></a>02870             }
<a name="l02871"></a>02871          }
<a name="l02872"></a>02872       } <span class="keywordflow">while</span> (1);
<a name="l02873"></a>02873    }
<a name="l02874"></a>02874 
<a name="l02875"></a>02875   <span class="comment">/*---- FIXED format ----------------------------------------------*/</span>
<a name="l02876"></a>02876    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
<a name="l02877"></a>02877       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, (<span class="keywordtype">char</span> *) (pevent + 1),
<a name="l02878"></a>02878                         pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>, 0) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l02879"></a>02879          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_odb&quot;</span>, <span class="stringliteral">&quot;event #%d size mismatch&quot;</span>, pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l02880"></a>02880    }
<a name="l02881"></a>02881 
<a name="l02882"></a>02882    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l02883"></a>02883 }
<a name="l02884"></a>02884 
<a name="l02885"></a>02885 <span class="comment">/*-- book N-tuples from ODB bank structures ------------------------*/</span>
<a name="l02886"></a>02886 
<a name="l02887"></a><a class="code" href="fal_8c.html#a224d67b5dbc75c0db41de55f1869544f">02887</a> <span class="keywordtype">char</span> <a class="code" href="fal_8c.html#a224d67b5dbc75c0db41de55f1869544f">hbook_types</a>[][8] = {
<a name="l02888"></a>02888    <span class="stringliteral">&quot;&quot;</span>,
<a name="l02889"></a>02889    <span class="stringliteral">&quot;:U:8&quot;</span>,                      <span class="comment">/* TID_BYTE      */</span>
<a name="l02890"></a>02890    <span class="stringliteral">&quot;:I:8&quot;</span>,                      <span class="comment">/* TID_SBYTE     */</span>
<a name="l02891"></a>02891    <span class="stringliteral">&quot;:I:8&quot;</span>,                      <span class="comment">/* TID_CHAR      */</span>
<a name="l02892"></a>02892    <span class="stringliteral">&quot;:U:16&quot;</span>,                     <span class="comment">/* TID_WORD      */</span>
<a name="l02893"></a>02893    <span class="stringliteral">&quot;:I:16&quot;</span>,                     <span class="comment">/* TID_SHORT     */</span>
<a name="l02894"></a>02894    <span class="stringliteral">&quot;:U*4&quot;</span>,                      <span class="comment">/* TID_DWORD     */</span>
<a name="l02895"></a>02895    <span class="stringliteral">&quot;:I*4&quot;</span>,                      <span class="comment">/* TID_INT       */</span>
<a name="l02896"></a>02896    <span class="stringliteral">&quot;:I*4&quot;</span>,                      <span class="comment">/* TID_BOOL      */</span>
<a name="l02897"></a>02897    <span class="stringliteral">&quot;:R*4&quot;</span>,                      <span class="comment">/* TID_FLOAT     */</span>
<a name="l02898"></a>02898    <span class="stringliteral">&quot;:R*8&quot;</span>,                      <span class="comment">/* TID_DOUBLE    */</span>
<a name="l02899"></a>02899    <span class="stringliteral">&quot;:U:8&quot;</span>,                      <span class="comment">/* TID_BITFIELD  */</span>
<a name="l02900"></a>02900    <span class="stringliteral">&quot;:C:32&quot;</span>,                     <span class="comment">/* TID_STRING    */</span>
<a name="l02901"></a>02901    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_ARRAY     */</span>
<a name="l02902"></a>02902    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_STRUCT    */</span>
<a name="l02903"></a>02903    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_KEY       */</span>
<a name="l02904"></a>02904    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_LINK      */</span>
<a name="l02905"></a>02905    <span class="stringliteral">&quot;&quot;</span>,                          <span class="comment">/* TID_LAST      */</span>
<a name="l02906"></a>02906 
<a name="l02907"></a>02907 };
<a name="l02908"></a>02908 
<a name="l02909"></a>02909 <span class="preprocessor">#ifndef MANA_LITE</span>
<a name="l02910"></a>02910 <span class="preprocessor"></span><a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>(<span class="keywordtype">void</span>);
<a name="l02911"></a>02911 
<a name="l02912"></a><a class="code" href="fal_8c.html#aa2ad5915dcb13ea292c9b31f1cf492a9">02912</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#aa2ad5915dcb13ea292c9b31f1cf492a9">banks_changed</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <span class="keywordtype">void</span> *info)
<a name="l02913"></a>02913 {
<a name="l02914"></a>02914    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[80];
<a name="l02915"></a>02915    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l02916"></a>02916 
<a name="l02917"></a>02917    <span class="comment">/* close previously opened hot link */</span>
<a name="l02918"></a>02918    sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>);
<a name="l02919"></a>02919    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(hDB, 0, str, &amp;hkey);
<a name="l02920"></a>02920    <a class="code" href="group__msectionh.html#gae60eb33ad37ee9a9ce1cbc872db2fb19">db_close_record</a>(hDB, hkey);
<a name="l02921"></a>02921 
<a name="l02922"></a>02922    <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>();
<a name="l02923"></a>02923    <a class="code" href="fal_8c.html#a48fa208044b7e1373af57d1b24393693">print_message</a>(<span class="stringliteral">&quot;N-tuples rebooked&quot;</span>);
<a name="l02924"></a>02924 }
<a name="l02925"></a>02925 
<a name="l02926"></a><a class="code" href="mana__orig_8c.html#a2a0fbf63d5970373f81721ce136319dc">02926</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>(<span class="keywordtype">void</span>)
<a name="l02927"></a>02927 {
<a name="l02928"></a>02928    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, n_tag, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, id;
<a name="l02929"></a>02929    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l02930"></a>02930    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l02931"></a>02931    <span class="keywordtype">char</span> rw_tag[512][8];
<a name="l02932"></a>02932    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[80], key_name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>], block_name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>];
<a name="l02933"></a>02933    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l02934"></a>02934    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l02935"></a>02935 
<a name="l02936"></a>02936    <span class="comment">/* copy output flag from ODB to bank_list */</span>
<a name="l02937"></a>02937    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l02938"></a>02938       bank_list = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l02939"></a>02939 
<a name="l02940"></a>02940       <span class="keywordflow">if</span> (bank_list != NULL)
<a name="l02941"></a>02941          <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l02942"></a>02942             sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches/%s&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l02943"></a>02943             bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02944"></a>02944             size = <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>);
<a name="l02945"></a>02945             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a>, &amp;size, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02946"></a>02946          }
<a name="l02947"></a>02947    }
<a name="l02948"></a>02948 
<a name="l02949"></a>02949    <span class="comment">/* hot link bank switches to N-tuple re-booking */</span>
<a name="l02950"></a>02950    sprintf(str, <span class="stringliteral">&quot;/%s/Bank switches&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>);
<a name="l02951"></a>02951    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hkey);
<a name="l02952"></a>02952    <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hkey, NULL, 0, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, <a class="code" href="fal_8c.html#aa2ad5915dcb13ea292c9b31f1cf492a9">banks_changed</a>, NULL);
<a name="l02953"></a>02953 
<a name="l02954"></a>02954    <span class="comment">/* book RW N-tuples */</span>
<a name="l02955"></a>02955 
<a name="l02956"></a>02956    <span class="comment">/* go through all analyzer requests (events) */</span>
<a name="l02957"></a>02957    <span class="keywordflow">for</span> (index = 0; analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; index++) {
<a name="l02958"></a>02958       <span class="comment">/* don&apos;t book N-tuples if buffer size is zero */</span>
<a name="l02959"></a>02959       <span class="keywordflow">if</span> (analyze_request[index].rwnt_buffer_size == 0)
<a name="l02960"></a>02960          <span class="keywordflow">continue</span>;
<a name="l02961"></a>02961 
<a name="l02962"></a>02962       n_tag = 0;
<a name="l02963"></a>02963 
<a name="l02964"></a>02964       strcpy(rw_tag[n_tag++], <span class="stringliteral">&quot;Run&quot;</span>);
<a name="l02965"></a>02965       strcpy(rw_tag[n_tag++], <span class="stringliteral">&quot;Number&quot;</span>);
<a name="l02966"></a>02966       strcpy(rw_tag[n_tag++], <span class="stringliteral">&quot;Time&quot;</span>);
<a name="l02967"></a>02967 
<a name="l02968"></a>02968       bank_list = analyze_request[index].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l02969"></a>02969       <span class="keywordflow">if</span> (bank_list == NULL) {
<a name="l02970"></a>02970          <span class="comment">/* book fixed event */</span>
<a name="l02971"></a>02971          event_def =
<a name="l02972"></a>02972              <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>((<span class="keywordtype">short</span> <span class="keywordtype">int</span>) analyze_request[index].ar_info.event_id);
<a name="l02973"></a>02973 
<a name="l02974"></a>02974          <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l02975"></a>02975             status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, i, &amp;hkey);
<a name="l02976"></a>02976             <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l02977"></a>02977                <span class="keywordflow">break</span>;
<a name="l02978"></a>02978 
<a name="l02979"></a>02979             <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hkey, &amp;key);
<a name="l02980"></a>02980 
<a name="l02981"></a>02981             <span class="comment">/* convert blanks etc to &apos;_&apos; */</span>
<a name="l02982"></a>02982             strcpy(key_name, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l02983"></a>02983             <span class="keywordflow">for</span> (j = 0; key_name[j]; j++) {
<a name="l02984"></a>02984                <span class="keywordflow">if</span> (!(key_name[j] &gt;= <span class="charliteral">&apos;a&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;z&apos;</span>) &amp;&amp;
<a name="l02985"></a>02985                    !(key_name[j] &gt;= <span class="charliteral">&apos;A&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;Z&apos;</span>) &amp;&amp;
<a name="l02986"></a>02986                    !(key_name[j] &gt;= <span class="charliteral">&apos;0&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;9&apos;</span>))
<a name="l02987"></a>02987                   key_name[j] = <span class="charliteral">&apos;_&apos;</span>;
<a name="l02988"></a>02988             }
<a name="l02989"></a>02989 
<a name="l02990"></a>02990             <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> &gt; 1)
<a name="l02991"></a>02991                <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l02992"></a>02992                   sprintf(str, <span class="stringliteral">&quot;%s%d&quot;</span>, key_name, j);
<a name="l02993"></a>02993                   strncpy(rw_tag[n_tag++], str, 8);
<a name="l02994"></a>02994                   <span class="keywordflow">if</span> (n_tag &gt;= 512) {
<a name="l02995"></a>02995                      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l02996"></a>02996                             <span class="stringliteral">&quot;Too much tags for RW N-tupeles (512 maximum)&quot;</span>);
<a name="l02997"></a>02997                      <span class="keywordflow">return</span> 0;
<a name="l02998"></a>02998                   }
<a name="l02999"></a>02999             } <span class="keywordflow">else</span>
<a name="l03000"></a>03000                strncpy(rw_tag[n_tag++], key_name, 8);
<a name="l03001"></a>03001             <span class="keywordflow">if</span> (n_tag &gt;= 512) {
<a name="l03002"></a>03002                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l03003"></a>03003                       <span class="stringliteral">&quot;Too much tags for RW N-tupeles (512 maximum)&quot;</span>);
<a name="l03004"></a>03004                <span class="keywordflow">return</span> 0;
<a name="l03005"></a>03005             }
<a name="l03006"></a>03006          }
<a name="l03007"></a>03007       } <span class="keywordflow">else</span> {
<a name="l03008"></a>03008          <span class="comment">/* go through all banks in bank_list */</span>
<a name="l03009"></a>03009          <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l03010"></a>03010             <span class="comment">/* remember tag offset in n_data variable */</span>
<a name="l03011"></a>03011             bank_list-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> = n_tag;
<a name="l03012"></a>03012 
<a name="l03013"></a>03013             <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0)
<a name="l03014"></a>03014                <span class="keywordflow">continue</span>;
<a name="l03015"></a>03015 
<a name="l03016"></a>03016             <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a> != <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l03017"></a>03017                <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>; i++) {
<a name="l03018"></a>03018                   sprintf(str, <span class="stringliteral">&quot;%s%d&quot;</span>, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, i);
<a name="l03019"></a>03019                   strncpy(rw_tag[n_tag++], str, 8);
<a name="l03020"></a>03020                }
<a name="l03021"></a>03021             } <span class="keywordflow">else</span> {
<a name="l03022"></a>03022                <span class="comment">/* define structured bank */</span>
<a name="l03023"></a>03023                <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l03024"></a>03024                   status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a>, i, &amp;hkey);
<a name="l03025"></a>03025                   <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l03026"></a>03026                      <span class="keywordflow">break</span>;
<a name="l03027"></a>03027 
<a name="l03028"></a>03028                   <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hkey, &amp;key);
<a name="l03029"></a>03029 
<a name="l03030"></a>03030                   <span class="comment">/* convert blanks etc to &apos;_&apos; */</span>
<a name="l03031"></a>03031                   strcpy(key_name, key.<a class="code" href="group__midasincludecode.html#gaab4927ab8eb9921525d82761adb11f5c">name</a>);
<a name="l03032"></a>03032                   <span class="keywordflow">for</span> (j = 0; key_name[j]; j++) {
<a name="l03033"></a>03033                      <span class="keywordflow">if</span> (!(key_name[j] &gt;= <span class="charliteral">&apos;a&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;z&apos;</span>) &amp;&amp;
<a name="l03034"></a>03034                          !(key_name[j] &gt;= <span class="charliteral">&apos;A&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;Z&apos;</span>) &amp;&amp;
<a name="l03035"></a>03035                          !(key_name[j] &gt;= <span class="charliteral">&apos;0&apos;</span> &amp;&amp; key_name[j] &lt;= <span class="charliteral">&apos;9&apos;</span>))
<a name="l03036"></a>03036                         key_name[j] = <span class="charliteral">&apos;_&apos;</span>;
<a name="l03037"></a>03037                   }
<a name="l03038"></a>03038 
<a name="l03039"></a>03039                   <span class="keywordflow">if</span> (key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a> &gt; 1)
<a name="l03040"></a>03040                      <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l03041"></a>03041                         sprintf(str, <span class="stringliteral">&quot;%s%d&quot;</span>, key_name, j);
<a name="l03042"></a>03042                         strncpy(rw_tag[n_tag++], str, 8);
<a name="l03043"></a>03043                         <span class="keywordflow">if</span> (n_tag &gt;= 512) {
<a name="l03044"></a>03044                            <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l03045"></a>03045                                   <span class="stringliteral">&quot;Too much tags for RW N-tupeles (512 maximum)&quot;</span>);
<a name="l03046"></a>03046                            <span class="keywordflow">return</span> 0;
<a name="l03047"></a>03047                         }
<a name="l03048"></a>03048                   } <span class="keywordflow">else</span>
<a name="l03049"></a>03049                      strncpy(rw_tag[n_tag++], key_name, 8);
<a name="l03050"></a>03050                   <span class="keywordflow">if</span> (n_tag &gt;= 512) {
<a name="l03051"></a>03051                      <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l03052"></a>03052                             <span class="stringliteral">&quot;Too much tags for RW N-tupeles (512 maximum)&quot;</span>);
<a name="l03053"></a>03053                      <span class="keywordflow">return</span> 0;
<a name="l03054"></a>03054                   }
<a name="l03055"></a>03055                }
<a name="l03056"></a>03056             }
<a name="l03057"></a>03057          }
<a name="l03058"></a>03058       }
<a name="l03059"></a>03059 
<a name="l03060"></a>03060       <span class="comment">/* book N-tuple with evend ID */</span>
<a name="l03061"></a>03061       strcpy(block_name, analyze_request[index].event_name);
<a name="l03062"></a>03062       block_name[8] = 0;
<a name="l03063"></a>03063 <span class="preprocessor">#ifndef MANA_LITE</span>
<a name="l03064"></a>03064 <span class="preprocessor"></span>      <span class="keywordtype">id</span> = analyze_request[index].<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="structAR__INFO.html#acb0cf26c5067b0c8eb7a895b70e42f11">event_id</a>;
<a name="l03065"></a>03065       <span class="keywordflow">if</span> (<a class="code" href="hbook_8h.html#a3efc0c35b6588eb50787985bb6440719">HEXIST</a>(<span class="keywordtype">id</span>))
<a name="l03066"></a>03066          <a class="code" href="hbook_8h.html#a3d7fcc23e32f4f11cb69aa1f97073ac0">HDELET</a>(<span class="keywordtype">id</span>);
<a name="l03067"></a>03067 
<a name="l03068"></a>03068       <a class="code" href="hbook_8h.html#afa68d551e34550d853d9a019dfcad8a0">HBOOKN</a>(<span class="keywordtype">id</span>, block_name, n_tag, <a class="code" href="fal_8c.html#a7fce5fc9af5702ff4cbc3f25bde32347">bstr</a>,
<a name="l03069"></a>03069              n_tag * analyze_request[index].rwnt_buffer_size, rw_tag);
<a name="l03070"></a>03070 
<a name="l03071"></a>03071       <span class="keywordflow">if</span> (!<a class="code" href="hbook_8h.html#a3efc0c35b6588eb50787985bb6440719">HEXIST</a>(<span class="keywordtype">id</span>)) {
<a name="l03072"></a>03072          printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l03073"></a>03073          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;book_ntuples&quot;</span>,
<a name="l03074"></a>03074                 <span class="stringliteral">&quot;Cannot book N-tuple #%d. Increase PAWC size via the -s flag or switch off banks&quot;</span>,
<a name="l03075"></a>03075                 <span class="keywordtype">id</span>);
<a name="l03076"></a>03076       }
<a name="l03077"></a>03077 <span class="preprocessor">#endif</span>
<a name="l03078"></a>03078 <span class="preprocessor"></span>   }
<a name="l03079"></a>03079 
<a name="l03080"></a>03080    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03081"></a>03081 }
<a name="l03082"></a>03082 
<a name="l03083"></a>03083 <span class="comment">/*---- HBOOK output ------------------------------------------------*/</span>
<a name="l03084"></a>03084 
<a name="l03085"></a><a class="code" href="fal_8c.html#a2ba1d8e79f061e622f62471ae9bc7063">03085</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a2ba1d8e79f061e622f62471ae9bc7063">write_event_hbook</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> * par)
<a name="l03086"></a>03086 {
<a name="l03087"></a>03087    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="odbhist_8c.html#a43fa990200c3ddd47c35f151bd4d66bf">k</a>, <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, item_size, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l03088"></a>03088    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l03089"></a>03089    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l03090"></a>03090    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *pbl;
<a name="l03091"></a>03091    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l03092"></a>03092    <span class="keywordtype">void</span> *pdata;
<a name="l03093"></a>03093    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> exclude, exclude_all;
<a name="l03094"></a>03094    <span class="keywordtype">char</span> block_name[5];
<a name="l03095"></a>03095    <span class="keywordtype">float</span> <a class="code" href="fal_8c.html#ae9487d607449dedf95bca2636c33b5d3">rwnt</a>[512];
<a name="l03096"></a>03096    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l03097"></a>03097    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l03098"></a>03098    <a class="code" href="structKEY.html">KEY</a> <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>;
<a name="l03099"></a>03099    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> bkname;
<a name="l03100"></a>03100    <a class="code" href="unionWORD.html">WORD</a> bktype;
<a name="l03101"></a>03101 
<a name="l03102"></a>03102    event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l03103"></a>03103    <span class="keywordflow">if</span> (event_def == NULL)
<a name="l03104"></a>03104       <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>;
<a name="l03105"></a>03105 
<a name="l03106"></a>03106    <span class="comment">/* fill number info */</span>
<a name="l03107"></a>03107    memset(rwnt, 0, <span class="keyword">sizeof</span>(rwnt));
<a name="l03108"></a>03108    rwnt[0] = (float) <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>;
<a name="l03109"></a>03109    rwnt[1] = (float) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a>;
<a name="l03110"></a>03110    rwnt[2] = (<span class="keywordtype">float</span>) pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a>;
<a name="l03111"></a>03111 
<a name="l03112"></a>03112   <span class="comment">/*---- MIDAS format ----------------------------------------------*/</span>
<a name="l03113"></a>03113 
<a name="l03114"></a>03114    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l03115"></a>03115       <span class="comment">/* first fill number block */</span>
<a name="l03116"></a>03116       pbk = NULL;
<a name="l03117"></a>03117       pbk32 = NULL;
<a name="l03118"></a>03118       exclude_all = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03119"></a>03119       <span class="keywordflow">do</span> {
<a name="l03120"></a>03120          pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l03121"></a>03121          <span class="comment">/* scan all banks */</span>
<a name="l03122"></a>03122          <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga75339a20fd35a8e8644f4a0fb77e96fe">bk_is32</a>(pbh)) {
<a name="l03123"></a>03123             size = <a class="code" href="group__msectionh.html#ga6ef3064c432f60af815e109bbf6acbd3">bk_iterate32</a>(pbh, &amp;pbk32, &amp;pdata);
<a name="l03124"></a>03124             <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l03125"></a>03125                <span class="keywordflow">break</span>;
<a name="l03126"></a>03126             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l03127"></a>03127             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk32-&gt;<a class="code" href="group__midasincludecode.html#ga24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l03128"></a>03128          } <span class="keywordflow">else</span> {
<a name="l03129"></a>03129             size = <a class="code" href="group__msectionh.html#gab47ee14db38356b8392632ba94b559d8">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l03130"></a>03130             <span class="keywordflow">if</span> (pbk == NULL)
<a name="l03131"></a>03131                <span class="keywordflow">break</span>;
<a name="l03132"></a>03132             bkname = *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l03133"></a>03133             bktype = (<a class="code" href="unionWORD.html">WORD</a>) pbk-&gt;<a class="code" href="group__midasincludecode.html#ga91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l03134"></a>03134          }
<a name="l03135"></a>03135 
<a name="l03136"></a>03136          <span class="comment">/* look if bank is in exclude list */</span>
<a name="l03137"></a>03137          *((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) block_name) = bkname;
<a name="l03138"></a>03138          block_name[4] = 0;
<a name="l03139"></a>03139 
<a name="l03140"></a>03140          exclude = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03141"></a>03141          pbl = NULL;
<a name="l03142"></a>03142          <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a> != NULL) {
<a name="l03143"></a>03143             <span class="keywordflow">for</span> (i = 0; par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; i++)
<a name="l03144"></a>03144                <span class="keywordflow">if</span> (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>) == bkname) {
<a name="l03145"></a>03145                   pbl = &amp;par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i];
<a name="l03146"></a>03146                   exclude = (pbl-&gt;<a class="code" href="group__midasincludecode.html#gae2fa2419da6dc57ec48d57da2b18b58a">output_flag</a> == 0);
<a name="l03147"></a>03147                   <span class="keywordflow">break</span>;
<a name="l03148"></a>03148                }
<a name="l03149"></a>03149             <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>[i].<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0] == 0)
<a name="l03150"></a>03150                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>, <span class="stringliteral">&quot;Received unknown bank %s&quot;</span>,
<a name="l03151"></a>03151                       block_name);
<a name="l03152"></a>03152          }
<a name="l03153"></a>03153 
<a name="l03154"></a>03154          <span class="comment">/* fill RW N-tuple */</span>
<a name="l03155"></a>03155          <span class="keywordflow">if</span> (!exclude &amp;&amp; pbl != NULL) {
<a name="l03156"></a>03156             exclude_all = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03157"></a>03157 
<a name="l03158"></a>03158             item_size = <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bktype &amp; 0xFF);
<a name="l03159"></a>03159             <span class="comment">/* set array size in bank list */</span>
<a name="l03160"></a>03160             <span class="keywordflow">if</span> ((bktype &amp; 0xFF) != <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l03161"></a>03161                n = size / item_size;
<a name="l03162"></a>03162 
<a name="l03163"></a>03163                <span class="comment">/* check bank size */</span>
<a name="l03164"></a>03164                <span class="keywordflow">if</span> (n &gt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>) {
<a name="l03165"></a>03165                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;write_event_hbook&quot;</span>,
<a name="l03166"></a>03166                          <span class="stringliteral">&quot;Bank %s has more (%d) entries than maximum value (%d)&quot;</span>,
<a name="l03167"></a>03167                          block_name, n, pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>);
<a name="l03168"></a>03168                   <span class="keywordflow">continue</span>;
<a name="l03169"></a>03169                }
<a name="l03170"></a>03170 
<a name="l03171"></a>03171                <span class="comment">/* convert bank to float values */</span>
<a name="l03172"></a>03172                <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l03173"></a>03173                   <span class="keywordflow">switch</span> (bktype &amp; 0xFF) {
<a name="l03174"></a>03174                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga7499d3aa0ca98d255f5147494ab4f572">TID_BYTE</a>:
<a name="l03175"></a>03175                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) pdata + i));
<a name="l03176"></a>03176                      <span class="keywordflow">break</span>;
<a name="l03177"></a>03177                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>:
<a name="l03178"></a>03178                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<a class="code" href="unionWORD.html">WORD</a> *) pdata + i));
<a name="l03179"></a>03179                      <span class="keywordflow">break</span>;
<a name="l03180"></a>03180                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>:
<a name="l03181"></a>03181                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pdata + i));
<a name="l03182"></a>03182                      <span class="keywordflow">break</span>;
<a name="l03183"></a>03183                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gae932ec1b283f6c4b9c30a6d489beea7f">TID_FLOAT</a>:
<a name="l03184"></a>03184                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<span class="keywordtype">float</span> *) pdata + i));
<a name="l03185"></a>03185                      <span class="keywordflow">break</span>;
<a name="l03186"></a>03186                   <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>:
<a name="l03187"></a>03187                      rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = (float) (*((<span class="keywordtype">double</span> *) pdata + i));
<a name="l03188"></a>03188                      <span class="keywordflow">break</span>;
<a name="l03189"></a>03189                   }
<a name="l03190"></a>03190                }
<a name="l03191"></a>03191 
<a name="l03192"></a>03192                <span class="comment">/* zero padding */</span>
<a name="l03193"></a>03193                <span class="keywordflow">for</span> (; i &lt; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) pbl-&gt;<a class="code" href="group__midasincludecode.html#ga4208294c0d0b8b4df63102ff7d4eb887">size</a>; i++)
<a name="l03194"></a>03194                   rwnt[pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a> + i] = 0.f;
<a name="l03195"></a>03195             } <span class="keywordflow">else</span> {
<a name="l03196"></a>03196                <span class="comment">/* fill N-tuple from structured bank */</span>
<a name="l03197"></a>03197                k = pbl-&gt;<a class="code" href="group__midasincludecode.html#gabea5afb1cbece5741ede80d53469368e">n_data</a>;
<a name="l03198"></a>03198 
<a name="l03199"></a>03199                <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l03200"></a>03200                   status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, pbl-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a>, i, &amp;hkey);
<a name="l03201"></a>03201                   <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l03202"></a>03202                      <span class="keywordflow">break</span>;
<a name="l03203"></a>03203 
<a name="l03204"></a>03204                   <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hkey, &amp;key);
<a name="l03205"></a>03205 
<a name="l03206"></a>03206                   <span class="comment">/* align data pointer */</span>
<a name="l03207"></a>03207                   pdata =
<a name="l03208"></a>03208                       (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l03209"></a>03209 
<a name="l03210"></a>03210                   <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l03211"></a>03211                      <span class="keywordflow">switch</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> &amp; 0xFF) {
<a name="l03212"></a>03212                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga7499d3aa0ca98d255f5147494ab4f572">TID_BYTE</a>:
<a name="l03213"></a>03213                         rwnt[k++] = (float) (*((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) pdata + j));
<a name="l03214"></a>03214                         <span class="keywordflow">break</span>;
<a name="l03215"></a>03215                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>:
<a name="l03216"></a>03216                         rwnt[k++] = (float) (*((<a class="code" href="unionWORD.html">WORD</a> *) pdata + j));
<a name="l03217"></a>03217                         <span class="keywordflow">break</span>;
<a name="l03218"></a>03218                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga4281dafac4285eae3e3c9be0a1d93c5a">TID_SHORT</a>:
<a name="l03219"></a>03219                         rwnt[k++] = (float) (*((<span class="keywordtype">short</span> <span class="keywordtype">int</span> *) pdata + j));
<a name="l03220"></a>03220                         <span class="keywordflow">break</span>;
<a name="l03221"></a>03221                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>:
<a name="l03222"></a>03222                         rwnt[k++] = (float) (*((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) pdata + j));
<a name="l03223"></a>03223                         <span class="keywordflow">break</span>;
<a name="l03224"></a>03224                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>:
<a name="l03225"></a>03225                         rwnt[k++] = (float) (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pdata + j));
<a name="l03226"></a>03226                         <span class="keywordflow">break</span>;
<a name="l03227"></a>03227                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>:
<a name="l03228"></a>03228                         rwnt[k++] = (float) (*((<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> *) pdata + j));
<a name="l03229"></a>03229                         <span class="keywordflow">break</span>;
<a name="l03230"></a>03230                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gae932ec1b283f6c4b9c30a6d489beea7f">TID_FLOAT</a>:
<a name="l03231"></a>03231                         rwnt[k++] = (float) (*((<span class="keywordtype">float</span> *) pdata + j));
<a name="l03232"></a>03232                         <span class="keywordflow">break</span>;
<a name="l03233"></a>03233                      <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>:
<a name="l03234"></a>03234                         rwnt[k++] = (float) (*((<span class="keywordtype">double</span> *) pdata + j));
<a name="l03235"></a>03235                         <span class="keywordflow">break</span>;
<a name="l03236"></a>03236                      }
<a name="l03237"></a>03237                   }
<a name="l03238"></a>03238 
<a name="l03239"></a>03239                   <span class="comment">/* shift data pointer to next item */</span>
<a name="l03240"></a>03240                   pdata = (<span class="keywordtype">char</span> *) pdata + key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l03241"></a>03241                }
<a name="l03242"></a>03242             }
<a name="l03243"></a>03243          }
<a name="l03244"></a>03244 
<a name="l03245"></a>03245       } <span class="keywordflow">while</span> (<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03246"></a>03246 
<a name="l03247"></a>03247       <span class="comment">/* fill shared memory */</span>
<a name="l03248"></a>03248       <a class="code" href="fal_8c.html#a9284066018f8d23f887b0f407b9a1442">HFNOV</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, rwnt);
<a name="l03249"></a>03249 
<a name="l03250"></a>03250    }
<a name="l03251"></a>03251 
<a name="l03252"></a>03252 
<a name="l03253"></a>03253    <span class="comment">/* if (event_def-&gt;format == FORMAT_MIDAS) */</span>
<a name="l03254"></a>03254  <span class="comment">/*---- FIXED format ----------------------------------------------*/</span>
<a name="l03255"></a>03255    <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
<a name="l03256"></a>03256       <span class="comment">/* fill N-tuple from structured bank */</span>
<a name="l03257"></a>03257       pdata = pevent + 1;
<a name="l03258"></a>03258       k = 3;                    <span class="comment">/* index 0..2 for run/serial/time */</span>
<a name="l03259"></a>03259 
<a name="l03260"></a>03260       <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l03261"></a>03261          status = <a class="code" href="group__msectionh.html#ga5a2a739267f29b1b1d86c5f9b25ff487">db_enum_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, event_def-&gt;<a class="code" href="structEVENT__DEF.html#a3289593eed2e93a8e2dd758252095ff6">hDefKey</a>, i, &amp;hkey);
<a name="l03262"></a>03262          <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l03263"></a>03263             <span class="keywordflow">break</span>;
<a name="l03264"></a>03264 
<a name="l03265"></a>03265          <a class="code" href="group__msectionh.html#gab97e8d856c8089519a59d3e44c0c4e65">db_get_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hkey, &amp;key);
<a name="l03266"></a>03266 
<a name="l03267"></a>03267          <span class="comment">/* align data pointer */</span>
<a name="l03268"></a>03268          pdata = (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="Mql_8h.html#a3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(<a class="code" href="group__msystemincludecode.html#gabae408f8715e9063be5cdf650a699282">ss_get_struct_align</a>(), key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l03269"></a>03269 
<a name="l03270"></a>03270          <span class="keywordflow">for</span> (j = 0; j &lt; key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>; j++) {
<a name="l03271"></a>03271             <span class="keywordflow">switch</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> &amp; 0xFF) {
<a name="l03272"></a>03272             <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga7499d3aa0ca98d255f5147494ab4f572">TID_BYTE</a>:
<a name="l03273"></a>03273                rwnt[k++] = (float) (*((<a class="code" href="group__mcstdinclude.html#ga4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) pdata + j));
<a name="l03274"></a>03274                <span class="keywordflow">break</span>;
<a name="l03275"></a>03275             <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>:
<a name="l03276"></a>03276                rwnt[k++] = (float) (*((<a class="code" href="unionWORD.html">WORD</a> *) pdata + j));
<a name="l03277"></a>03277                <span class="keywordflow">break</span>;
<a name="l03278"></a>03278             <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga4281dafac4285eae3e3c9be0a1d93c5a">TID_SHORT</a>:
<a name="l03279"></a>03279                rwnt[k++] = (float) (*((<span class="keywordtype">short</span> <span class="keywordtype">int</span> *) pdata + j));
<a name="l03280"></a>03280                <span class="keywordflow">break</span>;
<a name="l03281"></a>03281             <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>:
<a name="l03282"></a>03282                rwnt[k++] = (float) (*((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) pdata + j));
<a name="l03283"></a>03283                <span class="keywordflow">break</span>;
<a name="l03284"></a>03284             <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>:
<a name="l03285"></a>03285                rwnt[k++] = (float) (*((<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> *) pdata + j));
<a name="l03286"></a>03286                <span class="keywordflow">break</span>;
<a name="l03287"></a>03287             <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>:
<a name="l03288"></a>03288                rwnt[k++] = (float) (*((<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> *) pdata + j));
<a name="l03289"></a>03289                <span class="keywordflow">break</span>;
<a name="l03290"></a>03290             <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#gae932ec1b283f6c4b9c30a6d489beea7f">TID_FLOAT</a>:
<a name="l03291"></a>03291                rwnt[k++] = (float) (*((<span class="keywordtype">float</span> *) pdata + j));
<a name="l03292"></a>03292                <span class="keywordflow">break</span>;
<a name="l03293"></a>03293             <span class="keywordflow">case</span> <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>:
<a name="l03294"></a>03294                rwnt[k++] = (float) (*((<span class="keywordtype">double</span> *) pdata + j));
<a name="l03295"></a>03295                <span class="keywordflow">break</span>;
<a name="l03296"></a>03296             }
<a name="l03297"></a>03297          }
<a name="l03298"></a>03298 
<a name="l03299"></a>03299          <span class="comment">/* shift data pointer to next item */</span>
<a name="l03300"></a>03300          pdata = (<span class="keywordtype">char</span> *) pdata + key.<a class="code" href="group__midasincludecode.html#gacd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="group__midasincludecode.html#ga2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l03301"></a>03301       }
<a name="l03302"></a>03302 
<a name="l03303"></a>03303       <span class="comment">/* fill shared memory */</span>
<a name="l03304"></a>03304       <a class="code" href="fal_8c.html#a9284066018f8d23f887b0f407b9a1442">HFNOV</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>, rwnt);
<a name="l03305"></a>03305    }
<a name="l03306"></a>03306 
<a name="l03307"></a>03307    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03308"></a>03308 }
<a name="l03309"></a>03309 <span class="preprocessor">#endif</span>
<a name="l03310"></a>03310 <span class="preprocessor"></span>
<a name="l03311"></a>03311 <span class="comment">/*-- analyzer init routine -----------------------------------------*/</span>
<a name="l03312"></a>03312 
<a name="l03313"></a><a class="code" href="fal_8c.html#a12f9d4b93e18856d7ea847512163fc3b">03313</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a12f9d4b93e18856d7ea847512163fc3b">mana_init</a>()
<a name="l03314"></a>03314 {
<a name="l03315"></a>03315    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l03316"></a>03316    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>;
<a name="l03317"></a>03317    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l03318"></a>03318    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256], block_name[32];
<a name="l03319"></a>03319    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l03320"></a>03320    <span class="keywordtype">double</span> dummy;
<a name="l03321"></a>03321 
<a name="l03322"></a>03322    <span class="comment">/* create ODB structure for output */</span>
<a name="l03323"></a>03323    sprintf(str, <span class="stringliteral">&quot;/%s/Output&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>);
<a name="l03324"></a>03324    <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="fal_8c.html#a7c5689a91d273a5acdde5b6d6fd2a0b0">OUT_INFO_STR</a>);
<a name="l03325"></a>03325    <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hkey);
<a name="l03326"></a>03326    status = <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hkey, &amp;<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>, <span class="keyword">sizeof</span>(<a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL);
<a name="l03327"></a>03327    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03328"></a>03328       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bor&quot;</span>, <span class="stringliteral">&quot;Cannot read output info record&quot;</span>);
<a name="l03329"></a>03329       <span class="keywordflow">return</span> 0;
<a name="l03330"></a>03330    }
<a name="l03331"></a>03331 
<a name="l03332"></a>03332    <span class="comment">/* create ODB structures for banks */</span>
<a name="l03333"></a>03333    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l03334"></a>03334       bank_list = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga3130441b33d46c2072cd2c38d7a21497">bank_list</a>;
<a name="l03335"></a>03335 
<a name="l03336"></a>03336       <span class="keywordflow">if</span> (bank_list == NULL)
<a name="l03337"></a>03337          <span class="keywordflow">continue</span>;
<a name="l03338"></a>03338 
<a name="l03339"></a>03339       <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l03340"></a>03340          strncpy(block_name, bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>, 4);
<a name="l03341"></a>03341          block_name[4] = 0;
<a name="l03342"></a>03342 
<a name="l03343"></a>03343          <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a> == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l03344"></a>03344             sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, analyze_request[i].event_name,
<a name="l03345"></a>03345                     block_name);
<a name="l03346"></a>03346             <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga7ebd92f00cb428fcbb555f3ad30b86c8">init_str</a>));
<a name="l03347"></a>03347             <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hkey);
<a name="l03348"></a>03348             bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a> = hkey;
<a name="l03349"></a>03349          } <span class="keywordflow">else</span> {
<a name="l03350"></a>03350             sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, analyze_request[i].event_name,
<a name="l03351"></a>03351                     block_name);
<a name="l03352"></a>03352             dummy = 0;
<a name="l03353"></a>03353             <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;dummy, <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>), 1,
<a name="l03354"></a>03354                          bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>);
<a name="l03355"></a>03355             <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hkey);
<a name="l03356"></a>03356             bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga732747585d79c8c76c856d376aa56cf0">def_key</a> = hkey;
<a name="l03357"></a>03357          }
<a name="l03358"></a>03358       }
<a name="l03359"></a>03359    }
<a name="l03360"></a>03360 
<a name="l03361"></a>03361    <span class="comment">/* create ODB structures for fixed events */</span>
<a name="l03362"></a>03362    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l03363"></a>03363       <span class="keywordflow">if</span> (analyze_request[i].init_string) {
<a name="l03364"></a>03364          sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables&quot;</span>, analyze_request[i].event_name);
<a name="l03365"></a>03365          <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(analyze_request[i].init_string));
<a name="l03366"></a>03366       }
<a name="l03367"></a>03367    }
<a name="l03368"></a>03368 <span class="preprocessor">#ifndef MANA_LITE</span>
<a name="l03369"></a>03369 <span class="preprocessor"></span>   <span class="comment">/* create global section */</span>
<a name="l03370"></a>03370    <a class="code" href="hbook_8h.html#ac41e1ed0bb8347eadf199c22a759b0ba">HLIMAP</a>(<a class="code" href="fal_8c.html#a145953d65e4f33a2308075f26c13bfbe">pawc_size</a> / 4, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.global_memory_name);
<a name="l03371"></a>03371    printf(<span class="stringliteral">&quot;\nGLOBAL MEMORY NAME = %s\n&quot;</span>, <a class="code" href="fal_8c.html#a318694742ba8b26fea209b7a2a525f03">out_info</a>.global_memory_name);
<a name="l03372"></a>03372 
<a name="l03373"></a>03373    <span class="comment">/* book online N-tuples only once when online */</span>
<a name="l03374"></a>03374    status = <a class="code" href="fal_8c.html#a2a0fbf63d5970373f81721ce136319dc">book_ntuples</a>();
<a name="l03375"></a>03375    <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l03376"></a>03376       <span class="keywordflow">return</span> status;
<a name="l03377"></a>03377 <span class="preprocessor">#endif</span>
<a name="l03378"></a>03378 <span class="preprocessor"></span>   <span class="comment">/* call main analyzer init routine */</span>
<a name="l03379"></a>03379    status = <a class="code" href="analyzer_8cpp.html#afeea792d4dbe0001bd025397e494ab5b">analyzer_init</a>();
<a name="l03380"></a>03380    <span class="keywordflow">if</span> (status != <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>)
<a name="l03381"></a>03381       <span class="keywordflow">return</span> status;
<a name="l03382"></a>03382 
<a name="l03383"></a>03383    <span class="comment">/* initialize modules */</span>
<a name="l03384"></a>03384    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l03385"></a>03385       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l03386"></a>03386       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++) {
<a name="l03387"></a>03387          <span class="comment">/* copy module enabled flag to ana_module */</span>
<a name="l03388"></a>03388          sprintf(str, <span class="stringliteral">&quot;/%s/Module switches/%s&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>, module[j]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l03389"></a>03389          module[j]-&gt;<a class="code" href="group__midasincludecode.html#ga0d86abcfd4f421658176e51c24f7eb29">enabled</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03390"></a>03390          size = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l03391"></a>03391          <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03392"></a>03392 
<a name="l03393"></a>03393          <span class="keywordflow">if</span> (module[j]-&gt;init != NULL &amp;&amp; module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>)
<a name="l03394"></a>03394             module[j]-&gt;<a class="code" href="group__midasincludecode.html#ga8ae1120805260da00f37f34ed6d519c5">init</a>();
<a name="l03395"></a>03395       }
<a name="l03396"></a>03396    }
<a name="l03397"></a>03397 
<a name="l03398"></a>03398    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03399"></a>03399 }
<a name="l03400"></a>03400 
<a name="l03401"></a>03401 <span class="comment">/*-- init_module_parameters ----------------------------------------*/</span>
<a name="l03402"></a>03402 
<a name="l03403"></a><a class="code" href="fal_8c.html#a9527329c5d4ec01a728dfc43ad33b2fa">03403</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a9527329c5d4ec01a728dfc43ad33b2fa">init_module_parameters</a>()
<a name="l03404"></a>03404 {
<a name="l03405"></a>03405    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>;
<a name="l03406"></a>03406    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l03407"></a>03407    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[80];
<a name="l03408"></a>03408    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> hkey;
<a name="l03409"></a>03409 
<a name="l03410"></a>03410    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l03411"></a>03411       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l03412"></a>03412       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++) {
<a name="l03413"></a>03413          <span class="keywordflow">if</span> (module[j]-&gt;parameters != NULL) {
<a name="l03414"></a>03414             sprintf(str, <span class="stringliteral">&quot;/%s/Parameters/%s&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>, module[j]-&gt;<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l03415"></a>03415 
<a name="l03416"></a>03416             <span class="keywordflow">if</span> (module[j]-&gt;init_str)
<a name="l03417"></a>03417                <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(module[j]-&gt;init_str));
<a name="l03418"></a>03418 
<a name="l03419"></a>03419             <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hkey);
<a name="l03420"></a>03420             <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hkey, module[j]-&gt;parameters, module[j]-&gt;param_size,
<a name="l03421"></a>03421                                <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03422"></a>03422                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;init_module_parameters&quot;</span>,
<a name="l03423"></a>03423                       <span class="stringliteral">&quot;Cannot open \&quot;%s\&quot; parameters in ODB&quot;</span>, str);
<a name="l03424"></a>03424                <span class="keywordflow">return</span> 0;
<a name="l03425"></a>03425             }
<a name="l03426"></a>03426          }
<a name="l03427"></a>03427       }
<a name="l03428"></a>03428    }
<a name="l03429"></a>03429 
<a name="l03430"></a>03430    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03431"></a>03431 }
<a name="l03432"></a>03432 
<a name="l03433"></a>03433 <span class="comment">/*-- exit routine --------------------------------------------------*/</span>
<a name="l03434"></a>03434 
<a name="l03435"></a><a class="code" href="fal_8c.html#a11a24986d9abfd2f14209cf7c8893f52">03435</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a11a24986d9abfd2f14209cf7c8893f52">mana_exit</a>()
<a name="l03436"></a>03436 {
<a name="l03437"></a>03437    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l03438"></a>03438    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>;
<a name="l03439"></a>03439 
<a name="l03440"></a>03440    <span class="comment">/* call exit routines from modules */</span>
<a name="l03441"></a>03441    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l03442"></a>03442       module = analyze_request[i].<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l03443"></a>03443       <span class="keywordflow">for</span> (j = 0; module != NULL &amp;&amp; module[j] != NULL; j++)
<a name="l03444"></a>03444          <span class="keywordflow">if</span> (module[j]-&gt;exit != NULL &amp;&amp; module[j]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>)
<a name="l03445"></a>03445             module[j]-&gt;<a class="code" href="group__midasincludecode.html#gaf3b4cc4d6a12a8eadeea80d82866b780">exit</a>();
<a name="l03446"></a>03446    }
<a name="l03447"></a>03447 
<a name="l03448"></a>03448    <span class="comment">/* call main analyzer exit routine */</span>
<a name="l03449"></a>03449    <span class="keywordflow">return</span> <a class="code" href="analyzer_8cpp.html#a7738840c25fb678186362479850b4df6">analyzer_exit</a>();
<a name="l03450"></a>03450 }
<a name="l03451"></a>03451 
<a name="l03452"></a>03452 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03453"></a>03453 
<a name="l03454"></a>03454 <span class="keyword">struct </span>{
<a name="l03455"></a>03455    <span class="keywordtype">short</span> <span class="keywordtype">int</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l03456"></a><a class="code" href="fal_8c.html#a5fecce64b1b883ada4ac0bc410fb3304">03456</a>    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mevb_8cpp.html#a5fecce64b1b883ada4ac0bc410fb3304">last_time</a>;
<a name="l03457"></a>03457 } <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[50];
<a name="l03458"></a>03458 
<a name="l03459"></a><a class="code" href="fal_8c.html#a9d20ff6063daa3409b3dd0d4a790bd6f">03459</a> <span class="keywordtype">void</span> <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent)
<a name="l03460"></a>03460 {
<a name="l03461"></a>03461    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l03462"></a>03462    <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> **<a class="code" href="generate-MODULES_8h.html#a96e5f0eca87c2426370e0897ac7b8ca6">module</a>;
<a name="l03463"></a>03463    <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> *par;
<a name="l03464"></a>03464    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l03465"></a>03465    <a class="code" href="structEVENT__DEF.html">EVENT_DEF</a> *event_def;
<a name="l03466"></a>03466 
<a name="l03467"></a>03467    <span class="comment">/* log event to all channels  */</span>
<a name="l03468"></a>03468    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="evb_2mevb_8h.html#ac69ee46f4a51ed14f0d68628c2dec71d">MAX_CHANNELS</a>; i++) {
<a name="l03469"></a>03469       <span class="keywordflow">if</span> (log_chn[i].<a class="code" href="v1724__module_8c.html#a0e640374bff58e788b18fbed8f89fe11">handle</a> == 0)
<a name="l03470"></a>03470          <span class="keywordflow">continue</span>;
<a name="l03471"></a>03471 
<a name="l03472"></a>03472       <a class="code" href="fal_8c.html#ab757112cc906644f8c9d86fc41627951">log_write</a>(&amp;log_chn[i], pevent);
<a name="l03473"></a>03473    }
<a name="l03474"></a>03474 
<a name="l03475"></a>03475    <span class="comment">/* return for zero event size */</span>
<a name="l03476"></a>03476    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> == 0)
<a name="l03477"></a>03477       <span class="keywordflow">return</span>;
<a name="l03478"></a>03478 
<a name="l03479"></a>03479    <span class="comment">/* analyze event */</span>
<a name="l03480"></a>03480    par = analyze_request;
<a name="l03481"></a>03481 
<a name="l03482"></a>03482    <span class="keywordflow">for</span> (i = 0; par-&gt;<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; par++)
<a name="l03483"></a>03483       <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>.<a class="code" href="structAR__INFO.html#acb0cf26c5067b0c8eb7a895b70e42f11">event_id</a> == pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>) {
<a name="l03484"></a>03484          par-&gt;<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a>++;
<a name="l03485"></a>03485 
<a name="l03486"></a>03486          <span class="comment">/* call non-modular analyzer if defined */</span>
<a name="l03487"></a>03487          status = <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l03488"></a>03488          <span class="keywordflow">if</span> (par-&gt;<a class="code" href="group__midasincludecode.html#gae0728031c8b33ebc32851d6c2099a8f9">analyzer</a>)
<a name="l03489"></a>03489             status = par-&gt;<a class="code" href="group__midasincludecode.html#gae0728031c8b33ebc32851d6c2099a8f9">analyzer</a>(pevent, (<span class="keywordtype">void</span> *) (pevent + 1));
<a name="l03490"></a>03490 
<a name="l03491"></a>03491          <span class="comment">/* don&apos;t continue if event was rejected */</span>
<a name="l03492"></a>03492          <span class="keywordflow">if</span> (status == 0)
<a name="l03493"></a>03493             <span class="keywordflow">return</span>;
<a name="l03494"></a>03494 
<a name="l03495"></a>03495          <span class="comment">/* loop over analyzer modules */</span>
<a name="l03496"></a>03496          module = par-&gt;<a class="code" href="group__midasincludecode.html#ga84e88396cff69efebe3dad2289fe70c9">ana_module</a>;
<a name="l03497"></a>03497          <span class="keywordflow">for</span> (i = 0; module != NULL &amp;&amp; module[i] != NULL; i++) {
<a name="l03498"></a>03498             <span class="keywordflow">if</span> (module[i]-&gt;<a class="code" href="crate3_2rpc__master_8cpp.html#ac19b89f25c9dfa8d24866a5c108d6477">enabled</a>) {
<a name="l03499"></a>03499                status = module[i]-&gt;<a class="code" href="group__midasincludecode.html#gaf3d6511a274c1946ce0bf45e7000e756">analyzer</a>(pevent, (<span class="keywordtype">void</span> *) (pevent + 1));
<a name="l03500"></a>03500 
<a name="l03501"></a>03501                <span class="comment">/* don&apos;t continue if event was rejected */</span>
<a name="l03502"></a>03502                <span class="keywordflow">if</span> (status == 0)
<a name="l03503"></a>03503                   <span class="keywordflow">return</span>;
<a name="l03504"></a>03504             }
<a name="l03505"></a>03505          }
<a name="l03506"></a>03506 
<a name="l03507"></a>03507          <span class="comment">/* correct for increased event size */</span>
<a name="l03508"></a>03508          event_def = <a class="code" href="fal_8c.html#ad5d6f1e4c99351c9278d6189b7e87b08">db_get_event_definition</a>(pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l03509"></a>03509          <span class="keywordflow">if</span> (event_def == NULL)
<a name="l03510"></a>03510             <span class="keywordflow">return</span>;
<a name="l03511"></a>03511 
<a name="l03512"></a>03512          <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>)
<a name="l03513"></a>03513             pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = <a class="code" href="group__msectionh.html#ga825db64c9ef9b4656698c890fca37c05">bk_size</a>((<span class="keywordtype">void</span> *) (pevent + 1));
<a name="l03514"></a>03514          <span class="keywordflow">if</span> (event_def-&gt;<a class="code" href="structEVENT__DEF.html#a341f5361543139655a35bcb1cdedf265">format</a> == <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>)
<a name="l03515"></a>03515             pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = <a class="code" href="group__ybosincludecode.html#gab97b7d0d9ea164c791c36374826d19fe">ybk_size</a>((<span class="keywordtype">void</span> *) (pevent + 1));
<a name="l03516"></a>03516 
<a name="l03517"></a>03517          <span class="comment">/* increment tests */</span>
<a name="l03518"></a>03518          <a class="code" href="fal_8c.html#a5d0c60b46806a49cf44b5db6053b1e0f">test_increment</a>();
<a name="l03519"></a>03519 <span class="preprocessor">#ifndef MANA_LITE</span>
<a name="l03520"></a>03520 <span class="preprocessor"></span>         <a class="code" href="fal_8c.html#a2ba1d8e79f061e622f62471ae9bc7063">write_event_hbook</a>(pevent, par);
<a name="l03521"></a>03521 <span class="preprocessor">#endif</span>
<a name="l03522"></a>03522 <span class="preprocessor"></span>
<a name="l03523"></a>03523          <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l03524"></a>03524             <span class="keywordflow">if</span> (equipment[i].info.event_id == pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>)
<a name="l03525"></a>03525                <span class="keywordflow">break</span>;
<a name="l03526"></a>03526 
<a name="l03527"></a>03527          <span class="keywordflow">if</span> ((equipment[i].info.read_on &amp; <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a>) || equipment[i].<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#ga2740dd481bbbb7c8e417b5818ff8e064">history</a>) {
<a name="l03528"></a>03528             <span class="comment">/* put event in ODB once every second */</span>
<a name="l03529"></a>03529             actual_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l03530"></a>03530             <span class="keywordflow">for</span> (i = 0; i &lt; 50; i++) {
<a name="l03531"></a>03531                <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> == pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>) {
<a name="l03532"></a>03532                   <span class="keywordflow">if</span> (actual_time - <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].<a class="code" href="mevb_8cpp.html#a5fecce64b1b883ada4ac0bc410fb3304">last_time</a> &gt; 1000) {
<a name="l03533"></a>03533                      <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].last_time = actual_time;
<a name="l03534"></a>03534                      <a class="code" href="fal_8c.html#ab55e3bbd032e2ede908194386fdd0dc3">write_event_odb</a>(pevent, par);
<a name="l03535"></a>03535                   }
<a name="l03536"></a>03536                   <span class="keywordflow">break</span>;
<a name="l03537"></a>03537                }
<a name="l03538"></a>03538                <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a> == 0) {
<a name="l03539"></a>03539                   <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].event_id = pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>;
<a name="l03540"></a>03540                   <a class="code" href="fal_8c.html#a1bb2767e19e7d887ef6f9b80f7835af3">last_time_event</a>[i].last_time = actual_time;
<a name="l03541"></a>03541                   <a class="code" href="fal_8c.html#ab55e3bbd032e2ede908194386fdd0dc3">write_event_odb</a>(pevent, par);
<a name="l03542"></a>03542                   <span class="keywordflow">break</span>;
<a name="l03543"></a>03543                }
<a name="l03544"></a>03544             }
<a name="l03545"></a>03545          }
<a name="l03546"></a>03546 
<a name="l03547"></a>03547       }
<a name="l03548"></a>03548 }
<a name="l03549"></a>03549 
<a name="l03550"></a>03550 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03551"></a>03551 
<a name="l03552"></a><a class="code" href="fal_8c.html#abd8c095343249df7bf669d75ee933293">03552</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#abd8c095343249df7bf669d75ee933293">manual_trigger</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <span class="keywordtype">void</span> *prpc_param[])
<a name="l03553"></a>03553 {
<a name="l03554"></a>03554    <a class="code" href="unionWORD.html">WORD</a> <a class="code" href="examples_2macro_2midas__macro_8h.html#a6bff0a5e8995a80f74212d31f551167a">event_id</a>;
<a name="l03555"></a>03555    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l03556"></a>03556 
<a name="l03557"></a>03557    event_id = <a class="code" href="group__msectionh.html#ga94a92016dc66b32a6c75df667df20866">CWORD</a>(0);
<a name="l03558"></a>03558 
<a name="l03559"></a>03559    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l03560"></a>03560       <span class="keywordflow">if</span> (equipment[i].info.event_id == event_id)
<a name="l03561"></a>03561          <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">send_event</a>(i);
<a name="l03562"></a>03562 
<a name="l03563"></a>03563    <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l03564"></a>03564       <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l03565"></a>03565 
<a name="l03566"></a>03566    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03567"></a>03567 }
<a name="l03568"></a>03568 
<a name="l03569"></a>03569 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03570"></a>03570 
<a name="l03571"></a><a class="code" href="fal_8c.html#ab834073e5b665fccaa4eff2a61bc9372">03571</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ab834073e5b665fccaa4eff2a61bc9372">register_equipment</a>(<span class="keywordtype">void</span>)
<a name="l03572"></a>03572 {
<a name="l03573"></a>03573    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="odbhist_8c.html#a43fa990200c3ddd47c35f151bd4d66bf">k</a>, <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>;
<a name="l03574"></a>03574    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l03575"></a>03575    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l03576"></a>03576    <a class="code" href="structEQUIPMENT__STATS.html">EQUIPMENT_STATS</a> *eq_stats;
<a name="l03577"></a>03577    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="old__mevb_8cpp.html#af4211e1ba0e676018599e88cfae3537a">start_time</a>, <a class="code" href="mchart_8c.html#a36255e64f0394c6b59219618ef099ff9">delta_time</a>;
<a name="l03578"></a>03578    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l03579"></a>03579    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> manual_trig_flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03580"></a>03580    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l03581"></a>03581    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> dummy;
<a name="l03582"></a>03582 
<a name="l03583"></a>03583    <span class="comment">/* get current ODB run state */</span>
<a name="l03584"></a>03584    size = <span class="keyword">sizeof</span>(<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>);
<a name="l03585"></a>03585    <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> = <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>;
<a name="l03586"></a>03586    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/State&quot;</span>, &amp;<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03587"></a>03587    size = <span class="keyword">sizeof</span>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l03588"></a>03588    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = 1;
<a name="l03589"></a>03589    <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/Run number&quot;</span>, &amp;<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03590"></a>03590 
<a name="l03591"></a>03591    <span class="comment">/* scan EQUIPMENT table from FRONTEND.C */</span>
<a name="l03592"></a>03592    <span class="keywordflow">for</span> (index = 0; equipment[index].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; index++) {
<a name="l03593"></a>03593       eq_info = &amp;equipment[index].<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l03594"></a>03594       eq_stats = &amp;equipment[index].<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>;
<a name="l03595"></a>03595 
<a name="l03596"></a>03596       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a> == 0) {
<a name="l03597"></a>03597          printf(<span class="stringliteral">&quot;Event ID 0 for %s not allowed\n&quot;</span>, equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l03598"></a>03598          <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(5000);
<a name="l03599"></a>03599       }
<a name="l03600"></a>03600 
<a name="l03601"></a>03601       <span class="comment">/* init status */</span>
<a name="l03602"></a>03602       equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>;
<a name="l03603"></a>03603 
<a name="l03604"></a>03604       sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Common&quot;</span>, equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l03605"></a>03605 
<a name="l03606"></a>03606       <span class="comment">/* get last event limit from ODB */</span>
<a name="l03607"></a>03607       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> != <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) {
<a name="l03608"></a>03608          <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l03609"></a>03609          size = <span class="keyword">sizeof</span>(double);
<a name="l03610"></a>03610          <span class="keywordflow">if</span> (hKey)
<a name="l03611"></a>03611             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Event limit&quot;</span>, &amp;eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>, &amp;size,
<a name="l03612"></a>03612                          <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03613"></a>03613       }
<a name="l03614"></a>03614 
<a name="l03615"></a>03615       <span class="comment">/* Create common subtree */</span>
<a name="l03616"></a>03616       status = <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac92b30327caaa939b1b6630775c78ecd">EQUIPMENT_COMMON_STR</a>);
<a name="l03617"></a>03617       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03618"></a>03618          printf(<span class="stringliteral">&quot;Cannot init equipment record, probably other FE is using it\n&quot;</span>);
<a name="l03619"></a>03619          <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l03620"></a>03620       }
<a name="l03621"></a>03621       <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l03622"></a>03622 
<a name="l03623"></a>03623       <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga60d08f3eadb2b1f809d06d7a64b0bc5e">format</a>, <span class="stringliteral">&quot;YBOS&quot;</span>))
<a name="l03624"></a>03624          equipment[index].<a class="code" href="group__midasincludecode.html#gacad980d7699722234c72bfca6243203b">format</a> = <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>;
<a name="l03625"></a>03625       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga60d08f3eadb2b1f809d06d7a64b0bc5e">format</a>, <span class="stringliteral">&quot;FIXED&quot;</span>))
<a name="l03626"></a>03626          equipment[index].<a class="code" href="group__midasincludecode.html#gacad980d7699722234c72bfca6243203b">format</a> = <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>;
<a name="l03627"></a>03627       <span class="keywordflow">else</span>                      <span class="comment">/* default format is MIDAS */</span>
<a name="l03628"></a>03628          equipment[index].<a class="code" href="group__midasincludecode.html#gacad980d7699722234c72bfca6243203b">format</a> = <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>;
<a name="l03629"></a>03629 
<a name="l03630"></a>03630       gethostname(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0f7f20fef7826740571d2ffa82da4dfd">frontend_host</a>, <span class="keyword">sizeof</span>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0f7f20fef7826740571d2ffa82da4dfd">frontend_host</a>));
<a name="l03631"></a>03631       strcpy(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga2cfd04e323109fe1cbb75ca8047aaa77">frontend_name</a>, <a class="code" href="crate3_2crate_8cpp.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>);
<a name="l03632"></a>03632       strcpy(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0788ebd106c11c952e09f99e142d8bbf">frontend_file_name</a>, <a class="code" href="crate3_2crate_8cpp.html#aa045f89d0b0691cb1d05174b13369750">frontend_file_name</a>);
<a name="l03633"></a>03633 
<a name="l03634"></a>03634       <span class="comment">/* set record from equipment[] table in frontend.c */</span>
<a name="l03635"></a>03635       <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_info, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a>), 0);
<a name="l03636"></a>03636 
<a name="l03637"></a>03637       <span class="comment">/* open hot link to equipment info */</span>
<a name="l03638"></a>03638       <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_info, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL);
<a name="l03639"></a>03639 
<a name="l03640"></a>03640     <span class="comment">/*---- Create variables record ---------------------------------*/</span>
<a name="l03641"></a>03641       sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables&quot;</span>, equipment[index].name);
<a name="l03642"></a>03642       <span class="keywordflow">if</span> (equipment[index].event_descrip) {
<a name="l03643"></a>03643          <span class="keywordflow">if</span> (equipment[index].<a class="code" href="webpaw_8c.html#a6113855b8e5965f1e91ee407b4026ab7">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>)
<a name="l03644"></a>03644             <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, (<span class="keywordtype">char</span> *) equipment[index].event_descrip);
<a name="l03645"></a>03645          <span class="keywordflow">else</span> {
<a name="l03646"></a>03646             <span class="comment">/* create bank descriptions */</span>
<a name="l03647"></a>03647             bank_list = (<a class="code" href="structBANK__LIST.html">BANK_LIST</a> *) equipment[index].event_descrip;
<a name="l03648"></a>03648 
<a name="l03649"></a>03649             <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l03650"></a>03650                <span class="comment">/* mabye needed later...</span>
<a name="l03651"></a>03651 <span class="comment">                  if (bank_list-&gt;output_flag == 0)</span>
<a name="l03652"></a>03652 <span class="comment">                  continue;</span>
<a name="l03653"></a>03653 <span class="comment">                */</span>
<a name="l03654"></a>03654 
<a name="l03655"></a>03655                <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a> == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l03656"></a>03656                   sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, equipment[index].name,
<a name="l03657"></a>03657                           bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l03658"></a>03658                   <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="group__msectionh.html#gaccf82d3dbd8eb7090db598725713e012">strcomb</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga7ebd92f00cb428fcbb555f3ad30b86c8">init_str</a>));
<a name="l03659"></a>03659                } <span class="keywordflow">else</span> {
<a name="l03660"></a>03660                   sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, equipment[index].name,
<a name="l03661"></a>03661                           bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l03662"></a>03662                   dummy = 0;
<a name="l03663"></a>03663                   <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;dummy, <a class="code" href="group__msectionh.html#gaa0bf5cc257f83e9a7f3936738fe009f3">rpc_tid_size</a>(bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>), 1,
<a name="l03664"></a>03664                                bank_list-&gt;<a class="code" href="group__midasincludecode.html#ga949d7a28bdf3923796ffb2dff8f28690">type</a>);
<a name="l03665"></a>03665                }
<a name="l03666"></a>03666             }
<a name="l03667"></a>03667          }
<a name="l03668"></a>03668       } <span class="keywordflow">else</span>
<a name="l03669"></a>03669          <a class="code" href="group__msectionh.html#ga1441e5b7ca1923cf8611f920cf2c31b4">db_create_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="group__mdefineh.html#ga15ae151ae0b7588b3327bd8451d9bcb8">TID_KEY</a>);
<a name="l03670"></a>03670 
<a name="l03671"></a>03671       sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables&quot;</span>, equipment[index].name);
<a name="l03672"></a>03672       <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l03673"></a>03673       equipment[index].<a class="code" href="group__midasincludecode.html#gab6664c255e4c3fdc58806733ac04503b">hkey_variables</a> = hKey;
<a name="l03674"></a>03674 
<a name="l03675"></a>03675     <span class="comment">/*---- Create and initialize statistics tree -------------------*/</span>
<a name="l03676"></a>03676       sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Statistics&quot;</span>, equipment[index].name);
<a name="l03677"></a>03677 
<a name="l03678"></a>03678     <span class="comment">/*-PAA- Needed in case Statistics exists but size = 0 */</span>
<a name="l03679"></a>03679     <span class="comment">/*-SR- Not needed since db_create_record does a delete already */</span>
<a name="l03680"></a>03680 
<a name="l03681"></a>03681       status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l03682"></a>03682       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03683"></a>03683          status = <a class="code" href="group__msectionh.html#ga91277a012e0bfddbc32885da450409e0">db_delete_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l03684"></a>03684          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03685"></a>03685             printf(<span class="stringliteral">&quot;Cannot delete statistics record, error %d\n&quot;</span>, status);
<a name="l03686"></a>03686             <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l03687"></a>03687          }
<a name="l03688"></a>03688       }
<a name="l03689"></a>03689 
<a name="l03690"></a>03690       status = <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6064db0cc46885d207cedb497e3c355e">EQUIPMENT_STATISTICS_STR</a>);
<a name="l03691"></a>03691       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03692"></a>03692          printf(<span class="stringliteral">&quot;Cannot create statistics record, error %d\n&quot;</span>, status);
<a name="l03693"></a>03693          <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l03694"></a>03694       }
<a name="l03695"></a>03695 
<a name="l03696"></a>03696       status = <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l03697"></a>03697       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03698"></a>03698          printf(<span class="stringliteral">&quot;Cannot find statistics record, error %d\n&quot;</span>, status);
<a name="l03699"></a>03699          <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l03700"></a>03700       }
<a name="l03701"></a>03701 
<a name="l03702"></a>03702       eq_stats-&gt;<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> = 0;
<a name="l03703"></a>03703       eq_stats-&gt;<a class="code" href="group__midasincludecode.html#ga218c744ea441413af262fbd5ddf3780f">events_per_sec</a> = 0;
<a name="l03704"></a>03704       eq_stats-&gt;<a class="code" href="group__midasincludecode.html#ga7a7a7d4b78841a36d156a0941616538f">kbytes_per_sec</a> = 0;
<a name="l03705"></a>03705 
<a name="l03706"></a>03706       <span class="comment">/* open hot link to statistics tree */</span>
<a name="l03707"></a>03707       status =
<a name="l03708"></a>03708           <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_stats, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__STATS.html">EQUIPMENT_STATS</a>), <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a>, NULL,
<a name="l03709"></a>03709                          NULL);
<a name="l03710"></a>03710       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l03711"></a>03711          printf
<a name="l03712"></a>03712              (<span class="stringliteral">&quot;Cannot open statistics record, error %d. Probably other FE is using it\n&quot;</span>,
<a name="l03713"></a>03713               status);
<a name="l03714"></a>03714          <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l03715"></a>03715       }
<a name="l03716"></a>03716 
<a name="l03717"></a>03717     <span class="comment">/*---- open event buffer ---------------------------------------*/</span>
<a name="l03718"></a>03718       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>[0]) {
<a name="l03719"></a>03719          status =
<a name="l03720"></a>03720              <a class="code" href="group__msectionh.html#ga50e2528e639499eb42a75d47c7d58ca1">bm_open_buffer</a>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>, <a class="code" href="group__midasincludecode.html#gacc4dda1aaabc9862fe79fd94e0b722bf">EVENT_BUFFER_SIZE</a>,
<a name="l03721"></a>03721                             &amp;equipment[index].<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>);
<a name="l03722"></a>03722          <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a> &amp;&amp; status != <a class="code" href="group__err22.html#gaf4d0ec9887b0864c100b8062d21f4c0b">BM_CREATED</a>) {
<a name="l03723"></a>03723             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>,
<a name="l03724"></a>03724                    <span class="stringliteral">&quot;Cannot open event buffer. Try to reduce EVENT_BUFFER_SIZE in midas.h \</span>
<a name="l03725"></a>03725 <span class="stringliteral">and rebuild the system.&quot;</span>);
<a name="l03726"></a>03726             <span class="keywordflow">return</span> 0;
<a name="l03727"></a>03727          }
<a name="l03728"></a>03728 
<a name="l03729"></a>03729          <span class="comment">/* set the default buffer cache size */</span>
<a name="l03730"></a>03730          <a class="code" href="group__msectionh.html#ga3d70a1e1e38b6ccf6bde4bc5b436ae5b">bm_set_cache_size</a>(equipment[index].buffer_handle, 0, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a022c39e327f494dda3664f8888f860f1">SERVER_CACHE_SIZE</a>);
<a name="l03731"></a>03731       } <span class="keywordflow">else</span>
<a name="l03732"></a>03732          equipment[index].<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a> = 0;
<a name="l03733"></a>03733 
<a name="l03734"></a>03734     <span class="comment">/*---- evaluate polling count ----------------------------------*/</span>
<a name="l03735"></a>03735       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>) {
<a name="l03736"></a>03736          <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l03737"></a>03737             printf(<span class="stringliteral">&quot;\nCalibrating&quot;</span>);
<a name="l03738"></a>03738 
<a name="l03739"></a>03739          count = 1;
<a name="l03740"></a>03740          <span class="keywordflow">do</span> {
<a name="l03741"></a>03741             <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l03742"></a>03742                printf(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l03743"></a>03743 
<a name="l03744"></a>03744             start_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l03745"></a>03745 
<a name="l03746"></a>03746             <a class="code" href="crate3_2crate_8cpp.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(equipment[index].info.source, count, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03747"></a>03747 
<a name="l03748"></a>03748             delta_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>() - start_time;
<a name="l03749"></a>03749 
<a name="l03750"></a>03750             <span class="keywordflow">if</span> (delta_time &gt; 0)
<a name="l03751"></a>03751                count = (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) ((<span class="keywordtype">double</span>) count * 100 / delta_time);
<a name="l03752"></a>03752             <span class="keywordflow">else</span>
<a name="l03753"></a>03753                count *= 100;
<a name="l03754"></a>03754          } <span class="keywordflow">while</span> (delta_time &gt; 120 || delta_time &lt; 80);
<a name="l03755"></a>03755 
<a name="l03756"></a>03756          equipment[index].<a class="code" href="group__midasincludecode.html#gae9bf94db8ff48533601c3833b1b20097">poll_count</a> = (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) ((<span class="keywordtype">double</span>) eq_info-&gt;<a class="code" href="group__midasincludecode.html#gaf7f674490636b6f9736fb680201001c2">period</a> / 100 * count);
<a name="l03757"></a>03757 
<a name="l03758"></a>03758          <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l03759"></a>03759             printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l03760"></a>03760       }
<a name="l03761"></a>03761 
<a name="l03762"></a>03762     <span class="comment">/*---- initialize interrupt events -----------------------------*/</span>
<a name="l03763"></a>03763       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gad5ba2ec0f5d55139048dbe2d416da6ba">EQ_INTERRUPT</a>) {
<a name="l03764"></a>03764          <span class="comment">/* install interrupt for interrupt events */</span>
<a name="l03765"></a>03765 
<a name="l03766"></a>03766          <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l03767"></a>03767             <span class="keywordflow">if</span> (equipment[i].info.eq_type &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>) {
<a name="l03768"></a>03768                equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l03769"></a>03769                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>,
<a name="l03770"></a>03770                       <span class="stringliteral">&quot;Interrupt readout cannot be combined with polled readout&quot;</span>);
<a name="l03771"></a>03771             }
<a name="l03772"></a>03772 
<a name="l03773"></a>03773          <span class="keywordflow">if</span> (equipment[index].status != <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>) {
<a name="l03774"></a>03774             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>) {
<a name="l03775"></a>03775                <span class="keywordflow">if</span> (interrupt_eq) {
<a name="l03776"></a>03776                   equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l03777"></a>03777                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>,
<a name="l03778"></a>03778                          <span class="stringliteral">&quot;Defined more than one equipment with interrupt readout&quot;</span>);
<a name="l03779"></a>03779                } <span class="keywordflow">else</span> {
<a name="l03780"></a>03780                   <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="group__err26.html#ga8a891110d186a3a4b02f6dfde253efb2">CMD_INTERRUPT_ATTACH</a>, eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga345e65d8874f6b968bedc00e76d4f431">source</a>,
<a name="l03781"></a>03781                                       (<a class="code" href="group__midasincludecode.html#ga790216a8e71233fed28657b16a052e36">PTYPE</a>) <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">interrupt_routine</a>);
<a name="l03782"></a>03782                   interrupt_eq = &amp;equipment[index];
<a name="l03783"></a>03783                   interrupt_odb_buffer = malloc(<a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l03784"></a>03784                }
<a name="l03785"></a>03785             } <span class="keywordflow">else</span> {
<a name="l03786"></a>03786                equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l03787"></a>03787                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>,
<a name="l03788"></a>03788                       <span class="stringliteral">&quot;Equipment %s disabled in file \&quot;frontend.c\&quot;&quot;</span>,
<a name="l03789"></a>03789                       equipment[index].name);
<a name="l03790"></a>03790             }
<a name="l03791"></a>03791          }
<a name="l03792"></a>03792       }
<a name="l03793"></a>03793 
<a name="l03794"></a>03794     <span class="comment">/*---- initialize slow control equipment -----------------------*/</span>
<a name="l03795"></a>03795       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) {
<a name="l03796"></a>03796          <span class="comment">/* resolve duplicate device names */</span>
<a name="l03797"></a>03797          <span class="keywordflow">for</span> (i = 0; equipment[index].<a class="code" href="group__midasincludecode.html#gaf19c464fc7092048c9418328ca4e4afc">driver</a>[i].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0]; i++)
<a name="l03798"></a>03798             <span class="keywordflow">for</span> (j = i + 1; equipment[index].<a class="code" href="group__midasincludecode.html#gaf19c464fc7092048c9418328ca4e4afc">driver</a>[j].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0]; j++)
<a name="l03799"></a>03799                <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[i].name,
<a name="l03800"></a>03800                                  equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[j].name)) {
<a name="l03801"></a>03801                   strcpy(str, equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[i].name);
<a name="l03802"></a>03802                   <span class="keywordflow">for</span> (k = 0, n = 0; equipment[index].<a class="code" href="group__midasincludecode.html#gaf19c464fc7092048c9418328ca4e4afc">driver</a>[k].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0]; k++)
<a name="l03803"></a>03803                      <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga394539b87025a42608497b31260142c8">equal_ustring</a>(str, equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[k].name))
<a name="l03804"></a>03804                         sprintf(equipment[index].<a class="code" href="examples_2macro_2midas__macro_8h.html#a612199f8c1c02dff06a91020903b66c1">driver</a>[k].name, <span class="stringliteral">&quot;%s_%d&quot;</span>, str, n++);
<a name="l03805"></a>03805 
<a name="l03806"></a>03806                   <span class="keywordflow">break</span>;
<a name="l03807"></a>03807                }
<a name="l03808"></a>03808 
<a name="l03809"></a>03809          <span class="comment">/* loop over equipment list and call class driver&apos;s init method */</span>
<a name="l03810"></a>03810          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>)
<a name="l03811"></a>03811             equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = equipment[index].<a class="code" href="group__midasincludecode.html#gae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga2677fc43f8393bcf3bafc8bbface003f">CMD_INIT</a>, &amp;equipment[index]);
<a name="l03812"></a>03812          <span class="keywordflow">else</span> {
<a name="l03813"></a>03813             equipment[index].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l03814"></a>03814             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#a6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>,
<a name="l03815"></a>03815                    <span class="stringliteral">&quot;Equipment %s disabled in file \&quot;frontend.c\&quot;&quot;</span>, equipment[index].name);
<a name="l03816"></a>03816          }
<a name="l03817"></a>03817 
<a name="l03818"></a>03818          <span class="comment">/* let user read error messages */</span>
<a name="l03819"></a>03819          <span class="keywordflow">if</span> (equipment[index].status != <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l03820"></a>03820             <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(3000);
<a name="l03821"></a>03821       }
<a name="l03822"></a>03822 
<a name="l03823"></a>03823     <span class="comment">/*---- register callback for manual triggered events -----------*/</span>
<a name="l03824"></a>03824       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gac73e1045dff2b724325100af2e946717">EQ_MANUAL_TRIG</a>) {
<a name="l03825"></a>03825          <span class="keywordflow">if</span> (!manual_trig_flag)
<a name="l03826"></a>03826             <a class="code" href="group__msectionh.html#gad3115b4913387a49fb131e5144509557">cm_register_function</a>(<a class="code" href="group__mrpcdefineh.html#gaf820c7d84c71a1469983d23ebec18a8f">RPC_MANUAL_TRIG</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#abd8c095343249df7bf669d75ee933293">manual_trigger</a>);
<a name="l03827"></a>03827 
<a name="l03828"></a>03828          manual_trig_flag = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l03829"></a>03829       }
<a name="l03830"></a>03830    }
<a name="l03831"></a>03831 
<a name="l03832"></a>03832    <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03833"></a>03833 }
<a name="l03834"></a>03834 
<a name="l03835"></a>03835 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03836"></a>03836 
<a name="l03837"></a><a class="code" href="fal_8c.html#a1a2128d90a2986636c9e80968c0d5c67">03837</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a1a2128d90a2986636c9e80968c0d5c67">register_requests</a>(<span class="keywordtype">void</span>)
<a name="l03838"></a>03838 {
<a name="l03839"></a>03839    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l03840"></a>03840    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l03841"></a>03841    <a class="code" href="structAR__INFO.html">AR_INFO</a> *ar_info;
<a name="l03842"></a>03842    <a class="code" href="structAR__STATS.html">AR_STATS</a> *ar_stats;
<a name="l03843"></a>03843    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mevb_8cpp.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l03844"></a>03844 
<a name="l03845"></a>03845    <span class="comment">/* scan ANALYZE_REQUEST table from ANALYZE.C */</span>
<a name="l03846"></a>03846    <span class="keywordflow">for</span> (index = 0; analyze_request[index].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; index++) {
<a name="l03847"></a>03847       ar_info = &amp;analyze_request[index].<a class="code" href="group__midasincludecode.html#gabb8861e2bf01fae8d66f0f49ca6cd74c">ar_info</a>;
<a name="l03848"></a>03848       ar_stats = &amp;analyze_request[index].<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>;
<a name="l03849"></a>03849 
<a name="l03850"></a>03850       <span class="comment">/* create common subtree from analyze_request table in analyze.c */</span>
<a name="l03851"></a>03851       sprintf(str, <span class="stringliteral">&quot;/%s/%s/Common&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>, analyze_request[index].event_name);
<a name="l03852"></a>03852       <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="fal_8c.html#a9b830b651a8c873d619d16eb495097af">ANALYZER_REQUEST_STR</a>);
<a name="l03853"></a>03853       <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l03854"></a>03854       analyze_request[index].<a class="code" href="group__midasincludecode.html#ga7c9dd18e861558a006b694b3c9f197a1">hkey_common</a> = hKey;
<a name="l03855"></a>03855 
<a name="l03856"></a>03856       strcpy(ar_info-&gt;<a class="code" href="group__midasincludecode.html#ga1331a0c0525a7f42a0f9c23d897cf46c">client_name</a>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>);
<a name="l03857"></a>03857       gethostname(ar_info-&gt;<a class="code" href="group__midasincludecode.html#gae70ac5ffc29fabfaf9a87e717f75dae0">host</a>, <span class="keyword">sizeof</span>(ar_info-&gt;<a class="code" href="group__midasincludecode.html#gae70ac5ffc29fabfaf9a87e717f75dae0">host</a>));
<a name="l03858"></a>03858       <a class="code" href="group__msectionh.html#ga793daffa9cdc43b03465a1f2e82e58fc">db_set_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, ar_info, <span class="keyword">sizeof</span>(<a class="code" href="structAR__INFO.html">AR_INFO</a>), 0);
<a name="l03859"></a>03859 
<a name="l03860"></a>03860       <span class="comment">/* create statistics tree */</span>
<a name="l03861"></a>03861       sprintf(str, <span class="stringliteral">&quot;/%s/%s/Statistics&quot;</span>, <a class="code" href="analyzer_8cpp.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a>, analyze_request[index].event_name);
<a name="l03862"></a>03862       <a class="code" href="group__msectionh.html#ga8ed1d02d89738e2ac692ec60e727d1a7">db_create_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="fal_8c.html#a407acb59ee878974632978f7682e8d23">ANALYZER_STATS_STR</a>);
<a name="l03863"></a>03863       <a class="code" href="group__msectionh.html#ga2c6408e2f225703c9a666a2ab23d7680">db_find_key</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l03864"></a>03864 
<a name="l03865"></a>03865       ar_stats-&gt;<a class="code" href="structAR__STATS.html#ae75a481fd926f515b17a3e2b63ee283a">events_received</a> = 0;
<a name="l03866"></a>03866       ar_stats-&gt;<a class="code" href="group__midasincludecode.html#ga3695a89775259f076f838bf46af2e00f">events_per_sec</a> = 0;
<a name="l03867"></a>03867       ar_stats-&gt;<a class="code" href="group__midasincludecode.html#ga142015e81c965f9e9fba58f5a6322525">events_written</a> = 0;
<a name="l03868"></a>03868 
<a name="l03869"></a>03869       <span class="comment">/* open hot link to statistics tree */</span>
<a name="l03870"></a>03870       status =
<a name="l03871"></a>03871           <a class="code" href="group__msectionh.html#ga3495173a9725dc8c44167b71560aa290">db_open_record</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, ar_stats, <span class="keyword">sizeof</span>(<a class="code" href="structAR__STATS.html">AR_STATS</a>), <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a>, NULL, NULL);
<a name="l03872"></a>03872       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l03873"></a>03873          printf(<span class="stringliteral">&quot;Cannot open statistics record, probably other analyzer is using it\n&quot;</span>);
<a name="l03874"></a>03874    }
<a name="l03875"></a>03875 }
<a name="l03876"></a>03876 
<a name="l03877"></a>03877 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03878"></a>03878 
<a name="l03879"></a><a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">03879</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>()
<a name="l03880"></a>03880 {
<a name="l03881"></a>03881    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l03882"></a>03882    <a class="code" href="structAR__STATS.html">AR_STATS</a> *ar_stats;
<a name="l03883"></a>03883    <span class="keyword">static</span> <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="mevb_8cpp.html#a5fecce64b1b883ada4ac0bc410fb3304">last_time</a> = 0;
<a name="l03884"></a>03884    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l03885"></a>03885 
<a name="l03886"></a>03886    actual_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l03887"></a>03887 
<a name="l03888"></a>03888    <span class="keywordflow">if</span> (last_time == 0)
<a name="l03889"></a>03889       last_time = actual_time;
<a name="l03890"></a>03890 
<a name="l03891"></a>03891    <span class="keywordflow">if</span> (actual_time - last_time == 0)
<a name="l03892"></a>03892       <span class="keywordflow">return</span>;
<a name="l03893"></a>03893 
<a name="l03894"></a>03894    <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l03895"></a>03895       ar_stats = &amp;analyze_request[i].<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>;
<a name="l03896"></a>03896       ar_stats-&gt;<a class="code" href="structAR__STATS.html#ae75a481fd926f515b17a3e2b63ee283a">events_received</a> += analyze_request[i].<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a>;
<a name="l03897"></a>03897       ar_stats-&gt;<a class="code" href="group__midasincludecode.html#ga142015e81c965f9e9fba58f5a6322525">events_written</a> += analyze_request[i].<a class="code" href="group__midasincludecode.html#gaeaa47cc2392bfdc8a1ee1a459082c876">events_written</a>;
<a name="l03898"></a>03898       ar_stats-&gt;<a class="code" href="group__midasincludecode.html#ga3695a89775259f076f838bf46af2e00f">events_per_sec</a> =
<a name="l03899"></a>03899           (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) (analyze_request[i].events_received /
<a name="l03900"></a>03900                    ((actual_time - last_time) / 1000.0));
<a name="l03901"></a>03901       analyze_request[i].<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a> = 0;
<a name="l03902"></a>03902       analyze_request[i].<a class="code" href="group__midasincludecode.html#gaeaa47cc2392bfdc8a1ee1a459082c876">events_written</a> = 0;
<a name="l03903"></a>03903    }
<a name="l03904"></a>03904 
<a name="l03905"></a>03905    <span class="comment">/* propagate new statistics to ODB */</span>
<a name="l03906"></a>03906    <a class="code" href="group__msectionh.html#ga90c77b8a4ca06f60b0f595c8f16a39bc">db_send_changed_records</a>();
<a name="l03907"></a>03907 
<a name="l03908"></a>03908    <span class="comment">/* save tests in ODB */</span>
<a name="l03909"></a>03909    <a class="code" href="fal_8c.html#a29da9175b91a9b8fbadf2499e84c11e3">test_write</a>();
<a name="l03910"></a>03910 
<a name="l03911"></a>03911    last_time = actual_time;
<a name="l03912"></a>03912 }
<a name="l03913"></a>03913 
<a name="l03914"></a>03914 <span class="comment">/*-- Clear histos --------------------------------------------------*/</span>
<a name="l03915"></a>03915 
<a name="l03916"></a><a class="code" href="fal_8c.html#ac522dfaa480b4f4ff29fde3cafa97d38">03916</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a4439d57afe08d556f78e4b0ba490c79a">clear_histos</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> id1, <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> id2)
<a name="l03917"></a>03917 {
<a name="l03918"></a>03918    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l03919"></a>03919 <span class="preprocessor">#ifndef MANA_LITE</span>
<a name="l03920"></a>03920 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (id1 != id2) {
<a name="l03921"></a>03921       printf(<span class="stringliteral">&quot;Clear ID %d to ID %d\n&quot;</span>, id1, id2);
<a name="l03922"></a>03922       <span class="keywordflow">for</span> (i = id1; i &lt;= id2; i++)
<a name="l03923"></a>03923          <span class="keywordflow">if</span> (<a class="code" href="hbook_8h.html#a3efc0c35b6588eb50787985bb6440719">HEXIST</a>(i))
<a name="l03924"></a>03924             <a class="code" href="hbook_8h.html#aabf9d6f4996c66f08569c299f1f48f8c">HRESET</a>(i, <a class="code" href="fal_8c.html#a7fce5fc9af5702ff4cbc3f25bde32347">bstr</a>);
<a name="l03925"></a>03925    } <span class="keywordflow">else</span> {
<a name="l03926"></a>03926       printf(<span class="stringliteral">&quot;Clear ID %d\n&quot;</span>, id1);
<a name="l03927"></a>03927       <a class="code" href="hbook_8h.html#aabf9d6f4996c66f08569c299f1f48f8c">HRESET</a>(id1, <a class="code" href="fal_8c.html#a7fce5fc9af5702ff4cbc3f25bde32347">bstr</a>);
<a name="l03928"></a>03928    }
<a name="l03929"></a>03929 <span class="preprocessor">#endif</span>
<a name="l03930"></a>03930 <span class="preprocessor"></span>   <span class="keywordflow">return</span> <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l03931"></a>03931 }
<a name="l03932"></a>03932 
<a name="l03933"></a>03933 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03934"></a>03934 
<a name="l03935"></a><a class="code" href="fal_8c.html#a6286c3b1e900cb783d0b57e910d06f8a">03935</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#a6286c3b1e900cb783d0b57e910d06f8a">ana_callback</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <span class="keywordtype">void</span> *prpc_param[])
<a name="l03936"></a>03936 {
<a name="l03937"></a>03937    <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#gab04cd68bb2484fcbaa62d2eda3100250">RPC_ANA_CLEAR_HISTOS</a>)
<a name="l03938"></a>03938       <a class="code" href="fal_8c.html#a4439d57afe08d556f78e4b0ba490c79a">clear_histos</a>(<a class="code" href="group__msectionh.html#ga187949f830579556334ed017deea814c">CINT</a>(0), <a class="code" href="group__msectionh.html#ga187949f830579556334ed017deea814c">CINT</a>(1));
<a name="l03939"></a>03939 
<a name="l03940"></a>03940    <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>;
<a name="l03941"></a>03941 }
<a name="l03942"></a>03942 
<a name="l03943"></a>03943 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03944"></a>03944 
<a name="l03945"></a><a class="code" href="fal_8c.html#a55517f2f968b00f4bc592efdd03cd169">03945</a> <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">send_event</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>)
<a name="l03946"></a>03946 {
<a name="l03947"></a>03947    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l03948"></a>03948    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l03949"></a>03949    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l03950"></a>03950 
<a name="l03951"></a>03951    pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="consume_8c.html#a881e3cadecfb2fe6d53b7e33e74ac6d2">event_buffer</a>;
<a name="l03952"></a>03952 
<a name="l03953"></a>03953    eq_info = &amp;equipment[index].<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l03954"></a>03954 
<a name="l03955"></a>03955    pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l03956"></a>03956    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l03957"></a>03957    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = 0;
<a name="l03958"></a>03958    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>();
<a name="l03959"></a>03959    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> = equipment[index].<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l03960"></a>03960 
<a name="l03961"></a>03961    equipment[index].<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l03962"></a>03962 
<a name="l03963"></a>03963    <span class="comment">/* call user readout routine */</span>
<a name="l03964"></a>03964    *((<a class="code" href="structeqpmnt.html">EQUIPMENT</a> **) (pevent + 1)) = &amp;equipment[index];
<a name="l03965"></a>03965    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = equipment[index].<a class="code" href="group__midasincludecode.html#gab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), 0);
<a name="l03966"></a>03966 
<a name="l03967"></a>03967    <span class="comment">/* send event */</span>
<a name="l03968"></a>03968    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l03969"></a>03969       equipment[index].<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l03970"></a>03970       equipment[index].<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l03971"></a>03971 
<a name="l03972"></a>03972       equipment[index].<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> += equipment[index].<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>;
<a name="l03973"></a>03973       equipment[index].<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> = 0;
<a name="l03974"></a>03974 
<a name="l03975"></a>03975       <span class="comment">/* process event locally */</span>
<a name="l03976"></a>03976       <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(pevent);
<a name="l03977"></a>03977 
<a name="l03978"></a>03978       <span class="comment">/* send event to buffer */</span>
<a name="l03979"></a>03979       <span class="keywordflow">if</span> (equipment[index].buffer_handle) {
<a name="l03980"></a>03980          <a class="code" href="group__msectionh.html#ga5ebc713e2f1e7f0b6d257f072221321f">bm_send_event</a>(equipment[index].buffer_handle, pevent,
<a name="l03981"></a>03981                        pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l03982"></a>03982 
<a name="l03983"></a>03983          <span class="comment">/* flush buffer cache */</span>
<a name="l03984"></a>03984          <a class="code" href="group__msectionh.html#ga0116bb8954b16dfdc5d355f7c01127ad">bm_flush_cache</a>(equipment[index].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l03985"></a>03985       }
<a name="l03986"></a>03986    } <span class="keywordflow">else</span>
<a name="l03987"></a>03987       equipment[index].<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>--;
<a name="l03988"></a>03988 
<a name="l03989"></a>03989    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l03990"></a>03990       <span class="keywordflow">if</span> (equipment[i].buffer_handle)
<a name="l03991"></a>03991          <a class="code" href="group__msectionh.html#ga0116bb8954b16dfdc5d355f7c01127ad">bm_flush_cache</a>(equipment[i].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l03992"></a>03992 }
<a name="l03993"></a>03993 
<a name="l03994"></a>03994 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l03995"></a>03995 
<a name="l03996"></a><a class="code" href="fal_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">03996</a> <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="fal_8c.html#aed2a9a6c57de716dc564331cca8f0a85">transition</a>)
<a name="l03997"></a>03997 {
<a name="l03998"></a>03998    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l03999"></a>03999    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l04000"></a>04000 
<a name="l04001"></a>04001    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l04002"></a>04002       eq_info = &amp;equipment[i].<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l04003"></a>04003 
<a name="l04004"></a>04004       <span class="keywordflow">if</span> (!eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>)
<a name="l04005"></a>04005          <span class="keywordflow">continue</span>;
<a name="l04006"></a>04006 
<a name="l04007"></a>04007       <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga88e94e1aadd86417c8eaa304d8c3b467">RO_BOR</a>) == 0)
<a name="l04008"></a>04008          <span class="keywordflow">continue</span>;
<a name="l04009"></a>04009       <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga5b505930aa1fc780118b4fc75f771464">RO_EOR</a>) == 0)
<a name="l04010"></a>04010          <span class="keywordflow">continue</span>;
<a name="l04011"></a>04011       <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#ga11713399cfb35e58b8fae045836c0d88">TR_PAUSE</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga55beb931c834300fea83d24014f235d8">RO_PAUSE</a>) == 0)
<a name="l04012"></a>04012          <span class="keywordflow">continue</span>;
<a name="l04013"></a>04013       <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga549159f6ef3ef7c17261bcccecbe57ec">RO_RESUME</a>) == 0)
<a name="l04014"></a>04014          <span class="keywordflow">continue</span>;
<a name="l04015"></a>04015 
<a name="l04016"></a>04016       <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a215d5a2428c1e5bbb70d9fbeb85f07ae">send_event</a>(i);
<a name="l04017"></a>04017    }
<a name="l04018"></a>04018 }
<a name="l04019"></a>04019 
<a name="l04020"></a>04020 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04021"></a>04021 
<a name="l04022"></a><a class="code" href="fal_8c.html#a0bcbdb26f19446e99086a461e9ec8972">04022</a> <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a0bcbdb26f19446e99086a461e9ec8972">interrupt_enabled</a>;
<a name="l04023"></a>04023 
<a name="l04024"></a><a class="code" href="fal_8c.html#a4e71a4562915989e97f1bf8afe85dce2">04024</a> <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a4e71a4562915989e97f1bf8afe85dce2">interrupt_enable</a>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>)
<a name="l04025"></a>04025 {
<a name="l04026"></a>04026    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a0bcbdb26f19446e99086a461e9ec8972">interrupt_enabled</a> = flag;
<a name="l04027"></a>04027 
<a name="l04028"></a>04028    <span class="keywordflow">if</span> (interrupt_eq) {
<a name="l04029"></a>04029       <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a0bcbdb26f19446e99086a461e9ec8972">interrupt_enabled</a>)
<a name="l04030"></a>04030          <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="group__err26.html#gaab5043b2fd69a86d3bcecfb3fd8f7af3">CMD_INTERRUPT_ENABLE</a>, 0, 0);
<a name="l04031"></a>04031       <span class="keywordflow">else</span>
<a name="l04032"></a>04032          <a class="code" href="crate3_2crate_8cpp.html#a55dc1ffa15566edfd2ad2249aae97c77">interrupt_configure</a>(<a class="code" href="group__err26.html#gaa12884ae2e3cbffa489d7c5074a029f7">CMD_INTERRUPT_DISABLE</a>, 0, 0);
<a name="l04033"></a>04033    }
<a name="l04034"></a>04034 }
<a name="l04035"></a>04035 
<a name="l04036"></a>04036 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04037"></a>04037 
<a name="l04038"></a><a class="code" href="fal_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">04038</a> <span class="keywordtype">void</span> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">interrupt_routine</a>(<span class="keywordtype">void</span>)
<a name="l04039"></a>04039 {
<a name="l04040"></a>04040    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l04041"></a>04041 
<a name="l04042"></a>04042    <span class="comment">/* get pointer for upcoming event.</span>
<a name="l04043"></a>04043 <span class="comment">      This is a blocking call if no space available */</span>
<a name="l04044"></a>04044    <span class="keywordflow">if</span> ((pevent = <a class="code" href="group__msystemincludecode.html#ga166e1796a9a96ae0652665475bd6cfb7">dm_pointer_get</a>()) == NULL)
<a name="l04045"></a>04045       <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;interrupt_routine&quot;</span>, <span class="stringliteral">&quot;interrupt, dm_pointer_get returned NULL&quot;</span>);
<a name="l04046"></a>04046 
<a name="l04047"></a>04047    <span class="comment">/* compose MIDAS event header */</span>
<a name="l04048"></a>04048    pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l04049"></a>04049    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#ga5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l04050"></a>04050    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = 0;
<a name="l04051"></a>04051    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l04052"></a>04052    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> = interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l04053"></a>04053 
<a name="l04054"></a>04054    <span class="comment">/* call user readout routine */</span>
<a name="l04055"></a>04055    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#gab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), 0);
<a name="l04056"></a>04056 
<a name="l04057"></a>04057    <span class="comment">/* send event */</span>
<a name="l04058"></a>04058    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l04059"></a>04059       interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l04060"></a>04060       interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l04061"></a>04061 
<a name="l04062"></a>04062       <span class="keywordflow">if</span> (interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>) {
<a name="l04063"></a>04063 <span class="preprocessor">#ifdef USE_EVENT_CHANNEL</span>
<a name="l04064"></a>04064 <span class="preprocessor"></span>         <a class="code" href="group__msystemincludecode.html#gaf86511000a179574ea04744ccf04c452">dm_pointer_increment</a>(interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>,
<a name="l04065"></a>04065                               pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l04066"></a>04066 <span class="preprocessor">#else</span>
<a name="l04067"></a>04067 <span class="preprocessor"></span>         <a class="code" href="group__msectionh.html#ga309d572c69985cd8005f02e78eab4964">rpc_send_event</a>(interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l04068"></a>04068                         pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l04069"></a>04069 <span class="preprocessor">#endif</span>
<a name="l04070"></a>04070 <span class="preprocessor"></span>      }
<a name="l04071"></a>04071 
<a name="l04072"></a>04072       <span class="comment">/* send event to ODB */</span>
<a name="l04073"></a>04073       <span class="keywordflow">if</span> (interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a> || interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="group__midasincludecode.html#ga2740dd481bbbb7c8e417b5818ff8e064">history</a>) {
<a name="l04074"></a>04074          <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> &gt; <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a380a50d445745c2da54a29a1f2e5099e">ODB_UPDATE_TIME</a>) {
<a name="l04075"></a>04075             interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l04076"></a>04076             memcpy(interrupt_odb_buffer, pevent,
<a name="l04077"></a>04077                    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l04078"></a>04078             <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#aadf15a6e815e15b52fe5680277483e63">interrupt_odb_buffer_valid</a> = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04079"></a>04079             interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga2ba622da82fc7a02605e5f630464b13f">odb_out</a>++;
<a name="l04080"></a>04080          }
<a name="l04081"></a>04081       }
<a name="l04082"></a>04082    } <span class="keywordflow">else</span>
<a name="l04083"></a>04083       interrupt_eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>--;
<a name="l04084"></a>04084 
<a name="l04085"></a>04085 }
<a name="l04086"></a>04086 
<a name="l04087"></a>04087 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04088"></a>04088 
<a name="l04089"></a><a class="code" href="fal_8c.html#a48fa208044b7e1373af57d1b24393693">04089</a> <span class="keywordtype">int</span> <a class="code" href="fal_8c.html#a48fa208044b7e1373af57d1b24393693">print_message</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *msg)
<a name="l04090"></a>04090 {
<a name="l04091"></a>04091    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256];
<a name="l04092"></a>04092 
<a name="l04093"></a>04093    memset(str, <span class="charliteral">&apos; &apos;</span>, 159);
<a name="l04094"></a>04094    str[159] = 0;
<a name="l04095"></a>04095 
<a name="l04096"></a>04096    <span class="keywordflow">if</span> (msg[0] == <span class="charliteral">&apos;[&apos;</span>)
<a name="l04097"></a>04097       msg = strchr(msg, <span class="charliteral">&apos;]&apos;</span>) + 2;
<a name="l04098"></a>04098 
<a name="l04099"></a>04099    memcpy(str, msg, strlen(msg));
<a name="l04100"></a>04100    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 20, str);
<a name="l04101"></a>04101 
<a name="l04102"></a>04102    <span class="keywordflow">return</span> 0;
<a name="l04103"></a>04103 }
<a name="l04104"></a>04104 
<a name="l04105"></a>04105 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04106"></a>04106 
<a name="l04107"></a><a class="code" href="fal_8c.html#a168945a222012d1d908c78a41e7022c2">04107</a> <span class="keywordtype">void</span> <a class="code" href="fal_8c.html#a168945a222012d1d908c78a41e7022c2">receive_message</a>(<a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="minife_8c.html#ae7ddc6297773b75bea52d05c7a3ff5e5">hBuf</a>, <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <span class="keywordtype">id</span>, <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pheader, <span class="keywordtype">void</span> *<a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>)
<a name="l04108"></a>04108 {
<a name="l04109"></a>04109    <span class="comment">/* display message on screen */</span>
<a name="l04110"></a>04110    <a class="code" href="fal_8c.html#a48fa208044b7e1373af57d1b24393693">print_message</a>(message);
<a name="l04111"></a>04111 }
<a name="l04112"></a>04112 
<a name="l04113"></a>04113 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04114"></a>04114 
<a name="l04115"></a><a class="code" href="fal_8c.html#a27ee5885aecf4e5341362dc89033b3e3">04115</a> <span class="keywordtype">void</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> bInit)
<a name="l04116"></a>04116 {
<a name="l04117"></a>04117    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l04118"></a>04118    time_t full_time;
<a name="l04119"></a>04119    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[30];
<a name="l04120"></a>04120 
<a name="l04121"></a>04121    <span class="keywordflow">if</span> (bInit) {
<a name="l04122"></a>04122       <a class="code" href="group__msectionh.html#ga8d56c0c36ceb913e9de1043fe5bc269e">ss_clear_screen</a>();
<a name="l04123"></a>04123 
<a name="l04124"></a>04124       <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[0])
<a name="l04125"></a>04125          strcpy(str, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>);
<a name="l04126"></a>04126       <span class="keywordflow">else</span>
<a name="l04127"></a>04127          strcpy(str, <span class="stringliteral">&quot;&lt;local&gt;&quot;</span>);
<a name="l04128"></a>04128 
<a name="l04129"></a>04129       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 0, <span class="stringliteral">&quot;%s connected to %s. Press \&quot;!\&quot; to exit&quot;</span>, <a class="code" href="fal_8c.html#a9909e4be3ffcc1cc3f2076aaaa7629b0">fal_name</a>, str);
<a name="l04130"></a>04130       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 1,
<a name="l04131"></a>04131                 <span class="stringliteral">&quot;================================================================================&quot;</span>);
<a name="l04132"></a>04132       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 2, <span class="stringliteral">&quot;Run status:   %s&quot;</span>,
<a name="l04133"></a>04133                 <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a> ? <span class="stringliteral">&quot;Stopped&quot;</span> : <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> ==
<a name="l04134"></a>04134                 <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a> ? <span class="stringliteral">&quot;Running&quot;</span> : <span class="stringliteral">&quot;Paused&quot;</span>);
<a name="l04135"></a>04135       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(25, 2, <span class="stringliteral">&quot;Run number %ld   &quot;</span>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l04136"></a>04136       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 3,
<a name="l04137"></a>04137                 <span class="stringliteral">&quot;================================================================================&quot;</span>);
<a name="l04138"></a>04138       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 4,
<a name="l04139"></a>04139                 <span class="stringliteral">&quot;Equipment     Status     Events     Events/sec Rate[kB/s] ODB-&gt;FE    FE-&gt;ODB&quot;</span>);
<a name="l04140"></a>04140       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 5,
<a name="l04141"></a>04141                 <span class="stringliteral">&quot;--------------------------------------------------------------------------------&quot;</span>);
<a name="l04142"></a>04142       <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l04143"></a>04143          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, i + 6, <span class="stringliteral">&quot;%s&quot;</span>, equipment[i].<a class="code" href="examples_2macro_2midas__macro_8h.html#ab53d3e6e6144dcb27935cc71c57bc508">name</a>);
<a name="l04144"></a>04144    }
<a name="l04145"></a>04145 
<a name="l04146"></a>04146    <span class="comment">/* display time */</span>
<a name="l04147"></a>04147    <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>(&amp;full_time);
<a name="l04148"></a>04148    strcpy(str, ctime(&amp;full_time) + 11);
<a name="l04149"></a>04149    str[8] = 0;
<a name="l04150"></a>04150    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(72, 0, <span class="stringliteral">&quot;%s&quot;</span>, str);
<a name="l04151"></a>04151 
<a name="l04152"></a>04152    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l04153"></a>04153       status = equipment[i].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a>;
<a name="l04154"></a>04154 
<a name="l04155"></a>04155       <span class="keywordflow">if</span> ((status == 0 || status == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>) &amp;&amp; equipment[i].info.enabled)
<a name="l04156"></a>04156          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i + 6, <span class="stringliteral">&quot;OK       &quot;</span>);
<a name="l04157"></a>04157       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!equipment[i].info.enabled)
<a name="l04158"></a>04158          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i + 6, <span class="stringliteral">&quot;Disabled &quot;</span>);
<a name="l04159"></a>04159       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga8a0cc5de6ea758c61231a11b6a076e1f">FE_ERR_ODB</a>)
<a name="l04160"></a>04160          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i + 6, <span class="stringliteral">&quot;ODB Error&quot;</span>);
<a name="l04161"></a>04161       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga9fea053c26a278026fa0d7501c300c4f">FE_ERR_HW</a>)
<a name="l04162"></a>04162          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i + 6, <span class="stringliteral">&quot;HW Error &quot;</span>);
<a name="l04163"></a>04163       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>)
<a name="l04164"></a>04164          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i + 6, <span class="stringliteral">&quot;Disabled &quot;</span>);
<a name="l04165"></a>04165       <span class="keywordflow">else</span>
<a name="l04166"></a>04166          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(14, i + 6, <span class="stringliteral">&quot;Unknown  &quot;</span>);
<a name="l04167"></a>04167 
<a name="l04168"></a>04168       <span class="keywordflow">if</span> (equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt; 1E9)
<a name="l04169"></a>04169          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(25, i + 6, <span class="stringliteral">&quot;%1.3lfG     &quot;</span>, equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> / 1E9);
<a name="l04170"></a>04170       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt; 1E6)
<a name="l04171"></a>04171          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(25, i + 6, <span class="stringliteral">&quot;%1.3lfM     &quot;</span>, equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> / 1E6);
<a name="l04172"></a>04172       <span class="keywordflow">else</span>
<a name="l04173"></a>04173          <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(25, i + 6, <span class="stringliteral">&quot;%1.0lf      &quot;</span>, equipment[i].stats.<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>);
<a name="l04174"></a>04174       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(36, i + 6, <span class="stringliteral">&quot;%1.1lf      &quot;</span>, equipment[i].stats.events_per_sec);
<a name="l04175"></a>04175       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(47, i + 6, <span class="stringliteral">&quot;%1.1lf      &quot;</span>, equipment[i].stats.kbytes_per_sec);
<a name="l04176"></a>04176       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(58, i + 6, <span class="stringliteral">&quot;%ld       &quot;</span>, equipment[i].odb_in);
<a name="l04177"></a>04177       <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(69, i + 6, <span class="stringliteral">&quot;%ld       &quot;</span>, equipment[i].odb_out);
<a name="l04178"></a>04178    }
<a name="l04179"></a>04179 
<a name="l04180"></a>04180    <span class="comment">/* go to next line */</span>
<a name="l04181"></a>04181    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, i + 6, <span class="stringliteral">&quot;&quot;</span>);
<a name="l04182"></a>04182 }
<a name="l04183"></a>04183 
<a name="l04184"></a>04184 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04185"></a>04185 
<a name="l04186"></a><a class="code" href="fal_8c.html#a94c9987508c91ae4827cc231f43b577e">04186</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a94c9987508c91ae4827cc231f43b577e">scheduler</a>(<span class="keywordtype">void</span>)
<a name="l04187"></a>04187 {
<a name="l04188"></a>04188    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l04189"></a>04189    <a class="code" href="structeqpmnt.html">EQUIPMENT</a> *<a class="code" href="mdump_8c.html#a435a42b0c4c892426633a4295f59586e">eq</a>;
<a name="l04190"></a>04190    <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> *ar;
<a name="l04191"></a>04191    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l04192"></a>04192    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>,
<a name="l04193"></a>04193        last_time_network = 0, last_time_display = 0, readout_start, source;
<a name="l04194"></a>04194    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="odbhist_8c.html#a2df6784bd380a288cf2c3e7e2c43a6b8">j</a>, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, ch, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="scs__310__ql355p_8c.html#a11764cc96bb263d1f257bcc01205a787">flag</a>;
<a name="l04195"></a>04195    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[80];
<a name="l04196"></a>04196 
<a name="l04197"></a>04197    pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *) <a class="code" href="consume_8c.html#a881e3cadecfb2fe6d53b7e33e74ac6d2">event_buffer</a>;
<a name="l04198"></a>04198 
<a name="l04199"></a>04199   <span class="comment">/*----------------- MAIN equipment loop ------------------------------*/</span>
<a name="l04200"></a>04200 
<a name="l04201"></a>04201    <span class="keywordflow">do</span> {
<a name="l04202"></a>04202       actual_millitime = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l04203"></a>04203       actual_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l04204"></a>04204 
<a name="l04205"></a>04205     <span class="comment">/*---- loop over equipment table -------------------------------*/</span>
<a name="l04206"></a>04206       <span class="keywordflow">for</span> (index = 0;; index++) {
<a name="l04207"></a>04207          eq = &amp;equipment[index];
<a name="l04208"></a>04208          eq_info = &amp;eq-&gt;<a class="code" href="group__midasincludecode.html#ga51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l04209"></a>04209 
<a name="l04210"></a>04210          <span class="comment">/* check if end of equipment list */</span>
<a name="l04211"></a>04211          <span class="keywordflow">if</span> (!eq-&gt;<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0])
<a name="l04212"></a>04212             <span class="keywordflow">break</span>;
<a name="l04213"></a>04213 
<a name="l04214"></a>04214          <span class="keywordflow">if</span> (!eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>)
<a name="l04215"></a>04215             <span class="keywordflow">continue</span>;
<a name="l04216"></a>04216 
<a name="l04217"></a>04217          <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> != <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l04218"></a>04218             <span class="keywordflow">continue</span>;
<a name="l04219"></a>04219 
<a name="l04220"></a>04220       <span class="comment">/*---- call idle routine for slow control equipment ----*/</span>
<a name="l04221"></a>04221          <span class="keywordflow">if</span> ((eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) &amp;&amp; eq-&gt;<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>) {
<a name="l04222"></a>04222             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &gt; 0 &amp;&amp; <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>) {
<a name="l04223"></a>04223                <span class="keywordflow">if</span> (actual_time - eq-&gt;<a class="code" href="group__midasincludecode.html#ga8261688ef7d0d371cdf50023cf0447c1">last_idle</a> &gt;= (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>) {
<a name="l04224"></a>04224                   eq-&gt;<a class="code" href="group__midasincludecode.html#gae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga433697a25587c6ffe8a14f02e5be9066">CMD_IDLE</a>, eq);
<a name="l04225"></a>04225                   eq-&gt;<a class="code" href="group__midasincludecode.html#ga8261688ef7d0d371cdf50023cf0447c1">last_idle</a> = actual_time;
<a name="l04226"></a>04226                }
<a name="l04227"></a>04227             } <span class="keywordflow">else</span>
<a name="l04228"></a>04228                eq-&gt;<a class="code" href="group__midasincludecode.html#gae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga433697a25587c6ffe8a14f02e5be9066">CMD_IDLE</a>, eq);
<a name="l04229"></a>04229          }
<a name="l04230"></a>04230 
<a name="l04231"></a>04231          <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga05a5abc619ab24e168695befc7c0b4be">RO_STOPPED</a>) == 0)
<a name="l04232"></a>04232             <span class="keywordflow">continue</span>;
<a name="l04233"></a>04233          <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gab08c47284371c683ba80d6b3244400f1">STATE_PAUSED</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga8a47b3b86a72a7db84a582277d4b7a39">RO_PAUSED</a>) == 0)
<a name="l04234"></a>04234             <span class="keywordflow">continue</span>;
<a name="l04235"></a>04235          <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a> &amp;&amp; (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#gafc5ef41cae398b8500f9c3a42cef6d2c">RO_RUNNING</a>) == 0)
<a name="l04236"></a>04236             <span class="keywordflow">continue</span>;
<a name="l04237"></a>04237 
<a name="l04238"></a>04238       <span class="comment">/*---- check periodic events ----*/</span>
<a name="l04239"></a>04239          <span class="keywordflow">if</span> ((eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga58e919e4e401b299c1834be965c3e78c">EQ_PERIODIC</a>) || (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>)) {
<a name="l04240"></a>04240             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#gaf7f674490636b6f9736fb680201001c2">period</a> == 0)
<a name="l04241"></a>04241                <span class="keywordflow">continue</span>;
<a name="l04242"></a>04242 
<a name="l04243"></a>04243             <span class="comment">/* if period over, call readout routine */</span>
<a name="l04244"></a>04244             <span class="keywordflow">if</span> (actual_time - eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> &gt;= (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) eq_info-&gt;<a class="code" href="group__midasincludecode.html#gaf7f674490636b6f9736fb680201001c2">period</a>) {
<a name="l04245"></a>04245                eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = actual_time;
<a name="l04246"></a>04246 
<a name="l04247"></a>04247                <span class="comment">/* compose MIDAS event header */</span>
<a name="l04248"></a>04248                pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l04249"></a>04249                pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l04250"></a>04250                pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = 0;
<a name="l04251"></a>04251                pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = actual_time;
<a name="l04252"></a>04252                pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> = eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l04253"></a>04253 
<a name="l04254"></a>04254                <span class="comment">/* call user readout routine */</span>
<a name="l04255"></a>04255                *((<a class="code" href="structeqpmnt.html">EQUIPMENT</a> **) (pevent + 1)) = eq;
<a name="l04256"></a>04256                pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = eq-&gt;<a class="code" href="group__midasincludecode.html#gab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), 0);
<a name="l04257"></a>04257 
<a name="l04258"></a>04258                <span class="comment">/* send event */</span>
<a name="l04259"></a>04259                <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l04260"></a>04260                   eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l04261"></a>04261                   eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l04262"></a>04262 
<a name="l04263"></a>04263                   <span class="comment">/* process event locally */</span>
<a name="l04264"></a>04264                   <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(pevent);
<a name="l04265"></a>04265 
<a name="l04266"></a>04266                   <span class="comment">/* send event to buffer for remote consumer */</span>
<a name="l04267"></a>04267                   <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>) {
<a name="l04268"></a>04268                      <a class="code" href="group__msectionh.html#ga5ebc713e2f1e7f0b6d257f072221321f">bm_send_event</a>(eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l04269"></a>04269                                    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l04270"></a>04270 
<a name="l04271"></a>04271                      <span class="comment">/* flush buffer cache */</span>
<a name="l04272"></a>04272                      <a class="code" href="group__msectionh.html#ga0116bb8954b16dfdc5d355f7c01127ad">bm_flush_cache</a>(eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l04273"></a>04273                   }
<a name="l04274"></a>04274 
<a name="l04275"></a>04275                } <span class="keywordflow">else</span>
<a name="l04276"></a>04276                   eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>--;
<a name="l04277"></a>04277 
<a name="l04278"></a>04278                eq-&gt;<a class="code" href="group__midasincludecode.html#ga6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = actual_time;
<a name="l04279"></a>04279             }
<a name="l04280"></a>04280          }
<a name="l04281"></a>04281 
<a name="l04282"></a>04282       <span class="comment">/*---- check polled events ----*/</span>
<a name="l04283"></a>04283          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>) {
<a name="l04284"></a>04284             <span class="comment">/* compose MIDAS event header */</span>
<a name="l04285"></a>04285             pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l04286"></a>04286             pevent-&gt;<a class="code" href="group__midasincludecode.html#ga9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l04287"></a>04287             pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = 0;
<a name="l04288"></a>04288             readout_start = actual_time;
<a name="l04289"></a>04289 
<a name="l04290"></a>04290             <span class="keywordflow">while</span> ((source = <a class="code" href="crate3_2crate_8cpp.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga345e65d8874f6b968bedc00e76d4f431">source</a>, eq-&gt;<a class="code" href="group__midasincludecode.html#gae9bf94db8ff48533601c3833b1b20097">poll_count</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>))) {
<a name="l04291"></a>04291                pevent-&gt;<a class="code" href="group__midasincludecode.html#ga989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = actual_time;
<a name="l04292"></a>04292                pevent-&gt;<a class="code" href="group__midasincludecode.html#ga5ed07c075ebce619a8fa47e96f188440">serial_number</a> = eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l04293"></a>04293 
<a name="l04294"></a>04294                <span class="comment">/* put source at beginning of event */</span>
<a name="l04295"></a>04295                *(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> *) (pevent + 1) = source;
<a name="l04296"></a>04296 
<a name="l04297"></a>04297                <span class="comment">/* call user readout routine */</span>
<a name="l04298"></a>04298                pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> = eq-&gt;<a class="code" href="group__midasincludecode.html#gab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), 0);
<a name="l04299"></a>04299 
<a name="l04300"></a>04300                <span class="comment">/* send event */</span>
<a name="l04301"></a>04301                <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l04302"></a>04302                   <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>)
<a name="l04303"></a>04303                      <a class="code" href="group__msectionh.html#ga5ebc713e2f1e7f0b6d257f072221321f">bm_send_event</a>(eq-&gt;<a class="code" href="group__midasincludecode.html#ga7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l04304"></a>04304                                    pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l04305"></a>04305 
<a name="l04306"></a>04306                   eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="group__midasincludecode.html#ga194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l04307"></a>04307                   eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l04308"></a>04308 
<a name="l04309"></a>04309                   <span class="comment">/* analyze and log event */</span>
<a name="l04310"></a>04310                   <a class="code" href="miniana_8c.html#a681f90cedc0c323da19bfef26d8854b5">process_event</a>(pevent);
<a name="l04311"></a>04311                } <span class="keywordflow">else</span>
<a name="l04312"></a>04312                   eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>--;
<a name="l04313"></a>04313 
<a name="l04314"></a>04314                actual_time = <a class="code" href="group__msectionh.html#gaeb8fc912d50c2360588c50782b9c916d">ss_millitime</a>();
<a name="l04315"></a>04315 
<a name="l04316"></a>04316                <span class="comment">/* repeat no more than 100 ms */</span>
<a name="l04317"></a>04317                <span class="keywordflow">if</span> (actual_time - readout_start &gt; 100)
<a name="l04318"></a>04318                   <span class="keywordflow">break</span>;
<a name="l04319"></a>04319 
<a name="l04320"></a>04320                <span class="comment">/* quit if event limit is reached */</span>
<a name="l04321"></a>04321                <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &amp;&amp; eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a> &gt; eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>)
<a name="l04322"></a>04322                   <span class="keywordflow">break</span>;
<a name="l04323"></a>04323             }
<a name="l04324"></a>04324 
<a name="l04325"></a>04325          }
<a name="l04326"></a>04326 
<a name="l04327"></a>04327       <span class="comment">/*---- check if event limit is reached ----*/</span>
<a name="l04328"></a>04328          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga5d2b5c1a08c8312e86963499122d3c06">eq_type</a> != <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a> &amp;&amp;
<a name="l04329"></a>04329              eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &amp;&amp;
<a name="l04330"></a>04330              eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a> &gt; eq_info-&gt;<a class="code" href="group__midasincludecode.html#ga4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &amp;&amp; <a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>) {
<a name="l04331"></a>04331             <span class="comment">/* stop run */</span>
<a name="l04332"></a>04332             <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga98ba67d921647dab7eb4f00e5dea7ba0">cm_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, 0, str, <span class="keyword">sizeof</span>(str), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l04333"></a>04333                <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;Cannot stop run: %s&quot;</span>, str);
<a name="l04334"></a>04334             }
<a name="l04335"></a>04335 
<a name="l04336"></a>04336             <span class="comment">/* check if autorestart, main loop will take care of it */</span>
<a name="l04337"></a>04337             size = <span class="keyword">sizeof</span>(<a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l04338"></a>04338             flag = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04339"></a>04339             <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Auto restart&quot;</span>, &amp;flag, &amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04340"></a>04340 
<a name="l04341"></a>04341             <span class="keywordflow">if</span> (flag)
<a name="l04342"></a>04342                <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>() + 5;    <span class="comment">/* start in 5 sec. */</span>
<a name="l04343"></a>04343          }
<a name="l04344"></a>04344       }
<a name="l04345"></a>04345 
<a name="l04346"></a>04346     <span class="comment">/*---- call frontend_loop periodically -------------------------*/</span>
<a name="l04347"></a>04347       <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a0215c0a842a0e97fe65c7ef5fb7633a5">frontend_call_loop</a>) {
<a name="l04348"></a>04348          status = <a class="code" href="crate3_2crate_8cpp.html#ada66837c3c3d263974ad717921145e0a">frontend_loop</a>();
<a name="l04349"></a>04349          <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l04350"></a>04350             status = <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l04351"></a>04351       }
<a name="l04352"></a>04352 
<a name="l04353"></a>04353     <span class="comment">/*---- calculate rates and update status page periodically -----*/</span>
<a name="l04354"></a>04354       <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a> &amp;&amp; actual_time - last_time_display &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) <a class="code" href="crate3_2crate_8cpp.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>) {
<a name="l04355"></a>04355          <span class="comment">/* calculate rates */</span>
<a name="l04356"></a>04356          <span class="keywordflow">if</span> (actual_time != last_time_display) {
<a name="l04357"></a>04357             <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l04358"></a>04358                eq = &amp;equipment[i];
<a name="l04359"></a>04359                j = eq-&gt;<a class="code" href="group__midasincludecode.html#ga1eeffec216604567e3ddbed40cbb0a15">serial_number</a>;
<a name="l04360"></a>04360                <span class="keywordflow">if</span> (j &gt; 0)
<a name="l04361"></a>04361                   j--;
<a name="l04362"></a>04362                eq-&gt;<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> = j;
<a name="l04363"></a>04363                eq-&gt;<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="group__midasincludecode.html#ga218c744ea441413af262fbd5ddf3780f">events_per_sec</a> =
<a name="l04364"></a>04364                    (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) (eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> /
<a name="l04365"></a>04365                             ((actual_time - last_time_display) / 1000.0));
<a name="l04366"></a>04366                eq-&gt;<a class="code" href="group__midasincludecode.html#ga474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="group__midasincludecode.html#ga7a7a7d4b78841a36d156a0941616538f">kbytes_per_sec</a> =
<a name="l04367"></a>04367                    eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> / 1024.0 / ((actual_time - last_time_display) / 1000.0);
<a name="l04368"></a>04368 
<a name="l04369"></a>04369                eq-&gt;<a class="code" href="group__midasincludecode.html#ga2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> = 0;
<a name="l04370"></a>04370                eq-&gt;<a class="code" href="group__midasincludecode.html#ga448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> = 0;
<a name="l04371"></a>04371             }
<a name="l04372"></a>04372 
<a name="l04373"></a>04373             <span class="keywordflow">for</span> (i = 0; analyze_request[i].<a class="code" href="structANALYZE__REQUEST.html#abc24698c600ca2b3eec735b84832d0b0">event_name</a>[0]; i++) {
<a name="l04374"></a>04374                ar = &amp;analyze_request[i];
<a name="l04375"></a>04375                ar-&gt;<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>.<a class="code" href="structAR__STATS.html#ae75a481fd926f515b17a3e2b63ee283a">events_received</a> += ar-&gt;<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a>;
<a name="l04376"></a>04376                ar-&gt;<a class="code" href="group__midasincludecode.html#ga069e2a89b82e12f5257325227343b4c0">ar_stats</a>.<a class="code" href="group__midasincludecode.html#ga3695a89775259f076f838bf46af2e00f">events_per_sec</a> =
<a name="l04377"></a>04377                    (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) (ar-&gt;<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a> /
<a name="l04378"></a>04378                             ((actual_time - last_time_display) / 1000.0));
<a name="l04379"></a>04379                ar-&gt;<a class="code" href="group__midasincludecode.html#gabf605e9e770da11f91f501febd274aad">events_received</a> = 0;
<a name="l04380"></a>04380             }
<a name="l04381"></a>04381 
<a name="l04382"></a>04382          }
<a name="l04383"></a>04383 
<a name="l04384"></a>04384          <span class="comment">/* propagate changes in equipment to ODB */</span>
<a name="l04385"></a>04385          <a class="code" href="group__msectionh.html#ga90c77b8a4ca06f60b0f595c8f16a39bc">db_send_changed_records</a>();
<a name="l04386"></a>04386 
<a name="l04387"></a>04387          <span class="comment">/* update statistics */</span>
<a name="l04388"></a>04388          <a class="code" href="fal_8c.html#ae9ecbc5912c68c52edab9a9ddf41c5c7">update_stats</a>();
<a name="l04389"></a>04389 
<a name="l04390"></a>04390          <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04391"></a>04391 
<a name="l04392"></a>04392          <span class="comment">/* check keyboard */</span>
<a name="l04393"></a>04393          ch = 0;
<a name="l04394"></a>04394          status = 0;
<a name="l04395"></a>04395          <span class="keywordflow">while</span> (<a class="code" href="group__msectionh.html#gae96b0ebe47aa1d54f800e4f2e7f564b9">ss_kbhit</a>()) {
<a name="l04396"></a>04396             ch = <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(0);
<a name="l04397"></a>04397             <span class="keywordflow">if</span> (ch == -1)
<a name="l04398"></a>04398                ch = getchar();
<a name="l04399"></a>04399 
<a name="l04400"></a>04400             <span class="keywordflow">if</span> (ch == <span class="charliteral">&apos;!&apos;</span>)
<a name="l04401"></a>04401                status = <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l04402"></a>04402          }
<a name="l04403"></a>04403 
<a name="l04404"></a>04404          <span class="keywordflow">if</span> (ch &gt; 0)
<a name="l04405"></a>04405             <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04406"></a>04406          <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l04407"></a>04407             <span class="keywordflow">break</span>;
<a name="l04408"></a>04408 
<a name="l04409"></a>04409          last_time_display = actual_time;
<a name="l04410"></a>04410       }
<a name="l04411"></a>04411 
<a name="l04412"></a>04412     <span class="comment">/*---- check network messages ----------------------------------*/</span>
<a name="l04413"></a>04413       <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a796101401a6f991d4bc11e0059c664a7">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>) {
<a name="l04414"></a>04414          <span class="comment">/* only call yield once every 100ms when running */</span>
<a name="l04415"></a>04415          <span class="keywordflow">if</span> (actual_time - last_time_network &gt; 100) {
<a name="l04416"></a>04416             status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(0);
<a name="l04417"></a>04417             last_time_network = actual_time;
<a name="l04418"></a>04418          } <span class="keywordflow">else</span>
<a name="l04419"></a>04419             status = <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>;
<a name="l04420"></a>04420       } <span class="keywordflow">else</span>
<a name="l04421"></a>04421          <span class="comment">/* when run is stopped, call yield with 100ms timeout */</span>
<a name="l04422"></a>04422          status = <a class="code" href="group__msectionh.html#gae234f64a7143ed2be1019e53613a6e85">cm_yield</a>(100);
<a name="l04423"></a>04423 
<a name="l04424"></a>04424     <span class="comment">/*---- check auto restart --------------------------------------*/</span>
<a name="l04425"></a>04425       <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> &gt; 0 &amp;&amp; (<span class="keywordtype">int</span>) <a class="code" href="group__msectionh.html#ga910c0323866ee0d55ea786b90f594b49">ss_time</a>() &gt; <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a>) {
<a name="l04426"></a>04426          <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04427"></a>04427          size = <span class="keyword">sizeof</span>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l04428"></a>04428          <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/Run number&quot;</span>, &amp;<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04429"></a>04429 
<a name="l04430"></a>04430          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;main&quot;</span>, <span class="stringliteral">&quot;starting new run&quot;</span>);
<a name="l04431"></a>04431          status = <a class="code" href="group__msectionh.html#ga98ba67d921647dab7eb4f00e5dea7ba0">cm_transition</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> + 1, NULL, 0, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04432"></a>04432          <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l04433"></a>04433             <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;main&quot;</span>, <span class="stringliteral">&quot;cannot restart run&quot;</span>);
<a name="l04434"></a>04434       }
<a name="l04435"></a>04435 
<a name="l04436"></a>04436    } <span class="keywordflow">while</span> (status != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> &amp;&amp; status != <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>);
<a name="l04437"></a>04437 
<a name="l04438"></a>04438    <span class="keywordflow">return</span> status;
<a name="l04439"></a>04439 }
<a name="l04440"></a>04440 
<a name="l04441"></a>04441 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04442"></a>04442 
<a name="l04443"></a><a class="code" href="fal_8c.html#a2e79e874780c7bf4355f940ac18c7bfa">04443</a> <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2e79e874780c7bf4355f940ac18c7bfa">cnaf_callback</a>(<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <span class="keywordtype">void</span> *prpc_param[])
<a name="l04444"></a>04444 {
<a name="l04445"></a>04445    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> <a class="code" href="jorway73a_8c.html#a11d3b696651733f98e58d14ad8fa7a1d">cmd</a>, b, <a class="code" href="patch__mevb_8cpp.html#adce6024c3a1b29c5fcede88815f9b152">c</a>, <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, a, f, *pdword, *<a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, *x, *q;
<a name="l04446"></a>04446    <a class="code" href="unionWORD.html">WORD</a> *pword, *pdata;
<a name="l04447"></a>04447    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="mdump_8c.html#a3d42cdd395a9c14f809d2fe53748c620">count</a>;
<a name="l04448"></a>04448 
<a name="l04449"></a>04449    <span class="comment">/* Decode parameters */</span>
<a name="l04450"></a>04450    cmd = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(0);
<a name="l04451"></a>04451    b = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(1);
<a name="l04452"></a>04452    c = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(2);
<a name="l04453"></a>04453    n = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(3);
<a name="l04454"></a>04454    a = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(4);
<a name="l04455"></a>04455    f = <a class="code" href="group__msectionh.html#ga5510b5fa698f191723b72859fef9fb84">CDWORD</a>(5);
<a name="l04456"></a>04456    pdword = <a class="code" href="group__msectionh.html#gafff8900742914b9c11f421e66c8baa3b">CPDWORD</a>(6);
<a name="l04457"></a>04457    pword = <a class="code" href="group__msectionh.html#ga68a6343add951d2d9ca99197eac42fd2">CPWORD</a>(6);
<a name="l04458"></a>04458    pdata = <a class="code" href="group__msectionh.html#ga68a6343add951d2d9ca99197eac42fd2">CPWORD</a>(6);
<a name="l04459"></a>04459    size = <a class="code" href="group__msectionh.html#gafff8900742914b9c11f421e66c8baa3b">CPDWORD</a>(7);
<a name="l04460"></a>04460    x = <a class="code" href="group__msectionh.html#gafff8900742914b9c11f421e66c8baa3b">CPDWORD</a>(8);
<a name="l04461"></a>04461    q = <a class="code" href="group__msectionh.html#gafff8900742914b9c11f421e66c8baa3b">CPDWORD</a>(9);
<a name="l04462"></a>04462 
<a name="l04463"></a>04463    <span class="comment">/* determine repeat count */</span>
<a name="l04464"></a>04464    <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#ga04139d1c129e9a87093587d16d8ac5a4">RPC_CNAF16</a>)
<a name="l04465"></a>04465       count = *size / <span class="keyword">sizeof</span>(<a class="code" href="unionWORD.html">WORD</a>);     <span class="comment">/* 16 bit */</span>
<a name="l04466"></a>04466    <span class="keywordflow">else</span>
<a name="l04467"></a>04467       count = *size / <span class="keyword">sizeof</span>(<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>);    <span class="comment">/* 24 bit */</span>
<a name="l04468"></a>04468 
<a name="l04469"></a>04469    <span class="keywordflow">switch</span> (cmd) {
<a name="l04470"></a>04470     <span class="comment">/*---- special commands ----*/</span>
<a name="l04471"></a>04471 
<a name="l04472"></a>04472    <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#ga5034a4dfe61df0821dd0841bae13033a">CNAF_INHIBIT_SET</a>:
<a name="l04473"></a>04473       <a class="code" href="group__mcstdfunctionh.html#gaa171934ed8e8ce2af3ec97f4192aa27b">cam_inhibit_set</a>(c);
<a name="l04474"></a>04474       <span class="keywordflow">break</span>;
<a name="l04475"></a>04475    <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#gafe3467b124db26b5b10caf7f1633baed">CNAF_INHIBIT_CLEAR</a>:
<a name="l04476"></a>04476       <a class="code" href="group__mcstdfunctionh.html#gaaf50e8892fd5226754befa7185c9dc3a">cam_inhibit_clear</a>(c);
<a name="l04477"></a>04477       <span class="keywordflow">break</span>;
<a name="l04478"></a>04478    <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#gab5458177175ac7c1d62f96395e4b2f8f">CNAF_CRATE_CLEAR</a>:
<a name="l04479"></a>04479       <a class="code" href="group__mcstdfunctionh.html#ga9fb70c7c5fb16d3807373902b137fe3e">cam_crate_clear</a>(c);
<a name="l04480"></a>04480       <span class="keywordflow">break</span>;
<a name="l04481"></a>04481    <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#ga8ca71a69fac55838bc9bcc020f9edacf">CNAF_CRATE_ZINIT</a>:
<a name="l04482"></a>04482       <a class="code" href="group__mcstdfunctionh.html#ga476ffc902c4674e17aa3b544781023e4">cam_crate_zinit</a>(c);
<a name="l04483"></a>04483       <span class="keywordflow">break</span>;
<a name="l04484"></a>04484 
<a name="l04485"></a>04485    <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#ga6e256f90162b33b043f023b270ddfad9">CNAF_TEST</a>:
<a name="l04486"></a>04486       <span class="keywordflow">break</span>;
<a name="l04487"></a>04487 
<a name="l04488"></a>04488    <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#gaabc611f59210401f11ea4247291c4468">CNAF</a>:
<a name="l04489"></a>04489       <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#ga04139d1c129e9a87093587d16d8ac5a4">RPC_CNAF16</a>) {
<a name="l04490"></a>04490          <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
<a name="l04491"></a>04491             <span class="keywordflow">if</span> (f &lt; 16)
<a name="l04492"></a>04492                <a class="code" href="group__mcstdfunctionh.html#ga2a515796e8020af32ea0e5aad490a170">cam16i_q</a>(c, n, a, f, pword, (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l04493"></a>04493             <span class="keywordflow">else</span>
<a name="l04494"></a>04494                <a class="code" href="group__mcstdfunctionh.html#ga971dc315017a5801f0131c4c2d396d28">cam16o_q</a>(c, n, a, f, pword[i], (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l04495"></a>04495       } <span class="keywordflow">else</span> {
<a name="l04496"></a>04496          <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
<a name="l04497"></a>04497             <span class="keywordflow">if</span> (f &lt; 16)
<a name="l04498"></a>04498                <a class="code" href="group__mcstdfunctionh.html#ga0f1b4435d6f1fea0e5787a5c2388b41c">cam24i_q</a>(c, n, a, f, pdword, (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l04499"></a>04499             <span class="keywordflow">else</span>
<a name="l04500"></a>04500                <a class="code" href="group__mcstdfunctionh.html#gaefe50b118a37b83b19a3804a6759d8bd">cam24o_q</a>(c, n, a, f, pdword[i], (<span class="keywordtype">int</span> *) x, (<span class="keywordtype">int</span> *) q);
<a name="l04501"></a>04501       }
<a name="l04502"></a>04502 
<a name="l04503"></a>04503       <span class="keywordflow">break</span>;
<a name="l04504"></a>04504 
<a name="l04505"></a>04505    <span class="keywordflow">case</span> <a class="code" href="group__midasincludecode.html#gad36f02a80cebab2bdfa9795db23ef333">CNAF_nQ</a>:
<a name="l04506"></a>04506       <span class="keywordflow">if</span> (index == <a class="code" href="group__mrpcdefineh.html#ga04139d1c129e9a87093587d16d8ac5a4">RPC_CNAF16</a>) {
<a name="l04507"></a>04507          <span class="keywordflow">if</span> (f &lt; 16)
<a name="l04508"></a>04508             <a class="code" href="group__mcstdfunctionh.html#ga4a234b702b8b906b0cca1bcbdb01ca27">cam16i_rq</a>(c, n, a, f, (<a class="code" href="unionWORD.html">WORD</a> **) &amp; pdword, count);
<a name="l04509"></a>04509       } <span class="keywordflow">else</span> {
<a name="l04510"></a>04510          <span class="keywordflow">if</span> (f &lt; 16)
<a name="l04511"></a>04511             <a class="code" href="group__mcstdfunctionh.html#ga6a2d5a0785b2ccc27fc9e2769f749b10">cam24i_rq</a>(c, n, a, f, &amp;pdword, count);
<a name="l04512"></a>04512       }
<a name="l04513"></a>04513 
<a name="l04514"></a>04514       <span class="comment">/* return reduced return size */</span>
<a name="l04515"></a>04515       *size = (int) pdword - (<span class="keywordtype">int</span>) pdata;
<a name="l04516"></a>04516       <span class="keywordflow">break</span>;
<a name="l04517"></a>04517 
<a name="l04518"></a>04518    <span class="keywordflow">default</span>:
<a name="l04519"></a>04519       printf(<span class="stringliteral">&quot;cnaf: Unknown command 0x%lX\n&quot;</span>, cmd);
<a name="l04520"></a>04520    }
<a name="l04521"></a>04521 
<a name="l04522"></a>04522    printf(<span class="stringliteral">&quot;cmd=%ld c=%ld n=%ld a=%ld f=%ld d=%lX\n&quot;</span>, cmd, c, n, a, f, pdword[0]);
<a name="l04523"></a>04523 
<a name="l04524"></a>04524    <span class="keywordflow">return</span> <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>;
<a name="l04525"></a>04525 }
<a name="l04526"></a>04526 
<a name="l04527"></a>04527 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l04528"></a>04528 
<a name="l04529"></a>04529 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l04530"></a>04530 <span class="preprocessor"></span><span class="keywordtype">int</span> mfe(<span class="keywordtype">char</span> *ahost_name, <span class="keywordtype">char</span> *aexp_name, <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> adebug)
<a name="l04531"></a>04531 <span class="preprocessor">#else</span>
<a name="l04532"></a><a class="code" href="fal_8c.html#a0ddf1224851353fc92bfbff6f499fa97">04532</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="mucap__compress_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l04533"></a>04533 <span class="preprocessor">#endif</span>
<a name="l04534"></a>04534 <span class="preprocessor"></span>{
<a name="l04535"></a>04535    <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>;
<a name="l04536"></a>04536    <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a>;
<a name="l04537"></a>04537 
<a name="l04538"></a>04538    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[0] = 0;
<a name="l04539"></a>04539    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>[0] = 0;
<a name="l04540"></a>04540    debug = <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04541"></a>04541 
<a name="l04542"></a>04542 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l04543"></a>04543 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (ahost_name)
<a name="l04544"></a>04544       strcpy(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, ahost_name);
<a name="l04545"></a>04545    <span class="keywordflow">if</span> (aexp_name)
<a name="l04546"></a>04546       strcpy(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, aexp_name);
<a name="l04547"></a>04547    debug = adebug;
<a name="l04548"></a>04548 <span class="preprocessor">#else</span>
<a name="l04549"></a>04549 <span class="preprocessor"></span>
<a name="l04550"></a>04550    <span class="comment">/* get default from environment */</span>
<a name="l04551"></a>04551    <a class="code" href="patch__mevb_8cpp.html#aa598123f60ccd5496f2421c7bf2fabbf">cm_get_environment</a>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, <span class="keyword">sizeof</span>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>), <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <span class="keyword">sizeof</span>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>));
<a name="l04552"></a>04552 
<a name="l04553"></a>04553    <span class="comment">/* parse command line parameters */</span>
<a name="l04554"></a>04554    <span class="keywordflow">for</span> (i = 1; i &lt; argc; i++) {
<a name="l04555"></a>04555       <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; argv[i][1] == <span class="charliteral">&apos;d&apos;</span>)
<a name="l04556"></a>04556          debug = <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04557"></a>04557       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l04558"></a>04558          <span class="keywordflow">if</span> (i + 1 &gt;= argc || argv[i + 1][0] == <span class="charliteral">&apos;-&apos;</span>)
<a name="l04559"></a>04559             <span class="keywordflow">goto</span> <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>;
<a name="l04560"></a>04560          <span class="keywordflow">if</span> (argv[i][1] == <span class="charliteral">&apos;e&apos;</span>)
<a name="l04561"></a>04561             strcpy(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, argv[++i]);
<a name="l04562"></a>04562          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][1] == <span class="charliteral">&apos;h&apos;</span>)
<a name="l04563"></a>04563             strcpy(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, argv[++i]);
<a name="l04564"></a>04564 <span class="preprocessor">#ifndef MANA_LITE</span>
<a name="l04565"></a>04565 <span class="preprocessor"></span>         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][1] == <span class="charliteral">&apos;s&apos;</span>)
<a name="l04566"></a>04566             <a class="code" href="fal_8c.html#a145953d65e4f33a2308075f26c13bfbe">pawc_size</a> = atoi(argv[++i]);
<a name="l04567"></a>04567 <span class="preprocessor">#endif</span>
<a name="l04568"></a>04568 <span class="preprocessor"></span>         <span class="keywordflow">else</span> {
<a name="l04569"></a>04569           <a class="code" href="odb__check_8cc.html#a2ef30c42cbc289d899a8be5d2d8f77d0">usage</a>:
<a name="l04570"></a>04570             printf(<span class="stringliteral">&quot;usage: fal [-h Hostname] [-e Experiment] [-s pawc_size] [-d]\n\n&quot;</span>);
<a name="l04571"></a>04571             printf(<span class="stringliteral">&quot;-d(ebug) should be set if FAL is started inside a debugger\n&quot;</span>);
<a name="l04572"></a>04572             <span class="keywordflow">return</span> 1;
<a name="l04573"></a>04573          }
<a name="l04574"></a>04574       }
<a name="l04575"></a>04575    }
<a name="l04576"></a>04576 <span class="preprocessor">#endif</span>
<a name="l04577"></a>04577 <span class="preprocessor"></span>
<a name="l04578"></a>04578    <span class="comment">/* now connect to server */</span>
<a name="l04579"></a>04579    <span class="keywordflow">if</span> (<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[0])
<a name="l04580"></a>04580       printf(<span class="stringliteral">&quot;Connect to experiment %s on host %s...&quot;</span>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>);
<a name="l04581"></a>04581    <span class="keywordflow">else</span>
<a name="l04582"></a>04582       printf(<span class="stringliteral">&quot;Connect to experiment %s...&quot;</span>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>);
<a name="l04583"></a>04583 
<a name="l04584"></a>04584    status = <a class="code" href="group__msectionh.html#gae2c7dedc142d472208e2e67f920b91e2">cm_connect_experiment1</a>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <a class="code" href="fal_8c.html#a9909e4be3ffcc1cc3f2076aaaa7629b0">fal_name</a>, NULL, <a class="code" href="analyzer_8cpp.html#a7503268889a084b74a968787ffc025b7">odb_size</a>,
<a name="l04585"></a>04585                                    <a class="code" href="fal_8c.html#a0340d599df75b94d3f5bccc27ce8719d">LOGGER_TIMEOUT</a>);
<a name="l04586"></a>04586    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l04587"></a>04587       <span class="comment">/* let user read message before window might close */</span>
<a name="l04588"></a>04588       <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(5000);
<a name="l04589"></a>04589       <span class="keywordflow">return</span> 1;
<a name="l04590"></a>04590    }
<a name="l04591"></a>04591 
<a name="l04592"></a>04592    printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l04593"></a>04593 
<a name="l04594"></a>04594    <span class="comment">/* set own message print function */</span>
<a name="l04595"></a>04595    <a class="code" href="group__msectionh.html#gaf4589061aab20d351d901b6d2ccc0cc0">cm_set_msg_print</a>(<a class="code" href="group__mdefineh.html#ga3378bf6f53a24392145df33c8acc9c0c">MT_ALL</a>, <a class="code" href="group__mdefineh.html#ga3378bf6f53a24392145df33c8acc9c0c">MT_ALL</a>, <a class="code" href="fal_8c.html#a48fa208044b7e1373af57d1b24393693">print_message</a>);
<a name="l04596"></a>04596 
<a name="l04597"></a>04597    <span class="comment">/* check if FAL already running */</span>
<a name="l04598"></a>04598    status = <a class="code" href="group__msectionh.html#gafe2e23ec2e5c20fbc65ee238bd6cd48e">cm_exist</a>(<a class="code" href="fal_8c.html#a9909e4be3ffcc1cc3f2076aaaa7629b0">fal_name</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04599"></a>04599    <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l04600"></a>04600       <span class="comment">/* try to cleanup hanging FAL */</span>
<a name="l04601"></a>04601       <a class="code" href="group__msectionh.html#ga2bb78358bf566eb83197810aee9c59b5">cm_cleanup</a>(<a class="code" href="fal_8c.html#a9909e4be3ffcc1cc3f2076aaaa7629b0">fal_name</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04602"></a>04602 
<a name="l04603"></a>04603       <span class="comment">/* let user read message */</span>
<a name="l04604"></a>04604       <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(2000);
<a name="l04605"></a>04605 
<a name="l04606"></a>04606       <span class="comment">/* now check again */</span>
<a name="l04607"></a>04607       status = <a class="code" href="group__msectionh.html#gafe2e23ec2e5c20fbc65ee238bd6cd48e">cm_exist</a>(<a class="code" href="fal_8c.html#a9909e4be3ffcc1cc3f2076aaaa7629b0">fal_name</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04608"></a>04608       <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l04609"></a>04609          printf(<span class="stringliteral">&quot;This program runs already and cannot be started twice.\n&quot;</span>);
<a name="l04610"></a>04610          printf(<span class="stringliteral">&quot;&lt;Please hit return to exit&gt;&quot;</span>);
<a name="l04611"></a>04611          getchar();
<a name="l04612"></a>04612          <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l04613"></a>04613          <span class="keywordflow">return</span> 1;
<a name="l04614"></a>04614       }
<a name="l04615"></a>04615 
<a name="l04616"></a>04616       <span class="comment">/* now reconnect to get client name FAL, not FAL1 */</span>
<a name="l04617"></a>04617       <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l04618"></a>04618       <a class="code" href="group__msectionh.html#gae2c7dedc142d472208e2e67f920b91e2">cm_connect_experiment1</a>(<a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <a class="code" href="fal_8c.html#a9909e4be3ffcc1cc3f2076aaaa7629b0">fal_name</a>, NULL, <a class="code" href="analyzer_8cpp.html#a7503268889a084b74a968787ffc025b7">odb_size</a>,
<a name="l04619"></a>04619                              <a class="code" href="fal_8c.html#a0340d599df75b94d3f5bccc27ce8719d">LOGGER_TIMEOUT</a>);
<a name="l04620"></a>04620    }
<a name="l04621"></a>04621 
<a name="l04622"></a>04622    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>, <a class="code" href="fal_8c.html#a57d8732229dddafb0b75bab10325c12b">tr_start1</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l04623"></a>04623        <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, <a class="code" href="patch__mevb_8cpp.html#a29971c513f4451dd5c79373edd928ca0">tr_stop</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l04624"></a>04624        <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga11713399cfb35e58b8fae045836c0d88">TR_PAUSE</a>, <a class="code" href="crate9_2mfe__mucap_8c.html#a7b3b6a2f570d0b31b1ad13c34536db5a">tr_pause</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l04625"></a>04625        <a class="code" href="group__msectionh.html#ga4cf8478a882b7dac40756a9549e9748b">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">tr_resume</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l04626"></a>04626       printf(<span class="stringliteral">&quot;Failed to start local RPC server&quot;</span>);
<a name="l04627"></a>04627       <span class="keywordflow">return</span> 1;
<a name="l04628"></a>04628    }
<a name="l04629"></a>04629 
<a name="l04630"></a>04630    <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, NULL);
<a name="l04631"></a>04631 
<a name="l04632"></a>04632    <span class="comment">/* set online mode */</span>
<a name="l04633"></a>04633    i = 1;
<a name="l04634"></a>04634    <a class="code" href="group__msectionh.html#gaf83159c12a4e73b2ec3bf6099b3c5544">db_set_value</a>(<a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/Online Mode&quot;</span>, &amp;i, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), 1, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l04635"></a>04635 
<a name="l04636"></a>04636    <span class="comment">/* turn off watchdog if in debug mode */</span>
<a name="l04637"></a>04637    <span class="keywordflow">if</span> (debug)
<a name="l04638"></a>04638       <a class="code" href="group__msectionh.html#ga070f5551bb23bbfd54ca81554e729136">cm_set_watchdog_params</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, 0);
<a name="l04639"></a>04639 
<a name="l04640"></a>04640    <span class="comment">/* set own message print function */</span>
<a name="l04641"></a>04641    <a class="code" href="group__msectionh.html#gaf4589061aab20d351d901b6d2ccc0cc0">cm_set_msg_print</a>(<a class="code" href="group__mdefineh.html#ga3378bf6f53a24392145df33c8acc9c0c">MT_ALL</a>, <a class="code" href="group__mdefineh.html#ga3378bf6f53a24392145df33c8acc9c0c">MT_ALL</a>, <a class="code" href="fal_8c.html#a48fa208044b7e1373af57d1b24393693">print_message</a>);
<a name="l04642"></a>04642 
<a name="l04643"></a>04643    <span class="comment">/* register message receiver */</span>
<a name="l04644"></a>04644    <a class="code" href="group__msectionh.html#ga73f40964dfd745537f41ce13fbcc2fa4">cm_msg_register</a>(<a class="code" href="fal_8c.html#a168945a222012d1d908c78a41e7022c2">receive_message</a>);
<a name="l04645"></a>04645 
<a name="l04646"></a>04646    <span class="comment">/* register CNAF callback */</span>
<a name="l04647"></a>04647    <a class="code" href="group__msectionh.html#gad3115b4913387a49fb131e5144509557">cm_register_function</a>(<a class="code" href="group__mrpcdefineh.html#ga04139d1c129e9a87093587d16d8ac5a4">RPC_CNAF16</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2e79e874780c7bf4355f940ac18c7bfa">cnaf_callback</a>);
<a name="l04648"></a>04648    <a class="code" href="group__msectionh.html#gad3115b4913387a49fb131e5144509557">cm_register_function</a>(<a class="code" href="group__mrpcdefineh.html#gaf48c6e230ebd543627002769684a3240">RPC_CNAF24</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a2e79e874780c7bf4355f940ac18c7bfa">cnaf_callback</a>);
<a name="l04649"></a>04649 
<a name="l04650"></a>04650    <span class="comment">/* register callback for clearing histos */</span>
<a name="l04651"></a>04651    <a class="code" href="group__msectionh.html#gad3115b4913387a49fb131e5144509557">cm_register_function</a>(<a class="code" href="group__mrpcdefineh.html#gab04cd68bb2484fcbaa62d2eda3100250">RPC_ANA_CLEAR_HISTOS</a>, <a class="code" href="fal_8c.html#a6286c3b1e900cb783d0b57e910d06f8a">ana_callback</a>);
<a name="l04652"></a>04652 
<a name="l04653"></a>04653    <span class="comment">/* register callback for rewinding tapes */</span>
<a name="l04654"></a>04654    <a class="code" href="group__msectionh.html#gad3115b4913387a49fb131e5144509557">cm_register_function</a>(<a class="code" href="group__mrpcdefineh.html#gaaeb6f7b0868c6c7cf033e4da7c3ebf2d">RPC_LOG_REWIND</a>, <a class="code" href="fal_8c.html#afc00b48c6ecb0997ffbaff2d5913b376">log_callback</a>);
<a name="l04655"></a>04655 
<a name="l04656"></a>04656    <span class="comment">/* call frontend init function */</span>
<a name="l04657"></a>04657    printf(<span class="stringliteral">&quot;Init hardware...&quot;</span>);
<a name="l04658"></a>04658    <span class="keywordflow">if</span> (<a class="code" href="crate3_2crate_8cpp.html#a34c51ae8c88f4717087b0604975516f4">frontend_init</a>() != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l04659"></a>04659       printf(<span class="stringliteral">&quot;Cannot initialize hardware.\n&quot;</span>);
<a name="l04660"></a>04660       printf(<span class="stringliteral">&quot;&lt;Please hit return to exit&gt;&quot;</span>);
<a name="l04661"></a>04661       getchar();
<a name="l04662"></a>04662       <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l04663"></a>04663       <span class="keywordflow">return</span> 1;
<a name="l04664"></a>04664    }
<a name="l04665"></a>04665    printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l04666"></a>04666 
<a name="l04667"></a>04667    <span class="comment">/* reqister equipment in ODB */</span>
<a name="l04668"></a>04668    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#ab834073e5b665fccaa4eff2a61bc9372">register_equipment</a>();
<a name="l04669"></a>04669 
<a name="l04670"></a>04670    <span class="comment">/* initialize module parameters */</span>
<a name="l04671"></a>04671    <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a9527329c5d4ec01a728dfc43ad33b2fa">init_module_parameters</a>() != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l04672"></a>04672       <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l04673"></a>04673       <span class="keywordflow">return</span> 1;
<a name="l04674"></a>04674    }
<a name="l04675"></a>04675 
<a name="l04676"></a>04676    <span class="comment">/* init logger */</span>
<a name="l04677"></a>04677    <a class="code" href="fal_8c.html#acca02da5a5a8b842893ecc30ea12fda7">logger_init</a>();
<a name="l04678"></a>04678 
<a name="l04679"></a>04679    <span class="comment">/* call analyzer init function */</span>
<a name="l04680"></a>04680    printf(<span class="stringliteral">&quot;Init analyzer...&quot;</span>);
<a name="l04681"></a>04681    <span class="keywordflow">if</span> (<a class="code" href="fal_8c.html#a12f9d4b93e18856d7ea847512163fc3b">mana_init</a>() != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l04682"></a>04682       printf(<span class="stringliteral">&quot;Cannot initialize analyzer.\n&quot;</span>);
<a name="l04683"></a>04683       printf(<span class="stringliteral">&quot;&lt;Please hit return to exit&gt;&quot;</span>);
<a name="l04684"></a>04684       getchar();
<a name="l04685"></a>04685       <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l04686"></a>04686       <span class="keywordflow">return</span> 0;
<a name="l04687"></a>04687    }
<a name="l04688"></a>04688    printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l04689"></a>04689 
<a name="l04690"></a>04690    <span class="comment">/* reqister requests in ODB */</span>
<a name="l04691"></a>04691    <a class="code" href="fal_8c.html#a1a2128d90a2986636c9e80968c0d5c67">register_requests</a>();
<a name="l04692"></a>04692 
<a name="l04693"></a>04693    <span class="comment">/* open history logging */</span>
<a name="l04694"></a>04694    <a class="code" href="fal_8c.html#a8727d1a82d030403d6074654a6996814">open_history</a>();
<a name="l04695"></a>04695 
<a name="l04696"></a>04696    <span class="comment">/* initialize screen display */</span>
<a name="l04697"></a>04697    <a class="code" href="group__msectionh.html#gaaec652d8878ceb5ef38ad1ba2cbf7dec">ss_sleep</a>(2000);
<a name="l04698"></a>04698    <a class="code" href="examples_2macro_2midas__macro_8h.html#aa088095d2fabc6972c25ad622744cfd1">display</a>(<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l04699"></a>04699 
<a name="l04700"></a>04700    <span class="comment">/* initialize ss_getchar */</span>
<a name="l04701"></a>04701    <a class="code" href="group__msectionh.html#ga421c43305fae4215de164a5dd418909c">ss_getchar</a>(0);
<a name="l04702"></a>04702 
<a name="l04703"></a>04703    <span class="comment">/* call main scheduler loop */</span>
<a name="l04704"></a>04704    <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a94c9987508c91ae4827cc231f43b577e">scheduler</a>();
<a name="l04705"></a>04705 
<a name="l04706"></a>04706    <span class="comment">/* call user exit function */</span>
<a name="l04707"></a>04707    <a class="code" href="crate3_2crate_8cpp.html#a15271255cca6c92978b28afd5a548382">frontend_exit</a>();
<a name="l04708"></a>04708 
<a name="l04709"></a>04709    <span class="comment">/* close slow control drivers */</span>
<a name="l04710"></a>04710    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l04711"></a>04711       <span class="keywordflow">if</span> ((equipment[i].info.eq_type &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) &amp;&amp; equipment[i].<a class="code" href="group__midasincludecode.html#gaf498c07c0758b46649715eead4627874">status</a> == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l04712"></a>04712          equipment[i].<a class="code" href="group__midasincludecode.html#gae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#gacfa1d482ab47b3ceebb9717007111649">CMD_EXIT</a>, &amp;equipment[i]);
<a name="l04713"></a>04713 
<a name="l04714"></a>04714    <span class="comment">/* close history logging */</span>
<a name="l04715"></a>04715    <a class="code" href="fal_8c.html#a47956ca76e86a1e107f5c4f1b7c8399a">close_history</a>();
<a name="l04716"></a>04716 
<a name="l04717"></a>04717    <span class="comment">/* close network connection to server */</span>
<a name="l04718"></a>04718    <a class="code" href="group__msectionh.html#ga9792ed24b1150464250ac794067c9196">cm_disconnect_experiment</a>();
<a name="l04719"></a>04719 
<a name="l04720"></a>04720    <a class="code" href="group__msectionh.html#ga8d56c0c36ceb913e9de1043fe5bc269e">ss_clear_screen</a>();
<a name="l04721"></a>04721    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 0, <span class="stringliteral">&quot;%s shut down.&quot;</span>, <a class="code" href="fal_8c.html#a9909e4be3ffcc1cc3f2076aaaa7629b0">fal_name</a>);
<a name="l04722"></a>04722    <a class="code" href="group__msectionh.html#gad73ff3ba2cab1ffd6de38798a87f3b5e">ss_printf</a>(0, 1, <span class="stringliteral">&quot;&quot;</span>);
<a name="l04723"></a>04723 
<a name="l04724"></a>04724    <span class="keywordflow">return</span> 0;
<a name="l04725"></a>04725 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ:Rootana by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
