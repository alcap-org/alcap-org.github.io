<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AlcapDAQ:Rootana: Midas Elog Functions (el_xxx)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>Midas Elog Functions (el_xxx)<br/>
<small>
[<a class="el" href="group__midasincludecode.html">The midas.h &amp; midas.c</a>]</small>
</h1><table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a> (char *message, char *<a class="el" href="mzdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>, char *result, int <a class="el" href="slowcontrol_2vacuum__sensor_2frontend_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__elfunctionc.html#gaa6261c2ba4f0e04cb8285628a726ce90">el_submit</a> (int <a class="el" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>, char *author, char *<a class="el" href="ybos_8c.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>, char *system, char *subject, char *text, char *reply_to, char *encoding, char *afilename1, char *buffer1, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_size1, char *afilename2, char *buffer2, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_size2, char *afilename3, char *buffer3, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> buffer_size3, char *<a class="el" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> tag_size)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__elfunctionc.html#gaf2ce5ce365736663fce04d7e69064aa3">el_search_message</a> (char *<a class="el" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, int *fh, <a class="el" href="odbhist_8c.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a> walk)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__elfunctionc.html#ga244d23f35a780882669f635e2b590499">el_retrieve</a> (char *<a class="el" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, char *date, int *<a class="el" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>, char *author, char *<a class="el" href="ybos_8c.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>, char *system, char *subject, char *text, int *textsize, char *orig_tag, char *reply_tag, char *attachment1, char *attachment2, char *attachment3, char *encoding)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__elfunctionc.html#ga159e0c5f82d13b409f121d76b4a71947">el_search_run</a> (int <a class="el" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>, char *return_tag)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__elfunctionc.html#ga4f6dd3fc76fe56b9709626a1d9e9bf98">el_delete_message</a> (char *<a class="el" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>)</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>dox dox dox </p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="gad62749a2ca09a81ec2bb0daa8429967e"></a><!-- doxytag: member="midas.c::el_decode" ref="gad62749a2ca09a81ec2bb0daa8429967e" args="(char *message, char *key, char *result, int size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void el_decode </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>result</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>dox </p>

<p>Definition at line <a class="el" href="midas_8c_source.html#l15018">15018</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l15633">el_retrieve()</a>, and <a class="el" href="midas_8c_source.html#l15064">el_submit()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l15019"></a>15019 {
<a name="l15020"></a>15020    <span class="keywordtype">char</span> *rstart = result;
<a name="l15021"></a>15021    <span class="keywordtype">char</span> *pc;
<a name="l15022"></a>15022 
<a name="l15023"></a>15023    <span class="keywordflow">if</span> (result == NULL)
<a name="l15024"></a>15024       <span class="keywordflow">return</span>;
<a name="l15025"></a>15025 
<a name="l15026"></a>15026    *result = 0;
<a name="l15027"></a>15027 
<a name="l15028"></a>15028    <span class="keywordflow">if</span> (strstr(<a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>, <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>)) {
<a name="l15029"></a>15029       <span class="keywordflow">for</span> (pc = strstr(<a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>, <a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>) + strlen(<a class="code" href="mdump_8c.html#a5cdb181553f9aa7bb182db5c195bb079">key</a>); *pc != <span class="charliteral">&apos;\n&apos;</span>;)
<a name="l15030"></a>15030          *result++ = *pc++;
<a name="l15031"></a>15031       *result = 0;
<a name="l15032"></a>15032    }
<a name="l15033"></a>15033 
<a name="l15034"></a>15034    assert((<span class="keywordtype">int</span>)strlen(rstart) &lt; <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>);
<a name="l15035"></a>15035 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga4f6dd3fc76fe56b9709626a1d9e9bf98"></a><!-- doxytag: member="midas.c::el_delete_message" ref="ga4f6dd3fc76fe56b9709626a1d9e9bf98" args="(char *tag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> el_delete_message </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>tag</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="midas_8c_source.html#l15854">15854</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="fal_8c_source.html#l00201">buffer</a>, <a class="el" href="midas_8c_source.html#l02913">cm_get_experiment_database()</a>, <a class="el" href="midas_8c_source.html#l02934">cm_get_experiment_mutex()</a>, <a class="el" href="odb_8c_source.html#l03261">db_get_value()</a>, <a class="el" href="midas_8h_source.html#l01001">DB_SUCCESS</a>, <a class="el" href="midas_8h_source.html#l00639">DIR_SEPARATOR</a>, <a class="el" href="midas_8h_source.html#l00640">DIR_SEPARATOR_STR</a>, <a class="el" href="midas_8h_source.html#l01111">EL_FILE_ERROR</a>, <a class="el" href="midas_8h_source.html#l01110">EL_SUCCESS</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="odbhist_8c_source.html#l00059">file_name</a>, <a class="el" href="mucap__compress_8cpp_source.html#l00011">hDB</a>, <a class="el" href="midas_8h_source.html#l01755">M_FREE</a>, <a class="el" href="midas_8h_source.html#l01753">M_MALLOC</a>, <a class="el" href="camac_8c_source.html#l00506">n</a>, <a class="el" href="msystem_8h_source.html#l00351">O_BINARY</a>, <a class="el" href="mgd_8c_source.html#l01505">offset</a>, <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00256">read</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="system_8c_source.html#l02091">ss_mutex_release()</a>, <a class="el" href="system_8c_source.html#l01980">ss_mutex_wait_for()</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, <a class="el" href="msystem_8h_source.html#l00369">TELL</a>, <a class="el" href="midas_8h_source.html#l00746">TID_STRING</a>, <a class="el" href="p30_8h_source.html#l00043">TRUE</a>, and <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00259">write</a>.</p>

<p>Referenced by <a class="el" href="mhttpd_8c_source.html#l02941">show_elog_delete()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l15857"></a>15857          : <a class="code" href="group__msectionh.html#ga0403d907441aaec11229bbe9b43d0f5c">el_submit</a>
<a name="l15858"></a>15858 
<a name="l15859"></a>15859   Purpose: Submit an ELog entry
<a name="l15860"></a>15860 
<a name="l15861"></a>15861   Input:
<a name="l15862"></a>15862     <span class="keywordtype">char</span>   *<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>             Message tage
<a name="l15863"></a>15863 
<a name="l15864"></a>15864   Output:
<a name="l15865"></a>15865     &lt;none&gt;
<a name="l15866"></a>15866 
<a name="l15867"></a>15867   Function <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>:
<a name="l15868"></a>15868     <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>              Successful completion
<a name="l15869"></a>15869 
<a name="l15870"></a>15870 \********************************************************************/
<a name="l15871"></a>15871 {
<a name="l15872"></a>15872 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l15873"></a>15873 <span class="preprocessor"></span>   <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, fh, mutex, <a class="code" href="mgd_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = 0, tail_size, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l15874"></a>15874    <span class="keywordtype">char</span> dir[256], <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256], <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256];
<a name="l15875"></a>15875    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>;
<a name="l15876"></a>15876    <span class="keywordtype">char</span> *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> = NULL;
<a name="l15877"></a>15877 
<a name="l15878"></a>15878    <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;hDB, NULL);
<a name="l15879"></a>15879 
<a name="l15880"></a>15880    <span class="comment">/* request semaphore */</span>
<a name="l15881"></a>15881    <a class="code" href="group__msectionh.html#ga6df13ff68685b0b1f818a983430de5ec">cm_get_experiment_mutex</a>(NULL, &amp;mutex);
<a name="l15882"></a>15882    <a class="code" href="group__msystemincludecode.html#gad3c6b30fd77b7be3d4d3d6db5f106b45">ss_mutex_wait_for</a>(mutex, 0);
<a name="l15883"></a>15883 
<a name="l15884"></a>15884    <span class="comment">/* generate file name YYMMDD.log in data directory */</span>
<a name="l15885"></a>15885    <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;hDB, NULL);
<a name="l15886"></a>15886 
<a name="l15887"></a>15887    size = <span class="keyword">sizeof</span>(dir);
<a name="l15888"></a>15888    memset(dir, 0, size);
<a name="l15889"></a>15889    status = <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Elog dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l15890"></a>15890    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l15891"></a>15891       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Data dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15892"></a>15892 
<a name="l15893"></a>15893    <span class="keywordflow">if</span> (dir[0] != 0 &amp;&amp; dir[strlen(dir) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l15894"></a>15894       strcat(dir, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l15895"></a>15895 
<a name="l15896"></a>15896    strcpy(str, <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>);
<a name="l15897"></a>15897    <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;.&apos;</span>)) {
<a name="l15898"></a>15898       offset = atoi(strchr(str, <span class="charliteral">&apos;.&apos;</span>) + 1);
<a name="l15899"></a>15899       *strchr(str, <span class="charliteral">&apos;.&apos;</span>) = 0;
<a name="l15900"></a>15900    }
<a name="l15901"></a>15901    sprintf(file_name, <span class="stringliteral">&quot;%s%s.log&quot;</span>, dir, str);
<a name="l15902"></a>15902    fh = open(file_name, O_CREAT | O_RDWR | <a class="code" href="group__msystemincludecode.html#ga36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>, 0644);
<a name="l15903"></a>15903    <span class="keywordflow">if</span> (fh &lt; 0) {
<a name="l15904"></a>15904       <a class="code" href="group__msystemincludecode.html#gae9746bf50ec478e587bb9d981f8eb9da">ss_mutex_release</a>(mutex);
<a name="l15905"></a>15905       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15906"></a>15906    }
<a name="l15907"></a>15907    lseek(fh, offset, SEEK_SET);
<a name="l15908"></a>15908    <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(fh, str, 16);
<a name="l15909"></a>15909    size = atoi(str + 9);
<a name="l15910"></a>15910 
<a name="l15911"></a>15911    <span class="comment">/* buffer tail of logfile */</span>
<a name="l15912"></a>15912    lseek(fh, 0, SEEK_END);
<a name="l15913"></a>15913    tail_size = <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(fh) - (offset + size);
<a name="l15914"></a>15914 
<a name="l15915"></a>15915    <span class="keywordflow">if</span> (tail_size &gt; 0) {
<a name="l15916"></a>15916       buffer = (<span class="keywordtype">char</span> *) <a class="code" href="group__msectionh.html#ga130728d73c8c9b46e0b9bd2e34557c3d">M_MALLOC</a>(tail_size);
<a name="l15917"></a>15917       <span class="keywordflow">if</span> (buffer == NULL) {
<a name="l15918"></a>15918          close(fh);
<a name="l15919"></a>15919          <a class="code" href="group__msystemincludecode.html#gae9746bf50ec478e587bb9d981f8eb9da">ss_mutex_release</a>(mutex);
<a name="l15920"></a>15920          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15921"></a>15921       }
<a name="l15922"></a>15922 
<a name="l15923"></a>15923       lseek(fh, offset + size, SEEK_SET);
<a name="l15924"></a>15924       n = <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(fh, buffer, tail_size);
<a name="l15925"></a>15925    }
<a name="l15926"></a>15926    lseek(fh, offset, SEEK_SET);
<a name="l15927"></a>15927 
<a name="l15928"></a>15928    <span class="keywordflow">if</span> (tail_size &gt; 0) {
<a name="l15929"></a>15929       n = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(fh, buffer, tail_size);
<a name="l15930"></a>15930       <a class="code" href="group__msectionh.html#ga95c0d83820c28cf52ea13271b034fcb2">M_FREE</a>(buffer);
<a name="l15931"></a>15931    }
<a name="l15932"></a>15932 
<a name="l15933"></a>15933    <span class="comment">/* truncate file here */</span>
<a name="l15934"></a>15934 <span class="preprocessor">#ifdef OS_WINNT</span>
<a name="l15935"></a>15935 <span class="preprocessor"></span>   chsize(fh, <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(fh));
<a name="l15936"></a>15936 <span class="preprocessor">#else</span>
<a name="l15937"></a>15937 <span class="preprocessor"></span>   ftruncate(fh, <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(fh));
<a name="l15938"></a>15938 <span class="preprocessor">#endif</span>
<a name="l15939"></a>15939 <span class="preprocessor"></span>
<a name="l15940"></a>15940    <span class="comment">/* if file length gets zero, delete file */</span>
<a name="l15941"></a>15941    tail_size = lseek(fh, 0, SEEK_END);
<a name="l15942"></a>15942    close(fh);
<a name="l15943"></a>15943 
<a name="l15944"></a>15944    <span class="keywordflow">if</span> (tail_size == 0)
<a name="l15945"></a>15945       <span class="keyword">remove</span>(file_name);
<a name="l15946"></a>15946 
<a name="l15947"></a>15947    <span class="comment">/* release elog mutex */</span>
<a name="l15948"></a>15948    <a class="code" href="group__msystemincludecode.html#gae9746bf50ec478e587bb9d981f8eb9da">ss_mutex_release</a>(mutex);
<a name="l15949"></a>15949 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l15950"></a>15950 
<a name="l15951"></a>15951    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>;
<a name="l15952"></a>15952 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga244d23f35a780882669f635e2b590499"></a><!-- doxytag: member="midas.c::el_retrieve" ref="ga244d23f35a780882669f635e2b590499" args="(char *tag, char *date, int *run, char *author, char *type, char *system, char *subject, char *text, int *textsize, char *orig_tag, char *reply_tag, char *attachment1, char *attachment2, char *attachment3, char *encoding)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> el_retrieve </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>tag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>date</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>run</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>author</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>system</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>subject</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>text</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>textsize</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>orig_tag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>reply_tag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>attachment1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>attachment2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>attachment3</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>encoding</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="midas_8c_source.html#l15633">15633</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8c_source.html#l15018">el_decode()</a>, <a class="el" href="midas_8h_source.html#l01115">EL_LAST_MSG</a>, <a class="el" href="midas_8c_source.html#l15379">el_search_message()</a>, <a class="el" href="midas_8h_source.html#l01110">EL_SUCCESS</a>, <a class="el" href="midas_8h_source.html#l01113">EL_TRUNCATED</a>, <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00276">message</a>, <a class="el" href="mgd_8c_source.html#l01505">offset</a>, <a class="el" href="sis3803_8c_source.html#l00925">p</a>, <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00256">read</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="msystem_8h_source.html#l00369">TELL</a>, and <a class="el" href="p30_8h_source.html#l00043">TRUE</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l15790">el_search_run()</a>, <a class="el" href="mhttpd_8c_source.html#l02506">show_elog_new()</a>, <a class="el" href="mhttpd_8c_source.html#l04103">show_elog_page()</a>, and <a class="el" href="mhttpd_8c_source.html#l03003">show_elog_submit_query()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l15639"></a>15639          : <a class="code" href="group__msectionh.html#ga203cfa8e2d036e5e56a2fdd9d17eb09d">el_retrieve</a>
<a name="l15640"></a>15640 
<a name="l15641"></a>15641   Purpose: Retrieve an ELog entry <a class="code" href="patch__mevb_8cpp.html#a944cf20aa75177818af16fe394e984be">by</a> its <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a> tab
<a name="l15642"></a>15642 
<a name="l15643"></a>15643   Input:
<a name="l15644"></a>15644     <span class="keywordtype">char</span>   *<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>             <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a> <a class="code" href="scs__600__p1_8c.html#af8480819a437c1eaeaa5b28b890613fa">in</a> the form YYMMDD.offset
<a name="l15645"></a>15645     <span class="keywordtype">int</span>    *<a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>            Size of text <a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a>
<a name="l15646"></a>15646 
<a name="l15647"></a>15647   Output:
<a name="l15648"></a>15648     <span class="keywordtype">char</span>   *<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>             <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a> of retrieved <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>
<a name="l15649"></a>15649     <span class="keywordtype">char</span>   *date            Date/<a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a> of <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a> recording
<a name="l15650"></a>15650     <span class="keywordtype">int</span>    *<a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>             Run number
<a name="l15651"></a>15651     <span class="keywordtype">char</span>   *author          Message author
<a name="l15652"></a>15652     <span class="keywordtype">char</span>   *<a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>            Message <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>
<a name="l15653"></a>15653     <span class="keywordtype">char</span>   *system          Message system
<a name="l15654"></a>15654     <span class="keywordtype">char</span>   *subject         Subject
<a name="l15655"></a>15655     <span class="keywordtype">char</span>   *text            Message text
<a name="l15656"></a>15656     <span class="keywordtype">char</span>   *orig_tag        Original <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a> <span class="keywordflow">if</span> <span class="keyword">this</span> one is a reply
<a name="l15657"></a>15657     <span class="keywordtype">char</span>   *reply_tag       Reply <span class="keywordflow">for</span> current <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>
<a name="l15658"></a>15658     <span class="keywordtype">char</span>   *attachment1/2/3 File attachment
<a name="l15659"></a>15659     <span class="keywordtype">char</span>   *encoding        Encoding of <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>
<a name="l15660"></a>15660     <span class="keywordtype">int</span>    *<a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>            Actual <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a> text <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>
<a name="l15661"></a>15661 
<a name="l15662"></a>15662   Function <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>:
<a name="l15663"></a>15663     <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>              Successful completion
<a name="l15664"></a>15664     <a class="code" href="group__err26.html#ga5f11d9b4e829e2486252fef634b6a382">EL_LAST_MSG</a>             Last <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a> <a class="code" href="scs__600__p1_8c.html#af8480819a437c1eaeaa5b28b890613fa">in</a> log
<a name="l15665"></a>15665 
<a name="l15666"></a>15666 \********************************************************************/
<a name="l15667"></a>15667 {
<a name="l15668"></a>15668    <span class="keywordtype">int</span> <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, fh = 0, <a class="code" href="mgd_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a>, search_status, rd;
<a name="l15669"></a>15669    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256], *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>;
<a name="l15670"></a>15670    <span class="keywordtype">char</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>[10000], thread[256], attachment_all[256];
<a name="l15671"></a>15671 
<a name="l15672"></a>15672    <span class="keywordflow">if</span> (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[0]) {
<a name="l15673"></a>15673       search_status = <a class="code" href="group__msectionh.html#gad272ad608ea84675b7a2fa0ad57308ba">el_search_message</a>(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, &amp;fh, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15674"></a>15674       <span class="keywordflow">if</span> (search_status != <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>)
<a name="l15675"></a>15675          <span class="keywordflow">return</span> search_status;
<a name="l15676"></a>15676    } <span class="keywordflow">else</span> {
<a name="l15677"></a>15677       <span class="comment">/* open most recent message */</span>
<a name="l15678"></a>15678       strcpy(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <span class="stringliteral">&quot;-1&quot;</span>);
<a name="l15679"></a>15679       search_status = <a class="code" href="group__msectionh.html#gad272ad608ea84675b7a2fa0ad57308ba">el_search_message</a>(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, &amp;fh, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15680"></a>15680       <span class="keywordflow">if</span> (search_status != <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>)
<a name="l15681"></a>15681          <span class="keywordflow">return</span> search_status;
<a name="l15682"></a>15682    }
<a name="l15683"></a>15683 
<a name="l15684"></a>15684    <span class="comment">/* extract message size */</span>
<a name="l15685"></a>15685    <a class="code" href="mgd_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(fh);
<a name="l15686"></a>15686    rd = <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(fh, str, 15);
<a name="l15687"></a>15687    assert(rd == 15);
<a name="l15688"></a>15688    
<a name="l15689"></a>15689    <span class="comment">/* make sure the input string is zero-terminated before we call atoi() */</span>
<a name="l15690"></a>15690    str[15] = 0;
<a name="l15691"></a>15691 
<a name="l15692"></a>15692    <span class="comment">/* get size */</span>
<a name="l15693"></a>15693    size = atoi(str+9);
<a name="l15694"></a>15694    
<a name="l15695"></a>15695    assert(strncmp(str,<span class="stringliteral">&quot;$Start$:&quot;</span>,8) == 0);
<a name="l15696"></a>15696    assert(size &gt; 15);
<a name="l15697"></a>15697    assert(size &lt; <span class="keyword">sizeof</span>(message));
<a name="l15698"></a>15698    
<a name="l15699"></a>15699    memset(message, 0, <span class="keyword">sizeof</span>(message));
<a name="l15700"></a>15700 
<a name="l15701"></a>15701    rd = <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(fh, message, size);
<a name="l15702"></a>15702    assert(rd &gt; 0);
<a name="l15703"></a>15703    assert((rd+15 == size)||(rd == size));
<a name="l15704"></a>15704 
<a name="l15705"></a>15705    close(fh);
<a name="l15706"></a>15706 
<a name="l15707"></a>15707    <span class="comment">/* decode message */</span>
<a name="l15708"></a>15708    <span class="keywordflow">if</span> (strstr(message, <span class="stringliteral">&quot;Run: &quot;</span>) &amp;&amp; <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>)
<a name="l15709"></a>15709       *<a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a> = atoi(strstr(message, <span class="stringliteral">&quot;Run: &quot;</span>) + 5);
<a name="l15710"></a>15710 
<a name="l15711"></a>15711    <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Date: &quot;</span>,     date,     80); <span class="comment">/* size from show_elog_submit_query() */</span>
<a name="l15712"></a>15712    <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Thread: &quot;</span>, thread, <span class="keyword">sizeof</span>(thread));
<a name="l15713"></a>15713    <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Author: &quot;</span>,   author,   80); <span class="comment">/* size from show_elog_submit_query() */</span>
<a name="l15714"></a>15714    <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Type: &quot;</span>,     <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>,     80); <span class="comment">/* size from show_elog_submit_query() */</span>
<a name="l15715"></a>15715    <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;System: &quot;</span>,   system,   80); <span class="comment">/* size from show_elog_submit_query() */</span>
<a name="l15716"></a>15716    <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Subject: &quot;</span>,  subject, 256); <span class="comment">/* size from show_elog_submit_query() */</span>
<a name="l15717"></a>15717    <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Attachment: &quot;</span>, attachment_all, <span class="keyword">sizeof</span>(attachment_all));
<a name="l15718"></a>15718    <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Encoding: &quot;</span>, encoding, 80); <span class="comment">/* size from show_elog_submit_query() */</span>
<a name="l15719"></a>15719 
<a name="l15720"></a>15720    <span class="comment">/* break apart attachements */</span>
<a name="l15721"></a>15721    <span class="keywordflow">if</span> (attachment1 &amp;&amp; attachment2 &amp;&amp; attachment3) {
<a name="l15722"></a>15722       attachment1[0] = attachment2[0] = attachment3[0] = 0;
<a name="l15723"></a>15723       p = strtok(attachment_all, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l15724"></a>15724       <span class="keywordflow">if</span> (p != NULL) {
<a name="l15725"></a>15725          strcpy(attachment1, p);
<a name="l15726"></a>15726          p = strtok(NULL, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l15727"></a>15727          <span class="keywordflow">if</span> (p != NULL) {
<a name="l15728"></a>15728             strcpy(attachment2, p);
<a name="l15729"></a>15729             p = strtok(NULL, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l15730"></a>15730             <span class="keywordflow">if</span> (p != NULL)
<a name="l15731"></a>15731                strcpy(attachment3, p);
<a name="l15732"></a>15732          }
<a name="l15733"></a>15733       }
<a name="l15734"></a>15734 
<a name="l15735"></a>15735       assert(strlen(attachment1) &lt; 256); <span class="comment">/* size from show_elog_submit_query() */</span>
<a name="l15736"></a>15736       assert(strlen(attachment2) &lt; 256); <span class="comment">/* size from show_elog_submit_query() */</span>
<a name="l15737"></a>15737       assert(strlen(attachment3) &lt; 256); <span class="comment">/* size from show_elog_submit_query() */</span>
<a name="l15738"></a>15738    }
<a name="l15739"></a>15739 
<a name="l15740"></a>15740    <span class="comment">/* conver thread in reply-to and reply-from */</span>
<a name="l15741"></a>15741    <span class="keywordflow">if</span> (orig_tag != NULL &amp;&amp; reply_tag != NULL) {
<a name="l15742"></a>15742       p = strtok(thread, <span class="stringliteral">&quot; \r&quot;</span>);
<a name="l15743"></a>15743       <span class="keywordflow">if</span> (p != NULL)
<a name="l15744"></a>15744          strcpy(orig_tag, p);
<a name="l15745"></a>15745       <span class="keywordflow">else</span>
<a name="l15746"></a>15746          strcpy(orig_tag, <span class="stringliteral">&quot;&quot;</span>);
<a name="l15747"></a>15747       p = strtok(NULL, <span class="stringliteral">&quot; \r&quot;</span>);
<a name="l15748"></a>15748       <span class="keywordflow">if</span> (p != NULL)
<a name="l15749"></a>15749          strcpy(reply_tag, p);
<a name="l15750"></a>15750       <span class="keywordflow">else</span>
<a name="l15751"></a>15751          strcpy(reply_tag, <span class="stringliteral">&quot;&quot;</span>);
<a name="l15752"></a>15752       <span class="keywordflow">if</span> (atoi(orig_tag) == 0)
<a name="l15753"></a>15753          orig_tag[0] = 0;
<a name="l15754"></a>15754       <span class="keywordflow">if</span> (atoi(reply_tag) == 0)
<a name="l15755"></a>15755          reply_tag[0] = 0;
<a name="l15756"></a>15756    }
<a name="l15757"></a>15757 
<a name="l15758"></a>15758    p = strstr(message, <span class="stringliteral">&quot;========================================\n&quot;</span>);
<a name="l15759"></a>15759 
<a name="l15760"></a>15760    <span class="keywordflow">if</span> (text != NULL) {
<a name="l15761"></a>15761       <span class="keywordflow">if</span> (p != NULL) {
<a name="l15762"></a>15762          p += 41;
<a name="l15763"></a>15763          <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) strlen(p) &gt;= *textsize) {
<a name="l15764"></a>15764             strncpy(text, p, *textsize - 1);
<a name="l15765"></a>15765             text[*textsize - 1] = 0;
<a name="l15766"></a>15766             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga3e20cada0b5022911f56eb7c8b29b20b">EL_TRUNCATED</a>;
<a name="l15767"></a>15767          } <span class="keywordflow">else</span> {
<a name="l15768"></a>15768             strcpy(text, p);
<a name="l15769"></a>15769 
<a name="l15770"></a>15770             <span class="comment">/* strip end tag */</span>
<a name="l15771"></a>15771             <span class="keywordflow">if</span> (strstr(text, <span class="stringliteral">&quot;$End$&quot;</span>))
<a name="l15772"></a>15772                *strstr(text, <span class="stringliteral">&quot;$End$&quot;</span>) = 0;
<a name="l15773"></a>15773 
<a name="l15774"></a>15774             *textsize = strlen(text);
<a name="l15775"></a>15775          }
<a name="l15776"></a>15776       } <span class="keywordflow">else</span> {
<a name="l15777"></a>15777          text[0] = 0;
<a name="l15778"></a>15778          *textsize = 0;
<a name="l15779"></a>15779       }
<a name="l15780"></a>15780    }
<a name="l15781"></a>15781 
<a name="l15782"></a>15782    <span class="keywordflow">if</span> (search_status == <a class="code" href="group__err26.html#ga5f11d9b4e829e2486252fef634b6a382">EL_LAST_MSG</a>)
<a name="l15783"></a>15783       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga5f11d9b4e829e2486252fef634b6a382">EL_LAST_MSG</a>;
<a name="l15784"></a>15784 
<a name="l15785"></a>15785    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>;
<a name="l15786"></a>15786 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="gaf2ce5ce365736663fce04d7e69064aa3"></a><!-- doxytag: member="midas.c::el_search_message" ref="gaf2ce5ce365736663fce04d7e69064aa3" args="(char *tag, int *fh, BOOL walk)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> el_search_message </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>tag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>fh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a050c65e107f0c828f856a231f4b4e788">BOOL</a>&nbsp;</td>
          <td class="paramname"> <em>walk</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>dox </p>

<p>Definition at line <a class="el" href="midas_8c_source.html#l15379">15379</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="generic_8c_source.html#l00091">abs</a>, <a class="el" href="midas_8c_source.html#l02913">cm_get_experiment_database()</a>, <a class="el" href="odb_8c_source.html#l03261">db_get_value()</a>, <a class="el" href="midas_8h_source.html#l01001">DB_SUCCESS</a>, <a class="el" href="midas_8h_source.html#l00639">DIR_SEPARATOR</a>, <a class="el" href="midas_8h_source.html#l00640">DIR_SEPARATOR_STR</a>, <a class="el" href="midas_8h_source.html#l01111">EL_FILE_ERROR</a>, <a class="el" href="midas_8h_source.html#l01114">EL_FIRST_MSG</a>, <a class="el" href="midas_8h_source.html#l01115">EL_LAST_MSG</a>, <a class="el" href="midas_8c_source.html#l15379">el_search_message()</a>, <a class="el" href="midas_8h_source.html#l01110">EL_SUCCESS</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="odbhist_8c_source.html#l00059">file_name</a>, <a class="el" href="mucap__compress_8cpp_source.html#l00011">hDB</a>, <a class="el" href="mdump_8c_source.html#l00115">i</a>, <a class="el" href="MFastSlowCorrelator_8cpp_source.html#l00063">last</a>, <a class="el" href="msystem_8h_source.html#l00351">O_BINARY</a>, <a class="el" href="mgd_8c_source.html#l01505">offset</a>, <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00256">read</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, <a class="el" href="msystem_8h_source.html#l00369">TELL</a>, <a class="el" href="midas_8h_source.html#l00746">TID_STRING</a>, <a class="el" href="CAET_8h_source.html#l00002">time</a>, and <a class="el" href="p30_8h_source.html#l00043">TRUE</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l15633">el_retrieve()</a>, <a class="el" href="midas_8c_source.html#l15379">el_search_message()</a>, <a class="el" href="midas_8c_source.html#l15790">el_search_run()</a>, <a class="el" href="midas_8c_source.html#l15064">el_submit()</a>, and <a class="el" href="mhttpd_8c_source.html#l04103">show_elog_page()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l15380"></a>15380 {
<a name="l15381"></a>15381    <span class="keywordtype">int</span> <a class="code" href="mdump_8c.html#a65a8886d814fb9bf73f9d4f0fd64d162">i</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, <a class="code" href="mgd_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a>, direction, <a class="code" href="MFastSlowCorrelator_8cpp.html#a3579fbbede9d99d8d4aafc118b3abed3">last</a>, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l15382"></a>15382    <span class="keyword">struct </span>tm *tms, ltms;
<a name="l15383"></a>15383    <a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a> lt, ltime, lact;
<a name="l15384"></a>15384    <span class="keywordtype">char</span> <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256], <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256], dir[256];
<a name="l15385"></a>15385    <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>;
<a name="l15386"></a>15386 
<a name="l15387"></a>15387 <span class="preprocessor">#if !defined(OS_VXWORKS)</span>
<a name="l15388"></a>15388 <span class="preprocessor"></span><span class="preprocessor">#if !defined(OS_VMS)</span>
<a name="l15389"></a>15389 <span class="preprocessor"></span>   tzset();
<a name="l15390"></a>15390 <span class="preprocessor">#endif</span>
<a name="l15391"></a>15391 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l15392"></a>15392 <span class="preprocessor"></span>
<a name="l15393"></a>15393    <span class="comment">/* open file */</span>
<a name="l15394"></a>15394    <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;hDB, NULL);
<a name="l15395"></a>15395 
<a name="l15396"></a>15396    size = <span class="keyword">sizeof</span>(dir);
<a name="l15397"></a>15397    memset(dir, 0, size);
<a name="l15398"></a>15398    status = <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Elog dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l15399"></a>15399    <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l15400"></a>15400       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Data dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15401"></a>15401 
<a name="l15402"></a>15402    <span class="keywordflow">if</span> (dir[0] != 0 &amp;&amp; dir[strlen(dir) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l15403"></a>15403       strcat(dir, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l15404"></a>15404 
<a name="l15405"></a>15405    <span class="comment">/* check tag for direction */</span>
<a name="l15406"></a>15406    direction = 0;
<a name="l15407"></a>15407    <span class="keywordflow">if</span> (strpbrk(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <span class="stringliteral">&quot;+-&quot;</span>)) {
<a name="l15408"></a>15408       direction = atoi(strpbrk(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <span class="stringliteral">&quot;+-&quot;</span>));
<a name="l15409"></a>15409       *strpbrk(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <span class="stringliteral">&quot;+-&quot;</span>) = 0;
<a name="l15410"></a>15410    }
<a name="l15411"></a>15411 
<a name="l15412"></a>15412    <span class="comment">/* if tag is given, open file directly */</span>
<a name="l15413"></a>15413    <span class="keywordflow">if</span> (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[0]) {
<a name="l15414"></a>15414       <span class="comment">/* extract time structure from tag */</span>
<a name="l15415"></a>15415       tms = &amp;ltms;
<a name="l15416"></a>15416       memset(tms, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm));
<a name="l15417"></a>15417       tms-&gt;tm_year = (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[0] - <span class="charliteral">&apos;0&apos;</span>) * 10 + (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[1] - <span class="charliteral">&apos;0&apos;</span>);
<a name="l15418"></a>15418       tms-&gt;tm_mon = (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[2] - <span class="charliteral">&apos;0&apos;</span>) * 10 + (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[3] - <span class="charliteral">&apos;0&apos;</span>) - 1;
<a name="l15419"></a>15419       tms-&gt;tm_mday = (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[4] - <span class="charliteral">&apos;0&apos;</span>) * 10 + (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[5] - <span class="charliteral">&apos;0&apos;</span>);
<a name="l15420"></a>15420       tms-&gt;tm_hour = 12;
<a name="l15421"></a>15421 
<a name="l15422"></a>15422       <span class="keywordflow">if</span> (tms-&gt;tm_year &lt; 90)
<a name="l15423"></a>15423          tms-&gt;tm_year += 100;
<a name="l15424"></a>15424       ltime = lt = mktime(tms);
<a name="l15425"></a>15425 
<a name="l15426"></a>15426       strcpy(str, <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>);
<a name="l15427"></a>15427       <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;.&apos;</span>)) {
<a name="l15428"></a>15428          offset = atoi(strchr(str, <span class="charliteral">&apos;.&apos;</span>) + 1);
<a name="l15429"></a>15429          *strchr(str, <span class="charliteral">&apos;.&apos;</span>) = 0;
<a name="l15430"></a>15430       } <span class="keywordflow">else</span>
<a name="l15431"></a>15431          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15432"></a>15432 
<a name="l15433"></a>15433       <span class="keywordflow">do</span> {
<a name="l15434"></a>15434          tms = localtime((<span class="keyword">const</span> time_t *) &amp;ltime);
<a name="l15435"></a>15435 
<a name="l15436"></a>15436          sprintf(file_name, <span class="stringliteral">&quot;%s%02d%02d%02d.log&quot;</span>, dir,
<a name="l15437"></a>15437                  tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1, tms-&gt;tm_mday);
<a name="l15438"></a>15438          *fh = open(file_name, O_RDWR | <a class="code" href="group__msystemincludecode.html#ga36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>, 0644);
<a name="l15439"></a>15439 
<a name="l15440"></a>15440          <span class="keywordflow">if</span> (*fh &lt; 0) {
<a name="l15441"></a>15441             <span class="keywordflow">if</span> (!walk)
<a name="l15442"></a>15442                <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15443"></a>15443 
<a name="l15444"></a>15444             <span class="keywordflow">if</span> (direction == -1)
<a name="l15445"></a>15445                ltime -= 3600 * 24;      <span class="comment">/* one day back */</span>
<a name="l15446"></a>15446             <span class="keywordflow">else</span>
<a name="l15447"></a>15447                ltime += 3600 * 24;      <span class="comment">/* go forward one day */</span>
<a name="l15448"></a>15448 
<a name="l15449"></a>15449             <span class="comment">/* set new tag */</span>
<a name="l15450"></a>15450             tms = localtime((<span class="keyword">const</span> time_t *) &amp;ltime);
<a name="l15451"></a>15451             sprintf(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <span class="stringliteral">&quot;%02d%02d%02d.0&quot;</span>, tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1,
<a name="l15452"></a>15452                     tms-&gt;tm_mday);
<a name="l15453"></a>15453          }
<a name="l15454"></a>15454 
<a name="l15455"></a>15455          <span class="comment">/* in forward direction, stop today */</span>
<a name="l15456"></a>15456          <span class="keywordflow">if</span> (direction != -1 &amp;&amp; ltime &gt; (<a class="code" href="group__mvmestdinclude.html#ga798af1e30bc65f319c1a246cecf59e39">DWORD</a>) <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>(NULL) + 3600 * 24)
<a name="l15457"></a>15457             <span class="keywordflow">break</span>;
<a name="l15458"></a>15458 
<a name="l15459"></a>15459          <span class="comment">/* in backward direction, go back 10 years */</span>
<a name="l15460"></a>15460          <span class="keywordflow">if</span> (direction == -1 &amp;&amp; <a class="code" href="generic_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>((<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) lt - (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) ltime) &gt; 3600 * 24 * 365 * 10)
<a name="l15461"></a>15461             <span class="keywordflow">break</span>;
<a name="l15462"></a>15462 
<a name="l15463"></a>15463       } <span class="keywordflow">while</span> (*fh &lt; 0);
<a name="l15464"></a>15464 
<a name="l15465"></a>15465       <span class="keywordflow">if</span> (*fh &lt; 0)
<a name="l15466"></a>15466          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15467"></a>15467 
<a name="l15468"></a>15468       lseek(*fh, offset, SEEK_SET);
<a name="l15469"></a>15469 
<a name="l15470"></a>15470       <span class="comment">/* check if start of message */</span>
<a name="l15471"></a>15471       i = <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(*fh, str, 15);
<a name="l15472"></a>15472       <span class="keywordflow">if</span> (i &lt;= 0) {
<a name="l15473"></a>15473          close(*fh);
<a name="l15474"></a>15474          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15475"></a>15475       }
<a name="l15476"></a>15476 
<a name="l15477"></a>15477       <span class="keywordflow">if</span> (strncmp(str, <span class="stringliteral">&quot;$Start$: &quot;</span>, 9) != 0) {
<a name="l15478"></a>15478          close(*fh);
<a name="l15479"></a>15479          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15480"></a>15480       }
<a name="l15481"></a>15481 
<a name="l15482"></a>15482       lseek(*fh, offset, SEEK_SET);
<a name="l15483"></a>15483    }
<a name="l15484"></a>15484 
<a name="l15485"></a>15485    <span class="comment">/* open most recent file if no tag given */</span>
<a name="l15486"></a>15486    <span class="keywordflow">if</span> (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[0] == 0) {
<a name="l15487"></a>15487       <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>((<span class="keywordtype">long</span> *) &amp;lt);
<a name="l15488"></a>15488       ltime = lt;
<a name="l15489"></a>15489       <span class="keywordflow">do</span> {
<a name="l15490"></a>15490          tms = localtime((<span class="keyword">const</span> time_t *) &amp;ltime);
<a name="l15491"></a>15491 
<a name="l15492"></a>15492          sprintf(file_name, <span class="stringliteral">&quot;%s%02d%02d%02d.log&quot;</span>, dir,
<a name="l15493"></a>15493                  tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1, tms-&gt;tm_mday);
<a name="l15494"></a>15494          *fh = open(file_name, O_RDWR | <a class="code" href="group__msystemincludecode.html#ga36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>, 0644);
<a name="l15495"></a>15495 
<a name="l15496"></a>15496          <span class="keywordflow">if</span> (*fh &lt; 0)
<a name="l15497"></a>15497             ltime -= 3600 * 24; <span class="comment">/* one day back */</span>
<a name="l15498"></a>15498 
<a name="l15499"></a>15499       } <span class="keywordflow">while</span> (*fh &lt; 0 &amp;&amp; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) lt - (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) ltime &lt; 3600 * 24 * 365);
<a name="l15500"></a>15500 
<a name="l15501"></a>15501       <span class="keywordflow">if</span> (*fh &lt; 0)
<a name="l15502"></a>15502          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15503"></a>15503 
<a name="l15504"></a>15504       <span class="comment">/* remember tag */</span>
<a name="l15505"></a>15505       sprintf(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <span class="stringliteral">&quot;%02d%02d%02d&quot;</span>, tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1, tms-&gt;tm_mday);
<a name="l15506"></a>15506 
<a name="l15507"></a>15507       lseek(*fh, 0, SEEK_END);
<a name="l15508"></a>15508 
<a name="l15509"></a>15509       sprintf(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a> + strlen(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>), <span class="stringliteral">&quot;.%d&quot;</span>, (<span class="keywordtype">int</span>) <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(*fh));
<a name="l15510"></a>15510    }
<a name="l15511"></a>15511 
<a name="l15512"></a>15512 
<a name="l15513"></a>15513    <span class="keywordflow">if</span> (direction == -1) {
<a name="l15514"></a>15514       <span class="comment">/* seek previous message */</span>
<a name="l15515"></a>15515 
<a name="l15516"></a>15516       <span class="keywordflow">if</span> (<a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(*fh) == 0) {
<a name="l15517"></a>15517          <span class="comment">/* go back one day */</span>
<a name="l15518"></a>15518          close(*fh);
<a name="l15519"></a>15519 
<a name="l15520"></a>15520          lt = ltime;
<a name="l15521"></a>15521          <span class="keywordflow">do</span> {
<a name="l15522"></a>15522             lt -= 3600 * 24;
<a name="l15523"></a>15523             tms = localtime((<span class="keyword">const</span> time_t *) &amp;lt);
<a name="l15524"></a>15524             sprintf(str, <span class="stringliteral">&quot;%02d%02d%02d.0&quot;</span>,
<a name="l15525"></a>15525                     tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1, tms-&gt;tm_mday);
<a name="l15526"></a>15526 
<a name="l15527"></a>15527             status = <a class="code" href="group__msectionh.html#gad272ad608ea84675b7a2fa0ad57308ba">el_search_message</a>(str, fh, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l15528"></a>15528 
<a name="l15529"></a>15529          } <span class="keywordflow">while</span> (status != <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a> &amp;&amp; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) ltime - (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) lt &lt; 3600 * 24 * 365);
<a name="l15530"></a>15530 
<a name="l15531"></a>15531          <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>)
<a name="l15532"></a>15532             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gaac4d08b2b3c0c6755a104864de2ec8f0">EL_FIRST_MSG</a>;
<a name="l15533"></a>15533 
<a name="l15534"></a>15534          <span class="comment">/* adjust tag */</span>
<a name="l15535"></a>15535          strcpy(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, str);
<a name="l15536"></a>15536 
<a name="l15537"></a>15537          <span class="comment">/* go to end of current file */</span>
<a name="l15538"></a>15538          lseek(*fh, 0, SEEK_END);
<a name="l15539"></a>15539       }
<a name="l15540"></a>15540 
<a name="l15541"></a>15541       <span class="comment">/* read previous message size */</span>
<a name="l15542"></a>15542       lseek(*fh, -17, SEEK_CUR);
<a name="l15543"></a>15543       i = <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(*fh, str, 17);
<a name="l15544"></a>15544       <span class="keywordflow">if</span> (i &lt;= 0) {
<a name="l15545"></a>15545          close(*fh);
<a name="l15546"></a>15546          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15547"></a>15547       }
<a name="l15548"></a>15548 
<a name="l15549"></a>15549       <span class="keywordflow">if</span> (strncmp(str, <span class="stringliteral">&quot;$End$: &quot;</span>, 7) != 0) {
<a name="l15550"></a>15550          close(*fh);
<a name="l15551"></a>15551          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15552"></a>15552       }
<a name="l15553"></a>15553         
<a name="l15554"></a>15554       <span class="comment">/* make sure the input string to atoi() is zero-terminated:</span>
<a name="l15555"></a>15555 <span class="comment">       * $End$:      355garbage</span>
<a name="l15556"></a>15556 <span class="comment">       * 01234567890123456789 */</span>
<a name="l15557"></a>15557       str[15] = 0;
<a name="l15558"></a>15558 
<a name="l15559"></a>15559       size = atoi(str + 7);
<a name="l15560"></a>15560       assert(size &gt; 15);
<a name="l15561"></a>15561 
<a name="l15562"></a>15562       lseek(*fh, -size, SEEK_CUR);
<a name="l15563"></a>15563 
<a name="l15564"></a>15564       <span class="comment">/* adjust tag */</span>
<a name="l15565"></a>15565       sprintf(strchr(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <span class="charliteral">&apos;.&apos;</span>) + 1, <span class="stringliteral">&quot;%d&quot;</span>, (<span class="keywordtype">int</span>) <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(*fh));
<a name="l15566"></a>15566    }
<a name="l15567"></a>15567 
<a name="l15568"></a>15568    <span class="keywordflow">if</span> (direction == 1) {
<a name="l15569"></a>15569       <span class="comment">/* seek next message */</span>
<a name="l15570"></a>15570 
<a name="l15571"></a>15571       <span class="comment">/* read current message size */</span>
<a name="l15572"></a>15572       last = <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(*fh);
<a name="l15573"></a>15573 
<a name="l15574"></a>15574       i = <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(*fh, str, 15);
<a name="l15575"></a>15575       <span class="keywordflow">if</span> (i &lt;= 0) {
<a name="l15576"></a>15576          close(*fh);
<a name="l15577"></a>15577          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15578"></a>15578       }
<a name="l15579"></a>15579       lseek(*fh, -15, SEEK_CUR);
<a name="l15580"></a>15580 
<a name="l15581"></a>15581       <span class="keywordflow">if</span> (strncmp(str, <span class="stringliteral">&quot;$Start$: &quot;</span>, 9) != 0) {
<a name="l15582"></a>15582          close(*fh);
<a name="l15583"></a>15583          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15584"></a>15584       }
<a name="l15585"></a>15585 
<a name="l15586"></a>15586       <span class="comment">/* make sure the input string to atoi() is zero-terminated</span>
<a name="l15587"></a>15587 <span class="comment">       * $Start$:    606garbage</span>
<a name="l15588"></a>15588 <span class="comment">       * 01234567890123456789 */</span>
<a name="l15589"></a>15589       str[15] = 0;
<a name="l15590"></a>15590 
<a name="l15591"></a>15591       size = atoi(str+9);
<a name="l15592"></a>15592       assert(size &gt; 15);
<a name="l15593"></a>15593 
<a name="l15594"></a>15594       lseek(*fh, size, SEEK_CUR);
<a name="l15595"></a>15595 
<a name="l15596"></a>15596       <span class="comment">/* if EOF, goto next day */</span>
<a name="l15597"></a>15597       i = <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(*fh, str, 15);
<a name="l15598"></a>15598       <span class="keywordflow">if</span> (i &lt; 15) {
<a name="l15599"></a>15599          close(*fh);
<a name="l15600"></a>15600          <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>((<span class="keywordtype">long</span> *) &amp;lact);
<a name="l15601"></a>15601 
<a name="l15602"></a>15602          lt = ltime;
<a name="l15603"></a>15603          <span class="keywordflow">do</span> {
<a name="l15604"></a>15604             lt += 3600 * 24;
<a name="l15605"></a>15605             tms = localtime((<span class="keyword">const</span> time_t *) &amp;lt);
<a name="l15606"></a>15606             sprintf(str, <span class="stringliteral">&quot;%02d%02d%02d.0&quot;</span>,
<a name="l15607"></a>15607                     tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1, tms-&gt;tm_mday);
<a name="l15608"></a>15608 
<a name="l15609"></a>15609             status = <a class="code" href="group__msectionh.html#gad272ad608ea84675b7a2fa0ad57308ba">el_search_message</a>(str, fh, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l15610"></a>15610 
<a name="l15611"></a>15611          } <span class="keywordflow">while</span> (status != <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a> &amp;&amp; (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) lt - (<a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a>) lact &lt; 3600 * 24);
<a name="l15612"></a>15612 
<a name="l15613"></a>15613          <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>)
<a name="l15614"></a>15614             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga5f11d9b4e829e2486252fef634b6a382">EL_LAST_MSG</a>;
<a name="l15615"></a>15615 
<a name="l15616"></a>15616          <span class="comment">/* adjust tag */</span>
<a name="l15617"></a>15617          strcpy(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, str);
<a name="l15618"></a>15618 
<a name="l15619"></a>15619          <span class="comment">/* go to beginning of current file */</span>
<a name="l15620"></a>15620          lseek(*fh, 0, SEEK_SET);
<a name="l15621"></a>15621       } <span class="keywordflow">else</span>
<a name="l15622"></a>15622          lseek(*fh, -15, SEEK_CUR);
<a name="l15623"></a>15623 
<a name="l15624"></a>15624       <span class="comment">/* adjust tag */</span>
<a name="l15625"></a>15625       sprintf(strchr(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <span class="charliteral">&apos;.&apos;</span>) + 1, <span class="stringliteral">&quot;%d&quot;</span>, (<span class="keywordtype">int</span>) <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(*fh));
<a name="l15626"></a>15626    }
<a name="l15627"></a>15627 
<a name="l15628"></a>15628    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>;
<a name="l15629"></a>15629 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ga159e0c5f82d13b409f121d76b4a71947"></a><!-- doxytag: member="midas.c::el_search_run" ref="ga159e0c5f82d13b409f121d76b4a71947" args="(int run, char *return_tag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> el_search_run </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>run</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>return_tag</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="midas_8c_source.html#l15790">15790</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="midas_8h_source.html#l01114">EL_FIRST_MSG</a>, <a class="el" href="midas_8h_source.html#l01115">EL_LAST_MSG</a>, <a class="el" href="midas_8c_source.html#l15633">el_retrieve()</a>, <a class="el" href="midas_8c_source.html#l15379">el_search_message()</a>, <a class="el" href="midas_8h_source.html#l01110">EL_SUCCESS</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, <a class="el" href="mhist_8c_source.html#l00102">tag</a>, and <a class="el" href="p30_8h_source.html#l00043">TRUE</a>.</p>

<p>Referenced by <a class="el" href="mhttpd_8c_source.html#l03003">show_elog_submit_query()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l15793"></a>15793          : <a class="code" href="group__msectionh.html#ga4855981b0cdcc0d4f3dbab590b365619">el_search_run</a>
<a name="l15794"></a>15794 
<a name="l15795"></a>15795   Purpose: Find first <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a> belonging to a specific <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>
<a name="l15796"></a>15796 
<a name="l15797"></a>15797   Input:
<a name="l15798"></a>15798     <span class="keywordtype">int</span>    <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>              Run number
<a name="l15799"></a>15799 
<a name="l15800"></a>15800   Output:
<a name="l15801"></a>15801     <span class="keywordtype">char</span>   *<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>             <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a> of retrieved <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>
<a name="l15802"></a>15802 
<a name="l15803"></a>15803   Function <a class="code" href="ADCS_8h.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>:
<a name="l15804"></a>15804     <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>              Successful completion
<a name="l15805"></a>15805     <a class="code" href="group__err26.html#ga5f11d9b4e829e2486252fef634b6a382">EL_LAST_MSG</a>             Last <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a> <a class="code" href="scs__600__p1_8c.html#af8480819a437c1eaeaa5b28b890613fa">in</a> log
<a name="l15806"></a>15806 
<a name="l15807"></a>15807 \********************************************************************/
<a name="l15808"></a>15808 {
<a name="l15809"></a>15809    <span class="keywordtype">int</span> actual_run, fh, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>;
<a name="l15810"></a>15810    <span class="keywordtype">char</span> <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[256];
<a name="l15811"></a>15811 
<a name="l15812"></a>15812    tag[0] = return_tag[0] = 0;
<a name="l15813"></a>15813 
<a name="l15814"></a>15814    <span class="keywordflow">do</span> {
<a name="l15815"></a>15815       <span class="comment">/* open first message in file */</span>
<a name="l15816"></a>15816       strcat(tag, <span class="stringliteral">&quot;-1&quot;</span>);
<a name="l15817"></a>15817       status = <a class="code" href="group__msectionh.html#gad272ad608ea84675b7a2fa0ad57308ba">el_search_message</a>(tag, &amp;fh, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15818"></a>15818       <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#gaac4d08b2b3c0c6755a104864de2ec8f0">EL_FIRST_MSG</a>)
<a name="l15819"></a>15819          <span class="keywordflow">break</span>;
<a name="l15820"></a>15820       <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>)
<a name="l15821"></a>15821          <span class="keywordflow">return</span> status;
<a name="l15822"></a>15822       close(fh);
<a name="l15823"></a>15823 
<a name="l15824"></a>15824       <span class="keywordflow">if</span> (strchr(tag, <span class="charliteral">&apos;.&apos;</span>) != NULL)
<a name="l15825"></a>15825          strcpy(strchr(tag, <span class="charliteral">&apos;.&apos;</span>), <span class="stringliteral">&quot;.0&quot;</span>);
<a name="l15826"></a>15826 
<a name="l15827"></a>15827       <a class="code" href="group__msectionh.html#ga203cfa8e2d036e5e56a2fdd9d17eb09d">el_retrieve</a>(tag, NULL, &amp;actual_run, NULL, NULL,
<a name="l15828"></a>15828                   NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL);
<a name="l15829"></a>15829    } <span class="keywordflow">while</span> (actual_run &gt;= <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>);
<a name="l15830"></a>15830 
<a name="l15831"></a>15831    <span class="keywordflow">while</span> (actual_run &lt; <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>) {
<a name="l15832"></a>15832       strcat(tag, <span class="stringliteral">&quot;+1&quot;</span>);
<a name="l15833"></a>15833       status = <a class="code" href="group__msectionh.html#gad272ad608ea84675b7a2fa0ad57308ba">el_search_message</a>(tag, &amp;fh, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15834"></a>15834       <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga5f11d9b4e829e2486252fef634b6a382">EL_LAST_MSG</a>)
<a name="l15835"></a>15835          <span class="keywordflow">break</span>;
<a name="l15836"></a>15836       <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>)
<a name="l15837"></a>15837          <span class="keywordflow">return</span> status;
<a name="l15838"></a>15838       close(fh);
<a name="l15839"></a>15839 
<a name="l15840"></a>15840       <a class="code" href="group__msectionh.html#ga203cfa8e2d036e5e56a2fdd9d17eb09d">el_retrieve</a>(tag, NULL, &amp;actual_run, NULL, NULL,
<a name="l15841"></a>15841                   NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL);
<a name="l15842"></a>15842    }
<a name="l15843"></a>15843 
<a name="l15844"></a>15844    strcpy(return_tag, tag);
<a name="l15845"></a>15845 
<a name="l15846"></a>15846    <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga5f11d9b4e829e2486252fef634b6a382">EL_LAST_MSG</a> || status == <a class="code" href="group__err26.html#gaac4d08b2b3c0c6755a104864de2ec8f0">EL_FIRST_MSG</a>)
<a name="l15847"></a>15847       <span class="keywordflow">return</span> status;
<a name="l15848"></a>15848 
<a name="l15849"></a>15849    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>;
<a name="l15850"></a>15850 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="gaa6261c2ba4f0e04cb8285628a726ce90"></a><!-- doxytag: member="midas.c::el_submit" ref="gaa6261c2ba4f0e04cb8285628a726ce90" args="(int run, char *author, char *type, char *system, char *subject, char *text, char *reply_to, char *encoding, char *afilename1, char *buffer1, INT buffer_size1, char *afilename2, char *buffer2, INT buffer_size2, char *afilename3, char *buffer3, INT buffer_size3, char *tag, INT tag_size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a> el_submit </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>run</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>author</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>system</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>subject</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>text</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>reply_to</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>encoding</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>afilename1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buffer1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_size1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>afilename2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buffer2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_size2</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>afilename3</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buffer3</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>buffer_size3</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>tag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="odbhist_8c.html#a392e62da233ed3e2f7c3fd4f487a3896">INT</a>&nbsp;</td>
          <td class="paramname"> <em>tag_size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>dox Submit an ELog entry. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>run</em>&nbsp;</td><td>Run Number. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>author</em>&nbsp;</td><td>Message author. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>type</em>&nbsp;</td><td>Message type. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>system</em>&nbsp;</td><td>Message system. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>subject</em>&nbsp;</td><td>Subject. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>text</em>&nbsp;</td><td>Message text. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>reply_to</em>&nbsp;</td><td>In reply to this message. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>encoding</em>&nbsp;</td><td>Text encoding, either HTML or plain. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>afilename1</em>&nbsp;</td><td>File name of attachment. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer1</em>&nbsp;</td><td>File contents. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer_size1</em>&nbsp;</td><td>Size of buffer in bytes. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>afilename2</em>&nbsp;</td><td>File name of attachment. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer2</em>&nbsp;</td><td>File contents. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer_size2</em>&nbsp;</td><td>Size of buffer in bytes. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>afilename3</em>&nbsp;</td><td>File name of attachment. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer3</em>&nbsp;</td><td>File contents. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>buffer_size3</em>&nbsp;</td><td>Size of buffer in bytes. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>tag</em>&nbsp;</td><td>If given, edit existing message. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>tag_size</em>&nbsp;</td><td>Maximum size of tag. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>EL_SUCCESS </dd></dl>

<p>Definition at line <a class="el" href="midas_8c_source.html#l15064">15064</a> of file <a class="el" href="midas_8c_source.html">midas.c</a>.</p>

<p>References <a class="el" href="fal_8c_source.html#l00201">buffer</a>, <a class="el" href="fal_8c_source.html#l00202">buffer_size</a>, <a class="el" href="midas_8c_source.html#l02913">cm_get_experiment_database()</a>, <a class="el" href="midas_8c_source.html#l02934">cm_get_experiment_mutex()</a>, <a class="el" href="lrs1821_8h_source.html#l00218">cm_msg</a>, <a class="el" href="odb_8c_source.html#l03261">db_get_value()</a>, <a class="el" href="midas_8h_source.html#l01001">DB_SUCCESS</a>, <a class="el" href="midas_8h_source.html#l00639">DIR_SEPARATOR</a>, <a class="el" href="midas_8h_source.html#l00640">DIR_SEPARATOR_STR</a>, <a class="el" href="midas_8c_source.html#l15018">el_decode()</a>, <a class="el" href="midas_8h_source.html#l01111">EL_FILE_ERROR</a>, <a class="el" href="midas_8c_source.html#l15379">el_search_message()</a>, <a class="el" href="midas_8h_source.html#l01110">EL_SUCCESS</a>, <a class="el" href="p30_8h_source.html#l00042">FALSE</a>, <a class="el" href="odbhist_8c_source.html#l00059">file_name</a>, <a class="el" href="mucap__compress_8cpp_source.html#l00011">hDB</a>, <a class="el" href="mana_8cpp_source.html#l00677">index</a>, <a class="el" href="MFastSlowCorrelator_8cpp_source.html#l00063">last</a>, <a class="el" href="midas_8h_source.html#l01755">M_FREE</a>, <a class="el" href="midas_8h_source.html#l01753">M_MALLOC</a>, <a class="el" href="lrs1821_8h_source.html#l00220">MERROR</a>, <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00276">message</a>, <a class="el" href="camac_8c_source.html#l00506">n</a>, <a class="el" href="msystem_8h_source.html#l00351">O_BINARY</a>, <a class="el" href="mgd_8c_source.html#l01505">offset</a>, <a class="el" href="sis3803_8c_source.html#l00925">p</a>, <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00256">read</a>, <a class="el" href="midas_8c_source.html#l09810">rpc_call()</a>, <a class="el" href="mrpc_8h_source.html#l00183">RPC_EL_SUBMIT</a>, <a class="el" href="midas_8c_source.html#l09022">rpc_is_remote()</a>, <a class="el" href="crate6__CAEN__TDC_2mfe__mucap_8c_source.html#l00323">run_number</a>, <a class="el" href="ybos_8c_source.html#l00373">size</a>, <a class="el" href="system_8c_source.html#l02091">ss_mutex_release()</a>, <a class="el" href="system_8c_source.html#l01980">ss_mutex_wait_for()</a>, <a class="el" href="patch__mevb_8cpp_source.html#l00079">status</a>, <a class="el" href="bit3__mvme_2mvmestd_8h_source.html#l00045">SUCCESS</a>, <a class="el" href="msystem_8h_source.html#l00369">TELL</a>, <a class="el" href="midas_8h_source.html#l00741">TID_INT</a>, <a class="el" href="midas_8h_source.html#l00746">TID_STRING</a>, <a class="el" href="CAET_8h_source.html#l00002">time</a>, <a class="el" href="p30_8h_source.html#l00043">TRUE</a>, and <a class="el" href="examples_2macro_2midas__macro_8h_source.html#l00259">write</a>.</p>

<p>Referenced by <a class="el" href="midas_8c_source.html#l16225">al_trigger_class()</a>, <a class="el" href="mserver_8c_source.html#l00534">rpc_server_dispatch()</a>, and <a class="el" href="mhttpd_8c_source.html#l03805">submit_elog()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l15069"></a>15069 {
<a name="l15070"></a>15070    <span class="keywordflow">if</span> (<a class="code" href="group__msectionh.html#ga0090933001e7e1ddd52ed3f321bea957">rpc_is_remote</a>())
<a name="l15071"></a>15071       <span class="keywordflow">return</span> <a class="code" href="group__msectionh.html#ga6bf1d13a0c49a3f7a02650885937b5e7">rpc_call</a>(<a class="code" href="group__mrpcdefineh.html#ga01e8cb480d2e147d0df7075f7c16fd43">RPC_EL_SUBMIT</a>, <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>, author, <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>, system, subject,
<a name="l15072"></a>15072                       text, reply_to, encoding,
<a name="l15073"></a>15073                       afilename1, buffer1, buffer_size1,
<a name="l15074"></a>15074                       afilename2, buffer2, buffer_size2,
<a name="l15075"></a>15075                       afilename3, buffer3, buffer_size3, <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, tag_size);
<a name="l15076"></a>15076 
<a name="l15077"></a>15077 <span class="preprocessor">#ifdef LOCAL_ROUTINES</span>
<a name="l15078"></a>15078 <span class="preprocessor"></span>   {
<a name="l15079"></a>15079       <a class="code" href="lrs1190_8c.html#a6877c9d7ac317ac3415ee1a1f92302a0">INT</a> <a class="code" href="camac_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, <a class="code" href="ybos_8c.html#adfdd3a80d1d8ea7918a6d1ebee518102">size</a>, fh, <a class="code" href="patch__mevb_8cpp.html#a015eb90e0de9f16e87bd149d4b9ce959">status</a>, <a class="code" href="crate6__CAEN__TDC_2mfe__mucap_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, mutex, <a class="code" href="fal_8c.html#a72c9a6de0ddd97509a04d596e1886e80">buffer_size</a> = 0, <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>, <a class="code" href="mgd_8c.html#aed7ea92f45bd273dde380a45ddced592">offset</a> =
<a name="l15080"></a>15080           0, tail_size = 0;
<a name="l15081"></a>15081       <span class="keyword">struct </span>tm *tms = NULL;
<a name="l15082"></a>15082       <span class="keywordtype">char</span> afilename[256], <a class="code" href="odbhist_8c.html#a4da1fcf44864d811e793f03bf36e6e17">file_name</a>[256], afile_name[3][256], dir[256], <a class="code" href="odbhist_8c.html#a45bb529d5408fcb730eeccb339110d3f">str</a>[256],
<a name="l15083"></a>15083           start_str[80], end_str[80], <a class="code" href="MFastSlowCorrelator_8cpp.html#a3579fbbede9d99d8d4aafc118b3abed3">last</a>[80], date[80], thread[80], attachment[256];
<a name="l15084"></a>15084       <a class="code" href="group__midasincludecode.html#ga0e1bcf128ad8422667adffd1dea59791">HNDLE</a> <a class="code" href="mucap__compress_8cpp.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>;
<a name="l15085"></a>15085       time_t now;
<a name="l15086"></a>15086       <span class="keywordtype">char</span> <a class="code" href="examples_2macro_2midas__macro_8h.html#a408ca6b6abc64f4b82ea76d9a70dcacc">message</a>[10000], *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>, *<a class="code" href="fal_8c.html#a368f7094dc38acca20612bbb392552f4">buffer</a> = NULL;
<a name="l15087"></a>15087       <a class="code" href="group__midasincludecode.html#ga239c7f0d40651c3e419c5b9651507d14">BOOL</a> bedit;
<a name="l15088"></a>15088 
<a name="l15089"></a>15089       <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;hDB, NULL);
<a name="l15090"></a>15090 
<a name="l15091"></a>15091       bedit = (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>[0] != 0);
<a name="l15092"></a>15092 
<a name="l15093"></a>15093       <span class="comment">/* request semaphore */</span>
<a name="l15094"></a>15094       <a class="code" href="group__msectionh.html#ga6df13ff68685b0b1f818a983430de5ec">cm_get_experiment_mutex</a>(NULL, &amp;mutex);
<a name="l15095"></a>15095       <a class="code" href="group__msystemincludecode.html#gad3c6b30fd77b7be3d4d3d6db5f106b45">ss_mutex_wait_for</a>(mutex, 0);
<a name="l15096"></a>15096 
<a name="l15097"></a>15097       <span class="comment">/* get run number from ODB if not given */</span>
<a name="l15098"></a>15098       <span class="keywordflow">if</span> (<a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a> &gt; 0)
<a name="l15099"></a>15099          run_number = <a class="code" href="odbhist_8c.html#a369e3b30815f09142abc86f462a501ff">run</a>;
<a name="l15100"></a>15100       <span class="keywordflow">else</span> {
<a name="l15101"></a>15101          <span class="comment">/* get run number */</span>
<a name="l15102"></a>15102          size = <span class="keyword">sizeof</span>(run_number);
<a name="l15103"></a>15103          status =
<a name="l15104"></a>15104              <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, <span class="stringliteral">&quot;/Runinfo/Run number&quot;</span>, &amp;run_number, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>,
<a name="l15105"></a>15105                           <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15106"></a>15106          assert(status == <a class="code" href="group__mvmestdinclude.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>);
<a name="l15107"></a>15107       }
<a name="l15108"></a>15108 
<a name="l15109"></a>15109       <span class="keywordflow">if</span> (run_number &lt; 0) {
<a name="l15110"></a>15110          <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;el_submit&quot;</span>, <span class="stringliteral">&quot;aborting on attempt to use invalid run number %d&quot;</span>,
<a name="l15111"></a>15111                 run_number);
<a name="l15112"></a>15112          abort();
<a name="l15113"></a>15113       }
<a name="l15114"></a>15114 
<a name="l15115"></a>15115       <span class="keywordflow">for</span> (<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a> = 0; <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a> &lt; 3; <a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>++) {
<a name="l15116"></a>15116          <span class="comment">/* generate filename for attachment */</span>
<a name="l15117"></a>15117          afile_name[<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>][0] = file_name[0] = 0;
<a name="l15118"></a>15118 
<a name="l15119"></a>15119          <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a> == 0) {
<a name="l15120"></a>15120             strcpy(afilename, afilename1);
<a name="l15121"></a>15121             buffer = buffer1;
<a name="l15122"></a>15122             buffer_size = buffer_size1;
<a name="l15123"></a>15123          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a> == 1) {
<a name="l15124"></a>15124             strcpy(afilename, afilename2);
<a name="l15125"></a>15125             buffer = buffer2;
<a name="l15126"></a>15126             buffer_size = buffer_size2;
<a name="l15127"></a>15127          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a> == 2) {
<a name="l15128"></a>15128             strcpy(afilename, afilename3);
<a name="l15129"></a>15129             buffer = buffer3;
<a name="l15130"></a>15130             buffer_size = buffer_size3;
<a name="l15131"></a>15131          }
<a name="l15132"></a>15132 
<a name="l15133"></a>15133          <span class="keywordflow">if</span> (afilename[0]) {
<a name="l15134"></a>15134             strcpy(file_name, afilename);
<a name="l15135"></a>15135             p = file_name;
<a name="l15136"></a>15136             <span class="keywordflow">while</span> (strchr(p, <span class="charliteral">&apos;:&apos;</span>))
<a name="l15137"></a>15137                p = strchr(p, <span class="charliteral">&apos;:&apos;</span>) + 1;
<a name="l15138"></a>15138             <span class="keywordflow">while</span> (strchr(p, <span class="charliteral">&apos;\\&apos;</span>))
<a name="l15139"></a>15139                p = strchr(p, <span class="charliteral">&apos;\\&apos;</span>) + 1; <span class="comment">/* NT */</span>
<a name="l15140"></a>15140             <span class="keywordflow">while</span> (strchr(p, <span class="charliteral">&apos;/&apos;</span>))
<a name="l15141"></a>15141                p = strchr(p, <span class="charliteral">&apos;/&apos;</span>) + 1;  <span class="comment">/* Unix */</span>
<a name="l15142"></a>15142             <span class="keywordflow">while</span> (strchr(p, <span class="charliteral">&apos;]&apos;</span>))
<a name="l15143"></a>15143                p = strchr(p, <span class="charliteral">&apos;]&apos;</span>) + 1;  <span class="comment">/* VMS */</span>
<a name="l15144"></a>15144 
<a name="l15145"></a>15145             <span class="comment">/* assemble ELog filename */</span>
<a name="l15146"></a>15146             <span class="keywordflow">if</span> (p[0]) {
<a name="l15147"></a>15147                dir[0] = 0;
<a name="l15148"></a>15148                <span class="keywordflow">if</span> (hDB &gt; 0) {
<a name="l15149"></a>15149                   size = <span class="keyword">sizeof</span>(dir);
<a name="l15150"></a>15150                   memset(dir, 0, size);
<a name="l15151"></a>15151                   status =
<a name="l15152"></a>15152                       <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Elog dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>,
<a name="l15153"></a>15153                                    <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l15154"></a>15154                   <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l15155"></a>15155                      <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Data dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>,
<a name="l15156"></a>15156                                   <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15157"></a>15157 
<a name="l15158"></a>15158                   <span class="keywordflow">if</span> (dir[0] != 0 &amp;&amp; dir[strlen(dir) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l15159"></a>15159                      strcat(dir, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l15160"></a>15160                }
<a name="l15161"></a>15161 <span class="preprocessor">#if !defined(OS_VXWORKS)</span>
<a name="l15162"></a>15162 <span class="preprocessor"></span><span class="preprocessor">#if !defined(OS_VMS)</span>
<a name="l15163"></a>15163 <span class="preprocessor"></span>               tzset();
<a name="l15164"></a>15164 <span class="preprocessor">#endif</span>
<a name="l15165"></a>15165 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l15166"></a>15166 <span class="preprocessor"></span>
<a name="l15167"></a>15167                <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>((time_t *) &amp; now);
<a name="l15168"></a>15168                tms = localtime((<span class="keyword">const</span> time_t *) &amp;now);
<a name="l15169"></a>15169 
<a name="l15170"></a>15170                strcpy(str, p);
<a name="l15171"></a>15171                sprintf(afile_name[<a class="code" href="mana_8cpp.html#a312c2cad451d6bb0536fb9ec2863be59">index</a>], <span class="stringliteral">&quot;%02d%02d%02d_%02d%02d%02d_%s&quot;</span>,
<a name="l15172"></a>15172                        tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1, tms-&gt;tm_mday,
<a name="l15173"></a>15173                        tms-&gt;tm_hour, tms-&gt;tm_min, tms-&gt;tm_sec, str);
<a name="l15174"></a>15174                sprintf(file_name, <span class="stringliteral">&quot;%s%02d%02d%02d_%02d%02d%02d_%s&quot;</span>, dir,
<a name="l15175"></a>15175                        tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1, tms-&gt;tm_mday,
<a name="l15176"></a>15176                        tms-&gt;tm_hour, tms-&gt;tm_min, tms-&gt;tm_sec, str);
<a name="l15177"></a>15177 
<a name="l15178"></a>15178                <span class="comment">/* save attachment */</span>
<a name="l15179"></a>15179                fh = open(file_name, O_CREAT | O_RDWR | <a class="code" href="group__msystemincludecode.html#ga36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>, 0644);
<a name="l15180"></a>15180                <span class="keywordflow">if</span> (fh &lt; 0) {
<a name="l15181"></a>15181                   <a class="code" href="lrs1821_8h.html#aa6f8a5999f0a072ce20ab87bae8a9eb5">cm_msg</a>(<a class="code" href="lrs1821_8h.html#ac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;el_submit&quot;</span>, <span class="stringliteral">&quot;Cannot write attachment file \&quot;%s\&quot;&quot;</span>,
<a name="l15182"></a>15182                          file_name);
<a name="l15183"></a>15183                } <span class="keywordflow">else</span> {
<a name="l15184"></a>15184                   <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(fh, buffer, buffer_size);
<a name="l15185"></a>15185                   close(fh);
<a name="l15186"></a>15186                }
<a name="l15187"></a>15187             }
<a name="l15188"></a>15188          }
<a name="l15189"></a>15189       }
<a name="l15190"></a>15190 
<a name="l15191"></a>15191       <span class="comment">/* generate new file name YYMMDD.log in data directory */</span>
<a name="l15192"></a>15192       <a class="code" href="group__msectionh.html#ga1932e7947b0a024a845c5b8c19c3dda0">cm_get_experiment_database</a>(&amp;hDB, NULL);
<a name="l15193"></a>15193 
<a name="l15194"></a>15194       size = <span class="keyword">sizeof</span>(dir);
<a name="l15195"></a>15195       memset(dir, 0, size);
<a name="l15196"></a>15196       status = <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Elog dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l15197"></a>15197       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l15198"></a>15198          <a class="code" href="group__msectionh.html#ga9fc43f58a995c9f2cf9f734076ddedc2">db_get_value</a>(hDB, 0, <span class="stringliteral">&quot;/Logger/Data dir&quot;</span>, dir, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, <a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15199"></a>15199 
<a name="l15200"></a>15200       <span class="keywordflow">if</span> (dir[0] != 0 &amp;&amp; dir[strlen(dir) - 1] != <a class="code" href="group__midasincludecode.html#ga0920890c442b665b0c6609fa796e9047">DIR_SEPARATOR</a>)
<a name="l15201"></a>15201          strcat(dir, <a class="code" href="group__midasincludecode.html#ga23e72ca2d8456a971c13441bdfc4586f">DIR_SEPARATOR_STR</a>);
<a name="l15202"></a>15202 
<a name="l15203"></a>15203 <span class="preprocessor">#if !defined(OS_VXWORKS)</span>
<a name="l15204"></a>15204 <span class="preprocessor"></span><span class="preprocessor">#if !defined(OS_VMS)</span>
<a name="l15205"></a>15205 <span class="preprocessor"></span>      tzset();
<a name="l15206"></a>15206 <span class="preprocessor">#endif</span>
<a name="l15207"></a>15207 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l15208"></a>15208 <span class="preprocessor"></span>
<a name="l15209"></a>15209       <span class="keywordflow">if</span> (bedit) {
<a name="l15210"></a>15210          <span class="comment">/* edit existing message */</span>
<a name="l15211"></a>15211          strcpy(str, <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>);
<a name="l15212"></a>15212          <span class="keywordflow">if</span> (strchr(str, <span class="charliteral">&apos;.&apos;</span>)) {
<a name="l15213"></a>15213             offset = atoi(strchr(str, <span class="charliteral">&apos;.&apos;</span>) + 1);
<a name="l15214"></a>15214             *strchr(str, <span class="charliteral">&apos;.&apos;</span>) = 0;
<a name="l15215"></a>15215          }
<a name="l15216"></a>15216          sprintf(file_name, <span class="stringliteral">&quot;%s%s.log&quot;</span>, dir, str);
<a name="l15217"></a>15217          fh = open(file_name, O_CREAT | O_RDWR | <a class="code" href="group__msystemincludecode.html#ga36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>, 0644);
<a name="l15218"></a>15218          <span class="keywordflow">if</span> (fh &lt; 0) {
<a name="l15219"></a>15219             <a class="code" href="group__msystemincludecode.html#gae9746bf50ec478e587bb9d981f8eb9da">ss_mutex_release</a>(mutex);
<a name="l15220"></a>15220             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15221"></a>15221          }
<a name="l15222"></a>15222          lseek(fh, offset, SEEK_SET);
<a name="l15223"></a>15223          <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(fh, str, 16);
<a name="l15224"></a>15224          size = atoi(str + 9);
<a name="l15225"></a>15225          <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(fh, message, size);
<a name="l15226"></a>15226 
<a name="l15227"></a>15227          <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Date: &quot;</span>, date, <span class="keyword">sizeof</span>(date));
<a name="l15228"></a>15228          <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Thread: &quot;</span>, thread, <span class="keyword">sizeof</span>(thread));
<a name="l15229"></a>15229          <a class="code" href="group__elfunctionc.html#gad62749a2ca09a81ec2bb0daa8429967e">el_decode</a>(message, <span class="stringliteral">&quot;Attachment: &quot;</span>, attachment, <span class="keyword">sizeof</span>(attachment));
<a name="l15230"></a>15230 
<a name="l15231"></a>15231          <span class="comment">/* buffer tail of logfile */</span>
<a name="l15232"></a>15232          lseek(fh, 0, SEEK_END);
<a name="l15233"></a>15233          tail_size = <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(fh) - (offset + size);
<a name="l15234"></a>15234 
<a name="l15235"></a>15235          <span class="keywordflow">if</span> (tail_size &gt; 0) {
<a name="l15236"></a>15236             buffer = (<span class="keywordtype">char</span> *) <a class="code" href="group__msectionh.html#ga130728d73c8c9b46e0b9bd2e34557c3d">M_MALLOC</a>(tail_size);
<a name="l15237"></a>15237             <span class="keywordflow">if</span> (buffer == NULL) {
<a name="l15238"></a>15238                close(fh);
<a name="l15239"></a>15239                <a class="code" href="group__msystemincludecode.html#gae9746bf50ec478e587bb9d981f8eb9da">ss_mutex_release</a>(mutex);
<a name="l15240"></a>15240                <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15241"></a>15241             }
<a name="l15242"></a>15242 
<a name="l15243"></a>15243             lseek(fh, offset + size, SEEK_SET);
<a name="l15244"></a>15244             n = <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(fh, buffer, tail_size);
<a name="l15245"></a>15245          }
<a name="l15246"></a>15246          lseek(fh, offset, SEEK_SET);
<a name="l15247"></a>15247       } <span class="keywordflow">else</span> {
<a name="l15248"></a>15248          <span class="comment">/* create new message */</span>
<a name="l15249"></a>15249          <a class="code" href="CAET_8h.html#ab2d5aa7fce1a14d8bddfb2c333ea9679">time</a>((time_t *) &amp; now);
<a name="l15250"></a>15250          tms = localtime((<span class="keyword">const</span> time_t *) &amp;now);
<a name="l15251"></a>15251 
<a name="l15252"></a>15252          sprintf(file_name, <span class="stringliteral">&quot;%s%02d%02d%02d.log&quot;</span>, dir,
<a name="l15253"></a>15253                  tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1, tms-&gt;tm_mday);
<a name="l15254"></a>15254 
<a name="l15255"></a>15255          fh = open(file_name, O_CREAT | O_RDWR | <a class="code" href="group__msystemincludecode.html#ga36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>, 0644);
<a name="l15256"></a>15256          <span class="keywordflow">if</span> (fh &lt; 0) {
<a name="l15257"></a>15257             <a class="code" href="group__msystemincludecode.html#gae9746bf50ec478e587bb9d981f8eb9da">ss_mutex_release</a>(mutex);
<a name="l15258"></a>15258             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gae97067062620fe28d93670c390f23533">EL_FILE_ERROR</a>;
<a name="l15259"></a>15259          }
<a name="l15260"></a>15260 
<a name="l15261"></a>15261          strcpy(date, ctime(&amp;now));
<a name="l15262"></a>15262          date[24] = 0;
<a name="l15263"></a>15263 
<a name="l15264"></a>15264          <span class="keywordflow">if</span> (reply_to[0])
<a name="l15265"></a>15265             sprintf(thread, <span class="stringliteral">&quot;%16s %16s&quot;</span>, reply_to, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l15266"></a>15266          <span class="keywordflow">else</span>
<a name="l15267"></a>15267             sprintf(thread, <span class="stringliteral">&quot;%16s %16s&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l15268"></a>15268 
<a name="l15269"></a>15269          lseek(fh, 0, SEEK_END);
<a name="l15270"></a>15270       }
<a name="l15271"></a>15271 
<a name="l15272"></a>15272       <span class="comment">/* compose message */</span>
<a name="l15273"></a>15273 
<a name="l15274"></a>15274       sprintf(message, <span class="stringliteral">&quot;Date: %s\n&quot;</span>, date);
<a name="l15275"></a>15275       sprintf(message + strlen(message), <span class="stringliteral">&quot;Thread: %s\n&quot;</span>, thread);
<a name="l15276"></a>15276       sprintf(message + strlen(message), <span class="stringliteral">&quot;Run: %d\n&quot;</span>, run_number);
<a name="l15277"></a>15277       sprintf(message + strlen(message), <span class="stringliteral">&quot;Author: %s\n&quot;</span>, author);
<a name="l15278"></a>15278       sprintf(message + strlen(message), <span class="stringliteral">&quot;Type: %s\n&quot;</span>, <a class="code" href="mana_8cpp.html#a9a59b4d9fa62abe25a78cc38137ffd8e">type</a>);
<a name="l15279"></a>15279       sprintf(message + strlen(message), <span class="stringliteral">&quot;System: %s\n&quot;</span>, system);
<a name="l15280"></a>15280       sprintf(message + strlen(message), <span class="stringliteral">&quot;Subject: %s\n&quot;</span>, subject);
<a name="l15281"></a>15281 
<a name="l15282"></a>15282       <span class="comment">/* keep original attachment if edit and no new attachment */</span>
<a name="l15283"></a>15283       <span class="keywordflow">if</span> (bedit &amp;&amp; afile_name[0][0] == 0 &amp;&amp; afile_name[1][0] == 0 &amp;&amp;
<a name="l15284"></a>15284           afile_name[2][0] == 0)
<a name="l15285"></a>15285          sprintf(message + strlen(message), <span class="stringliteral">&quot;Attachment: %s&quot;</span>, attachment);
<a name="l15286"></a>15286       <span class="keywordflow">else</span> {
<a name="l15287"></a>15287          sprintf(message + strlen(message), <span class="stringliteral">&quot;Attachment: %s&quot;</span>, afile_name[0]);
<a name="l15288"></a>15288          <span class="keywordflow">if</span> (afile_name[1][0])
<a name="l15289"></a>15289             sprintf(message + strlen(message), <span class="stringliteral">&quot;,%s&quot;</span>, afile_name[1]);
<a name="l15290"></a>15290          <span class="keywordflow">if</span> (afile_name[2][0])
<a name="l15291"></a>15291             sprintf(message + strlen(message), <span class="stringliteral">&quot;,%s&quot;</span>, afile_name[2]);
<a name="l15292"></a>15292       }
<a name="l15293"></a>15293       sprintf(message + strlen(message), <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l15294"></a>15294 
<a name="l15295"></a>15295       sprintf(message + strlen(message), <span class="stringliteral">&quot;Encoding: %s\n&quot;</span>, encoding);
<a name="l15296"></a>15296       sprintf(message + strlen(message), <span class="stringliteral">&quot;========================================\n&quot;</span>);
<a name="l15297"></a>15297       strcat(message, text);
<a name="l15298"></a>15298 
<a name="l15299"></a>15299       assert(strlen(message) &lt; <span class="keyword">sizeof</span>(message)); <span class="comment">/* bomb out on array overrun. */</span>
<a name="l15300"></a>15300 
<a name="l15301"></a>15301       size = 0;
<a name="l15302"></a>15302       sprintf(start_str, <span class="stringliteral">&quot;$Start$: %6d\n&quot;</span>, size);
<a name="l15303"></a>15303       sprintf(end_str, <span class="stringliteral">&quot;$End$:   %6d\n\f&quot;</span>, size);
<a name="l15304"></a>15304 
<a name="l15305"></a>15305       size = strlen(message) + strlen(start_str) + strlen(end_str);
<a name="l15306"></a>15306 
<a name="l15307"></a>15307       <span class="keywordflow">if</span> (<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a> != NULL &amp;&amp; !bedit)
<a name="l15308"></a>15308          sprintf(<a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>, <span class="stringliteral">&quot;%02d%02d%02d.%d&quot;</span>, tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1,
<a name="l15309"></a>15309                  tms-&gt;tm_mday, (<span class="keywordtype">int</span>) <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(fh));
<a name="l15310"></a>15310 
<a name="l15311"></a>15311       <span class="comment">/* size has to fit in 6 digits */</span>
<a name="l15312"></a>15312       assert(size &lt; 999999);
<a name="l15313"></a>15313 
<a name="l15314"></a>15314       sprintf(start_str, <span class="stringliteral">&quot;$Start$: %6d\n&quot;</span>, size);
<a name="l15315"></a>15315       sprintf(end_str, <span class="stringliteral">&quot;$End$:   %6d\n\f&quot;</span>, size);
<a name="l15316"></a>15316 
<a name="l15317"></a>15317       <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(fh, start_str, strlen(start_str));
<a name="l15318"></a>15318       <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(fh, message, strlen(message));
<a name="l15319"></a>15319       <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(fh, end_str, strlen(end_str));
<a name="l15320"></a>15320 
<a name="l15321"></a>15321       <span class="keywordflow">if</span> (bedit) {
<a name="l15322"></a>15322          <span class="keywordflow">if</span> (tail_size &gt; 0) {
<a name="l15323"></a>15323             n = <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(fh, buffer, tail_size);
<a name="l15324"></a>15324             <a class="code" href="group__msectionh.html#ga95c0d83820c28cf52ea13271b034fcb2">M_FREE</a>(buffer);
<a name="l15325"></a>15325          }
<a name="l15326"></a>15326 
<a name="l15327"></a>15327          <span class="comment">/* truncate file here */</span>
<a name="l15328"></a>15328 <span class="preprocessor">#ifdef OS_WINNT</span>
<a name="l15329"></a>15329 <span class="preprocessor"></span>         chsize(fh, <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(fh));
<a name="l15330"></a>15330 <span class="preprocessor">#else</span>
<a name="l15331"></a>15331 <span class="preprocessor"></span>         ftruncate(fh, <a class="code" href="group__msystemincludecode.html#ga337ff93ab881892ee5854628ed184352">TELL</a>(fh));
<a name="l15332"></a>15332 <span class="preprocessor">#endif</span>
<a name="l15333"></a>15333 <span class="preprocessor"></span>      }
<a name="l15334"></a>15334 
<a name="l15335"></a>15335       close(fh);
<a name="l15336"></a>15336 
<a name="l15337"></a>15337       <span class="comment">/* if reply, mark original message */</span>
<a name="l15338"></a>15338       <span class="keywordflow">if</span> (reply_to[0] &amp;&amp; !bedit) {
<a name="l15339"></a>15339          strcpy(last, reply_to);
<a name="l15340"></a>15340          <span class="keywordflow">do</span> {
<a name="l15341"></a>15341             status = <a class="code" href="group__msectionh.html#gad272ad608ea84675b7a2fa0ad57308ba">el_search_message</a>(last, &amp;fh, <a class="code" href="p30_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l15342"></a>15342             <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>) {
<a name="l15343"></a>15343                <span class="comment">/* position to next thread location */</span>
<a name="l15344"></a>15344                lseek(fh, 72, SEEK_CUR);
<a name="l15345"></a>15345                memset(str, 0, <span class="keyword">sizeof</span>(str));
<a name="l15346"></a>15346                <a class="code" href="examples_2macro_2midas__macro_8h.html#a5b55880ce7d302ae13576e90584a63bb">read</a>(fh, str, 16);
<a name="l15347"></a>15347                lseek(fh, -16, SEEK_CUR);
<a name="l15348"></a>15348 
<a name="l15349"></a>15349                <span class="comment">/* if no reply yet, set it */</span>
<a name="l15350"></a>15350                <span class="keywordflow">if</span> (atoi(str) == 0) {
<a name="l15351"></a>15351                   sprintf(str, <span class="stringliteral">&quot;%16s&quot;</span>, <a class="code" href="mhist_8c.html#a27ce05f73a16e6abc070da1007833b9b">tag</a>);
<a name="l15352"></a>15352                   <a class="code" href="examples_2macro_2midas__macro_8h.html#a6fbb683090a733152e51639d58b90cd6">write</a>(fh, str, 16);
<a name="l15353"></a>15353                   close(fh);
<a name="l15354"></a>15354                   <span class="keywordflow">break</span>;
<a name="l15355"></a>15355                } <span class="keywordflow">else</span> {
<a name="l15356"></a>15356                   <span class="comment">/* if reply set, find last one in chain */</span>
<a name="l15357"></a>15357                   strcpy(last, strtok(str, <span class="stringliteral">&quot; &quot;</span>));
<a name="l15358"></a>15358                   close(fh);
<a name="l15359"></a>15359                }
<a name="l15360"></a>15360             } <span class="keywordflow">else</span>
<a name="l15361"></a>15361                <span class="comment">/* stop on error */</span>
<a name="l15362"></a>15362                <span class="keywordflow">break</span>;
<a name="l15363"></a>15363 
<a name="l15364"></a>15364          } <span class="keywordflow">while</span> (<a class="code" href="p30_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l15365"></a>15365       }
<a name="l15366"></a>15366 
<a name="l15367"></a>15367       <span class="comment">/* release elog mutex */</span>
<a name="l15368"></a>15368       <a class="code" href="group__msystemincludecode.html#gae9746bf50ec478e587bb9d981f8eb9da">ss_mutex_release</a>(mutex);
<a name="l15369"></a>15369    }
<a name="l15370"></a>15370 <span class="preprocessor">#endif                          </span><span class="comment">/* LOCAL_ROUTINES */</span>
<a name="l15371"></a>15371 
<a name="l15372"></a>15372    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga6d87830641fea1e7e72242c32acde1df">EL_SUCCESS</a>;
<a name="l15373"></a>15373 }
</pre></div></p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 6 Jun 2014 for AlcapDAQ:Rootana by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
